<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dukan Pro - Ultimate Business Suite</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ====================================================================
         === DUKAN PRO - MODERN AESTHETIC REDESIGN (INDIGO/CYAN) ===
         ====================================================================
        */
    
        /* --- 1. ‡§®‡§è ‡§î‡§∞ ‡§∏‡•Å‡§Ç‡§¶‡§∞ ‡§∞‡§Ç‡§ó‡•ã‡§Ç ‡§ï‡•ã ‡§°‡§ø‡§´‡§æ‡§á‡§® ‡§ï‡§∞‡§®‡§æ --- */
        :root {
            --dp-bg-light: #f4f7f6;        /* ‡§π‡§≤‡•ç‡§ï‡§æ ‡§ó‡•ç‡§∞‡•á ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° */
            --dp-bg-white: #ffffff;
            --dp-sidebar-bg: #111d4a;    /* ‡§°‡•Ä‡§™ ‡§á‡§Ç‡§°‡§ø‡§ó‡•ã (‡§ó‡§π‡§∞‡§æ ‡§®‡•Ä‡§≤‡§æ) */
            --dp-sidebar-text: #a0aed0;   /* ‡§π‡§≤‡•ç‡§ï‡§æ ‡§®‡•Ä‡§≤‡§æ/‡§ó‡•ç‡§∞‡•á ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü */
            --dp-sidebar-text-hover: #ffffff;
            --dp-sidebar-active-bg: #1a2b6d;  /* ‡§è‡§ï‡•ç‡§ü‡§ø‡§µ ‡§≤‡§ø‡§Ç‡§ï ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ó‡§π‡§∞‡§æ ‡§®‡•Ä‡§≤‡§æ */
            --dp-primary: #00b4d8;       /* ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§∏‡§æ‡§Ø‡§® (Cyan) ‡§∞‡§Ç‡§ó */
            --dp-secondary: #03045e;     /* ‡§ó‡§π‡§∞‡§æ ‡§®‡•Ä‡§≤‡§æ (Gradient ‡§ï‡•á ‡§≤‡§ø‡§è) */
            --dp-text-dark: #1A202C;
            --dp-text-light: #4A5568;
            --dp-border: #E2E8F0;
            --dp-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); /* ‡§∏‡•â‡§´‡•ç‡§ü ‡§∂‡•à‡§°‡•ã */
            
            /* ‡§π‡§Æ‡§æ‡§∞‡§æ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø '‡§∏‡•Å‡§Ç‡§¶‡§∞' ‡§ó‡•ç‡§∞‡•á‡§°‡§ø‡§è‡§Ç‡§ü */
            --dp-gradient: linear-gradient(135deg, var(--dp-primary) 0%, var(--dp-secondary) 100%);
        }
    
        /* --- 2. ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§¨‡•â‡§°‡•Ä ‡§î‡§∞ ‡§≤‡•á‡§Ü‡§â‡§ü --- */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--dp-bg-light); /* ‡§®‡§Ø‡§æ ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° */
            color: var(--dp-text-dark); /* ‡§®‡§Ø‡§æ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡§≤‡§∞ */
        }
    
        .main-content {
            margin-left: 280px;
            padding: 30px; /* ‡§•‡•ã‡§°‡§º‡•Ä ‡§î‡§∞ ‡§ú‡§ó‡§π */
            transition: margin-left 0.3s ease;
        }
    
        /* App is hidden until licensed */
        .main-content.locked, .sidebar.locked, .navbar-toggler.locked {
                display: none;
        }
    
        /* --- 3. ‡§∏‡§æ‡§á‡§°‡§¨‡§æ‡§∞ (‡§Ü‡§™‡§ï‡§æ ‡§´‡§ø‡§ï‡•ç‡§∏‡•ç‡§° ‡§∏‡•ç‡§ü‡•ç‡§∞‡§ï‡•ç‡§ö‡§∞) --- */
        .sidebar {
            width: 280px;
            background-color: var(--dp-sidebar-bg); /* ‡§®‡§Ø‡§æ ‡§á‡§Ç‡§°‡§ø‡§ó‡•ã ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° */
            color: var(--dp-sidebar-text-hover);
            height: 100vh;
            position: fixed; /* ‚≠êÔ∏è ‡§Ø‡§π ‡§Ü‡§™‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à, ‡§Ø‡§π ‡§µ‡•à‡§∏‡•Ä ‡§π‡•Ä ‡§π‡•à */
            top: 0;
            left: 0;
            padding-top: 20px;
            transition: transform 0.3s ease;
            z-index: 1050;
            border-right: 1px solid var(--dp-border);
            overflow-y: auto; /* ‡§∏‡•ç‡§ï‡•ç‡§∞‡•â‡§≤ ‡§ï‡•á ‡§≤‡§ø‡§è */
            overflow-x: hidden;
        }
        
        /* ‡§∏‡§æ‡§á‡§°‡§¨‡§æ‡§∞ ‡§Æ‡•á‡§Ç "Dukan Pro" ‡§π‡•á‡§°‡§ø‡§Ç‡§ó */
        .sidebar h3 {
            margin-bottom: 2rem;
            text-align: center;
            font-weight: 700;
            color: #fff;
            letter-spacing: 1px;
        }
    
        /* ‡§∏‡§æ‡§á‡§°‡§¨‡§æ‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§Ç‡§ï‡•ç‡§∏ (‡§®‡§Ø‡§æ ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤) */
        .sidebar .nav-link {
            color: var(--dp-sidebar-text);
            padding: 15px 25px;
            border-left: 5px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            /* ‡§®‡§Ø‡§æ: ‡§¶‡§æ‡§à‡§Ç ‡§ì‡§∞ ‡§∏‡•á ‡§ó‡•ã‡§≤ ‡§á‡§´‡§º‡•á‡§ï‡•ç‡§ü */
            border-radius: 0 30px 30px 0;
            margin-right: 15px; 
            margin-bottom: 5px; /* ‡§≤‡§ø‡§Ç‡§ï‡•ç‡§∏ ‡§ï‡•á ‡§¨‡•Ä‡§ö ‡§•‡•ã‡§°‡§º‡•Ä ‡§ú‡§ó‡§π */
        }
    
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: var(--dp-sidebar-text-hover); /* ‡§∏‡§´‡§º‡•á‡§¶ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü */
            background-color: var(--dp-sidebar-active-bg); /* ‡§•‡•ã‡§°‡§º‡§æ ‡§π‡§≤‡•ç‡§ï‡§æ ‡§®‡•Ä‡§≤‡§æ */
            border-left-color: var(--dp-primary); /* ‡§∏‡§æ‡§Ø‡§® ‡§è‡§ï‡•ç‡§∏‡•á‡§Ç‡§ü */
            /* ‡§ñ‡•Ç‡§¨‡§∏‡•Ç‡§∞‡§§ 'Glow' ‡§á‡§´‡§º‡•á‡§ï‡•ç‡§ü */
            box-shadow: 0 4px 10px rgba(0, 180, 216, 0.2); 
        }
    
        .sidebar .nav-link i {
            margin-right: 12px;
            width: 20px; /* ‡§Ü‡§á‡§ï‡§®‡•ç‡§∏ ‡§ï‡•ã ‡§è‡§ï ‡§≤‡§æ‡§á‡§® ‡§Æ‡•á‡§Ç ‡§∞‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è */
            text-align: center;
        }
        
        /* ‡§®‡•Ä‡§ö‡•á ‡§ï‡§æ ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§á‡§®‡•ç‡§´‡•ã ‡§¨‡•â‡§ï‡•ç‡§∏ */
        #user-info {
            background-color: var(--dp-sidebar-active-bg) !important;
        }
        
    
        /* --- 4. ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü (‡§ï‡§æ‡§∞‡•ç‡§°‡•ç‡§∏, ‡§¨‡§ü‡§®, ‡§ü‡•á‡§¨‡§≤‡•ç‡§∏) --- */
    
        /* ‡§∏‡•á‡§ï‡•ç‡§∂‡§® ‡§ï‡•Ä ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§π‡•á‡§°‡§ø‡§Ç‡§ó (‡§ú‡•à‡§∏‡•á "‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°") */
        .section > h2 {
            font-weight: 700;
            color: var(--dp-text-dark);
            margin-bottom: 2rem !important;
            /* ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§™‡§∞ ‡§ó‡•ç‡§∞‡•á‡§°‡§ø‡§è‡§Ç‡§ü */
            background-image: var(--dp-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            display: inline-block;
        }
    
        /* ‡§ï‡§æ‡§∞‡•ç‡§°‡•ç‡§∏ ‡§ï‡§æ ‡§®‡§Ø‡§æ ‡§°‡§ø‡§ú‡§º‡§æ‡§á‡§® */
        .card {
            border-radius: 16px; /* ‡§ú‡§º‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§ó‡•ã‡§≤ ‡§ï‡•ã‡§®‡•á */
            box-shadow: var(--dp-shadow); /* ‡§®‡§Ø‡§æ ‡§∏‡•â‡§´‡•ç‡§ü ‡§∂‡•à‡§°‡•ã */
            border: none;
            overflow: hidden; /* ‡§π‡•á‡§°‡§∞ ‡§ï‡•ã ‡§∏‡§π‡•Ä ‡§∏‡•á ‡§∞‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è */
            margin-bottom: 1.5rem; /* ‡§ï‡§æ‡§∞‡•ç‡§°‡•ç‡§∏ ‡§ï‡•á ‡§¨‡•Ä‡§ö ‡§ú‡§ó‡§π */
        }
    
        /* ‡§ï‡§æ‡§∞‡•ç‡§° ‡§ï‡§æ ‡§π‡•á‡§°‡§∞ (‡§Ø‡§π ‡§∏‡§¨‡§∏‡•á ‡§¨‡§°‡§º‡§æ ‡§¨‡§¶‡§≤‡§æ‡§µ ‡§π‡•à) */
        .card-header {
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            background: var(--dp-gradient); /* ‡§π‡§Æ‡§æ‡§∞‡§æ ‡§∏‡•Å‡§Ç‡§¶‡§∞ ‡§ó‡•ç‡§∞‡•á‡§°‡§ø‡§è‡§Ç‡§ü */
            color: white;
            padding: 20px 25px;
            font-weight: 600;
            font-size: 1.1rem;
            border-bottom: none;
        }
        
        /* ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§ï‡•á ‡§õ‡•ã‡§ü‡•á ‡§ï‡§æ‡§∞‡•ç‡§°‡•ç‡§∏ */
        .dashboard-card {
            transition: transform 0.2s, box-shadow 0.2s;
            background: var(--dp-bg-white);
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); /* ‡§π‡•â‡§µ‡§∞ ‡§™‡§∞ ‡§ú‡§º‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§∂‡•à‡§°‡•ã */
        }
        /* ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§ï‡•á ‡§Ü‡§á‡§ï‡§®‡•ç‡§∏ ‡§™‡§∞ ‡§ó‡•ç‡§∞‡•á‡§°‡§ø‡§è‡§Ç‡§ü */
        .dashboard-card i {
            background: var(--dp-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            font-size: 2.5rem; /* ‡§•‡•ã‡§°‡§º‡•á ‡§¨‡§°‡§º‡•á ‡§Ü‡§á‡§ï‡§®‡•ç‡§∏ */
        }
    
        /* ‡§´‡•â‡§∞‡•ç‡§Æ‡•ç‡§∏ ‡§î‡§∞ ‡§¨‡§ü‡§®‡•ç‡§∏ */
        .form-control, .form-select, .btn {
            border-radius: 8px;
            padding: 10px 15px;
            border: 1px solid var(--dp-border);
            transition: all 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--dp-primary);
            box-shadow: 0 0 0 3px rgba(0, 180, 216, 0.15);
        }
    
        .btn {
            font-weight: 600;
            padding: 10px 20px;
        }
        
        /* ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§¨‡§ü‡§® (‡§®‡§Ø‡§æ ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤) */
        .btn-primary {
            background-color: var(--dp-primary);
            border-color: var(--dp-primary);
            color: #fff;
        }
        .btn-primary:hover {
            background-color: var(--dp-secondary);
            border-color: var(--dp-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 180, 216, 0.3);
        }
        
        /* ‡§Ö‡§®‡•ç‡§Ø ‡§¨‡§ü‡§® (‡§ú‡•à‡§∏‡•á 'Add') */
        .btn-success { background-color: #1abc9c; border-color: #1abc9c; }
        .btn-success:hover { background-color: #16a085; border-color: #16a085; }
        .btn-info { background-color: #3498db; border-color: #3498db; }
        .btn-info:hover { background-color: #2980b9; border-color: #2980b9; }
        .btn-warning { background-color: #f39c12; border-color: #f39c12; }
        .btn-warning:hover { background-color: #e67e22; border-color: #e67e22; }
    
        /* ‡§ü‡•á‡§¨‡§≤‡•ç‡§∏ */
        .table th {
            background-color: var(--dp-bg-light); /* ‡§π‡§≤‡•ç‡§ï‡§æ ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° */
            color: var(--dp-text-light); /* ‡§π‡§≤‡•ç‡§ï‡§æ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü */
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            border: none;
            padding: 15px;
        }
        .table-striped > tbody > tr:nth-of-type(odd) > * {
            --bs-table-bg-type: var(--dp-bg-light);
        }
        .table td {
            border-top: 1px solid var(--dp-border); /* ‡§π‡§≤‡•ç‡§ï‡•Ä ‡§¨‡•â‡§∞‡•ç‡§°‡§∞ */
            vertical-align: middle;
            padding: 15px;
            color: var(--dp-text-dark);
        }
        .table-hover tbody tr:hover {
            background-color: #eaf6f9; /* ‡§π‡§≤‡•ç‡§ï‡§æ ‡§∏‡§æ‡§Ø‡§® ‡§π‡•â‡§µ‡§∞ */
        }
    
        /* --- 5. ‡§¨‡§æ‡§ï‡•Ä ‡§ï‡•á ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤‡•ç‡§∏ (‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§Æ‡•å‡§ú‡•Ç‡§¶) --- */
        
        /* ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§è‡§°‡§ú‡§∏‡•ç‡§ü‡§Æ‡•á‡§Ç‡§ü (‡§™‡§π‡§≤‡•á ‡§ú‡•à‡§∏‡§æ) */
        @media (max-width: 991.98px) {
            .sidebar { transform: translateX(-280px); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .main-content.sidebar-open { margin-left: 280px; overflow-x: hidden; }
            .navbar-toggler { display: block !important; }
        }
        
        .navbar-toggler {
            position: fixed; top: 10px; left: 10px; z-index: 1060;
            display: none; background-color: var(--dp-sidebar-bg);
            border: 1px solid var(--dp-primary);
        }
        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='white' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }
        
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); display: flex;
            justify-content: center; align-items: center; z-index: 2000;
        }
        .hidden { display: none !important; }
    
        /* --- ‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§ú‡§®‡§∞‡•á‡§ü‡§∞ ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤‡•ç‡§∏ --- */
        #invoice-generator h5 { font-weight: 600; }
        #invoice-preview {
            background: white; padding: 25px; border: 1px solid var(--dp-border);
            min-height: 80vh; font-size: 14px; color: #333;
            border-radius: 16px; box-shadow: var(--dp-shadow);
        }
        .invoice-header {
            border-bottom: 2px solid var(--dp-primary);
            margin-bottom: 20px; padding-bottom: 15px;
        }
        .shop-details h3 { color: var(--dp-secondary); font-weight: 700; }
        .customer-details {
            border: 1px solid #eee; padding: 15px;
            margin-bottom: 20px; border-radius: 8px;
        }
        .invoice-table th { background-color: var(--dp-bg-light); }
        
        /* --- GST ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ü‡•à‡§¨‡•ç‡§∏ --- */
        .gst-report-tabs .nav-link {
            background-color: #f0f0f0; border: 1px solid var(--dp-border);
            color: var(--dp-text-light); font-weight: 600;
        }
        .gst-report-tabs .nav-link.active {
            background-color: var(--dp-bg-white);
            border-bottom: 1px solid var(--dp-bg-white);
            color: var(--dp-secondary); /* ‡§°‡§æ‡§∞‡•ç‡§ï ‡§¨‡•ç‡§≤‡•Ç ‡§è‡§ï‡•ç‡§ü‡§ø‡§µ */
            position: relative; top: 1px;
        }
        .gst-report-tab-content {
            background-color: var(--dp-bg-white);
            border: 1px solid var(--dp-border);
            padding: 1.5rem;
            border-radius: 0 8px 8px 8px;
        }
        
        /* --- ‡§Ö‡§®‡•ç‡§Ø ‡§∏‡§≠‡•Ä ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤‡•ç‡§∏ (‡§¨‡§æ‡§∞‡§ï‡•ã‡§°, ‡§ü‡§æ‡§á‡§Æ‡§∞, ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü) --- */
        /* (‡§Ø‡§π ‡§¨‡§æ‡§ï‡•Ä ‡§ï‡§æ CSS ‡§π‡•à ‡§ú‡§ø‡§∏‡•á ‡§¨‡§¶‡§≤‡§®‡•á ‡§ï‡•Ä ‡§ú‡§º‡§∞‡•Ç‡§∞‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à) */
    
        .section { display: none; }
        .section.active { display: block; }
        .text-shadow { text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); }
        #qr-preview img { max-width: 100px; max-height: 100px; border: 1px solid #ccc; padding: 3px; }
        .invoice-table { width: 100%; margin-bottom: 20px; border-collapse: collapse; }
        .invoice-table th, .invoice-table td { padding: 10px; text-align: right; border-bottom: 1px solid #dee2e6; }
        .invoice-table th:first-child, .invoice-table td:first-child { text-align: left; }
        .invoice-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 20px; }
        .totals-table { width: 50%; }
        .totals-table td { padding: 5px 10px; }
        .terms { font-size: 12px; color: #777; }
        .report-table { font-size: 0.9rem; }
        .report-table th { background-color: #f8f9fa; }
        .report-table td { padding: 0.5rem; }
        .report-table .fw-bold { border-top: 2px solid #333; }
        .report-print-area { display: none; }
        #barcode-scanner-input { position: fixed; top: -100px; left: -100px; opacity: 0; }
        #license-timer { font-size: 0.8rem; font-weight: 500; padding: 5px 10px; border-radius: 6px; }
        #license-timer.expiring-soon { background-color: #ffc107; color: #333; cursor: pointer; }
        #license-timer.expired { background-color: #dc3545; color: #fff; cursor: pointer; }
        #license-timer i { margin-right: 5px; }
        .json-viewer { background-color: #282c34; color: #abb2bf; padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto; font-family: 'Courier New', Courier, monospace; font-size: 0.9rem; white-space: pre; }
        @media print {
            body * { visibility: hidden; }
            .printable, .printable * { visibility: visible; }
            .printable { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 15px; border: none; box-shadow: none; }
            .no-print { display: none; }
        }
        .sidebar::-webkit-scrollbar { width: 8px; }
        .sidebar::-webkit-scrollbar-track { background: #555; }
        .sidebar::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .sidebar::-webkit-scrollbar-thumb:hover { background: #aaa; }
        .gst-report-table { font-size: 0.85rem; margin-top: 15px; border-collapse: collapse; width: 100%; }
        .gst-report-table th, .gst-report-table td { border: 1px solid #dee2e6; padding: 8px 12px; text-align: right; }
        .gst-report-table th { background-color: #f8f9fa; text-align: center; font-weight: 600; vertical-align: middle; }
        .gst-report-table td:first-child { text-align: left; }
        .gst-report-table tfoot tr { font-weight: bold; background-color: #e9ecef; }
        .gst-report-table .group-header td { background-color: #f3f4f6; font-weight: bold; text-align: left; }
    
    
    /* ======================================================== */
/* === üöÄ ‡§®‡§Ø‡§æ ‡§ñ‡•Ç‡§¨‡§∏‡•Ç‡§∞‡§§ ‡§≤‡•â‡§ó‡§ø‡§® CSS (‡§Ø‡§π‡§æ‡§Å ‡§∏‡•á ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç) === */
/* ======================================================== */

/* 1. ‡§Æ‡•â‡§≤ ‡§ï‡§æ ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° ‡§á‡§Æ‡•á‡§ú */
.auth-overlay {
    background: url('./images/shopkeeper-dukanpro.jpg') no-repeat center center fixed;
    background-size: cover;
    background-color: rgba(0, 0, 0, 0.45); /* ‡§•‡•ã‡§°‡§º‡§æ ‡§ó‡§π‡§∞‡§æ ‡§ì‡§µ‡§∞‡§≤‡•á */
    background-blend-mode: multiply;
    /* ... (‡§¨‡§æ‡§ï‡•Ä ‡§ï‡§æ ‡§ï‡•ã‡§°) ... */
}    
    /* ‡§®‡§Ø‡§æ: ‡§Æ‡•â‡§≤ ‡§ï‡§æ ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° */
    background: url('https://raw.githubusercontent.com/Dinesh9529/Dukan-Pro-Ultimate/main/images/shopkeeper-dukanpro.jpg') no-repeat center center fixed;    
	background-size: cover;
    
    /* ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§∏‡§æ‡§´‡§º ‡§¶‡§ø‡§ñ‡•á ‡§á‡§∏‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§≤‡•ç‡§ï‡•Ä ‡§°‡§æ‡§∞‡•ç‡§ï ‡§≤‡•á‡§Ø‡§∞ */
    background-color: rgba(0, 0, 0, 0.3);
    background-blend-mode: multiply;
    
    /* ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§Ø‡§π ‡§™‡•Ç‡§∞‡•á ‡§™‡•á‡§ú ‡§™‡§∞ ‡§π‡•ã */
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 20px;
}

/* 2. ‡§®‡§Ø‡§æ ‡§∏‡•á‡§Ç‡§ü‡§∞‡•ç‡§° ‡§∞‡•à‡§™‡§∞ (Wrapper) */
.login-wrapper {
    width: 100%;
    max-width: 950px; /* ‡§≤‡•â‡§ó‡§ø‡§® ‡§¨‡•â‡§ï‡•ç‡§∏ + ‡§∏‡§æ‡§á‡§°‡§¨‡§æ‡§∞ ‡§ï‡•Ä ‡§ï‡•Å‡§≤ ‡§ö‡•å‡§°‡§º‡§æ‡§à */
    display: grid;
    /* 40% ‡§è‡§°‡§µ‡§∞‡§ü‡§æ‡§á‡§ú‡§ø‡§Ç‡§ó, 60% ‡§≤‡•â‡§ó‡§ø‡§® ‡§´‡•â‡§∞‡•ç‡§Æ */
    grid-template-columns: 40% 60%; 
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

/* 3. ‡§®‡§Ø‡§æ ‡§è‡§°‡§µ‡§∞‡§ü‡§æ‡§á‡§ú‡§ø‡§Ç‡§ó ‡§∏‡§æ‡§á‡§°‡§¨‡§æ‡§∞ (Left Column) */
.login-ad-sidebar {
    /* ‡§Ü‡§™‡§ï‡•Ä ‡§ê‡§™ ‡§ï‡•Ä ‡§á‡§Ç‡§°‡§ø‡§ó‡•ã ‡§•‡•Ä‡§Æ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó */
    background: var(--dp-sidebar-bg, #111d4a); 
    color: #fff;
    padding: 40px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}
.login-ad-sidebar h3 {
    font-weight: 700;
    letter-spacing: 1px;
}
.login-ad-sidebar p {
    font-size: 1.1rem;
    color: var(--dp-sidebar-text, #a0aed0);
    border-bottom: 1px solid var(--dp-sidebar-active-bg, #1a2b6d);
    padding-bottom: 15px;
}
.login-ad-sidebar .ad-footer {
    margin-top: auto;
    padding-top: 15px;
    border-top: 1px solid var(--dp-sidebar-active-bg, #1a2b6d);
    color: var(--dp-sidebar-text, #a0aed0);
}

/* 4. ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§æ‡§∞‡•ç‡§° (Glass Effect) */
.login-card-glass {
    background: rgba(255, 255, 255, 0.8); /* ‡§•‡•ã‡§°‡§º‡•Ä ‡§ú‡§º‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§™‡§æ‡§∞‡§¶‡§∞‡•ç‡§∂‡§ø‡§§‡§æ */
    backdrop-filter: blur(15px); /* ‡§•‡•ã‡§°‡§º‡§æ ‡§ï‡§Æ ‡§¨‡•ç‡§≤‡§∞, ‡§§‡§æ‡§ï‡§ø ‡§™‡•Ä‡§õ‡•á ‡§ï‡§æ ‡§ú‡§º‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§¶‡§ø‡§ñ‡•á */
    -webkit-backdrop-filter: blur(15px);
    padding: 30px 40px;
}
.login-card-glass h3 {
    color: var(--dp-text-dark, #1A202C);
}
/* ‡§ü‡•à‡§¨‡•ç‡§∏ ‡§ï‡•ã ‡§ó‡•ç‡§≤‡§æ‡§∏ ‡§™‡§∞ ‡§¨‡•á‡§π‡§§‡§∞ ‡§¶‡§ø‡§ñ‡§æ‡§®‡§æ */
.login-card-glass .nav-tabs {
    border-bottom: 2px solid var(--dp-border, #E2E8F0);
}
.login-card-glass .nav-link {
    color: var(--dp-text-light, #4A5568);
    font-weight: 600;
    padding: 10px 15px;
}
.login-card-glass .nav-link.active {
    background-color: rgba(255, 255, 255, 0.8);
    color: var(--dp-primary, #00b4d8);
    border: 2px solid var(--dp-border, #E2E8F0);
    border-bottom-color: transparent;
    border-radius: 8px 8px 0 0;
}


/* 5. ‡§è‡§®‡§ø‡§Æ‡•á‡§ü‡•á‡§° ‡§´‡•Ä‡§ö‡§∞‡•ç‡§∏ (Advertising Quotes) */
.features-list {
    list-style: none;
    padding: 0;
    margin: 25px 0;
    height: 180px; /* ‡§è‡§®‡•Ä‡§Æ‡•á‡§∂‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§´‡§ø‡§ï‡•ç‡§∏‡•ç‡§° ‡§ä‡§Ç‡§ö‡§æ‡§à */
    overflow: hidden;
    position: relative;
}
.features-list {
    list-style: none;
    padding: 0;
    margin: 25px 0;
    height: 250px; /* ‡§è‡§®‡•Ä‡§Æ‡•á‡§∂‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§•‡•ã‡§°‡§º‡•Ä ‡§ú‡§º‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§ä‡§Ç‡§ö‡§æ‡§à */
    overflow: hidden;
    position: relative;
    font-size: 1.1rem; /* ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡§æ ‡§∏‡§æ‡§á‡•õ */
}
.features-list li {
    font-weight: 500;
    padding: 8px 0;
    position: absolute;
    width: 100%;
    opacity: 0;
    transform: translateY(30px);
    /* 9 ‡§Ü‡§á‡§ü‡§Æ ‡§ï‡•á ‡§≤‡§ø‡§è 18 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§ï‡§æ ‡§≤‡•Ç‡§™ (2s ‡§™‡•ç‡§∞‡§§‡§ø ‡§Ü‡§á‡§ü‡§Æ) */
    animation: slide-up-fade 18s linear infinite; /* ‡§ü‡•ã‡§ü‡§≤ 18 ‡§∏‡•á‡§ï‡§Ç‡§° */
    animation-delay: var(--delay);
}
.features-list li span {
    display: block; /* ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•ã ‡§®‡§à ‡§≤‡§æ‡§á‡§® ‡§™‡§∞ */
    font-size: 0.9rem; /* ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡§æ ‡§õ‡•ã‡§ü‡§æ ‡§∏‡§æ‡§á‡•õ */
    color: var(--dp-sidebar-text, #a0aed0); /* ‡§π‡§≤‡•ç‡§ï‡§æ ‡§∞‡§Ç‡§ó */
    margin-top: 3px;
    font-weight: 400;
}
/* ‡§π‡§∞ ‡§Ü‡§á‡§ü‡§Æ ‡§ï‡•ã ‡§Ö‡§≤‡§ó-‡§Ö‡§≤‡§ó ‡§∏‡§Æ‡§Ø ‡§™‡§∞ ‡§è‡§®‡§ø‡§Æ‡•á‡§ü ‡§ï‡§∞‡§®‡§æ (‡§Ö‡§¨ 9 ‡§Ü‡§á‡§ü‡§Æ ‡§ï‡•á ‡§≤‡§ø‡§è) */
.features-list li:nth-child(1) { --delay: 0s; }
.features-list li:nth-child(2) { --delay: 2s; }
.features-list li:nth-child(3) { --delay: 4s; }
.features-list li:nth-child(4) { --delay: 6s; }
.features-list li:nth-child(5) { --delay: 8s; }
.features-list li:nth-child(6) { --delay: 10s; }
.features-list li:nth-child(7) { --delay: 12s; }
.features-list li:nth-child(8) { --delay: 14s; } /* ‡§®‡§Ø‡§æ ‡§Ü‡§á‡§ü‡§Æ */
.features-list li:nth-child(9) { --delay: 16s; } /* ‡§®‡§Ø‡§æ ‡§Ü‡§á‡§ü‡§Æ */
/* (‡§®‡§Ø‡§æ, ‡§∏‡§π‡•Ä ‡§ï‡•ã‡§°) */
@keyframes slide-up-fade {
    /* ‡§π‡§∞ ‡§Ü‡§á‡§ü‡§Æ 18 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§ï‡•á ‡§≤‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§∏‡§ø‡§∞‡•ç‡§´ 2 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¶‡§ø‡§ñ‡•á‡§ó‡§æ */

    /* 0% ‡§∏‡•á ~1.1% (‡§≤‡§ó‡§≠‡§ó 0.2s) - ‡§Ö‡§Ç‡§¶‡§∞ ‡§Ü‡§®‡§æ */
    0%   { opacity: 0; transform: translateY(30px); }
    1.1% { opacity: 1; transform: translateY(0); }

    /* ~1.1% ‡§∏‡•á ~10% (‡§≤‡§ó‡§≠‡§ó 1.6s) - ‡§∞‡•Å‡§ï‡•á ‡§∞‡§π‡§®‡§æ */
    10%  { opacity: 1; transform: translateY(0); }

    /* ~10% ‡§∏‡•á ~11.1% (‡§≤‡§ó‡§≠‡§ó 0.2s) - ‡§¨‡§æ‡§π‡§∞ ‡§ú‡§æ‡§®‡§æ */
    11.1% { opacity: 0; transform: translateY(-15px); }
    
    /* ‡§¨‡§æ‡§ï‡•Ä 88.9% ‡§∏‡§Æ‡§Ø (16 ‡§∏‡•á‡§ï‡§Ç‡§°) - ‡§õ‡§ø‡§™‡§æ ‡§∞‡§π‡§®‡§æ */
    100% { opacity: 0; }
}/* 6. ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§ï‡•á ‡§≤‡§ø‡§è (‡§¨‡§π‡•Å‡§§ ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£) */
@media (max-width: 800px) {
    .login-wrapper {
        grid-template-columns: 1fr; /* 1 ‡§ï‡•â‡§≤‡§Æ ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ñ‡§æ‡§®‡§æ */
        width: 95%;
        max-width: 450px;
        max-height: 90vh;
        overflow-y: auto; /* ‡§∏‡•ç‡§ï‡•ç‡§∞‡•â‡§≤ ‡§ï‡•á ‡§≤‡§ø‡§è */
    }
    .login-ad-sidebar {
        /* ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§™‡§∞ ‡§è‡§°‡§µ‡§∞‡§ü‡§æ‡§á‡§ú‡§ø‡§Ç‡§ó ‡§õ‡§ø‡§™‡§æ ‡§¶‡•á‡§Ç */
        display: none; 
    }
    .login-card-glass {
        /* ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§™‡§∞ ‡§ú‡§º‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§∏‡§æ‡§´‡§º ‡§¶‡§ø‡§ñ‡§æ‡§®‡§æ */
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }
}
/* ======================================================== */
/* === üöÄ ‡§®‡§Ø‡§æ CSS ‡§Ø‡§π‡§æ‡§Å ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã‡§§‡§æ ‡§π‡•à === */
/* ======================================================== */
    
    
    
    
    </style>


</head>

<body>

    <input type="text" id="barcode-scanner-input" autocomplete="off">


    <div class="auth-overlay" id="auth-container-new">
    
    <div class="login-wrapper">
        
        <div class="login-ad-sidebar">
            <h3 class="mb-3"><i class="fas fa-store me-2"></i>Dukan Pro Ultimate</h3>
            <p>‡§á‡§Ç‡§°‡§ø‡§Ø‡§æ ‡§ï‡§æ ‡§∏‡§¨‡§∏‡•á ‡§è‡§°‡§µ‡§æ‡§Ç‡§∏ ‡§¨‡§ø‡•õ‡§®‡•á‡§∏ ‡§∏‡•Ç‡§ü</p>
            
            <ul class="features-list">
                <li><i class="fas fa-file-alt me-2"></i> GSTR-1, 2, & 3B Reports<br><span>(GSTR-1, 2, ‡§î‡§∞ 3B ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏)</span></li>
                <li><i class="fas fa-university me-2"></i> Automated Bank Reconciliation<br><span>(‡§∏‡•ç‡§µ‡§ö‡§æ‡§≤‡§ø‡§§ ‡§¨‡•à‡§Ç‡§ï ‡§∏‡§Æ‡§æ‡§ß‡§æ‡§®)</span></li>
                <li><i class="fas fa-qrcode me-2"></i> Barcode Scanning via Mobile<br><span>(‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§∏‡•á ‡§¨‡§æ‡§∞‡§ï‡•ã‡§° ‡§∏‡•ç‡§ï‡•à‡§®‡§ø‡§Ç‡§ó)</span></li>
                <li><i class="fas fa-users me-2"></i> Advanced Customer (CRM)<br><span>(‡§â‡§®‡•ç‡§®‡§§ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§∏‡§Ç‡§¨‡§Ç‡§ß ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®)</span></li>
                <li><i class="fas fa-boxes me-2"></i> Smart Stock & Inventory Control<br><span>(‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§∏‡•ç‡§ü‡•â‡§ï ‡§î‡§∞ ‡§á‡§®‡•ç‡§µ‡•á‡§Ç‡§ü‡§∞‡•Ä ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§£)</span></li>
                <li><i class="fas fa-chart-line me-2"></i> Real-time P&L & Analytics<br><span>(‡§∞‡§ø‡§Ø‡§≤-‡§ü‡§æ‡§á‡§Æ P&L ‡§î‡§∞ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£)</span></li>
                <li><i class="fas fa-cash-register me-2"></i> Lightning-Fast POS Billing<br><span>(‡§¨‡§ø‡§ú‡§≤‡•Ä ‡§ï‡•Ä ‡§§‡•á‡§ú‡§º‡•Ä ‡§∏‡•á POS ‡§¨‡§ø‡§≤‡§ø‡§Ç‡§ó)</span></li>
                <li><i class="fas fa-receipt me-2"></i> Customizable Invoice Generator<br><span>(‡§ï‡§∏‡•ç‡§ü‡§Æ‡§æ‡§á‡§ú‡•á‡§¨‡§≤ ‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§ú‡§®‡§∞‡•á‡§ü‡§∞)</span></li>
                <li><i class="fas fa-cloud me-2"></i> Secure Cloud Data Backup<br><span>(‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§ï‡•ç‡§≤‡§æ‡§â‡§° ‡§°‡•á‡§ü‡§æ ‡§¨‡•à‡§ï‡§Ö‡§™)</span></li>
            </ul>

            <div class="ad-footer">
                <p>‡§Ü‡§™‡§ï‡•á ‡§¨‡§ø‡•õ‡§®‡•á‡§∏ ‡§ï‡•Ä ‡§π‡§∞ ‡•õ‡§∞‡•Ç‡§∞‡§§, ‡§è‡§ï ‡§∏‡•â‡§´‡•ç‡§ü‡§µ‡•á‡§Ø‡§∞ ‡§Æ‡•á‡§Ç‡•§</p>
            </div>
        </div>
        
        <div class="login-card-glass">
            <nav>
                <div class="nav nav-tabs" id="nav-tab" role="tablist">
                    <button class="nav-link active w-50" id="nav-login-tab" data-bs-toggle="tab" data-bs-target="#nav-login" type="button" role="tab" aria-controls="nav-login" aria-selected="true">
                        <i class="fas fa-sign-in-alt me-2"></i>‡§≤‡•â‡§ó‡§ø‡§®
                    </button>
                    <button class="nav-link w-50" id="nav-register-tab" data-bs-toggle="tab" data-bs-target="#nav-register" type="button" role="tab" aria-controls="nav-register" aria-selected="false">
                        <i class="fas fa-user-plus me-2"></i>‡§®‡§Ø‡§æ ‡§Ö‡§ï‡§æ‡§â‡§Ç‡§ü
                    </button>
                </div>
            </nav>
            <div class="tab-content mt-4" id="nav-tabContent">
                <div class="tab-pane fade show active" id="nav-login" role="tabpanel" aria-labelledby="nav-login-tab">
                    <h3 class="text-center mb-4">Dukan Pro ‡§Æ‡•á‡§Ç ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç</h3>
                    <form id="login-form">
                        <div class="mb-3">
                            <label for="login-email" class="form-label">‡§à‡§Æ‡•á‡§≤</label>
                            <input type="email" class="form-control" id="login-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="login-password" class="form-label">‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°</label>
                            <input type="password" class="form-control" id="login-password" required>
                        </div>
                        <div id="login-message" class="text-danger small mb-3">&nbsp;</div>
                        <button type="submit" class="btn btn-primary w-100" id="login-submit-btn">‡§≤‡•â‡§ó‡§ø‡§®</button>
                    </form>
                </div>
                <div class="tab-pane fade" id="nav-register" role="tabpanel" aria-labelledby="nav-register-tab">
                    <h3 class="text-center mb-4">‡§®‡§Ø‡§æ ‡§∂‡•â‡§™ ‡§Ö‡§ï‡§æ‡§â‡§Ç‡§ü ‡§¨‡§®‡§æ‡§è‡§Ç</h3>
                    <form id="register-form">
                        <div class="mb-3">
                            <label for="register-shop-name" class="form-label">‡§Ü‡§™‡§ï‡•Ä ‡§∂‡•â‡§™ ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
                            <input type="text" class="form-control" id="register-shop-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="register-name" class="form-label">‡§Ü‡§™‡§ï‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ (‡§è‡§°‡§Æ‡§ø‡§®)</label>
                            <input type="text" class="form-control" id="register-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="register-email" class="form-label">‡§Ü‡§™‡§ï‡§æ ‡§à‡§Æ‡•á‡§≤</label>
                            <input type="email" class="form-control" id="register-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="register-mobile" class="form-label">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞</label>
                            <input type="tel" class="form-control" id="register-mobile" required pattern="[0-9]{10}">
                        </div>
                        <div class="mb-3">
                            <label for="register-password" class="form-label">‡§®‡§Ø‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°</label>
                            <input type="password" class="form-control" id="register-password" required>
                        </div>
                        <div id="register-message" class="text-danger small mb-3">&nbsp;</div>
                        <button type="submit" class="btn btn-success w-100" id="register-submit-btn">‡§Ö‡§ï‡§æ‡§â‡§Ç‡§ü ‡§¨‡§®‡§æ‡§è‡§Ç</button>
                    </form>
                </div>
            </div>
            </div>

    </div>

</div>



    <div class="modal fade" id="licenseModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="licenseModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="licenseModalLabel">Dukan Pro - License Verification</h5>
                </div>
                <form id="license-form">
                    <div class="modal-body">
                        <p>‡§∏‡•â‡§´‡•ç‡§ü‡§µ‡•á‡§Ø‡§∞ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡•Ä ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§ï‡•Ä ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§</p>
                        <div class="mb-3">
                            <label for="license-key-input" class="form-label fw-bold">‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§ï‡•Ä (License Key)</label>
                            <input type="text" class="form-control" id="license-key-input" required autocomplete="off">
                        </div>
                        <div id="license-message" class="text-danger small mt-2">&nbsp;</div>
                    </div>
                    <div class="modal-footer">
                         <button type="button" class="btn btn-outline-secondary d-none" id="open-admin-login-from-license-btn">‡§è‡§°‡§Æ‡§ø‡§® ‡§≤‡•â‡§ó‡§ø‡§®</button>
                         <button type="submit" class="btn btn-primary" id="license-submit-btn">‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="renewalModal" tabindex="-1" aria-labelledby="renewalModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-warning border-3">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="renewalModalLabel"><i class="fas fa-exclamation-triangle"></i> ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§∞‡§ø‡§®‡•ç‡§Ø‡•Ç‡§Ö‡§≤ ‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="fs-5">‡§Ü‡§™‡§ï‡•Ä Dukan Pro ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§ï‡•Ä ‡§ú‡§≤‡•ç‡§¶ ‡§π‡•Ä ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã‡§®‡•á ‡§µ‡§æ‡§≤‡•Ä ‡§π‡•à!</p>
                    <p>‡§Ö‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ ‡§∏‡•á ‡§¨‡§ö‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§Æ‡§Ø ‡§™‡§∞ ‡§∞‡§ø‡§®‡•ç‡§Ø‡•Ç‡§Ö‡§≤ ‡§ï‡§∞‡§æ‡§è‡§Å‡•§</p>
                    <p class="fw-bold">‡§∞‡§ø‡§®‡•ç‡§Ø‡•Ç‡§Ö‡§≤ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è 7303410987 ‡§™‡§∞ WhatsApp ‡§ï‡§∞‡•á‡§Ç‡•§</p>
                    <hr>
                    <p class="mb-2 fw-bold">‡§Ü‡§™ ‡§ï‡§ø‡§§‡§®‡•á ‡§∏‡§Æ‡§Ø ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∞‡§ø‡§®‡•ç‡§Ø‡•Ç‡§Ö‡§≤ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?</p>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success" onclick="sendWhatsAppRenewal(1)">
                            <i class="fab fa-whatsapp"></i> 1 ‡§Æ‡§π‡•Ä‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•Ç‡§õ‡•á‡§Ç
                        </button>
                        <button type="button" class="btn btn-success" onclick="sendWhatsAppRenewal(6)">
                            <i class="fab fa-whatsapp"></i> 6 ‡§Æ‡§π‡•Ä‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•Ç‡§õ‡•á‡§Ç
                        </button>
                        <button type="button" class="btn btn-success" onclick="sendWhatsAppRenewal(12)">
                            <i class="fab fa-whatsapp"></i> 12 ‡§Æ‡§π‡•Ä‡§®‡•á (1 ‡§∏‡§æ‡§≤) ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•Ç‡§õ‡•á‡§Ç
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç</button>
                </div>
            </div>
        </div>
    </div>




    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="ms-3 text-primary" id="loading-message">‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>
    </div>

    <button class="navbar-toggler locked" type="button" id="menu-toggle">
        <span class="navbar-toggler-icon"></span>
    </button>
    <nav id="sidebar" class="sidebar locked">
        <div class="p-4 d-flex flex-column h-100">
            <div class="text-center mb-3" id="shop-logo-container">
                </div>
            <h3 class="mb-4 text-white text-shadow text-center"><i class="fas fa-store me-2"></i>Dukan Pro</h3>
            
            <ul class="nav flex-column mb-auto" id="sidebar-nav">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-view="dashboard" data-role="ANY"> <i class="fas fa-home"></i> ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="stock" data-role="MANAGER"> <i class="fas fa-boxes"></i> ‡§∏‡•ç‡§ü‡•â‡§ï ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="sales" data-role="ANY"> <i class="fas fa-cash-register"></i> ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä (POS)
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="invoice-generator" data-role="ANY"> <i class="fas fa-file-invoice"></i> ‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§ú‡§®‡§∞‡•á‡§ü‡§∞ Pro
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="purchases" data-role="MANAGER"> <i class="fas fa-shopping-basket"></i> ‡§ñ‡§∞‡•Ä‡§¶
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="crm" data-role="MANAGER"> <i class="fas fa-users"></i> ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï (CRM)
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="expenses" data-role="MANAGER"> <i class="fas fa-money-bill-wave"></i> ‡§ñ‡§∞‡•ç‡§ö
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="reports" data-role="MANAGER"> <i class="fas fa-chart-line"></i> ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="gst-reports" data-role="MANAGER"> <i class="fas fa-file-alt"></i> GST ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="bank-reconciliation" data-role="MANAGER"> <i class="fas fa-university"></i> ‡§¨‡•à‡§Ç‡§ï ‡§∞‡§ø‡§ï‡•â‡§®‡•ç‡§∏‡§ø‡§≤‡•á‡§∂‡§®
                    </a>
                </li>

                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="daily-closing" data-role="MANAGER"> <i class="fas fa-calendar-check"></i> ‡§°‡•á‡§≤‡•Ä ‡§ï‡•ç‡§≤‡•ã‡§ú‡§ø‡§Ç‡§ó
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="data-backup" data-role="ADMIN"> <i class="fas fa-download"></i> ‡§°‡•á‡§ü‡§æ ‡§¨‡•à‡§ï‡§Ö‡§™
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link d-none" data-view="staff" data-role="ADMIN"> <i class="fas fa-user-cog"></i> ‡§∏‡•ç‡§ü‡§æ‡§´ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®
                    </a>
                </li>
                 <li class="nav-item">
                    <a href="#" class="nav-link" data-view="shop-settings" data-role="ADMIN"> <i class="fas fa-cogs"></i> ‡§∂‡•â‡§™ ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏
                    </a>
                </li>
            </ul>
            
            <hr class="text-white-50">
            
            <div id="user-info" class="text-white-50 p-2 text-center mb-2" style="background-color: #495057; border-radius: 8px;">
                <h5 id="user-shop-name" class="text-white mb-0">Shop Name</h5>
                <small id="user-name-email">User Name (Role)</small>
            </div>

            <div id="license-timer" class="text-center text-white-50 mb-2">
                <i class="fas fa-check-circle text-success"></i> ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...
            </div>
            
            <button id="logout-btn" class="btn btn-sm btn-danger w-100"><i class="fas fa-sign-out-alt me-2"></i>‡§≤‡•â‡§ó‡§Ü‡§â‡§ü</button>
            
            <p class="text-muted mt-2 mb-0 text-center small">v1.0.3 Corrected</p>
        </div>
    </nav>

    

    <div id="main-content" class="main-content locked">
        <section id="dashboard" class="section">
            <h2 class="mb-4 text-primary">‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</h2>
            <div class="row g-4">
                <div class="col-md-6 col-lg-3">
                    <div class="card p-3 dashboard-card bg-white">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-rupee-sign fa-2x text-primary me-3"></i>
                            <div>
                                <p class="text-muted mb-0">‡§ï‡•Å‡§≤ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä (‡§∞‡•á‡§µ‡•á‡§®‡•ç‡§Ø‡•Ç)</p>
                                <h4 class="mb-0" id="total-sales-revenue">‚Çπ0.00</h4>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="card p-3 dashboard-card bg-white">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-boxes fa-2x text-warning me-3"></i>
                            <div>
                                <p class="text-muted mb-0">‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•Ç‡§≤‡•ç‡§Ø (‡§ñ‡§∞‡•Ä‡§¶)</p>
                                <h4 class="mb-0" id="total-stock-value">‚Çπ0.00</h4>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="card p-3 dashboard-card bg-white">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-users fa-2x text-success me-3"></i>
                            <div>
                                <p class="text-muted mb-0">‡§ï‡•Å‡§≤ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï</p>
                                <h4 class="mb-0" id="total-customers">0</h4>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="card p-3 dashboard-card bg-white">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle fa-2x text-danger me-3"></i>
                            <div>
                                <p class="text-muted mb-0">‡§ï‡§Æ ‡§∏‡•ç‡§ü‡•â‡§ï ‡§µ‡§æ‡§≤‡•á ‡§Ü‡§á‡§ü‡§Æ</p>
                                <h4 class="mb-0" id="low-stock-count">0</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4 g-4">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header bg-gradient-primary">‡§™‡§ø‡§õ‡§≤‡•á 30 ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§ï‡•Ä ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä</div>
                        <div class="card-body">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header bg-warning text-dark">‡§ï‡§Æ ‡§∏‡•ç‡§ü‡•â‡§ï ‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä</div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm table-striped mb-0">
                                    <thead>
                                        <tr>
                                            <th>SKU</th>
                                            <th>‡§Ü‡§á‡§ü‡§Æ</th>
                                            <th>Qty</th>
                                        </tr>
                                    </thead>
                                    <tbody id="low-stock-table-body">
                                        <tr><td colspan="3" class="text-center text-muted">‡§ï‡•ã‡§à ‡§ï‡§Æ ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Ü‡§á‡§ü‡§Æ ‡§®‡§π‡•Ä‡§Ç</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4 g-4">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header bg-success">‡§π‡§æ‡§≤ ‡§ï‡•Ä ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä</div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-striped mb-0">
                                    <thead>
                                        <tr>
                                            <th>‡§ö‡§æ‡§≤‡§æ‡§® ‡§®‡§Ç.</th>
                                            <th>‡§ó‡•ç‡§∞‡§æ‡§π‡§ï</th>
                                            <th>‡§∞‡§æ‡§∂‡§ø</th>
                                            <th>‡§§‡§ø‡§•‡§ø</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-sales-table-body">
                                        <tr><td colspan="4" class="text-center text-muted">‡§ï‡•ã‡§à ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header bg-info">‡§π‡§æ‡§≤ ‡§ï‡•á ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï</div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-striped mb-0">
                                    <thead>
                                        <tr>
                                            <th>‡§®‡§æ‡§Æ</th>
                                            <th>‡§´‡§º‡•ã‡§®</th>
                                            <th>‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-customers-table-body">
                                        <tr><td colspan="3" class="text-center text-muted">‡§ï‡•ã‡§à ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§®‡§π‡•Ä‡§Ç</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>



        <section id="stock" class="section">
            <h2 class="mb-4 text-primary">‡§∏‡•ç‡§ü‡•â‡§ï ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®</h2>
            <div class="card mb-4">
                <div class="card-header">‡§®‡§Ø‡§æ ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</div>
                <div class="card-body">
                    <form id="add-stock-form" class="row g-3">
                        <div class="col-md-3">
                            <label for="stock-sku" class="form-label">SKU / ‡§ï‡•ã‡§°</label>
                            <input type="text" class="form-control" id="stock-sku" required>
                        </div>
                        <div class="col-md-5">
                            <label for="stock-name" class="form-label">‡§Ü‡§á‡§ü‡§Æ ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
                            <input type="text" class="form-control" id="stock-name" required>
                        </div>
                        <div class="col-md-2">
                            <label for="stock-quantity" class="form-label">‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (Qty)</label>
                            <input type="number" class="form-control" id="stock-quantity" required min="0">
                        </div>
                         <div class="col-md-2">
                             <label for="stock-unit" class="form-label">‡§á‡§ï‡§æ‡§à</label>
                             <input type="text" class="form-control" id="stock-unit" value="Pcs" placeholder="e.g., Pcs, Kg, Ltr" required>
                         </div>
                        <div class="col-md-3">
                            <label for="stock-purchase-price" class="form-label">‡§ñ‡§∞‡•Ä‡§¶ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø (‚Çπ)</label>
                            <input type="number" step="0.01" class="form-control" id="stock-purchase-price" required min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="stock-sale-price" class="form-label">‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§Æ‡•Ç‡§≤‡•ç‡§Ø (‚Çπ)</label>
                            <input type="number" step="0.01" class="form-control" id="stock-sale-price" required min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="stock-gst" class="form-label">GST (%)</label>
                            <input type="number" step="0.01" class="form-control" id="stock-gst" value="0" min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="stock-hsn-code" class="form-label">HSN ‡§ï‡•ã‡§° (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)</label>
                            <input type="text" class="form-control" id="stock-hsn-code">
                        </div>
                        <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-primary w-100">‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•á‡§Ç ‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§∏‡•ç‡§ü‡•â‡§ï ‡§∏‡•Ç‡§ö‡•Ä</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>SKU</th>
                                    <th>‡§Ü‡§á‡§ü‡§Æ</th>
                                    <th>Qty</th>
                                    <th>‡§ñ‡§∞‡•Ä‡§¶ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø</th>
                                    <th>‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§Æ‡•Ç‡§≤‡•ç‡§Ø</th>
                                    <th>GST %</th>
                                    <th>Last Updated</th>
                                    <th>‡§è‡§ï‡•ç‡§∂‡§®</th> 
                                </tr>
                            </thead>
                            <tbody id="stock-table-body">
                                <tr><td colspan="8" class="text-center text-muted">‡§ï‡•ã‡§à ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Ü‡§á‡§ü‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ</td></tr>
                            </tbody>
                            <tfoot id="stock-table-foot"></tfoot> 
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="sales" class="section">
            <h2 class="mb-4 text-primary">‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä (‡§™‡•â‡§á‡§Ç‡§ü ‡§ë‡§´ ‡§∏‡•á‡§≤)</h2>
            <div class="row g-4">
                <div class="col-lg-5"> <div class="card">
                        <div class="card-header">‡§®‡§Ø‡§æ ‡§ö‡§æ‡§≤‡§æ‡§® ‡§¨‡§®‡§æ‡§è‡§Ç</div>
                        <div class="card-body">
                            <form id="pos-form">
                                <div class="mb-3">
                                    <label for="pos-customer" class="form-label">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
                                    <input type="text" class="form-control" id="pos-customer" list="customer-datalist" placeholder="‡§Ö‡§®‡§æ‡§Æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§Ø‡§æ ‡§®‡§æ‡§Æ ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç">
                                    <datalist id="customer-datalist"></datalist>
                                </div>
        
                                <div class="mb-3">
                                    <label for="pos-customer-mobile" class="form-label">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞</label>
                                    <input type="tel" class="form-control" id="pos-customer-mobile" placeholder="‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)">
                                </div>
                                
                                <div class="mb-3 position-relative">
                                    <label for="pos-item-search" class="form-label">‡§Ü‡§á‡§ü‡§Æ ‡§ñ‡•ã‡§ú‡•á‡§Ç / SKU</label>
                                    <div class="input-group"> 
                                        <input 
                                            type="text" 
                                            class="form-control" 
                                            id="pos-item-search" 
                                            placeholder="‡§Ü‡§á‡§ü‡§Æ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§Ø‡§æ SKU ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç (‡§Ø‡§æ ‡§∏‡§≠‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç)" 
                                            autocomplete="off"
                                        >
                                        <button class="btn btn-warning" type="button" onclick="openMobileScanner()">
                                            <i class="fas fa-qrcode"></i> ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§∏‡•ç‡§ï‡•à‡§®‡§∞
                                        </button>
                                    </div>

                                    <div id="inline-pairing-box" class="mt-2 p-2 border border-warning rounded bg-light text-center" style="display: none;">
                                        <p class="mb-1 small text-muted">‡§∏‡•ç‡§ï‡•à‡§®‡§∞ ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§π ‡§ï‡•ã‡§° ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§≤‡•á‡§Ç:</p>
                                        <span id="inline-pairing-code" style="font-size: 1.8rem; font-weight: bold; letter-spacing: 3px; color: #dc3545;"></span> <div id="inline-pairing-spinner" class="spinner-border spinner-border-sm text-warning ms-2" role="status"> <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p id="inline-pairing-status" class="mt-1 mb-0 small text-success" style="display: none;">
                                            <i class="fas fa-check-circle"></i> ‡§∏‡•ç‡§ï‡•à‡§®‡§∞ ‡§ï‡§®‡•á‡§ï‡•ç‡§ü‡•á‡§°‡•§
                                        </p>
                                    </div>
                                    <ul 
                                        id="pos-search-results" 
                                        class="list-group position-absolute w-100" 
                                        style="z-index: 100; max-height: 300px; overflow-y: auto;"
                                        onclick="handleSearchResultClick(event)"
                                    ></ul>
                                </div>
                                <hr>
        
                                <h5>‡§¨‡§ø‡§≤‡§ø‡§Ç‡§ó ‡§ï‡§æ‡§∞‡•ç‡§ü</h5>
                                <div class="table-responsive mb-3" style="min-height: 150px;">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>‡§Ü‡§á‡§ü‡§Æ</th>
                                                <th style="width: 15%;">Qty</th>
                                                <th>‡§¶‡§∞</th>
                                                <th>‡§ï‡•Å‡§≤</th>
                                                <th style="width: 1%;"></th>
                                            </tr>
                                        </thead>
                                        <tbody id="pos-cart-body">
                                            <tr><td colspan="5" class="text-center text-muted">‡§ï‡§æ‡§∞‡•ç‡§ü ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•à‡•§</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="d-flex justify-content-between fw-bold mb-2">
                                    <span>‡§ï‡•Å‡§≤ ‡§ü‡•à‡§ï‡•ç‡§∏‡•á‡§¨‡§≤ ‡§∞‡§æ‡§∂‡§ø:</span>
                                    <span id="pos-subtotal">‚Çπ0.00</span>
                                </div>
                                <div class="d-flex justify-content-between fw-bold mb-2 text-danger">
                                    <span>‡§ï‡•Å‡§≤ GST ‡§∞‡§æ‡§∂‡§ø:</span>
                                    <span id="pos-gst-amount">‚Çπ0.00</span>
                                </div>
                                <div class="d-flex justify-content-between fw-bold fs-5 border-top pt-2">
                                    <span>‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡•Ä ‡§ú‡§æ‡§®‡•á ‡§µ‡§æ‡§≤‡•Ä ‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø:</span>
                                    <span id="pos-total-amount">‚Çπ0.00</span>
                                </div>
        
                                <div class="mt-4">
                                    <button 
                                        type="button" 
                                        class="btn btn-success btn-lg w-100" 
                                        id="complete-sale-btn"
                                        onclick="handleCompleteSale()"
                                    >‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§™‡•Ç‡§∞‡•Ä ‡§ï‡§∞‡•á‡§Ç</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-7"> <div class="card">
                        <div class="card-header">‡§π‡§æ‡§≤ ‡§ï‡•á ‡§ö‡§æ‡§≤‡§æ‡§®</div>
                        <div class="card-body">
                            <div class="mb-3 d-flex justify-content-end">
                                <button class="btn btn-sm btn-outline-secondary" id="refresh-sales-btn" onclick="fetchAndRenderSales()"><i class="fas fa-sync-alt"></i> ‡§§‡§æ‡§ú‡§º‡§æ ‡§ï‡§∞‡•á‡§Ç</button>
                            </div>
                            <div class="table-responsive" style="max-height: 700px; overflow-y: auto;">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>‡§ö‡§æ‡§≤‡§æ‡§® ‡§®‡§Ç.</th>
                                            <th>‡§ó‡•ç‡§∞‡§æ‡§π‡§ï</th>
                                            <th>GST</th>
                                            <th>‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø</th>
                                            <th>‡§§‡§ø‡§•‡§ø</th>
                                            <th>‡§è‡§ï‡•ç‡§∂‡§®</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sales-table-body">
                                        <tr><td colspan="5" class="text-center text-muted">‡§ï‡•ã‡§à ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç‡•§</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="invoice-generator" class="section">
            <h2 class="mb-4 text-primary">üáÆüá≥ India's Best Invoice Generator Pro</h2>
            <div class="row g-4">
                <div class="col-lg-5 no-print">
                    <div class="card">
                        <div class="card-header">
                            <h2>üìù Create New Invoice</h2>
                        </div>
                        <div class="card-body p-4">
                            <div class="row g-3 mb-4">
                                <h5>üè™ Shop Details</h5>
                                <div class="col-md-6">
                                    <input type="text" id="shopName" class="form-control" placeholder="Shop Name" onkeyup="updateInvoicePreview()">
                                </div>
                                <div class="col-md-6">
                                    <input type="text" id="shopContact" class="form-control" placeholder="Contact No." onkeyup="updateInvoicePreview()">
                                </div>
                                <div class="col-12">
                                    <input type="text" id="shopAddress" class="form-control" placeholder="Shop Address" onkeyup="updateInvoicePreview()">
                                </div>
                                 <div class="col-md-6">
                                     <input type="text" id="shopGstin" class="form-control" placeholder="GSTIN (Optional)" onkeyup="updateInvoicePreview()">
                                 </div>
                                 <div class="col-md-6">
                                     <label for="qrUpload" class="form-label small">Upload UPI QR (Optional)</label>
                                     <input type="file" class="form-control form-control-sm" id="qrUpload" accept="image/*">
                                 </div>
                            </div>
        
                            <div class="row g-3 mb-4">
                                <h5>üë§ Customer Details</h5>
                                 <div class="col-md-6">
                                     <input type="text" id="customerName" class="form-control" placeholder="Customer Name" onkeyup="updateInvoicePreview()">
                                 </div>
                                 <div class="col-md-6">
                                     <input type="text" id="customerContact" class="form-control" placeholder="Contact No." onkeyup="updateInvoicePreview()">
                                 </div>
                                <div class="col-12">
                                    <input type="text" id="customerAddress" class="form-control" placeholder="Customer Address" onkeyup="updateInvoicePreview()">
                                </div>
                            </div>
        
                            <h5 class="mb-3">‚ûï Add Items</h5>
                            <form id="item-form" class="row g-2 align-items-center">
                                <div class="col-sm-12 mb-2">
                                    <input type="text" id="itemName" class="form-control" placeholder="Item Name">
                                </div>
                                <div class="col-sm-3">
                                    <input type="number" id="quantity" class="form-control" placeholder="Qty">
                                </div>
                                 <div class="col-sm-4">
                                     <input type="number" id="price" class="form-control" placeholder="Rate">
                                 </div>
                                 <div class="col-sm-3">
                                     <input type="number" id="gst" class="form-control" placeholder="GST %">
                                 </div>
                                <div class="col-sm-2">
                                    <button type="button" class="btn btn-success w-100" onclick="addItem()">Add</button>
                                </div>
                            </form>
                            <hr>
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button class="btn btn-info text-white" onclick="printInvoice()">üñ®Ô∏è Print Invoice</button>
                                <button class="btn btn-danger" onclick="clearBill()">üóëÔ∏è Clear Bill</button>
                            </div>
                        </div>
                    </div>
                </div>
        
                <div class="col-lg-7">
                    <div id="invoice-preview">
                        <div class="text-center text-muted p-5">Please fill details and add items to see the invoice preview.</div>
                    </div>
                </div>
            </div>
        </section>

        <section id="purchases" class="section">
            <h2 class="mb-4 text-primary">‡§ñ‡§∞‡•Ä‡§¶ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°</h2>
            <div class="card mb-4">
                <div class="card-header">‡§®‡§à ‡§ñ‡§∞‡•Ä‡§¶ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç</div>
                <div class="card-body">
                    <form id="add-purchase-form" class="row g-3">
                        <div class="col-md-3">
                            <label for="purchase-bill-number" class="form-label">‡§¨‡§ø‡§≤ / ‡§ö‡§æ‡§≤‡§æ‡§® ‡§®‡§Ç.</label>
                            <input type="text" class="form-control" id="purchase-bill-number" required>
                        </div>
                        <div class="col-md-3">
                            <label for="purchase-supplier" class="form-label">‡§Ü‡§™‡•Ç‡§∞‡•ç‡§§‡§ø‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
                            <input type="text" class="form-control" id="purchase-supplier" required>
                        </div>
                        <div class="col-md-3">
                            <label for="purchase-date" class="form-label">‡§ñ‡§∞‡•Ä‡§¶ ‡§ï‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ</label>
                            <input type="date" class="form-control" id="purchase-date" required>
                        </div>
                        <div class="col-md-3">
                            <label for="purchase-total-cost" class="form-label">‡§ï‡•Å‡§≤ ‡§¨‡§ø‡§≤ ‡§∞‡§æ‡§∂‡§ø (‚Çπ)</label>
                            <input type="number" step="0.01" class="form-control" id="purchase-total-cost" required min="0">
                        </div>
                    
                        <hr class="my-3 col-12">
                        <h6 class="col-12 text-primary">GST ‡§µ‡§ø‡§µ‡§∞‡§£ (GSTR-2 ‡§ï‡•á ‡§≤‡§ø‡§è)</h6>
                        
                        <div class="col-md-3">
                            <label for="purchase-taxable-value" class="form-label">‡§ü‡•à‡§ï‡•ç‡§∏‡•á‡§¨‡§≤ ‡§µ‡•à‡§≤‡•ç‡§Ø‡•Ç (‚Çπ)</label>
                            <input type="number" step="0.01" class="form-control" id="purchase-taxable-value" min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="purchase-cgst" class="form-label">CGST (‚Çπ)</label>
                            <input type="number" step="0.01" class="form-control" id="purchase-cgst" value="0" min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="purchase-sgst" class="form-label">SGST (‚Çπ)</label>
                            <input type="number" step="0.01" class="form-control" id="purchase-sgst" value="0" min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="purchase-igst" class="form-label">IGST (‚Çπ)</label>
                            <input type="number" step="0.01" class="form-control" id="purchase-igst" value="0" min="0">
                        </div>
                    
                        <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-success w-100">‡§ñ‡§∞‡•Ä‡§¶ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ï‡§∞‡•á‡§Ç</button>
                        </div>
                    </form>                </div>
            </div>

            <div class="card">
                <div class="card-header">‡§π‡§æ‡§≤ ‡§ï‡•Ä ‡§ñ‡§∞‡•Ä‡§¶ ‡§ï‡§æ ‡§á‡§§‡§ø‡§π‡§æ‡§∏</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>‡§¨‡§ø‡§≤ ‡§®‡§Ç.</th>
                                    <th>‡§Ü‡§™‡•Ç‡§∞‡•ç‡§§‡§ø‡§ï‡§∞‡•ç‡§§‡§æ</th>
                                    <th>‡§Ü‡§á‡§ü‡§Æ</th>
                                    <th>‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø</th>
                                    <th>‡§§‡§ø‡§•‡§ø</th>
                                    <th>‡§è‡§ï‡•ç‡§∂‡§®</th>
                                </tr>
                            </thead>
                            <tbody id="purchases-table-body">
                                <tr><td colspan="6" class="text-center text-muted">‡§ï‡•ã‡§à ‡§ñ‡§∞‡•Ä‡§¶ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ</td></tr>
                            </tbody>
                            <tfoot id="purchases-table-foot"></tfoot> 
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="crm" class="section">
            <h2 class="mb-4 text-primary">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§∏‡§Ç‡§¨‡§Ç‡§ß ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® (CRM)</h2>
            <div class="card mb-4">
                <div class="card-header">‡§®‡§Ø‡§æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</div>
                <div class="card-body">
                    <form id="add-customer-form" class="row g-3">
                        <div class="col-md-4">
                            <label for="customer-name" class="form-label">‡§®‡§æ‡§Æ</label>
                            <input type="text" class="form-control" id="customer-name" required>
                        </div>
                        <div class="col-md-4">
                            <label for="customer-phone" class="form-label">‡§´‡§º‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞</label>
                            <input type="tel" class="form-control" id="customer-phone">
                        </div>
                        <div class="col-md-4">
                            <label for="customer-email" class="form-label">‡§à‡§Æ‡•á‡§≤ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)</label>
                            <input type="email" class="form-control" id="customer-email">
                        </div>
                        <div class="col-12">
                            <label for="customer-address" class="form-label">‡§™‡§§‡§æ (Address)</label>
                            <textarea class="form-control" id="customer-address" rows="1"></textarea>
                        </div>
                         <div class="col-md-6">
                            <label for="customer-gstin" class="form-label">GSTIN (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)</label>
                            <input type="text" class="form-control" id="customer-gstin" maxlength="15">
                        </div>
                        <div class="col-md-6">
                            <label for="customer-balance" class="form-label">‡§™‡§ø‡§õ‡§≤‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ (‚Çπ)</label>
                            <input type="number" step="0.01" class="form-control" id="customer-balance" value="0" min="0">
                        </div>
                       <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-primary w-100">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡•ã ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="card">
                <div class="card-header">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§∏‡•Ç‡§ö‡•Ä</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>‡§®‡§æ‡§Æ</th>
                                    <th>‡§´‡§º‡•ã‡§®</th>
                                    <th>‡§™‡§§‡§æ</th>
                                    <th>‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ</th>
                                    <th>‡§è‡§ï‡•ç‡§∂‡§®</th>
                                </tr>
                            </thead>
                            <tbody id="crm-table-body">
                                <tr><td colspan="6" class="text-center text-muted">‡§ï‡•ã‡§à ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="expenses" class="section">
            <h2 class="mb-4 text-primary">‡§ñ‡§∞‡•ç‡§ö ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®</h2>
            <div class="card mb-4">
                <div class="card-header">‡§®‡§Ø‡§æ ‡§ñ‡§∞‡•ç‡§ö ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç</div>
                <div class="card-body">
                    <form id="add-expense-form" class="row g-3">
                        <div class="col-md-4">
                            <label for="expense-date" class="form-label">‡§§‡§ø‡§•‡§ø</label>
                            <input type="date" class="form-control" id="expense-date" value="" required>
                        </div>
                        <div class="col-md-4">
                            <label for="expense-category" class="form-label">‡§∂‡•ç‡§∞‡•á‡§£‡•Ä</label>
                            <select class="form-select" id="expense-category" required>
                                <option value="" disabled selected>‡§∂‡•ç‡§∞‡•á‡§£‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç</option>
                                <option value="Salary">‡§µ‡•á‡§§‡§® (Salary)</option>
                                <option value="Rent">‡§ï‡§ø‡§∞‡§æ‡§Ø‡§æ (Rent)</option>
                                <option value="Utilities">‡§Ø‡•Ç‡§ü‡§ø‡§≤‡§ø‡§ü‡•Ä‡§ú (‡§¨‡§ø‡§ú‡§≤‡•Ä/‡§™‡§æ‡§®‡•Ä)</option>
                                <option value="Marketing">‡§Æ‡§æ‡§∞‡•ç‡§ï‡•á‡§ü‡§ø‡§Ç‡§ó</option>
                                <option value="Miscellaneous">‡§µ‡§ø‡§µ‡§ø‡§ß</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="expense-amount" class="form-label">‡§∞‡§æ‡§∂‡§ø (‚Çπ)</label>
                            <input type="number" step="0.01" class="form-control" id="expense-amount" required min="0">
                        </div>
                        <div class="col-12">
                            <label for="expense-description" class="form-label">‡§µ‡§ø‡§µ‡§∞‡§£</label>
                            <input type="text" class="form-control" id="expense-description" required>
                        </div>
                        <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-warning w-100">‡§ñ‡§∞‡•ç‡§ö ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="card">
                <div class="card-header">‡§ñ‡§∞‡•ç‡§ö ‡§ï‡§æ ‡§á‡§§‡§ø‡§π‡§æ‡§∏</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>‡§§‡§ø‡§•‡§ø</th>
                                    <th>‡§∂‡•ç‡§∞‡•á‡§£‡•Ä</th>
                                    <th>‡§µ‡§ø‡§µ‡§∞‡§£</th>
                                    <th>‡§∞‡§æ‡§∂‡§ø</th>
                                    <th>‡§è‡§ï‡•ç‡§∂‡§®</th>
                                </tr>
                            </thead>
                            <tbody id="expenses-table-body">
                                <tr><td colspan="5" class="text-center text-muted">‡§ï‡•ã‡§à ‡§ñ‡§∞‡•ç‡§ö ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ</td></tr>
                            </tbody>
                            <tfoot id="expenses-table-foot"></tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="reports" class="section">
            <h2 class="mb-4 text-primary">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏ ‡§î‡§∞ ‡§è‡§®‡§æ‡§≤‡§ø‡§ü‡§ø‡§ï‡•ç‡§∏</h2>
            <div class="row g-4">
                <div class="col-lg-12 mb-4">
                    <div class="card" id="pl-card">
                        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                            <span>‡§≤‡§æ‡§≠ ‡§î‡§∞ ‡§π‡§æ‡§®‡§ø (Profit & Loss)</span>
                            <div class="no-print">
                                <button class="btn btn-sm btn-light me-2" onclick="handleReportAction('profit_loss', 'download')"><i class="fas fa-file-download"></i> ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</button>
                                <button class="btn btn-sm btn-light" onclick="handleReportAction('profit_loss', 'print')"><i class="fas fa-print"></i> ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-sm report-table">
                                        <thead><tr><th colspan="2" class="text-center">‡§ñ‡§∞‡•ç‡§ö (Debit)</th></tr></thead>
                                        <tbody>
                                            <tr><td>‡§ï‡•Å‡§≤ ‡§ñ‡§∞‡•Ä‡§¶ (Purchases)</td><td class="text-end" id="report-pl-purchases">‚Çπ0.00</td></tr>
                                            <tr><td>‡§ï‡•Å‡§≤ ‡§ñ‡§∞‡•ç‡§ö (Expenses)</td><td class="text-end" id="report-pl-expenses">‚Çπ0.00</td></tr>
                                            <tr id="report-pl-profit-row" class="d-none"><td><b>‡§∂‡•Å‡§¶‡•ç‡§ß ‡§≤‡§æ‡§≠ (Net Profit)</b></td><td class="text-end fw-bold text-success" id="report-pl-profit">‚Çπ0.00</td></tr>
                                        </tbody>
                                        <tfoot>
                                            <tr class="fw-bold bg-light"><td >‡§ï‡•Å‡§≤ ‡§°‡•á‡§¨‡§ø‡§ü</td><td class="text-end" id="report-pl-total-debit">‚Çπ0.00</td></tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <table class="table table-sm report-table">
                                        <thead><tr><th colspan="2" class="text-center">‡§Ü‡§Ø (Credit)</th></tr></thead>
                                        <tbody>
                                            <tr><td>‡§ï‡•Å‡§≤ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä (Revenue)</td><td class="text-end" id="report-pl-revenue">‚Çπ0.00</td></tr>
                                            <tr id="report-pl-loss-row" class="d-none"><td><b>‡§∂‡•Å‡§¶‡•ç‡§ß ‡§π‡§æ‡§®‡§ø (Net Loss)</b></td><td class="text-end fw-bold text-danger" id="report-pl-loss">‚Çπ0.00</td></tr>
                                        </tbody>
                                        <tfoot>
                                            <tr class="fw-bold bg-light"><td>‡§ï‡•Å‡§≤ ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü</td><td class="text-end" id="report-pl-total-credit">‚Çπ0.00</td></tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-12">
                    <div class="card" id="bs-card">
                        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                            <span>‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§∂‡•Ä‡§ü (Balance Sheet)</span>
                             <div class="no-print">
                                <button class="btn btn-sm btn-light me-2" onclick="handleReportAction('balance_sheet', 'download')"><i class="fas fa-file-download"></i> ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</button>
                                <button class="btn btn-sm btn-light" onclick="handleReportAction('balance_sheet', 'print')"><i class="fas fa-print"></i> ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-sm report-table">
                                        <thead><tr><th colspan="2" class="text-center">‡§¶‡•á‡§®‡§¶‡§æ‡§∞‡§ø‡§Ø‡§æ‡§Ç ‡§î‡§∞ ‡§á‡§ï‡•ç‡§µ‡§ø‡§ü‡•Ä (Liabilities & Equity)</th></tr></thead>
                                        <tbody>
                                            <tr><td>GST ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§®‡•á ‡§Ø‡•ã‡§ó‡•ç‡§Ø (Payable)</td><td class="text-end" id="report-bs-gst-payable">‚Çπ0.00</td></tr>
                                            <tr><td>‡§µ‡•á‡§Ç‡§°‡§∞ ‡§ï‡•ã ‡§¶‡•á‡§Ø (Payable)</td><td class="text-end" id="report-bs-vendors-payable">‚Çπ0.00</td></tr>
                                            <tr><td>‡§Æ‡§æ‡§≤‡§ø‡§ï ‡§ï‡•Ä ‡§á‡§ï‡•ç‡§µ‡§ø‡§ü‡•Ä (Owner's Equity)</td><td class="text-end" id="report-bs-owner-equity">‚Çπ0.00</td></tr>
                                        </tbody>
                                        <tfoot>
                                            <tr class="fw-bold bg-light"><td>‡§ï‡•Å‡§≤ ‡§¶‡•á‡§®‡§¶‡§æ‡§∞‡§ø‡§Ø‡§æ‡§Ç ‡§î‡§∞ ‡§á‡§ï‡•ç‡§µ‡§ø‡§ü‡•Ä</td><td class="text-end" id="report-bs-total-liabilities">‚Çπ0.00</td></tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                     <table class="table table-sm report-table">
                                        <thead><tr><th colspan="2" class="text-center">‡§™‡§∞‡§ø‡§∏‡§Ç‡§™‡§§‡•ç‡§§‡§ø‡§Ø‡§æ‡§Ç (Assets)</th></tr></thead>
                                        <tbody>
                                            <tr><td>‡§∏‡•ç‡§ü‡•â‡§ï ‡§ï‡§æ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø (Stock Value)</td><td class="text-end" id="report-bs-stock-value">‚Çπ0.00</td></tr>
                                            <tr><td>‡§¨‡•à‡§Ç‡§ï/‡§ï‡•à‡§∂ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ (Profit)</td><td class="text-end" id="report-bs-cash-balance">‚Çπ0.00</td></tr>
                                        </tbody>
                                        <tfoot>
                                            <tr class="fw-bold bg-light"><td>‡§ï‡•Å‡§≤ ‡§™‡§∞‡§ø‡§∏‡§Ç‡§™‡§§‡•ç‡§§‡§ø‡§Ø‡§æ‡§Ç</td><td class="text-end" id="report-bs-total-assets">‚Çπ0.00</td></tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-12">
                    <div class="card" id="product-sales-card">
                        <div class="card-header bg-dark text-white">
                            <span>‡§â‡§§‡•ç‡§™‡§æ‡§¶-‡§µ‡§æ‡§∞ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§î‡§∞ ‡§≤‡§æ‡§≠ (Product-wise Sales & Profit)</span>
                        </div>
                        <div class="card-body">
                            <div class="row g-3 mb-3">
                                <div class="col-md-5">
                                    <label for="product-report-start-date" class="form-label">‡§∂‡•Å‡§∞‡•Ç‡§Ü‡§§‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ</label>
                                    <input type="date" id="product-report-start-date" class="form-control">
                                </div>
                                <div class="col-md-5">
                                    <label for="product-report-end-date" class="form-label">‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§§‡§æ‡§∞‡•Ä‡§ñ</label>
                                    <input type="date" id="product-report-end-date" class="form-control">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" id="fetch-product-sales-report-btn">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§¶‡•á‡§ñ‡•á‡§Ç</button>
                                </div>
                            </div>
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>SKU</th>
                                            <th>‡§Ü‡§á‡§ü‡§Æ</th>
                                            <th>‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ ‡§¨‡§ø‡§ï‡•Ä</th>
                                            <th>‡§ï‡•Å‡§≤ ‡§∞‡•á‡§µ‡•á‡§®‡•ç‡§Ø‡•Ç</th>
                                            <th>‡§ï‡•Å‡§≤ ‡§≤‡§æ‡§ó‡§§</th>
                                            <th>‡§ï‡•Å‡§≤ ‡§≤‡§æ‡§≠</th>
                                        </tr>
                                    </thead>
                                    <tbody id="product-sales-report-body">
                                        <tr><td colspan="6" class="text-center text-muted">‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ö‡•Å‡§®‡•á‡§Ç ‡§î‡§∞ '‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§¶‡•á‡§ñ‡•á‡§Ç' ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="staff" class="section">
            <h2 class="mb-4 text-primary">‡§∏‡•ç‡§ü‡§æ‡§´ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® (‡§è‡§°‡§Æ‡§ø‡§®)</h2>
            
            <div class="card mb-4">
                <div class="card-header bg-success text-white">‡§®‡§Ø‡§æ ‡§∏‡•ç‡§ü‡§æ‡§´ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</div>
                <div class="card-body">
                    <form id="add-staff-form" class="row g-3">
                        <div class="col-md-4">
                            <label for="staff-name" class="form-label">‡§®‡§æ‡§Æ</label>
                            <input type="text" class="form-control" id="staff-name" required placeholder="‡§ú‡•à‡§∏‡•á: ‡§∞‡§æ‡§π‡•Å‡§≤ ‡§ï‡•Å‡§Æ‡§æ‡§∞">
                        </div>
                        <div class="col-md-4">
                            <label for="staff-email" class="form-label">‡§à‡§Æ‡•á‡§≤</label>
                            <input type="email" class="form-control" id="staff-email" required placeholder="‡§ú‡•à‡§∏‡•á: rahul@example.com">
                        </div>
                        <div class="col-md-4">
                            <label for="staff-password" class="form-label">‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°</label>
                            <input type="password" class="form-control" id="staff-password" required placeholder="‡§è‡§ï ‡§Æ‡§ú‡§¨‡•Ç‡§§ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§ö‡•Å‡§®‡•á‡§Ç">
                        </div>
                        <div class="col-md-6">
                            <label for="staff-role" class="form-label">‡§∞‡•ã‡§≤ (‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ)</label>
                            <select id="staff-role" class="form-select">
                                <option value="CASHIER" selected>‡§ï‡•à‡§∂‡§ø‡§Ø‡§∞ (Cashier)</option>
                                <option value="MANAGER">‡§Æ‡•à‡§®‡•á‡§ú‡§∞ (Manager)</option>
                                <option value="ADMIN">‡§è‡§°‡§Æ‡§ø‡§® (Admin)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="staff-status" class="form-label">‡§∏‡•ç‡§•‡§ø‡§§‡§ø (Status)</label>
                            <select id="staff-status" class="form-select">
                                <option value="pending" selected>‡§™‡•á‡§Ç‡§°‡§ø‡§Ç‡§ó (Pending)</option>
                                <option value="active">‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø (Active)</option>
                                <option value="disabled">‡§Ö‡§ï‡•ç‡§∑‡§Æ (Disabled)</option>
                            </select>
                        </div>
                        <div class="col-12 mt-3">
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-user-plus me-2"></i>‡§∏‡•ç‡§ü‡§æ‡§´ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        
            <div class="card">
                <div class="card-header">‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§∏‡•ç‡§ü‡§æ‡§´ ‡§∏‡§¶‡§∏‡•ç‡§Ø</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>‡§®‡§æ‡§Æ</th>
                                    <th>‡§à‡§Æ‡•á‡§≤</th>
                                    <th>‡§∞‡•ã‡§≤</th>
                                    <th>‡§∏‡•ç‡§•‡§ø‡§§‡§ø</th>
                                    <th>‡§¨‡§®‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ</th>
                                    <th>‡§è‡§ï‡•ç‡§∂‡§®</th>
                                </tr>
                            </thead>
                            <tbody id="staff-table-body">
                                <tr><td colspan="7" class="text-center text-muted py-4">‡§∏‡•ç‡§ü‡§æ‡§´ ‡§∏‡•Ç‡§ö‡•Ä ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        
            <div class="modal fade" id="editStaffModal" tabindex="-1" aria-labelledby="editStaffModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="editStaffModalLabel">
                        <i class="fas fa-user-edit me-2"></i>‡§∏‡•ç‡§ü‡§æ‡§´ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <form id="edit-staff-form">
                      <div class="modal-body">
                          <input type="hidden" id="edit-staff-id">
                          <div class="mb-3">
                              <label for="edit-staff-name" class="form-label">‡§®‡§æ‡§Æ</label>
                              <input type="text" class="form-control" id="edit-staff-name" required>
                          </div>
                          <div class="mb-3">
                              <label for="edit-staff-email" class="form-label">‡§à‡§Æ‡•á‡§≤ (‡§¨‡§¶‡§≤‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ)</label>
                              <input type="email" class="form-control" id="edit-staff-email" disabled readonly>
                          </div>
                          <div class="mb-3">
                            <label for="edit-staff-role" class="form-label">‡§∞‡•ã‡§≤ (‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ)</label>
                            <select id="edit-staff-role" class="form-select">
                                <option value="CASHIER">‡§ï‡•à‡§∂‡§ø‡§Ø‡§∞ (Cashier)</option>
                                <option value="MANAGER">‡§Æ‡•à‡§®‡•á‡§ú‡§∞ (Manager)</option>
                                <option value="ADMIN">‡§è‡§°‡§Æ‡§ø‡§® (Admin)</option>
                            </select>
                          </div>
                          <div class="mb-3">
                            <label for="edit-staff-status" class="form-label">‡§∏‡•ç‡§•‡§ø‡§§‡§ø (Status)</label>
                            <select id="edit-staff-status" class="form-select">
                                <option value="pending">‡§™‡•á‡§Ç‡§°‡§ø‡§Ç‡§ó (Pending)</option>
                                <option value="active">‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø (Active)</option>
                                <option value="disabled">‡§Ö‡§ï‡•ç‡§∑‡§Æ (Disabled)</option>
                            </select>
                          </div>
                           <div class="mb-3">
                              <label for="edit-staff-password" class="form-label">‡§®‡§Ø‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° (‡§Ö‡§ó‡§∞ ‡§¨‡§¶‡§≤‡§®‡§æ ‡§π‡•à)</label>
                              <input type="password" class="form-control" id="edit-staff-password" placeholder="‡§ñ‡§æ‡§≤‡•Ä ‡§õ‡•ã‡§°‡§º ‡§¶‡•á‡§Ç ‡§Ö‡§ó‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§¨‡§¶‡§≤‡§®‡§æ ‡§π‡•à">
                              <div class="form-text">‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¨‡§¶‡§≤‡§®‡•á ‡§ï‡•Ä ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§™‡§∞ ‡§≤‡§æ‡§ó‡•Ç ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡•á‡§ó‡•Ä‡•§</div>
                          </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>‡§¨‡§¶‡§≤‡§æ‡§µ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç
                        </button>
                      </div>
                  </form>
                </div>
              </div>
            </div>
        </section>

        <section id="gst-reports" class="section">
            <h2 class="mb-4 text-primary">GST ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏ (Simplified)</h2>
            <p class="text-muted">‡§Ø‡•á ‡§Ü‡§™‡§ï‡•á ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡•Ä ‡§ó‡§à ‡§∏‡§∞‡§≤‡•Ä‡§ï‡•É‡§§ (simplified) GST ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§π‡•à‡§Ç‡•§ </p>
            
            <div class="card">
                <div class="card-header">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏ ‡§ú‡•á‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç</div>
                <div class="card-body">
                    <div class="row g-3 mb-4">
                        <div class="col-md-5">
                            <label for="gst-report-start-date" class="form-label">‡§∂‡•Å‡§∞‡•Ç‡§Ü‡§§‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ</label>
                            <input type="date" id="gst-report-start-date" class="form-control" value="">
                        </div>
                        <div class="col-md-5">
                            <label for="gst-report-end-date" class="form-label">‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§§‡§æ‡§∞‡•Ä‡§ñ</label>
                            <input type="date" id="gst-report-end-date" class="form-control" value="">
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <button class="btn btn-info w-100" id="fetch-gstr1-report-btn">GSTR-1 (‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä) ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§¶‡•á‡§ñ‡•á‡§Ç</button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-warning w-100" id="fetch-gstr2-report-btn">GSTR-2 (‡§ñ‡§∞‡•Ä‡§¶) ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§¶‡•á‡§ñ‡•á‡§Ç</button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-secondary w-100" id="fetch-gstr3b-report-btn">GSTR-3B (‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂) ‡§¶‡•á‡§ñ‡•á‡§Ç</button>
                        </div>
                    </div>
                    <p class="text-muted small mt-3">‡§®‡•ã‡§ü: ‡§Ø‡§π GSTR ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§Ü‡§™‡§ï‡•á ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ '‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä (POS)' ‡§î‡§∞ '‡§ó‡•ç‡§∞‡§æ‡§π‡§ï (CRM)' ‡§Æ‡•á‡§Ç ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§ø‡§è ‡§ó‡§è ‡§°‡•á‡§ü‡§æ ‡§™‡§∞ ‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§π‡•à‡•§ </p>

                    <hr class="my-4">
                    
                    <h5 id="gst-report-title">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∞‡§ø‡§ú‡§≤‡•ç‡§ü</h5>
                    <div id="gst-report-result">
                        <div class="text-muted text-center py-4">‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ö‡•Å‡§®‡•á‡§Ç ‡§î‡§∞ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§¨‡§ü‡§® ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§</div>
                        
                        <div id="gstr1-report-template" style="display: none;">


                            
                           <!-- ============ TALLY-STYLE GST REPORT HTML START ============ -->
<!-- ‡§Ø‡§π Tally-Style ‡§ü‡•à‡§¨ ‡§≤‡•á‡§Ü‡§â‡§ü ‡§π‡•à -->

<!-- Tab Navigation (GSTR-1, 2, 3B) -->
<nav class="gst-report-tabs mt-4">
    <div class="nav nav-tabs" id="gstReportTab" role="tablist">
        <button class="nav-link active" id="gst-gstr1-tab" data-bs-toggle="tab" data-bs-target="#gst-gstr1" type="button" role="tab" aria-controls="gst-gstr1" aria-selected="true">
            GSTR-1 (‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä)
        </button>
        <button class="nav-link" id="gst-gstr2-tab" data-bs-toggle="tab" data-bs-target="#gst-gstr2" type="button" role="tab" aria-controls="gst-gstr2" aria-selected="false">
            GSTR-2 (‡§ñ‡§∞‡•Ä‡§¶ ITC)
        </button>
        <button class="nav-link" id="gst-gstr3b-tab" data-bs-toggle="tab" data-bs-target="#gst-gstr3b" type="button" role="tab" aria-controls="gst-gstr3b" aria-selected="false">
            GSTR-3B (‡§∏‡§Æ‡§∞‡•Ä)
        </button>
    </div>
</nav>

<!-- Tab Content (Main Body) -->
<div class="tab-content gst-report-tab-content" id="gstReportTabContent">
    
    <!-- GSTR-1 Pane (‡§Ø‡§π GSTR-1 ‡§¨‡§ü‡§® ‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡§æ ‡§π‡•à) -->
    <div class="tab-pane fade show active" id="gst-gstr1" role="tabpanel" aria-labelledby="gst-gstr1-tab">
        <div id="gstr1-report-content" class="report-content-area">
            <p class="text-muted text-center py-4">‡§ï‡•É‡§™‡§Ø‡§æ ‡§ä‡§™‡§∞ ‡§¶‡§ø‡§è ‡§ó‡§è 'GSTR-1 (‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä) ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§¶‡•á‡§ñ‡•á‡§Ç' ‡§¨‡§ü‡§® ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§</p>
            <!-- GSTR-1 ‡§°‡•á‡§ü‡§æ JavaScript ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§Ø‡§π‡§æ‡§Å ‡§≠‡§∞‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ -->
        </div>
        
        <!-- GSTR-1 ‡§ï‡•á ‡§≤‡§ø‡§è ‡§õ‡§ø‡§™‡§æ ‡§π‡•Å‡§Ü ‡§ü‡•á‡§Æ‡•ç‡§™‡§≤‡•á‡§ü (JavaScript ‡§á‡§∏‡§ï‡§æ ‡§á‡§∏‡•ç‡§§‡•á‡§Æ‡§æ‡§≤ ‡§ï‡§∞‡•á‡§ó‡§æ) -->
        <div id="gstr1-report-template" style="display: none;">
            <nav class="gst-report-tabs">
                <div class="nav nav-tabs" id="gstr1-inner-tab" role="tablist">
                    <button class="nav-link active" id="gstr1-b2b-tab" data-bs-toggle="tab" data-bs-target="#gstr1-b2b" type="button" role="tab">B2B (GSTIN ‡§µ‡§æ‡§≤‡•Ä ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä)</button>
                    <button class="nav-link" id="gstr1-b2c-tab" data-bs-toggle="tab" data-bs-target="#gstr1-b2c" type="button" role="tab">B2C (‡§õ‡•ã‡§ü‡•Ä ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä)</button>
                    <button class="nav-link" id="gstr1-hsn-tab" data-bs-toggle="tab" data-bs-target="#gstr1-hsn" type="button" role="tab">HSN/SAC ‡§∏‡§Æ‡§∞‡•Ä</button>
                </div>
            </nav>
            <div class="tab-content gst-report-tab-content" id="gstr1-inner-tabContent">
                <div class="tab-pane fade show active" id="gstr1-b2b" role="tabpanel">
                    <h6>GSTR-1: B2B (‡§™‡§Ç‡§ú‡•Ä‡§ï‡•É‡§§ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï‡•ã‡§Ç ‡§ï‡•ã ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä)</h6>
                    <p class="small text-muted">‡§µ‡§π ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§ú‡§π‡§æ‡§Å ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ GSTIN ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§•‡§æ‡•§</p>
                    <div class="table-responsive">
                        <table class="table gst-report-table" id="gstr1-b2b-table">
                            <thead><tr><th>‡§ó‡•ç‡§∞‡§æ‡§π‡§ï GSTIN</th><th class="text-left">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ</th><th>‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§®‡§Ç.</th><th>‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§§‡§æ‡§∞‡•Ä‡§ñ</th><th>‡§ü‡•à‡§ï‡•ç‡§∏‡•á‡§¨‡§≤ ‡§µ‡•à‡§≤‡•ç‡§Ø‡•Ç (‚Çπ)</th><th>IGST (‚Çπ)</th><th>CGST (‚Çπ)</th><th>SGST (‚Çπ)</th></tr></thead>
                            <tbody></tbody>
                            <tfoot></tfoot>
                        </table>
                    </div>
                </div>
                <div class="tab-pane fade" id="gstr1-b2c" role="tabpanel">
                    <h6>GSTR-1: B2C(S) (‡§õ‡•ã‡§ü‡•Ä ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§∏‡§Æ‡§∞‡•Ä)</h6>
                    <p class="small text-muted">‡§µ‡§π ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§ú‡§π‡§æ‡§Å ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ GSTIN ‡§¶‡§∞‡•ç‡§ú ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§•‡§æ (‡§∞‡§æ‡§ú‡•ç‡§Ø ‡§î‡§∞ GST ‡§¶‡§∞ ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞)‡•§</p>
                    <div class="table-responsive">
                        <table class="table gst-report-table" id="gstr1-b2c-table">
                            <thead><tr><th class="text-left">‡§∏‡§™‡•ç‡§≤‡§æ‡§à ‡§ï‡§æ ‡§∞‡§æ‡§ú‡•ç‡§Ø</th><th>GST ‡§¶‡§∞ (%)</th><th>‡§ü‡•à‡§ï‡•ç‡§∏‡•á‡§¨‡§≤ ‡§µ‡•à‡§≤‡•ç‡§Ø‡•Ç (‚Çπ)</th><th>IGST (‚Çπ)</th><th>CGST (‚Çπ)</th><th>SGST (‚Çπ)</th><th>‡§ï‡•Å‡§≤ ‡§ü‡•à‡§ï‡•ç‡§∏ (‚Çπ)</th></tr></thead>
                            <tbody></tbody>
                            <tfoot></tfoot>
                        </table>
                    </div>
                </div>
                <div class="tab-pane fade" id="gstr1-hsn" role="tabpanel">
                    <h6>GSTR-1: HSN/SAC ‡§∏‡§Æ‡§∞‡•Ä (‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä)</h6>
                    <p class="small text-muted">‡§¨‡•á‡§ö‡•á ‡§ó‡§è ‡§Ü‡§á‡§ü‡§Æ ‡§ï‡•Ä HSN ‡§ï‡•ã‡§° ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§∏‡§Æ‡§∞‡•Ä‡•§</p>
                    <div class="table-responsive">
                        <table class="table gst-report-table" id="gstr1-hsn-table">
                            <thead><tr><th>HSN ‡§ï‡•ã‡§°</th><th class="text-left">‡§Ü‡§á‡§ü‡§Æ ‡§ï‡§æ ‡§®‡§æ‡§Æ</th><th>‡§Ø‡•Ç‡§®‡§ø‡§ü</th><th>‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (Qty)</th><th>‡§ü‡•à‡§ï‡•ç‡§∏‡•á‡§¨‡§≤ ‡§µ‡•à‡§≤‡•ç‡§Ø‡•Ç (‚Çπ)</th><th>IGST (‚Çπ)</th><th>CGST (‚Çπ)</th><th>SGST (‚Çπ)</th><th>‡§ï‡•Å‡§≤ ‡§ü‡•à‡§ï‡•ç‡§∏ (‚Çπ)</th></tr></thead>
                            <tbody></tbody>
                            <tfoot></tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GSTR-2 Pane (‡§Ø‡§π GSTR-2 ‡§¨‡§ü‡§® ‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡§æ ‡§π‡•à) -->
    <div class="tab-pane fade" id="gst-gstr2" role="tabpanel" aria-labelledby="gst-gstr2-tab">
        <div id="gstr2-report-content" class="report-content-area">
            <p class="text-muted text-center py-4">‡§ï‡•É‡§™‡§Ø‡§æ ‡§ä‡§™‡§∞ ‡§¶‡§ø‡§è ‡§ó‡§è 'GSTR-2 (‡§ñ‡§∞‡•Ä‡§¶) ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§¶‡•á‡§ñ‡•á‡§Ç' ‡§¨‡§ü‡§® ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§</p>
            <!-- GSTR-2 ‡§°‡•á‡§ü‡§æ JavaScript ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§Ø‡§π‡§æ‡§Å ‡§≠‡§∞‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ -->
        </div>
    </div>

    <!-- GSTR-3B Pane (‡§Ø‡§π GSTR-3B ‡§¨‡§ü‡§® ‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡§æ ‡§π‡•à) -->
    <div class="tab-pane fade" id="gst-gstr3b" role="tabpanel" aria-labelledby="gst-gstr3b-tab">
        <div id="gstr3b-report-content" class="report-content-area">
            <p class="text-muted text-center py-4">‡§ï‡•É‡§™‡§Ø‡§æ ‡§ä‡§™‡§∞ ‡§¶‡§ø‡§è ‡§ó‡§è 'GSTR-3B (‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂) ‡§¶‡•á‡§ñ‡•á‡§Ç' ‡§¨‡§ü‡§® ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§</p>
            <!-- GSTR-3B ‡§°‡•á‡§ü‡§æ JavaScript ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§Ø‡§π‡§æ‡§Å ‡§≠‡§∞‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ -->
        </div>
    </div>
</div>
</section>
<!-- ============ TALLY-STYLE GST REPORT HTML END ============ -->


<section id="bank-reconciliation" class="section">
    <h2 class="mb-4 text-primary">‡§¨‡•à‡§Ç‡§ï ‡§∞‡§ø‡§ï‡•â‡§®‡•ç‡§∏‡§ø‡§≤‡•á‡§∂‡§®</h2>
    
    <div class="card mb-4" id="reconciliation-setup">
        <div class="card-header">
            ‡§®‡§Ø‡§æ ‡§∞‡§ø‡§ï‡•â‡§®‡•ç‡§∏‡§ø‡§≤‡•á‡§∂‡§® ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç
        </div>
        <div class="card-body">
            <form id="reconciliation-start-form">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="recon-statement-date" class="form-label">‡§¨‡•à‡§Ç‡§ï ‡§∏‡•ç‡§ü‡•á‡§ü‡§Æ‡•á‡§Ç‡§ü ‡§ï‡•Ä ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§§‡§ø‡§•‡§ø</label>
                        <input type="date" class="form-control" id="recon-statement-date" required>
                    </div>
                    <div class="col-md-4">
                        <label for="recon-statement-balance" class="form-label">‡§∏‡•ç‡§ü‡•á‡§ü‡§Æ‡•á‡§Ç‡§ü ‡§ï‡§æ ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ (‚Çπ)</label>
                        <input type="number" step="0.01" class="form-control" id="recon-statement-balance" required>
                    </div>
                    <div class="col-md-4">
                        <label for="recon-statement-csv" class="form-label">‡§¨‡•à‡§Ç‡§ï ‡§∏‡•ç‡§ü‡•á‡§ü‡§Æ‡•á‡§Ç‡§ü ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç (.csv)</label>
                        <input type="file" class="form-control" id="recon-statement-csv" accept=".csv" required>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <p class="text-muted small">‡§Ø‡§π ‡§´‡§º‡§æ‡§á‡§≤ ‡§Ü‡§™ ‡§Ö‡§™‡§®‡•á ‡§¨‡•à‡§Ç‡§ï ‡§ï‡•Ä ‡§®‡•á‡§ü ‡§¨‡•à‡§Ç‡§ï‡§ø‡§Ç‡§ó ‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü ‡§™‡§∞ 'Account Statement' > 'Download Statement' ‡§∏‡•á‡§ï‡•ç‡§∂‡§® ‡§∏‡•á CSV ‡§´‡•â‡§∞‡•ç‡§Æ‡•á‡§ü ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§â‡§∏‡§Æ‡•á‡§Ç 'Date', 'Description', 'Debit'/'Withdrawal', ‡§î‡§∞ 'Credit'/'Deposit' ‡§ï‡•â‡§≤‡§Æ ‡§π‡•ã‡§Ç‡•§
                    </div>
                </div>
                <hr>
                <div class="text-end">
                    <button type="submit" class="btn btn-primary btn-lg" id="start-reconciliation-btn">
                        <i class="fas fa-play me-2"></i> ‡§∞‡§ø‡§ï‡•â‡§®‡•ç‡§∏‡§ø‡§≤‡•á‡§∂‡§® ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="reconciliation-matching-area" class="hidden">
        <h3 class="mb-3">‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä‡§ú‡§º ‡§ï‡§æ ‡§Æ‡§ø‡§≤‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç</h3>
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        Dukan Pro (‡§¨‡•Å‡§ï) ‡§ü‡•ç‡§∞‡§æ‡§Ç‡§ú‡•à‡§ï‡•ç‡§∂‡§®
                        <span id="book-total" class="badge bg-light text-dark float-end">‚Çπ0.00</span>
                    </div>
                    <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="check-all-book"></th>
                                    <th>‡§µ‡§ø‡§µ‡§∞‡§£</th>
                                    <th>‡§∞‡§æ‡§∂‡§ø (‚Çπ)</th>
                                </tr>
                            </thead>
                            <tbody id="book-transactions-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        ‡§¨‡•à‡§Ç‡§ï ‡§∏‡•ç‡§ü‡•á‡§ü‡§Æ‡•á‡§Ç‡§ü ‡§ü‡•ç‡§∞‡§æ‡§Ç‡§ú‡•à‡§ï‡•ç‡§∂‡§®
                        <span id="bank-total" class="badge bg-light text-dark float-end">‚Çπ0.00</span>
                    </div>
                    <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="check-all-bank"></th>
                                    <th>‡§µ‡§ø‡§µ‡§∞‡§£</th>
                                    <th>‡§∞‡§æ‡§∂‡§ø (‚Çπ)</th>
                                </tr>
                            </thead>
                            <tbody id="bank-transactions-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header bg-dark text-white">
                ‡§∞‡§ø‡§ï‡•â‡§®‡•ç‡§∏‡§ø‡§≤‡•á‡§∂‡§® ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂)
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <table class="table" id="reconciliation-report-table">
                            <tbody>
                                <tr>
                                    <td>‡§¨‡•à‡§Ç‡§ï ‡§∏‡•ç‡§ü‡•á‡§ü‡§Æ‡•á‡§Ç‡§ü ‡§ï‡§æ ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏</td>
                                    <td class="text-end" id="report-statement-balance">‚Çπ0.00</td>
                                </tr>
                                <tr>
                                    <td>‡§µ‡•á ‡§™‡•á‡§Æ‡•á‡§Ç‡§ü‡•ç‡§∏ ‡§ú‡•ã ‡§Ö‡§≠‡•Ä ‡§ï‡•ç‡§≤‡§ø‡§Ø‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§è (Uncleared Payments)</td>
                                    <td class="text-end" id="report-uncleared-payments">‚Çπ0.00</td>
                                </tr>
                                <tr>
                                    <td>‡§µ‡•á ‡§°‡§ø‡§™‡•â‡§ú‡§ø‡§ü ‡§ú‡•ã ‡§Ö‡§≠‡•Ä ‡§ï‡•ç‡§≤‡§ø‡§Ø‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§è (Uncleared Deposits)</td>
                                    <td class="text-end" id="report-uncleared-deposits">‚Çπ0.00</td>
                                </tr>
                                <tr class="fw-bold">
                                    <td>Dukan Pro (‡§¨‡•Å‡§ï) ‡§Æ‡•á‡§Ç ‡§è‡§°‡§ú‡§∏‡•ç‡§ü‡•á‡§° ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏</td>
                                    <td class="text-end" id="report-adjusted-balance">‚Çπ0.00</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-4 d-flex align-items-center justify-content-center">
                        <div id="reconciliation-status-box" class="p-3 text-center">
                            <h4 id="difference-amount" class="text-danger fw-bold">‚Çπ0.00 ‡§ï‡§æ ‡§Ö‡§Ç‡§§‡§∞</h4>
                            <p id="difference-status" class="text-muted">‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§Æ‡•à‡§ö ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü</p>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="text-end">
                    <button class="btn btn-secondary" id="cancel-reconciliation-btn">‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
                    <button class="btn btn-success" id="save-reconciliation-btn" disabled>
                        <i class="fas fa-save me-2"></i> ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç
                    </button>
                </div>
            </div>
        </div>
    </div> 
    <div class="card mt-4" id="previous-reports-area">
        <div class="card-header bg-secondary text-white">
            ‡§™‡§ø‡§õ‡§≤‡•Ä ‡§∞‡§ø‡§ï‡•â‡§®‡•ç‡§∏‡§ø‡§≤‡•á‡§∂‡§® ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏
        </div>
        <div class="card-body">
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ID</th>
                            <th>‡§∏‡•ç‡§ü‡•á‡§ü‡§Æ‡•á‡§Ç‡§ü ‡§ï‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ</th>
                            <th>‡§¨‡•à‡§Ç‡§ï ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ (‚Çπ)</th>
                            <th>‡§Ö‡§®‡§ï‡•ç‡§≤‡§ø‡§Ø‡§∞‡§∞‡•ç‡§° ‡§Ö‡§Æ‡§æ‡§â‡§Ç‡§ü (‚Çπ)</th>
                            <th>‡§∏‡•á‡§µ ‡§ï‡•Ä ‡§ó‡§à ‡§§‡§æ‡§∞‡•Ä‡§ñ</th>
                        </tr>
                    </thead>
                    <tbody id="previous-reports-body">
                        <tr><td colspan="5" class="text-center text-muted">‡§ï‡•ã‡§à ‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    </section>

        <section id="daily-closing" class="section">
            <h2 class="mb-4 text-primary">‡§°‡•á‡§≤‡•Ä ‡§ï‡•ç‡§≤‡•ã‡§ú‡§ø‡§Ç‡§ó</h2>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header bg-success text-white">‡§Ü‡§ú ‡§ï‡•Ä ‡§ï‡•ç‡§≤‡•ã‡§ú‡§ø‡§Ç‡§ó ‡§∞‡§® ‡§ï‡§∞‡•á‡§Ç</div>
                        <div class="card-body text-center">
                            <p>‡§Ü‡§ú ‡§ï‡•Ä ‡§∏‡§≠‡•Ä ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä, ‡§ñ‡§∞‡•ç‡§ö ‡§î‡§∞ ‡§≤‡§æ‡§≠ ‡§ï‡•ã ‡§´‡§æ‡§á‡§®‡§≤ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ç‡§≤‡•ã‡§ú‡§ø‡§Ç‡§ó ‡§∞‡§® ‡§ï‡§∞‡•á‡§Ç‡•§</p>
                            <button class="btn btn-success btn-lg" id="run-daily-closing-btn">
                                <i class="fas fa-play-circle me-2"></i> ‡§Ü‡§ú ‡§ï‡•Ä ‡§ï‡•ç‡§≤‡•ã‡§ú‡§ø‡§Ç‡§ó ‡§∞‡§® ‡§ï‡§∞‡•á‡§Ç
                            </button>
                            <div id="closing-message" class="mt-3"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">‡§™‡§ø‡§õ‡§≤‡•Ä ‡§ï‡•ç‡§≤‡•ã‡§ú‡§ø‡§Ç‡§ó ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏</div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>‡§§‡§æ‡§∞‡•Ä‡§ñ</th>
                                            <th>‡§ï‡•Å‡§≤ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä</th>
                                            <th>‡§ï‡•Å‡§≤ ‡§≤‡§æ‡§ó‡§§ (COGS)</th>
                                            <th>‡§ï‡•Å‡§≤ ‡§ñ‡§∞‡•ç‡§ö</th>
                                            <th>‡§∂‡•Å‡§¶‡•ç‡§ß ‡§≤‡§æ‡§≠</th>
                                        </tr>
                                    </thead>
                                    <tbody id="daily-closing-table-body">
                                        <tr><td colspan="5" class="text-center text-muted">‡§ï‡•ã‡§à ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="data-backup" class="section">
            <h2 class="mb-4 text-primary">‡§°‡•á‡§ü‡§æ ‡§¨‡•à‡§ï‡§Ö‡§™ (‡§è‡§°‡§Æ‡§ø‡§®)</h2>
            <div class="card">
                <div class="card-header">‡§Ö‡§™‡§®‡§æ ‡§°‡•á‡§ü‡§æ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç</div>
                <div class="card-body">
                    <p>‡§Ø‡§π‡§æ‡§Å ‡§Ü‡§™ ‡§Ö‡§™‡§®‡•Ä ‡§∂‡•â‡§™ ‡§ï‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§°‡•á‡§ü‡§æ ‡§¨‡•à‡§ï‡§Ö‡§™ ‡§Ø‡§æ ‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§</p>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="card p-3 text-center">
                                <h5>‡§´‡•Å‡§≤ ‡§∂‡•â‡§™ ‡§¨‡•à‡§ï‡§Ö‡§™ (JSON)</h5>
                                <p class="small text-muted">‡§∏‡•ç‡§ü‡•â‡§ï, ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï, ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä, ‡§ñ‡§∞‡•ç‡§ö ‡§Ü‡§¶‡§ø ‡§∏‡§¨ ‡§ï‡•Å‡§õ‡•§ (‡§§‡§ï‡§®‡•Ä‡§ï‡•Ä ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡•á ‡§≤‡§ø‡§è)</p>
                                <button class="btn btn-primary" id="download-json-backup-btn">
                                    <i class="fas fa-file-code"></i> JSON ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card p-3 text-center">
                                <h5>‡§´‡•Å‡§≤ ‡§∂‡•â‡§™ ‡§¨‡•à‡§ï‡§Ö‡§™ (Excel)</h5>
                                <p class="small text-muted">‡§∏‡§≠‡•Ä ‡§°‡•á‡§ü‡§æ ‡§è‡§ï Excel ‡§´‡§º‡§æ‡§á‡§≤ ‡§Æ‡•á‡§Ç (‡§Ö‡§≤‡§ó-‡§Ö‡§≤‡§ó ‡§∂‡•Ä‡§ü‡•ç‡§∏ ‡§Æ‡•á‡§Ç)‡•§</p>
                                <button class="btn btn-success" id="download-excel-backup-btn">
                                    <i class="fas fa-file-excel"></i> Excel (.xlsx) ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card p-3 text-center">
                                <h5>‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (CSV)</h5>
                                <p class="small text-muted">‡§§‡§æ‡§∞‡•Ä‡§ñ-‡§µ‡§æ‡§∞ ‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (CSV ‡§´‡•â‡§∞‡•ç‡§Æ‡•á‡§ü)‡•§</p>
                                <button class="btn btn-info" id="download-product-sales-csv-btn">
                                    <i class="fas fa-file-csv"></i> CSV ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="shop-settings" class="section">
            <h2 class="mb-4 text-primary">‡§∂‡•â‡§™ ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ (‡§è‡§°‡§Æ‡§ø‡§®)</h2>
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-info">‡§ï‡§Ç‡§™‡§®‡•Ä ‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ (GST ‡§î‡§∞ ‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§ï‡•á ‡§≤‡§ø‡§è)</div>
                        <div class="card-body">
                            <form id="company-profile-form">
                                <div class="mb-3">
                                    <label for="company-legal-name" class="form-label">‡§∂‡•â‡§™ ‡§ï‡§æ ‡§ï‡§æ‡§®‡•Ç‡§®‡•Ä ‡§®‡§æ‡§Æ</label>
                                    <input type="text" class="form-control" id="company-legal-name">
                                </div>
                                <div class="mb-3">
                                    <label for="company-gstin" class="form-label">‡§∂‡•â‡§™ ‡§ï‡§æ GSTIN</label>
                                    <input type="text" class="form-control" id="company-gstin" maxlength="15">
                                </div>
                                <div class="mb-3">
                                    <label for="company-address" class="form-label">‡§∂‡•â‡§™ ‡§ï‡§æ ‡§™‡§§‡§æ</label>
                                    <textarea class="form-control" id="company-address" rows="2"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="company-opening-capital" class="form-label">‡§ì‡§™‡§®‡§ø‡§Ç‡§ó ‡§ï‡•à‡§™‡§ø‡§ü‡§≤ (‡§∂‡•Å‡§∞‡•Å‡§Ü‡§§‡•Ä ‡§™‡•Ç‡§Ç‡§ú‡•Ä)</label>
                                    <input type="number" step="0.01" class="form-control" id="company-opening-capital" value="0" min="0">
                                </div>
                                <button type="submit" class="btn btn-primary w-100">‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">‡§∂‡•â‡§™ ‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏</div>
                        <div class="card-body">
                            <form id="shop-display-form">
                                <div class="mb-3">
                                    <label for="shop-display-name" class="form-label">‡§∂‡•â‡§™ ‡§ï‡§æ ‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á ‡§®‡§æ‡§Æ</label>
                                    <input type="text" class="form-control" id="shop-display-name">
                                    <div class="form-text">‡§Ø‡§π ‡§®‡§æ‡§Æ ‡§∏‡§æ‡§á‡§°‡§¨‡§æ‡§∞ ‡§Æ‡•á‡§Ç ‡§∏‡§¨‡§∏‡•á ‡§ä‡§™‡§∞ ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á‡§ó‡§æ‡•§</div>
                                </div>
                                <div class="mb-3">
                                    <label for="shop-logo-upload" class="form-label">‡§∂‡•â‡§™ ‡§≤‡•ã‡§ó‡•ã (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)</label>
                                    <input type="file" class="form-control" id="shop-logo-upload" accept="image/png, image/jpeg">
                                    <div class="form-text">‡§∏‡§¨‡§∏‡•á ‡§Ö‡§ö‡•ç‡§õ‡•á ‡§∞‡§ø‡§ú‡§≤‡•ç‡§ü ‡§ï‡•á ‡§≤‡§ø‡§è 1:1 (‡§∏‡•ç‡§ï‡•ç‡§µ‡§æ‡§Ø‡§∞) ‡§á‡§Æ‡•á‡§ú ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç‡•§</div>
                                    <img id="shop-logo-preview" src="" alt="Logo Preview" class="img-thumbnail mt-2" style="max-height: 100px; display: none;">
                                </div>
                                    <button type="button" id="remove-shop-logo-btn" class="btn btn-sm btn-outline-danger mt-2 d-none" onclick="removeShopLogo()">
                                    <i class="fas fa-trash"></i> ‡§≤‡•ã‡§ó‡•ã ‡§π‡§ü‡§æ‡§è‡§Å
                                </button>
                                <button type="submit" class="btn btn-primary w-100">‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>
                            </form>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="appToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto" id="toast-title"></strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body" id="toast-body">
                    Hello, world! This is a toast message.
                </div>
            </div>
        </div>
		
		
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="./qrcode.min.js"></script>


<script>
    // --- CONFIGURATION AND GLOBAL STATE ---
   // --- CONFIGURATION AND GLOBAL STATE ---
// --- CONFIGURATION AND GLOBAL STATE ---
    // ... (‡§Ö‡§®‡•ç‡§Ø ‡§µ‡•á‡§∞‡§ø‡§è‡§¨‡§≤‡•ç‡§∏) ...
    let posWebSocket = null;
    let qrCodeDataUrl = null; // üöÄ ‡§®‡§Ø‡§æ: QR ‡§ï‡•ã‡§° ‡§á‡§Æ‡•á‡§ú ‡§°‡•á‡§ü‡§æ ‡§∞‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è
    let isWaitingForQr = false; // üöÄ ‡§®‡§Ø‡§æ: ‡§¨‡§§‡§æ‡§è‡§ó‡§æ ‡§ï‡§ø QR ‡§ï‡§æ ‡§á‡§Ç‡§§‡§ú‡§º‡§æ‡§∞ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à
    
    function isMobile() {
        try {
            if (navigator.userAgentData && navigator.userAgentData.mobile) return true;
        } catch (e) { /* ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡•á‡§Ç */ }
        return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    }
    
   
// [ initPosWebSocket ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã ‡§á‡§∏ ‡§ï‡•ã‡§° ‡§∏‡•á ‡§¨‡§¶‡§≤ ‡§¶‡•á‡§Ç ]

// [ ‡§Ø‡§π initPosWebSocket ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡§æ ‡§®‡§Ø‡§æ ‡§ï‡•ã‡§° ‡§π‡•à ]

function initPosWebSocket() {
    if (posWebSocket && posWebSocket.readyState === WebSocket.OPEN) {
        // ‡§Ö‡§ó‡§∞ ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§ñ‡•Å‡§≤‡§æ ‡§π‡•à, ‡§§‡•ã ‡§¨‡§∏ ‡§®‡§Ø‡§æ ‡§ï‡•ã‡§° ‡§Æ‡§æ‡§Å‡§ó‡•á‡§Ç ‡§î‡§∞ UI ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
        const spinner = document.getElementById('inline-pairing-spinner');
        const codeDisplay = document.getElementById('inline-pairing-code');
        const statusDisplay = document.getElementById('inline-pairing-status');
        if(spinner) spinner.style.display = 'inline-block';
        if(codeDisplay) codeDisplay.textContent = '------';
        if(statusDisplay) statusDisplay.style.display = 'none';
        posWebSocket.send(JSON.stringify({ type: 'REGISTER_POS', token: AppState.token }));
        return;
    }

    const wsUrl = __backend_url.replace('https', 'wss').replace('http', 'ws');
    posWebSocket = new WebSocket(wsUrl);

    posWebSocket.onopen = () => {
        console.log("POS WebSocket Connected");
        posWebSocket.send(JSON.stringify({ type: 'REGISTER_POS', token: AppState.token }));
    };

   // [ ‡§™‡•Å‡§∞‡§æ‡§®‡§æ onmessage ‡§¨‡§¶‡§≤‡•á‡§Ç ]
posWebSocket.onmessage = (event) => {
    const data = JSON.parse(event.data);

    // ‡§á‡§®‡§≤‡§æ‡§á‡§® ‡§è‡§≤‡§ø‡§Æ‡•á‡§Ç‡§ü‡•ç‡§∏ ‡§ï‡•ã ‡§¢‡•Ç‡§Å‡§¢‡•á‡§Ç
    const codeDisplay = document.getElementById('inline-pairing-code');
    const spinner = document.getElementById('inline-pairing-spinner');
    const statusDisplay = document.getElementById('inline-pairing-status');
    const inlineBox = document.getElementById('inline-pairing-box'); // Need inlineBox too

    // ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§ú‡§æ‡§Å‡§ö
    if (!codeDisplay || !spinner || !statusDisplay || !inlineBox) { // Check all 4
         console.error("‚ùå Fatal Error: Inline pairing elements missing in onmessage!");
         return; 
    }

    switch (data.type) {
        case 'PAIR_CODE_GENERATED':
            console.log("PAIR_CODE_GENERATED ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§π‡•Å‡§Ü:", data.pairCode);
            codeDisplay.textContent = data.pairCode; // ‡§ï‡•ã‡§° ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
            spinner.style.display = 'none'; // ‡§∏‡•ç‡§™‡§ø‡§®‡§∞ ‡§õ‡§ø‡§™‡§æ‡§è‡§Å
            statusDisplay.style.display = 'none'; 
            codeDisplay.style.display = 'inline-block'; // ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§ï‡•ã‡§° ‡§¶‡§ø‡§ñ‡•á
            inlineBox.style.display = 'block'; // ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§¶‡§ø‡§ñ‡•á
            break;

        case 'SCANNER_PAIRED':
            console.log("‡§∏‡•ç‡§ï‡•à‡§®‡§∞ ‡§™‡•á‡§Ø‡§∞ ‡§π‡•ã ‡§ó‡§Ø‡§æ!");
            spinner.style.display = 'none';
            codeDisplay.style.display = 'none'; 
            statusDisplay.style.display = 'block'; 
            // setTimeout(() => { inlineBox.style.display = 'none'; }, 3000); 
            break;

        case 'SKU_SCANNED':
            console.log("SKU ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§π‡•Å‡§Ü:", data.sku);
            handleBarcodeScan(data.sku); 
            break;

        case 'SCANNER_DISCONNECTED':
            console.log("‡§∏‡•ç‡§ï‡•à‡§®‡§∞ ‡§°‡§ø‡§∏‡•ç‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ‡•§");
            if(inlineBox) inlineBox.style.display = 'block'; 
            spinner.style.display = 'inline-block'; 
            codeDisplay.textContent = '------'; 
            codeDisplay.style.display = 'inline-block'; // Re-show display span
            statusDisplay.style.display = 'none'; 
            if (posWebSocket && posWebSocket.readyState === WebSocket.OPEN) {
               posWebSocket.send(JSON.stringify({ type: 'REGISTER_POS', token: AppState.token }));
            }
            break;
    }
};

posWebSocket.onclose = () => {
        console.log("POS WebSocket Disconnected");
        posWebSocket = null;
         const inlineBox = document.getElementById('inline-pairing-box');
         if(inlineBox) inlineBox.style.display = 'none';
    };
    posWebSocket.onerror = (error) => {
         console.error("WebSocket Error:", error);
         const inlineBox = document.getElementById('inline-pairing-box');
         if(inlineBox) {
             inlineBox.innerHTML = '<p class="text-danger small">‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§</p>';
             inlineBox.style.display = 'block';
         }
    };
}
// [ closePosWebSocket ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§¨‡§¶‡§≤‡•á‡§Ç ]
function closePosWebSocket() {
    if (posWebSocket) {
        posWebSocket.close();
        posWebSocket = null;
        console.log("WebSocket connection closed.");
    }
    // ‡§∏‡§ø‡§∞‡•ç‡§´ ‡§á‡§®‡§≤‡§æ‡§á‡§® ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§õ‡§ø‡§™‡§æ‡§è‡§Å
    const inlineBox = document.getElementById('inline-pairing-box');
    if(inlineBox) inlineBox.style.display = 'none';
}


// [ ‡§á‡§∏‡•á ‡§á‡§∏‡§∏‡•á ‡§¨‡§¶‡§≤‡•á‡§Ç ]
    function closePosWebSocket() {
        // WebSocket ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç (‡§Ö‡§ó‡§∞ ‡§ñ‡•Å‡§≤‡§æ ‡§π‡•à)
        if (posWebSocket) {
            posWebSocket.close();
            posWebSocket = null;
            console.log("WebSocket connection closed by user.");
        }
        
        // üöÄ ‡§®‡§Ø‡§æ: Modal ‡§ï‡•ã ‡§≠‡•Ä ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç (‡§Ö‡§ó‡§∞ ‡§ñ‡•Å‡§≤‡§æ ‡§π‡•à)
        if (pairingModalInstance) {
            pairingModalInstance.hide();
            console.log("Pairing modal hidden.");
        }
    }



   const __backend_url = 'https://dukan-pro-ultimate.onrender.com';
    const SERVER_TIMEOUT = 20000; // 20 seconds for slow connections
    const AppState = {
        token: null,     // Will store the JWT
        user: null,      // Will store user info (id, email, role, shopId)
        currentView: 'dashboard',
        licenseTimerId: null, // NEW: To store the license timer
    };
    
    // --- INVOICE GENERATOR PRO VARIABLES ---
    let items = [];
    let qrCodeImage = '';

    // --- POS (SALES) SECTION STATE ---
    let posCart = [];
    let currentStock = [];
    
    // --- CORE UTILITY FUNCTIONS ---
    const showLoader = (message = '‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...') => {
        document.getElementById('loading-message').innerText = message;
        document.getElementById('loading-overlay').classList.remove('hidden');
    };

    const hideLoader = () => {
        document.getElementById('loading-overlay').classList.add('hidden');
    };
    
// ==========================================================

// --- üöÄ ‡§®‡§Ø‡§æ: ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§°‡§ø‡§ü‡•á‡§ï‡•ç‡§∂‡§® ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ---


// ========== ‡§¨‡§æ‡§∞‡§ï‡•ã‡§° ‡§∏‡•ç‡§ï‡•à‡§®‡§ø‡§Ç‡§ó ‡§î‡§∞ POS ‡§≤‡•â‡§ú‡§ø‡§ï (CORE) ==========
// ==========================================================

// --- POS Section State (‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§Ø‡•á ‡§µ‡•á‡§∞‡§ø‡§è‡§¨‡§≤‡•ç‡§∏ ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§π‡•à‡§Ç) ---

/**
 * SKU (‡§¨‡§æ‡§∞‡§ï‡•ã‡§°) ‡§ï‡•ã ‡§ï‡§æ‡§∞‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§ï‡§æ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§®‡•§
 */
function addSKUToCart(sku) {
    const selectedItem = currentStock.find(item => item.sku === sku);
        
    if (selectedItem) {
        // ‡§∏‡•ç‡§ü‡•â‡§ï ‡§ï‡•Ä ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ ‡§ú‡§æ‡§Å‡§ö‡•á‡§Ç
        if(selectedItem.quantity <= 0) {
            return showMessage('‡§∏‡•ç‡§ü‡•â‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à', `${selectedItem.name} ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§`, 'danger');
        }
        
        const existingCartItem = posCart.find(item => item.sku === sku);
        if (existingCartItem) {
            // ‡§ï‡§æ‡§∞‡•ç‡§ü ‡§ï‡•á ‡§Æ‡•Å‡§ï‡§æ‡§¨‡§≤‡•á ‡§∏‡•ç‡§ü‡•â‡§ï ‡§ï‡•Ä ‡§ú‡§æ‡§Å‡§ö ‡§ï‡§∞‡•á‡§Ç
            if(existingCartItem.quantity >= selectedItem.quantity) {
                return showMessage('‡§∏‡•ç‡§ü‡•â‡§ï ‡§∏‡•Ä‡§Æ‡§ø‡§§ ‡§π‡•à', `‡§Ü‡§™‡§ï‡•á ‡§™‡§æ‡§∏ ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•á‡§Ç ‡§ï‡•á‡§µ‡§≤ ${selectedItem.quantity} ${selectedItem.name} ‡§π‡•à‡§Ç‡•§`, 'warning');
            }
            existingCartItem.quantity++;
        } else {
            posCart.push({ 
                ...selectedItem, 
                quantity: 1,
                purchase_price: parseFloat(selectedItem.purchase_price || 0),
                gst: parseFloat(selectedItem.gst || 0),
                sale_price: parseFloat(selectedItem.sale_price || 0)
            });
        }
        updatePOSCartView(); // Cart view ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
    } else {
         showMessage('‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ', `SKU ${sku} ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§`, 'warning');
    }
    
    // ‡§á‡§®‡§™‡•Å‡§ü ‡§∏‡§æ‡§´ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§∞‡§ø-‡§´‡•ã‡§ï‡§∏ ‡§ï‡§∞‡•á‡§Ç (‡§Ø‡§π ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§ó‡§æ ‡§ï‡§ø ‡§Ö‡§ó‡§≤‡§æ ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡•á)
    document.getElementById('pos-item-search').value = '';
    document.getElementById('pos-search-results').innerHTML = '';
    document.getElementById('pos-item-search').focus();
}


/**
 * ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§ø‡§è ‡§ó‡§è ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§π‡•à‡§Ç‡§°‡§≤ ‡§ï‡§∞‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§®‡•§
 */
// ‡§¨‡§¶‡§≤‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§ï‡•ã‡§°: handleBarcodeScan (‡§™‡•Ç‡§∞‡§æ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ‡§¨‡§¶‡§≤‡•á‡§Ç)
// ‡§Ø‡§π ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§ï‡§ø ‡§Ø‡§π ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§á‡§®‡§™‡•Å‡§ü ‡§∏‡•á ‡§Ø‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§∏‡•ç‡§ï‡•à‡§®‡§∞ ‡§∏‡•á SKU ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§
async function handleBarcodeScan(skuFromScanner = null) {
    let sku;
    
    // ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø SKU ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§∏‡•ç‡§ï‡•à‡§®‡§∞ ‡§Ø‡§æ ‡§´‡§ø‡§ú‡§ø‡§ï‡§≤ ‡§á‡§®‡§™‡•Å‡§ü ‡§∏‡•á ‡§Ü‡§Ø‡§æ ‡§π‡•à
    if (skuFromScanner) {
        sku = skuFromScanner;
    } else {
        const barcodeInput = document.getElementById('barcode-scanner-input');
        sku = barcodeInput.value.trim();
        barcodeInput.value = ''; // ‡§á‡§®‡§™‡•Å‡§ü ‡§ï‡•ã ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç
    }

    if (!sku) return;

    const existingItemIndex = posCart.findIndex(item => item.sku === sku);

    if (existingItemIndex !== -1) {
        // ‡§Ü‡§á‡§ü‡§Æ ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§ï‡§æ‡§∞‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§π‡•à, ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ ‡§¨‡§¢‡§º‡§æ‡§è‡§Å
        posCart[existingItemIndex].quantity += 1;
        showMessage('‡§ï‡§æ‡§∞‡•ç‡§ü ‡§Ö‡§™‡§°‡•á‡§ü', `${posCart[existingItemIndex].name} ‡§ï‡•Ä ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ ‡§¨‡§¢‡§º‡•Ä (+1)‡•§`, 'success');
        updatePOSCartView();
        return;
    }

    // ‡§∏‡•ç‡§ü‡•â‡§ï ‡§∏‡•á ‡§Ü‡§á‡§ü‡§Æ ‡§°‡•á‡§ü‡§æ ‡§≤‡§æ‡§è‡§Å
    const stockItem = await fetchApi(`/api/get-stock-item/${sku}`);
    
    if (stockItem.success && stockItem.data) { // Ensure stockItem.data exists
        const item = stockItem.data; // Note: Ensure your API returns 'data' property
        if (item.quantity <= 0) {
            showMessage('‡§∏‡•ç‡§ü‡•â‡§ï ‡§Ö‡§≤‡§∞‡•ç‡§ü', `${item.name} ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§`, 'warning');
            return;
        }
        
        posCart.push({
            sku: sku, // Use the provided SKU
            name: item.name,
            sale_price: parseFloat(item.sale_price),
            purchase_price: parseFloat(item.purchase_price || 0),
            gst: parseFloat(item.gst_rate || 0), // Use gst_rate from server
            quantity: 1
        });
        showMessage('‡§∏‡§´‡§≤‡§§‡§æ', `${item.name} ‡§ï‡§æ‡§∞‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ‡•§`, 'success');
        updatePOSCartView();

    } else {
        showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `SKU ${sku} ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§`, 'danger');
    }
}



      
    // üöÄ ‡§®‡§Ø‡§æ: WebSocket ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§î‡§∞ ‡§á‡§Ç‡§§‡§ú‡§º‡§æ‡§∞ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
    function openMobileScanner() {
    const inlineBox = document.getElementById('inline-pairing-box');
    if (!inlineBox) {
        console.error("Inline pairing box not found!");
        return;
    }

    // ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å ‡§î‡§∞ UI ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
    inlineBox.style.display = 'block';
    const spinner = document.getElementById('inline-pairing-spinner');
    const codeDisplay = document.getElementById('inline-pairing-code');
    const statusDisplay = document.getElementById('inline-pairing-status');
    if(spinner) spinner.style.display = 'inline-block'; // ‡§∏‡•ç‡§™‡§ø‡§®‡§∞ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
    if(codeDisplay) codeDisplay.textContent = '------'; // ‡§ï‡•ã‡§° ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
    if(statusDisplay) statusDisplay.style.display = 'none'; // ‡§∏‡•ç‡§ü‡•á‡§ü‡§∏ ‡§õ‡§ø‡§™‡§æ‡§è‡§Å

    // WebSocket ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç (‡§Ø‡§π ‡§ï‡•ã‡§° ‡§ú‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§≠‡•á‡§ú‡•á‡§ó‡§æ)
    initPosWebSocket(); 
}
// ‡§®‡§Ø‡§æ ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§®: ‡§™‡•ã‡§∏‡•ç‡§ü ‡§Æ‡•à‡§∏‡•á‡§ú ‡§∏‡•á ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ SKU ‡§ï‡•ã ‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
function processScannedSku(sku) {
    if (currentTab !== 'sales') {
        // ‡§Ö‡§ó‡§∞ POS ‡§ü‡•à‡§¨ ‡§ñ‡•Å‡§≤‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§§‡•ã ‡§â‡§∏‡•á ‡§ñ‡•ã‡§≤‡•á‡§Ç
        currentTab = 'sales';
        renderContent(); 
    }
    // ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§π‡•à‡§Ç‡§°‡§≤‡§∞ ‡§ï‡•ã SKU ‡§≠‡•á‡§ú‡•á‡§Ç
    handleBarcodeScan(sku); 
}


    function formatCurrency(amount) {
        if (amount === null || amount === undefined) return '‚Çπ0.00';
        return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 2 }).format(amount);
    }
    
    // NEW: Function to format dates as YYYY-MM-DD
    function getISODate(date = new Date()) {
        return date.toISOString().split('T')[0];
    }

    const showMessage = (title, body, type = 'primary') => {
        const toastElement = document.getElementById('appToast');
        const toastTitle = document.getElementById('toast-title');
        const toastBody = document.getElementById('toast-body');
        
        toastTitle.innerText = title;
        toastBody.innerText = body;
        toastElement.querySelector('.toast-header').className = `toast-header bg-${type} text-white`;
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
    };

    async function fetchApi(path, options = {}, loadingMessage = '‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...') {
        showLoader(loadingMessage);
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), SERVER_TIMEOUT);

        // 1. Get token from AppState or localStorage
        const token = AppState.token || localStorage.getItem('authToken');
        
        const headers = {
            'Content-Type': 'application/json',
            ...options.headers,
        };

        // 2. Add Authorization header if token exists [cite: 39]
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        // NEW: Handle file uploads ( FormData )
        let body = options.body;
        if (!(body instanceof FormData)) {
            // Keep default JSON behavior
            body = body ? JSON.stringify(body) : null;
        } else {
            // If body is FormData, remove Content-Type. Fetch API sets it automatically.
            delete headers['Content-Type'];
        }

        try {
            const response = await fetch(__backend_url + path, {
                ...options,
                headers: headers, // Use the new headers
                body: body, // Use the modified body
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);

            const responseData = await response.json().catch(() => ({}));

            if (!response.ok) {
                // 401/403 means token is bad or expired, log the user out
                if (response.status === 401 || response.status === 403) {
                    showMessage('‡§∏‡§§‡•ç‡§∞ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§', '‡§Ü‡§™‡§ï‡§æ ‡§∏‡§§‡•ç‡§∞ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç‡•§', 'danger');
                    logout(); // Log out the user
                }
                throw new Error(responseData.message || `‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§è‡§∞‡§∞: ${response.status}`);
            }
            
            return responseData; // Return the JSON data
            
        } catch (error) {
            if (error.name === 'AbortError') throw new Error('‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§π‡•ã‡§®‡•á ‡§Æ‡•á‡§Ç ‡§¨‡§π‡•Å‡§§ ‡§∏‡§Æ‡§Ø ‡§≤‡§ó‡§æ‡•§');
            throw error;
        } finally {
            hideLoader();
        }
    }


/**
 * ‡§è‡§ï ‡§∏‡§æ‡§ß‡§æ‡§∞‡§£ CSV ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•ã JSON ‡§ë‡§¨‡•ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§ê‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§™‡§æ‡§∞‡•ç‡§∏ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
 */
 function parseCSV(csvText) {
    const lines = csvText.split('\n');
    if (lines.length === 0) return [];
    
    // ‡§π‡•á‡§°‡§∞ (Date, Description, Debit, Credit) ‡§ï‡§æ ‡§™‡§§‡§æ ‡§≤‡§ó‡§æ‡§è‡§Å
    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
    
    // ‡§ï‡•â‡§≤‡§Æ ‡§á‡§Ç‡§°‡•á‡§ï‡•ç‡§∏ ‡§¢‡•Ç‡§Å‡§¢‡•á‡§Ç
    const dateIdx = headers.findIndex(h => h.includes('date'));
    const descIdx = headers.findIndex(h => h.includes('description') || h.includes('narration'));
    const debitIdx = headers.findIndex(h => h.includes('debit') || h.includes('withdrawal'));
    const creditIdx = headers.findIndex(h => h.includes('credit') || h.includes('deposit'));

    if (dateIdx === -1 || descIdx === -1 || debitIdx === -1 || creditIdx === -1) {
        showMessage('CSV ‡§è‡§∞‡§∞', 'CSV ‡§Æ‡•á‡§Ç Date, Description, Debit/Withdrawal, ‡§Ø‡§æ Credit/Deposit ‡§ï‡•â‡§≤‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•á‡•§', 'danger');
        throw new Error('Invalid CSV headers');
    }

    const items = [];
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line) continue;
        
        const values = line.split(',');
        
        const dateStr = values[dateIdx];
        // ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ï‡•ã YYYY-MM-DD ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤‡•á‡§Ç (‡§Æ‡§æ‡§® ‡§≤‡•á‡§Ç ‡§ï‡§ø ‡§Ø‡§π DD/MM/YYYY ‡§Ø‡§æ MM/DD/YYYY ‡§π‡•à)
        let dateObj;
        if (dateStr.includes('/')) {
            const parts = dateStr.split('/');
            // ‡§Æ‡§æ‡§® ‡§≤‡•á‡§Ç ‡§ï‡§ø ‡§Ø‡§π MM/DD/YYYY ‡§π‡•à (‡§á‡§∏‡•á ‡§Ö‡§™‡§®‡•á ‡§¨‡•à‡§Ç‡§ï ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§¨‡§¶‡§≤‡•á‡§Ç)
            // ‡§Ö‡§ó‡§∞ DD/MM/YYYY ‡§π‡•à, ‡§§‡•ã new Date(parts[2], parts[1] - 1, parts[0]) ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç
            dateObj = new Date(parts[2], parts[0] - 1, parts[1]); 
        } else {
            dateObj = new Date(dateStr); // ISO 8601 (YYYY-MM-DD)
        }
        
        const debitAmount = parseFloat(values[debitIdx].replace(/[^0-9.]/g, '')) || 0;
        const creditAmount = parseFloat(values[creditIdx].replace(/[^0-9.]/g, '')) || 0;

        items.push({
            date: dateObj.toISOString().split('T')[0],
            description: values[descIdx],
            debit: debitAmount,
            credit: creditAmount
        });
    }
    return items;
}








    function updateBalanceSheet(data) {
    // ‡§Ö‡§ó‡§∞ ‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Ü‡§§‡§æ ‡§π‡•à, ‡§§‡•ã ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§Ø‡§π‡•Ä‡§Ç ‡§∞‡•Å‡§ï ‡§ú‡§æ‡§è‡§ó‡§æ
    if (!data) return; 

    // --- ‡§¶‡•á‡§®‡§¶‡§æ‡§∞‡§ø‡§Ø‡§æ‡§Ç ‡§î‡§∞ ‡§á‡§ï‡•ç‡§µ‡§ø‡§ü‡•Ä (Liabilities & Equity) ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç ---
    
    // GST ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§®‡•á ‡§Ø‡•ã‡§ó‡•ç‡§Ø (Payable)
    document.getElementById('report-bs-gst-payable').innerText = formatCurrency(data.gstPayable || 0);
    
    // ‡§µ‡•á‡§Ç‡§°‡§∞ ‡§ï‡•ã ‡§¶‡•á‡§Ø (Payable)
    document.getElementById('report-bs-vendors-payable').innerText = formatCurrency(data.vendorsPayable || 0);
    
    // ‡§Æ‡§æ‡§≤‡§ø‡§ï ‡§ï‡•Ä ‡§á‡§ï‡•ç‡§µ‡§ø‡§ü‡•Ä (Owner's Equity) = Net Profit
    document.getElementById('report-bs-owner-equity').innerText = formatCurrency(data.ownerEquity || 0);
    
    // ‡§ï‡•Å‡§≤ ‡§¶‡•á‡§®‡§¶‡§æ‡§∞‡§ø‡§Ø‡§æ‡§Ç ‡§î‡§∞ ‡§á‡§ï‡•ç‡§µ‡§ø‡§ü‡•Ä
    document.getElementById('report-bs-total-liabilities').innerText = formatCurrency(data.totalLiabilitiesAndEquity || 0);

    // --- ‡§™‡§∞‡§ø‡§∏‡§Ç‡§™‡§§‡•ç‡§§‡§ø‡§Ø‡§æ‡§Ç (Assets) ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç ---
    
    // ‡§∏‡•ç‡§ü‡•â‡§ï ‡§ï‡§æ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø (Stock Value)
    document.getElementById('report-bs-stock-value').innerText = formatCurrency(data.stockValue || 0);
    
    // ‡§ï‡•à‡§∂/‡§¨‡•à‡§Ç‡§ï ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ (‡§Ü‡§™‡§ï‡•á ‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§¨‡•à‡§ï‡§è‡§Ç‡§° ‡§Æ‡•á‡§Ç ‡§á‡§∏‡•á ‡§ü‡•ç‡§∞‡•à‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à, ‡§á‡§∏‡§≤‡§ø‡§è 0.00 ‡§∞‡§ñ‡•á‡§Ç)
    document.getElementById('report-bs-cash-balance').innerText = formatCurrency(data.cashBalance || 0);
    
    // ‡§ï‡•Å‡§≤ ‡§™‡§∞‡§ø‡§∏‡§Ç‡§™‡§§‡•ç‡§§‡§ø‡§Ø‡§æ‡§Ç
    document.getElementById('report-bs-total-assets').innerText = formatCurrency(data.totalAssets || 0);
    
    console.log('Balance Sheet data successfully updated in HTML with correct IDs.');
}



// NEW: Function to fetch and populate Company Profile into Invoice Generator
function fetchAndPopulateShopData() {
        console.log("Populating Shop Data for Invoice...");
        try {
            // 1. ‡§∂‡•â‡§™ ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§∏‡•á ‡§°‡•á‡§ü‡§æ ‡§â‡§†‡§æ‡§è‡§Å
            const legalName = document.getElementById('company-legal-name').value;
            const gstin = document.getElementById('company-gstin').value;
            const address = document.getElementById('company-address').value;
            
            // 2. AppState (‡§≤‡•â‡§ó-‡§á‡§® ‡§Ø‡•Ç‡§ú‡§º‡§∞) ‡§∏‡•á ‡§°‡•á‡§ü‡§æ ‡§â‡§†‡§æ‡§è‡§Å
            const displayName = AppState.user?.shopName || '';
            const mobile = AppState.user?.mobile || ''; // (‡§Ø‡§π ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§Ü‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è)

            // 3. ‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§ú‡§®‡§∞‡•á‡§ü‡§∞ ‡§ï‡•á ‡§´‡•â‡§∞‡•ç‡§Æ ‡§Æ‡•á‡§Ç ‡§Ø‡§π ‡§°‡•á‡§ü‡§æ ‡§≠‡§∞‡•á‡§Ç
            document.getElementById('shopName').value = legalName || displayName; //
            document.getElementById('shopContact').value = mobile; //
            document.getElementById('shopAddress').value = address; //
            document.getElementById('shopGstin').value = gstin; //
            
            // 4. ‡§™‡•ç‡§∞‡•Ä‡§µ‡•ç‡§Ø‡•Ç ‡§ï‡•ã ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
            updateInvoicePreview();

        } catch (e) {
            console.warn("Could not pre-populate shop data:", e.message);
        }
    }// ‡§Ø‡§π ‡§≠‡•Ä ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø 'renderReports' ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ API ‡§ï‡•â‡§≤ ‡§ï‡•á ‡§¨‡§æ‡§¶ 
// ‡§Ø‡§π ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•â‡§≤ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à, ‡§ú‡•à‡§∏‡§æ ‡§ï‡§ø ‡§®‡•Ä‡§ö‡•á ‡§π‡•à:


    // --- RENDER FUNCTIONS FOR EACH SECTION ---
    const renderView = (viewId) => {
        AppState.currentView = viewId;
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        
        // ‡§Ø‡§π ‡§≤‡§æ‡§á‡§® ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡§§‡•Ä ‡§π‡•à ‡§ï‡§ø ‡§∏‡•á‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã active ‡§ï‡•ç‡§≤‡§æ‡§∏ ‡§Æ‡§ø‡§≤‡•á
        const sectionElement = document.getElementById(viewId);
        if (sectionElement) {
             sectionElement.classList.add('active');
             console.log(`‚úÖ Activated section: #${viewId}`); // ‡§ï‡§®‡•ç‡§´‡§∞‡•ç‡§Æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§≤‡•â‡§ó
        } else {
             console.error(`‚ùå Section not found for ID: ${viewId}`); // ‡§Ö‡§ó‡§∞ ID ‡§ó‡§≤‡§§ ‡§π‡•à
        }

        document.querySelectorAll('#sidebar-nav .nav-link').forEach(l => {
            l.classList.remove('active');
            if (l.getAttribute('data-view') === viewId) l.classList.add('active');
        });
        
        // --- üöÄ ‡§Ö‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§ï‡§Æ‡•á‡§Ç‡§ü ‡§Ü‡§â‡§ü ---
        switch (viewId) {
            case 'dashboard': renderDashboard(); break;
            case 'stock': fetchAndRenderStockList(); break;
            case 'crm': fetchAndRenderCustomers(); break;
            case 'purchases': fetchAndRenderPurchases(); break;
            case 'expenses': fetchAndRenderExpenses(); break;
            case 'reports': renderReports(); break;
            case 'sales': 
                fetchAndRenderSales(); 
                fetchApi('/api/stock', { method: 'GET' }).then(res => {
                    if (res.success) currentStock = res.stock;
                });
                focusBarcodeScanner(); 
                break;
                case 'invoice-generator':
            fetchAndPopulateShopData();
            initializeQRUpload();
            break;
             // Note: Duplicate 'sales' case removed below
            
            case 'gst-reports': 
                // Ensure getISODate function exists or handle potential error
                try {
                    document.getElementById('gst-report-start-date').value = getISODate(new Date(new Date().setDate(1))); 
                    document.getElementById('gst-report-end-date').value = getISODate(); 
                } catch (e) { console.error("Error setting GST dates:", e); }
                break;
            case 'bank-reconciliation':
            // ‡§ú‡§¨ ‡§π‡§Æ ‡§ü‡•à‡§¨ ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç ‡§§‡•ã ‡§á‡§Ç‡§ü‡§∞‡§´‡§º‡•á‡§∏ ‡§ï‡•ã ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
                document.getElementById('reconciliation-setup').classList.remove('hidden');
                document.getElementById('reconciliation-matching-area').classList.add('hidden');
                document.getElementById('reconciliation-start-form').reset();
                fetchAndRenderSavedReports();
                break;    
            case 'daily-closing': fetchAndRenderClosingReports(); break; 
            case 'data-backup': break; 
            case 'shop-settings': fetchAndRenderShopSettings(); break; 
            case 'staff': renderStaff(); break; 
        }
        
        // --- üöÄ ‡§ï‡§Æ‡•á‡§Ç‡§ü ‡§ñ‡§§‡•ç‡§Æ ---
    };

    async function fetchAndRenderSales() {
        const salesTableBody = document.getElementById('sales-table-body');  
        salesTableBody.innerHTML = ''; // Clear previous entries
        try {
            const salesRes = await fetchApi('/api/invoices', { method: 'GET' }, '‡§π‡§æ‡§≤ ‡§ï‡•Ä ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...');
            if (salesRes.success && salesRes.sales && salesRes.sales.length > 0) {
                salesRes.sales.forEach(sale => {
                    
                    // --- ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§≤‡•â‡§ú‡§ø‡§ï (‡§ï‡§Æ‡•á‡§Ç‡§ü‡•á‡§°) ---
                    /*
                    salesTableBody.innerHTML += `
                        <tr>
                            <td>INV-${sale.id}</td> <td>${sale.customer_name}</td>
                            <td>${formatCurrency(sale.total_gst)}</td> 
                            <td>${formatCurrency(sale.total_amount)}</td>
                            <td>${new Date(sale.created_at).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-sm btn-info py-0 px-1" onclick="showInvoiceDetail(${sale.id})" title="‡§µ‡§ø‡§µ‡§∞‡§£ ‡§¶‡•á‡§ñ‡•á‡§Ç">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-secondary py-0 px-1 ms-1" onclick="printPOSInvoice(${sale.id})" title="‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡•á‡§Ç">
                                    <i class="fas fa-print"></i>
                                </button>
                               </td>
                        </tr>
                    `;
                    */
                    // --- ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§≤‡•â‡§ú‡§ø‡§ï ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ---

                    // --- üöÄ ‡§®‡§Ø‡§æ ‡§î‡§∞ ‡§∏‡§π‡•Ä ‡§ï‡•ã‡§° (6 ‡§ï‡•â‡§≤‡§Æ ‡§ï‡•á ‡§≤‡§ø‡§è) ---
                    salesTableBody.innerHTML += `
                        <tr>
                            <td>INV-${sale.id}</td>
                            <td>${sale.customer_name}</td>
                            <td>${formatCurrency(sale.total_gst)}</td>
                            <td>${formatCurrency(sale.total_amount)}</td>
                            <td>${new Date(sale.created_at).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-sm btn-info py-0 px-1" onclick="showInvoiceDetail(${sale.id})" title="‡§µ‡§ø‡§µ‡§∞‡§£ ‡§¶‡•á‡§ñ‡•á‡§Ç">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-secondary py-0 px-1 ms-1" onclick="printPOSInvoice(${sale.id})" title="‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡•á‡§Ç">
                                    <i class="fas fa-print"></i>
                                </button>
                               </td>
                        </tr>
                    `;
                    // --- ‡§®‡§Ø‡§æ ‡§ï‡•ã‡§° ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ---

                });
            } else {
                 salesTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">‡§ï‡•ã‡§à ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç‡•§</td></tr>`; // üëà colspan ‡§ï‡•ã 5 ‡§∏‡•á 6 ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ
            }
        } catch (error) {
            showMessage('‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§æ: ${error.message}`, 'danger');
            salesTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}</td></tr>`; // üëà colspan ‡§ï‡•ã 5 ‡§∏‡•á 6 ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ
        }
    }
        
    // NEW: Show Invoice Detail Modal (Placeholder, needs a modal)
    async function showInvoiceDetail(invoiceId) {
        try {
            const res = await fetchApi(`/api/invoices/${invoiceId}`, { method: 'GET' });
            if (res.success) {
                // TODO: Create a modal to show this data
                console.log(res.invoice);
                alert(`‡§ö‡§æ‡§≤‡§æ‡§® #${res.invoice.id}\n‡§ó‡•ç‡§∞‡§æ‡§π‡§ï: ${res.invoice.customer_name}\n‡§ï‡•Å‡§≤: ${formatCurrency(res.invoice.total_amount)}\n‡§Ü‡§á‡§ü‡§Æ:\n` + 
                    res.invoice.items.map(item => `${item.item_name} (Qty: ${item.quantity})`).join('\n')
                );
            } else {
                showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', res.message, 'danger');
            }
        } catch (e) {
            showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', e.message, 'danger');
        }
    }

/**
    
  /**
     * (‡§®‡§Ø‡§æ ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® - ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡•ç‡§≤‡•Ä‡§®‡§Ö‡§™ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§´‡§ø‡§ï‡•ç‡§∏‡•ç‡§°)
     * POS ‡§∏‡•á ‡§∏‡•á‡§µ ‡§ï‡§ø‡§Ø‡•á ‡§ó‡§è ‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§ï‡•ã ‡§´‡§º‡•á‡§ö ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§î‡§∞ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§
     */
     async function printPOSInvoice(invoiceId) {
        showLoader('‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...');
        
        // üöÄ ‡§π‡§Æ ‡§á‡§∏ 'printArea' ‡§ï‡•ã ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§π‡§ü‡§æ‡§è‡§Ç‡§ó‡•á
        let printArea = document.getElementById('report-print-area');

        try {
            // 1. ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§ï‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§°‡•á‡§ü‡§æ ‡§≤‡§æ‡§è‡§Å
            const res = await fetchApi(`/api/invoices/${invoiceId}`, { method: 'GET' }, null);
            if (!res.success || !res.invoice) {
                throw new Error(res.message || '‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§');
            }
            
            const invoice = res.invoice;
            
            // 2. ‡§∂‡•â‡§™ ‡§ï‡•Ä ‡§°‡§ø‡§ü‡•á‡§≤‡•ç‡§∏ AppState ‡§∏‡•á ‡§≤‡•á‡§Ç
            const profileRes = await fetchApi('/api/shop/company-profile', { method: 'GET' }, null);
            const shopProfile = profileRes.success ? profileRes.profile : {};
            const shopDisplayName = AppState.user?.shopName || 'Shop Name';

            // 3. ‡§á‡§®‡§µ‡•â‡§á‡§∏ HTML ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç
            let itemRows = '';
            let totalTax = 0;
            let subTotal = 0;

            invoice.items.forEach((item, index) => {
                const itemSubTotal = (item.sale_price || 0) * (item.quantity || 0);
                const itemGst = itemSubTotal * ((item.gst_rate || 0) / 100); 
                
                subTotal += itemSubTotal;
                totalTax += itemGst;
                
                itemRows += `
                    <tr>
                        <td>${index + 1}</td>
                        <td style="text-align: left;">${item.item_name}</td>
                        <td>${item.quantity}</td>
                        <td>${formatCurrency(item.sale_price)}</td>
                        <td>${item.gst_rate || 0}%</td> 
                        <td>${formatCurrency(itemSubTotal)}</td>
                        <td class="no-print"></td>
                    </tr>
                `;
            });

            const cgst = totalTax / 2;
            const sgst = totalTax / 2;

            // 4. ‡§è‡§ï ‡§Ö‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§Ø‡•ã‡§ó‡•ç‡§Ø (printable) div ‡§¨‡§®‡§æ‡§è‡§Å
            if (!printArea) {
                printArea = document.createElement('div');
                printArea.id = 'report-print-area';
                printArea.className = 'printable'; // [cite: 1-267]
                document.body.appendChild(printArea);
            }

            // 5. ‡§á‡§®‡§µ‡•â‡§á‡§∏ HTML ‡§ï‡•ã ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§è‡§∞‡§ø‡§Ø‡§æ ‡§Æ‡•á‡§Ç ‡§á‡§Ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç
            printArea.innerHTML = `
                <div id="invoice-preview-printable" class="printable"> 
                    <div class="invoice-header">
                        <div class="shop-details">
                            <h3>${shopProfile.legal_name || shopDisplayName}</h3>
                            <p class="mb-0">${shopProfile.address || 'Shop Address'}</p>
                            <p class="mb-0">Ph: ${shopProfile.contact || 'Contact No.'}</p>
                            ${shopProfile.gstin ? `<p class="mb-0"><strong>GSTIN: ${shopProfile.gstin}</strong></p>` : ''}
                        </div>
                        <h2 style="color: #333; align-self: center;">INVOICE</h2>
                    </div>
                    
                    <div class="customer-details row">
                        <div class="col-8">
                            <strong>Bill To:</strong>
                            <p class="mb-0">${invoice.customer_name || 'N/A'}</p>
                            <p class="mb-0">Ph: ${invoice.customer_mobile || 'N/A'}</p>
                        </div>
                        <div class="col-4 text-end">
                            <p class="mb-0"><strong>Invoice No:</strong> INV-${invoice.id}</p>
                            <p class="mb-0"><strong>Date:</strong> ${new Date(invoice.created_at).toLocaleDateString()}</p>
                        </div>
                    </div>

                    <table class="invoice-table">
                        <thead>
                            <tr>
                                <th style="width: 5%;">#</th>
                                <th style="text-align: left;">Item</th>
                                <th style="width: 10%;">Qty</th>
                                <th style="width: 15%;">Rate</th>
                                <th style="width: 10%;">GST%</th>
                                <th style="width: 15%;">Amount</th>
                                <th style="width: 5%;" class="no-print"></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemRows}
                        </tbody>
                    </table>
                    
                    <div class="invoice-footer">
                        <div>
                            </div>
                        <table class="totals-table">
                            <tbody>
                                <tr><td>Subtotal:</td><td style="text-align: right;">${formatCurrency(subTotal)}</td></tr>
                                <tr><td>CGST:</td><td style="text-align: right;">${formatCurrency(cgst)}</td></tr>
                                <tr><td>SGST:</td><td style="text-align: right;">${formatCurrency(sgst)}</td></tr>
                                <tr style="font-weight: bold; font-size: 1.2em; border-top: 2px solid #333;">
                                    <td>Grand Total:</td>
                                    <td style="text-align: right;">${formatCurrency(invoice.total_amount)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // üöÄüöÄüöÄ ‡§Ø‡§π ‡§∞‡§π‡§æ ‡§´‡§ø‡§ï‡•ç‡§∏ üöÄüöÄüöÄ
            // 6. ‡§è‡§ï ‡§ï‡•ç‡§≤‡•Ä‡§®‡§Ö‡§™ ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§¨‡§®‡§æ‡§è‡§Å
            function cleanupPrint() {
                if (printArea) {
                    printArea.remove(); // ‡§Ö‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä div ‡§ï‡•ã ‡§π‡§ü‡§æ ‡§¶‡•á‡§Ç
                }
                window.onafterprint = null; // ‡§á‡§µ‡•á‡§Ç‡§ü ‡§≤‡§ø‡§∏‡•ç‡§®‡§∞ ‡§ï‡•ã ‡§π‡§ü‡§æ ‡§¶‡•á‡§Ç
            }
            
            // 7. 'afterprint' (‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶) ‡§á‡§µ‡•á‡§Ç‡§ü ‡§™‡§∞ ‡§ï‡•ç‡§≤‡•Ä‡§®‡§Ö‡§™ ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
            window.onafterprint = cleanupPrint;
            
            // 8. ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡•á‡§Ç
            window.print();
            // üöÄüöÄüöÄ ‡§´‡§ø‡§ï‡•ç‡§∏ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ üöÄüöÄüöÄ

        } catch (e) {
            showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${e.message}`, 'danger');
            // üöÄ ‡§Ö‡§ó‡§∞ ‡§è‡§∞‡§∞ ‡§Ü‡§è ‡§§‡•ã ‡§≠‡•Ä ‡§ï‡•ç‡§≤‡•Ä‡§®‡§Ö‡§™ ‡§ï‡§∞‡•á‡§Ç
            if (printArea) {
                printArea.remove();
            }
        } finally {
            hideLoader();
        }
    }
    
    async function renderDashboard() {
        // --- 1. Get Summary Cards Data ---
        try {
            // Use the new multi-tenant endpoint [cite: 214]
            const data = await fetchApi('/api/dashboard/summary', { method: 'GET' }, '‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Ü‡§Å‡§ï‡§°‡§º‡•á ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...');
            if (data.success) {
                // Use the correct response keys from server.cjs [cite: 225]
                document.getElementById('total-sales-revenue').innerText = formatCurrency(data.summary.totalSales);
                document.getElementById('total-stock-value').innerText = formatCurrency(data.summary.currentStockValue);
                // totalCustomers is not in this summary, we need to fetch it separately or remove it
                // Let's modify the server endpoint logic slightly in our head...
                // ...or just fetch the data from the other endpoints
            } else {
                showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', data.message, 'danger');
            }
        } catch (error) {
            showMessage('‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§Ü‡§Å‡§ï‡§°‡§º‡•á ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡•á: ${error.message}`, 'danger');
        }

        // --- 2. Load other tables (Your existing logic is fine, but needs new endpoints) ---
        try {
            // [cite: 187] [cite_start]for customers, [cite: 168] for sales
            const [lowStockRes, salesRes, customersRes] = await Promise.all([
                fetchApi('/api/stock', { method: 'GET' }, '‡§ï‡§Æ ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Ü‡§á‡§ü‡§Æ‡•ç‡§∏ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...'), // Assuming low stock is just stock
                fetchApi('/api/invoices', { method: 'GET' }, '‡§π‡§æ‡§≤ ‡§ï‡•Ä ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...'), 
                fetchApi('/api/customers', { method: 'GET' }, '‡§π‡§æ‡§≤ ‡§ï‡•á ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...')
            ]);
            
            // Low Stock Table (Filter from full stock list)
            const lowStockBody = document.getElementById('low-stock-table-body');
            lowStockBody.innerHTML = '';
            const lowStockItems = lowStockRes.success ? lowStockRes.stock.filter(item => item.quantity < 10) : []; // 10 ‡§ï‡•ã ‡§•‡•ç‡§∞‡•á‡§∂‡•ã‡§≤‡•ç‡§° ‡§Æ‡§æ‡§®‡•á‡§Ç
            
            document.getElementById('low-stock-count').innerText = lowStockItems.length; // Update low stock count
            
            if (lowStockItems.length > 0) {
                lowStockItems.forEach(item => {
                    lowStockBody.innerHTML += `<tr><td>${item.sku}</td><td>${item.name}</td><td>${item.quantity}</td></tr>`;
                });
            } else {
                lowStockBody.innerHTML = `<tr><td colspan="3" class="text-center text-muted">‡§ï‡•ã‡§à ‡§ï‡§Æ ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Ü‡§á‡§ü‡§Æ ‡§®‡§π‡•Ä‡§Ç</td></tr>`;
            }

            // Recent Sales Table
            const recentSalesBody = document.getElementById('recent-sales-table-body');
            recentSalesBody.innerHTML = '';
            if (salesRes.success && salesRes.sales.length > 0) {
                // Update total customers count
                document.getElementById('total-sales-revenue').innerText = formatCurrency(salesRes.sales.reduce((acc, s) => acc + parseFloat(s.total_amount), 0));
                
                salesRes.sales.slice(0, 10).forEach(sale => { // Show 10 recent
                    recentSalesBody.innerHTML += `<tr><td>INV-${sale.id}</td><td>${sale.customer_name}</td><td>${formatCurrency(sale.total_amount)}</td><td>${new Date(sale.created_at).toLocaleDateString()}</td></tr>`;
                });
            } else {
                recentSalesBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">‡§ï‡•ã‡§à ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç</td></tr>`;
            }

            // Recent Customers Table
            const recentCustomersBody = document.getElementById('recent-customers-table-body');
            recentCustomersBody.innerHTML = '';
            if (customersRes.success && customersRes.customers.length > 0) {
                // Update total customers count
                document.getElementById('total-customers').innerText = customersRes.customers.length;
                
                customersRes.customers.slice(0, 10).forEach(cust => { // Show 10 recent
                    recentCustomersBody.innerHTML += `<tr><td>${cust.name}</td><td>${cust.phone || 'N/A'}</td><td>${new Date(cust.created_at).toLocaleDateString()}</td></tr>`;
                });
            } else {
                recentCustomersBody.innerHTML = `<tr><td colspan="3" class="text-center text-muted">‡§ï‡•ã‡§à ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§®‡§π‡•Ä‡§Ç</td></tr>`;
            }
            
            // Update stock value from stock endpoint
             document.getElementById('total-stock-value').innerText = formatCurrency(lowStockRes.success ? lowStockRes.stock.reduce((acc, item) => acc + (item.purchase_price * item.quantity), 0) : 0);
            
            // --- NEW: Load Sales Chart ---
            renderSalesChart();

            console.log("‚úÖ Dashboard fully updated.");

        } catch (error) {
            showMessage('‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§§‡§æ‡§≤‡§ø‡§ï‡§æ‡§è‡§Å ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡•Ä‡§Ç: ${error.message}`, 'danger');
        }
    } 
    
  // NEW: Render Sales Chart (Uses server endpoint [cite: 271-282])
    let salesChartInstance = null; // To hold the chart object
    async function renderSalesChart(days = 30) {
        try {
            const res = await fetchApi(`/api/dashboard/sales-by-day?days=${days}`, { method: 'GET' });
            if (res.success) {
                const ctx = document.getElementById('salesChart').getContext('2d');
                const labels = res.data.map(d => d.date);
                const salesData = res.data.map(d => d.sales);
                const profitData = res.data.map(d => d.profit);

                if (salesChartInstance) {
                    salesChartInstance.destroy(); // Destroy old chart before creating new one
                }
                
                salesChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä (Sales)',
                                data: salesData,
                                borderColor: '#0d6efd',
                                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: '‡§≤‡§æ‡§≠ (Profit)',
                                data: profitData,
                                borderColor: '#198754',
                                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                                fill: true,
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) { return '‚Çπ' + value; }
                                }
                            }
                        }
                    }
                });
            }
        } catch (e) {
            console.error("Sales chart error:", e.message);
        }
    }

    // ==========================================================
// ========== UPDATED: renderReports (Bank-Style Detail) ==========
// ==========================================================
async function renderReports() {
    // 1. Get date range (assuming server defaults if not provided, but server code requires it)
    const endDate = getISODate();
    const startDate = getISODate(new Date(new Date().setDate(new Date().getDate() - 90))); // 90-day default

    try {
        // 2. Fetch P&L Report first
        const plRes = await fetchApi(`/api/reports/profit-loss?startDate=${startDate}&endDate=${endDate}`, { method: 'GET' }, 'P&L ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...');
        
        if (!plRes.success) {
            throw new Error(plRes.message || 'P&L ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§');
        }
        
        const pl = plRes.report;
        const netProfit = pl.netProfit; // Save this for the Balance Sheet

        // 3. Populate P&L Table (Debit Side)
        // [‡§Ø‡§π 'pl-card' ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§™‡§π‡§≤‡•á <tbody> ‡§ï‡•ã ‡§ö‡•Å‡§®‡§§‡§æ ‡§π‡•à]
        const plDebitBody = document.getElementById('pl-card').querySelectorAll('tbody')[0];
        plDebitBody.innerHTML = ''; // Clear existing static rows
        pl.debit.forEach(item => {
            plDebitBody.innerHTML += `<tr>
                                        <td>${item.description}</td>
                                        <td class="text-end">${formatCurrency(item.amount)}</td>
                                      </tr>`;
        });
        // Total Debit
        document.getElementById('report-pl-total-debit').innerText = formatCurrency(pl.totalDebit);

        // 4. Populate P&L Table (Credit Side)
        // [‡§Ø‡§π 'pl-card' ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§¶‡•Ç‡§∏‡§∞‡•á <tbody> ‡§ï‡•ã ‡§ö‡•Å‡§®‡§§‡§æ ‡§π‡•à]
        const plCreditBody = document.getElementById('pl-card').querySelectorAll('tbody')[1];
        plCreditBody.innerHTML = ''; // Clear existing static rows
        pl.credit.forEach(item => {
            plCreditBody.innerHTML += `<tr>
                                        <td>${item.description}</td>
                                        <td class="text-end">${formatCurrency(item.amount)}</td>
                                      </tr>`;
        });
        // Total Credit
        document.getElementById('report-pl-total-credit').innerText = formatCurrency(pl.totalCredit);

        // 5. Fetch Balance Sheet Report (passing the calculated netProfit)
        // [‡§Ø‡§π P&L ‡§∏‡•á ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§∂‡•Å‡§¶‡•ç‡§ß ‡§≤‡§æ‡§≠ ‡§ï‡•ã ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§∂‡•Ä‡§ü API ‡§ï‡•ã ‡§≠‡•á‡§ú‡§§‡§æ ‡§π‡•à]
        const bsRes = await fetchApi(`/api/reports/balance-sheet?netProfit=${netProfit}`, { method: 'GET' }, '‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§∂‡•Ä‡§ü ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...');

        if (!bsRes.success) {
            throw new Error(bsRes.message || '‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§∂‡•Ä‡§ü ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§');
        }
        
        const bs = bsRes.report;

        // 6. Populate Balance Sheet (Liabilities & Equity Side)
        // [‡§Ø‡§π 'bs-card' ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§™‡§π‡§≤‡•á <tbody> ‡§ï‡•ã ‡§ö‡•Å‡§®‡§§‡§æ ‡§π‡•à]
        const bsLiabilitiesBody = document.getElementById('bs-card').querySelectorAll('tbody')[0];
        bsLiabilitiesBody.innerHTML = ''; // Clear existing static rows
        
        // Liabilities (‡§¶‡•á‡§®‡§¶‡§æ‡§∞‡§ø‡§Ø‡§æ‡§Ç)
        bs.liabilities.forEach(item => {
            bsLiabilitiesBody.innerHTML += `<tr>
                                                <td>${item.description}</td>
                                                <td class="text-end">${formatCurrency(item.amount)}</td>
                                            </tr>`;
        });
        // Equity (‡§á‡§ï‡•ç‡§µ‡§ø‡§ü‡•Ä)
        bs.equity.forEach(item => {
            bsLiabilitiesBody.innerHTML += `<tr>
                                                <td>${item.description}</td>
                                                <td class="text-end">${formatCurrency(item.amount)}</td>
                                            </tr>`;
        });
        // Total Liabilities & Equity
        document.getElementById('report-bs-total-liabilities').innerText = formatCurrency(bs.totalLiabilitiesAndEquity);

        // 7. Populate Balance Sheet (Assets Side)
        // [‡§Ø‡§π 'bs-card' ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§¶‡•Ç‡§∏‡§∞‡•á <tbody> ‡§ï‡•ã ‡§ö‡•Å‡§®‡§§‡§æ ‡§π‡•à]
        const bsAssetsBody = document.getElementById('bs-card').querySelectorAll('tbody')[1];
        bsAssetsBody.innerHTML = ''; // Clear existing static rows
        
        // Assets (‡§™‡§∞‡§ø‡§∏‡§Ç‡§™‡§§‡•ç‡§§‡§ø‡§Ø‡§æ‡§Ç)
        bs.assets.forEach(item => {
            let note = item.note ? `<small class="text-muted d-block">${item.note}</small>` : '';
            bsAssetsBody.innerHTML += `<tr>
                                        <td>${item.description} ${note}</td>
                                        <td class="text-end">${formatCurrency(item.amount)}</td>
                                      </tr>`;
        });
        // Total Assets
        document.getElementById('report-bs-total-assets').innerText = formatCurrency(bs.totalAssets);
        
        console.log("‚úÖ Reports updated successfully with details.");

    } catch (error) {
        console.error("renderReports ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error);
        showMessage('‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏ ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡•Ä: ${error.message}`, 'danger');
        
        // Clear tables on error to avoid showing old data
        document.getElementById('pl-card').querySelectorAll('tbody')[0].innerHTML = '<tr><td colspan="2" class="text-danger text-center">P&L ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§</td></tr>';
        document.getElementById('pl-card').querySelectorAll('tbody')[1].innerHTML = '<tr><td colspan="2" class="text-danger text-center"></td></tr>';
        document.getElementById('bs-card').querySelectorAll('tbody')[0].innerHTML = '<tr><td colspan="2" class="text-danger text-center">BS ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§</td></tr>';
        document.getElementById('bs-card').querySelectorAll('tbody')[1].innerHTML = '<tr><td colspan="2" class="text-danger text-center"></td></tr>';
    }
}
// ==========================================================
// ========== END OF UPDATED FUNCTION ==========
// ==========================================================


async function fetchAndRenderStockList() {
        const tableBody = document.getElementById('stock-table-body');
        const tableFoot = document.getElementById('stock-table-foot');
        tableBody.innerHTML = `<tr><td colspan="8" class="text-center">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</td></tr>`;
        tableFoot.innerHTML = '';
        try {
            const res = await fetchApi('/api/stock', { method: 'GET' });
            tableBody.innerHTML = '';
            let totalPurchaseValue = 0;
            let totalSaleValue = 0;
            if (res.success && res.stock.length > 0) {
                res.stock.forEach(item => {
                    totalPurchaseValue += (item.purchase_price || 0) * (item.quantity || 0);
                    totalSaleValue += (item.sale_price || 0) * (item.quantity || 0);
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${item.sku}</td>
                        <td>${item.name}</td>
                        <td>${item.quantity} ${item.unit || ''}</td>
                        <td>${formatCurrency(item.purchase_price)}</td>
                        <td>${formatCurrency(item.sale_price)}</td>
                        <td>${item.gst || 0}%</td>
                        <td>${new Date(item.updated_at).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" data-role="ADMIN" onclick="deleteEntry('stock', '${item.sku}')">‡§π‡§ü‡§æ‡§è‡§Ç</button>
                        </td>
                    `;
                });
                tableFoot.innerHTML = `
                    <tr class="fw-bold bg-light">
                        <td colspan="3">‡§ï‡•Å‡§≤</td>
                        <td>${formatCurrency(totalPurchaseValue)}</td>
                        <td>${formatCurrency(totalSaleValue)}</td>
                        <td colspan="3"></td>
                    </tr>
                `;
            } else {
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">‡§ï‡•ã‡§à ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Ü‡§á‡§ü‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</td></tr>`;
            }
        } catch (e) {
            tableBody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}</td></tr>`;
        }
    }

    async function fetchAndRenderCustomers() {
        const tableBody = document.getElementById('crm-table-body');
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</td></tr>`;
        try {
            const res = await fetchApi('/api/customers', { method: 'GET' });
            tableBody.innerHTML = '';
            if (res.success && res.customers.length > 0) {
                res.customers.forEach(c => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${c.id}</td>
                        <td>${c.name}</td>
                        <td>${c.phone || 'N/A'}</td>
                        <td>${c.address || 'N/A'}</td>
                        <td>${new Date(c.created_at).toLocaleDateString()}</td>
                        <td>
                           </td>
                    `;
                });
            } else {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">‡§ï‡•ã‡§à ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§</td></tr>`;
            }
        } catch (e) {
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}</td></tr>`;
        }
    }
	
	
    // --- (... ‡§™‡§ø‡§õ‡§≤‡§æ ‡§ú‡§æ‡§µ‡§æ‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§ï‡•ã‡§° ‡§™‡§æ‡§∞‡•ç‡§ü 2 ‡§∏‡•á ‡§ú‡§æ‡§∞‡•Ä ...) ---

    async function fetchAndRenderPurchases() {
        const tableBody = document.getElementById('purchases-table-body');
        const tableFoot = document.getElementById('purchases-table-foot');
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</td></tr>`;
        tableFoot.innerHTML = '';
        try {
            const res = await fetchApi('/api/purchases', { method: 'GET' });
            tableBody.innerHTML = '';
            let totalCost = 0;
            if (res.success && res.purchases.length > 0) {
                res.purchases.forEach(p => {
                    totalCost += parseFloat(p.total_cost || 0);
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${p.id}</td>
                        <td>${p.supplier_name || 'N/A'}</td>
                        <td>${p.item_details}</td>
                        <td>${formatCurrency(p.total_cost)}</td>
                        <td>${new Date(p.created_at).toLocaleDateString()}</td>
                        <td><button class="btn btn-sm btn-danger" data-role="ADMIN" onclick="deleteEntry('purchase', ${p.id})">‡§π‡§ü‡§æ‡§è‡§Ç</button></td>
                    `;
                });
                tableFoot.innerHTML = `<tr class="fw-bold bg-light"><td colspan="3">‡§ï‡•Å‡§≤ ‡§ñ‡§∞‡•Ä‡§¶ ‡§∞‡§æ‡§∂‡§ø</td><td>${formatCurrency(totalCost)}</td><td colspan="2"></td></tr>`;
            } else {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">‡§ï‡•ã‡§à ‡§ñ‡§∞‡•Ä‡§¶ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§</td></tr>`;
            }
        } catch (e) {
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}</td></tr>`;
        }
    }

    async function fetchAndRenderExpenses() {
        const tableBody = document.getElementById('expenses-table-body');
        const tableFoot = document.getElementById('expenses-table-foot');
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</td></tr>`;
        tableFoot.innerHTML = '';
        try {
            const res = await fetchApi('/api/expenses', { method: 'GET' });
            tableBody.innerHTML = '';
            let totalExpenses = 0;
            if (res.success && res.expenses.length > 0) {
                res.expenses.forEach(ex => {
                    totalExpenses += parseFloat(ex.amount || 0);
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${new Date(ex.created_at).toLocaleDateString()}</td>
                        <td>${ex.category}</td>
                        <td>${ex.description}</td>
                        <td>${formatCurrency(ex.amount)}</td>
                        <td><button class="btn btn-sm btn-danger" data-role="ADMIN" onclick="deleteEntry('expense', ${ex.id})">‡§π‡§ü‡§æ‡§è‡§Ç</button></td>
                    `;
                });
                tableFoot.innerHTML = `<tr class="fw-bold bg-light"><td colspan="3">‡§ï‡•Å‡§≤ ‡§ñ‡§∞‡•ç‡§ö ‡§∞‡§æ‡§∂‡§ø</td><td>${formatCurrency(totalExpenses)}</td><td></td></tr>`;
            } else {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">‡§ï‡•ã‡§à ‡§ñ‡§∞‡•ç‡§ö ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§</td></tr>`;
            }
        } catch (e) {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}</td></tr>`;
        }
    }    
    // --- POS (SALES) SECTION LOGIC ---

    // NEW: Modified to show all items on click (showAll = true)
    function handleItemSearch(showAll = false) {
        const query = document.getElementById('pos-item-search').value.toLowerCase();
        const resultsUl = document.getElementById('pos-search-results');
        
        if (!showAll && query.length < 2) {
            resultsUl.innerHTML = '';
            return;
        }

        const results = (showAll && query.length === 0)
            ? currentStock // Show all
            : currentStock.filter(item => 
                item.name.toLowerCase().includes(query) || (item.sku && item.sku.toLowerCase().includes(query))
            );

        if (results.length > 0) {
            resultsUl.innerHTML = results.map(item => 
                `<li class="list-group-item list-group-item-action" data-sku="${item.sku}">
                    ${item.name} (${formatCurrency(item.sale_price)}) <span class="badge bg-primary float-end">${item.sku}</span>
                </li>`
            ).join('');
        } else {
            resultsUl.innerHTML = '<li class="list-group-item text-muted">‡§ï‡•ã‡§à ‡§Ü‡§á‡§ü‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ</li>';
        }
    }

    function handleSearchResultClick(e) {
        if (e.target.tagName === 'LI' && e.target.dataset.sku) {
            const sku = e.target.dataset.sku;
            addSKUToCart(sku); // NEW: Use centralized function
        }
    }
    
    // NEW: Centralized function to add SKU to cart (used by barcode and search)
    function addSKUToCart(sku) {
        const selectedItem = currentStock.find(item => item.sku === sku);
            
        if (selectedItem) {
            // Check stock quantity
            if(selectedItem.quantity <= 0) {
                return showMessage('‡§∏‡•ç‡§ü‡•â‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à', `${selectedItem.name} ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§`, 'danger');
            }
            
            const existingCartItem = posCart.find(item => item.sku === sku);
            if (existingCartItem) {
                // Check stock against cart
                if(existingCartItem.quantity >= selectedItem.quantity) {
                    return showMessage('‡§∏‡•ç‡§ü‡•â‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à', `‡§Ü‡§™‡§ï‡•á ‡§™‡§æ‡§∏ ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•á‡§Ç ‡§ï‡•á‡§µ‡§≤ ${selectedItem.quantity} ${selectedItem.name} ‡§π‡•à‡§Ç‡•§`, 'warning');
                }
                existingCartItem.quantity++;
            } else {
                posCart.push({ 
                    ...selectedItem, 
                    quantity: 1,
                    purchase_price: parseFloat(selectedItem.purchase_price || 0)
                });
            }
            updatePOSCartView();
        } else {
             showMessage('‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ', `SKU ${sku} ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§`, 'warning');
        }
        
        document.getElementById('pos-item-search').value = '';
        document.getElementById('pos-search-results').innerHTML = '';
        document.getElementById('pos-item-search').focus();
    }

    function updatePOSCartView() {
        const cartBody = document.getElementById('pos-cart-body');
        if(!cartBody) return; // Prevent errors if view is not active

        if (posCart.length === 0) {
            cartBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">‡§ï‡§æ‡§∞‡•ç‡§ü ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•à‡•§</td></tr>`;
        } else {
            cartBody.innerHTML = posCart.map((item, index) => {
                const saleTotal = item.sale_price * item.quantity;
                const stockItem = currentStock.find(s => s.sku === item.sku);
                const maxStock = stockItem ? stockItem.quantity : item.quantity; // Get current stock level
                
                return `
                    <tr>
                        <td>${item.name}</td>
                        <td>
                            <input 
                                type="number" 
                                class="form-control form-control-sm" 
                                style="width: 100px;"
                                value="${item.quantity}" 
                                min="1" 
                                max="${maxStock}"
                                onchange="updateCartQuantity(${index}, this.value)"
                                onblur="validateCartQuantity(${index}, this.value, ${maxStock})"
                            >
                        </td>
                        <td>${formatCurrency(item.sale_price)}</td>
                        <td>${formatCurrency(saleTotal)}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="removeFromCart(${index})">&times;</button></td>
                    </tr>
                `;
            }).join('');
        }
        calculatePOSTotals();
    }
    
    // NEW: Validate quantity on blur (after changing)
    function validateCartQuantity(index, newQuantity, maxStock) {
        const quantity = parseInt(newQuantity);
        if (quantity > maxStock) {
             showMessage('‡§∏‡•ç‡§ü‡•â‡§ï ‡§∏‡•Ä‡§Æ‡§ø‡§§ ‡§π‡•à', `‡§Ü‡§™‡§ï‡•á ‡§™‡§æ‡§∏ ‡§ï‡•á‡§µ‡§≤ ${maxStock} ‡§Ü‡§á‡§ü‡§Æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§π‡•à‡§Ç‡•§`, 'warning');
             posCart[index].quantity = maxStock;
             updatePOSCartView();
        }
    }


    function updateCartQuantity(index, newQuantity) {
        const quantity = parseInt(newQuantity);
        
        if (isNaN(quantity) || quantity < 1) {
            showMessage('‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä', '‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ 1 ‡§Ø‡§æ ‡§â‡§∏‡§∏‡•á ‡§Ö‡§ß‡§ø‡§ï ‡§π‡•ã‡§®‡•Ä ‡§ö‡§æ‡§π‡§ø‡§è‡•§', 'warning');
            updatePOSCartView(); 
            return;
        }
        
        posCart[index].quantity = quantity;
        updatePOSCartView(); 
    }

    function removeFromCart(index) {
        posCart.splice(index, 1);
        updatePOSCartView();
    }

    function calculatePOSTotals() {
        let subtotal = 0;
        let gstAmount = 0;
        let totalAmount = 0;
        
        posCart.forEach(item => {
            const itemTotalWithGST = item.sale_price * item.quantity;
            const gstValue = parseFloat(item.gst) || 0;
            // This calculation assumes sale_price INCLUDES GST.
            // const subtotalWithoutGST = itemTotalWithGST / (1 + (gstValue / 100)); 
            
            // This calculation assumes sale_price EXCLUDES GST.
            const subtotalWithoutGST = itemTotalWithGST;
            const itemGstAmount = subtotalWithoutGST * (gstValue / 100);
            
            subtotal += subtotalWithoutGST;
            gstAmount += itemGstAmount;
        });
        
        totalAmount = subtotal + gstAmount;
        
        document.getElementById('pos-subtotal').innerText = formatCurrency(subtotal);
        document.getElementById('pos-gst-amount').innerText = formatCurrency(gstAmount);
        document.getElementById('pos-total-amount').innerText = formatCurrency(totalAmount);

        return totalAmount;
    }

    async function handleCompleteSale() {
    if (posCart.length === 0) {
        return showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', '‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§™‡•Ç‡§∞‡•Ä ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§æ‡§∞‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç‡•§', 'warning');
    }

    const finalTotalAmount = parseFloat(document.getElementById('pos-total-amount').innerText.replace(/[^0-9.]/g, ''));

    const itemsForApi = posCart.map(item => ({
        sku: item.sku,
        name: item.name,
        quantity: item.quantity,
        sale_price: item.sale_price,
        purchase_price: parseFloat(item.purchase_price || 0),
        gst: item.gst
    }));

    const saleData = {
        customerName: document.getElementById('pos-customer').value || '‡§Ö‡§®‡§æ‡§Æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï',
        customerMobile: document.getElementById('pos-customer-mobile').value || null, // ‡§Ø‡§π ‡§≤‡§æ‡§á‡§® ‡§°‡•á‡§ü‡§æ ‡§≠‡•á‡§ú‡§§‡•Ä ‡§π‡•à
        total_amount: finalTotalAmount,
        sale_items: itemsForApi
    };
    
    try {
        const res = await fetchApi('/api/invoices', {
            method: 'POST',
            body: saleData
        }, '‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§™‡•Ç‡§∞‡•Ä ‡§ï‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à...');

        if (res.success) {
            showMessage('‡§∏‡§´‡§≤‡§§‡§æ', res.message, 'success');
            posCart = [];
            updatePOSCartView();
            document.getElementById('pos-customer').value = '';
            
            // ‚úÖ FIX: ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§á‡§®‡§™‡•Å‡§ü ‡§ï‡•ã ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡§®‡•á ‡§µ‡§æ‡§≤‡•Ä ‡§≤‡§æ‡§á‡§® ‡§Ø‡§π‡§æ‡§Å ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
            document.getElementById('pos-customer-mobile').value = ''; 
            
            fetchAndRenderSales();
            // Update stock list
            fetchApi('/api/stock', { method: 'GET' }).then(res => {
                if (res.success) currentStock = res.stock;
            });
            if (typeof renderDashboard === 'function') {
                renderDashboard();
            }
        } else {
            throw new Error(res.message || '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§');
        }
    } catch (error) {
        showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§µ‡§ø‡§´‡§≤: ${error.message}`, 'danger');
    }
}
    // --- FORM SUBMISSION HANDLERS ---
    
    function setupForm(formId, apiPath, successCallback) {
        const form = document.getElementById(formId);
        if (form && !form.dataset.initialized) {
            form.dataset.initialized = 'true';
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = form.querySelector('button[type="submit"]');
                const originalBtnText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ‡§∏‡•á‡§µ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...`;
                
                const data = {};

                if (formId === 'add-stock-form') {
                    data.sku = document.getElementById('stock-sku').value;
                    data.name = document.getElementById('stock-name').value;
                    data.quantity = document.getElementById('stock-quantity').value;
                    data.unit = document.getElementById('stock-unit').value;
                    data.purchase_price = document.getElementById('stock-purchase-price').value;
                    data.sale_price = document.getElementById('stock-sale-price').value;
                    data.gst = document.getElementById('stock-gst').value;
                    data.hsn_code = document.getElementById('stock-hsn-code').value; // NEW
                } else if (formId === 'add-customer-form') {
                    data.name = document.getElementById('customer-name').value;
                    data.phone = document.getElementById('customer-phone').value;
                    data.email = document.getElementById('customer-email').value;
                    data.address = document.getElementById('customer-address').value;
                    data.gstin = document.getElementById('customer-gstin').value;
                    
                    // üöÄ ‡§Ø‡§π ‡§®‡§à ‡§≤‡§æ‡§á‡§® ‡§Ø‡§π‡§æ‡§Å ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
                    data.balance = document.getElementById('customer-balance').value || 0;

                } else if (formId === 'add-purchase-form') {
               // ... (‡§≤‡§æ‡§á‡§® 1944 ‡§ï‡•á ‡§Ü‡§∏‡§™‡§æ‡§∏)
            } else if (formId === 'add-purchase-form') {
                    // üöÄ ‡§®‡§Ø‡§æ GST-‡§∏‡§ï‡•ç‡§∑‡§Æ ‡§≤‡•â‡§ú‡§ø‡§ï
                    data.supplier_name = document.getElementById('purchase-supplier').value;
                    data.total_cost = document.getElementById('purchase-total-cost').value;
                    data.date = document.getElementById('purchase-date').value;
                    
                    // GSTR-2 ‡§ï‡•á ‡§≤‡§ø‡§è gst_details JSON ‡§¨‡§®‡§æ‡§è‡§Å 
                    data.gst_details = {
                        invoice_number: document.getElementById('purchase-bill-number').value,
                        taxable_value: parseFloat(document.getElementById('purchase-taxable-value').value) || 0,
                        cgst: parseFloat(document.getElementById('purchase-cgst').value) || 0,
                        sgst: parseFloat(document.getElementById('purchase-sgst').value) || 0,
                        igst: parseFloat(document.getElementById('purchase-igst').value) || 0
                    };
                    
                    // 'item_details' ‡§ï‡•ã ‡§¨‡§ø‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§∏‡•á ‡§≠‡§∞‡•á‡§Ç
                    data.item_details = `Bill No: ${data.gst_details.invoice_number}`;
                    
                    // ‡§Ø‡§π ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø 'total_cost' GST ‡§ï‡•á ‡§∏‡§æ‡§• ‡§Æ‡•à‡§ö ‡§π‡•ã
                    const calculatedTotal = data.gst_details.taxable_value + data.gst_details.cgst + data.gst_details.sgst + data.gst_details.igst;
                    if (calculatedTotal > 0 && Math.abs(calculatedTotal - data.total_cost) > 0.1) {
                         // ‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä ‡§¶‡•á‡§Ç ‡§Ö‡§ó‡§∞ '‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø' ‡§î‡§∞ GST ‡§ï‡§æ ‡§ú‡•ã‡§°‡§º ‡§Æ‡•à‡§ö ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§§‡§æ
                         if(!confirm(`‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä: ‡§Ü‡§™‡§ï‡•Ä '‡§ï‡•Å‡§≤ ‡§¨‡§ø‡§≤ ‡§∞‡§æ‡§∂‡§ø' (${formatCurrency(data.total_cost)}) ‡§î‡§∞ GST ‡§ï‡§æ ‡§ú‡•ã‡§°‡§º (${formatCurrency(calculatedTotal)}) ‡§Æ‡•à‡§ö ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§´‡§ø‡§∞ ‡§≠‡•Ä ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?`)) {
                             btn.disabled = false;
                             btn.innerHTML = originalBtnText;
                             return; // ‡§∏‡§¨‡§Æ‡§ø‡§∂‡§® ‡§∞‡•ã‡§ï‡•á‡§Ç
                         }
                    }
                    
// ... (‡§Ø‡§π 'else if (formId === 'add-expense-form')' ‡§∏‡•á ‡§™‡§π‡§≤‡•á ‡§ñ‡§§‡•ç‡§Æ ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è)
                } else if (formId === 'add-expense-form') {
                    data.description = document.getElementById('expense-description').value;
                    data.category = document.getElementById('expense-category').value;
                    data.amount = document.getElementById('expense-amount').value;
                    data.created_at = document.getElementById('expense-date').value;
                }

                try {
                    let correctApiPath = apiPath;
                    if (apiPath === '/api/customer') correctApiPath = '/api/customers';
                    if (apiPath === '/api/purchase') correctApiPath = '/api/purchases';
                    if (apiPath === '/api/expense') correctApiPath = '/api/expenses';

                    const res = await fetchApi(correctApiPath, { method: 'POST', body: data });
                    if (res.success) {
                        showMessage('‡§∏‡§´‡§≤‡§§‡§æ', res.message, 'success');
                        form.reset();
                        if (successCallback) successCallback();
                    } else {
                        throw new Error(res.message);
                    }
                } catch (error) {
                    showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§∏‡•á‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§æ: ${error.message}`, 'danger');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalBtnText;
                }
            });
        }
    }



    

// üöÄ ‡§®‡§Ø‡§æ ‡§π‡•á‡§≤‡•ç‡§™‡§∞ ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§®: QR ‡§á‡§Æ‡•á‡§ú ‡§∏‡•á‡§ü ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§î‡§∞ Modal ‡§¶‡§ø‡§ñ‡§æ‡§§‡§æ ‡§π‡•à
function displayQrModal() {
         const modalBody = document.querySelector('#pairingModal .modal-body'); 
         if (!modalBody || !qrCodeDataUrl) {
             console.error("‚ùå displayQrModal: Modal ‡§¨‡•â‡§°‡•Ä ‡§Ø‡§æ QR ‡§ï‡•ã‡§° URL ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ!");
             showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', 'QR ‡§ï‡•ã‡§° ‡§¶‡§ø‡§ñ‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§', 'danger');
             return;
         }
         
         // Modal ‡§¨‡•â‡§°‡•Ä ‡§ï‡•ã ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§á‡§Æ‡•á‡§ú ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
         modalBody.innerHTML = `
            <p>‡§Ö‡§™‡§®‡•á Dukan Pro ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§∏‡•ç‡§ï‡•à‡§®‡§∞ ‡§ê‡§™ ‡§∏‡•á ‡§Ø‡§π QR ‡§ï‡•ã‡§° ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡•á‡§Ç‡•§</p>
            <div style="min-height: 260px; display: flex; align-items: center; justify-content: center;">
                <img src="${qrCodeDataUrl}" alt="QR Code" style="width: 256px; height: 256px; border: 1px solid #ccc;">
            </div>
             <p class="text-muted small mt-3">‡§Ø‡§π QR ‡§ï‡•ã‡§° ‡§Ü‡§™‡§ï‡•á POS ‡§ï‡•ã ‡§Ü‡§™‡§ï‡•á ‡§´‡§º‡•ã‡§® ‡§∏‡•á ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§ú‡•ã‡§°‡§º‡§§‡§æ ‡§π‡•à‡•§</p>
         `;
         
         // Modal ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
         if (pairingModalInstance) {
             pairingModalInstance.show();
         }
         isWaitingForQr = false; // ‡§á‡§Ç‡§§‡§ú‡§º‡§æ‡§∞ ‡§ñ‡§§‡•ç‡§Æ
    }


    // ===================================
// STAFF MANAGEMENT FUNCTIONS (NEW)
// ===================================
let staffEditModal = null; // To hold the modal instance

async function renderStaff() {
    // Only admin can see and manage staff
    if (!AppState.user || AppState.user.role !== 'ADMIN') {
        // Optionally hide the staff section link if not admin, though RBAC should handle it
        const staffLink = document.querySelector('a[data-view="staff"]');
        if(staffLink) staffLink.classList.add('d-none');
        // Clear the table if somehow accessed by non-admin
        document.getElementById('staff-table-body').innerHTML = `<tr><td colspan="7" class="text-center text-danger">‡§á‡§∏ ‡§∏‡•á‡§ï‡•ç‡§∂‡§® ‡§§‡§ï ‡§™‡§π‡•Å‡§Å‡§ö‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§°‡§Æ‡§ø‡§® ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à‡•§</td></tr>`;
        return;
    }

    const tableBody = document.getElementById('staff-table-body');
    tableBody.innerHTML = `<tr><td colspan="7" class="text-center">‡§∏‡•ç‡§ü‡§æ‡§´ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</td></tr>`;

    try {
        // Fetch users for the current shop using the correct endpoint
        const res = await fetchApi('/api/users', { method: 'GET' });
        if (res.success && res.users) {
            if (res.users.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">‡§á‡§∏ ‡§∂‡•â‡§™ ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§∏‡•ç‡§ü‡§æ‡§´ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§®‡§π‡•Ä‡§Ç ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§</td></tr>`;
                 return;
            }
            // Populate table rows
            tableBody.innerHTML = res.users.map(staff => `
                <tr>
                    <td>${staff.id}</td>
                    <td>${staff.name}</td>
                    <td>${staff.email}</td>
                    <td><span class="badge bg-${staff.role === 'ADMIN' ? 'danger' : staff.role === 'MANAGER' ? 'warning' : 'info'}">${staff.role}</span></td>
                    <td><span class="badge bg-${staff.status === 'active' ? 'success' : staff.status === 'pending' ? 'secondary' : 'dark'}">${staff.status}</span></td>
                    <td>${new Date(staff.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-primary ${staff.id === AppState.user.id ? 'disabled' : ''}" onclick='openEditStaffModal(${JSON.stringify(staff)})' title="‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger ${staff.id === AppState.user.id ? 'disabled' : ''}" onclick="handleDeleteStaff(${staff.id})" title="‡§π‡§ü‡§æ‡§è‡§Ç">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } else {
            throw new Error(res.message || '‡§∏‡•ç‡§ü‡§æ‡§´ ‡§∏‡•Ç‡§ö‡•Ä ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§');
        }
    } catch (e) {
        tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}</td></tr>`;
    }
}

// Opens the Edit Staff modal with pre-filled data
function openEditStaffModal(staff) {
    if (!staffEditModal) {
        staffEditModal = new bootstrap.Modal(document.getElementById('editStaffModal'));
    }
    // Populate the modal form fields
    document.getElementById('edit-staff-id').value = staff.id;
    document.getElementById('edit-staff-name').value = staff.name;
    document.getElementById('edit-staff-email').value = staff.email; // Email is disabled, just for display
    document.getElementById('edit-staff-role').value = staff.role;
    document.getElementById('edit-staff-status').value = staff.status;
    document.getElementById('edit-staff-password').value = ''; // Clear password field for security
    staffEditModal.show(); // Show the modal
}

// Handles the submission of the "Add Staff" form
async function handleAddStaff(event) {
    event.preventDefault(); // Prevent default form submission
    const btn = event.target.querySelector('button[type="submit"]');
    const originalBtnText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ‡§ú‡•ã‡§°‡§º‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...`;

    // Collect data from the add form
    const data = {
        name: document.getElementById('staff-name').value,
        email: document.getElementById('staff-email').value,
        password: document.getElementById('staff-password').value,
        role: document.getElementById('staff-role').value,
        status: document.getElementById('staff-status').value,
    };

    try {
        // Send POST request to add user endpoint
        const res = await fetchApi('/api/users', { method: 'POST', body: data });
        if (res.success) {
            showMessage('‡§∏‡§´‡§≤‡§§‡§æ', '‡§∏‡•ç‡§ü‡§æ‡§´ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ‡•§', 'success');
            document.getElementById('add-staff-form').reset(); // Reset form fields
            renderStaff(); // Refresh the staff list
        } else {
            throw new Error(res.message);
        }
    } catch (e) {
        showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§∏‡•ç‡§ü‡§æ‡§´ ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${e.message}`, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalBtnText;
    }
}



/**
 * ‡§è‡§ï ‡§∏‡§æ‡§ß‡§æ‡§∞‡§£ CSV ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•ã JSON ‡§ë‡§¨‡•ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§ê‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§™‡§æ‡§∞‡•ç‡§∏ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
 */
 function parseCSV(csvText) {
    const lines = csvText.split('\n');
    if (lines.length === 0) return [];
    
    // ‡§π‡•á‡§°‡§∞ (Date, Description, Debit, Credit) ‡§ï‡§æ ‡§™‡§§‡§æ ‡§≤‡§ó‡§æ‡§è‡§Å
    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
    
    // ‡§ï‡•â‡§≤‡§Æ ‡§á‡§Ç‡§°‡•á‡§ï‡•ç‡§∏ ‡§¢‡•Ç‡§Å‡§¢‡•á‡§Ç
    const dateIdx = headers.findIndex(h => h.includes('date'));
    const descIdx = headers.findIndex(h => h.includes('description') || h.includes('narration'));
    const debitIdx = headers.findIndex(h => h.includes('debit') || h.includes('withdrawal'));
    const creditIdx = headers.findIndex(h => h.includes('credit') || h.includes('deposit'));

    if (dateIdx === -1 || descIdx === -1 || debitIdx === -1 || creditIdx === -1) {
        showMessage('CSV ‡§è‡§∞‡§∞', 'CSV ‡§Æ‡•á‡§Ç Date, Description, Debit/Withdrawal, ‡§Ø‡§æ Credit/Deposit ‡§ï‡•â‡§≤‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•á‡•§', 'danger');
        throw new Error('Invalid CSV headers');
    }

    const items = [];
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line) continue;
        
        const values = line.split(',');
        
        const dateStr = values[dateIdx];
        // ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ï‡•ã YYYY-MM-DD ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤‡•á‡§Ç (‡§Æ‡§æ‡§® ‡§≤‡•á‡§Ç ‡§ï‡§ø ‡§Ø‡§π DD/MM/YYYY ‡§Ø‡§æ MM/DD/YYYY ‡§π‡•à)
        let dateObj;
        if (dateStr.includes('/')) {
            const parts = dateStr.split('/');
            // ‡§Æ‡§æ‡§® ‡§≤‡•á‡§Ç ‡§ï‡§ø ‡§Ø‡§π MM/DD/YYYY ‡§π‡•à (‡§á‡§∏‡•á ‡§Ö‡§™‡§®‡•á ‡§¨‡•à‡§Ç‡§ï ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§¨‡§¶‡§≤‡•á‡§Ç)
            // ‡§Ö‡§ó‡§∞ DD/MM/YYYY ‡§π‡•à, ‡§§‡•ã new Date(parts[2], parts[1] - 1, parts[0]) ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç
            dateObj = new Date(parts[2], parts[0] - 1, parts[1]); 
        } else {
            dateObj = new Date(dateStr); // ISO 8601 (YYYY-MM-DD)
        }
        
        const debitAmount = parseFloat(values[debitIdx].replace(/[^0-9.]/g, '')) || 0;
        const creditAmount = parseFloat(values[creditIdx].replace(/[^0-9.]/g, '')) || 0;

        items.push({
            date: dateObj.toISOString().split('T')[0],
            description: values[descIdx],
            debit: debitAmount,
            credit: creditAmount
        });
    }
    return items;
}




 // Handles the submission of the "Edit Staff" modal form
 async function handleUpdateStaff(event) {
    event.preventDefault(); // Prevent default form submission
    const staffId = document.getElementById('edit-staff-id').value;
    const btn = event.target.querySelector('button[type="submit"]');
    const originalBtnText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ‡§∏‡•á‡§µ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...`;

    // Collect data from the edit form
    const data = {
        name: document.getElementById('edit-staff-name').value,
        role: document.getElementById('edit-staff-role').value,
        status: document.getElementById('edit-staff-status').value,
    };
    // Note: Password update logic is currently commented out as per previous code
    const newPassword = document.getElementById('edit-staff-password').value;
    if (newPassword) {
         showMessage('‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä', '‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¨‡§¶‡§≤‡§®‡•á ‡§ï‡•Ä ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ ‡§Ö‡§≠‡•Ä ‡§≤‡§æ‡§ó‡•Ç ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§°‡§Æ‡§ø‡§® ‡§™‡•à‡§®‡§≤ ‡§∏‡•á ‡§¨‡§¶‡§≤‡•á‡§Ç ‡§Ø‡§æ ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§', 'warning');
         // If you implement password change on the server via PUT /api/users/:userId, uncomment below
         // data.password = newPassword;
    }

    try {
        // Send PUT request to update user endpoint
        const res = await fetchApi(`/api/users/${staffId}`, { method: 'PUT', body: data });
        if (res.success) {
            showMessage('‡§∏‡§´‡§≤‡§§‡§æ', '‡§∏‡•ç‡§ü‡§æ‡§´ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§', 'success');
            if (staffEditModal) staffEditModal.hide(); // Hide the modal
            renderStaff(); // Refresh the staff list
        } else {
            throw new Error(res.message);
        }
    } catch (e) {
        showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§∏‡•ç‡§ü‡§æ‡§´ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${e.message}`, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalBtnText;
    }
}

// Handles the deletion of a staff member
async function handleDeleteStaff(staffId) {
    // Prevent admin from deleting themselves
    if (staffId === AppState.user.id) {
        showMessage('‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§®‡§π‡•Ä‡§Ç', '‡§Ü‡§™ ‡§ñ‡•Å‡§¶ ‡§ï‡•ã ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á‡•§', 'warning');
        return;
    }

    if (!confirm(`‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§∏‡•ç‡§ü‡§æ‡§´ ‡§∏‡§¶‡§∏‡•ç‡§Ø ID ${staffId} ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§Ø‡§π ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§µ‡§æ‡§™‡§∏ ‡§®‡§π‡•Ä‡§Ç ‡§≤‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä‡•§`)) return;

    try {
        // Send DELETE request to delete user endpoint
        const res = await fetchApi(`/api/users/${staffId}`, { method: 'DELETE' });
         if (res.success) {
            showMessage('‡§∏‡§´‡§≤‡§§‡§æ', '‡§∏‡•ç‡§ü‡§æ‡§´ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§π‡§ü‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§', 'success');
            renderStaff(); // Refresh the staff list
        } else {
            throw new Error(res.message);
        }
    } catch (e) {
         showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§∏‡•ç‡§ü‡§æ‡§´ ‡§π‡§ü‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${e.message}`, 'danger');
    }
}

    // --- APPLICATION UNLOCK & INITIALIZATION ---
   // ... (unlockApplication ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§®)
   const unlockApplication = () => {
        // üöÄ ‡§®‡§Ø‡§æ: ‡§®‡§è ‡§≤‡•â‡§ó‡§ø‡§® ‡§™‡•á‡§ú ‡§ï‡•ã ‡§õ‡§ø‡§™‡§æ‡§è‡§Å
        const authContainerNew = document.getElementById('auth-container-new');
        if (authContainerNew) authContainerNew.classList.add('hidden');
        
        // ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§ï‡•ã‡§° (auth-container ‡§ï‡•ã ‡§õ‡§ø‡§™‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è)
        //document.getElementById('auth-container').classList.add('hidden');//
        
        // ‡§¨‡§æ‡§ï‡•Ä ‡§ï‡§æ ‡§Ü‡§™‡§ï‡§æ ‡§ï‡•ã‡§°...
        document.getElementById('sidebar').classList.remove('locked');
        document.getElementById('main-content').classList.remove('locked');
        // ... (‡§Ü‡§¶‡§ø) ...
        
        applyRBAC(AppState.user.role);
        setupForm('add-stock-form', '/api/stock', () => { /* ... */ });
        // ... (‡§Ü‡§™‡§ï‡•á ‡§∏‡§≠‡•Ä setupForm ‡§î‡§∞ setupNewFormHandlers ‡§ï‡•â‡§≤‡•ç‡§∏) ...
        renderView('dashboard');
    };


    /**
     * Hides/Shows UI elements based on user role
     * Roles: ADMIN (3) > MANAGER (2) > CASHIER (1)
     */
     function applyRBAC(role) {
        const roles = { 'ADMIN': 3, 'MANAGER': 2, 'CASHIER': 1, 'ANY': 0 };
        const userLevel = roles[role.toUpperCase()] || 0; // Get user's level

        // Loop through all elements that require a role
        document.querySelectorAll('[data-role]').forEach(el => {
            const requiredRole = el.dataset.role.toUpperCase();
            const requiredLevel = roles[requiredRole];
            
            if(requiredRole === 'ANY' || userLevel >= requiredLevel) {
                 el.classList.remove('d-none'); // Show element
            } else {
                el.classList.add('d-none'); // Hide element
            }
        });
    }
    
    // --- INVOICE GENERATOR FUNCTIONS ---
    function initializeQRUpload() {
        console.log("Initializing QR Upload...");
        const qrUploadInput = document.getElementById('qrUpload'); //
        if (qrUploadInput) {
            qrUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) {
                    qrCodeImage = '';
                    updateInvoicePreview();
                    return;
                }
                
                // ‡§´‡§º‡§æ‡§á‡§≤ ‡§ï‡•ã Base64 ‡§∏‡•ç‡§ü‡•ç‡§∞‡§ø‡§Ç‡§ó ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤‡•á‡§Ç
                const reader = new FileReader();
                reader.onload = (event) => {
                    qrCodeImage = event.target.result; // Base64 ‡§°‡•á‡§ü‡§æ
                    updateInvoicePreview(); // ‡§™‡•ç‡§∞‡•Ä‡§µ‡•ç‡§Ø‡•Ç ‡§ï‡•ã QR ‡§ï‡•ã‡§° ‡§ï‡•á ‡§∏‡§æ‡§• ‡§∞‡•Ä‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç
                };
                reader.readAsDataURL(file);
            });
        }
    }
    // --- REPORT ACTION HANDLER ---
    function handleReportAction(reportType, action) {
        const reportCardId = reportType === 'profit_loss' ? 'pl-card' : 'bs-card';
        const reportElement = document.getElementById(reportCardId);

        if (action === 'print') {
            document.querySelectorAll('.printable').forEach(el => el.classList.remove('printable'));
            reportElement.classList.add('printable');
            window.print();
        } else if (action === 'download') {
            showMessage('Info', 'PDF ‡§¨‡§®‡§æ‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç...', 'info');
            html2canvas(reportElement, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const ratio = canvas.height / canvas.width;
                const pdfHeight = pdfWidth * ratio;
                pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth - 20, pdfHeight - 20);
                pdf.save(`${reportType}_report_${new Date().toISOString().slice(0,10)}.pdf`);
            }).catch(err => {
                showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', 'PDF ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ' + err.message, 'danger');
            });
        }
    }

    // --- UNIVERSAL DELETE FUNCTION ---
   async function deleteEntry(type, id) {
        // 'id' is now the primary key or SKU
        const messages = {
            sale: `(‡§Ö‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§) ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä (ID: ${id}) ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?`,
            stock: `‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Ü‡§á‡§ü‡§Æ (SKU: ${id}) ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?`, // Changed to SKU
            customer: `(‡§Ö‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§) ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï (ID: ${id}) ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?`,
            purchase: `‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ ‡§ñ‡§∞‡•Ä‡§¶ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° (ID: ${id}) ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?`,
            expense: `‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ ‡§ñ‡§∞‡•ç‡§ö ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° (ID: ${id}) ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?`
        };

        if (!confirm(messages[type])) return;

        let apiPath = '';
        let successCallback;

        switch (type) {
            case 'stock': apiPath = `/api/stock/${id}`; successCallback = fetchAndRenderStockList; break;
            case 'purchase': apiPath = `/api/purchases/${id}`; successCallback = fetchAndRenderPurchases; break; 
            case 'expense': apiPath = `/api/expenses/${id}`; successCallback = fetchAndRenderExpenses; break; 
            
            case 'sale': 
            case 'customer':
            default: 
                showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', '‡§Ø‡§π ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ (delete) ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§', 'danger'); 
                return;
        }

        try {
            const res = await fetchApi(apiPath, { method: 'DELETE' }, '‡§π‡§ü‡§æ‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...');
            if (res.success) {
                showMessage('‡§∏‡§´‡§≤‡§§‡§æ', res.message, 'success');
                if (successCallback) successCallback();
                renderDashboard();
                renderReports();
            } else {
                throw new Error(res.message);
            }
        } catch (error) {
            showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§π‡§ü‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${error.message}`, 'danger');
        }
    }


    function addItem() {
        const itemName = document.getElementById('itemName').value; //
        const quantity = parseFloat(document.getElementById('quantity').value); //
        const price = parseFloat(document.getElementById('price').value); //
        const gst = parseFloat(document.getElementById('gst').value) || 0; //

        if (!itemName || !quantity || !price) {
            showMessage('Error', 'Please fill Item Name, Quantity, and Rate.', 'danger');
            return;
        }

        items.push({ name: itemName, quantity: quantity, price: price, gst: gst });
        updateInvoicePreview();
        
        document.getElementById('item-form').reset(); //
        document.getElementById('itemName').focus();
    }

    function deleteItem(index) {
        if (confirm('Are you sure you want to delete this item?')) {
            items.splice(index, 1);
            updateInvoicePreview();
        }
    }

    function updateInvoicePreview() {
        const shopName = document.getElementById('shopName').value || 'Shop Name';
        const shopContact = document.getElementById('shopContact').value || 'Contact No.';
        const shopAddress = document.getElementById('shopAddress').value || 'Shop Address';
        const shopGstin = document.getElementById('shopGstin').value || '';
        
        const customerName = document.getElementById('customerName').value || 'Customer Name';
        const customerContact = document.getElementById('customerContact').value || 'Contact No.';
        const customerAddress = document.getElementById('customerAddress').value || 'Customer Address';
        
        const preview = document.getElementById('invoice-preview'); //
        
        let itemRows = '';
        let totalAmount = 0;
        let totalTax = 0;
        let subTotal = 0;
        
        items.forEach((item, index) => {
            const itemSubTotal = (item.price || 0) * (item.quantity || 0);
            const itemGst = itemSubTotal * ((item.gst || 0) / 100);
            const itemTotal = itemSubTotal + itemGst;
            
            subTotal += itemSubTotal;
            totalTax += itemGst;
            totalAmount += itemTotal;
            
            itemRows += `
                <tr>
                    <td>${index + 1}</td>
                    <td style="text-align: left;">${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${formatCurrency(item.price)}</td>
                    <td>${item.gst}%</td>
                    <td>${formatCurrency(itemSubTotal)}</td>
                    <td>
                        <button class="btn btn-danger btn-sm py-0 px-1 no-print" onclick="deleteItem(${index})">&times;</button>
                    </td>
                </tr>
            `;
        });

        const cgst = totalTax / 2;
        const sgst = totalTax / 2;
        
        // üöÄ (‡§´‡§ø‡§ï‡•ç‡§∏) QR ‡§ï‡•ã‡§° ‡§ï‡•á ‡§≤‡§ø‡§è HTML
        const qrHtml = qrCodeImage ? `
            <div id="qr-preview" class="text-center">
                <p class="small mb-1">Scan to Pay:</p>
                <img src="${qrCodeImage}" alt="UPI QR Code" style="max-width: 100px; max-height: 100px; border: 1px solid #ccc; padding: 3px;">
            </div>` : '';

        // ‡§™‡•Ç‡§∞‡§æ ‡§á‡§®‡§µ‡•â‡§á‡§∏ HTML
        preview.innerHTML = `
            <div class="printable">
                <div class="invoice-header">
                    <div class="shop-details">
                        <h3>${shopName}</h3>
                        <p class="mb-0">${shopAddress}</p>
                        <p class="mb-0">Ph: ${shopContact}</p>
                        ${shopGstin ? `<p class="mb-0"><strong>GSTIN: ${shopGstin}</strong></p>` : ''}
                    </div>
                    <h2 style="color: #333; align-self: center;">INVOICE</h2>
                </div>
                
                <div class="customer-details row">
                    <div class="col-8">
                        <strong>Bill To:</strong>
                        <p class="mb-0">${customerName}</p>
                        <p class="mb-0">${customerAddress}</p>
                        <p class="mb-0">Ph: ${customerContact}</p>
                    </div>
                    <div class="col-4 text-end">
                        <p class="mb-0"><strong>Invoice No:</strong> INV-${Date.now().toString().slice(-6)}</p>
                        <p class="mb-0"><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                    </div>
                </div>

                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">#</th>
                            <th style="text-align: left;">Item</th>
                            <th style="width: 10%;">Qty</th>
                            <th style="width: 15%;">Rate</th>
                            <th style="width: 10%;">GST%</th>
                            <th style="width: 15%;">Amount</th>
                            <th style="width: 5%;" class="no-print"></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemRows || `<tr><td colspan="7" class="text-center text-muted p-4">No items added.</td></tr>`}
                    </tbody>
                </table>
                
                <div class="invoice-footer">
                    <div>
                        ${qrHtml} <div class="terms mt-3">
                            <strong>Terms & Conditions:</strong>
                            <p class="mb-0">1. Goods once sold will not be taken back.</p>
                            <p class="mb-0">2. All disputes are subject to jurisdiction.</p>
                        </div>
                    </div>
                    
                    <table class="totals-table">
                        <tbody>
                            <tr>
                                <td>Subtotal:</td>
                                <td style="text-align: right;">${formatCurrency(subTotal)}</td>
                            </tr>
                            <tr>
                                <td>CGST:</td>
                                <td style="text-align: right;">${formatCurrency(cgst)}</td>
                            </tr>
                            <tr>
                                <td>SGST:</td>
                                <td style="text-align: right;">${formatCurrency(sgst)}</td>
                            </tr>
                            <tr style="font-weight: bold; font-size: 1.2em; border-top: 2px solid #333;">
                                <td>Grand Total:</td>
                                <td style="text-align: right;">${formatCurrency(totalAmount)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }


   function downloadInvoicePDF() {
        if (items.length === 0) {
            return showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', 'PDF ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç‡•§', 'warning');
        }
        handleReportAction('invoice', 'download');
    }

    function printInvoice() {
        window.print();
    }

    function clearBill() {
        if (confirm('Are you sure you want to clear the entire bill?')) {
            items = [];
            qrCodeImage = '';
            document.getElementById('qrUpload').value = null;
            document.getElementById('customerName').value = '';
            document.getElementById('customerContact').value = '';
            document.getElementById('customerAddress').value = '';
            document.getElementById('item-form').reset();
            
            // ‡§∂‡•â‡§™ ‡§ï‡•Ä ‡§°‡§ø‡§ü‡•á‡§≤‡•ç‡§∏ ‡§ï‡•ã ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§≠‡§∞‡•á‡§Ç (‡§â‡§®‡•ç‡§π‡•á‡§Ç ‡§ï‡•ç‡§≤‡§ø‡§Ø‡§∞ ‡§® ‡§ï‡§∞‡•á‡§Ç)
            fetchAndPopulateShopData(); 
            
            showMessage('Success', 'Bill cleared.', 'success');
        }
    }
   // ===================================
    // STEP 6: NEW AUTHENTICATION FLOW & NEW FEATURES
    // ===================================

    /**
     * Saves auth data to AppState and localStorage
     */
     function saveAuthData(token, user) {
        AppState.token = token;
        AppState.user = user;
        localStorage.setItem('authToken', token);
        localStorage.setItem('authUser', JSON.stringify(user));
        
        // Update UI with user info
        updateShopDisplay(user);
    }
    
    // NEW: Update Shop Name/Logo in UI
   // NEW: Update Shop Name/Logo in UI
  // NEW: Update Shop Name/Logo in UI
  function updateShopDisplay(user) {
        if (!user) return;
        const shopName = user.shopName || 'Dukan Pro';
        
        // üöÄ FIX: ‡§™‡§π‡§≤‡•á ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§Ü‡§Ø‡§æ ‡§π‡•Å‡§Ü ‡§≤‡•ã‡§ó‡•ã, ‡§Ö‡§ó‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§§‡•ã Local Storage ‡§∏‡•á ‡§≤‡•á‡§Ç
        const storedLogo = localStorage.getItem('shopLogoData');
        const shopLogo = user.shopLogo || storedLogo; 

        document.getElementById('user-shop-name').innerText = shopName;
        document.getElementById('user-name-email').innerText = `${user.name} (${user.role})`;
        
        const logoContainer = document.getElementById('shop-logo-container');
        if (shopLogo) {
            logoContainer.innerHTML = `<img src="${shopLogo}" alt="Shop Logo" class="img-fluid rounded-circle" style="max-height: 100px; border: 3px solid #fff;">`;
            
            // ‡§Ø‡§π ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø UI ‡§ï‡•á ‡§Ö‡§®‡•ç‡§Ø ‡§≠‡§æ‡§ó ‡§≠‡•Ä ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ú‡§æ‡§è‡§Å
            document.getElementById('remove-shop-logo-btn').classList.remove('d-none');
            document.getElementById('shop-logo-preview').src = shopLogo; 
            document.getElementById('shop-logo-preview').style.display = 'block';
        } else {
            logoContainer.innerHTML = '';
            document.getElementById('remove-shop-logo-btn').classList.add('d-none');
            document.getElementById('shop-logo-preview').style.display = 'none';
        }
    }


    /**
     * Clears auth data and reloads the page to show login screen
     */
     function logout() {
        AppState.token = null;
        AppState.user = null;
        localStorage.removeItem('authToken');
        localStorage.removeItem('authUser');
        if(AppState.licenseTimerId) clearInterval(AppState.licenseTimerId);
        window.location.reload(); 
        
        // üöÄ ‡§®‡§Ø‡§æ: ‡§∞‡•Ä‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§∏‡•á ‡§™‡§π‡§≤‡•á ‡§≤‡•â‡§ó‡§ø‡§® ‡§™‡•á‡§ú ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï, ‡§≤‡•á‡§ï‡§ø‡§® ‡§∏‡•ç‡§Æ‡•Ç‡§•)
        const authContainerNew = document.getElementById('auth-container-new');
        if (authContainerNew) authContainerNew.classList.remove('hidden');
    }
    
    // NEW: License Timer and Renewal Warning
    function startLicenseTimer(expiryDateStr) {
        const timerEl = document.getElementById('license-timer');
        const renewalModal = new bootstrap.Modal(document.getElementById('renewalModal'));
        if (AppState.licenseTimerId) clearInterval(AppState.licenseTimerId);
        
        if (!expiryDateStr) {
            timerEl.innerHTML = `<i class="fas fa-times-circle text-danger"></i> ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à`;
            timerEl.className = 'text-center mb-2 expired';
            timerEl.onclick = () => renewalModal.show();
            return;
        }

        const expiryDate = new Date(expiryDateStr);
        
        function updateTimer() {
            const now = new Date();
            const timeLeft = expiryDate.getTime() - now.getTime();
            
            const daysLeft = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hoursLeft = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutesLeft = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const secondsLeft = Math.floor((timeLeft % (1000 * 60)) / 1000);

            if (timeLeft <= 0) {
                timerEl.innerHTML = `<i class="fas fa-times-circle"></i> ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à`;
                timerEl.className = 'text-center mb-2 expired';
                timerEl.onclick = () => renewalModal.show();
                clearInterval(AppState.licenseTimerId);
            } else if (daysLeft < 7) {
                // Requirement 9: Expiring soon warning
                timerEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${daysLeft}d ${hoursLeft}h ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã‡§ó‡§æ!`;
                timerEl.className = 'text-center mb-2 expiring-soon';
                timerEl.onclick = () => renewalModal.show();
            } else {
                timerEl.innerHTML = `<i class="fas fa-check-circle text-success"></i> ${daysLeft} ‡§¶‡§ø‡§® ${hoursLeft} ‡§ò‡§Ç‡§ü‡•á ‡§∂‡•á‡§∑`;
                timerEl.className = 'text-center text-white-50 mb-2';
                timerEl.onclick = null;
            }
        }
        
        updateTimer();
        AppState.licenseTimerId = setInterval(updateTimer, 1000); // Update every second
    }
    
    // NEW: Send WhatsApp Renewal Request
    function sendWhatsAppRenewal(months) {
        const adminPhone = "7303410987";
        let message = `‡§®‡§Æ‡§∏‡•ç‡§§‡•á Dukan Pro ‡§è‡§°‡§Æ‡§ø‡§®,\n\n`;
        message += `‡§Æ‡•á‡§∞‡§æ ‡§®‡§æ‡§Æ ${AppState.user.name} ‡§π‡•à ‡§î‡§∞ ‡§Æ‡•á‡§∞‡•Ä ‡§∂‡•â‡§™ ‡§ï‡§æ ‡§®‡§æ‡§Æ ${AppState.user.shopName} (Shop ID: ${AppState.user.shopId}) ‡§π‡•à‡•§\n`;
        message += `‡§Æ‡•á‡§∞‡§æ ‡§à‡§Æ‡•á‡§≤: ${AppState.user.email}\n\n`;
        message += `‡§Æ‡•à‡§Ç ‡§Ö‡§™‡§®‡§æ Dukan Pro ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ${months} ‡§Æ‡§π‡•Ä‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∞‡§ø‡§®‡•ç‡§Ø‡•Ç ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡§æ ‡§π‡•Ç‡§Å‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç‡•§\n\n‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶‡•§`;
        
        const whatsappUrl = `https://wa.me/${adminPhone}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
    }
    
    // NEW: Barcode Scanning Functions
    function focusBarcodeScanner() {
        const scannerInput = document.getElementById('barcode-scanner-input');
        // Only focus if we are on the sales page
        if(AppState.currentView === 'sales') {
            scannerInput.focus();
        }
    }
    
       
    // NEW: Functions for New Sections
    async function fetchAndRenderClosingReports() {
    console.log("üöÄ fetchAndRenderClosingReports() ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•Å‡§Ü..."); // Log Start
    const tableBody = document.getElementById('daily-closing-table-body');
    if (!tableBody) {
         console.error("‚ùå ‡§è‡§∞‡§∞: daily-closing-table-body ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ!");
         return;
    }
    tableBody.innerHTML = `<tr><td colspan="5" class="text-center">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</td></tr>`;
    try {
        console.log("üì° API ‡§ï‡•â‡§≤ /api/closing/reports ‡§≠‡•á‡§ú‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...");
        const res = await fetchApi('/api/closing/reports', { method: 'GET' });
        console.log("üìÑ API ‡§∞‡§ø‡§∏‡•ç‡§™‡§æ‡§Ç‡§∏ ‡§Æ‡§ø‡§≤‡§æ:", res); // Log Response

        if (res.success && res.reports && res.reports.length > 0) {
             console.log(`üìä ${res.reports.length} ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏ ‡§Æ‡§ø‡§≤‡•Ä‡§Ç‡•§ HTML ‡§¨‡§®‡§æ ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å...`);
            tableBody.innerHTML = res.reports.map(r => `
                <tr>
                    <td>${new Date(r.closing_date).toLocaleDateString()}</td>
                    <td>${formatCurrency(r.total_sales)}</td>
                    <td>${formatCurrency(r.total_cogs)}</td>
                    <td>${formatCurrency(r.total_expenses)}</td>
                    <td class="fw-bold ${r.net_profit >= 0 ? 'text-success' : 'text-danger'}">
                        ${formatCurrency(r.net_profit)}
                    </td>
                </tr>
            `).join('');
             console.log("‚úÖ ‡§ü‡•á‡§¨‡§≤ HTML ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ‡•§");
        } else {
             console.log("‚ÑπÔ∏è ‡§ï‡•ã‡§à ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä ‡§Ø‡§æ API ‡§µ‡§ø‡§´‡§≤‡•§");
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">‡§ï‡•ã‡§à ‡§ï‡•ç‡§≤‡•ã‡§ú‡§ø‡§Ç‡§ó ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§</td></tr>`;
        }
    } catch (e) {
        console.error("‚ùå fetchAndRenderClosingReports ‡§è‡§∞‡§∞:", e); // Log Error
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}</td></tr>`;
    }
     console.log("üèÅ fetchAndRenderClosingReports() ‡§ñ‡§§‡•ç‡§Æ ‡§π‡•Å‡§Ü‡•§"); // Log End
}
    
    async function fetchAndRenderShopSettings() {
        try {
            // Fetch company profile (GST info) [cite: 349]
            const profileRes = await fetchApi('/api/shop/company-profile', { method: 'GET' });
            if (profileRes.success && profileRes.profile) {
                document.getElementById('company-legal-name').value = profileRes.profile.legal_name || '';
                document.getElementById('company-gstin').value = profileRes.profile.gstin || '';
                document.getElementById('company-address').value = profileRes.profile.address || '';
                // üöÄ FIX: ‡§™‡•Ç‡§Ç‡§ú‡•Ä ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§π ‡§≤‡§æ‡§á‡§® ‡§ú‡•ã‡§°‡§º‡•Ä
                document.getElementById('company-opening-capital').value = profileRes.profile.opening_capital || '0'; 
            }
            
            // Fetch display settings (from user object)
            document.getElementById('shop-display-name').value = AppState.user.shopName || '';
            const logoPreview = document.getElementById('shop-logo-preview');
            if (AppState.user.shopLogo) {
                logoPreview.src = AppState.user.shopLogo;
                logoPreview.style.display = 'block';
            } else {
                logoPreview.style.display = 'none';
            }
        } catch (e) {
            showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${e.message}`, 'danger');
        }
    }
    
    // NEW: Handle complex backup downloads
    async function handleBackupDownloads(type) {
        if (type === 'json') {
            try {
                const res = await fetchApi('/api/backup', { method: 'GET' }, 'JSON ‡§¨‡•à‡§ï‡§Ö‡§™ ‡§¨‡§®‡§æ‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...');
                if (res.success) {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(res.backupData, null, 2));
                    const dlAnchorElem = document.createElement('a');
                    dlAnchorElem.setAttribute("href", dataStr);
                    dlAnchorElem.setAttribute("download", `dukan_pro_backup_${AppState.user.shopId}_${getISODate()}.json`);
                    dlAnchorElem.click();
                } else {
                    showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', res.message, 'danger');
                }
            } catch (e) { showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', e.message, 'danger'); }
        
        } else if (type === 'excel') {
            try {
                const res = await fetchApi('/api/backup', { method: 'GET' }, 'Excel ‡§¨‡•à‡§ï‡§Ö‡§™ ‡§¨‡§®‡§æ‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...');
                if (res.success) {
                    const wb = XLSX.utils.book_new();
                    for (const tableName in res.backupData) {
                        const ws = XLSX.utils.json_to_sheet(res.backupData[tableName]);
                        XLSX.utils.book_append_sheet(wb, ws, tableName.slice(0, 31)); // Sheet name limit 31 chars
                    }
                    XLSX.writeFile(wb, `dukan_pro_backup_${AppState.user.shopId}_${getISODate()}.xlsx`);
                } else {
                    showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', res.message, 'danger');
                }
            } catch (e) { showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', e.message, 'danger'); }
            
        } else if (type === 'csv') {
            const startDate = document.getElementById('product-report-start-date').value;
            const endDate = document.getElementById('product-report-end-date').value;
            if (!startDate || !endDate) {
                return showMessage('‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ö‡•Å‡§®‡•á‡§Ç', "‡§ï‡•É‡§™‡§Ø‡§æ ‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä CSV ‡§ï‡•á ‡§≤‡§ø‡§è 'Reports' ‡§ü‡•à‡§¨ ‡§Æ‡•á‡§Ç ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§", 'warning');
            }
            // Use the dedicated server endpoint [cite: 331]
            const url = `${__backend_url}/api/reports/product-sales/download?startDate=${startDate}&endDate=${endDate}&token=${AppState.token}`;
            // Hacky way to download with token (GET request)
            window.open(url, '_blank');
        }
    }


    // ‡§Ö‡§™‡§®‡•á ‡§Ö‡§®‡•ç‡§Ø JavaScript ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®‡•ç‡§∏ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§á‡§∏‡•á ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
function removeShopLogo() {
    // 1. ‡§ó‡•ç‡§≤‡•ã‡§¨‡§≤ ‡§µ‡•á‡§∞‡§ø‡§è‡§¨‡§≤ ‡§ï‡•ã ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
    shopLogoBase64 = null; 
    // 2. HTML ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç
    document.getElementById('shop-logo-preview').src = '';
    document.getElementById('shop-logo-preview').style.display = 'none';
    document.getElementById('shop-logo-upload').value = null; // ‡§´‡§º‡§æ‡§á‡§≤ ‡§á‡§®‡§™‡•Å‡§ü ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç
    document.getElementById('remove-shop-logo-btn').classList.add('d-none');
    
    showMessage('‡§∏‡§æ‡§µ‡§ß‡§æ‡§®', '‡§≤‡•ã‡§ó‡•ã ‡§π‡§ü‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è "‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç" ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§', 'warning');
}
    
    // NEW: Setup listeners for all new forms and buttons
    function setupNewFormHandlers() {
        // Product Sales Report Button
        document.getElementById('fetch-product-sales-report-btn').addEventListener('click', async () => {
            const startDate = document.getElementById('product-report-start-date').value;
            const endDate = document.getElementById('product-report-end-date').value;
            if (!startDate || !endDate) {
                return showMessage('‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ö‡•Å‡§®‡•á‡§Ç', '‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§', 'warning');
            }
            const tableBody = document.getElementById('product-sales-report-body');
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...</td></tr>`;
            try {
                const res = await fetchApi(`/api/reports/product-sales?startDate=${startDate}&endDate=${endDate}`, { method: 'GET' });
                if (res.success && res.report.length > 0) {
                    tableBody.innerHTML = res.report.map(r => `
                        <tr>
                            <td>${r.item_sku}</td>
                            <td>${r.item_name}</td>
                            <td>${r.total_quantity_sold}</td>
                            <td>${formatCurrency(r.total_revenue)}</td>
                            <td>${formatCurrency(r.total_cost)}</td>
                            <td class="fw-bold ${r.total_profit >= 0 ? 'text-success' : 'text-danger'}">
                                ${formatCurrency(r.total_profit)}
                            </td>
                        </tr>
                    `).join('');
                } else {
                     tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">‡§á‡§∏ ‡§Ö‡§µ‡§ß‡§ø ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§</td></tr>`;
                }
            } catch (e) { tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}</td></tr>`; }
        });
        
        // GST Report Buttons
        const gstResultEl = document.getElementById('gst-report-result');
        const gstTitleEl = document.getElementById('gst-report-title');
        
        // --- TALLY UPDATE START: GSTR-1 Button Logic ---
        document.getElementById('fetch-gstr1-report-btn').addEventListener('click', async () => {
            const startDate = document.getElementById('gst-report-start-date').value;
            const endDate = document.getElementById('gst-report-end-date').value;
            if (!startDate || !endDate) return showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', '‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§', 'warning');
            
            // ‡§®‡§è HTML ‡§ü‡•à‡§¨ ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü ‡§è‡§∞‡§ø‡§Ø‡§æ ‡§ï‡•ã ‡§ü‡§æ‡§∞‡§ó‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
            const gstr1ContentEl = document.getElementById('gstr1-report-content');
            const mainGstTitleEl = document.getElementById('gst-report-title'); // ‡§Ø‡§π ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§ü‡§æ‡§á‡§ü‡§≤ ‡§π‡•à, ‡§á‡§∏‡•á ‡§õ‡§ø‡§™‡§æ ‡§≠‡•Ä ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç
            
            if(mainGstTitleEl) mainGstTitleEl.innerText = "GSTR-1 (‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä) ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...)";
            gstr1ContentEl.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

            // GSTR-1 ‡§ü‡•à‡§¨ ‡§ï‡•ã ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§∞‡•á‡§Ç
            new bootstrap.Tab(document.getElementById('gst-gstr1-tab')).show();

            try {
                const res = await fetchApi(`/api/reports/gstr1?startDate=${startDate}&endDate=${endDate}`, { method: 'GET' });
                if (!res.success) throw new Error(res.message || 'GSTR-1 ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§≤‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§');
                
                if(mainGstTitleEl) mainGstTitleEl.innerText = `GSTR-1 (‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä) ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (${startDate} ‡§∏‡•á ${endDate})`;
                const report = res.report;
                
                // 1. Tally-Style HTML Template ‡§ï‡•ã ‡§ï‡•ç‡§≤‡•ã‡§® ‡§ï‡§∞‡•á‡§Ç
                const template = document.getElementById('gstr1-report-template');
                gstr1ContentEl.innerHTML = template.innerHTML; // ‡§ü‡•á‡§Æ‡•ç‡§™‡§≤‡•á‡§ü ‡§ï‡•ã ‡§∞‡§ø‡§ú‡§≤‡•ç‡§ü ‡§è‡§∞‡§ø‡§Ø‡§æ ‡§Æ‡•á‡§Ç ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç

                // 2. B2B ‡§ü‡•á‡§¨‡§≤ ‡§≠‡§∞‡•á‡§Ç
                const b2bTableBody = document.getElementById('gstr1-b2b-table').querySelector('tbody');
                const b2bTableFoot = document.getElementById('gstr1-b2b-table').querySelector('tfoot');
                let b2bTotalTaxable = 0, b2bTotalIgst = 0, b2bTotalCgst = 0, b2bTotalSgst = 0;
                b2bTableBody.innerHTML = ''; // ‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§™‡§Ç‡§ï‡•ç‡§§‡§ø‡§Ø‡§æ‡§Å ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç
                
                if (report.b2b && report.b2b.length > 0) {
                    report.b2b.forEach(item => {
                        const taxable = parseFloat(item.total_taxable_value) || 0;
                        const igst = parseFloat(item.total_igst) || 0;
                        const cgst = parseFloat(item.total_cgst) || 0;
                        const sgst = parseFloat(item.total_sgst) || 0;
                        b2bTotalTaxable += taxable;
                        b2bTotalIgst += igst;
                        b2bTotalCgst += cgst;
                        b2bTotalSgst += sgst;
                        
                        b2bTableBody.innerHTML += `
                            <tr>
                                <td class="text-left">${item.customer_gstin}</td>
                                <td class="text-left">${item.customer_name || 'N/A'}</td>
                                <td class="text-center">${item.invoice_number}</td>
                                <td class="text-center">${new Date(item.invoice_date).toLocaleDateString()}</td>
                                <td>${formatCurrency(taxable)}</td>
                                <td>${formatCurrency(igst)}</td>
                                <td>${formatCurrency(cgst)}</td>
                                <td>${formatCurrency(sgst)}</td>
                            </tr>
                        `;
                    });
                } else {
                    b2bTableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">‡§á‡§∏ ‡§Ö‡§µ‡§ß‡§ø ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à B2B (GSTIN ‡§µ‡§æ‡§≤‡•Ä) ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§</td></tr>';
                }
                b2bTableFoot.innerHTML = `<tr><td colspan="4" class="text-left">B2B ‡§ï‡•Å‡§≤</td><td>${formatCurrency(b2bTotalTaxable)}</td><td>${formatCurrency(b2bTotalIgst)}</td><td>${formatCurrency(b2bTotalCgst)}</td><td>${formatCurrency(b2bTotalSgst)}</td></tr>`;

                // 3. B2C ‡§ü‡•á‡§¨‡§≤ ‡§≠‡§∞‡•á‡§Ç
                const b2cTableBody = document.getElementById('gstr1-b2c-table').querySelector('tbody');
                const b2cTableFoot = document.getElementById('gstr1-b2c-table').querySelector('tfoot');
                let b2cTotalTaxable = 0, b2cTotalIgst = 0, b2cTotalCgst = 0, b2cTotalSgst = 0, b2cTotalTax = 0;
                b2cTableBody.innerHTML = ''; // ‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§™‡§Ç‡§ï‡•ç‡§§‡§ø‡§Ø‡§æ‡§Å ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç
                
                if (report.b2c && report.b2c.length > 0) {
                    report.b2c.forEach(item => {
                        const taxable = parseFloat(item.taxable_value) || 0;
                        const igst = parseFloat(item.total_igst) || 0;
                        const cgst = parseFloat(item.total_cgst) || 0;
                        const sgst = parseFloat(item.total_sgst) || 0;
                        const tax = parseFloat(item.total_tax) || 0;
                        b2cTotalTaxable += taxable;
                        b2cTotalIgst += igst;
                        b2cTotalCgst += cgst;
                        b2cTotalSgst += sgst;
                        b2cTotalTax += tax;

                        b2cTableBody.innerHTML += `
                            <tr>
                                <td class="text-left">${item.place_of_supply || 'N/A'}</td>
                                <td class="text-center">${item.gst_rate}%</td>
                                <td>${formatCurrency(taxable)}</td>
                                <td>${formatCurrency(igst)}</td>
                                <td>${formatCurrency(cgst)}</td>
                                <td>${formatCurrency(sgst)}</td>
                                <td>${formatCurrency(tax)}</td>
                            </tr>
                        `;
                    });
                } else {
                    b2cTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">‡§á‡§∏ ‡§Ö‡§µ‡§ß‡§ø ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à B2C (‡§õ‡•ã‡§ü‡•Ä) ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§</td></tr>';
                }
                b2cTableFoot.innerHTML = `<tr><td colspan="2" class="text-left">B2C ‡§ï‡•Å‡§≤</td><td>${formatCurrency(b2cTotalTaxable)}</td><td>${formatCurrency(b2cTotalIgst)}</td><td>${formatCurrency(b2cTotalCgst)}</td><td>${formatCurrency(b2cTotalSgst)}</td><td>${formatCurrency(b2cTotalTax)}</td></tr>`;

                // 4. HSN ‡§ü‡•á‡§¨‡§≤ ‡§≠‡§∞‡•á‡§Ç
                const hsnTableBody = document.getElementById('gstr1-hsn-table').querySelector('tbody');
                const hsnTableFoot = document.getElementById('gstr1-hsn-table').querySelector('tfoot'); // tfoot ‡§≠‡•Ä ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
                let hsnTotalQty = 0, hsnTotalTaxable = 0, hsnTotalIgst = 0, hsnTotalCgst = 0, hsnTotalSgst = 0, hsnTotalTax = 0;
                hsnTableBody.innerHTML = ''; // ‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§™‡§Ç‡§ï‡•ç‡§§‡§ø‡§Ø‡§æ‡§Å ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç
                
                if (report.hsn_summary && report.hsn_summary.length > 0) {
                    report.hsn_summary.forEach(item => {
                        const qty = parseFloat(item.total_quantity) || 0;
                        const taxable = parseFloat(item.total_taxable_value) || 0;
                        const igst = parseFloat(item.total_igst) || 0;
                        const cgst = parseFloat(item.total_cgst) || 0;
                        const sgst = parseFloat(item.total_sgst) || 0;
                        const tax = parseFloat(item.total_tax) || 0;
                        
                        hsnTotalQty += qty;
                        hsnTotalTaxable += taxable;
                        hsnTotalIgst += igst;
                        hsnTotalCgst += cgst;
                        hsnTotalSgst += sgst;
                        hsnTotalTax += tax;
                        
                        hsnTableBody.innerHTML += `
                            <tr>
                                <td class="text-center">${item.hsn_code || 'N/A'}</td>
                                <td class="text-left">${item.item_name}</td>
                                <td class="text-center">${item.unit || 'Pcs'}</td>
                                <td class="text-center">${qty}</td>
                                <td>${formatCurrency(taxable)}</td>
                                <td>${formatCurrency(igst)}</td>
                                <td>${formatCurrency(cgst)}</td>
                                <td>${formatCurrency(sgst)}</td>
                                <td>${formatCurrency(tax)}</td>
                            </tr>
                        `;
                    });
                } else {
                    hsnTableBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">‡§á‡§∏ ‡§Ö‡§µ‡§ß‡§ø ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à HSN ‡§∏‡§Æ‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§</td></tr>';
                }
                // HSN Total Foot
                if (hsnTableFoot) {
                    hsnTableFoot.innerHTML = `<tr><td colspan="3" class="text-left">HSN ‡§ï‡•Å‡§≤</td><td class="text-center">${hsnTotalQty}</td><td>${formatCurrency(hsnTotalTaxable)}</td><td>${formatCurrency(hsnTotalIgst)}</td><td>${formatCurrency(hsnTotalCgst)}</td><td>${formatCurrency(hsnTotalSgst)}</td><td>${formatCurrency(hsnTotalTax)}</td></tr>`;
                }


                // 5. Tabs ‡§ï‡•ã ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§∞‡•á‡§Ç (‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø ‡§π‡§Æ‡§®‡•á HTML ‡§ï‡•ã ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§≤‡§ø‡§ñ‡§æ ‡§π‡•à)
                var triggerTabList = [].slice.call(document.querySelectorAll('#gstr1-inner-tab button'));
                triggerTabList.forEach(function (triggerEl) {
                    var tabTrigger = new bootstrap.Tab(triggerEl);
                    triggerEl.addEventListener('click', function (event) {
                        event.preventDefault();
                        tabTrigger.show();
                    });
                });
                // ‡§™‡§π‡§≤‡•á ‡§ü‡•à‡§¨ (B2B) ‡§ï‡•ã ‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
                new bootstrap.Tab(document.getElementById('gstr1-b2b-tab')).show();


            } catch (e) { 
                if(mainGstTitleEl) mainGstTitleEl.innerText = "GSTR-1 ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü";
                gstr1ContentEl.innerHTML = `<div class="text-danger p-4">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}</div>`;
            }
        });
        // --- TALLY UPDATE END: GSTR-1 Button Logic ---
        
        
        // --- TALLY UPDATE START: GSTR-2 Button Logic ---
        document.getElementById('fetch-gstr2-report-btn').addEventListener('click', async () => {
            const startDate = document.getElementById('gst-report-start-date').value;
            const endDate = document.getElementById('gst-report-end-date').value;
            if (!startDate || !endDate) return showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', '‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§', 'warning');
            
            const gstr2ContentEl = document.getElementById('gstr2-report-content');
            const mainGstTitleEl = document.getElementById('gst-report-title'); // ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§ü‡§æ‡§á‡§ü‡§≤
            
            if(mainGstTitleEl) mainGstTitleEl.innerText = "GSTR-2 (‡§ñ‡§∞‡•Ä‡§¶) ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...)";
            gstr2ContentEl.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-warning" role="status"><span class="visually-hidden">Loading...</span></div></div>';

            // GSTR-2 ‡§ü‡•à‡§¨ ‡§ï‡•ã ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§∞‡•á‡§Ç
            new bootstrap.Tab(document.getElementById('gst-gstr2-tab')).show();

            try {
                const res = await fetchApi(`/api/reports/gstr2?startDate=${startDate}&endDate=${endDate}`, { method: 'GET' });
                if (!res.success) throw new Error(res.message || 'GSTR-2 ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§≤‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§');
                
                if(mainGstTitleEl) mainGstTitleEl.innerText = `GSTR-2 (‡§ñ‡§∞‡•Ä‡§¶) ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (${startDate} ‡§∏‡•á ${endDate})`;
                const report = res.report;
                let tableHtml = '';

                // B2B Purchases Table
                tableHtml += '<h6>B2B (‡§™‡§Ç‡§ú‡•Ä‡§ï‡•É‡§§ ‡§∏‡§™‡•ç‡§≤‡§æ‡§Ø‡§∞ ‡§∏‡•á ‡§ñ‡§∞‡•Ä‡§¶)</h6>';
                if (report.b2b_purchases && report.b2b_purchases.length > 0) {
                    tableHtml += '<table class="table gst-report-table"><thead><tr><th class="text-left">‡§∏‡§™‡•ç‡§≤‡§æ‡§Ø‡§∞</th><th>‡§¨‡§ø‡§≤ ‡§®‡§Ç.</th><th>‡§§‡§æ‡§∞‡•Ä‡§ñ</th><th>‡§ü‡•à‡§ï‡•ç‡§∏‡•á‡§¨‡§≤ ‡§µ‡•à‡§≤‡•ç‡§Ø‡•Ç (‚Çπ)</th><th>IGST (‚Çπ)</th><th>CGST (‚Çπ)</th><th>SGST (‚Çπ)</th></tr></thead><tbody>';
                    report.b2b_purchases.forEach(item => {
                        const details = item.gst_details || {}; // Get the JSONB data
                        tableHtml += `
                            <tr>
                                <td class="text-left">${item.supplier_name}</td>
                                <td class="text-center">${details.invoice_number || item.id}</td>
                                <td class="text-center">${new Date(item.created_at).toLocaleDateString()}</td>
                                <td>${formatCurrency(details.taxable_value)}</td>
                                <td>${formatCurrency(details.igst)}</td>
                                <td>${formatCurrency(details.cgst)}</td>
                                <td>${formatCurrency(details.sgst)}</td>
                            </tr>
                        `;
                    });
                    tableHtml += '</tbody></table>';
                } else {
                    tableHtml += '<p class="text-muted">‡§á‡§∏ ‡§Ö‡§µ‡§ß‡§ø ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à GST ‡§µ‡§æ‡§≤‡•Ä ‡§ñ‡§∞‡•Ä‡§¶ ‡§¶‡§∞‡•ç‡§ú ‡§®‡§π‡•Ä‡§Ç ‡§ï‡•Ä ‡§ó‡§à‡•§ (‡§ï‡•É‡§™‡§Ø‡§æ \'‡§ñ‡§∞‡•Ä‡§¶\' ‡§∏‡•á‡§ï‡•ç‡§∂‡§® ‡§Æ‡•á‡§Ç GST Details ‡§ú‡•ã‡§°‡§º‡•á‡§Ç)</p>';
                }

                // ITC Summary Table
                tableHtml += '<h6 class="mt-4">‡§á‡§®‡§™‡•Å‡§ü ‡§ü‡•à‡§ï‡•ç‡§∏ ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü (ITC) ‡§∏‡§Æ‡§∞‡•Ä</h6>';
                const itc = report.itc_summary || {};
                const totalTaxable = parseFloat(itc.total_taxable_value) || 0;
                const totalIgst = parseFloat(itc.total_igst) || 0;
                const totalCgst = parseFloat(itc.total_cgst) || 0;
                const totalSgst = parseFloat(itc.total_sgst) || 0;
                
                tableHtml += '<table class="table gst-report-table"><thead><tr><th class="text-left">‡§µ‡§ø‡§µ‡§∞‡§£</th><th>‡§ü‡•à‡§ï‡•ç‡§∏‡•á‡§¨‡§≤ ‡§µ‡•à‡§≤‡•ç‡§Ø‡•Ç (‚Çπ)</th><th>IGST (‚Çπ)</th><th>CGST (‚Çπ)</th><th>SGST (‚Çπ)</th></tr></thead><tbody>';
                tableHtml += `
                    <tr class="subtotal-row">
                        <td class="text-left">‡§ï‡•Å‡§≤ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ITC</td>
                        <td>${formatCurrency(totalTaxable)}</td>
                        <td>${formatCurrency(totalIgst)}</td>
                        <td>${formatCurrency(totalCgst)}</td>
                        <td>${formatCurrency(totalSgst)}</td>
                    </tr>
                `;
                tableHtml += '</tbody></table>';
                
                gstr2ContentEl.innerHTML = tableHtml;

            } catch (e) {
                if(mainGstTitleEl) mainGstTitleEl.innerText = "GSTR-2 ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü";
                gstr2ContentEl.innerHTML = `<div class="text-danger p-4">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}</div>`;
            }
        });
        // --- TALLY UPDATE END: GSTR-2 Button Logic ---


        // --- TALLY UPDATE START: GSTR-3B Button Logic ---
        document.getElementById('fetch-gstr3b-report-btn').addEventListener('click', async () => {
            const startDate = document.getElementById('gst-report-start-date').value;
            const endDate = document.getElementById('gst-report-end-date').value;
            if (!startDate || !endDate) return showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', '‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§', 'warning');

            const gstr3bContentEl = document.getElementById('gstr3b-report-content');
            const mainGstTitleEl = document.getElementById('gst-report-title'); // ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§ü‡§æ‡§á‡§ü‡§≤
            
            if(mainGstTitleEl) mainGstTitleEl.innerText = "GSTR-3B (‡§∏‡§Æ‡§∞‡•Ä) ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...)";
            gstr3bContentEl.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

            // GSTR-3B ‡§ü‡•à‡§¨ ‡§ï‡•ã ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§∞‡•á‡§Ç
            new bootstrap.Tab(document.getElementById('gst-gstr3b-tab')).show();

            try {
                const res = await fetchApi(`/api/reports/gstr3b?startDate=${startDate}&endDate=${endDate}`, { method: 'GET' });
                if (!res.success) throw new Error(res.message || 'GSTR-3B ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§≤‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§');
                
                if(mainGstTitleEl) mainGstTitleEl.innerText = `GSTR-3B (‡§∏‡§Æ‡§∞‡•Ä) ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (${startDate} ‡§∏‡•á ${endDate})`;
                const report = res.report;
                let tableHtml = '';

                // Table 3.1: Outward Supplies (Sales)
                tableHtml += '<h6>3.1: ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§î‡§∞ ‡§ü‡•à‡§ï‡•ç‡§∏ (Outward Supplies)</h6>';
                tableHtml += '<table class="table gst-report-table"><thead><tr><th class="text-left">‡§µ‡§ø‡§µ‡§∞‡§£</th><th>‡§ü‡•à‡§ï‡•ç‡§∏‡•á‡§¨‡§≤ ‡§µ‡•à‡§≤‡•ç‡§Ø‡•Ç (‚Çπ)</th><th>IGST (‚Çπ)</th><th>CGST (‚Çπ)</th><th>SGST (‚Çπ)</th></tr></thead><tbody>';
                tableHtml += `
                    <tr class="subtotal-row">
                        <td class="text-left">(a) ‡§ü‡•à‡§ï‡•ç‡§∏‡•á‡§¨‡§≤ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä</td>
                        <td>${formatCurrency(report.outward_supplies.taxable_value)}</td>
                        <td>${formatCurrency(report.outward_supplies.igst)}</td>
                        <td>${formatCurrency(report.outward_supplies.cgst)}</td>
                        <td>${formatCurrency(report.outward_supplies.sgst)}</td>
                    </tr>
                `;
                tableHtml += '</tbody></table>';

                // Table 4: Eligible ITC (Purchases)
                tableHtml += '<h6 class="mt-4">4: ‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§á‡§®‡§™‡•Å‡§ü ‡§ü‡•à‡§ï‡•ç‡§∏ ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü (ITC)</h6>';
                tableHtml += '<table class="table gst-report-table"><thead><tr><th class="text-left">‡§µ‡§ø‡§µ‡§∞‡§£</th><th>IGST (‚Çπ)</th><th>CGST (‚Çπ)</th><th>SGST (‚Çπ)</th></tr></thead><tbody>';
                tableHtml += `
                    <tr>
                        <td class="text-left">(A) (5) ‡§∏‡§≠‡•Ä ‡§Ö‡§®‡•ç‡§Ø ITC (B2B ‡§ñ‡§∞‡•Ä‡§¶)</td>
                        <td>${formatCurrency(report.inward_supplies_itc.igst)}</td>
                        <td>${formatCurrency(report.inward_supplies_itc.cgst)}</td>
                        <td>${formatCurrency(report.inward_supplies_itc.sgst)}</td>
                    </tr>
                    <tr class="subtotal-row">
                        <td class="text-left">(D) ‡§ï‡•Å‡§≤ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ITC (A)</td>
                        <td>${formatCurrency(report.inward_supplies_itc.igst)}</td>
                        <td>${formatCurrency(report.inward_supplies_itc.cgst)}</td>
                        <td>${formatCurrency(report.inward_supplies_itc.sgst)}</td>
                    </tr>
                `;
                tableHtml += '</tbody></table>';

                // Table 6.1: Payment of Tax (Net Tax)
                tableHtml += '<h6 class="mt-4">6.1: ‡§ü‡•à‡§ï‡•ç‡§∏ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® (Net Tax Payable)</h6>';
                tableHtml += '<table class="table gst-report-table"><thead><tr><th class="text-left">‡§µ‡§ø‡§µ‡§∞‡§£</th><th>IGST (‚Çπ)</th><th>CGST (‚Çπ)</th><th>SGST (‚Çπ)</th><th>‡§ï‡•Å‡§≤ ‡§¶‡•á‡§Ø ‡§ü‡•à‡§ï‡•ç‡§∏ (‚Çπ)</th></tr></thead><tbody>';
                tableHtml += `
                    <tr class="subtotal-row">
                        <td class="text-left">‡§ï‡•Å‡§≤ ‡§¶‡•á‡§Ø ‡§ü‡•à‡§ï‡•ç‡§∏ (‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä - ‡§ñ‡§∞‡•Ä‡§¶)</td>
                        <td>${formatCurrency(report.net_tax_payable.igst)}</td>
                        <td>${formatCurrency(report.net_tax_payable.cgst)}</td>
                        <td>${formatCurrency(report.net_tax_payable.sgst)}</td>
                        <td>${formatCurrency(report.net_tax_payable.total)}</td>
                    </tr>
                `;
                tableHtml += '</tbody></table>';

                gstr3bContentEl.innerHTML = tableHtml;

            } catch (e) {
                if(mainGstTitleEl) mainGstTitleEl.innerText = "GSTR-3B ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü";
                gstr3bContentEl.innerHTML = `<div class="text-danger p-4">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}</div>`;
            }
        });
        // --- TALLY UPDATE END: GSTR-3B Button Logic ---

        
        // Daily Closing Button
        document.getElementById('run-daily-closing-btn').addEventListener('click', async () => {
            if (!confirm('‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§Ü‡§ú ‡§ï‡•Ä ‡§ï‡•ç‡§≤‡•ã‡§ú‡§ø‡§Ç‡§ó ‡§∞‡§® ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§Ø‡§π ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§è‡§ï ‡§¨‡§æ‡§∞ ‡§π‡•Ä ‡§ï‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡•§')) return;
            const msgEl = document.getElementById('closing-message');
            msgEl.className = 'mt-3 alert alert-info';
            msgEl.innerText = '‡§ï‡•ç‡§≤‡•ã‡§ú‡§ø‡§Ç‡§ó ‡§∞‡§® ‡§ï‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à...';
            try {
                const res = await fetchApi('/api/closing/run', { method: 'POST' });
                if (res.success) {
                    msgEl.className = 'mt-3 alert alert-success';
                    msgEl.innerText = res.message;
                    fetchAndRenderClosingReports(); // Refresh the list
                } else {
                    throw new Error(res.message);
                }
            } catch (e) {
                msgEl.className = 'mt-3 alert alert-danger';
                msgEl.innerText = `‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}`;
            }
        });
        
        // Backup Buttons
        document.getElementById('download-json-backup-btn').addEventListener('click', () => handleBackupDownloads('json'));
        document.getElementById('download-excel-backup-btn').addEventListener('click', () => handleBackupDownloads('excel'));
        document.getElementById('download-product-sales-csv-btn').addEventListener('click', () => handleBackupDownloads('csv'));
        
        // Shop Settings Forms
        document.getElementById('company-profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                legal_name: document.getElementById('company-legal-name').value,
                gstin: document.getElementById('company-gstin').value,
                address: document.getElementById('company-address').value,
                // üöÄ FIX: ‡§™‡•Ç‡§Ç‡§ú‡•Ä ‡§°‡•á‡§ü‡§æ ‡§Ø‡§π‡§æ‡§Å ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ
                opening_capital: document.getElementById('company-opening-capital').value 
            };
            try {
                const res = await fetchApi('/api/shop/company-profile', { method: 'POST', body: data });
                showMessage('‡§∏‡§´‡§≤‡§§‡§æ', res.message, 'success');
            } catch (err) { showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', err.message, 'danger'); }
        });
        
        let shopLogoBase64 = null; // Store logo data
        document.getElementById('shop-logo-upload').addEventListener('change', (e) => {
             const file = e.target.files[0];
             if (!file) return;
             const reader = new FileReader();
             reader.onload = (event) => {
                 shopLogoBase64 = event.target.result;
                 document.getElementById('shop-logo-preview').src = shopLogoBase64;
                 document.getElementById('shop-logo-preview').style.display = 'block';
                 document.getElementById('remove-shop-logo-btn').classList.remove('d-none');
             };
             reader.readAsDataURL(file);
        });
        
       // ... (‡§¨‡§æ‡§ï‡•Ä ‡§ï‡•ã‡§°)
  // ... (‡§≤‡§æ‡§á‡§® 2244 ‡§ï‡•á ‡§Ü‡§∏‡§™‡§æ‡§∏)

  document.getElementById('shop-display-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            shop_name: document.getElementById('shop-display-name').value,
            shop_logo: shopLogoBase64 || AppState.user.shopLogo // Send new logo or old one
        };
        try {
            const res = await fetchApi('/api/shop/settings', { method: 'POST', body: data });
            if (res.success) {
                // CRITICAL: Update token and user data with new shop name/logo
                saveAuthData(res.token, res.user);
                
                // üöÄ FIX: ‡§á‡§Æ‡•á‡§ú ‡§ï‡•ã Local Storage ‡§Æ‡•á‡§Ç ‡§≠‡•Ä ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç (‡§∏‡§´‡§≤‡§§‡§æ ‡§™‡§∞)
                if (res.user.shopLogo) {
                    localStorage.setItem('shopLogoData', res.user.shopLogo);
                } else {
                    localStorage.removeItem('shopLogoData');
                }
                
                showMessage('‡§∏‡§´‡§≤‡§§‡§æ', res.message, 'success');
            } else {
                // üöÄ FIX: ‡§Ø‡§¶‡§ø ‡§∏‡§∞‡•ç‡§µ‡§∞ 500 ‡§è‡§∞‡§∞ ‡§¶‡•á, ‡§§‡•ã ‡§≠‡•Ä ‡§≤‡•ã‡§ï‡§≤ ‡§∏‡•ç‡§ü‡•ã‡§∞‡•á‡§ú ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç (FallBack)
                if (shopLogoBase64) {
                     localStorage.setItem('shopLogoData', shopLogoBase64);
                     // Note: We don't call saveAuthData because the server update failed
                     showMessage('‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä', '‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§ü‡§æ‡§á‡§Æ‡§Ü‡§â‡§ü ‡§π‡•Å‡§Ü‡•§ ‡§≤‡•ã‡§ó‡•ã ‡§≤‡•ã‡§ï‡§≤ (Local) ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à, ‡§≤‡•á‡§ï‡§ø‡§® ‡§Ö‡§®‡•ç‡§Ø ‡§Ø‡•Ç‡§ú‡§º‡§∞‡•ç‡§∏ ‡§ï‡•ã ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§π ‡§Ö‡§≠‡•Ä ‡§≠‡•Ä ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à‡•§', 'warning');
                } else {
                    throw new Error(res.message);
                }
            }
        } catch (err) { 
             // ‡§Ø‡§¶‡§ø Fetch API ‡§π‡•Ä ‡§µ‡§ø‡§´‡§≤ ‡§π‡•ã ‡§ú‡§æ‡§§‡§æ ‡§π‡•à
             showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', err.message, 'danger');
        }
    });

// ... (‡§¨‡§æ‡§ï‡•Ä ‡§ï‡•ã‡§°)

// Staff Form Listeners
const addStaffForm = document.getElementById('add-staff-form');
        if (addStaffForm && !addStaffForm.dataset.initialized) {
            addStaffForm.dataset.initialized = 'true';
            addStaffForm.addEventListener('submit', handleAddStaff);
        }
        const editStaffForm = document.getElementById('edit-staff-form');
         if (editStaffForm && !editStaffForm.dataset.initialized) {
            editStaffForm.dataset.initialized = 'true';
            editStaffForm.addEventListener('submit', handleUpdateStaff);
        }

    }

// üöÄüöÄüöÄ ‡§¨‡•à‡§Ç‡§ï ‡§∞‡§ø‡§ï‡•â‡§®‡•ç‡§∏‡§ø‡§≤‡•á‡§∂‡§® ‡§≤‡§ø‡§∏‡•ç‡§®‡§∞ ‡§Ø‡§π‡§æ‡§Å ‡§ú‡•ã‡§°‡§º‡•á‡§Ç üöÄüöÄüöÄ
document.getElementById('reconciliation-start-form').addEventListener('submit', handleStatementUpload);
        document.getElementById('save-reconciliation-btn').addEventListener('click', saveReconciliationReport);
        document.getElementById('cancel-reconciliation-btn').addEventListener('click', () => {
            if(confirm('‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§∞‡§ø‡§ï‡•â‡§®‡•ç‡§∏‡§ø‡§≤‡•á‡§∂‡§® ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?')) {
                renderView('bank-reconciliation'); // ‡§™‡•á‡§ú ‡§ï‡•ã ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
            }
        });
        // üöÄüöÄüöÄ ‡§ï‡•ã‡§° ‡§Ø‡§π‡§æ‡§Å ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã‡§§‡§æ ‡§π‡•à üöÄüöÄüöÄ



// ==============================================
// üöÄ ‡§¨‡•à‡§Ç‡§ï ‡§∞‡§ø‡§ï‡•â‡§®‡•ç‡§∏‡§ø‡§≤‡•á‡§∂‡§® ‡§≤‡•â‡§ú‡§ø‡§ï ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§Ç‡§∏
// ==============================================

/**
 * ‡§ö‡§∞‡§£ 1: ‡§¨‡•à‡§Ç‡§ï ‡§∏‡•ç‡§ü‡•á‡§ü‡§Æ‡•á‡§Ç‡§ü CSV ‡§ï‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§î‡§∞ ‡§™‡§æ‡§∞‡•ç‡§∏ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
 */
/**
 * ‡§ö‡§∞‡§£ 1: ‡§¨‡•à‡§Ç‡§ï ‡§∏‡•ç‡§ü‡•á‡§ü‡§Æ‡•á‡§Ç‡§ü CSV ‡§ï‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§î‡§∞ ‡§™‡§æ‡§∞‡•ç‡§∏ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
 */
 async function handleStatementUpload(event) {
    event.preventDefault();
    const btn = document.getElementById('start-reconciliation-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ‡§Ö‡§™‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...';

    // 1. ‡§´‡•â‡§∞‡•ç‡§Æ ‡§°‡•á‡§ü‡§æ ‡§á‡§ï‡§ü‡•ç‡§†‡§æ ‡§ï‡§∞‡•á‡§Ç
    const statementFile = document.getElementById('recon-statement-csv').files[0];
    const statementDate = document.getElementById('recon-statement-date').value;
    const statementBalance = parseFloat(document.getElementById('recon-statement-balance').value);

    if (!statementFile) {
        showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', '‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï CSV ‡§´‡§º‡§æ‡§á‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§', 'danger');
        btn.disabled = false; btn.innerHTML = '<i class="fas fa-play me-2"></i> ‡§∞‡§ø‡§ï‡•â‡§®‡•ç‡§∏‡§ø‡§≤‡•á‡§∂‡§® ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç';
        return;
    }

    try {
        // 2. CSV ‡§´‡§º‡§æ‡§á‡§≤ ‡§ï‡•ã ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§™‡§¢‡§º‡•á‡§Ç
        const csvText = await statementFile.text();
        
        // 3. ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•ã JSON ‡§Æ‡•á‡§Ç ‡§™‡§æ‡§∞‡•ç‡§∏ ‡§ï‡§∞‡•á‡§Ç
        const statementItems = parseCSV(csvText);

        if (!statementItems || statementItems.length === 0) {
            throw new Error('CSV ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•à ‡§Ø‡§æ ‡§™‡§æ‡§∞‡•ç‡§∏ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§æ‡•§');
        }

        // 4. ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§®‡§è API ‡§è‡§Ç‡§°‡§™‡•â‡§á‡§Ç‡§ü ‡§™‡§∞ ‡§≠‡•á‡§ú‡•á‡§Ç
        const res = await fetchApi('/api/reconciliation/upload-statement', {
            method: 'POST',
            body: {
                statementDate,
                statementBalance,
                statementItems
            }
        }, '‡§ü‡•ç‡§∞‡§æ‡§Ç‡§ú‡•à‡§ï‡•ç‡§∂‡§® ‡§ï‡§æ ‡§Æ‡§ø‡§≤‡§æ‡§® ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...');

        if (res.success) {
            // 5. UI ‡§ï‡•ã "‡§Æ‡•à‡§ö‡§ø‡§Ç‡§ó" ‡§Æ‡•ã‡§° ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤‡•á‡§Ç
            document.getElementById('reconciliation-setup').classList.add('hidden');
            document.getElementById('reconciliation-matching-area').classList.remove('hidden');
            
            // 6. ‡§Æ‡•à‡§ö‡§ø‡§Ç‡§ó ‡§ü‡•á‡§¨‡§≤ ‡§∞‡•á‡§Ç‡§°‡§∞ ‡§ï‡§∞‡•á‡§Ç
            renderReconciliationTables(res.bookItems, res.bankItems, statementBalance);
            showMessage('‡§∏‡§´‡§≤‡§§‡§æ', '‡§∏‡•ç‡§ü‡•á‡§ü‡§Æ‡•á‡§Ç‡§ü ‡§Ö‡§™‡§≤‡•ã‡§° ‡§π‡•Å‡§Ü‡•§ ‡§Ö‡§¨ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä‡§ú‡§º ‡§ï‡§æ ‡§Æ‡§ø‡§≤‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç‡•§', 'success');
        } else {
            throw new Error(res.message);
        }

    } catch (e) {
        showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§Ö‡§™‡§≤‡•ã‡§° ‡§µ‡§ø‡§´‡§≤: ${e.message}`, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-play me-2"></i> ‡§∞‡§ø‡§ï‡•â‡§®‡•ç‡§∏‡§ø‡§≤‡•á‡§∂‡§® ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç';
    }
}


 /**
 * ‡§ö‡§∞‡§£ 2: ‡§¨‡•Å‡§ï ‡§î‡§∞ ‡§¨‡•à‡§Ç‡§ï ‡§ü‡•ç‡§∞‡§æ‡§Ç‡§ú‡•à‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã ‡§≤‡§æ‡§§‡§æ ‡§π‡•à ‡§î‡§∞ ‡§ü‡•á‡§¨‡§≤ ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ñ‡§æ‡§§‡§æ ‡§π‡•à
 * (‡§á‡§µ‡•á‡§Ç‡§ü ‡§≤‡§ø‡§∏‡•ç‡§®‡§∞ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§´‡§ø‡§ï‡•ç‡§∏‡•ç‡§°)
 */
function renderReconciliationTables(bookItems, bankItems, statementBalance) {
    const bookBody = document.getElementById('book-transactions-body');  
    const bankBody = document.getElementById('bank-transactions-body'); 
    bookBody.innerHTML = '';
    bankBody.innerHTML = '';

    let bookTotal = 0;
    let bankTotal = 0;

    // Dukan Pro (‡§¨‡•Å‡§ï) ‡§Ü‡§á‡§ü‡§Æ‡•ç‡§∏ ‡§ï‡•ã ‡§≠‡§∞‡•á‡§Ç
    bookItems.forEach(item => {
        bookTotal += parseFloat(item.amount);
        bookBody.innerHTML += `
            <tr data-id="${item.type}-${item.id}" data-amount="${item.amount}">
                <td><input type="checkbox" class="recon-check-book"></td>
                <td>
                    ${item.description}
                    <small class="d-block text-muted">${new Date(item.date).toLocaleDateString()}</small>
                </td>
                <td>${formatCurrency(item.amount)}</td>
            </tr>
        `;
    });

    // ‡§¨‡•à‡§Ç‡§ï ‡§∏‡•ç‡§ü‡•á‡§ü‡§Æ‡•á‡§Ç‡§ü ‡§Ü‡§á‡§ü‡§Æ‡•ç‡§∏ ‡§ï‡•ã ‡§≠‡§∞‡•á‡§Ç
    bankItems.forEach(item => {
        bankTotal += parseFloat(item.amount);
        bankBody.innerHTML += `
            <tr data-id="${item.id}" data-amount="${item.amount}">
                <td><input type="checkbox" class="recon-check-bank"></td>
                <td>
                    ${item.description}
                    <small class="d-block text-muted">${new Date(item.date).toLocaleDateString()}</small>
                </td>
                <td>${formatCurrency(item.amount)}</td>
            </tr>
        `;
    });

    // ‡§ü‡•ã‡§ü‡§≤‡•ç‡§∏ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
    document.getElementById('book-total').innerText = formatCurrency(bookTotal);  
    document.getElementById('bank-total').innerText = formatCurrency(bankTotal);  
    
    // ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§∏‡•ç‡§ü‡•á‡§ü‡§Æ‡•á‡§Ç‡§ü ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
    document.getElementById('report-statement-balance').innerText = formatCurrency(statementBalance);  
    
    // üöÄüöÄüöÄ ‡§Ø‡§π ‡§®‡§Ø‡§æ ‡§ï‡•ã‡§° ‡§π‡•à (‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞) üöÄüöÄüöÄ
    // ‡§∏‡§≠‡•Ä ‡§ö‡•á‡§ï‡§¨‡•â‡§ï‡•ç‡§∏ ‡§Æ‡•á‡§Ç 'change' ‡§á‡§µ‡•á‡§Ç‡§ü ‡§≤‡§ø‡§∏‡•ç‡§®‡§∞ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
    const allCheckboxes = document.querySelectorAll('.recon-check-book, .recon-check-bank, #check-all-book, #check-all-bank'); 
    allCheckboxes.forEach(cb => {
        cb.addEventListener('change', () => {
            // 'Select All' ‡§≤‡•â‡§ú‡§ø‡§ï
            if (cb.id === 'check-all-book') {  
                document.querySelectorAll('.recon-check-book').forEach(bookCb => bookCb.checked = cb.checked);  
            }
            if (cb.id === 'check-all-bank') {  
                document.querySelectorAll('.recon-check-bank').forEach(bankCb => bankCb.checked = cb.checked);  
            }
            
            // ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ó‡§£‡§®‡§æ ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã ‡§ï‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç
            calculateReconciliation();
        });
    });
    
    // ‡§™‡§π‡§≤‡•Ä ‡§¨‡§æ‡§∞ ‡§ó‡§£‡§®‡§æ (Calculate) ‡§ö‡§≤‡§æ‡§è‡§Å
    calculateReconciliation();
    // üöÄüöÄüöÄ ‡§®‡§Ø‡§æ ‡§ï‡•ã‡§° ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ üöÄüöÄüöÄ
}
/**
 * ‡§ö‡§∞‡§£ 3: ‡§Æ‡§ø‡§≤‡§æ‡§® ‡§ï‡•Ä ‡§ó‡§à ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä‡§ú‡§º ‡§î‡§∞ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡•ã ‡§∏‡•á‡§µ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
 */
/**
 * ‡§ö‡§∞‡§£ 3: ‡§Æ‡§ø‡§≤‡§æ‡§® ‡§ï‡•Ä ‡§ó‡§à ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä‡§ú‡§º ‡§î‡§∞ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡•ã ‡§∏‡•á‡§µ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
 */
 async function saveReconciliationReport() {
    const btn = document.getElementById('save-reconciliation-btn');  
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ‡§∏‡•á‡§µ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...';

    try {
        // 1. ‡§ö‡•á‡§ï‡•ç‡§° (matched) ‡§¨‡•à‡§Ç‡§ï IDs ‡§á‡§ï‡§ü‡•ç‡§†‡§æ ‡§ï‡§∞‡•á‡§Ç
        const reconciledBankIds = [];
        document.querySelectorAll('.recon-check-bank:checked').forEach(cb => {  
            reconciledBankIds.push(cb.closest('tr').dataset.id);
        });

        // 2. ‡§ö‡•á‡§ï‡•ç‡§° (matched) ‡§¨‡•Å‡§ï Items ‡§á‡§ï‡§ü‡•ç‡§†‡§æ ‡§ï‡§∞‡•á‡§Ç
        const reconciledBookItems = [];
        document.querySelectorAll('.recon-check-book:checked').forEach(cb => {  
            const idParts = cb.closest('tr').dataset.id.split('-'); // ‡§ú‡•à‡§∏‡•á "invoice-123"
            reconciledBookItems.push({
                type: idParts[0],
                id: parseInt(idParts[1])
            });
        });
        
        // 3. ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§æ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ (Summary) ‡§á‡§ï‡§ü‡•ç‡§†‡§æ ‡§ï‡§∞‡•á‡§Ç 
        const unclearedPaymentsAmount = parseFloat(document.getElementById('report-uncleared-payments').innerText.replace(/[^0-9.-]/g, '')); 
        const unclearedDepositsAmount = parseFloat(document.getElementById('report-uncleared-deposits').innerText.replace(/[^0-9.-]/g, '')); 
        
        const reportData = {
             clearedPayments: 0, // (‡§Ø‡§π ‡§Ö‡§≠‡•Ä ‡§ü‡•ç‡§∞‡•à‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à, 0 ‡§≠‡•á‡§ú‡•á‡§Ç)
             clearedDeposits: 0, // (‡§Ø‡§π ‡§Ö‡§≠‡•Ä ‡§ü‡•ç‡§∞‡•à‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à, 0 ‡§≠‡•á‡§ú‡•á‡§Ç)
             unclearedCount: document.querySelectorAll('.recon-check-book:not(:checked)').length,  
             unclearedTotal: unclearedPaymentsAmount + unclearedDepositsAmount
        };

        // 4. ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§°‡•á‡§ü‡§æ ‡§á‡§ï‡§ü‡•ç‡§†‡§æ ‡§ï‡§∞‡•á‡§Ç
        const dataToSend = {
            statementEndDate: document.getElementById('recon-statement-date').value,  
            statementEndBalance: parseFloat(document.getElementById('report-statement-balance').innerText.replace(/[^0-9.-]/g, '')),  
            reportSummary: reportData,
            reconciledBankIds: reconciledBankIds,
            reconciledBookItems: reconciledBookItems
        };

        // 5. ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§™‡§∞ ‡§≠‡•á‡§ú‡•á‡§Ç
        const res = await fetchApi('/api/reconciliation/save', {
            method: 'POST',
            body: dataToSend
        }, '‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡•á‡§µ ‡§ï‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à...');

        if (res.success) {
            showMessage('‡§∏‡§´‡§≤‡§§‡§æ', '‡§∞‡§ø‡§ï‡•â‡§®‡•ç‡§∏‡§ø‡§≤‡•á‡§∂‡§® ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡•á‡§µ ‡§ï‡•Ä ‡§ó‡§à!', 'success');
            renderView('bank-reconciliation'); // ‡§∏‡§¨ ‡§ï‡•Å‡§õ ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
        } else {
            throw new Error(res.message);
        }

    } catch (e) {
        showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡•á‡§µ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${e.message}`, 'danger');
        btn.disabled = false; // ‡§¨‡§ü‡§® ‡§ï‡•ã ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§á‡§®‡•á‡§¨‡§≤ ‡§ï‡§∞‡•á‡§Ç
        btn.innerHTML = '<i class="fas fa-save me-2"></i> ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç';
    }
}


    /**
 * ‡§ö‡§∞‡§£ 4: ‡§™‡§ø‡§õ‡§≤‡•Ä ‡§∏‡•á‡§µ ‡§ï‡•Ä ‡§ó‡§à ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏ ‡§ï‡•ã ‡§≤‡§æ‡§§‡§æ ‡§π‡•à ‡§î‡§∞ ‡§ü‡•á‡§¨‡§≤ ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ñ‡§æ‡§§‡§æ ‡§π‡•à
 */
async function fetchAndRenderSavedReports() {
    const tableBody = document.getElementById('previous-reports-body');
    tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à‡§Ç...</td></tr>`;

    try {
        const res = await fetchApi('/api/reconciliation/reports', { method: 'GET' }, null); // ‡§≤‡•ã‡§°‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å

        if (res.success && res.reports.length > 0) {
            tableBody.innerHTML = res.reports.map(report => `
                <tr>
                    <td>REP-${report.id}</td>
                    <td>${new Date(report.statement_end_date).toLocaleDateString()}</td>
                    <td>${formatCurrency(report.statement_end_balance)}</td>
                    <td class="${parseFloat(report.uncleared_items_total) !== 0 ? 'text-danger' : ''}">
                        ${formatCurrency(report.uncleared_items_total)}
                    </td>
                    <td>${new Date(report.reconciled_at).toLocaleString()}</td>
                </tr>
            `).join('');
        } else {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">‡§ï‡•ã‡§à ‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§</td></tr>`;
        }
    } catch (e) {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}</td></tr>`;
    }
}
    /**
     * Main startup logic
     */
    // ==========================================================
// ========== 1. LICENSE CHECK & APP LOCK LOGIC ==========
// ==========================================================

/**
 * Main startup logic - MODIFIED
 */
// [ ‡§Ø‡§π ‡§∞‡§π‡§æ ‡§®‡§Ø‡§æ ‡§î‡§∞ ‡§∏‡§π‡•Ä DOMContentLoaded - ‡§™‡•Å‡§∞‡§æ‡§®‡•á ‡§µ‡§æ‡§≤‡•á ‡§ï‡•ã ‡§π‡§ü‡§æ‡§ï‡§∞ ‡§á‡§∏‡•á ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç ]
// [ ‡§Ø‡§π ‡§∞‡§π‡§æ ‡§®‡§Ø‡§æ ‡§î‡§∞ ‡§∏‡§π‡•Ä DOMContentLoaded - ‡§™‡•Å‡§∞‡§æ‡§®‡•á ‡§µ‡§æ‡§≤‡•á ‡§ï‡•ã ‡§π‡§ü‡§æ‡§ï‡§∞ ‡§á‡§∏‡•á ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç ]
// [ ‡§Ø‡§π ‡§∞‡§π‡§æ ‡§®‡§Ø‡§æ ‡§î‡§∞ ‡§∏‡§π‡•Ä DOMContentLoaded - ‡§™‡•Å‡§∞‡§æ‡§®‡•á ‡§µ‡§æ‡§≤‡•á ‡§ï‡•ã ‡§π‡§ü‡§æ‡§ï‡§∞ ‡§á‡§∏‡•á ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç ]
document.addEventListener('DOMContentLoaded', () => {
    const licenseModalEl = document.getElementById('licenseModal');  
    const licenseModal = new bootstrap.Modal(licenseModalEl);
    
    // üöÄ ‡§´‡§ø‡§ï‡•ç‡§∏: ‡§∏‡§ø‡§∞‡•ç‡§´ ‡§®‡§è ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§ï‡•ã ‡§™‡§ï‡§°‡§º‡•á‡§Ç
    const newLoginContainer = document.getElementById('auth-container-new'); 
    
    // üöÄ ‡§´‡§ø‡§ï‡•ç‡§∏: ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§Ö‡§¨ ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§â‡§∏‡•á ‡§π‡§ü‡§æ ‡§¶‡•á‡§Ç
    // const oldLoginContainer = document.getElementById('auth-container'); 

    const token = localStorage.getItem('authToken');
    const user = JSON.parse(localStorage.getItem('authUser'));

    if (token && user) {
        console.log("‡§ü‡•ã‡§ï‡§® ‡§Æ‡§ø‡§≤‡§æ, ‡§≤‡•â‡§ó‡§ø‡§® ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§ï‡•Ä ‡§ú‡§æ‡§Å‡§ö ‡§ï‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à...");
        saveAuthData(token, user);
        startLicenseTimer(user.licenseExpiryDate);

        const expiryDate = user.licenseExpiryDate ? new Date(user.licenseExpiryDate) : null;
        const now = new Date();

        if (!expiryDate || expiryDate < now) {
            // --- üöÄ ‡§ï‡•á‡§∏ 1: ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§è‡§ï‡•ç‡§∏‡§™‡§æ‡§Ø‡§∞ ‡§π‡•à ---
            console.log("‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§Ø‡§æ ‡§ó‡•Å‡§Æ ‡§π‡•à‡•§ ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø‡§£ ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à‡•§");
            showMessage('‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï', '‡§Ü‡§™‡§ï‡§æ ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§∞‡•á‡§Ç‡•§', 'warning');

            // üöÄ ‡§´‡§ø‡§ï‡•ç‡§∏: ‡§®‡§Ø‡§æ ‡§≤‡•â‡§ó‡§ø‡§® ‡§™‡•á‡§ú (‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° ‡§ï‡•á ‡§≤‡§ø‡§è) ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
            if (newLoginContainer) newLoginContainer.classList.remove('hidden');

            // ‡§ê‡§™ ‡§ï‡•á ‡§π‡§ø‡§∏‡•ç‡§∏‡•á (‡§ú‡•à‡§∏‡•á ‡§∏‡§æ‡§á‡§°‡§¨‡§æ‡§∞) ‡§Ö‡§®‡§≤‡•â‡§ï ‡§ï‡§∞‡•á‡§Ç
            document.getElementById('sidebar').classList.remove('locked');
            document.getElementById('menu-toggle').classList.remove('locked');
            document.getElementById('main-content').classList.add('locked'); // ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü ‡§≤‡•â‡§ï ‡§∞‡§ñ‡•á‡§Ç
            applyRBAC(user.role);
            licenseModal.show(); // ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ Modal ‡§ï‡•ã ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° ‡§ï‡•á ‡§ä‡§™‡§∞ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å

        } else {
            // --- üöÄ ‡§ï‡•á‡§∏ 2: ‡§∏‡§¨ ‡§ï‡•Å‡§õ ‡§∏‡§π‡•Ä ‡§π‡•à (‡§ü‡•ã‡§ï‡§® ‡§î‡§∞ ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏) ---
            console.log("‡§ü‡•ã‡§ï‡§® ‡§î‡§∞ ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§π‡•à‡§Ç‡•§ ‡§ê‡§™ ‡§Ö‡§®‡§≤‡•â‡§ï ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à‡•§");
            
            // üöÄ ‡§´‡§ø‡§ï‡•ç‡§∏: ‡§®‡§Ø‡§æ ‡§≤‡•â‡§ó‡§ø‡§® ‡§™‡•á‡§ú ‡§õ‡§ø‡§™‡§æ‡§è‡§Å
            if (newLoginContainer) newLoginContainer.classList.add('hidden');
            
            unlockApplication(); // ‡§ê‡§™ ‡§ï‡•ã ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‡§Ö‡§®‡§≤‡•â‡§ï ‡§ï‡§∞‡•á‡§Ç
        }

    } else {
        // --- üöÄ ‡§ï‡•á‡§∏ 3: ‡§ï‡•ã‡§à ‡§ü‡•ã‡§ï‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ (‡§≤‡•â‡§ó‡§Ü‡§â‡§ü ‡§π‡•à) ---
        console.log("‡§ï‡•ã‡§à ‡§ü‡•ã‡§ï‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§ ‡§≤‡•â‡§ó‡§ø‡§® ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§¶‡§ø‡§ñ‡§æ ‡§∞‡§π‡§æ ‡§π‡•à‡•§");
        
        // üöÄ ‡§´‡§ø‡§ï‡•ç‡§∏: ‡§∏‡§ø‡§∞‡•ç‡§´ ‡§®‡§Ø‡§æ ‡§≤‡•â‡§ó‡§ø‡§® ‡§™‡•á‡§ú ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
        if (newLoginContainer) newLoginContainer.classList.remove('hidden');

        // ‡§ê‡§™ ‡§ï‡•á ‡§¨‡§æ‡§ï‡•Ä ‡§π‡§ø‡§∏‡•ç‡§∏‡•ã‡§Ç ‡§ï‡•ã ‡§≤‡•â‡§ï ‡§∞‡§ñ‡•á‡§Ç
        document.getElementById('sidebar').classList.add('locked');
        document.getElementById('main-content').classList.add('locked');
        document.getElementById('menu-toggle').classList.add('locked');
    }

    // --- ‡§¨‡§æ‡§ï‡•Ä ‡§ï‡•á ‡§∏‡§≠‡•Ä ‡§≤‡§ø‡§∏‡•ç‡§®‡§∞ (Event Listeners) ---
    
    // Login Form
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const msgEl = document.getElementById('login-message');
        const btn = document.getElementById('login-submit-btn');
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ‡§≤‡•â‡§ó ‡§á‡§® ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...`;

        try {
            const res = await fetch(__backend_url + '/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await res.json();
            if (!res.ok || !data.success) { throw new Error(data.message || '‡§≤‡•â‡§ó‡§ø‡§® ‡§µ‡§ø‡§´‡§≤'); }

            msgEl.innerText = '‡§∏‡§´‡§≤‡§§‡§æ! ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...';
            saveAuthData(data.token, data.user);
            startLicenseTimer(data.user.licenseExpiryDate);

            if (data.requiresLicense) {
                // üöÄ ‡§´‡§ø‡§ï‡•ç‡§∏: ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§è‡§ï‡•ç‡§∏‡§™‡§æ‡§Ø‡§∞ ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§∏‡§ø‡§∞‡•ç‡§´ Modal ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å (‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§π‡•Ä ‡§¶‡§ø‡§ñ ‡§∞‡§π‡§æ ‡§π‡•à)
                showMessage('‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï', data.message, 'warning');
                if (newLoginContainer) newLoginContainer.classList.remove('hidden'); // ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° ‡§¶‡§ø‡§ñ‡•á
                document.getElementById('sidebar').classList.remove('locked');
                document.getElementById('menu-toggle').classList.remove('locked');
                document.getElementById('main-content').classList.add('locked');
                applyRBAC(data.user.role);
                licenseModal.show();
            } else {
                unlockApplication(); // ‡§∏‡§¨ ‡§∏‡§π‡•Ä ‡§π‡•à, ‡§ê‡§™ ‡§Ö‡§®‡§≤‡•â‡§ï ‡§ï‡§∞‡•á‡§Ç
            }
        } catch (error) {
            msgEl.innerText = error.message;
        } finally {
            btn.disabled = false;
            btn.innerHTML = '‡§≤‡•â‡§ó‡§ø‡§®';
        }
    });

    // Registration Form
    document.getElementById('register-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const shopName = document.getElementById('register-shop-name').value;
        const name = document.getElementById('register-name').value;
        const email = document.getElementById('register-email').value;
        const mobile = document.getElementById('register-mobile').value;
        const password = document.getElementById('register-password').value;
        const msgEl = document.getElementById('register-message');
        const btn = document.getElementById('register-submit-btn');
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...`;

        try {
            const res = await fetch(__backend_url + '/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ shopName, name, email, mobile, password })
            });
            const data = await res.json();
            if (!res.ok || !data.success) { throw new Error(data.message || '‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•á‡§∂‡§® ‡§µ‡§ø‡§´‡§≤'); }

            msgEl.innerText = '‡§∏‡§´‡§≤‡§§‡§æ! ‡§ê‡§™ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...';
            saveAuthData(data.token, data.user);
            startLicenseTimer(data.user.licenseExpiryDate);
            showMessage('‡§∏‡§´‡§≤‡§§‡§æ!', '‡§Ü‡§™‡§ï‡§æ ‡§Ö‡§ï‡§æ‡§â‡§Ç‡§ü ‡§¨‡§® ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§∞‡•á‡§Ç‡•§', 'success');
            
            // üöÄ ‡§´‡§ø‡§ï‡•ç‡§∏: ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§≠‡•Ä ‡§®‡§Ø‡§æ ‡§≤‡•â‡§ó‡§ø‡§® ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
            if (newLoginContainer) newLoginContainer.classList.remove('hidden');
            document.getElementById('sidebar').classList.remove('locked');
            document.getElementById('menu-toggle').classList.remove('locked');
            document.getElementById('main-content').classList.add('locked');
            applyRBAC(data.user.role);
            licenseModal.show();

        } catch (error) {
            msgEl.innerText = error.message;
        } finally {
            btn.disabled = false;
            btn.innerHTML = '‡§Ö‡§ï‡§æ‡§â‡§Ç‡§ü ‡§¨‡§®‡§æ‡§è‡§Ç';
        }
    });

    // License Activation Form
    document.getElementById('license-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const key = document.getElementById("license-key-input").value.trim();
        const messageEl = document.getElementById("license-message");
        messageEl.innerText = '‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...';

        try {
           const res = await fetchApi('/api/activate-license', {
                method: 'POST',
                body: { licenseKey: key }
           }, '‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...');
            
            if (res.success) {
                saveAuthData(res.token, res.user);
                startLicenseTimer(res.user.licenseExpiryDate);
                licenseModal.hide();
                showMessage('‡§∏‡§´‡§≤‡§§‡§æ', res.message, 'success');
                unlockApplication(); // <<< ‡§Ö‡§¨ ‡§ê‡§™ ‡§ï‡•ã ‡§Ö‡§®‡§≤‡•â‡§ï ‡§ï‡§∞‡•á‡§Ç
            } else {
                throw new Error(res.message || '‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§Ø‡§æ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏‡•§');
            }
        } catch (err) {
            messageEl.innerText = '‚ùå ' + err.message;
        }
    });
    
    // --- ‡§¨‡§æ‡§ï‡•Ä ‡§ï‡•á ‡§∏‡§≠‡•Ä ‡§≤‡§ø‡§∏‡•ç‡§®‡§∞ ---
    document.getElementById('logout-btn').addEventListener('click', logout);
    document.querySelectorAll('#sidebar-nav .nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            renderView(link.getAttribute('data-view'));
            if (window.innerWidth < 992) document.getElementById('sidebar').classList.remove('active');
        });
    });
    document.getElementById('menu-toggle').addEventListener('click', () => {
         document.getElementById('sidebar').classList.toggle('active');
    });
    const posSearchInput = document.getElementById('pos-item-search');
    if (posSearchInput) {
        posSearchInput.addEventListener('input', () => handleItemSearch(false)); 
        posSearchInput.addEventListener('click', () => handleItemSearch(true)); 
        document.addEventListener('click', (e) => {
            if (e.target.id !== 'pos-item-search') {
                document.getElementById('pos-search-results').innerHTML = '';
            }
        });
    }
    updatePOSCartView(); 
    const expenseDateInput = document.getElementById('expense-date');
    if (expenseDateInput) {
        try {
            expenseDateInput.value = new Date().toISOString().split('T')[0];
        } catch(e) { console.error("Expense date set error", e); }
    }
    const barcodeInput = document.getElementById('barcode-scanner-input');
    barcodeInput.addEventListener('change', () => handleBarcodeScan(null));
    document.body.addEventListener('click', focusBarcodeScanner);

    // postMessage Listener
    window.addEventListener('message', function(event) {
        if (event.origin !== window.location.origin) return; 
        if (event.data) {
            const token = localStorage.getItem('authToken');
            const user = AppState.user || JSON.parse(localStorage.getItem('authUser'));
            const shopId = user ? user.shopId : null;
            const backendUrl = __backend_url;

            if (event.data.type === 'REQUEST_AUTH' && token) {
                if (window.scannerWindow && !window.scannerWindow.closed) {
                    window.scannerWindow.postMessage({
                        type: 'AUTH_TOKEN',
                        token: token,
                        shopId: shopId,
                        backendUrl: backendUrl
                    }, window.location.origin);
                }
            }
            if (event.data.type === 'SCANNED_SKU' && event.data.sku) {
                 addSKUToCart(event.data.sku);
            }
        }
    });
});
// [ ‡§®‡§Ø‡§æ DOMContentLoaded ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§Ø‡§π‡§æ‡§Å ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã‡§§‡§æ ‡§π‡•à ]

// [ ‡§®‡§Ø‡§æ DOMContentLoaded ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§Ø‡§π‡§æ‡§Å ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã‡§§‡§æ ‡§π‡•à ]// [ ‡§®‡§Ø‡§æ DOMContentLoaded ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§Ø‡§π‡§æ‡§Å ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã‡§§‡§æ ‡§π‡•à ]    // --- Registration Form Handler - MODIFIED ---
   // Registration Form Handler - MODIFIED to include mobile
document.getElementById('register-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    // --- Get form data ---
    const shopName = document.getElementById('register-shop-name').value;
    const name = document.getElementById('register-name').value;
    const email = document.getElementById('register-email').value;
    const mobile = document.getElementById('register-mobile').value; // <<< ‡§®‡§à ‡§≤‡§æ‡§á‡§® ‡§ú‡•ã‡§°‡§º‡•Ä ‡§ó‡§à
    const password = document.getElementById('register-password').value;
    // --- End get form data ---

    const msgEl = document.getElementById('register-message');
    const btn = document.getElementById('register-submit-btn');
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...`;

    try {
        const res = await fetch(__backend_url + '/api/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            // --- Include mobile in the body ---
            body: JSON.stringify({ shopName, name, email, mobile, password }) // <<< ‡§Ø‡§π‡§æ‡§Å mobile ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ
            // --- End include mobile ---
        });
        const data = await res.json();

        if (!res.ok || !data.success) {
            throw new Error(data.message || '‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•á‡§∂‡§® ‡§µ‡§ø‡§´‡§≤');
        }

        // ... (‡§¨‡§æ‡§ï‡•Ä ‡§ï‡§æ ‡§ï‡•ã‡§° success handling ‡§ï‡•á ‡§≤‡§ø‡§è) ...
        msgEl.innerText = '‡§∏‡§´‡§≤‡§§‡§æ! ‡§ê‡§™ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...';
        saveAuthData(data.token, data.user);
        startLicenseTimer(data.user.licenseExpiryDate);
        showMessage('‡§∏‡§´‡§≤‡§§‡§æ!', '‡§Ü‡§™‡§ï‡§æ ‡§Ö‡§ï‡§æ‡§â‡§Ç‡§ü ‡§¨‡§® ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§∞‡•á‡§Ç‡•§', 'success');
        document.getElementById('auth-container').classList.add('hidden');
        document.getElementById('sidebar').classList.remove('locked');
        document.getElementById('menu-toggle').classList.remove('locked');
        document.getElementById('main-content').classList.add('locked');
        applyRBAC(data.user.role);
        // Ensure licenseModal variable is accessible or get instance
        const licenseModalInstance = bootstrap.Modal.getInstance(document.getElementById('licenseModal')) || new bootstrap.Modal(document.getElementById('licenseModal'));
        licenseModalInstance.show();


    } catch (error) {
        msgEl.innerText = error.message;
    } finally {
        btn.disabled = false;
        btn.innerHTML = '‡§Ö‡§ï‡§æ‡§â‡§Ç‡§ü ‡§¨‡§®‡§æ‡§è‡§Ç';
    }
});
    // --- License Activation Form Handler - MODIFIED ---
    document.getElementById('license-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const key = document.getElementById("license-key-input").value.trim();
        const messageEl = document.getElementById("license-message");
        messageEl.innerText = '‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...';

        if (!key) { /* ... */ return; }

        try {
           // ‡§∏‡§π‡•Ä ‡§ï‡•ã‡§° (‡§á‡§∏‡•á ‡§¨‡§¶‡§≤‡•á‡§Ç):
const res = await fetchApi('/api/activate-license', {
    method: 'POST', // <<< ‡§Ø‡§π POST ‡§¨‡§§‡§æ‡§§‡§æ ‡§π‡•à
    // headers are handled by fetchApi, Content-Type will be added automatically for JSON
    body: { licenseKey: key } // <<< ‡§Ø‡§π ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ Key ‡§≠‡•á‡§ú‡§§‡§æ ‡§π‡•à (key ‡§µ‡•á‡§∞‡§ø‡§è‡§¨‡§≤ ‡§™‡§π‡§≤‡•á ‡§°‡§ø‡§´‡§æ‡§á‡§® ‡§π‡•à)
}, '‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...');
            if (res.success) {
                saveAuthData(res.token, res.user);
                startLicenseTimer(res.user.licenseExpiryDate);
                licenseModal.hide();
                showMessage('‡§∏‡§´‡§≤‡§§‡§æ', res.message, 'success');

                // --- MODIFIED: Unlock FULLY only AFTER successful activation ---
                unlockApplication(); // <<< UNLOCK HERE NOW
                // --- END MODIFIED ---

            } else {
                throw new Error(res.message || '‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§Ø‡§æ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏‡•§');
            }
        } catch (err) {
            messageEl.innerText = '‚ùå ' + err.message;
        }
    });

    // ... (rest of DOMContentLoaded listeners like logout, sidebar, etc.) ...


        // --- Setup Other Listeners ---
        
        // Logout Button
        document.getElementById('logout-btn').addEventListener('click', logout);

        // Remove old admin login button listener
             
        // Sidebar navigation
        document.querySelectorAll('#sidebar-nav .nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                renderView(link.getAttribute('data-view'));
                if (window.innerWidth < 992) document.getElementById('sidebar').classList.remove('active');
            });
        });

        // Mobile menu toggle
        document.getElementById('menu-toggle').addEventListener('click', () => {
             document.getElementById('sidebar').classList.toggle('active');
        });

        // POS Search (NEW: Added 'click' listener)
        const posSearchInput = document.getElementById('pos-item-search');
        if (posSearchInput) {
            posSearchInput.addEventListener('input', () => handleItemSearch(false)); 
            posSearchInput.addEventListener('click', () => handleItemSearch(true)); 
            // Hide results when clicking away
            document.addEventListener('click', (e) => {
                if (e.target.id !== 'pos-item-search') {
                    document.getElementById('pos-search-results').innerHTML = '';
                }
            });
        }
        updatePOSCartView(); 

        // Expense Date
        const expenseDateInput = document.getElementById('expense-date');
        if (expenseDateInput) {
            expenseDateInput.value = new Date().toISOString().split('T')[0];
        }
        
        // NEW: Barcode Scanner Listener
        const barcodeInput = document.getElementById('barcode-scanner-input');
        barcodeInput.addEventListener('change', handleBarcodeScan);
        // Re-focus scanner input whenever user clicks anywhere
       
        // üöÄ ‡§®‡§Ø‡§æ ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§®: Modal ‡§á‡§µ‡•á‡§Ç‡§ü ‡§∏‡•á‡§ü‡§Ö‡§™ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
   
        
</script>
<div class="modal fade" id="pairingModal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="pairingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pairingModalLabel">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§∏‡•ç‡§ï‡•à‡§®‡§∞ ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closePosWebSocket()"></button>
            </div>
            <div class="modal-body text-center">
                <p>‡§Ö‡§™‡§®‡•á Dukan Pro ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§∏‡•ç‡§ï‡•à‡§®‡§∞ ‡§Æ‡•á‡§Ç ‡§Ø‡§π ‡§ï‡•ã‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç:</p>
                
                <div id="pairing-code-container" style="min-height: 100px; display: flex; align-items: center; justify-content: center; background: #eee; border-radius: 8px; margin: 20px 0;">
                    
                    <span id="pairing-code-display" style="font-size: 2.5rem; font-weight: bold; letter-spacing: 5px; color: #0d6efd;"></span> 
                    
                    <div id="code-spinner" class="spinner-border text-primary" role="status"> 
                        <span class="visually-hidden">‡§ï‡•ã‡§° ‡§ú‡§®‡§∞‡•á‡§ü ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</span>
                    </div>
                </div>
                
                <h4 id="pairing-status" class="text-success"> 
                    <i class="fas fa-check-circle"></i> ‡§∏‡•ç‡§ï‡•à‡§®‡§∞ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ!
                </h4>
                
                <p class="text-muted small mt-3">‡§Ø‡§π ‡§ï‡•ã‡§° ‡§Ü‡§™‡§ï‡•á POS ‡§ï‡•ã ‡§Ü‡§™‡§ï‡•á ‡§´‡§º‡•ã‡§® ‡§∏‡•á ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§ú‡•ã‡§°‡§º‡§§‡§æ ‡§π‡•à‡•§</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closePosWebSocket()">‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
            </div>
        </div>
    </div>
</div>


</body>
</html>

