<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dukan Pro - Ultimate Business Suite</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ====================================================================
         === DUKAN PRO - MODERN AESTHETIC REDESIGN (INDIGO/CYAN) ===
         ====================================================================
        */
    
        /* --- 1. नए और सुंदर रंगों को डिफाइन करना --- */
        :root {
            --dp-bg-light: #f4f7f6;        /* हल्का ग्रे बैकग्राउंड */
            --dp-bg-white: #ffffff;
            --dp-sidebar-bg: #111d4a;    /* डीप इंडिगो (गहरा नीला) */
            --dp-sidebar-text: #a0aed0;   /* हल्का नीला/ग्रे टेक्स्ट */
            --dp-sidebar-text-hover: #ffffff;
            --dp-sidebar-active-bg: #1a2b6d;  /* एक्टिव लिंक के लिए गहरा नीला */
            --dp-primary: #00b4d8;       /* मुख्य सायन (Cyan) रंग */
            --dp-secondary: #03045e;     /* गहरा नीला (Gradient के लिए) */
            --dp-text-dark: #1A202C;
            --dp-text-light: #4A5568;
            --dp-border: #E2E8F0;
            --dp-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); /* सॉफ्ट शैडो */
            
            /* हमारा मुख्य 'सुंदर' ग्रेडिएंट */
            --dp-gradient: linear-gradient(135deg, var(--dp-primary) 0%, var(--dp-secondary) 100%);
        }
    
        /* --- 2. मुख्य बॉडी और लेआउट --- */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--dp-bg-light); /* नया बैकग्राउंड */
            color: var(--dp-text-dark); /* नया टेक्स्ट कलर */
        }
    
        .main-content {
            margin-left: 280px;
            padding: 30px; /* थोड़ी और जगह */
            transition: margin-left 0.3s ease;
        }
    
        /* App is hidden until licensed */
        .main-content.locked, .sidebar.locked, .navbar-toggler.locked {
                display: none;
        }
    
        /* --- 3. साइडबार (आपका फिक्स्ड स्ट्रक्चर) --- */
        .sidebar {
            width: 280px;
            background-color: var(--dp-sidebar-bg); /* नया इंडिगो बैकग्राउंड */
            color: var(--dp-sidebar-text-hover);
            height: 100vh;
            position: fixed; /* ⭐️ यह आपकी आवश्यकता है, यह वैसी ही है */
            top: 0;
            left: 0;
            padding-top: 20px;
            transition: transform 0.3s ease;
            z-index: 1050;
            border-right: 1px solid var(--dp-border);
            overflow-y: auto; /* स्क्रॉल के लिए */
            overflow-x: hidden;
        }
        
        /* साइडबार में "Dukan Pro" हेडिंग */
        .sidebar h3 {
            margin-bottom: 2rem;
            text-align: center;
            font-weight: 700;
            color: #fff;
            letter-spacing: 1px;
        }
    
        /* साइडबार के लिंक्स (नया स्टाइल) */
        .sidebar .nav-link {
            color: var(--dp-sidebar-text);
            padding: 15px 25px;
            border-left: 5px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            /* नया: दाईं ओर से गोल इफ़ेक्ट */
            border-radius: 0 30px 30px 0;
            margin-right: 15px; 
            margin-bottom: 5px; /* लिंक्स के बीच थोड़ी जगह */
        }
    
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: var(--dp-sidebar-text-hover); /* सफ़ेद टेक्स्ट */
            background-color: var(--dp-sidebar-active-bg); /* थोड़ा हल्का नीला */
            border-left-color: var(--dp-primary); /* सायन एक्सेंट */
            /* खूबसूरत 'Glow' इफ़ेक्ट */
            box-shadow: 0 4px 10px rgba(0, 180, 216, 0.2); 
        }
    
        .sidebar .nav-link i {
            margin-right: 12px;
            width: 20px; /* आइकन्स को एक लाइन में रखने के लिए */
            text-align: center;
        }
        
        /* नीचे का यूज़र इन्फो बॉक्स */
        #user-info {
            background-color: var(--dp-sidebar-active-bg) !important;
        }
        
    
        /* --- 4. मुख्य कंटेंट (कार्ड्स, बटन, टेबल्स) --- */
    
        /* सेक्शन की मुख्य हेडिंग (जैसे "डैशबोर्ड") */
        .section > h2 {
            font-weight: 700;
            color: var(--dp-text-dark);
            margin-bottom: 2rem !important;
            /* टेक्स्ट पर ग्रेडिएंट */
            background-image: var(--dp-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            display: inline-block;
        }
    
        /* कार्ड्स का नया डिज़ाइन */
        .card {
            border-radius: 16px; /* ज़्यादा गोल कोने */
            box-shadow: var(--dp-shadow); /* नया सॉफ्ट शैडो */
            border: none;
            overflow: hidden; /* हेडर को सही से रखने के लिए */
            margin-bottom: 1.5rem; /* कार्ड्स के बीच जगह */
        }
    
        /* कार्ड का हेडर (यह सबसे बड़ा बदलाव है) */
        .card-header {
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            background: var(--dp-gradient); /* हमारा सुंदर ग्रेडिएंट */
            color: white;
            padding: 20px 25px;
            font-weight: 600;
            font-size: 1.1rem;
            border-bottom: none;
        }
        
        /* डैशबोर्ड के छोटे कार्ड्स */
        .dashboard-card {
            transition: transform 0.2s, box-shadow 0.2s;
            background: var(--dp-bg-white);
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); /* हॉवर पर ज़्यादा शैडो */
        }
        /* डैशबोर्ड के आइकन्स पर ग्रेडिएंट */
        .dashboard-card i {
            background: var(--dp-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            font-size: 2.5rem; /* थोड़े बड़े आइकन्स */
        }
    
        /* फॉर्म्स और बटन्स */
        .form-control, .form-select, .btn {
            border-radius: 8px;
            padding: 10px 15px;
            border: 1px solid var(--dp-border);
            transition: all 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--dp-primary);
            box-shadow: 0 0 0 3px rgba(0, 180, 216, 0.15);
        }
    
        .btn {
            font-weight: 600;
            padding: 10px 20px;
        }
        
        /* मुख्य बटन (नया स्टाइल) */
        .btn-primary {
            background-color: var(--dp-primary);
            border-color: var(--dp-primary);
            color: #fff;
        }
        .btn-primary:hover {
            background-color: var(--dp-secondary);
            border-color: var(--dp-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 180, 216, 0.3);
        }
        
        /* अन्य बटन (जैसे 'Add') */
        .btn-success { background-color: #1abc9c; border-color: #1abc9c; }
        .btn-success:hover { background-color: #16a085; border-color: #16a085; }
        .btn-info { background-color: #3498db; border-color: #3498db; }
        .btn-info:hover { background-color: #2980b9; border-color: #2980b9; }
        .btn-warning { background-color: #f39c12; border-color: #f39c12; }
        .btn-warning:hover { background-color: #e67e22; border-color: #e67e22; }
    
        /* टेबल्स */
        .table th {
            background-color: var(--dp-bg-light); /* हल्का बैकग्राउंड */
            color: var(--dp-text-light); /* हल्का टेक्स्ट */
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            border: none;
            padding: 15px;
        }
        .table-striped > tbody > tr:nth-of-type(odd) > * {
            --bs-table-bg-type: var(--dp-bg-light);
        }
        .table td {
            border-top: 1px solid var(--dp-border); /* हल्की बॉर्डर */
            vertical-align: middle;
            padding: 15px;
            color: var(--dp-text-dark);
        }
        .table-hover tbody tr:hover {
            background-color: #eaf6f9; /* हल्का सायन हॉवर */
        }
    
        /* --- 5. बाकी के स्टाइल्स (पहले से मौजूद) --- */
        
        /* मोबाइल एडजस्टमेंट (पहले जैसा) */
        @media (max-width: 991.98px) {
            .sidebar { transform: translateX(-280px); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .main-content.sidebar-open { margin-left: 280px; overflow-x: hidden; }
            .navbar-toggler { display: block !important; }
        }
        
        .navbar-toggler {
            position: fixed; top: 10px; left: 10px; z-index: 1060;
            display: none; background-color: var(--dp-sidebar-bg);
            border: 1px solid var(--dp-primary);
        }
        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='white' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }
        
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); display: flex;
            justify-content: center; align-items: center; z-index: 2000;
        }
        .hidden { display: none !important; }
    
        /* --- इनवॉइस जनरेटर स्टाइल्स --- */
        #invoice-generator h5 { font-weight: 600; }
        #invoice-preview {
            background: white; padding: 25px; border: 1px solid var(--dp-border);
            min-height: 80vh; font-size: 14px; color: #333;
            border-radius: 16px; box-shadow: var(--dp-shadow);
        }
        .invoice-header {
            border-bottom: 2px solid var(--dp-primary);
            margin-bottom: 20px; padding-bottom: 15px;
        }
        .shop-details h3 { color: var(--dp-secondary); font-weight: 700; }
        .customer-details {
            border: 1px solid #eee; padding: 15px;
            margin-bottom: 20px; border-radius: 8px;
        }
        .invoice-table th { background-color: var(--dp-bg-light); }
        
        /* --- GST रिपोर्ट टैब्स --- */
        .gst-report-tabs .nav-link {
            background-color: #f0f0f0; border: 1px solid var(--dp-border);
            color: var(--dp-text-light); font-weight: 600;
        }
        .gst-report-tabs .nav-link.active {
            background-color: var(--dp-bg-white);
            border-bottom: 1px solid var(--dp-bg-white);
            color: var(--dp-secondary); /* डार्क ब्लू एक्टिव */
            position: relative; top: 1px;
        }
        .gst-report-tab-content {
            background-color: var(--dp-bg-white);
            border: 1px solid var(--dp-border);
            padding: 1.5rem;
            border-radius: 0 8px 8px 8px;
        }
        
        /* --- अन्य सभी स्टाइल्स (बारकोड, टाइमर, प्रिंट) --- */
        /* (यह बाकी का CSS है जिसे बदलने की ज़रूरत नहीं है) */
    
        .section { display: none; }
        .section.active { display: block; }
        .text-shadow { text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); }
        #qr-preview img { max-width: 100px; max-height: 100px; border: 1px solid #ccc; padding: 3px; }
        .invoice-table { width: 100%; margin-bottom: 20px; border-collapse: collapse; }
        .invoice-table th, .invoice-table td { padding: 10px; text-align: right; border-bottom: 1px solid #dee2e6; }
        .invoice-table th:first-child, .invoice-table td:first-child { text-align: left; }
        .invoice-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 20px; }
        .totals-table { width: 50%; }
        .totals-table td { padding: 5px 10px; }
        .terms { font-size: 12px; color: #777; }
        .report-table { font-size: 0.9rem; }
        .report-table th { background-color: #f8f9fa; }
        .report-table td { padding: 0.5rem; }
        .report-table .fw-bold { border-top: 2px solid #333; }
        .report-print-area { display: none; }
        #barcode-scanner-input { position: fixed; top: -100px; left: -100px; opacity: 0; }
        #license-timer { font-size: 0.8rem; font-weight: 500; padding: 5px 10px; border-radius: 6px; }
        #license-timer.expiring-soon { background-color: #ffc107; color: #333; cursor: pointer; }
        #license-timer.expired { background-color: #dc3545; color: #fff; cursor: pointer; }
        #license-timer i { margin-right: 5px; }
        .json-viewer { background-color: #282c34; color: #abb2bf; padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto; font-family: 'Courier New', Courier, monospace; font-size: 0.9rem; white-space: pre; }
        @media print {
            body * { visibility: hidden; }
            .printable, .printable * { visibility: visible; }
            .printable { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 15px; border: none; box-shadow: none; }
            .no-print { display: none; }
        }
        .sidebar::-webkit-scrollbar { width: 8px; }
        .sidebar::-webkit-scrollbar-track { background: #555; }
        .sidebar::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .sidebar::-webkit-scrollbar-thumb:hover { background: #aaa; }
        .gst-report-table { font-size: 0.85rem; margin-top: 15px; border-collapse: collapse; width: 100%; }
        .gst-report-table th, .gst-report-table td { border: 1px solid #dee2e6; padding: 8px 12px; text-align: right; }
        .gst-report-table th { background-color: #f8f9fa; text-align: center; font-weight: 600; vertical-align: middle; }
        .gst-report-table td:first-child { text-align: left; }
        .gst-report-table tfoot tr { font-weight: bold; background-color: #e9ecef; }
        .gst-report-table .group-header td { background-color: #f3f4f6; font-weight: bold; text-align: left; }
    
    
    /* ======================================================== */
/* === 🚀 नया खूबसूरत लॉगिन CSS (यहाँ से कॉपी करें) === */
/* ======================================================== */

/* 1. मॉल का बैकग्राउंड इमेज */
.auth-overlay {
    background: url('./images/shopkeeper-dukanpro.jpg') no-repeat center center fixed;
    background-size: cover;
    background-color: rgba(0, 0, 0, 0.45); /* थोड़ा गहरा ओवरले */
    background-blend-mode: multiply;
    /* ... (बाकी का कोड) ... */
}    
    /* नया: मॉल का बैकग्राउंड */
    background: url('https://raw.githubusercontent.com/Dinesh9529/Dukan-Pro-Ultimate/main/images/shopkeeper-dukanpro.jpg') no-repeat center center fixed;    
	background-size: cover;
    
    /* टेक्स्ट साफ़ दिखे इसके लिए हल्की डार्क लेयर */
    background-color: rgba(0, 0, 0, 0.3);
    background-blend-mode: multiply;
    
    /* सुनिश्चित करें कि यह पूरे पेज पर हो */
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 20px;
}

/* 2. नया सेंटर्ड रैपर (Wrapper) */
.login-wrapper {
    width: 100%;
    max-width: 950px; /* लॉगिन बॉक्स + साइडबार की कुल चौड़ाई */
    display: grid;
    /* 40% एडवरटाइजिंग, 60% लॉगिन फॉर्म */
    grid-template-columns: 40% 60%; 
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

/* 3. नया एडवरटाइजिंग साइडबार (Left Column) */
.login-ad-sidebar {
    /* आपकी ऐप की इंडिगो थीम का उपयोग */
    background: var(--dp-sidebar-bg, #111d4a); 
    color: #fff;
    padding: 40px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}
.login-ad-sidebar h3 {
    font-weight: 700;
    letter-spacing: 1px;
}
.login-ad-sidebar p {
    font-size: 1.1rem;
    color: var(--dp-sidebar-text, #a0aed0);
    border-bottom: 1px solid var(--dp-sidebar-active-bg, #1a2b6d);
    padding-bottom: 15px;
}
.login-ad-sidebar .ad-footer {
    margin-top: auto;
    padding-top: 15px;
    border-top: 1px solid var(--dp-sidebar-active-bg, #1a2b6d);
    color: var(--dp-sidebar-text, #a0aed0);
}

/* 4. लॉगिन कार्ड (Glass Effect) */
.login-card-glass {
    background: rgba(255, 255, 255, 0.8); /* थोड़ी ज़्यादा पारदर्शिता */
    backdrop-filter: blur(15px); /* थोड़ा कम ब्लर, ताकि पीछे का ज़्यादा दिखे */
    -webkit-backdrop-filter: blur(15px);
    padding: 30px 40px;
}
.login-card-glass h3 {
    color: var(--dp-text-dark, #1A202C);
}
/* टैब्स को ग्लास पर बेहतर दिखाना */
.login-card-glass .nav-tabs {
    border-bottom: 2px solid var(--dp-border, #E2E8F0);
}
.login-card-glass .nav-link {
    color: var(--dp-text-light, #4A5568);
    font-weight: 600;
    padding: 10px 15px;
}
.login-card-glass .nav-link.active {
    background-color: rgba(255, 255, 255, 0.8);
    color: var(--dp-primary, #00b4d8);
    border: 2px solid var(--dp-border, #E2E8F0);
    border-bottom-color: transparent;
    border-radius: 8px 8px 0 0;
}


/* 5. एनिमेटेड फीचर्स (Advertising Quotes) */
.features-list {
    list-style: none;
    padding: 0;
    margin: 25px 0;
    height: 180px; /* एनीमेशन के लिए फिक्स्ड ऊंचाई */
    overflow: hidden;
    position: relative;
}
.features-list {
    list-style: none;
    padding: 0;
    margin: 25px 0;
    height: 250px; /* एनीमेशन के लिए थोड़ी ज़्यादा ऊंचाई */
    overflow: hidden;
    position: relative;
    font-size: 1.1rem; /* मुख्य टेक्स्ट का साइज़ */
}
.features-list li {
    font-weight: 500;
    padding: 8px 0;
    position: absolute;
    width: 100%;
    opacity: 0;
    transform: translateY(30px);
    /* 9 आइटम के लिए 18 सेकंड का लूप (2s प्रति आइटम) */
    animation: slide-up-fade 18s linear infinite; /* टोटल 18 सेकंड */
    animation-delay: var(--delay);
}
.features-list li span {
    display: block; /* हिंदी टेक्स्ट को नई लाइन पर */
    font-size: 0.9rem; /* हिंदी टेक्स्ट का छोटा साइज़ */
    color: var(--dp-sidebar-text, #a0aed0); /* हल्का रंग */
    margin-top: 3px;
    font-weight: 400;
}
/* हर आइटम को अलग-अलग समय पर एनिमेट करना (अब 9 आइटम के लिए) */
.features-list li:nth-child(1) { --delay: 0s; }
.features-list li:nth-child(2) { --delay: 2s; }
.features-list li:nth-child(3) { --delay: 4s; }
.features-list li:nth-child(4) { --delay: 6s; }
.features-list li:nth-child(5) { --delay: 8s; }
.features-list li:nth-child(6) { --delay: 10s; }
.features-list li:nth-child(7) { --delay: 12s; }
.features-list li:nth-child(8) { --delay: 14s; } /* नया आइटम */
.features-list li:nth-child(9) { --delay: 16s; } /* नया आइटम */
/* (नया, सही कोड) */
@keyframes slide-up-fade {
    /* हर आइटम 18 सेकंड के लूप में सिर्फ 2 सेकंड के लिए दिखेगा */

    /* 0% से ~1.1% (लगभग 0.2s) - अंदर आना */
    0%   { opacity: 0; transform: translateY(30px); }
    1.1% { opacity: 1; transform: translateY(0); }

    /* ~1.1% से ~10% (लगभग 1.6s) - रुके रहना */
    10%  { opacity: 1; transform: translateY(0); }

    /* ~10% से ~11.1% (लगभग 0.2s) - बाहर जाना */
    11.1% { opacity: 0; transform: translateY(-15px); }
    
    /* बाकी 88.9% समय (16 सेकंड) - छिपा रहना */
    100% { opacity: 0; }
}/* 6. मोबाइल के लिए (बहुत महत्वपूर्ण) */
@media (max-width: 800px) {
    .login-wrapper {
        grid-template-columns: 1fr; /* 1 कॉलम में दिखाना */
        width: 95%;
        max-width: 450px;
        max-height: 90vh;
        overflow-y: auto; /* स्क्रॉल के लिए */
    }
    .login-ad-sidebar {
        /* मोबाइल पर एडवरटाइजिंग छिपा दें */
        display: none; 
    }
    .login-card-glass {
        /* मोबाइल पर ज़्यादा साफ़ दिखाना */
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }
}
/* ======================================================== */
/* === 🚀 नया CSS यहाँ समाप्त होता है === */
/* ======================================================== */
    
    
    
    
    </style>


</head>

<body>

    <input type="text" id="barcode-scanner-input" autocomplete="off">


    <div class="auth-overlay" id="auth-container-new">
    
    <div class="login-wrapper">
        
        <div class="login-ad-sidebar">
            <h3 class="mb-3"><i class="fas fa-store me-2"></i>Dukan Pro Ultimate</h3>
            <p>इंडिया का सबसे एडवांस बिज़नेस सूट</p>
            
            <ul class="features-list">
                <li><i class="fas fa-file-alt me-2"></i> GSTR-1, 2, & 3B Reports<br><span>(GSTR-1, 2, और 3B रिपोर्ट्स)</span></li>
                <li><i class="fas fa-university me-2"></i> Automated Bank Reconciliation<br><span>(स्वचालित बैंक समाधान)</span></li>
                <li><i class="fas fa-qrcode me-2"></i> Barcode Scanning via Mobile<br><span>(मोबाइल से बारकोड स्कैनिंग)</span></li>
                <li><i class="fas fa-users me-2"></i> Advanced Customer (CRM)<br><span>(उन्नत ग्राहक संबंध प्रबंधन)</span></li>
                <li><i class="fas fa-boxes me-2"></i> Smart Stock & Inventory Control<br><span>(स्मार्ट स्टॉक और इन्वेंटरी नियंत्रण)</span></li>
                <li><i class="fas fa-chart-line me-2"></i> Real-time P&L & Analytics<br><span>(रियल-टाइम P&L और विश्लेषण)</span></li>
                <li><i class="fas fa-cash-register me-2"></i> Lightning-Fast POS Billing<br><span>(बिजली की तेज़ी से POS बिलिंग)</span></li>
                <li><i class="fas fa-receipt me-2"></i> Customizable Invoice Generator<br><span>(कस्टमाइजेबल इनवॉइस जनरेटर)</span></li>
                <li><i class="fas fa-cloud me-2"></i> Secure Cloud Data Backup<br><span>(सुरक्षित क्लाउड डेटा बैकअप)</span></li>
            </ul>

            <div class="ad-footer">
                <p>आपके बिज़नेस की हर ज़रूरत, एक सॉफ्टवेयर में।</p>
            </div>
        </div>
        
        <div class="login-card-glass">
            <nav>
                <div class="nav nav-tabs" id="nav-tab" role="tablist">
                    <button class="nav-link active w-50" id="nav-login-tab" data-bs-toggle="tab" data-bs-target="#nav-login" type="button" role="tab" aria-controls="nav-login" aria-selected="true">
                        <i class="fas fa-sign-in-alt me-2"></i>लॉगिन
                    </button>
                    <button class="nav-link w-50" id="nav-register-tab" data-bs-toggle="tab" data-bs-target="#nav-register" type="button" role="tab" aria-controls="nav-register" aria-selected="false">
                        <i class="fas fa-user-plus me-2"></i>नया अकाउंट
                    </button>
                </div>
            </nav>
            <div class="tab-content mt-4" id="nav-tabContent">
                <div class="tab-pane fade show active" id="nav-login" role="tabpanel" aria-labelledby="nav-login-tab">
                    <h3 class="text-center mb-4">Dukan Pro में लॉगिन करें</h3>
                    <form id="login-form">
                        <div class="mb-3">
                            <label for="login-email" class="form-label">ईमेल</label>
                            <input type="email" class="form-control" id="login-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="login-password" class="form-label">पासवर्ड</label>
                            <input type="password" class="form-control" id="login-password" required>
                        </div>
                        <div id="login-message" class="text-danger small mb-3">&nbsp;</div>
                        <button type="submit" class="btn btn-primary w-100" id="login-submit-btn">लॉगिन</button>
                    </form>
                </div>
                <div class="tab-pane fade" id="nav-register" role="tabpanel" aria-labelledby="nav-register-tab">
                    <h3 class="text-center mb-4">नया शॉप अकाउंट बनाएं</h3>
                    <form id="register-form">
                        <div class="mb-3">
                            <label for="register-shop-name" class="form-label">आपकी शॉप का नाम</label>
                            <input type="text" class="form-control" id="register-shop-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="register-name" class="form-label">आपका पूरा नाम (एडमिन)</label>
                            <input type="text" class="form-control" id="register-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="register-email" class="form-label">आपका ईमेल</label>
                            <input type="email" class="form-control" id="register-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="register-mobile" class="form-label">मोबाइल नंबर</label>
                            <input type="tel" class="form-control" id="register-mobile" required pattern="[0-9]{10}">
                        </div>
                        <div class="mb-3">
                            <label for="register-password" class="form-label">नया पासवर्ड</label>
                            <input type="password" class="form-control" id="register-password" required>
                        </div>
                        <div id="register-message" class="text-danger small mb-3">&nbsp;</div>
                        <button type="submit" class="btn btn-success w-100" id="register-submit-btn">अकाउंट बनाएं</button>
                    </form>
                </div>
            </div>
            </div>

    </div>

</div>



    <div class="modal fade" id="licenseModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="licenseModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="licenseModalLabel">Dukan Pro - License Verification</h5>
                </div>
                <form id="license-form">
                    <div class="modal-body">
                        <p>सॉफ्टवेयर का उपयोग करने के लिए कृपया अपनी लाइसेंस की दर्ज करें।</p>
                        <div class="mb-3">
                            <label for="license-key-input" class="form-label fw-bold">लाइसेंस की (License Key)</label>
                            <input type="text" class="form-control" id="license-key-input" required autocomplete="off">
                        </div>
                        <div id="license-message" class="text-danger small mt-2">&nbsp;</div>
                    </div>
                    <div class="modal-footer">
                         <button type="button" class="btn btn-outline-secondary d-none" id="open-admin-login-from-license-btn">एडमिन लॉगिन</button>
                         <button type="submit" class="btn btn-primary" id="license-submit-btn">सत्यापित करें</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="renewalModal" tabindex="-1" aria-labelledby="renewalModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-warning border-3">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="renewalModalLabel"><i class="fas fa-exclamation-triangle"></i> लाइसेंस रिन्यूअल चेतावनी</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="fs-5">आपकी Dukan Pro लाइसेंस की जल्द ही समाप्त होने वाली है!</p>
                    <p>असुविधा से बचने के लिए, कृपया समय पर रिन्यूअल कराएँ।</p>
                    <p class="fw-bold">रिन्यूअल करने के लिए 7303410987 पर WhatsApp करें।</p>
                    <hr>
                    <p class="mb-2 fw-bold">आप कितने समय के लिए रिन्यूअल करना चाहते हैं?</p>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success" onclick="sendWhatsAppRenewal(1)">
                            <i class="fab fa-whatsapp"></i> 1 महीने के लिए पूछें
                        </button>
                        <button type="button" class="btn btn-success" onclick="sendWhatsAppRenewal(6)">
                            <i class="fab fa-whatsapp"></i> 6 महीने के लिए पूछें
                        </button>
                        <button type="button" class="btn btn-success" onclick="sendWhatsAppRenewal(12)">
                            <i class="fab fa-whatsapp"></i> 12 महीने (1 साल) के लिए पूछें
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">बाद में</button>
                </div>
            </div>
        </div>
    </div>




    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="ms-3 text-primary" id="loading-message">डेटा लोड हो रहा है...</div>
    </div>

    <button class="navbar-toggler locked" type="button" id="menu-toggle">
        <span class="navbar-toggler-icon"></span>
    </button>
    <nav id="sidebar" class="sidebar locked">
        <div class="p-4 d-flex flex-column h-100">
            <div class="text-center mb-3" id="shop-logo-container">
                </div>
            <h3 class="mb-4 text-white text-shadow text-center"><i class="fas fa-store me-2"></i>Dukan Pro</h3>
            
            <ul class="nav flex-column mb-auto" id="sidebar-nav">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-view="dashboard" data-role="ANY"> <i class="fas fa-home"></i> डैशबोर्ड
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="stock" data-role="MANAGER"> <i class="fas fa-boxes"></i> स्टॉक प्रबंधन
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="sales" data-role="ANY"> <i class="fas fa-cash-register"></i> बिक्री (POS)
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="invoice-generator" data-role="ANY"> <i class="fas fa-file-invoice"></i> इनवॉइस जनरेटर Pro
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="purchases" data-role="MANAGER"> <i class="fas fa-shopping-basket"></i> खरीद
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="crm" data-role="MANAGER"> <i class="fas fa-users"></i> ग्राहक (CRM)
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="expenses" data-role="MANAGER"> <i class="fas fa-money-bill-wave"></i> खर्च
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="reports" data-role="MANAGER"> <i class="fas fa-chart-line"></i> रिपोर्ट्स
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="gst-reports" data-role="MANAGER"> <i class="fas fa-file-alt"></i> GST रिपोर्ट्स
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="bank-reconciliation" data-role="MANAGER"> <i class="fas fa-university"></i> बैंक रिकॉन्सिलेशन
                    </a>
                </li>

                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="daily-closing" data-role="MANAGER"> <i class="fas fa-calendar-check"></i> डेली क्लोजिंग
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="data-backup" data-role="ADMIN"> <i class="fas fa-download"></i> डेटा बैकअप
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link d-none" data-view="staff" data-role="ADMIN"> <i class="fas fa-user-cog"></i> स्टाफ प्रबंधन
                    </a>
                </li>
                 <li class="nav-item">
                    <a href="#" class="nav-link" data-view="shop-settings" data-role="ADMIN"> <i class="fas fa-cogs"></i> शॉप सेटिंग्स
                    </a>
                </li>
            </ul>
            
            <hr class="text-white-50">
            
            <div id="user-info" class="text-white-50 p-2 text-center mb-2" style="background-color: #495057; border-radius: 8px;">
                <h5 id="user-shop-name" class="text-white mb-0">Shop Name</h5>
                <small id="user-name-email">User Name (Role)</small>
            </div>

            <div id="license-timer" class="text-center text-white-50 mb-2">
                <i class="fas fa-check-circle text-success"></i> लाइसेंस लोड हो रहा है...
            </div>
            
            <button id="logout-btn" class="btn btn-sm btn-danger w-100"><i class="fas fa-sign-out-alt me-2"></i>लॉगआउट</button>
            
            <p class="text-muted mt-2 mb-0 text-center small">v1.0.3 Corrected</p>
        </div>
    </nav>

    

    <div id="main-content" class="main-content locked">
        <section id="dashboard" class="section">
            <h2 class="mb-4 text-primary">डैशबोर्ड</h2>
            <div class="row g-4">
                <div class="col-md-6 col-lg-3">
                    <div class="card p-3 dashboard-card bg-white">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-rupee-sign fa-2x text-primary me-3"></i>
                            <div>
                                <p class="text-muted mb-0">कुल बिक्री (रेवेन्यू)</p>
                                <h4 class="mb-0" id="total-sales-revenue">₹0.00</h4>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="card p-3 dashboard-card bg-white">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-boxes fa-2x text-warning me-3"></i>
                            <div>
                                <p class="text-muted mb-0">स्टॉक मूल्य (खरीद)</p>
                                <h4 class="mb-0" id="total-stock-value">₹0.00</h4>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="card p-3 dashboard-card bg-white">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-users fa-2x text-success me-3"></i>
                            <div>
                                <p class="text-muted mb-0">कुल ग्राहक</p>
                                <h4 class="mb-0" id="total-customers">0</h4>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="card p-3 dashboard-card bg-white">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle fa-2x text-danger me-3"></i>
                            <div>
                                <p class="text-muted mb-0">कम स्टॉक वाले आइटम</p>
                                <h4 class="mb-0" id="low-stock-count">0</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4 g-4">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header bg-gradient-primary">पिछले 30 दिनों की बिक्री</div>
                        <div class="card-body">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header bg-warning text-dark">कम स्टॉक चेतावनी</div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm table-striped mb-0">
                                    <thead>
                                        <tr>
                                            <th>SKU</th>
                                            <th>आइटम</th>
                                            <th>Qty</th>
                                        </tr>
                                    </thead>
                                    <tbody id="low-stock-table-body">
                                        <tr><td colspan="3" class="text-center text-muted">कोई कम स्टॉक आइटम नहीं</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4 g-4">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header bg-success">हाल की बिक्री</div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-striped mb-0">
                                    <thead>
                                        <tr>
                                            <th>चालान नं.</th>
                                            <th>ग्राहक</th>
                                            <th>राशि</th>
                                            <th>तिथि</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-sales-table-body">
                                        <tr><td colspan="4" class="text-center text-muted">कोई बिक्री नहीं</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header bg-info">हाल के ग्राहक</div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-striped mb-0">
                                    <thead>
                                        <tr>
                                            <th>नाम</th>
                                            <th>फ़ोन</th>
                                            <th>जोड़ा गया</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-customers-table-body">
                                        <tr><td colspan="3" class="text-center text-muted">कोई ग्राहक नहीं</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>



        <section id="stock" class="section">
            <h2 class="mb-4 text-primary">स्टॉक प्रबंधन</h2>
            <div class="card mb-4">
                <div class="card-header">नया स्टॉक आइटम जोड़ें</div>
                <div class="card-body">
                    <form id="add-stock-form" class="row g-3">
                        <div class="col-md-3">
                            <label for="stock-sku" class="form-label">SKU / कोड</label>
                            <input type="text" class="form-control" id="stock-sku" required>
                        </div>
                        <div class="col-md-5">
                            <label for="stock-name" class="form-label">आइटम का नाम</label>
                            <input type="text" class="form-control" id="stock-name" required>
                        </div>
                        <div class="col-md-2">
                            <label for="stock-quantity" class="form-label">मात्रा (Qty)</label>
                            <input type="number" class="form-control" id="stock-quantity" required min="0">
                        </div>
                         <div class="col-md-2">
                             <label for="stock-unit" class="form-label">इकाई</label>
                             <input type="text" class="form-control" id="stock-unit" value="Pcs" placeholder="e.g., Pcs, Kg, Ltr" required>
                         </div>
                        <div class="col-md-3">
                            <label for="stock-purchase-price" class="form-label">खरीद मूल्य (₹)</label>
                            <input type="number" step="0.01" class="form-control" id="stock-purchase-price" required min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="stock-sale-price" class="form-label">बिक्री मूल्य (₹)</label>
                            <input type="number" step="0.01" class="form-control" id="stock-sale-price" required min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="stock-gst" class="form-label">GST (%)</label>
                            <input type="number" step="0.01" class="form-control" id="stock-gst" value="0" min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="stock-hsn-code" class="form-label">HSN कोड (वैकल्पिक)</label>
                            <input type="text" class="form-control" id="stock-hsn-code">
                        </div>
                        <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-primary w-100">स्टॉक में आइटम जोड़ें</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">उपलब्ध स्टॉक सूची</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>SKU</th>
                                    <th>आइटम</th>
                                    <th>Qty</th>
                                    <th>खरीद मूल्य</th>
                                    <th>बिक्री मूल्य</th>
                                    <th>GST %</th>
                                    <th>Last Updated</th>
                                    <th>एक्शन</th> 
                                </tr>
                            </thead>
                            <tbody id="stock-table-body">
                                <tr><td colspan="8" class="text-center text-muted">कोई स्टॉक आइटम नहीं मिला</td></tr>
                            </tbody>
                            <tfoot id="stock-table-foot"></tfoot> 
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="sales" class="section">
            <h2 class="mb-4 text-primary">बिक्री (पॉइंट ऑफ सेल)</h2>
            <div class="row g-4">
                <div class="col-lg-5"> <div class="card">
                        <div class="card-header">नया चालान बनाएं</div>
                        <div class="card-body">
                            <form id="pos-form">
                                <div class="mb-3">
                                    <label for="pos-customer" class="form-label">ग्राहक का नाम</label>
                                    <input type="text" class="form-control" id="pos-customer" list="customer-datalist" placeholder="अनाम ग्राहक या नाम टाइप करें">
                                    <datalist id="customer-datalist"></datalist>
                                </div>
        
                                <div class="mb-3">
                                    <label for="pos-customer-mobile" class="form-label">मोबाइल नंबर</label>
                                    <input type="tel" class="form-control" id="pos-customer-mobile" placeholder="ग्राहक का मोबाइल नंबर (वैकल्पिक)">
                                </div>
                                
                                <div class="mb-3 position-relative">
                                    <label for="pos-item-search" class="form-label">आइटम खोजें / SKU</label>
                                    <div class="input-group"> 
                                        <input 
                                            type="text" 
                                            class="form-control" 
                                            id="pos-item-search" 
                                            placeholder="आइटम का नाम या SKU टाइप करें (या सभी के लिए क्लिक करें)" 
                                            autocomplete="off"
                                        >
                                        <button class="btn btn-warning" type="button" onclick="openMobileScanner()">
                                            <i class="fas fa-qrcode"></i> मोबाइल स्कैनर
                                        </button>
                                    </div>

                                    <div id="inline-pairing-box" class="mt-2 p-2 border border-warning rounded bg-light text-center" style="display: none;">
                                        <p class="mb-1 small text-muted">स्कैनर कनेक्ट करने के लिए यह कोड मोबाइल में डालें:</p>
                                        <span id="inline-pairing-code" style="font-size: 1.8rem; font-weight: bold; letter-spacing: 3px; color: #dc3545;"></span> <div id="inline-pairing-spinner" class="spinner-border spinner-border-sm text-warning ms-2" role="status"> <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p id="inline-pairing-status" class="mt-1 mb-0 small text-success" style="display: none;">
                                            <i class="fas fa-check-circle"></i> स्कैनर कनेक्टेड।
                                        </p>
                                    </div>
                                    <ul 
                                        id="pos-search-results" 
                                        class="list-group position-absolute w-100" 
                                        style="z-index: 100; max-height: 300px; overflow-y: auto;"
                                        onclick="handleSearchResultClick(event)"
                                    ></ul>
                                </div>
                                <hr>
        
                                <h5>बिलिंग कार्ट</h5>
                                <div class="table-responsive mb-3" style="min-height: 150px;">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>आइटम</th>
                                                <th style="width: 15%;">Qty</th>
                                                <th>दर</th>
                                                <th>कुल</th>
                                                <th style="width: 1%;"></th>
                                            </tr>
                                        </thead>
                                        <tbody id="pos-cart-body">
                                            <tr><td colspan="5" class="text-center text-muted">कार्ट खाली है।</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="d-flex justify-content-between fw-bold mb-2">
                                    <span>कुल टैक्सेबल राशि:</span>
                                    <span id="pos-subtotal">₹0.00</span>
                                </div>
                                <div class="d-flex justify-content-between fw-bold mb-2 text-danger">
                                    <span>कुल GST राशि:</span>
                                    <span id="pos-gst-amount">₹0.00</span>
                                </div>
                                <div class="d-flex justify-content-between fw-bold fs-5 border-top pt-2">
                                    <span>भुगतान की जाने वाली कुल राशि:</span>
                                    <span id="pos-total-amount">₹0.00</span>
                                </div>
        
                                <div class="mt-4">
                                    <button 
                                        type="button" 
                                        class="btn btn-success btn-lg w-100" 
                                        id="complete-sale-btn"
                                        onclick="handleCompleteSale()"
                                    >बिक्री पूरी करें</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-7"> <div class="card">
                        <div class="card-header">हाल के चालान</div>
                        <div class="card-body">
                            <div class="mb-3 d-flex justify-content-end">
                                <button class="btn btn-sm btn-outline-secondary" id="refresh-sales-btn" onclick="fetchAndRenderSales()"><i class="fas fa-sync-alt"></i> ताज़ा करें</button>
                            </div>
                            <div class="table-responsive" style="max-height: 700px; overflow-y: auto;">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>चालान नं.</th>
                                            <th>ग्राहक</th>
                                            <th>GST</th>
                                            <th>कुल राशि</th>
                                            <th>तिथि</th>
                                            <th>एक्शन</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sales-table-body">
                                        <tr><td colspan="5" class="text-center text-muted">कोई बिक्री रिकॉर्ड नहीं।</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="invoice-generator" class="section">
            <h2 class="mb-4 text-primary">🇮🇳 India's Best Invoice Generator Pro</h2>
            <div class="row g-4">
                <div class="col-lg-5 no-print">
                    <div class="card">
                        <div class="card-header">
                            <h2>📝 Create New Invoice</h2>
                        </div>
                        <div class="card-body p-4">
                            <div class="row g-3 mb-4">
                                <h5>🏪 Shop Details</h5>
                                <div class="col-md-6">
                                    <input type="text" id="shopName" class="form-control" placeholder="Shop Name" onkeyup="updateInvoicePreview()">
                                </div>
                                <div class="col-md-6">
                                    <input type="text" id="shopContact" class="form-control" placeholder="Contact No." onkeyup="updateInvoicePreview()">
                                </div>
                                <div class="col-12">
                                    <input type="text" id="shopAddress" class="form-control" placeholder="Shop Address" onkeyup="updateInvoicePreview()">
                                </div>
                                 <div class="col-md-6">
                                     <input type="text" id="shopGstin" class="form-control" placeholder="GSTIN (Optional)" onkeyup="updateInvoicePreview()">
                                 </div>
                                 <div class="col-md-6">
                                     <label for="qrUpload" class="form-label small">Upload UPI QR (Optional)</label>
                                     <input type="file" class="form-control form-control-sm" id="qrUpload" accept="image/*">
                                 </div>
                            </div>
        
                            <div class="row g-3 mb-4">
                                <h5>👤 Customer Details</h5>
                                 <div class="col-md-6">
                                     <input type="text" id="customerName" class="form-control" placeholder="Customer Name" onkeyup="updateInvoicePreview()">
                                 </div>
                                 <div class="col-md-6">
                                     <input type="text" id="customerContact" class="form-control" placeholder="Contact No." onkeyup="updateInvoicePreview()">
                                 </div>
                                <div class="col-12">
                                    <input type="text" id="customerAddress" class="form-control" placeholder="Customer Address" onkeyup="updateInvoicePreview()">
                                </div>
                            </div>
        
                            <h5 class="mb-3">➕ Add Items</h5>
                            <form id="item-form" class="row g-2 align-items-center">
                                <div class="col-sm-12 mb-2">
                                    <input type="text" id="itemName" class="form-control" placeholder="Item Name">
                                </div>
                                <div class="col-sm-3">
                                    <input type="number" id="quantity" class="form-control" placeholder="Qty">
                                </div>
                                 <div class="col-sm-4">
                                     <input type="number" id="price" class="form-control" placeholder="Rate">
                                 </div>
                                 <div class="col-sm-3">
                                     <input type="number" id="gst" class="form-control" placeholder="GST %">
                                 </div>
                                <div class="col-sm-2">
                                    <button type="button" class="btn btn-success w-100" onclick="addItem()">Add</button>
                                </div>
                            </form>
                            <hr>
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button class="btn btn-info text-white" onclick="printInvoice()">🖨️ Print Invoice</button>
                                <button class="btn btn-danger" onclick="clearBill()">🗑️ Clear Bill</button>
                            </div>
                        </div>
                    </div>
                </div>
        
                <div class="col-lg-7">
                    <div id="invoice-preview">
                        <div class="text-center text-muted p-5">Please fill details and add items to see the invoice preview.</div>
                    </div>
                </div>
            </div>
        </section>

        <section id="purchases" class="section">
            <h2 class="mb-4 text-primary">खरीद रिकॉर्ड</h2>
            <div class="card mb-4">
                <div class="card-header">नई खरीद दर्ज करें</div>
                <div class="card-body">
                    <form id="add-purchase-form" class="row g-3">
                        <div class="col-md-3">
                            <label for="purchase-bill-number" class="form-label">बिल / चालान नं.</label>
                            <input type="text" class="form-control" id="purchase-bill-number" required>
                        </div>
                        <div class="col-md-3">
                            <label for="purchase-supplier" class="form-label">आपूर्तिकर्ता का नाम</label>
                            <input type="text" class="form-control" id="purchase-supplier" required>
                        </div>
                        <div class="col-md-3">
                            <label for="purchase-date" class="form-label">खरीद की तारीख</label>
                            <input type="date" class="form-control" id="purchase-date" required>
                        </div>
                        <div class="col-md-3">
                            <label for="purchase-total-cost" class="form-label">कुल बिल राशि (₹)</label>
                            <input type="number" step="0.01" class="form-control" id="purchase-total-cost" required min="0">
                        </div>
                    
                        <hr class="my-3 col-12">
                        <h6 class="col-12 text-primary">GST विवरण (GSTR-2 के लिए)</h6>
                        
                        <div class="col-md-3">
                            <label for="purchase-taxable-value" class="form-label">टैक्सेबल वैल्यू (₹)</label>
                            <input type="number" step="0.01" class="form-control" id="purchase-taxable-value" min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="purchase-cgst" class="form-label">CGST (₹)</label>
                            <input type="number" step="0.01" class="form-control" id="purchase-cgst" value="0" min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="purchase-sgst" class="form-label">SGST (₹)</label>
                            <input type="number" step="0.01" class="form-control" id="purchase-sgst" value="0" min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="purchase-igst" class="form-label">IGST (₹)</label>
                            <input type="number" step="0.01" class="form-control" id="purchase-igst" value="0" min="0">
                        </div>
                    
                        <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-success w-100">खरीद रिकॉर्ड करें</button>
                        </div>
                    </form>                </div>
            </div>

            <div class="card">
                <div class="card-header">हाल की खरीद का इतिहास</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>बिल नं.</th>
                                    <th>आपूर्तिकर्ता</th>
                                    <th>आइटम</th>
                                    <th>कुल राशि</th>
                                    <th>तिथि</th>
                                    <th>एक्शन</th>
                                </tr>
                            </thead>
                            <tbody id="purchases-table-body">
                                <tr><td colspan="6" class="text-center text-muted">कोई खरीद रिकॉर्ड नहीं मिला</td></tr>
                            </tbody>
                            <tfoot id="purchases-table-foot"></tfoot> 
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="crm" class="section">
            <h2 class="mb-4 text-primary">ग्राहक संबंध प्रबंधन (CRM)</h2>
            <div class="card mb-4">
                <div class="card-header">नया ग्राहक जोड़ें</div>
                <div class="card-body">
                    <form id="add-customer-form" class="row g-3">
                        <div class="col-md-4">
                            <label for="customer-name" class="form-label">नाम</label>
                            <input type="text" class="form-control" id="customer-name" required>
                        </div>
                        <div class="col-md-4">
                            <label for="customer-phone" class="form-label">फ़ोन नंबर</label>
                            <input type="tel" class="form-control" id="customer-phone">
                        </div>
                        <div class="col-md-4">
                            <label for="customer-email" class="form-label">ईमेल (वैकल्पिक)</label>
                            <input type="email" class="form-control" id="customer-email">
                        </div>
                        <div class="col-12">
                            <label for="customer-address" class="form-label">पता (Address)</label>
                            <textarea class="form-control" id="customer-address" rows="1"></textarea>
                        </div>
                         <div class="col-md-6">
                            <label for="customer-gstin" class="form-label">GSTIN (वैकल्पिक)</label>
                            <input type="text" class="form-control" id="customer-gstin" maxlength="15">
                        </div>
                        <div class="col-md-6">
                            <label for="customer-balance" class="form-label">पिछला बकाया (₹)</label>
                            <input type="number" step="0.01" class="form-control" id="customer-balance" value="0" min="0">
                        </div>
                       <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-primary w-100">ग्राहक को जोड़ें</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="card">
                <div class="card-header">ग्राहक सूची</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>नाम</th>
                                    <th>फ़ोन</th>
                                    <th>पता</th>
                                    <th>जोड़ा गया</th>
                                    <th>एक्शन</th>
                                </tr>
                            </thead>
                            <tbody id="crm-table-body">
                                <tr><td colspan="6" class="text-center text-muted">कोई ग्राहक नहीं मिला</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="expenses" class="section">
            <h2 class="mb-4 text-primary">खर्च प्रबंधन</h2>
            <div class="card mb-4">
                <div class="card-header">नया खर्च दर्ज करें</div>
                <div class="card-body">
                    <form id="add-expense-form" class="row g-3">
                        <div class="col-md-4">
                            <label for="expense-date" class="form-label">तिथि</label>
                            <input type="date" class="form-control" id="expense-date" value="" required>
                        </div>
                        <div class="col-md-4">
                            <label for="expense-category" class="form-label">श्रेणी</label>
                            <select class="form-select" id="expense-category" required>
                                <option value="" disabled selected>श्रेणी चुनें</option>
                                <option value="Salary">वेतन (Salary)</option>
                                <option value="Rent">किराया (Rent)</option>
                                <option value="Utilities">यूटिलिटीज (बिजली/पानी)</option>
                                <option value="Marketing">मार्केटिंग</option>
                                <option value="Miscellaneous">विविध</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="expense-amount" class="form-label">राशि (₹)</label>
                            <input type="number" step="0.01" class="form-control" id="expense-amount" required min="0">
                        </div>
                        <div class="col-12">
                            <label for="expense-description" class="form-label">विवरण</label>
                            <input type="text" class="form-control" id="expense-description" required>
                        </div>
                        <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-warning w-100">खर्च दर्ज करें</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="card">
                <div class="card-header">खर्च का इतिहास</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>तिथि</th>
                                    <th>श्रेणी</th>
                                    <th>विवरण</th>
                                    <th>राशि</th>
                                    <th>एक्शन</th>
                                </tr>
                            </thead>
                            <tbody id="expenses-table-body">
                                <tr><td colspan="5" class="text-center text-muted">कोई खर्च रिकॉर्ड नहीं मिला</td></tr>
                            </tbody>
                            <tfoot id="expenses-table-foot"></tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="reports" class="section">
            <h2 class="mb-4 text-primary">रिपोर्ट्स और एनालिटिक्स</h2>
            <div class="row g-4">
                <div class="col-lg-12 mb-4">
                    <div class="card" id="pl-card">
                        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                            <span>लाभ और हानि (Profit & Loss)</span>
                            <div class="no-print">
                                <button class="btn btn-sm btn-light me-2" onclick="handleReportAction('profit_loss', 'download')"><i class="fas fa-file-download"></i> डाउनलोड</button>
                                <button class="btn btn-sm btn-light" onclick="handleReportAction('profit_loss', 'print')"><i class="fas fa-print"></i> प्रिंट</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-sm report-table">
                                        <thead><tr><th colspan="2" class="text-center">खर्च (Debit)</th></tr></thead>
                                        <tbody>
                                            <tr><td>कुल खरीद (Purchases)</td><td class="text-end" id="report-pl-purchases">₹0.00</td></tr>
                                            <tr><td>कुल खर्च (Expenses)</td><td class="text-end" id="report-pl-expenses">₹0.00</td></tr>
                                            <tr id="report-pl-profit-row" class="d-none"><td><b>शुद्ध लाभ (Net Profit)</b></td><td class="text-end fw-bold text-success" id="report-pl-profit">₹0.00</td></tr>
                                        </tbody>
                                        <tfoot>
                                            <tr class="fw-bold bg-light"><td >कुल डेबिट</td><td class="text-end" id="report-pl-total-debit">₹0.00</td></tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <table class="table table-sm report-table">
                                        <thead><tr><th colspan="2" class="text-center">आय (Credit)</th></tr></thead>
                                        <tbody>
                                            <tr><td>कुल बिक्री (Revenue)</td><td class="text-end" id="report-pl-revenue">₹0.00</td></tr>
                                            <tr id="report-pl-loss-row" class="d-none"><td><b>शुद्ध हानि (Net Loss)</b></td><td class="text-end fw-bold text-danger" id="report-pl-loss">₹0.00</td></tr>
                                        </tbody>
                                        <tfoot>
                                            <tr class="fw-bold bg-light"><td>कुल क्रेडिट</td><td class="text-end" id="report-pl-total-credit">₹0.00</td></tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-12">
                    <div class="card" id="bs-card">
                        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                            <span>बैलेंस शीट (Balance Sheet)</span>
                             <div class="no-print">
                                <button class="btn btn-sm btn-light me-2" onclick="handleReportAction('balance_sheet', 'download')"><i class="fas fa-file-download"></i> डाउनलोड</button>
                                <button class="btn btn-sm btn-light" onclick="handleReportAction('balance_sheet', 'print')"><i class="fas fa-print"></i> प्रिंट</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-sm report-table">
                                        <thead><tr><th colspan="2" class="text-center">देनदारियां और इक्विटी (Liabilities & Equity)</th></tr></thead>
                                        <tbody>
                                            <tr><td>GST जमा करने योग्य (Payable)</td><td class="text-end" id="report-bs-gst-payable">₹0.00</td></tr>
                                            <tr><td>वेंडर को देय (Payable)</td><td class="text-end" id="report-bs-vendors-payable">₹0.00</td></tr>
                                            <tr><td>मालिक की इक्विटी (Owner's Equity)</td><td class="text-end" id="report-bs-owner-equity">₹0.00</td></tr>
                                        </tbody>
                                        <tfoot>
                                            <tr class="fw-bold bg-light"><td>कुल देनदारियां और इक्विटी</td><td class="text-end" id="report-bs-total-liabilities">₹0.00</td></tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                     <table class="table table-sm report-table">
                                        <thead><tr><th colspan="2" class="text-center">परिसंपत्तियां (Assets)</th></tr></thead>
                                        <tbody>
                                            <tr><td>स्टॉक का मूल्य (Stock Value)</td><td class="text-end" id="report-bs-stock-value">₹0.00</td></tr>
                                            <tr><td>बैंक/कैश बैलेंस (Profit)</td><td class="text-end" id="report-bs-cash-balance">₹0.00</td></tr>
                                        </tbody>
                                        <tfoot>
                                            <tr class="fw-bold bg-light"><td>कुल परिसंपत्तियां</td><td class="text-end" id="report-bs-total-assets">₹0.00</td></tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-12">
                    <div class="card" id="product-sales-card">
                        <div class="card-header bg-dark text-white">
                            <span>उत्पाद-वार बिक्री और लाभ (Product-wise Sales & Profit)</span>
                        </div>
                        <div class="card-body">
                            <div class="row g-3 mb-3">
                                <div class="col-md-5">
                                    <label for="product-report-start-date" class="form-label">शुरूआती तारीख</label>
                                    <input type="date" id="product-report-start-date" class="form-control">
                                </div>
                                <div class="col-md-5">
                                    <label for="product-report-end-date" class="form-label">अंतिम तारीख</label>
                                    <input type="date" id="product-report-end-date" class="form-control">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" id="fetch-product-sales-report-btn">रिपोर्ट देखें</button>
                                </div>
                            </div>
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>SKU</th>
                                            <th>आइटम</th>
                                            <th>मात्रा बिकी</th>
                                            <th>कुल रेवेन्यू</th>
                                            <th>कुल लागत</th>
                                            <th>कुल लाभ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="product-sales-report-body">
                                        <tr><td colspan="6" class="text-center text-muted">कृपया तारीख चुनें और 'रिपोर्ट देखें' पर क्लिक करें।</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="staff" class="section">
            <h2 class="mb-4 text-primary">स्टाफ प्रबंधन (एडमिन)</h2>
            
            <div class="card mb-4">
                <div class="card-header bg-success text-white">नया स्टाफ सदस्य जोड़ें</div>
                <div class="card-body">
                    <form id="add-staff-form" class="row g-3">
                        <div class="col-md-4">
                            <label for="staff-name" class="form-label">नाम</label>
                            <input type="text" class="form-control" id="staff-name" required placeholder="जैसे: राहुल कुमार">
                        </div>
                        <div class="col-md-4">
                            <label for="staff-email" class="form-label">ईमेल</label>
                            <input type="email" class="form-control" id="staff-email" required placeholder="जैसे: rahul@example.com">
                        </div>
                        <div class="col-md-4">
                            <label for="staff-password" class="form-label">पासवर्ड</label>
                            <input type="password" class="form-control" id="staff-password" required placeholder="एक मजबूत पासवर्ड चुनें">
                        </div>
                        <div class="col-md-6">
                            <label for="staff-role" class="form-label">रोल (भूमिका)</label>
                            <select id="staff-role" class="form-select">
                                <option value="CASHIER" selected>कैशियर (Cashier)</option>
                                <option value="MANAGER">मैनेजर (Manager)</option>
                                <option value="ADMIN">एडमिन (Admin)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="staff-status" class="form-label">स्थिति (Status)</label>
                            <select id="staff-status" class="form-select">
                                <option value="pending" selected>पेंडिंग (Pending)</option>
                                <option value="active">सक्रिय (Active)</option>
                                <option value="disabled">अक्षम (Disabled)</option>
                            </select>
                        </div>
                        <div class="col-12 mt-3">
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-user-plus me-2"></i>स्टाफ सदस्य जोड़ें
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        
            <div class="card">
                <div class="card-header">मौजूदा स्टाफ सदस्य</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>नाम</th>
                                    <th>ईमेल</th>
                                    <th>रोल</th>
                                    <th>स्थिति</th>
                                    <th>बनाया गया</th>
                                    <th>एक्शन</th>
                                </tr>
                            </thead>
                            <tbody id="staff-table-body">
                                <tr><td colspan="7" class="text-center text-muted py-4">स्टाफ सूची लोड हो रही है...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        
            <div class="modal fade" id="editStaffModal" tabindex="-1" aria-labelledby="editStaffModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="editStaffModalLabel">
                        <i class="fas fa-user-edit me-2"></i>स्टाफ सदस्य संपादित करें
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <form id="edit-staff-form">
                      <div class="modal-body">
                          <input type="hidden" id="edit-staff-id">
                          <div class="mb-3">
                              <label for="edit-staff-name" class="form-label">नाम</label>
                              <input type="text" class="form-control" id="edit-staff-name" required>
                          </div>
                          <div class="mb-3">
                              <label for="edit-staff-email" class="form-label">ईमेल (बदला नहीं जा सकता)</label>
                              <input type="email" class="form-control" id="edit-staff-email" disabled readonly>
                          </div>
                          <div class="mb-3">
                            <label for="edit-staff-role" class="form-label">रोल (भूमिका)</label>
                            <select id="edit-staff-role" class="form-select">
                                <option value="CASHIER">कैशियर (Cashier)</option>
                                <option value="MANAGER">मैनेजर (Manager)</option>
                                <option value="ADMIN">एडमिन (Admin)</option>
                            </select>
                          </div>
                          <div class="mb-3">
                            <label for="edit-staff-status" class="form-label">स्थिति (Status)</label>
                            <select id="edit-staff-status" class="form-select">
                                <option value="pending">पेंडिंग (Pending)</option>
                                <option value="active">सक्रिय (Active)</option>
                                <option value="disabled">अक्षम (Disabled)</option>
                            </select>
                          </div>
                           <div class="mb-3">
                              <label for="edit-staff-password" class="form-label">नया पासवर्ड (अगर बदलना है)</label>
                              <input type="password" class="form-control" id="edit-staff-password" placeholder="खाली छोड़ दें अगर नहीं बदलना है">
                              <div class="form-text">पासवर्ड बदलने की सुविधा सर्वर पर लागू होने पर काम करेगी।</div>
                          </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">रद्द करें</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>बदलाव सेव करें
                        </button>
                      </div>
                  </form>
                </div>
              </div>
            </div>
        </section>

        <section id="gst-reports" class="section">
            <h2 class="mb-4 text-primary">GST रिपोर्ट्स (Simplified)</h2>
            <p class="text-muted">ये आपके सर्वर द्वारा प्रदान की गई सरलीकृत (simplified) GST रिपोर्ट हैं। </p>
            
            <div class="card">
                <div class="card-header">रिपोर्ट्स जेनरेट करें</div>
                <div class="card-body">
                    <div class="row g-3 mb-4">
                        <div class="col-md-5">
                            <label for="gst-report-start-date" class="form-label">शुरूआती तारीख</label>
                            <input type="date" id="gst-report-start-date" class="form-control" value="">
                        </div>
                        <div class="col-md-5">
                            <label for="gst-report-end-date" class="form-label">अंतिम तारीख</label>
                            <input type="date" id="gst-report-end-date" class="form-control" value="">
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <button class="btn btn-info w-100" id="fetch-gstr1-report-btn">GSTR-1 (बिक्री) रिपोर्ट देखें</button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-warning w-100" id="fetch-gstr2-report-btn">GSTR-2 (खरीद) रिपोर्ट देखें</button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-secondary w-100" id="fetch-gstr3b-report-btn">GSTR-3B (सारांश) देखें</button>
                        </div>
                    </div>
                    <p class="text-muted small mt-3">नोट: यह GSTR रिपोर्ट आपके द्वारा 'बिक्री (POS)' और 'ग्राहक (CRM)' में दर्ज किए गए डेटा पर आधारित है। </p>

                    <hr class="my-4">
                    
                    <h5 id="gst-report-title">रिपोर्ट रिजल्ट</h5>
                    <div id="gst-report-result">
                        <div class="text-muted text-center py-4">कृपया तारीख चुनें और रिपोर्ट बटन पर क्लिक करें।</div>
                        
                        <div id="gstr1-report-template" style="display: none;">


                            
                           <!-- ============ TALLY-STYLE GST REPORT HTML START ============ -->
<!-- यह Tally-Style टैब लेआउट है -->

<!-- Tab Navigation (GSTR-1, 2, 3B) -->
<nav class="gst-report-tabs mt-4">
    <div class="nav nav-tabs" id="gstReportTab" role="tablist">
        <button class="nav-link active" id="gst-gstr1-tab" data-bs-toggle="tab" data-bs-target="#gst-gstr1" type="button" role="tab" aria-controls="gst-gstr1" aria-selected="true">
            GSTR-1 (बिक्री)
        </button>
        <button class="nav-link" id="gst-gstr2-tab" data-bs-toggle="tab" data-bs-target="#gst-gstr2" type="button" role="tab" aria-controls="gst-gstr2" aria-selected="false">
            GSTR-2 (खरीद ITC)
        </button>
        <button class="nav-link" id="gst-gstr3b-tab" data-bs-toggle="tab" data-bs-target="#gst-gstr3b" type="button" role="tab" aria-controls="gst-gstr3b" aria-selected="false">
            GSTR-3B (समरी)
        </button>
    </div>
</nav>

<!-- Tab Content (Main Body) -->
<div class="tab-content gst-report-tab-content" id="gstReportTabContent">
    
    <!-- GSTR-1 Pane (यह GSTR-1 बटन से जुड़ा है) -->
    <div class="tab-pane fade show active" id="gst-gstr1" role="tabpanel" aria-labelledby="gst-gstr1-tab">
        <div id="gstr1-report-content" class="report-content-area">
            <p class="text-muted text-center py-4">कृपया ऊपर दिए गए 'GSTR-1 (बिक्री) रिपोर्ट देखें' बटन पर क्लिक करें।</p>
            <!-- GSTR-1 डेटा JavaScript द्वारा यहाँ भरा जाएगा -->
        </div>
        
        <!-- GSTR-1 के लिए छिपा हुआ टेम्पलेट (JavaScript इसका इस्तेमाल करेगा) -->
        <div id="gstr1-report-template" style="display: none;">
            <nav class="gst-report-tabs">
                <div class="nav nav-tabs" id="gstr1-inner-tab" role="tablist">
                    <button class="nav-link active" id="gstr1-b2b-tab" data-bs-toggle="tab" data-bs-target="#gstr1-b2b" type="button" role="tab">B2B (GSTIN वाली बिक्री)</button>
                    <button class="nav-link" id="gstr1-b2c-tab" data-bs-toggle="tab" data-bs-target="#gstr1-b2c" type="button" role="tab">B2C (छोटी बिक्री)</button>
                    <button class="nav-link" id="gstr1-hsn-tab" data-bs-toggle="tab" data-bs-target="#gstr1-hsn" type="button" role="tab">HSN/SAC समरी</button>
                </div>
            </nav>
            <div class="tab-content gst-report-tab-content" id="gstr1-inner-tabContent">
                <div class="tab-pane fade show active" id="gstr1-b2b" role="tabpanel">
                    <h6>GSTR-1: B2B (पंजीकृत ग्राहकों को बिक्री)</h6>
                    <p class="small text-muted">वह बिक्री जहाँ ग्राहक का GSTIN दर्ज किया गया था।</p>
                    <div class="table-responsive">
                        <table class="table gst-report-table" id="gstr1-b2b-table">
                            <thead><tr><th>ग्राहक GSTIN</th><th class="text-left">ग्राहक का नाम</th><th>इनवॉइस नं.</th><th>इनवॉइस तारीख</th><th>टैक्सेबल वैल्यू (₹)</th><th>IGST (₹)</th><th>CGST (₹)</th><th>SGST (₹)</th></tr></thead>
                            <tbody></tbody>
                            <tfoot></tfoot>
                        </table>
                    </div>
                </div>
                <div class="tab-pane fade" id="gstr1-b2c" role="tabpanel">
                    <h6>GSTR-1: B2C(S) (छोटी बिक्री समरी)</h6>
                    <p class="small text-muted">वह बिक्री जहाँ ग्राहक का GSTIN दर्ज नहीं किया गया था (राज्य और GST दर के अनुसार)।</p>
                    <div class="table-responsive">
                        <table class="table gst-report-table" id="gstr1-b2c-table">
                            <thead><tr><th class="text-left">सप्लाई का राज्य</th><th>GST दर (%)</th><th>टैक्सेबल वैल्यू (₹)</th><th>IGST (₹)</th><th>CGST (₹)</th><th>SGST (₹)</th><th>कुल टैक्स (₹)</th></tr></thead>
                            <tbody></tbody>
                            <tfoot></tfoot>
                        </table>
                    </div>
                </div>
                <div class="tab-pane fade" id="gstr1-hsn" role="tabpanel">
                    <h6>GSTR-1: HSN/SAC समरी (बिक्री)</h6>
                    <p class="small text-muted">बेचे गए आइटम की HSN कोड के अनुसार समरी।</p>
                    <div class="table-responsive">
                        <table class="table gst-report-table" id="gstr1-hsn-table">
                            <thead><tr><th>HSN कोड</th><th class="text-left">आइटम का नाम</th><th>यूनिट</th><th>मात्रा (Qty)</th><th>टैक्सेबल वैल्यू (₹)</th><th>IGST (₹)</th><th>CGST (₹)</th><th>SGST (₹)</th><th>कुल टैक्स (₹)</th></tr></thead>
                            <tbody></tbody>
                            <tfoot></tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GSTR-2 Pane (यह GSTR-2 बटन से जुड़ा है) -->
    <div class="tab-pane fade" id="gst-gstr2" role="tabpanel" aria-labelledby="gst-gstr2-tab">
        <div id="gstr2-report-content" class="report-content-area">
            <p class="text-muted text-center py-4">कृपया ऊपर दिए गए 'GSTR-2 (खरीद) रिपोर्ट देखें' बटन पर क्लिक करें।</p>
            <!-- GSTR-2 डेटा JavaScript द्वारा यहाँ भरा जाएगा -->
        </div>
    </div>

    <!-- GSTR-3B Pane (यह GSTR-3B बटन से जुड़ा है) -->
    <div class="tab-pane fade" id="gst-gstr3b" role="tabpanel" aria-labelledby="gst-gstr3b-tab">
        <div id="gstr3b-report-content" class="report-content-area">
            <p class="text-muted text-center py-4">कृपया ऊपर दिए गए 'GSTR-3B (सारांश) देखें' बटन पर क्लिक करें।</p>
            <!-- GSTR-3B डेटा JavaScript द्वारा यहाँ भरा जाएगा -->
        </div>
    </div>
</div>
</section>
<!-- ============ TALLY-STYLE GST REPORT HTML END ============ -->


<section id="bank-reconciliation" class="section">
    <h2 class="mb-4 text-primary">बैंक रिकॉन्सिलेशन</h2>
    
    <div class="card mb-4" id="reconciliation-setup">
        <div class="card-header">
            नया रिकॉन्सिलेशन शुरू करें
        </div>
        <div class="card-body">
            <form id="reconciliation-start-form">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="recon-statement-date" class="form-label">बैंक स्टेटमेंट की अंतिम तिथि</label>
                        <input type="date" class="form-control" id="recon-statement-date" required>
                    </div>
                    <div class="col-md-4">
                        <label for="recon-statement-balance" class="form-label">स्टेटमेंट का अंतिम बैलेंस (₹)</label>
                        <input type="number" step="0.01" class="form-control" id="recon-statement-balance" required>
                    </div>
                    <div class="col-md-4">
                        <label for="recon-statement-csv" class="form-label">बैंक स्टेटमेंट अपलोड करें (.csv)</label>
                        <input type="file" class="form-control" id="recon-statement-csv" accept=".csv" required>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <p class="text-muted small">यह फ़ाइल आप अपने बैंक की नेट बैंकिंग वेबसाइट पर 'Account Statement' > 'Download Statement' सेक्शन से CSV फॉर्मेट में डाउनलोड कर सकते हैं। कृपया सुनिश्चित करें कि उसमें 'Date', 'Description', 'Debit'/'Withdrawal', और 'Credit'/'Deposit' कॉलम हों।
                    </div>
                </div>
                <hr>
                <div class="text-end">
                    <button type="submit" class="btn btn-primary btn-lg" id="start-reconciliation-btn">
                        <i class="fas fa-play me-2"></i> रिकॉन्सिलेशन शुरू करें
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="reconciliation-matching-area" class="hidden">
        <h3 class="mb-3">एंट्रीज़ का मिलान करें</h3>
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        Dukan Pro (बुक) ट्रांजैक्शन
                        <span id="book-total" class="badge bg-light text-dark float-end">₹0.00</span>
                    </div>
                    <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="check-all-book"></th>
                                    <th>विवरण</th>
                                    <th>राशि (₹)</th>
                                </tr>
                            </thead>
                            <tbody id="book-transactions-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        बैंक स्टेटमेंट ट्रांजैक्शन
                        <span id="bank-total" class="badge bg-light text-dark float-end">₹0.00</span>
                    </div>
                    <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="check-all-bank"></th>
                                    <th>विवरण</th>
                                    <th>राशि (₹)</th>
                                </tr>
                            </thead>
                            <tbody id="bank-transactions-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header bg-dark text-white">
                रिकॉन्सिलेशन रिपोर्ट (सारांश)
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <table class="table" id="reconciliation-report-table">
                            <tbody>
                                <tr>
                                    <td>बैंक स्टेटमेंट का अंतिम बैलेंस</td>
                                    <td class="text-end" id="report-statement-balance">₹0.00</td>
                                </tr>
                                <tr>
                                    <td>वे पेमेंट्स जो अभी क्लियर नहीं हुए (Uncleared Payments)</td>
                                    <td class="text-end" id="report-uncleared-payments">₹0.00</td>
                                </tr>
                                <tr>
                                    <td>वे डिपॉजिट जो अभी क्लियर नहीं हुए (Uncleared Deposits)</td>
                                    <td class="text-end" id="report-uncleared-deposits">₹0.00</td>
                                </tr>
                                <tr class="fw-bold">
                                    <td>Dukan Pro (बुक) में एडजस्टेड बैलेंस</td>
                                    <td class="text-end" id="report-adjusted-balance">₹0.00</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-4 d-flex align-items-center justify-content-center">
                        <div id="reconciliation-status-box" class="p-3 text-center">
                            <h4 id="difference-amount" class="text-danger fw-bold">₹0.00 का अंतर</h4>
                            <p id="difference-status" class="text-muted">बैलेंस मैच नहीं हुआ</p>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="text-end">
                    <button class="btn btn-secondary" id="cancel-reconciliation-btn">रद्द करें</button>
                    <button class="btn btn-success" id="save-reconciliation-btn" disabled>
                        <i class="fas fa-save me-2"></i> रिपोर्ट सेव करें
                    </button>
                </div>
            </div>
        </div>
    </div> 
    <div class="card mt-4" id="previous-reports-area">
        <div class="card-header bg-secondary text-white">
            पिछली रिकॉन्सिलेशन रिपोर्ट्स
        </div>
        <div class="card-body">
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>रिपोर्ट ID</th>
                            <th>स्टेटमेंट की तारीख</th>
                            <th>बैंक बैलेंस (₹)</th>
                            <th>अनक्लियरर्ड अमाउंट (₹)</th>
                            <th>सेव की गई तारीख</th>
                        </tr>
                    </thead>
                    <tbody id="previous-reports-body">
                        <tr><td colspan="5" class="text-center text-muted">कोई पुरानी रिपोर्ट नहीं मिली।</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    </section>

        <section id="daily-closing" class="section">
            <h2 class="mb-4 text-primary">डेली क्लोजिंग</h2>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header bg-success text-white">आज की क्लोजिंग रन करें</div>
                        <div class="card-body text-center">
                            <p>आज की सभी बिक्री, खर्च और लाभ को फाइनल करने के लिए क्लोजिंग रन करें।</p>
                            <button class="btn btn-success btn-lg" id="run-daily-closing-btn">
                                <i class="fas fa-play-circle me-2"></i> आज की क्लोजिंग रन करें
                            </button>
                            <div id="closing-message" class="mt-3"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">पिछली क्लोजिंग रिपोर्ट्स</div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>तारीख</th>
                                            <th>कुल बिक्री</th>
                                            <th>कुल लागत (COGS)</th>
                                            <th>कुल खर्च</th>
                                            <th>शुद्ध लाभ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="daily-closing-table-body">
                                        <tr><td colspan="5" class="text-center text-muted">कोई रिपोर्ट नहीं मिली।</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="data-backup" class="section">
            <h2 class="mb-4 text-primary">डेटा बैकअप (एडमिन)</h2>
            <div class="card">
                <div class="card-header">अपना डेटा डाउनलोड करें</div>
                <div class="card-body">
                    <p>यहाँ आप अपनी शॉप का पूरा डेटा बैकअप या विशिष्ट रिपोर्ट डाउनलोड कर सकते हैं।</p>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="card p-3 text-center">
                                <h5>फुल शॉप बैकअप (JSON)</h5>
                                <p class="small text-muted">स्टॉक, ग्राहक, बिक्री, खर्च आदि सब कुछ। (तकनीकी उपयोग के लिए)</p>
                                <button class="btn btn-primary" id="download-json-backup-btn">
                                    <i class="fas fa-file-code"></i> JSON डाउनलोड करें
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card p-3 text-center">
                                <h5>फुल शॉप बैकअप (Excel)</h5>
                                <p class="small text-muted">सभी डेटा एक Excel फ़ाइल में (अलग-अलग शीट्स में)।</p>
                                <button class="btn btn-success" id="download-excel-backup-btn">
                                    <i class="fas fa-file-excel"></i> Excel (.xlsx) डाउनलोड करें
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card p-3 text-center">
                                <h5>उत्पाद बिक्री रिपोर्ट (CSV)</h5>
                                <p class="small text-muted">तारीख-वार उत्पाद बिक्री रिपोर्ट (CSV फॉर्मेट)।</p>
                                <button class="btn btn-info" id="download-product-sales-csv-btn">
                                    <i class="fas fa-file-csv"></i> CSV डाउनलोड करें
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="shop-settings" class="section">
            <h2 class="mb-4 text-primary">शॉप सेटिंग्स (एडमिन)</h2>
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-info">कंपनी प्रोफाइल (GST और इनवॉइस के लिए)</div>
                        <div class="card-body">
                            <form id="company-profile-form">
                                <div class="mb-3">
                                    <label for="company-legal-name" class="form-label">शॉप का कानूनी नाम</label>
                                    <input type="text" class="form-control" id="company-legal-name">
                                </div>
                                <div class="mb-3">
                                    <label for="company-gstin" class="form-label">शॉप का GSTIN</label>
                                    <input type="text" class="form-control" id="company-gstin" maxlength="15">
                                </div>
                                <div class="mb-3">
                                    <label for="company-address" class="form-label">शॉप का पता</label>
                                    <textarea class="form-control" id="company-address" rows="2"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="company-opening-capital" class="form-label">ओपनिंग कैपिटल (शुरुआती पूंजी)</label>
                                    <input type="number" step="0.01" class="form-control" id="company-opening-capital" value="0" min="0">
                                </div>
                                <button type="submit" class="btn btn-primary w-100">प्रोफाइल सेव करें</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">शॉप डिस्प्ले सेटिंग्स</div>
                        <div class="card-body">
                            <form id="shop-display-form">
                                <div class="mb-3">
                                    <label for="shop-display-name" class="form-label">शॉप का डिस्प्ले नाम</label>
                                    <input type="text" class="form-control" id="shop-display-name">
                                    <div class="form-text">यह नाम साइडबार में सबसे ऊपर दिखाई देगा।</div>
                                </div>
                                <div class="mb-3">
                                    <label for="shop-logo-upload" class="form-label">शॉप लोगो (वैकल्पिक)</label>
                                    <input type="file" class="form-control" id="shop-logo-upload" accept="image/png, image/jpeg">
                                    <div class="form-text">सबसे अच्छे रिजल्ट के लिए 1:1 (स्क्वायर) इमेज अपलोड करें।</div>
                                    <img id="shop-logo-preview" src="" alt="Logo Preview" class="img-thumbnail mt-2" style="max-height: 100px; display: none;">
                                </div>
                                    <button type="button" id="remove-shop-logo-btn" class="btn btn-sm btn-outline-danger mt-2 d-none" onclick="removeShopLogo()">
                                    <i class="fas fa-trash"></i> लोगो हटाएँ
                                </button>
                                <button type="submit" class="btn btn-primary w-100">डिस्प्ले सेव करें</button>
                            </form>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="appToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto" id="toast-title"></strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body" id="toast-body">
                    Hello, world! This is a toast message.
                </div>
            </div>
        </div>
		
		
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="./qrcode.min.js"></script>


<script>
    // --- CONFIGURATION AND GLOBAL STATE ---
   // --- CONFIGURATION AND GLOBAL STATE ---
// --- CONFIGURATION AND GLOBAL STATE ---
    // ... (अन्य वेरिएबल्स) ...
    let posWebSocket = null;
    let qrCodeDataUrl = null; // 🚀 नया: QR कोड इमेज डेटा रखने के लिए
    let isWaitingForQr = false; // 🚀 नया: बताएगा कि QR का इंतज़ार हो रहा है
    
    function isMobile() {
        try {
            if (navigator.userAgentData && navigator.userAgentData.mobile) return true;
        } catch (e) { /* जारी रखें */ }
        return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    }
    
   
// [ initPosWebSocket फ़ंक्शन को इस कोड से बदल दें ]

// [ यह initPosWebSocket फ़ंक्शन का नया कोड है ]

function initPosWebSocket() {
    if (posWebSocket && posWebSocket.readyState === WebSocket.OPEN) {
        // अगर पहले से खुला है, तो बस नया कोड माँगें और UI रीसेट करें
        const spinner = document.getElementById('inline-pairing-spinner');
        const codeDisplay = document.getElementById('inline-pairing-code');
        const statusDisplay = document.getElementById('inline-pairing-status');
        if(spinner) spinner.style.display = 'inline-block';
        if(codeDisplay) codeDisplay.textContent = '------';
        if(statusDisplay) statusDisplay.style.display = 'none';
        posWebSocket.send(JSON.stringify({ type: 'REGISTER_POS', token: AppState.token }));
        return;
    }

    const wsUrl = __backend_url.replace('https', 'wss').replace('http', 'ws');
    posWebSocket = new WebSocket(wsUrl);

    posWebSocket.onopen = () => {
        console.log("POS WebSocket Connected");
        posWebSocket.send(JSON.stringify({ type: 'REGISTER_POS', token: AppState.token }));
    };

   // [ पुराना onmessage बदलें ]
posWebSocket.onmessage = (event) => {
    const data = JSON.parse(event.data);

    // इनलाइन एलिमेंट्स को ढूँढें
    const codeDisplay = document.getElementById('inline-pairing-code');
    const spinner = document.getElementById('inline-pairing-spinner');
    const statusDisplay = document.getElementById('inline-pairing-status');
    const inlineBox = document.getElementById('inline-pairing-box'); // Need inlineBox too

    // सुरक्षा जाँच
    if (!codeDisplay || !spinner || !statusDisplay || !inlineBox) { // Check all 4
         console.error("❌ Fatal Error: Inline pairing elements missing in onmessage!");
         return; 
    }

    switch (data.type) {
        case 'PAIR_CODE_GENERATED':
            console.log("PAIR_CODE_GENERATED प्राप्त हुआ:", data.pairCode);
            codeDisplay.textContent = data.pairCode; // कोड सेट करें
            spinner.style.display = 'none'; // स्पिनर छिपाएँ
            statusDisplay.style.display = 'none'; 
            codeDisplay.style.display = 'inline-block'; // सुनिश्चित करें कि कोड दिखे
            inlineBox.style.display = 'block'; // सुनिश्चित करें कि बॉक्स दिखे
            break;

        case 'SCANNER_PAIRED':
            console.log("स्कैनर पेयर हो गया!");
            spinner.style.display = 'none';
            codeDisplay.style.display = 'none'; 
            statusDisplay.style.display = 'block'; 
            // setTimeout(() => { inlineBox.style.display = 'none'; }, 3000); 
            break;

        case 'SKU_SCANNED':
            console.log("SKU प्राप्त हुआ:", data.sku);
            handleBarcodeScan(data.sku); 
            break;

        case 'SCANNER_DISCONNECTED':
            console.log("स्कैनर डिस्कनेक्ट हो गया।");
            if(inlineBox) inlineBox.style.display = 'block'; 
            spinner.style.display = 'inline-block'; 
            codeDisplay.textContent = '------'; 
            codeDisplay.style.display = 'inline-block'; // Re-show display span
            statusDisplay.style.display = 'none'; 
            if (posWebSocket && posWebSocket.readyState === WebSocket.OPEN) {
               posWebSocket.send(JSON.stringify({ type: 'REGISTER_POS', token: AppState.token }));
            }
            break;
    }
};

posWebSocket.onclose = () => {
        console.log("POS WebSocket Disconnected");
        posWebSocket = null;
         const inlineBox = document.getElementById('inline-pairing-box');
         if(inlineBox) inlineBox.style.display = 'none';
    };
    posWebSocket.onerror = (error) => {
         console.error("WebSocket Error:", error);
         const inlineBox = document.getElementById('inline-pairing-box');
         if(inlineBox) {
             inlineBox.innerHTML = '<p class="text-danger small">कनेक्शन त्रुटि।</p>';
             inlineBox.style.display = 'block';
         }
    };
}
// [ closePosWebSocket फ़ंक्शन बदलें ]
function closePosWebSocket() {
    if (posWebSocket) {
        posWebSocket.close();
        posWebSocket = null;
        console.log("WebSocket connection closed.");
    }
    // सिर्फ इनलाइन बॉक्स छिपाएँ
    const inlineBox = document.getElementById('inline-pairing-box');
    if(inlineBox) inlineBox.style.display = 'none';
}


// [ इसे इससे बदलें ]
    function closePosWebSocket() {
        // WebSocket बंद करें (अगर खुला है)
        if (posWebSocket) {
            posWebSocket.close();
            posWebSocket = null;
            console.log("WebSocket connection closed by user.");
        }
        
        // 🚀 नया: Modal को भी बंद करें (अगर खुला है)
        if (pairingModalInstance) {
            pairingModalInstance.hide();
            console.log("Pairing modal hidden.");
        }
    }



   const __backend_url = 'https://dukan-pro-ultimate.onrender.com';
    const SERVER_TIMEOUT = 20000; // 20 seconds for slow connections
    const AppState = {
        token: null,     // Will store the JWT
        user: null,      // Will store user info (id, email, role, shopId)
        currentView: 'dashboard',
        licenseTimerId: null, // NEW: To store the license timer
    };
    
    // --- INVOICE GENERATOR PRO VARIABLES ---
    let items = [];
    let qrCodeImage = '';

    // --- POS (SALES) SECTION STATE ---
    let posCart = [];
    let currentStock = [];
    
    // --- CORE UTILITY FUNCTIONS ---
    const showLoader = (message = 'डेटा लोड हो रहा है...') => {
        document.getElementById('loading-message').innerText = message;
        document.getElementById('loading-overlay').classList.remove('hidden');
    };

    const hideLoader = () => {
        document.getElementById('loading-overlay').classList.add('hidden');
    };
    
// ==========================================================

// --- 🚀 नया: मोबाइल डिटेक्शन फ़ंक्शन ---


// ========== बारकोड स्कैनिंग और POS लॉजिक (CORE) ==========
// ==========================================================

// --- POS Section State (सुनिश्चित करें कि ये वेरिएबल्स मौजूद हैं) ---

/**
 * SKU (बारकोड) को कार्ट में जोड़ने का मुख्य फ़ंक्शन।
 */
function addSKUToCart(sku) {
    const selectedItem = currentStock.find(item => item.sku === sku);
        
    if (selectedItem) {
        // स्टॉक की मात्रा जाँचें
        if(selectedItem.quantity <= 0) {
            return showMessage('स्टॉक नहीं है', `${selectedItem.name} स्टॉक में समाप्त हो गया है।`, 'danger');
        }
        
        const existingCartItem = posCart.find(item => item.sku === sku);
        if (existingCartItem) {
            // कार्ट के मुकाबले स्टॉक की जाँच करें
            if(existingCartItem.quantity >= selectedItem.quantity) {
                return showMessage('स्टॉक सीमित है', `आपके पास स्टॉक में केवल ${selectedItem.quantity} ${selectedItem.name} हैं।`, 'warning');
            }
            existingCartItem.quantity++;
        } else {
            posCart.push({ 
                ...selectedItem, 
                quantity: 1,
                purchase_price: parseFloat(selectedItem.purchase_price || 0),
                gst: parseFloat(selectedItem.gst || 0),
                sale_price: parseFloat(selectedItem.sale_price || 0)
            });
        }
        updatePOSCartView(); // Cart view अपडेट करें
    } else {
         showMessage('नहीं मिला', `SKU ${sku} स्टॉक में नहीं मिला।`, 'warning');
    }
    
    // इनपुट साफ करें और रि-फोकस करें (यह सुनिश्चित करेगा कि अगला स्कैन काम करे)
    document.getElementById('pos-item-search').value = '';
    document.getElementById('pos-search-results').innerHTML = '';
    document.getElementById('pos-item-search').focus();
}


/**
 * स्कैन किए गए डेटा को हैंडल करने वाला फ़ंक्शन।
 */
// बदलने वाला कोड: handleBarcodeScan (पूरा फंक्शन बदलें)
// यह सुनिश्चित करता है कि यह फ़ंक्शन इनपुट से या मोबाइल स्कैनर से SKU स्वीकार करता है।
async function handleBarcodeScan(skuFromScanner = null) {
    let sku;
    
    // चेक करें कि SKU मोबाइल स्कैनर या फिजिकल इनपुट से आया है
    if (skuFromScanner) {
        sku = skuFromScanner;
    } else {
        const barcodeInput = document.getElementById('barcode-scanner-input');
        sku = barcodeInput.value.trim();
        barcodeInput.value = ''; // इनपुट को तुरंत साफ़ करें
    }

    if (!sku) return;

    const existingItemIndex = posCart.findIndex(item => item.sku === sku);

    if (existingItemIndex !== -1) {
        // आइटम पहले से कार्ट में है, मात्रा बढ़ाएँ
        posCart[existingItemIndex].quantity += 1;
        showMessage('कार्ट अपडेट', `${posCart[existingItemIndex].name} की मात्रा बढ़ी (+1)।`, 'success');
        updatePOSCartView();
        return;
    }

    // स्टॉक से आइटम डेटा लाएँ
    const stockItem = await fetchApi(`/api/get-stock-item/${sku}`);
    
    if (stockItem.success && stockItem.data) { // Ensure stockItem.data exists
        const item = stockItem.data; // Note: Ensure your API returns 'data' property
        if (item.quantity <= 0) {
            showMessage('स्टॉक अलर्ट', `${item.name} स्टॉक में नहीं है।`, 'warning');
            return;
        }
        
        posCart.push({
            sku: sku, // Use the provided SKU
            name: item.name,
            sale_price: parseFloat(item.sale_price),
            purchase_price: parseFloat(item.purchase_price || 0),
            gst: parseFloat(item.gst_rate || 0), // Use gst_rate from server
            quantity: 1
        });
        showMessage('सफलता', `${item.name} कार्ट में जोड़ा गया।`, 'success');
        updatePOSCartView();

    } else {
        showMessage('त्रुटि', `SKU ${sku} स्टॉक में नहीं मिला।`, 'danger');
    }
}



      
    // 🚀 नया: WebSocket शुरू करता है और इंतज़ार करता है
    function openMobileScanner() {
    const inlineBox = document.getElementById('inline-pairing-box');
    if (!inlineBox) {
        console.error("Inline pairing box not found!");
        return;
    }

    // बॉक्स दिखाएँ और UI रीसेट करें
    inlineBox.style.display = 'block';
    const spinner = document.getElementById('inline-pairing-spinner');
    const codeDisplay = document.getElementById('inline-pairing-code');
    const statusDisplay = document.getElementById('inline-pairing-status');
    if(spinner) spinner.style.display = 'inline-block'; // स्पिनर दिखाएँ
    if(codeDisplay) codeDisplay.textContent = '------'; // कोड रीसेट करें
    if(statusDisplay) statusDisplay.style.display = 'none'; // स्टेटस छिपाएँ

    // WebSocket शुरू करें (यह कोड जनरेट करने का अनुरोध भेजेगा)
    initPosWebSocket(); 
}
// नया फ़ंक्शन: पोस्ट मैसेज से प्राप्त SKU को प्रोसेस करता है
function processScannedSku(sku) {
    if (currentTab !== 'sales') {
        // अगर POS टैब खुला नहीं है, तो उसे खोलें
        currentTab = 'sales';
        renderContent(); 
    }
    // मुख्य हैंडलर को SKU भेजें
    handleBarcodeScan(sku); 
}


    function formatCurrency(amount) {
        if (amount === null || amount === undefined) return '₹0.00';
        return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 2 }).format(amount);
    }
    
    // NEW: Function to format dates as YYYY-MM-DD
    function getISODate(date = new Date()) {
        return date.toISOString().split('T')[0];
    }

    const showMessage = (title, body, type = 'primary') => {
        const toastElement = document.getElementById('appToast');
        const toastTitle = document.getElementById('toast-title');
        const toastBody = document.getElementById('toast-body');
        
        toastTitle.innerText = title;
        toastBody.innerText = body;
        toastElement.querySelector('.toast-header').className = `toast-header bg-${type} text-white`;
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
    };

    async function fetchApi(path, options = {}, loadingMessage = 'डेटा लोड हो रहा है...') {
        showLoader(loadingMessage);
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), SERVER_TIMEOUT);

        // 1. Get token from AppState or localStorage
        const token = AppState.token || localStorage.getItem('authToken');
        
        const headers = {
            'Content-Type': 'application/json',
            ...options.headers,
        };

        // 2. Add Authorization header if token exists [cite: 39]
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        // NEW: Handle file uploads ( FormData )
        let body = options.body;
        if (!(body instanceof FormData)) {
            // Keep default JSON behavior
            body = body ? JSON.stringify(body) : null;
        } else {
            // If body is FormData, remove Content-Type. Fetch API sets it automatically.
            delete headers['Content-Type'];
        }

        try {
            const response = await fetch(__backend_url + path, {
                ...options,
                headers: headers, // Use the new headers
                body: body, // Use the modified body
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);

            const responseData = await response.json().catch(() => ({}));

            if (!response.ok) {
                // 401/403 means token is bad or expired, log the user out
                if (response.status === 401 || response.status === 403) {
                    showMessage('सत्र समाप्त', 'आपका सत्र समाप्त हो गया है। कृपया पुनः लॉगिन करें।', 'danger');
                    logout(); // Log out the user
                }
                throw new Error(responseData.message || `सर्वर एरर: ${response.status}`);
            }
            
            return responseData; // Return the JSON data
            
        } catch (error) {
            if (error.name === 'AbortError') throw new Error('सर्वर से कनेक्ट होने में बहुत समय लगा।');
            throw error;
        } finally {
            hideLoader();
        }
    }


/**
 * एक साधारण CSV टेक्स्ट को JSON ऑब्जेक्ट ऐरे में पार्स करता है
 */
 function parseCSV(csvText) {
    const lines = csvText.split('\n');
    if (lines.length === 0) return [];
    
    // हेडर (Date, Description, Debit, Credit) का पता लगाएँ
    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
    
    // कॉलम इंडेक्स ढूँढें
    const dateIdx = headers.findIndex(h => h.includes('date'));
    const descIdx = headers.findIndex(h => h.includes('description') || h.includes('narration'));
    const debitIdx = headers.findIndex(h => h.includes('debit') || h.includes('withdrawal'));
    const creditIdx = headers.findIndex(h => h.includes('credit') || h.includes('deposit'));

    if (dateIdx === -1 || descIdx === -1 || debitIdx === -1 || creditIdx === -1) {
        showMessage('CSV एरर', 'CSV में Date, Description, Debit/Withdrawal, या Credit/Deposit कॉलम नहीं मिले।', 'danger');
        throw new Error('Invalid CSV headers');
    }

    const items = [];
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line) continue;
        
        const values = line.split(',');
        
        const dateStr = values[dateIdx];
        // तारीख को YYYY-MM-DD में बदलें (मान लें कि यह DD/MM/YYYY या MM/DD/YYYY है)
        let dateObj;
        if (dateStr.includes('/')) {
            const parts = dateStr.split('/');
            // मान लें कि यह MM/DD/YYYY है (इसे अपने बैंक के अनुसार बदलें)
            // अगर DD/MM/YYYY है, तो new Date(parts[2], parts[1] - 1, parts[0]) का उपयोग करें
            dateObj = new Date(parts[2], parts[0] - 1, parts[1]); 
        } else {
            dateObj = new Date(dateStr); // ISO 8601 (YYYY-MM-DD)
        }
        
        const debitAmount = parseFloat(values[debitIdx].replace(/[^0-9.]/g, '')) || 0;
        const creditAmount = parseFloat(values[creditIdx].replace(/[^0-9.]/g, '')) || 0;

        items.push({
            date: dateObj.toISOString().split('T')[0],
            description: values[descIdx],
            debit: debitAmount,
            credit: creditAmount
        });
    }
    return items;
}








    function updateBalanceSheet(data) {
    // अगर कोई डेटा नहीं आता है, तो फ़ंक्शन यहीं रुक जाएगा
    if (!data) return; 

    // --- देनदारियां और इक्विटी (Liabilities & Equity) अपडेट करें ---
    
    // GST जमा करने योग्य (Payable)
    document.getElementById('report-bs-gst-payable').innerText = formatCurrency(data.gstPayable || 0);
    
    // वेंडर को देय (Payable)
    document.getElementById('report-bs-vendors-payable').innerText = formatCurrency(data.vendorsPayable || 0);
    
    // मालिक की इक्विटी (Owner's Equity) = Net Profit
    document.getElementById('report-bs-owner-equity').innerText = formatCurrency(data.ownerEquity || 0);
    
    // कुल देनदारियां और इक्विटी
    document.getElementById('report-bs-total-liabilities').innerText = formatCurrency(data.totalLiabilitiesAndEquity || 0);

    // --- परिसंपत्तियां (Assets) अपडेट करें ---
    
    // स्टॉक का मूल्य (Stock Value)
    document.getElementById('report-bs-stock-value').innerText = formatCurrency(data.stockValue || 0);
    
    // कैश/बैंक बैलेंस (आपके मौजूदा बैकएंड में इसे ट्रैक नहीं किया गया है, इसलिए 0.00 रखें)
    document.getElementById('report-bs-cash-balance').innerText = formatCurrency(data.cashBalance || 0);
    
    // कुल परिसंपत्तियां
    document.getElementById('report-bs-total-assets').innerText = formatCurrency(data.totalAssets || 0);
    
    console.log('Balance Sheet data successfully updated in HTML with correct IDs.');
}



// NEW: Function to fetch and populate Company Profile into Invoice Generator
function fetchAndPopulateShopData() {
        console.log("Populating Shop Data for Invoice...");
        try {
            // 1. शॉप सेटिंग्स से डेटा उठाएँ
            const legalName = document.getElementById('company-legal-name').value;
            const gstin = document.getElementById('company-gstin').value;
            const address = document.getElementById('company-address').value;
            
            // 2. AppState (लॉग-इन यूज़र) से डेटा उठाएँ
            const displayName = AppState.user?.shopName || '';
            const mobile = AppState.user?.mobile || ''; // (यह सर्वर से आना चाहिए)

            // 3. इनवॉइस जनरेटर के फॉर्म में यह डेटा भरें
            document.getElementById('shopName').value = legalName || displayName; //
            document.getElementById('shopContact').value = mobile; //
            document.getElementById('shopAddress').value = address; //
            document.getElementById('shopGstin').value = gstin; //
            
            // 4. प्रीव्यू को तुरंत अपडेट करें
            updateInvoicePreview();

        } catch (e) {
            console.warn("Could not pre-populate shop data:", e.message);
        }
    }// यह भी सुनिश्चित करें कि 'renderReports' फ़ंक्शन के अंदर API कॉल के बाद 
// यह फ़ंक्शन कॉल हो रहा है, जैसा कि नीचे है:


    // --- RENDER FUNCTIONS FOR EACH SECTION ---
    const renderView = (viewId) => {
        AppState.currentView = viewId;
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        
        // यह लाइन सुनिश्चित करती है कि सेक्शन को active क्लास मिले
        const sectionElement = document.getElementById(viewId);
        if (sectionElement) {
             sectionElement.classList.add('active');
             console.log(`✅ Activated section: #${viewId}`); // कन्फर्म करने के लिए लॉग
        } else {
             console.error(`❌ Section not found for ID: ${viewId}`); // अगर ID गलत है
        }

        document.querySelectorAll('#sidebar-nav .nav-link').forEach(l => {
            l.classList.remove('active');
            if (l.getAttribute('data-view') === viewId) l.classList.add('active');
        });
        
        // --- 🚀 अस्थायी रूप से कमेंट आउट ---
        switch (viewId) {
            case 'dashboard': renderDashboard(); break;
            case 'stock': fetchAndRenderStockList(); break;
            case 'crm': fetchAndRenderCustomers(); break;
            case 'purchases': fetchAndRenderPurchases(); break;
            case 'expenses': fetchAndRenderExpenses(); break;
            case 'reports': renderReports(); break;
            case 'sales': 
                fetchAndRenderSales(); 
                fetchApi('/api/stock', { method: 'GET' }).then(res => {
                    if (res.success) currentStock = res.stock;
                });
                focusBarcodeScanner(); 
                break;
                case 'invoice-generator':
            fetchAndPopulateShopData();
            initializeQRUpload();
            break;
             // Note: Duplicate 'sales' case removed below
            
            case 'gst-reports': 
                // Ensure getISODate function exists or handle potential error
                try {
                    document.getElementById('gst-report-start-date').value = getISODate(new Date(new Date().setDate(1))); 
                    document.getElementById('gst-report-end-date').value = getISODate(); 
                } catch (e) { console.error("Error setting GST dates:", e); }
                break;
            case 'bank-reconciliation':
            // जब हम टैब पर क्लिक करते हैं तो इंटरफ़ेस को रीसेट करें
                document.getElementById('reconciliation-setup').classList.remove('hidden');
                document.getElementById('reconciliation-matching-area').classList.add('hidden');
                document.getElementById('reconciliation-start-form').reset();
                fetchAndRenderSavedReports();
                break;    
            case 'daily-closing': fetchAndRenderClosingReports(); break; 
            case 'data-backup': break; 
            case 'shop-settings': fetchAndRenderShopSettings(); break; 
            case 'staff': renderStaff(); break; 
        }
        
        // --- 🚀 कमेंट खत्म ---
    };

    async function fetchAndRenderSales() {
        const salesTableBody = document.getElementById('sales-table-body');  
        salesTableBody.innerHTML = ''; // Clear previous entries
        try {
            const salesRes = await fetchApi('/api/invoices', { method: 'GET' }, 'हाल की बिक्री लोड हो रही है...');
            if (salesRes.success && salesRes.sales && salesRes.sales.length > 0) {
                salesRes.sales.forEach(sale => {
                    
                    // --- पुराना लॉजिक (कमेंटेड) ---
                    /*
                    salesTableBody.innerHTML += `
                        <tr>
                            <td>INV-${sale.id}</td> <td>${sale.customer_name}</td>
                            <td>${formatCurrency(sale.total_gst)}</td> 
                            <td>${formatCurrency(sale.total_amount)}</td>
                            <td>${new Date(sale.created_at).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-sm btn-info py-0 px-1" onclick="showInvoiceDetail(${sale.id})" title="विवरण देखें">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-secondary py-0 px-1 ms-1" onclick="printPOSInvoice(${sale.id})" title="इनवॉइस प्रिंट करें">
                                    <i class="fas fa-print"></i>
                                </button>
                               </td>
                        </tr>
                    `;
                    */
                    // --- पुराना लॉजिक समाप्त ---

                    // --- 🚀 नया और सही कोड (6 कॉलम के लिए) ---
                    salesTableBody.innerHTML += `
                        <tr>
                            <td>INV-${sale.id}</td>
                            <td>${sale.customer_name}</td>
                            <td>${formatCurrency(sale.total_gst)}</td>
                            <td>${formatCurrency(sale.total_amount)}</td>
                            <td>${new Date(sale.created_at).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-sm btn-info py-0 px-1" onclick="showInvoiceDetail(${sale.id})" title="विवरण देखें">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-secondary py-0 px-1 ms-1" onclick="printPOSInvoice(${sale.id})" title="इनवॉइस प्रिंट करें">
                                    <i class="fas fa-print"></i>
                                </button>
                               </td>
                        </tr>
                    `;
                    // --- नया कोड समाप्त ---

                });
            } else {
                 salesTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">कोई बिक्री रिकॉर्ड नहीं।</td></tr>`; // 👈 colspan को 5 से 6 कर दिया
            }
        } catch (error) {
            showMessage('सर्वर त्रुटि', `बिक्री डेटा लोड नहीं हो सका: ${error.message}`, 'danger');
            salesTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">त्रुटि: ${error.message}</td></tr>`; // 👈 colspan को 5 से 6 कर दिया
        }
    }
        
    // NEW: Show Invoice Detail Modal (Placeholder, needs a modal)
    async function showInvoiceDetail(invoiceId) {
        try {
            const res = await fetchApi(`/api/invoices/${invoiceId}`, { method: 'GET' });
            if (res.success) {
                // TODO: Create a modal to show this data
                console.log(res.invoice);
                alert(`चालान #${res.invoice.id}\nग्राहक: ${res.invoice.customer_name}\nकुल: ${formatCurrency(res.invoice.total_amount)}\nआइटम:\n` + 
                    res.invoice.items.map(item => `${item.item_name} (Qty: ${item.quantity})`).join('\n')
                );
            } else {
                showMessage('त्रुटि', res.message, 'danger');
            }
        } catch (e) {
            showMessage('त्रुटि', e.message, 'danger');
        }
    }

/**
    
  /**
     * (नया फ़ंक्शन - प्रिंट क्लीनअप के साथ फिक्स्ड)
     * POS से सेव किये गए इनवॉइस को फ़ेच करता है और प्रिंट करता है।
     */
     async function printPOSInvoice(invoiceId) {
        showLoader('इनवॉइस लोड हो रहा है...');
        
        // 🚀 हम इस 'printArea' को बाद में हटाएंगे
        let printArea = document.getElementById('report-print-area');

        try {
            // 1. सर्वर से इनवॉइस का पूरा डेटा लाएँ
            const res = await fetchApi(`/api/invoices/${invoiceId}`, { method: 'GET' }, null);
            if (!res.success || !res.invoice) {
                throw new Error(res.message || 'इनवॉइस डेटा नहीं मिला।');
            }
            
            const invoice = res.invoice;
            
            // 2. शॉप की डिटेल्स AppState से लें
            const profileRes = await fetchApi('/api/shop/company-profile', { method: 'GET' }, null);
            const shopProfile = profileRes.success ? profileRes.profile : {};
            const shopDisplayName = AppState.user?.shopName || 'Shop Name';

            // 3. इनवॉइस HTML तैयार करें
            let itemRows = '';
            let totalTax = 0;
            let subTotal = 0;

            invoice.items.forEach((item, index) => {
                const itemSubTotal = (item.sale_price || 0) * (item.quantity || 0);
                const itemGst = itemSubTotal * ((item.gst_rate || 0) / 100); 
                
                subTotal += itemSubTotal;
                totalTax += itemGst;
                
                itemRows += `
                    <tr>
                        <td>${index + 1}</td>
                        <td style="text-align: left;">${item.item_name}</td>
                        <td>${item.quantity}</td>
                        <td>${formatCurrency(item.sale_price)}</td>
                        <td>${item.gst_rate || 0}%</td> 
                        <td>${formatCurrency(itemSubTotal)}</td>
                        <td class="no-print"></td>
                    </tr>
                `;
            });

            const cgst = totalTax / 2;
            const sgst = totalTax / 2;

            // 4. एक अस्थायी प्रिंट करने योग्य (printable) div बनाएँ
            if (!printArea) {
                printArea = document.createElement('div');
                printArea.id = 'report-print-area';
                printArea.className = 'printable'; // [cite: 1-267]
                document.body.appendChild(printArea);
            }

            // 5. इनवॉइस HTML को प्रिंट एरिया में इंजेक्ट करें
            printArea.innerHTML = `
                <div id="invoice-preview-printable" class="printable"> 
                    <div class="invoice-header">
                        <div class="shop-details">
                            <h3>${shopProfile.legal_name || shopDisplayName}</h3>
                            <p class="mb-0">${shopProfile.address || 'Shop Address'}</p>
                            <p class="mb-0">Ph: ${shopProfile.contact || 'Contact No.'}</p>
                            ${shopProfile.gstin ? `<p class="mb-0"><strong>GSTIN: ${shopProfile.gstin}</strong></p>` : ''}
                        </div>
                        <h2 style="color: #333; align-self: center;">INVOICE</h2>
                    </div>
                    
                    <div class="customer-details row">
                        <div class="col-8">
                            <strong>Bill To:</strong>
                            <p class="mb-0">${invoice.customer_name || 'N/A'}</p>
                            <p class="mb-0">Ph: ${invoice.customer_mobile || 'N/A'}</p>
                        </div>
                        <div class="col-4 text-end">
                            <p class="mb-0"><strong>Invoice No:</strong> INV-${invoice.id}</p>
                            <p class="mb-0"><strong>Date:</strong> ${new Date(invoice.created_at).toLocaleDateString()}</p>
                        </div>
                    </div>

                    <table class="invoice-table">
                        <thead>
                            <tr>
                                <th style="width: 5%;">#</th>
                                <th style="text-align: left;">Item</th>
                                <th style="width: 10%;">Qty</th>
                                <th style="width: 15%;">Rate</th>
                                <th style="width: 10%;">GST%</th>
                                <th style="width: 15%;">Amount</th>
                                <th style="width: 5%;" class="no-print"></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemRows}
                        </tbody>
                    </table>
                    
                    <div class="invoice-footer">
                        <div>
                            </div>
                        <table class="totals-table">
                            <tbody>
                                <tr><td>Subtotal:</td><td style="text-align: right;">${formatCurrency(subTotal)}</td></tr>
                                <tr><td>CGST:</td><td style="text-align: right;">${formatCurrency(cgst)}</td></tr>
                                <tr><td>SGST:</td><td style="text-align: right;">${formatCurrency(sgst)}</td></tr>
                                <tr style="font-weight: bold; font-size: 1.2em; border-top: 2px solid #333;">
                                    <td>Grand Total:</td>
                                    <td style="text-align: right;">${formatCurrency(invoice.total_amount)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // 🚀🚀🚀 यह रहा फिक्स 🚀🚀🚀
            // 6. एक क्लीनअप फ़ंक्शन बनाएँ
            function cleanupPrint() {
                if (printArea) {
                    printArea.remove(); // अस्थायी div को हटा दें
                }
                window.onafterprint = null; // इवेंट लिस्नर को हटा दें
            }
            
            // 7. 'afterprint' (प्रिंट करने के बाद) इवेंट पर क्लीनअप फ़ंक्शन सेट करें
            window.onafterprint = cleanupPrint;
            
            // 8. प्रिंट करें
            window.print();
            // 🚀🚀🚀 फिक्स समाप्त 🚀🚀🚀

        } catch (e) {
            showMessage('त्रुटि', `इनवॉइस प्रिंट करने में विफल: ${e.message}`, 'danger');
            // 🚀 अगर एरर आए तो भी क्लीनअप करें
            if (printArea) {
                printArea.remove();
            }
        } finally {
            hideLoader();
        }
    }
    
    async function renderDashboard() {
        // --- 1. Get Summary Cards Data ---
        try {
            // Use the new multi-tenant endpoint [cite: 214]
            const data = await fetchApi('/api/dashboard/summary', { method: 'GET' }, 'मुख्य आँकड़े लोड हो रहे हैं...');
            if (data.success) {
                // Use the correct response keys from server.cjs [cite: 225]
                document.getElementById('total-sales-revenue').innerText = formatCurrency(data.summary.totalSales);
                document.getElementById('total-stock-value').innerText = formatCurrency(data.summary.currentStockValue);
                // totalCustomers is not in this summary, we need to fetch it separately or remove it
                // Let's modify the server endpoint logic slightly in our head...
                // ...or just fetch the data from the other endpoints
            } else {
                showMessage('त्रुटि', data.message, 'danger');
            }
        } catch (error) {
            showMessage('सर्वर त्रुटि', `डैशबोर्ड आँकड़े लोड नहीं हो सके: ${error.message}`, 'danger');
        }

        // --- 2. Load other tables (Your existing logic is fine, but needs new endpoints) ---
        try {
            // [cite: 187] [cite_start]for customers, [cite: 168] for sales
            const [lowStockRes, salesRes, customersRes] = await Promise.all([
                fetchApi('/api/stock', { method: 'GET' }, 'कम स्टॉक आइटम्स लोड हो रहे हैं...'), // Assuming low stock is just stock
                fetchApi('/api/invoices', { method: 'GET' }, 'हाल की बिक्री लोड हो रही है...'), 
                fetchApi('/api/customers', { method: 'GET' }, 'हाल के ग्राहक लोड हो रहे हैं...')
            ]);
            
            // Low Stock Table (Filter from full stock list)
            const lowStockBody = document.getElementById('low-stock-table-body');
            lowStockBody.innerHTML = '';
            const lowStockItems = lowStockRes.success ? lowStockRes.stock.filter(item => item.quantity < 10) : []; // 10 को थ्रेशोल्ड मानें
            
            document.getElementById('low-stock-count').innerText = lowStockItems.length; // Update low stock count
            
            if (lowStockItems.length > 0) {
                lowStockItems.forEach(item => {
                    lowStockBody.innerHTML += `<tr><td>${item.sku}</td><td>${item.name}</td><td>${item.quantity}</td></tr>`;
                });
            } else {
                lowStockBody.innerHTML = `<tr><td colspan="3" class="text-center text-muted">कोई कम स्टॉक आइटम नहीं</td></tr>`;
            }

            // Recent Sales Table
            const recentSalesBody = document.getElementById('recent-sales-table-body');
            recentSalesBody.innerHTML = '';
            if (salesRes.success && salesRes.sales.length > 0) {
                // Update total customers count
                document.getElementById('total-sales-revenue').innerText = formatCurrency(salesRes.sales.reduce((acc, s) => acc + parseFloat(s.total_amount), 0));
                
                salesRes.sales.slice(0, 10).forEach(sale => { // Show 10 recent
                    recentSalesBody.innerHTML += `<tr><td>INV-${sale.id}</td><td>${sale.customer_name}</td><td>${formatCurrency(sale.total_amount)}</td><td>${new Date(sale.created_at).toLocaleDateString()}</td></tr>`;
                });
            } else {
                recentSalesBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">कोई बिक्री नहीं</td></tr>`;
            }

            // Recent Customers Table
            const recentCustomersBody = document.getElementById('recent-customers-table-body');
            recentCustomersBody.innerHTML = '';
            if (customersRes.success && customersRes.customers.length > 0) {
                // Update total customers count
                document.getElementById('total-customers').innerText = customersRes.customers.length;
                
                customersRes.customers.slice(0, 10).forEach(cust => { // Show 10 recent
                    recentCustomersBody.innerHTML += `<tr><td>${cust.name}</td><td>${cust.phone || 'N/A'}</td><td>${new Date(cust.created_at).toLocaleDateString()}</td></tr>`;
                });
            } else {
                recentCustomersBody.innerHTML = `<tr><td colspan="3" class="text-center text-muted">कोई ग्राहक नहीं</td></tr>`;
            }
            
            // Update stock value from stock endpoint
             document.getElementById('total-stock-value').innerText = formatCurrency(lowStockRes.success ? lowStockRes.stock.reduce((acc, item) => acc + (item.purchase_price * item.quantity), 0) : 0);
            
            // --- NEW: Load Sales Chart ---
            renderSalesChart();

            console.log("✅ Dashboard fully updated.");

        } catch (error) {
            showMessage('सर्वर त्रुटि', `डैशबोर्ड तालिकाएँ लोड नहीं हो सकीं: ${error.message}`, 'danger');
        }
    } 
    
  // NEW: Render Sales Chart (Uses server endpoint [cite: 271-282])
    let salesChartInstance = null; // To hold the chart object
    async function renderSalesChart(days = 30) {
        try {
            const res = await fetchApi(`/api/dashboard/sales-by-day?days=${days}`, { method: 'GET' });
            if (res.success) {
                const ctx = document.getElementById('salesChart').getContext('2d');
                const labels = res.data.map(d => d.date);
                const salesData = res.data.map(d => d.sales);
                const profitData = res.data.map(d => d.profit);

                if (salesChartInstance) {
                    salesChartInstance.destroy(); // Destroy old chart before creating new one
                }
                
                salesChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'बिक्री (Sales)',
                                data: salesData,
                                borderColor: '#0d6efd',
                                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'लाभ (Profit)',
                                data: profitData,
                                borderColor: '#198754',
                                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                                fill: true,
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) { return '₹' + value; }
                                }
                            }
                        }
                    }
                });
            }
        } catch (e) {
            console.error("Sales chart error:", e.message);
        }
    }

    // ==========================================================
// ========== UPDATED: renderReports (Bank-Style Detail) ==========
// ==========================================================
async function renderReports() {
    // 1. Get date range (assuming server defaults if not provided, but server code requires it)
    const endDate = getISODate();
    const startDate = getISODate(new Date(new Date().setDate(new Date().getDate() - 90))); // 90-day default

    try {
        // 2. Fetch P&L Report first
        const plRes = await fetchApi(`/api/reports/profit-loss?startDate=${startDate}&endDate=${endDate}`, { method: 'GET' }, 'P&L रिपोर्ट लोड हो रही है...');
        
        if (!plRes.success) {
            throw new Error(plRes.message || 'P&L रिपोर्ट लोड करने में विफल।');
        }
        
        const pl = plRes.report;
        const netProfit = pl.netProfit; // Save this for the Balance Sheet

        // 3. Populate P&L Table (Debit Side)
        // [यह 'pl-card' के अंदर पहले <tbody> को चुनता है]
        const plDebitBody = document.getElementById('pl-card').querySelectorAll('tbody')[0];
        plDebitBody.innerHTML = ''; // Clear existing static rows
        pl.debit.forEach(item => {
            plDebitBody.innerHTML += `<tr>
                                        <td>${item.description}</td>
                                        <td class="text-end">${formatCurrency(item.amount)}</td>
                                      </tr>`;
        });
        // Total Debit
        document.getElementById('report-pl-total-debit').innerText = formatCurrency(pl.totalDebit);

        // 4. Populate P&L Table (Credit Side)
        // [यह 'pl-card' के अंदर दूसरे <tbody> को चुनता है]
        const plCreditBody = document.getElementById('pl-card').querySelectorAll('tbody')[1];
        plCreditBody.innerHTML = ''; // Clear existing static rows
        pl.credit.forEach(item => {
            plCreditBody.innerHTML += `<tr>
                                        <td>${item.description}</td>
                                        <td class="text-end">${formatCurrency(item.amount)}</td>
                                      </tr>`;
        });
        // Total Credit
        document.getElementById('report-pl-total-credit').innerText = formatCurrency(pl.totalCredit);

        // 5. Fetch Balance Sheet Report (passing the calculated netProfit)
        // [यह P&L से प्राप्त शुद्ध लाभ को बैलेंस शीट API को भेजता है]
        const bsRes = await fetchApi(`/api/reports/balance-sheet?netProfit=${netProfit}`, { method: 'GET' }, 'बैलेंस शीट लोड हो रही है...');

        if (!bsRes.success) {
            throw new Error(bsRes.message || 'बैलेंस शीट लोड करने में विफल।');
        }
        
        const bs = bsRes.report;

        // 6. Populate Balance Sheet (Liabilities & Equity Side)
        // [यह 'bs-card' के अंदर पहले <tbody> को चुनता है]
        const bsLiabilitiesBody = document.getElementById('bs-card').querySelectorAll('tbody')[0];
        bsLiabilitiesBody.innerHTML = ''; // Clear existing static rows
        
        // Liabilities (देनदारियां)
        bs.liabilities.forEach(item => {
            bsLiabilitiesBody.innerHTML += `<tr>
                                                <td>${item.description}</td>
                                                <td class="text-end">${formatCurrency(item.amount)}</td>
                                            </tr>`;
        });
        // Equity (इक्विटी)
        bs.equity.forEach(item => {
            bsLiabilitiesBody.innerHTML += `<tr>
                                                <td>${item.description}</td>
                                                <td class="text-end">${formatCurrency(item.amount)}</td>
                                            </tr>`;
        });
        // Total Liabilities & Equity
        document.getElementById('report-bs-total-liabilities').innerText = formatCurrency(bs.totalLiabilitiesAndEquity);

        // 7. Populate Balance Sheet (Assets Side)
        // [यह 'bs-card' के अंदर दूसरे <tbody> को चुनता है]
        const bsAssetsBody = document.getElementById('bs-card').querySelectorAll('tbody')[1];
        bsAssetsBody.innerHTML = ''; // Clear existing static rows
        
        // Assets (परिसंपत्तियां)
        bs.assets.forEach(item => {
            let note = item.note ? `<small class="text-muted d-block">${item.note}</small>` : '';
            bsAssetsBody.innerHTML += `<tr>
                                        <td>${item.description} ${note}</td>
                                        <td class="text-end">${formatCurrency(item.amount)}</td>
                                      </tr>`;
        });
        // Total Assets
        document.getElementById('report-bs-total-assets').innerText = formatCurrency(bs.totalAssets);
        
        console.log("✅ Reports updated successfully with details.");

    } catch (error) {
        console.error("renderReports त्रुटि:", error);
        showMessage('सर्वर त्रुटि', `रिपोर्ट्स लोड नहीं हो सकी: ${error.message}`, 'danger');
        
        // Clear tables on error to avoid showing old data
        document.getElementById('pl-card').querySelectorAll('tbody')[0].innerHTML = '<tr><td colspan="2" class="text-danger text-center">P&L लोड करने में विफल।</td></tr>';
        document.getElementById('pl-card').querySelectorAll('tbody')[1].innerHTML = '<tr><td colspan="2" class="text-danger text-center"></td></tr>';
        document.getElementById('bs-card').querySelectorAll('tbody')[0].innerHTML = '<tr><td colspan="2" class="text-danger text-center">BS लोड करने में विफल।</td></tr>';
        document.getElementById('bs-card').querySelectorAll('tbody')[1].innerHTML = '<tr><td colspan="2" class="text-danger text-center"></td></tr>';
    }
}
// ==========================================================
// ========== END OF UPDATED FUNCTION ==========
// ==========================================================


async function fetchAndRenderStockList() {
        const tableBody = document.getElementById('stock-table-body');
        const tableFoot = document.getElementById('stock-table-foot');
        tableBody.innerHTML = `<tr><td colspan="8" class="text-center">लोड हो रहा है...</td></tr>`;
        tableFoot.innerHTML = '';
        try {
            const res = await fetchApi('/api/stock', { method: 'GET' });
            tableBody.innerHTML = '';
            let totalPurchaseValue = 0;
            let totalSaleValue = 0;
            if (res.success && res.stock.length > 0) {
                res.stock.forEach(item => {
                    totalPurchaseValue += (item.purchase_price || 0) * (item.quantity || 0);
                    totalSaleValue += (item.sale_price || 0) * (item.quantity || 0);
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${item.sku}</td>
                        <td>${item.name}</td>
                        <td>${item.quantity} ${item.unit || ''}</td>
                        <td>${formatCurrency(item.purchase_price)}</td>
                        <td>${formatCurrency(item.sale_price)}</td>
                        <td>${item.gst || 0}%</td>
                        <td>${new Date(item.updated_at).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" data-role="ADMIN" onclick="deleteEntry('stock', '${item.sku}')">हटाएं</button>
                        </td>
                    `;
                });
                tableFoot.innerHTML = `
                    <tr class="fw-bold bg-light">
                        <td colspan="3">कुल</td>
                        <td>${formatCurrency(totalPurchaseValue)}</td>
                        <td>${formatCurrency(totalSaleValue)}</td>
                        <td colspan="3"></td>
                    </tr>
                `;
            } else {
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">कोई स्टॉक आइटम नहीं है।</td></tr>`;
            }
        } catch (e) {
            tableBody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">त्रुटि: ${e.message}</td></tr>`;
        }
    }

    async function fetchAndRenderCustomers() {
        const tableBody = document.getElementById('crm-table-body');
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center">लोड हो रहा है...</td></tr>`;
        try {
            const res = await fetchApi('/api/customers', { method: 'GET' });
            tableBody.innerHTML = '';
            if (res.success && res.customers.length > 0) {
                res.customers.forEach(c => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${c.id}</td>
                        <td>${c.name}</td>
                        <td>${c.phone || 'N/A'}</td>
                        <td>${c.address || 'N/A'}</td>
                        <td>${new Date(c.created_at).toLocaleDateString()}</td>
                        <td>
                           </td>
                    `;
                });
            } else {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">कोई ग्राहक नहीं मिला।</td></tr>`;
            }
        } catch (e) {
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">त्रुटि: ${e.message}</td></tr>`;
        }
    }
	
	
    // --- (... पिछला जावास्क्रिप्ट कोड पार्ट 2 से जारी ...) ---

    async function fetchAndRenderPurchases() {
        const tableBody = document.getElementById('purchases-table-body');
        const tableFoot = document.getElementById('purchases-table-foot');
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center">लोड हो रहा है...</td></tr>`;
        tableFoot.innerHTML = '';
        try {
            const res = await fetchApi('/api/purchases', { method: 'GET' });
            tableBody.innerHTML = '';
            let totalCost = 0;
            if (res.success && res.purchases.length > 0) {
                res.purchases.forEach(p => {
                    totalCost += parseFloat(p.total_cost || 0);
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${p.id}</td>
                        <td>${p.supplier_name || 'N/A'}</td>
                        <td>${p.item_details}</td>
                        <td>${formatCurrency(p.total_cost)}</td>
                        <td>${new Date(p.created_at).toLocaleDateString()}</td>
                        <td><button class="btn btn-sm btn-danger" data-role="ADMIN" onclick="deleteEntry('purchase', ${p.id})">हटाएं</button></td>
                    `;
                });
                tableFoot.innerHTML = `<tr class="fw-bold bg-light"><td colspan="3">कुल खरीद राशि</td><td>${formatCurrency(totalCost)}</td><td colspan="2"></td></tr>`;
            } else {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">कोई खरीद रिकॉर्ड नहीं मिला।</td></tr>`;
            }
        } catch (e) {
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">त्रुटि: ${e.message}</td></tr>`;
        }
    }

    async function fetchAndRenderExpenses() {
        const tableBody = document.getElementById('expenses-table-body');
        const tableFoot = document.getElementById('expenses-table-foot');
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center">लोड हो रहा है...</td></tr>`;
        tableFoot.innerHTML = '';
        try {
            const res = await fetchApi('/api/expenses', { method: 'GET' });
            tableBody.innerHTML = '';
            let totalExpenses = 0;
            if (res.success && res.expenses.length > 0) {
                res.expenses.forEach(ex => {
                    totalExpenses += parseFloat(ex.amount || 0);
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${new Date(ex.created_at).toLocaleDateString()}</td>
                        <td>${ex.category}</td>
                        <td>${ex.description}</td>
                        <td>${formatCurrency(ex.amount)}</td>
                        <td><button class="btn btn-sm btn-danger" data-role="ADMIN" onclick="deleteEntry('expense', ${ex.id})">हटाएं</button></td>
                    `;
                });
                tableFoot.innerHTML = `<tr class="fw-bold bg-light"><td colspan="3">कुल खर्च राशि</td><td>${formatCurrency(totalExpenses)}</td><td></td></tr>`;
            } else {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">कोई खर्च रिकॉर्ड नहीं मिला।</td></tr>`;
            }
        } catch (e) {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">त्रुटि: ${e.message}</td></tr>`;
        }
    }    
    // --- POS (SALES) SECTION LOGIC ---

    // NEW: Modified to show all items on click (showAll = true)
    function handleItemSearch(showAll = false) {
        const query = document.getElementById('pos-item-search').value.toLowerCase();
        const resultsUl = document.getElementById('pos-search-results');
        
        if (!showAll && query.length < 2) {
            resultsUl.innerHTML = '';
            return;
        }

        const results = (showAll && query.length === 0)
            ? currentStock // Show all
            : currentStock.filter(item => 
                item.name.toLowerCase().includes(query) || (item.sku && item.sku.toLowerCase().includes(query))
            );

        if (results.length > 0) {
            resultsUl.innerHTML = results.map(item => 
                `<li class="list-group-item list-group-item-action" data-sku="${item.sku}">
                    ${item.name} (${formatCurrency(item.sale_price)}) <span class="badge bg-primary float-end">${item.sku}</span>
                </li>`
            ).join('');
        } else {
            resultsUl.innerHTML = '<li class="list-group-item text-muted">कोई आइटम नहीं मिला</li>';
        }
    }

    function handleSearchResultClick(e) {
        if (e.target.tagName === 'LI' && e.target.dataset.sku) {
            const sku = e.target.dataset.sku;
            addSKUToCart(sku); // NEW: Use centralized function
        }
    }
    
    // NEW: Centralized function to add SKU to cart (used by barcode and search)
    function addSKUToCart(sku) {
        const selectedItem = currentStock.find(item => item.sku === sku);
            
        if (selectedItem) {
            // Check stock quantity
            if(selectedItem.quantity <= 0) {
                return showMessage('स्टॉक नहीं है', `${selectedItem.name} स्टॉक में समाप्त हो गया है।`, 'danger');
            }
            
            const existingCartItem = posCart.find(item => item.sku === sku);
            if (existingCartItem) {
                // Check stock against cart
                if(existingCartItem.quantity >= selectedItem.quantity) {
                    return showMessage('स्टॉक नहीं है', `आपके पास स्टॉक में केवल ${selectedItem.quantity} ${selectedItem.name} हैं।`, 'warning');
                }
                existingCartItem.quantity++;
            } else {
                posCart.push({ 
                    ...selectedItem, 
                    quantity: 1,
                    purchase_price: parseFloat(selectedItem.purchase_price || 0)
                });
            }
            updatePOSCartView();
        } else {
             showMessage('नहीं मिला', `SKU ${sku} स्टॉक में नहीं मिला।`, 'warning');
        }
        
        document.getElementById('pos-item-search').value = '';
        document.getElementById('pos-search-results').innerHTML = '';
        document.getElementById('pos-item-search').focus();
    }

    function updatePOSCartView() {
        const cartBody = document.getElementById('pos-cart-body');
        if(!cartBody) return; // Prevent errors if view is not active

        if (posCart.length === 0) {
            cartBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">कार्ट खाली है।</td></tr>`;
        } else {
            cartBody.innerHTML = posCart.map((item, index) => {
                const saleTotal = item.sale_price * item.quantity;
                const stockItem = currentStock.find(s => s.sku === item.sku);
                const maxStock = stockItem ? stockItem.quantity : item.quantity; // Get current stock level
                
                return `
                    <tr>
                        <td>${item.name}</td>
                        <td>
                            <input 
                                type="number" 
                                class="form-control form-control-sm" 
                                style="width: 100px;"
                                value="${item.quantity}" 
                                min="1" 
                                max="${maxStock}"
                                onchange="updateCartQuantity(${index}, this.value)"
                                onblur="validateCartQuantity(${index}, this.value, ${maxStock})"
                            >
                        </td>
                        <td>${formatCurrency(item.sale_price)}</td>
                        <td>${formatCurrency(saleTotal)}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="removeFromCart(${index})">&times;</button></td>
                    </tr>
                `;
            }).join('');
        }
        calculatePOSTotals();
    }
    
    // NEW: Validate quantity on blur (after changing)
    function validateCartQuantity(index, newQuantity, maxStock) {
        const quantity = parseInt(newQuantity);
        if (quantity > maxStock) {
             showMessage('स्टॉक सीमित है', `आपके पास केवल ${maxStock} आइटम उपलब्ध हैं।`, 'warning');
             posCart[index].quantity = maxStock;
             updatePOSCartView();
        }
    }


    function updateCartQuantity(index, newQuantity) {
        const quantity = parseInt(newQuantity);
        
        if (isNaN(quantity) || quantity < 1) {
            showMessage('चेतावनी', 'मात्रा 1 या उससे अधिक होनी चाहिए।', 'warning');
            updatePOSCartView(); 
            return;
        }
        
        posCart[index].quantity = quantity;
        updatePOSCartView(); 
    }

    function removeFromCart(index) {
        posCart.splice(index, 1);
        updatePOSCartView();
    }

    function calculatePOSTotals() {
        let subtotal = 0;
        let gstAmount = 0;
        let totalAmount = 0;
        
        posCart.forEach(item => {
            const itemTotalWithGST = item.sale_price * item.quantity;
            const gstValue = parseFloat(item.gst) || 0;
            // This calculation assumes sale_price INCLUDES GST.
            // const subtotalWithoutGST = itemTotalWithGST / (1 + (gstValue / 100)); 
            
            // This calculation assumes sale_price EXCLUDES GST.
            const subtotalWithoutGST = itemTotalWithGST;
            const itemGstAmount = subtotalWithoutGST * (gstValue / 100);
            
            subtotal += subtotalWithoutGST;
            gstAmount += itemGstAmount;
        });
        
        totalAmount = subtotal + gstAmount;
        
        document.getElementById('pos-subtotal').innerText = formatCurrency(subtotal);
        document.getElementById('pos-gst-amount').innerText = formatCurrency(gstAmount);
        document.getElementById('pos-total-amount').innerText = formatCurrency(totalAmount);

        return totalAmount;
    }

    async function handleCompleteSale() {
    if (posCart.length === 0) {
        return showMessage('त्रुटि', 'बिक्री पूरी करने के लिए कार्ट में आइटम जोड़ें।', 'warning');
    }

    const finalTotalAmount = parseFloat(document.getElementById('pos-total-amount').innerText.replace(/[^0-9.]/g, ''));

    const itemsForApi = posCart.map(item => ({
        sku: item.sku,
        name: item.name,
        quantity: item.quantity,
        sale_price: item.sale_price,
        purchase_price: parseFloat(item.purchase_price || 0),
        gst: item.gst
    }));

    const saleData = {
        customerName: document.getElementById('pos-customer').value || 'अनाम ग्राहक',
        customerMobile: document.getElementById('pos-customer-mobile').value || null, // यह लाइन डेटा भेजती है
        total_amount: finalTotalAmount,
        sale_items: itemsForApi
    };
    
    try {
        const res = await fetchApi('/api/invoices', {
            method: 'POST',
            body: saleData
        }, 'बिक्री पूरी की जा रही है...');

        if (res.success) {
            showMessage('सफलता', res.message, 'success');
            posCart = [];
            updatePOSCartView();
            document.getElementById('pos-customer').value = '';
            
            // ✅ FIX: मोबाइल नंबर इनपुट को साफ़ करने वाली लाइन यहाँ जोड़ें
            document.getElementById('pos-customer-mobile').value = ''; 
            
            fetchAndRenderSales();
            // Update stock list
            fetchApi('/api/stock', { method: 'GET' }).then(res => {
                if (res.success) currentStock = res.stock;
            });
            if (typeof renderDashboard === 'function') {
                renderDashboard();
            }
        } else {
            throw new Error(res.message || 'अज्ञात बिक्री त्रुटि।');
        }
    } catch (error) {
        showMessage('त्रुटि', `बिक्री विफल: ${error.message}`, 'danger');
    }
}
    // --- FORM SUBMISSION HANDLERS ---
    
    function setupForm(formId, apiPath, successCallback) {
        const form = document.getElementById(formId);
        if (form && !form.dataset.initialized) {
            form.dataset.initialized = 'true';
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = form.querySelector('button[type="submit"]');
                const originalBtnText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> सेव हो रहा है...`;
                
                const data = {};

                if (formId === 'add-stock-form') {
                    data.sku = document.getElementById('stock-sku').value;
                    data.name = document.getElementById('stock-name').value;
                    data.quantity = document.getElementById('stock-quantity').value;
                    data.unit = document.getElementById('stock-unit').value;
                    data.purchase_price = document.getElementById('stock-purchase-price').value;
                    data.sale_price = document.getElementById('stock-sale-price').value;
                    data.gst = document.getElementById('stock-gst').value;
                    data.hsn_code = document.getElementById('stock-hsn-code').value; // NEW
                } else if (formId === 'add-customer-form') {
                    data.name = document.getElementById('customer-name').value;
                    data.phone = document.getElementById('customer-phone').value;
                    data.email = document.getElementById('customer-email').value;
                    data.address = document.getElementById('customer-address').value;
                    data.gstin = document.getElementById('customer-gstin').value;
                    
                    // 🚀 यह नई लाइन यहाँ जोड़ें
                    data.balance = document.getElementById('customer-balance').value || 0;

                } else if (formId === 'add-purchase-form') {
               // ... (लाइन 1944 के आसपास)
            } else if (formId === 'add-purchase-form') {
                    // 🚀 नया GST-सक्षम लॉजिक
                    data.supplier_name = document.getElementById('purchase-supplier').value;
                    data.total_cost = document.getElementById('purchase-total-cost').value;
                    data.date = document.getElementById('purchase-date').value;
                    
                    // GSTR-2 के लिए gst_details JSON बनाएँ 
                    data.gst_details = {
                        invoice_number: document.getElementById('purchase-bill-number').value,
                        taxable_value: parseFloat(document.getElementById('purchase-taxable-value').value) || 0,
                        cgst: parseFloat(document.getElementById('purchase-cgst').value) || 0,
                        sgst: parseFloat(document.getElementById('purchase-sgst').value) || 0,
                        igst: parseFloat(document.getElementById('purchase-igst').value) || 0
                    };
                    
                    // 'item_details' को बिल नंबर से भरें
                    data.item_details = `Bill No: ${data.gst_details.invoice_number}`;
                    
                    // यह सुनिश्चित करें कि 'total_cost' GST के साथ मैच हो
                    const calculatedTotal = data.gst_details.taxable_value + data.gst_details.cgst + data.gst_details.sgst + data.gst_details.igst;
                    if (calculatedTotal > 0 && Math.abs(calculatedTotal - data.total_cost) > 0.1) {
                         // चेतावनी दें अगर 'कुल राशि' और GST का जोड़ मैच नहीं होता
                         if(!confirm(`चेतावनी: आपकी 'कुल बिल राशि' (${formatCurrency(data.total_cost)}) और GST का जोड़ (${formatCurrency(calculatedTotal)}) मैच नहीं हो रहा है। क्या आप फिर भी जारी रखना चाहते हैं?`)) {
                             btn.disabled = false;
                             btn.innerHTML = originalBtnText;
                             return; // सबमिशन रोकें
                         }
                    }
                    
// ... (यह 'else if (formId === 'add-expense-form')' से पहले खत्म होना चाहिए)
                } else if (formId === 'add-expense-form') {
                    data.description = document.getElementById('expense-description').value;
                    data.category = document.getElementById('expense-category').value;
                    data.amount = document.getElementById('expense-amount').value;
                    data.created_at = document.getElementById('expense-date').value;
                }

                try {
                    let correctApiPath = apiPath;
                    if (apiPath === '/api/customer') correctApiPath = '/api/customers';
                    if (apiPath === '/api/purchase') correctApiPath = '/api/purchases';
                    if (apiPath === '/api/expense') correctApiPath = '/api/expenses';

                    const res = await fetchApi(correctApiPath, { method: 'POST', body: data });
                    if (res.success) {
                        showMessage('सफलता', res.message, 'success');
                        form.reset();
                        if (successCallback) successCallback();
                    } else {
                        throw new Error(res.message);
                    }
                } catch (error) {
                    showMessage('त्रुटि', `सेव नहीं हो सका: ${error.message}`, 'danger');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalBtnText;
                }
            });
        }
    }



    

// 🚀 नया हेल्पर फ़ंक्शन: QR इमेज सेट करता है और Modal दिखाता है
function displayQrModal() {
         const modalBody = document.querySelector('#pairingModal .modal-body'); 
         if (!modalBody || !qrCodeDataUrl) {
             console.error("❌ displayQrModal: Modal बॉडी या QR कोड URL नहीं मिला!");
             showMessage('त्रुटि', 'QR कोड दिखाने में विफल।', 'danger');
             return;
         }
         
         // Modal बॉडी को साफ़ करें और इमेज दिखाएँ
         modalBody.innerHTML = `
            <p>अपने Dukan Pro मोबाइल स्कैनर ऐप से यह QR कोड स्कैन करें।</p>
            <div style="min-height: 260px; display: flex; align-items: center; justify-content: center;">
                <img src="${qrCodeDataUrl}" alt="QR Code" style="width: 256px; height: 256px; border: 1px solid #ccc;">
            </div>
             <p class="text-muted small mt-3">यह QR कोड आपके POS को आपके फ़ोन से सुरक्षित रूप से जोड़ता है।</p>
         `;
         
         // Modal दिखाएँ
         if (pairingModalInstance) {
             pairingModalInstance.show();
         }
         isWaitingForQr = false; // इंतज़ार खत्म
    }


    // ===================================
// STAFF MANAGEMENT FUNCTIONS (NEW)
// ===================================
let staffEditModal = null; // To hold the modal instance

async function renderStaff() {
    // Only admin can see and manage staff
    if (!AppState.user || AppState.user.role !== 'ADMIN') {
        // Optionally hide the staff section link if not admin, though RBAC should handle it
        const staffLink = document.querySelector('a[data-view="staff"]');
        if(staffLink) staffLink.classList.add('d-none');
        // Clear the table if somehow accessed by non-admin
        document.getElementById('staff-table-body').innerHTML = `<tr><td colspan="7" class="text-center text-danger">इस सेक्शन तक पहुँचने के लिए एडमिन अनुमति आवश्यक है।</td></tr>`;
        return;
    }

    const tableBody = document.getElementById('staff-table-body');
    tableBody.innerHTML = `<tr><td colspan="7" class="text-center">स्टाफ लोड हो रहा है...</td></tr>`;

    try {
        // Fetch users for the current shop using the correct endpoint
        const res = await fetchApi('/api/users', { method: 'GET' });
        if (res.success && res.users) {
            if (res.users.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">इस शॉप में कोई स्टाफ सदस्य नहीं जोड़ा गया है।</td></tr>`;
                 return;
            }
            // Populate table rows
            tableBody.innerHTML = res.users.map(staff => `
                <tr>
                    <td>${staff.id}</td>
                    <td>${staff.name}</td>
                    <td>${staff.email}</td>
                    <td><span class="badge bg-${staff.role === 'ADMIN' ? 'danger' : staff.role === 'MANAGER' ? 'warning' : 'info'}">${staff.role}</span></td>
                    <td><span class="badge bg-${staff.status === 'active' ? 'success' : staff.status === 'pending' ? 'secondary' : 'dark'}">${staff.status}</span></td>
                    <td>${new Date(staff.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-primary ${staff.id === AppState.user.id ? 'disabled' : ''}" onclick='openEditStaffModal(${JSON.stringify(staff)})' title="संपादित करें">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger ${staff.id === AppState.user.id ? 'disabled' : ''}" onclick="handleDeleteStaff(${staff.id})" title="हटाएं">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } else {
            throw new Error(res.message || 'स्टाफ सूची लोड करने में विफल।');
        }
    } catch (e) {
        tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">त्रुटि: ${e.message}</td></tr>`;
    }
}

// Opens the Edit Staff modal with pre-filled data
function openEditStaffModal(staff) {
    if (!staffEditModal) {
        staffEditModal = new bootstrap.Modal(document.getElementById('editStaffModal'));
    }
    // Populate the modal form fields
    document.getElementById('edit-staff-id').value = staff.id;
    document.getElementById('edit-staff-name').value = staff.name;
    document.getElementById('edit-staff-email').value = staff.email; // Email is disabled, just for display
    document.getElementById('edit-staff-role').value = staff.role;
    document.getElementById('edit-staff-status').value = staff.status;
    document.getElementById('edit-staff-password').value = ''; // Clear password field for security
    staffEditModal.show(); // Show the modal
}

// Handles the submission of the "Add Staff" form
async function handleAddStaff(event) {
    event.preventDefault(); // Prevent default form submission
    const btn = event.target.querySelector('button[type="submit"]');
    const originalBtnText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> जोड़ा जा रहा है...`;

    // Collect data from the add form
    const data = {
        name: document.getElementById('staff-name').value,
        email: document.getElementById('staff-email').value,
        password: document.getElementById('staff-password').value,
        role: document.getElementById('staff-role').value,
        status: document.getElementById('staff-status').value,
    };

    try {
        // Send POST request to add user endpoint
        const res = await fetchApi('/api/users', { method: 'POST', body: data });
        if (res.success) {
            showMessage('सफलता', 'स्टाफ सदस्य सफलतापूर्वक जोड़ा गया।', 'success');
            document.getElementById('add-staff-form').reset(); // Reset form fields
            renderStaff(); // Refresh the staff list
        } else {
            throw new Error(res.message);
        }
    } catch (e) {
        showMessage('त्रुटि', `स्टाफ जोड़ने में विफल: ${e.message}`, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalBtnText;
    }
}



/**
 * एक साधारण CSV टेक्स्ट को JSON ऑब्जेक्ट ऐरे में पार्स करता है
 */
 function parseCSV(csvText) {
    const lines = csvText.split('\n');
    if (lines.length === 0) return [];
    
    // हेडर (Date, Description, Debit, Credit) का पता लगाएँ
    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
    
    // कॉलम इंडेक्स ढूँढें
    const dateIdx = headers.findIndex(h => h.includes('date'));
    const descIdx = headers.findIndex(h => h.includes('description') || h.includes('narration'));
    const debitIdx = headers.findIndex(h => h.includes('debit') || h.includes('withdrawal'));
    const creditIdx = headers.findIndex(h => h.includes('credit') || h.includes('deposit'));

    if (dateIdx === -1 || descIdx === -1 || debitIdx === -1 || creditIdx === -1) {
        showMessage('CSV एरर', 'CSV में Date, Description, Debit/Withdrawal, या Credit/Deposit कॉलम नहीं मिले।', 'danger');
        throw new Error('Invalid CSV headers');
    }

    const items = [];
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line) continue;
        
        const values = line.split(',');
        
        const dateStr = values[dateIdx];
        // तारीख को YYYY-MM-DD में बदलें (मान लें कि यह DD/MM/YYYY या MM/DD/YYYY है)
        let dateObj;
        if (dateStr.includes('/')) {
            const parts = dateStr.split('/');
            // मान लें कि यह MM/DD/YYYY है (इसे अपने बैंक के अनुसार बदलें)
            // अगर DD/MM/YYYY है, तो new Date(parts[2], parts[1] - 1, parts[0]) का उपयोग करें
            dateObj = new Date(parts[2], parts[0] - 1, parts[1]); 
        } else {
            dateObj = new Date(dateStr); // ISO 8601 (YYYY-MM-DD)
        }
        
        const debitAmount = parseFloat(values[debitIdx].replace(/[^0-9.]/g, '')) || 0;
        const creditAmount = parseFloat(values[creditIdx].replace(/[^0-9.]/g, '')) || 0;

        items.push({
            date: dateObj.toISOString().split('T')[0],
            description: values[descIdx],
            debit: debitAmount,
            credit: creditAmount
        });
    }
    return items;
}




 // Handles the submission of the "Edit Staff" modal form
 async function handleUpdateStaff(event) {
    event.preventDefault(); // Prevent default form submission
    const staffId = document.getElementById('edit-staff-id').value;
    const btn = event.target.querySelector('button[type="submit"]');
    const originalBtnText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> सेव हो रहा है...`;

    // Collect data from the edit form
    const data = {
        name: document.getElementById('edit-staff-name').value,
        role: document.getElementById('edit-staff-role').value,
        status: document.getElementById('edit-staff-status').value,
    };
    // Note: Password update logic is currently commented out as per previous code
    const newPassword = document.getElementById('edit-staff-password').value;
    if (newPassword) {
         showMessage('चेतावनी', 'पासवर्ड बदलने की सुविधा अभी लागू नहीं है। कृपया एडमिन पैनल से बदलें या संपर्क करें।', 'warning');
         // If you implement password change on the server via PUT /api/users/:userId, uncomment below
         // data.password = newPassword;
    }

    try {
        // Send PUT request to update user endpoint
        const res = await fetchApi(`/api/users/${staffId}`, { method: 'PUT', body: data });
        if (res.success) {
            showMessage('सफलता', 'स्टाफ सदस्य सफलतापूर्वक अपडेट किया गया।', 'success');
            if (staffEditModal) staffEditModal.hide(); // Hide the modal
            renderStaff(); // Refresh the staff list
        } else {
            throw new Error(res.message);
        }
    } catch (e) {
        showMessage('त्रुटि', `स्टाफ अपडेट करने में विफल: ${e.message}`, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalBtnText;
    }
}

// Handles the deletion of a staff member
async function handleDeleteStaff(staffId) {
    // Prevent admin from deleting themselves
    if (staffId === AppState.user.id) {
        showMessage('अनुमति नहीं', 'आप खुद को डिलीट नहीं कर सकते।', 'warning');
        return;
    }

    if (!confirm(`क्या आप वाकई स्टाफ सदस्य ID ${staffId} को हटाना चाहते हैं? यह क्रिया वापस नहीं ली जा सकती।`)) return;

    try {
        // Send DELETE request to delete user endpoint
        const res = await fetchApi(`/api/users/${staffId}`, { method: 'DELETE' });
         if (res.success) {
            showMessage('सफलता', 'स्टाफ सदस्य सफलतापूर्वक हटाया गया।', 'success');
            renderStaff(); // Refresh the staff list
        } else {
            throw new Error(res.message);
        }
    } catch (e) {
         showMessage('त्रुटि', `स्टाफ हटाने में विफल: ${e.message}`, 'danger');
    }
}

    // --- APPLICATION UNLOCK & INITIALIZATION ---
   // ... (unlockApplication फ़ंक्शन)
   const unlockApplication = () => {
        // 🚀 नया: नए लॉगिन पेज को छिपाएँ
        const authContainerNew = document.getElementById('auth-container-new');
        if (authContainerNew) authContainerNew.classList.add('hidden');
        
        // पुराना कोड (auth-container को छिपाने के लिए)
        //document.getElementById('auth-container').classList.add('hidden');//
        
        // बाकी का आपका कोड...
        document.getElementById('sidebar').classList.remove('locked');
        document.getElementById('main-content').classList.remove('locked');
        // ... (आदि) ...
        
        applyRBAC(AppState.user.role);
        setupForm('add-stock-form', '/api/stock', () => { /* ... */ });
        // ... (आपके सभी setupForm और setupNewFormHandlers कॉल्स) ...
        renderView('dashboard');
    };


    /**
     * Hides/Shows UI elements based on user role
     * Roles: ADMIN (3) > MANAGER (2) > CASHIER (1)
     */
     function applyRBAC(role) {
        const roles = { 'ADMIN': 3, 'MANAGER': 2, 'CASHIER': 1, 'ANY': 0 };
        const userLevel = roles[role.toUpperCase()] || 0; // Get user's level

        // Loop through all elements that require a role
        document.querySelectorAll('[data-role]').forEach(el => {
            const requiredRole = el.dataset.role.toUpperCase();
            const requiredLevel = roles[requiredRole];
            
            if(requiredRole === 'ANY' || userLevel >= requiredLevel) {
                 el.classList.remove('d-none'); // Show element
            } else {
                el.classList.add('d-none'); // Hide element
            }
        });
    }
    
    // --- INVOICE GENERATOR FUNCTIONS ---
    function initializeQRUpload() {
        console.log("Initializing QR Upload...");
        const qrUploadInput = document.getElementById('qrUpload'); //
        if (qrUploadInput) {
            qrUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) {
                    qrCodeImage = '';
                    updateInvoicePreview();
                    return;
                }
                
                // फ़ाइल को Base64 स्ट्रिंग में बदलें
                const reader = new FileReader();
                reader.onload = (event) => {
                    qrCodeImage = event.target.result; // Base64 डेटा
                    updateInvoicePreview(); // प्रीव्यू को QR कोड के साथ रीफ्रेश करें
                };
                reader.readAsDataURL(file);
            });
        }
    }
    // --- REPORT ACTION HANDLER ---
    function handleReportAction(reportType, action) {
        const reportCardId = reportType === 'profit_loss' ? 'pl-card' : 'bs-card';
        const reportElement = document.getElementById(reportCardId);

        if (action === 'print') {
            document.querySelectorAll('.printable').forEach(el => el.classList.remove('printable'));
            reportElement.classList.add('printable');
            window.print();
        } else if (action === 'download') {
            showMessage('Info', 'PDF बनाया जा रहा है, कृपया प्रतीक्षा करें...', 'info');
            html2canvas(reportElement, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const ratio = canvas.height / canvas.width;
                const pdfHeight = pdfWidth * ratio;
                pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth - 20, pdfHeight - 20);
                pdf.save(`${reportType}_report_${new Date().toISOString().slice(0,10)}.pdf`);
            }).catch(err => {
                showMessage('त्रुटि', 'PDF बनाने में विफल: ' + err.message, 'danger');
            });
        }
    }

    // --- UNIVERSAL DELETE FUNCTION ---
   async function deleteEntry(type, id) {
        // 'id' is now the primary key or SKU
        const messages = {
            sale: `(असमर्थित) क्या आप वाकई इस बिक्री (ID: ${id}) को हटाना चाहते हैं?`,
            stock: `क्या आप वाकई इस स्टॉक आइटम (SKU: ${id}) को हटाना चाहते हैं?`, // Changed to SKU
            customer: `(असमर्थित) क्या आप वाकई इस ग्राहक (ID: ${id}) को हटाना चाहते हैं?`,
            purchase: `क्या आप वाकई इस खरीद रिकॉर्ड (ID: ${id}) को हटाना चाहते हैं?`,
            expense: `क्या आप वाकई इस खर्च रिकॉर्ड (ID: ${id}) को हटाना चाहते हैं?`
        };

        if (!confirm(messages[type])) return;

        let apiPath = '';
        let successCallback;

        switch (type) {
            case 'stock': apiPath = `/api/stock/${id}`; successCallback = fetchAndRenderStockList; break;
            case 'purchase': apiPath = `/api/purchases/${id}`; successCallback = fetchAndRenderPurchases; break; 
            case 'expense': apiPath = `/api/expenses/${id}`; successCallback = fetchAndRenderExpenses; break; 
            
            case 'sale': 
            case 'customer':
            default: 
                showMessage('त्रुटि', 'यह क्रिया (delete) सर्वर द्वारा समर्थित नहीं है।', 'danger'); 
                return;
        }

        try {
            const res = await fetchApi(apiPath, { method: 'DELETE' }, 'हटाया जा रहा है...');
            if (res.success) {
                showMessage('सफलता', res.message, 'success');
                if (successCallback) successCallback();
                renderDashboard();
                renderReports();
            } else {
                throw new Error(res.message);
            }
        } catch (error) {
            showMessage('त्रुटि', `हटाने में विफल: ${error.message}`, 'danger');
        }
    }


    function addItem() {
        const itemName = document.getElementById('itemName').value; //
        const quantity = parseFloat(document.getElementById('quantity').value); //
        const price = parseFloat(document.getElementById('price').value); //
        const gst = parseFloat(document.getElementById('gst').value) || 0; //

        if (!itemName || !quantity || !price) {
            showMessage('Error', 'Please fill Item Name, Quantity, and Rate.', 'danger');
            return;
        }

        items.push({ name: itemName, quantity: quantity, price: price, gst: gst });
        updateInvoicePreview();
        
        document.getElementById('item-form').reset(); //
        document.getElementById('itemName').focus();
    }

    function deleteItem(index) {
        if (confirm('Are you sure you want to delete this item?')) {
            items.splice(index, 1);
            updateInvoicePreview();
        }
    }

    function updateInvoicePreview() {
        const shopName = document.getElementById('shopName').value || 'Shop Name';
        const shopContact = document.getElementById('shopContact').value || 'Contact No.';
        const shopAddress = document.getElementById('shopAddress').value || 'Shop Address';
        const shopGstin = document.getElementById('shopGstin').value || '';
        
        const customerName = document.getElementById('customerName').value || 'Customer Name';
        const customerContact = document.getElementById('customerContact').value || 'Contact No.';
        const customerAddress = document.getElementById('customerAddress').value || 'Customer Address';
        
        const preview = document.getElementById('invoice-preview'); //
        
        let itemRows = '';
        let totalAmount = 0;
        let totalTax = 0;
        let subTotal = 0;
        
        items.forEach((item, index) => {
            const itemSubTotal = (item.price || 0) * (item.quantity || 0);
            const itemGst = itemSubTotal * ((item.gst || 0) / 100);
            const itemTotal = itemSubTotal + itemGst;
            
            subTotal += itemSubTotal;
            totalTax += itemGst;
            totalAmount += itemTotal;
            
            itemRows += `
                <tr>
                    <td>${index + 1}</td>
                    <td style="text-align: left;">${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${formatCurrency(item.price)}</td>
                    <td>${item.gst}%</td>
                    <td>${formatCurrency(itemSubTotal)}</td>
                    <td>
                        <button class="btn btn-danger btn-sm py-0 px-1 no-print" onclick="deleteItem(${index})">&times;</button>
                    </td>
                </tr>
            `;
        });

        const cgst = totalTax / 2;
        const sgst = totalTax / 2;
        
        // 🚀 (फिक्स) QR कोड के लिए HTML
        const qrHtml = qrCodeImage ? `
            <div id="qr-preview" class="text-center">
                <p class="small mb-1">Scan to Pay:</p>
                <img src="${qrCodeImage}" alt="UPI QR Code" style="max-width: 100px; max-height: 100px; border: 1px solid #ccc; padding: 3px;">
            </div>` : '';

        // पूरा इनवॉइस HTML
        preview.innerHTML = `
            <div class="printable">
                <div class="invoice-header">
                    <div class="shop-details">
                        <h3>${shopName}</h3>
                        <p class="mb-0">${shopAddress}</p>
                        <p class="mb-0">Ph: ${shopContact}</p>
                        ${shopGstin ? `<p class="mb-0"><strong>GSTIN: ${shopGstin}</strong></p>` : ''}
                    </div>
                    <h2 style="color: #333; align-self: center;">INVOICE</h2>
                </div>
                
                <div class="customer-details row">
                    <div class="col-8">
                        <strong>Bill To:</strong>
                        <p class="mb-0">${customerName}</p>
                        <p class="mb-0">${customerAddress}</p>
                        <p class="mb-0">Ph: ${customerContact}</p>
                    </div>
                    <div class="col-4 text-end">
                        <p class="mb-0"><strong>Invoice No:</strong> INV-${Date.now().toString().slice(-6)}</p>
                        <p class="mb-0"><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                    </div>
                </div>

                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">#</th>
                            <th style="text-align: left;">Item</th>
                            <th style="width: 10%;">Qty</th>
                            <th style="width: 15%;">Rate</th>
                            <th style="width: 10%;">GST%</th>
                            <th style="width: 15%;">Amount</th>
                            <th style="width: 5%;" class="no-print"></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemRows || `<tr><td colspan="7" class="text-center text-muted p-4">No items added.</td></tr>`}
                    </tbody>
                </table>
                
                <div class="invoice-footer">
                    <div>
                        ${qrHtml} <div class="terms mt-3">
                            <strong>Terms & Conditions:</strong>
                            <p class="mb-0">1. Goods once sold will not be taken back.</p>
                            <p class="mb-0">2. All disputes are subject to jurisdiction.</p>
                        </div>
                    </div>
                    
                    <table class="totals-table">
                        <tbody>
                            <tr>
                                <td>Subtotal:</td>
                                <td style="text-align: right;">${formatCurrency(subTotal)}</td>
                            </tr>
                            <tr>
                                <td>CGST:</td>
                                <td style="text-align: right;">${formatCurrency(cgst)}</td>
                            </tr>
                            <tr>
                                <td>SGST:</td>
                                <td style="text-align: right;">${formatCurrency(sgst)}</td>
                            </tr>
                            <tr style="font-weight: bold; font-size: 1.2em; border-top: 2px solid #333;">
                                <td>Grand Total:</td>
                                <td style="text-align: right;">${formatCurrency(totalAmount)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }


   function downloadInvoicePDF() {
        if (items.length === 0) {
            return showMessage('त्रुटि', 'PDF बनाने के लिए कृपया पहले आइटम जोड़ें।', 'warning');
        }
        handleReportAction('invoice', 'download');
    }

    function printInvoice() {
        window.print();
    }

    function clearBill() {
        if (confirm('Are you sure you want to clear the entire bill?')) {
            items = [];
            qrCodeImage = '';
            document.getElementById('qrUpload').value = null;
            document.getElementById('customerName').value = '';
            document.getElementById('customerContact').value = '';
            document.getElementById('customerAddress').value = '';
            document.getElementById('item-form').reset();
            
            // शॉप की डिटेल्स को फिर से भरें (उन्हें क्लियर न करें)
            fetchAndPopulateShopData(); 
            
            showMessage('Success', 'Bill cleared.', 'success');
        }
    }
   // ===================================
    // STEP 6: NEW AUTHENTICATION FLOW & NEW FEATURES
    // ===================================

    /**
     * Saves auth data to AppState and localStorage
     */
     function saveAuthData(token, user) {
        AppState.token = token;
        AppState.user = user;
        localStorage.setItem('authToken', token);
        localStorage.setItem('authUser', JSON.stringify(user));
        
        // Update UI with user info
        updateShopDisplay(user);
    }
    
    // NEW: Update Shop Name/Logo in UI
   // NEW: Update Shop Name/Logo in UI
  // NEW: Update Shop Name/Logo in UI
  function updateShopDisplay(user) {
        if (!user) return;
        const shopName = user.shopName || 'Dukan Pro';
        
        // 🚀 FIX: पहले सर्वर से आया हुआ लोगो, अगर नहीं तो Local Storage से लें
        const storedLogo = localStorage.getItem('shopLogoData');
        const shopLogo = user.shopLogo || storedLogo; 

        document.getElementById('user-shop-name').innerText = shopName;
        document.getElementById('user-name-email').innerText = `${user.name} (${user.role})`;
        
        const logoContainer = document.getElementById('shop-logo-container');
        if (shopLogo) {
            logoContainer.innerHTML = `<img src="${shopLogo}" alt="Shop Logo" class="img-fluid rounded-circle" style="max-height: 100px; border: 3px solid #fff;">`;
            
            // यह सुनिश्चित करें कि UI के अन्य भाग भी अपडेट हो जाएँ
            document.getElementById('remove-shop-logo-btn').classList.remove('d-none');
            document.getElementById('shop-logo-preview').src = shopLogo; 
            document.getElementById('shop-logo-preview').style.display = 'block';
        } else {
            logoContainer.innerHTML = '';
            document.getElementById('remove-shop-logo-btn').classList.add('d-none');
            document.getElementById('shop-logo-preview').style.display = 'none';
        }
    }


    /**
     * Clears auth data and reloads the page to show login screen
     */
     function logout() {
        AppState.token = null;
        AppState.user = null;
        localStorage.removeItem('authToken');
        localStorage.removeItem('authUser');
        if(AppState.licenseTimerId) clearInterval(AppState.licenseTimerId);
        window.location.reload(); 
        
        // 🚀 नया: रीलोड करने से पहले लॉगिन पेज दिखाएँ (वैकल्पिक, लेकिन स्मूथ)
        const authContainerNew = document.getElementById('auth-container-new');
        if (authContainerNew) authContainerNew.classList.remove('hidden');
    }
    
    // NEW: License Timer and Renewal Warning
    function startLicenseTimer(expiryDateStr) {
        const timerEl = document.getElementById('license-timer');
        const renewalModal = new bootstrap.Modal(document.getElementById('renewalModal'));
        if (AppState.licenseTimerId) clearInterval(AppState.licenseTimerId);
        
        if (!expiryDateStr) {
            timerEl.innerHTML = `<i class="fas fa-times-circle text-danger"></i> लाइसेंस सक्रिय नहीं है`;
            timerEl.className = 'text-center mb-2 expired';
            timerEl.onclick = () => renewalModal.show();
            return;
        }

        const expiryDate = new Date(expiryDateStr);
        
        function updateTimer() {
            const now = new Date();
            const timeLeft = expiryDate.getTime() - now.getTime();
            
            const daysLeft = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hoursLeft = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutesLeft = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const secondsLeft = Math.floor((timeLeft % (1000 * 60)) / 1000);

            if (timeLeft <= 0) {
                timerEl.innerHTML = `<i class="fas fa-times-circle"></i> लाइसेंस समाप्त हो गया है`;
                timerEl.className = 'text-center mb-2 expired';
                timerEl.onclick = () => renewalModal.show();
                clearInterval(AppState.licenseTimerId);
            } else if (daysLeft < 7) {
                // Requirement 9: Expiring soon warning
                timerEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${daysLeft}d ${hoursLeft}h में समाप्त होगा!`;
                timerEl.className = 'text-center mb-2 expiring-soon';
                timerEl.onclick = () => renewalModal.show();
            } else {
                timerEl.innerHTML = `<i class="fas fa-check-circle text-success"></i> ${daysLeft} दिन ${hoursLeft} घंटे शेष`;
                timerEl.className = 'text-center text-white-50 mb-2';
                timerEl.onclick = null;
            }
        }
        
        updateTimer();
        AppState.licenseTimerId = setInterval(updateTimer, 1000); // Update every second
    }
    
    // NEW: Send WhatsApp Renewal Request
    function sendWhatsAppRenewal(months) {
        const adminPhone = "7303410987";
        let message = `नमस्ते Dukan Pro एडमिन,\n\n`;
        message += `मेरा नाम ${AppState.user.name} है और मेरी शॉप का नाम ${AppState.user.shopName} (Shop ID: ${AppState.user.shopId}) है।\n`;
        message += `मेरा ईमेल: ${AppState.user.email}\n\n`;
        message += `मैं अपना Dukan Pro लाइसेंस ${months} महीने के लिए रिन्यू करना चाहता हूँ। कृपया भुगतान विवरण प्रदान करें।\n\nधन्यवाद।`;
        
        const whatsappUrl = `https://wa.me/${adminPhone}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
    }
    
    // NEW: Barcode Scanning Functions
    function focusBarcodeScanner() {
        const scannerInput = document.getElementById('barcode-scanner-input');
        // Only focus if we are on the sales page
        if(AppState.currentView === 'sales') {
            scannerInput.focus();
        }
    }
    
       
    // NEW: Functions for New Sections
    async function fetchAndRenderClosingReports() {
    console.log("🚀 fetchAndRenderClosingReports() शुरू हुआ..."); // Log Start
    const tableBody = document.getElementById('daily-closing-table-body');
    if (!tableBody) {
         console.error("❌ एरर: daily-closing-table-body नहीं मिला!");
         return;
    }
    tableBody.innerHTML = `<tr><td colspan="5" class="text-center">लोड हो रहा है...</td></tr>`;
    try {
        console.log("📡 API कॉल /api/closing/reports भेजा जा रहा है...");
        const res = await fetchApi('/api/closing/reports', { method: 'GET' });
        console.log("📄 API रिस्पांस मिला:", res); // Log Response

        if (res.success && res.reports && res.reports.length > 0) {
             console.log(`📊 ${res.reports.length} रिपोर्ट्स मिलीं। HTML बना रहा हूँ...`);
            tableBody.innerHTML = res.reports.map(r => `
                <tr>
                    <td>${new Date(r.closing_date).toLocaleDateString()}</td>
                    <td>${formatCurrency(r.total_sales)}</td>
                    <td>${formatCurrency(r.total_cogs)}</td>
                    <td>${formatCurrency(r.total_expenses)}</td>
                    <td class="fw-bold ${r.net_profit >= 0 ? 'text-success' : 'text-danger'}">
                        ${formatCurrency(r.net_profit)}
                    </td>
                </tr>
            `).join('');
             console.log("✅ टेबल HTML अपडेट हो गया।");
        } else {
             console.log("ℹ️ कोई रिपोर्ट नहीं मिली या API विफल।");
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">कोई क्लोजिंग रिपोर्ट नहीं मिली।</td></tr>`;
        }
    } catch (e) {
        console.error("❌ fetchAndRenderClosingReports एरर:", e); // Log Error
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">त्रुटि: ${e.message}</td></tr>`;
    }
     console.log("🏁 fetchAndRenderClosingReports() खत्म हुआ।"); // Log End
}
    
    async function fetchAndRenderShopSettings() {
        try {
            // Fetch company profile (GST info) [cite: 349]
            const profileRes = await fetchApi('/api/shop/company-profile', { method: 'GET' });
            if (profileRes.success && profileRes.profile) {
                document.getElementById('company-legal-name').value = profileRes.profile.legal_name || '';
                document.getElementById('company-gstin').value = profileRes.profile.gstin || '';
                document.getElementById('company-address').value = profileRes.profile.address || '';
                // 🚀 FIX: पूंजी लोड करने के लिए यह लाइन जोड़ी
                document.getElementById('company-opening-capital').value = profileRes.profile.opening_capital || '0'; 
            }
            
            // Fetch display settings (from user object)
            document.getElementById('shop-display-name').value = AppState.user.shopName || '';
            const logoPreview = document.getElementById('shop-logo-preview');
            if (AppState.user.shopLogo) {
                logoPreview.src = AppState.user.shopLogo;
                logoPreview.style.display = 'block';
            } else {
                logoPreview.style.display = 'none';
            }
        } catch (e) {
            showMessage('त्रुटि', `सेटिंग्स लोड करने में विफल: ${e.message}`, 'danger');
        }
    }
    
    // NEW: Handle complex backup downloads
    async function handleBackupDownloads(type) {
        if (type === 'json') {
            try {
                const res = await fetchApi('/api/backup', { method: 'GET' }, 'JSON बैकअप बनाया जा रहा है...');
                if (res.success) {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(res.backupData, null, 2));
                    const dlAnchorElem = document.createElement('a');
                    dlAnchorElem.setAttribute("href", dataStr);
                    dlAnchorElem.setAttribute("download", `dukan_pro_backup_${AppState.user.shopId}_${getISODate()}.json`);
                    dlAnchorElem.click();
                } else {
                    showMessage('त्रुटि', res.message, 'danger');
                }
            } catch (e) { showMessage('त्रुटि', e.message, 'danger'); }
        
        } else if (type === 'excel') {
            try {
                const res = await fetchApi('/api/backup', { method: 'GET' }, 'Excel बैकअप बनाया जा रहा है...');
                if (res.success) {
                    const wb = XLSX.utils.book_new();
                    for (const tableName in res.backupData) {
                        const ws = XLSX.utils.json_to_sheet(res.backupData[tableName]);
                        XLSX.utils.book_append_sheet(wb, ws, tableName.slice(0, 31)); // Sheet name limit 31 chars
                    }
                    XLSX.writeFile(wb, `dukan_pro_backup_${AppState.user.shopId}_${getISODate()}.xlsx`);
                } else {
                    showMessage('त्रुटि', res.message, 'danger');
                }
            } catch (e) { showMessage('त्रुटि', e.message, 'danger'); }
            
        } else if (type === 'csv') {
            const startDate = document.getElementById('product-report-start-date').value;
            const endDate = document.getElementById('product-report-end-date').value;
            if (!startDate || !endDate) {
                return showMessage('तारीख चुनें', "कृपया उत्पाद बिक्री CSV के लिए 'Reports' टैब में तारीख चुनें।", 'warning');
            }
            // Use the dedicated server endpoint [cite: 331]
            const url = `${__backend_url}/api/reports/product-sales/download?startDate=${startDate}&endDate=${endDate}&token=${AppState.token}`;
            // Hacky way to download with token (GET request)
            window.open(url, '_blank');
        }
    }


    // अपने अन्य JavaScript फंक्शन्स के साथ इसे जोड़ें
function removeShopLogo() {
    // 1. ग्लोबल वेरिएबल को रीसेट करें
    shopLogoBase64 = null; 
    // 2. HTML साफ़ करें
    document.getElementById('shop-logo-preview').src = '';
    document.getElementById('shop-logo-preview').style.display = 'none';
    document.getElementById('shop-logo-upload').value = null; // फ़ाइल इनपुट साफ़ करें
    document.getElementById('remove-shop-logo-btn').classList.add('d-none');
    
    showMessage('सावधान', 'लोगो हटाने के लिए "डिस्प्ले सेव करें" पर क्लिक करें।', 'warning');
}
    
    // NEW: Setup listeners for all new forms and buttons
    function setupNewFormHandlers() {
        // Product Sales Report Button
        document.getElementById('fetch-product-sales-report-btn').addEventListener('click', async () => {
            const startDate = document.getElementById('product-report-start-date').value;
            const endDate = document.getElementById('product-report-end-date').value;
            if (!startDate || !endDate) {
                return showMessage('तारीख चुनें', 'कृपया तारीख चुनें।', 'warning');
            }
            const tableBody = document.getElementById('product-sales-report-body');
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center">रिपोर्ट लोड हो रही है...</td></tr>`;
            try {
                const res = await fetchApi(`/api/reports/product-sales?startDate=${startDate}&endDate=${endDate}`, { method: 'GET' });
                if (res.success && res.report.length > 0) {
                    tableBody.innerHTML = res.report.map(r => `
                        <tr>
                            <td>${r.item_sku}</td>
                            <td>${r.item_name}</td>
                            <td>${r.total_quantity_sold}</td>
                            <td>${formatCurrency(r.total_revenue)}</td>
                            <td>${formatCurrency(r.total_cost)}</td>
                            <td class="fw-bold ${r.total_profit >= 0 ? 'text-success' : 'text-danger'}">
                                ${formatCurrency(r.total_profit)}
                            </td>
                        </tr>
                    `).join('');
                } else {
                     tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">इस अवधि में कोई बिक्री नहीं मिली।</td></tr>`;
                }
            } catch (e) { tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">त्रुटि: ${e.message}</td></tr>`; }
        });
        
        // GST Report Buttons
        const gstResultEl = document.getElementById('gst-report-result');
        const gstTitleEl = document.getElementById('gst-report-title');
        
        // --- TALLY UPDATE START: GSTR-1 Button Logic ---
        document.getElementById('fetch-gstr1-report-btn').addEventListener('click', async () => {
            const startDate = document.getElementById('gst-report-start-date').value;
            const endDate = document.getElementById('gst-report-end-date').value;
            if (!startDate || !endDate) return showMessage('त्रुटि', 'कृपया तारीख चुनें।', 'warning');
            
            // नए HTML टैब कंटेंट एरिया को टारगेट करें
            const gstr1ContentEl = document.getElementById('gstr1-report-content');
            const mainGstTitleEl = document.getElementById('gst-report-title'); // यह पुराना टाइटल है, इसे छिपा भी सकते हैं
            
            if(mainGstTitleEl) mainGstTitleEl.innerText = "GSTR-1 (बिक्री) रिपोर्ट (लोड हो रही है...)";
            gstr1ContentEl.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

            // GSTR-1 टैब को सक्रिय करें
            new bootstrap.Tab(document.getElementById('gst-gstr1-tab')).show();

            try {
                const res = await fetchApi(`/api/reports/gstr1?startDate=${startDate}&endDate=${endDate}`, { method: 'GET' });
                if (!res.success) throw new Error(res.message || 'GSTR-1 रिपोर्ट लाने में विफल।');
                
                if(mainGstTitleEl) mainGstTitleEl.innerText = `GSTR-1 (बिक्री) रिपोर्ट (${startDate} से ${endDate})`;
                const report = res.report;
                
                // 1. Tally-Style HTML Template को क्लोन करें
                const template = document.getElementById('gstr1-report-template');
                gstr1ContentEl.innerHTML = template.innerHTML; // टेम्पलेट को रिजल्ट एरिया में कॉपी करें

                // 2. B2B टेबल भरें
                const b2bTableBody = document.getElementById('gstr1-b2b-table').querySelector('tbody');
                const b2bTableFoot = document.getElementById('gstr1-b2b-table').querySelector('tfoot');
                let b2bTotalTaxable = 0, b2bTotalIgst = 0, b2bTotalCgst = 0, b2bTotalSgst = 0;
                b2bTableBody.innerHTML = ''; // पुरानी पंक्तियाँ साफ़ करें
                
                if (report.b2b && report.b2b.length > 0) {
                    report.b2b.forEach(item => {
                        const taxable = parseFloat(item.total_taxable_value) || 0;
                        const igst = parseFloat(item.total_igst) || 0;
                        const cgst = parseFloat(item.total_cgst) || 0;
                        const sgst = parseFloat(item.total_sgst) || 0;
                        b2bTotalTaxable += taxable;
                        b2bTotalIgst += igst;
                        b2bTotalCgst += cgst;
                        b2bTotalSgst += sgst;
                        
                        b2bTableBody.innerHTML += `
                            <tr>
                                <td class="text-left">${item.customer_gstin}</td>
                                <td class="text-left">${item.customer_name || 'N/A'}</td>
                                <td class="text-center">${item.invoice_number}</td>
                                <td class="text-center">${new Date(item.invoice_date).toLocaleDateString()}</td>
                                <td>${formatCurrency(taxable)}</td>
                                <td>${formatCurrency(igst)}</td>
                                <td>${formatCurrency(cgst)}</td>
                                <td>${formatCurrency(sgst)}</td>
                            </tr>
                        `;
                    });
                } else {
                    b2bTableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">इस अवधि में कोई B2B (GSTIN वाली) बिक्री नहीं मिली।</td></tr>';
                }
                b2bTableFoot.innerHTML = `<tr><td colspan="4" class="text-left">B2B कुल</td><td>${formatCurrency(b2bTotalTaxable)}</td><td>${formatCurrency(b2bTotalIgst)}</td><td>${formatCurrency(b2bTotalCgst)}</td><td>${formatCurrency(b2bTotalSgst)}</td></tr>`;

                // 3. B2C टेबल भरें
                const b2cTableBody = document.getElementById('gstr1-b2c-table').querySelector('tbody');
                const b2cTableFoot = document.getElementById('gstr1-b2c-table').querySelector('tfoot');
                let b2cTotalTaxable = 0, b2cTotalIgst = 0, b2cTotalCgst = 0, b2cTotalSgst = 0, b2cTotalTax = 0;
                b2cTableBody.innerHTML = ''; // पुरानी पंक्तियाँ साफ़ करें
                
                if (report.b2c && report.b2c.length > 0) {
                    report.b2c.forEach(item => {
                        const taxable = parseFloat(item.taxable_value) || 0;
                        const igst = parseFloat(item.total_igst) || 0;
                        const cgst = parseFloat(item.total_cgst) || 0;
                        const sgst = parseFloat(item.total_sgst) || 0;
                        const tax = parseFloat(item.total_tax) || 0;
                        b2cTotalTaxable += taxable;
                        b2cTotalIgst += igst;
                        b2cTotalCgst += cgst;
                        b2cTotalSgst += sgst;
                        b2cTotalTax += tax;

                        b2cTableBody.innerHTML += `
                            <tr>
                                <td class="text-left">${item.place_of_supply || 'N/A'}</td>
                                <td class="text-center">${item.gst_rate}%</td>
                                <td>${formatCurrency(taxable)}</td>
                                <td>${formatCurrency(igst)}</td>
                                <td>${formatCurrency(cgst)}</td>
                                <td>${formatCurrency(sgst)}</td>
                                <td>${formatCurrency(tax)}</td>
                            </tr>
                        `;
                    });
                } else {
                    b2cTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">इस अवधि में कोई B2C (छोटी) बिक्री नहीं मिली।</td></tr>';
                }
                b2cTableFoot.innerHTML = `<tr><td colspan="2" class="text-left">B2C कुल</td><td>${formatCurrency(b2cTotalTaxable)}</td><td>${formatCurrency(b2cTotalIgst)}</td><td>${formatCurrency(b2cTotalCgst)}</td><td>${formatCurrency(b2cTotalSgst)}</td><td>${formatCurrency(b2cTotalTax)}</td></tr>`;

                // 4. HSN टेबल भरें
                const hsnTableBody = document.getElementById('gstr1-hsn-table').querySelector('tbody');
                const hsnTableFoot = document.getElementById('gstr1-hsn-table').querySelector('tfoot'); // tfoot भी जोड़ें
                let hsnTotalQty = 0, hsnTotalTaxable = 0, hsnTotalIgst = 0, hsnTotalCgst = 0, hsnTotalSgst = 0, hsnTotalTax = 0;
                hsnTableBody.innerHTML = ''; // पुरानी पंक्तियाँ साफ़ करें
                
                if (report.hsn_summary && report.hsn_summary.length > 0) {
                    report.hsn_summary.forEach(item => {
                        const qty = parseFloat(item.total_quantity) || 0;
                        const taxable = parseFloat(item.total_taxable_value) || 0;
                        const igst = parseFloat(item.total_igst) || 0;
                        const cgst = parseFloat(item.total_cgst) || 0;
                        const sgst = parseFloat(item.total_sgst) || 0;
                        const tax = parseFloat(item.total_tax) || 0;
                        
                        hsnTotalQty += qty;
                        hsnTotalTaxable += taxable;
                        hsnTotalIgst += igst;
                        hsnTotalCgst += cgst;
                        hsnTotalSgst += sgst;
                        hsnTotalTax += tax;
                        
                        hsnTableBody.innerHTML += `
                            <tr>
                                <td class="text-center">${item.hsn_code || 'N/A'}</td>
                                <td class="text-left">${item.item_name}</td>
                                <td class="text-center">${item.unit || 'Pcs'}</td>
                                <td class="text-center">${qty}</td>
                                <td>${formatCurrency(taxable)}</td>
                                <td>${formatCurrency(igst)}</td>
                                <td>${formatCurrency(cgst)}</td>
                                <td>${formatCurrency(sgst)}</td>
                                <td>${formatCurrency(tax)}</td>
                            </tr>
                        `;
                    });
                } else {
                    hsnTableBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">इस अवधि के लिए कोई HSN समरी नहीं मिली।</td></tr>';
                }
                // HSN Total Foot
                if (hsnTableFoot) {
                    hsnTableFoot.innerHTML = `<tr><td colspan="3" class="text-left">HSN कुल</td><td class="text-center">${hsnTotalQty}</td><td>${formatCurrency(hsnTotalTaxable)}</td><td>${formatCurrency(hsnTotalIgst)}</td><td>${formatCurrency(hsnTotalCgst)}</td><td>${formatCurrency(hsnTotalSgst)}</td><td>${formatCurrency(hsnTotalTax)}</td></tr>`;
                }


                // 5. Tabs को फिर से सक्रिय करें (क्योंकि हमने HTML को फिर से लिखा है)
                var triggerTabList = [].slice.call(document.querySelectorAll('#gstr1-inner-tab button'));
                triggerTabList.forEach(function (triggerEl) {
                    var tabTrigger = new bootstrap.Tab(triggerEl);
                    triggerEl.addEventListener('click', function (event) {
                        event.preventDefault();
                        tabTrigger.show();
                    });
                });
                // पहले टैब (B2B) को डिफ़ॉल्ट रूप से दिखाएं
                new bootstrap.Tab(document.getElementById('gstr1-b2b-tab')).show();


            } catch (e) { 
                if(mainGstTitleEl) mainGstTitleEl.innerText = "GSTR-1 रिपोर्ट";
                gstr1ContentEl.innerHTML = `<div class="text-danger p-4">त्रुटि: ${e.message}</div>`;
            }
        });
        // --- TALLY UPDATE END: GSTR-1 Button Logic ---
        
        
        // --- TALLY UPDATE START: GSTR-2 Button Logic ---
        document.getElementById('fetch-gstr2-report-btn').addEventListener('click', async () => {
            const startDate = document.getElementById('gst-report-start-date').value;
            const endDate = document.getElementById('gst-report-end-date').value;
            if (!startDate || !endDate) return showMessage('त्रुटि', 'कृपया तारीख चुनें।', 'warning');
            
            const gstr2ContentEl = document.getElementById('gstr2-report-content');
            const mainGstTitleEl = document.getElementById('gst-report-title'); // पुराना टाइटल
            
            if(mainGstTitleEl) mainGstTitleEl.innerText = "GSTR-2 (खरीद) रिपोर्ट (लोड हो रही है...)";
            gstr2ContentEl.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-warning" role="status"><span class="visually-hidden">Loading...</span></div></div>';

            // GSTR-2 टैब को सक्रिय करें
            new bootstrap.Tab(document.getElementById('gst-gstr2-tab')).show();

            try {
                const res = await fetchApi(`/api/reports/gstr2?startDate=${startDate}&endDate=${endDate}`, { method: 'GET' });
                if (!res.success) throw new Error(res.message || 'GSTR-2 रिपोर्ट लाने में विफल।');
                
                if(mainGstTitleEl) mainGstTitleEl.innerText = `GSTR-2 (खरीद) रिपोर्ट (${startDate} से ${endDate})`;
                const report = res.report;
                let tableHtml = '';

                // B2B Purchases Table
                tableHtml += '<h6>B2B (पंजीकृत सप्लायर से खरीद)</h6>';
                if (report.b2b_purchases && report.b2b_purchases.length > 0) {
                    tableHtml += '<table class="table gst-report-table"><thead><tr><th class="text-left">सप्लायर</th><th>बिल नं.</th><th>तारीख</th><th>टैक्सेबल वैल्यू (₹)</th><th>IGST (₹)</th><th>CGST (₹)</th><th>SGST (₹)</th></tr></thead><tbody>';
                    report.b2b_purchases.forEach(item => {
                        const details = item.gst_details || {}; // Get the JSONB data
                        tableHtml += `
                            <tr>
                                <td class="text-left">${item.supplier_name}</td>
                                <td class="text-center">${details.invoice_number || item.id}</td>
                                <td class="text-center">${new Date(item.created_at).toLocaleDateString()}</td>
                                <td>${formatCurrency(details.taxable_value)}</td>
                                <td>${formatCurrency(details.igst)}</td>
                                <td>${formatCurrency(details.cgst)}</td>
                                <td>${formatCurrency(details.sgst)}</td>
                            </tr>
                        `;
                    });
                    tableHtml += '</tbody></table>';
                } else {
                    tableHtml += '<p class="text-muted">इस अवधि में कोई GST वाली खरीद दर्ज नहीं की गई। (कृपया \'खरीद\' सेक्शन में GST Details जोड़ें)</p>';
                }

                // ITC Summary Table
                tableHtml += '<h6 class="mt-4">इनपुट टैक्स क्रेडिट (ITC) समरी</h6>';
                const itc = report.itc_summary || {};
                const totalTaxable = parseFloat(itc.total_taxable_value) || 0;
                const totalIgst = parseFloat(itc.total_igst) || 0;
                const totalCgst = parseFloat(itc.total_cgst) || 0;
                const totalSgst = parseFloat(itc.total_sgst) || 0;
                
                tableHtml += '<table class="table gst-report-table"><thead><tr><th class="text-left">विवरण</th><th>टैक्सेबल वैल्यू (₹)</th><th>IGST (₹)</th><th>CGST (₹)</th><th>SGST (₹)</th></tr></thead><tbody>';
                tableHtml += `
                    <tr class="subtotal-row">
                        <td class="text-left">कुल उपलब्ध ITC</td>
                        <td>${formatCurrency(totalTaxable)}</td>
                        <td>${formatCurrency(totalIgst)}</td>
                        <td>${formatCurrency(totalCgst)}</td>
                        <td>${formatCurrency(totalSgst)}</td>
                    </tr>
                `;
                tableHtml += '</tbody></table>';
                
                gstr2ContentEl.innerHTML = tableHtml;

            } catch (e) {
                if(mainGstTitleEl) mainGstTitleEl.innerText = "GSTR-2 रिपोर्ट";
                gstr2ContentEl.innerHTML = `<div class="text-danger p-4">त्रुटि: ${e.message}</div>`;
            }
        });
        // --- TALLY UPDATE END: GSTR-2 Button Logic ---


        // --- TALLY UPDATE START: GSTR-3B Button Logic ---
        document.getElementById('fetch-gstr3b-report-btn').addEventListener('click', async () => {
            const startDate = document.getElementById('gst-report-start-date').value;
            const endDate = document.getElementById('gst-report-end-date').value;
            if (!startDate || !endDate) return showMessage('त्रुटि', 'कृपया तारीख चुनें।', 'warning');

            const gstr3bContentEl = document.getElementById('gstr3b-report-content');
            const mainGstTitleEl = document.getElementById('gst-report-title'); // पुराना टाइटल
            
            if(mainGstTitleEl) mainGstTitleEl.innerText = "GSTR-3B (समरी) रिपोर्ट (लोड हो रही है...)";
            gstr3bContentEl.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

            // GSTR-3B टैब को सक्रिय करें
            new bootstrap.Tab(document.getElementById('gst-gstr3b-tab')).show();

            try {
                const res = await fetchApi(`/api/reports/gstr3b?startDate=${startDate}&endDate=${endDate}`, { method: 'GET' });
                if (!res.success) throw new Error(res.message || 'GSTR-3B रिपोर्ट लाने में विफल।');
                
                if(mainGstTitleEl) mainGstTitleEl.innerText = `GSTR-3B (समरी) रिपोर्ट (${startDate} से ${endDate})`;
                const report = res.report;
                let tableHtml = '';

                // Table 3.1: Outward Supplies (Sales)
                tableHtml += '<h6>3.1: बिक्री और टैक्स (Outward Supplies)</h6>';
                tableHtml += '<table class="table gst-report-table"><thead><tr><th class="text-left">विवरण</th><th>टैक्सेबल वैल्यू (₹)</th><th>IGST (₹)</th><th>CGST (₹)</th><th>SGST (₹)</th></tr></thead><tbody>';
                tableHtml += `
                    <tr class="subtotal-row">
                        <td class="text-left">(a) टैक्सेबल बिक्री</td>
                        <td>${formatCurrency(report.outward_supplies.taxable_value)}</td>
                        <td>${formatCurrency(report.outward_supplies.igst)}</td>
                        <td>${formatCurrency(report.outward_supplies.cgst)}</td>
                        <td>${formatCurrency(report.outward_supplies.sgst)}</td>
                    </tr>
                `;
                tableHtml += '</tbody></table>';

                // Table 4: Eligible ITC (Purchases)
                tableHtml += '<h6 class="mt-4">4: योग्य इनपुट टैक्स क्रेडिट (ITC)</h6>';
                tableHtml += '<table class="table gst-report-table"><thead><tr><th class="text-left">विवरण</th><th>IGST (₹)</th><th>CGST (₹)</th><th>SGST (₹)</th></tr></thead><tbody>';
                tableHtml += `
                    <tr>
                        <td class="text-left">(A) (5) सभी अन्य ITC (B2B खरीद)</td>
                        <td>${formatCurrency(report.inward_supplies_itc.igst)}</td>
                        <td>${formatCurrency(report.inward_supplies_itc.cgst)}</td>
                        <td>${formatCurrency(report.inward_supplies_itc.sgst)}</td>
                    </tr>
                    <tr class="subtotal-row">
                        <td class="text-left">(D) कुल उपलब्ध ITC (A)</td>
                        <td>${formatCurrency(report.inward_supplies_itc.igst)}</td>
                        <td>${formatCurrency(report.inward_supplies_itc.cgst)}</td>
                        <td>${formatCurrency(report.inward_supplies_itc.sgst)}</td>
                    </tr>
                `;
                tableHtml += '</tbody></table>';

                // Table 6.1: Payment of Tax (Net Tax)
                tableHtml += '<h6 class="mt-4">6.1: टैक्स भुगतान (Net Tax Payable)</h6>';
                tableHtml += '<table class="table gst-report-table"><thead><tr><th class="text-left">विवरण</th><th>IGST (₹)</th><th>CGST (₹)</th><th>SGST (₹)</th><th>कुल देय टैक्स (₹)</th></tr></thead><tbody>';
                tableHtml += `
                    <tr class="subtotal-row">
                        <td class="text-left">कुल देय टैक्स (बिक्री - खरीद)</td>
                        <td>${formatCurrency(report.net_tax_payable.igst)}</td>
                        <td>${formatCurrency(report.net_tax_payable.cgst)}</td>
                        <td>${formatCurrency(report.net_tax_payable.sgst)}</td>
                        <td>${formatCurrency(report.net_tax_payable.total)}</td>
                    </tr>
                `;
                tableHtml += '</tbody></table>';

                gstr3bContentEl.innerHTML = tableHtml;

            } catch (e) {
                if(mainGstTitleEl) mainGstTitleEl.innerText = "GSTR-3B रिपोर्ट";
                gstr3bContentEl.innerHTML = `<div class="text-danger p-4">त्रुटि: ${e.message}</div>`;
            }
        });
        // --- TALLY UPDATE END: GSTR-3B Button Logic ---

        
        // Daily Closing Button
        document.getElementById('run-daily-closing-btn').addEventListener('click', async () => {
            if (!confirm('क्या आप वाकई आज की क्लोजिंग रन करना चाहते हैं? यह क्रिया एक बार ही की जा सकती है।')) return;
            const msgEl = document.getElementById('closing-message');
            msgEl.className = 'mt-3 alert alert-info';
            msgEl.innerText = 'क्लोजिंग रन की जा रही है...';
            try {
                const res = await fetchApi('/api/closing/run', { method: 'POST' });
                if (res.success) {
                    msgEl.className = 'mt-3 alert alert-success';
                    msgEl.innerText = res.message;
                    fetchAndRenderClosingReports(); // Refresh the list
                } else {
                    throw new Error(res.message);
                }
            } catch (e) {
                msgEl.className = 'mt-3 alert alert-danger';
                msgEl.innerText = `त्रुटि: ${e.message}`;
            }
        });
        
        // Backup Buttons
        document.getElementById('download-json-backup-btn').addEventListener('click', () => handleBackupDownloads('json'));
        document.getElementById('download-excel-backup-btn').addEventListener('click', () => handleBackupDownloads('excel'));
        document.getElementById('download-product-sales-csv-btn').addEventListener('click', () => handleBackupDownloads('csv'));
        
        // Shop Settings Forms
        document.getElementById('company-profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                legal_name: document.getElementById('company-legal-name').value,
                gstin: document.getElementById('company-gstin').value,
                address: document.getElementById('company-address').value,
                // 🚀 FIX: पूंजी डेटा यहाँ जोड़ा गया
                opening_capital: document.getElementById('company-opening-capital').value 
            };
            try {
                const res = await fetchApi('/api/shop/company-profile', { method: 'POST', body: data });
                showMessage('सफलता', res.message, 'success');
            } catch (err) { showMessage('त्रुटि', err.message, 'danger'); }
        });
        
        let shopLogoBase64 = null; // Store logo data
        document.getElementById('shop-logo-upload').addEventListener('change', (e) => {
             const file = e.target.files[0];
             if (!file) return;
             const reader = new FileReader();
             reader.onload = (event) => {
                 shopLogoBase64 = event.target.result;
                 document.getElementById('shop-logo-preview').src = shopLogoBase64;
                 document.getElementById('shop-logo-preview').style.display = 'block';
                 document.getElementById('remove-shop-logo-btn').classList.remove('d-none');
             };
             reader.readAsDataURL(file);
        });
        
       // ... (बाकी कोड)
  // ... (लाइन 2244 के आसपास)

  document.getElementById('shop-display-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            shop_name: document.getElementById('shop-display-name').value,
            shop_logo: shopLogoBase64 || AppState.user.shopLogo // Send new logo or old one
        };
        try {
            const res = await fetchApi('/api/shop/settings', { method: 'POST', body: data });
            if (res.success) {
                // CRITICAL: Update token and user data with new shop name/logo
                saveAuthData(res.token, res.user);
                
                // 🚀 FIX: इमेज को Local Storage में भी सेव करें (सफलता पर)
                if (res.user.shopLogo) {
                    localStorage.setItem('shopLogoData', res.user.shopLogo);
                } else {
                    localStorage.removeItem('shopLogoData');
                }
                
                showMessage('सफलता', res.message, 'success');
            } else {
                // 🚀 FIX: यदि सर्वर 500 एरर दे, तो भी लोकल स्टोरेज में सेव करें (FallBack)
                if (shopLogoBase64) {
                     localStorage.setItem('shopLogoData', shopLogoBase64);
                     // Note: We don't call saveAuthData because the server update failed
                     showMessage('चेतावनी', 'सर्वर टाइमआउट हुआ। लोगो लोकल (Local) में सेव हो गया है, लेकिन अन्य यूज़र्स को देखने के लिए यह अभी भी डेटाबेस में सेव हो रहा है।', 'warning');
                } else {
                    throw new Error(res.message);
                }
            }
        } catch (err) { 
             // यदि Fetch API ही विफल हो जाता है
             showMessage('त्रुटि', err.message, 'danger');
        }
    });

// ... (बाकी कोड)

// Staff Form Listeners
const addStaffForm = document.getElementById('add-staff-form');
        if (addStaffForm && !addStaffForm.dataset.initialized) {
            addStaffForm.dataset.initialized = 'true';
            addStaffForm.addEventListener('submit', handleAddStaff);
        }
        const editStaffForm = document.getElementById('edit-staff-form');
         if (editStaffForm && !editStaffForm.dataset.initialized) {
            editStaffForm.dataset.initialized = 'true';
            editStaffForm.addEventListener('submit', handleUpdateStaff);
        }

    }

// 🚀🚀🚀 बैंक रिकॉन्सिलेशन लिस्नर यहाँ जोड़ें 🚀🚀🚀
document.getElementById('reconciliation-start-form').addEventListener('submit', handleStatementUpload);
        document.getElementById('save-reconciliation-btn').addEventListener('click', saveReconciliationReport);
        document.getElementById('cancel-reconciliation-btn').addEventListener('click', () => {
            if(confirm('क्या आप वाकई रिकॉन्सिलेशन रद्द करना चाहते हैं?')) {
                renderView('bank-reconciliation'); // पेज को रीसेट करें
            }
        });
        // 🚀🚀🚀 कोड यहाँ समाप्त होता है 🚀🚀🚀



// ==============================================
// 🚀 बैंक रिकॉन्सिलेशन लॉजिक फ़ंक्शंस
// ==============================================

/**
 * चरण 1: बैंक स्टेटमेंट CSV को अपलोड और पार्स करता है
 */
/**
 * चरण 1: बैंक स्टेटमेंट CSV को अपलोड और पार्स करता है
 */
 async function handleStatementUpload(event) {
    event.preventDefault();
    const btn = document.getElementById('start-reconciliation-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> अपलोड हो रहा है...';

    // 1. फॉर्म डेटा इकट्ठा करें
    const statementFile = document.getElementById('recon-statement-csv').files[0];
    const statementDate = document.getElementById('recon-statement-date').value;
    const statementBalance = parseFloat(document.getElementById('recon-statement-balance').value);

    if (!statementFile) {
        showMessage('त्रुटि', 'कृपया एक CSV फ़ाइल चुनें।', 'danger');
        btn.disabled = false; btn.innerHTML = '<i class="fas fa-play me-2"></i> रिकॉन्सिलेशन शुरू करें';
        return;
    }

    try {
        // 2. CSV फ़ाइल को टेक्स्ट के रूप में पढ़ें
        const csvText = await statementFile.text();
        
        // 3. टेक्स्ट को JSON में पार्स करें
        const statementItems = parseCSV(csvText);

        if (!statementItems || statementItems.length === 0) {
            throw new Error('CSV खाली है या पार्स नहीं किया जा सका।');
        }

        // 4. डेटा को नए API एंडपॉइंट पर भेजें
        const res = await fetchApi('/api/reconciliation/upload-statement', {
            method: 'POST',
            body: {
                statementDate,
                statementBalance,
                statementItems
            }
        }, 'ट्रांजैक्शन का मिलान किया जा रहा है...');

        if (res.success) {
            // 5. UI को "मैचिंग" मोड में बदलें
            document.getElementById('reconciliation-setup').classList.add('hidden');
            document.getElementById('reconciliation-matching-area').classList.remove('hidden');
            
            // 6. मैचिंग टेबल रेंडर करें
            renderReconciliationTables(res.bookItems, res.bankItems, statementBalance);
            showMessage('सफलता', 'स्टेटमेंट अपलोड हुआ। अब एंट्रीज़ का मिलान करें।', 'success');
        } else {
            throw new Error(res.message);
        }

    } catch (e) {
        showMessage('त्रुटि', `अपलोड विफल: ${e.message}`, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-play me-2"></i> रिकॉन्सिलेशन शुरू करें';
    }
}


 /**
 * चरण 2: बुक और बैंक ट्रांजैक्शन को लाता है और टेबल में दिखाता है
 * (इवेंट लिस्नर के साथ फिक्स्ड)
 */
function renderReconciliationTables(bookItems, bankItems, statementBalance) {
    const bookBody = document.getElementById('book-transactions-body');  
    const bankBody = document.getElementById('bank-transactions-body'); 
    bookBody.innerHTML = '';
    bankBody.innerHTML = '';

    let bookTotal = 0;
    let bankTotal = 0;

    // Dukan Pro (बुक) आइटम्स को भरें
    bookItems.forEach(item => {
        bookTotal += parseFloat(item.amount);
        bookBody.innerHTML += `
            <tr data-id="${item.type}-${item.id}" data-amount="${item.amount}">
                <td><input type="checkbox" class="recon-check-book"></td>
                <td>
                    ${item.description}
                    <small class="d-block text-muted">${new Date(item.date).toLocaleDateString()}</small>
                </td>
                <td>${formatCurrency(item.amount)}</td>
            </tr>
        `;
    });

    // बैंक स्टेटमेंट आइटम्स को भरें
    bankItems.forEach(item => {
        bankTotal += parseFloat(item.amount);
        bankBody.innerHTML += `
            <tr data-id="${item.id}" data-amount="${item.amount}">
                <td><input type="checkbox" class="recon-check-bank"></td>
                <td>
                    ${item.description}
                    <small class="d-block text-muted">${new Date(item.date).toLocaleDateString()}</small>
                </td>
                <td>${formatCurrency(item.amount)}</td>
            </tr>
        `;
    });

    // टोटल्स दिखाएँ
    document.getElementById('book-total').innerText = formatCurrency(bookTotal);  
    document.getElementById('bank-total').innerText = formatCurrency(bankTotal);  
    
    // रिपोर्ट में स्टेटमेंट बैलेंस सेट करें
    document.getElementById('report-statement-balance').innerText = formatCurrency(statementBalance);  
    
    // 🚀🚀🚀 यह नया कोड है (फ़ंक्शन के अंदर) 🚀🚀🚀
    // सभी चेकबॉक्स में 'change' इवेंट लिस्नर जोड़ें
    const allCheckboxes = document.querySelectorAll('.recon-check-book, .recon-check-bank, #check-all-book, #check-all-bank'); 
    allCheckboxes.forEach(cb => {
        cb.addEventListener('change', () => {
            // 'Select All' लॉजिक
            if (cb.id === 'check-all-book') {  
                document.querySelectorAll('.recon-check-book').forEach(bookCb => bookCb.checked = cb.checked);  
            }
            if (cb.id === 'check-all-bank') {  
                document.querySelectorAll('.recon-check-bank').forEach(bankCb => bankCb.checked = cb.checked);  
            }
            
            // मुख्य गणना फ़ंक्शन को कॉल करें
            calculateReconciliation();
        });
    });
    
    // पहली बार गणना (Calculate) चलाएँ
    calculateReconciliation();
    // 🚀🚀🚀 नया कोड समाप्त 🚀🚀🚀
}
/**
 * चरण 3: मिलान की गई एंट्रीज़ और रिपोर्ट को सेव करता है
 */
/**
 * चरण 3: मिलान की गई एंट्रीज़ और रिपोर्ट को सेव करता है
 */
 async function saveReconciliationReport() {
    const btn = document.getElementById('save-reconciliation-btn');  
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> सेव हो रहा है...';

    try {
        // 1. चेक्ड (matched) बैंक IDs इकट्ठा करें
        const reconciledBankIds = [];
        document.querySelectorAll('.recon-check-bank:checked').forEach(cb => {  
            reconciledBankIds.push(cb.closest('tr').dataset.id);
        });

        // 2. चेक्ड (matched) बुक Items इकट्ठा करें
        const reconciledBookItems = [];
        document.querySelectorAll('.recon-check-book:checked').forEach(cb => {  
            const idParts = cb.closest('tr').dataset.id.split('-'); // जैसे "invoice-123"
            reconciledBookItems.push({
                type: idParts[0],
                id: parseInt(idParts[1])
            });
        });
        
        // 3. रिपोर्ट का सारांश (Summary) इकट्ठा करें 
        const unclearedPaymentsAmount = parseFloat(document.getElementById('report-uncleared-payments').innerText.replace(/[^0-9.-]/g, '')); 
        const unclearedDepositsAmount = parseFloat(document.getElementById('report-uncleared-deposits').innerText.replace(/[^0-9.-]/g, '')); 
        
        const reportData = {
             clearedPayments: 0, // (यह अभी ट्रैक नहीं किया गया है, 0 भेजें)
             clearedDeposits: 0, // (यह अभी ट्रैक नहीं किया गया है, 0 भेजें)
             unclearedCount: document.querySelectorAll('.recon-check-book:not(:checked)').length,  
             unclearedTotal: unclearedPaymentsAmount + unclearedDepositsAmount
        };

        // 4. मुख्य डेटा इकट्ठा करें
        const dataToSend = {
            statementEndDate: document.getElementById('recon-statement-date').value,  
            statementEndBalance: parseFloat(document.getElementById('report-statement-balance').innerText.replace(/[^0-9.-]/g, '')),  
            reportSummary: reportData,
            reconciledBankIds: reconciledBankIds,
            reconciledBookItems: reconciledBookItems
        };

        // 5. सर्वर पर भेजें
        const res = await fetchApi('/api/reconciliation/save', {
            method: 'POST',
            body: dataToSend
        }, 'रिपोर्ट सेव की जा रही है...');

        if (res.success) {
            showMessage('सफलता', 'रिकॉन्सिलेशन रिपोर्ट सफलतापूर्वक सेव की गई!', 'success');
            renderView('bank-reconciliation'); // सब कुछ रीसेट करें
        } else {
            throw new Error(res.message);
        }

    } catch (e) {
        showMessage('त्रुटि', `रिपोर्ट सेव करने में विफल: ${e.message}`, 'danger');
        btn.disabled = false; // बटन को फिर से इनेबल करें
        btn.innerHTML = '<i class="fas fa-save me-2"></i> रिपोर्ट सेव करें';
    }
}


    /**
 * चरण 4: पिछली सेव की गई रिपोर्ट्स को लाता है और टेबल में दिखाता है
 */
async function fetchAndRenderSavedReports() {
    const tableBody = document.getElementById('previous-reports-body');
    tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">रिपोर्ट्स लोड हो रही हैं...</td></tr>`;

    try {
        const res = await fetchApi('/api/reconciliation/reports', { method: 'GET' }, null); // लोडर नहीं दिखाएँ

        if (res.success && res.reports.length > 0) {
            tableBody.innerHTML = res.reports.map(report => `
                <tr>
                    <td>REP-${report.id}</td>
                    <td>${new Date(report.statement_end_date).toLocaleDateString()}</td>
                    <td>${formatCurrency(report.statement_end_balance)}</td>
                    <td class="${parseFloat(report.uncleared_items_total) !== 0 ? 'text-danger' : ''}">
                        ${formatCurrency(report.uncleared_items_total)}
                    </td>
                    <td>${new Date(report.reconciled_at).toLocaleString()}</td>
                </tr>
            `).join('');
        } else {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">कोई पुरानी रिपोर्ट नहीं मिली।</td></tr>`;
        }
    } catch (e) {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">त्रुटि: ${e.message}</td></tr>`;
    }
}
    /**
     * Main startup logic
     */
    // ==========================================================
// ========== 1. LICENSE CHECK & APP LOCK LOGIC ==========
// ==========================================================

/**
 * Main startup logic - MODIFIED
 */
// [ यह रहा नया और सही DOMContentLoaded - पुराने वाले को हटाकर इसे पेस्ट करें ]
// [ यह रहा नया और सही DOMContentLoaded - पुराने वाले को हटाकर इसे पेस्ट करें ]
// [ यह रहा नया और सही DOMContentLoaded - पुराने वाले को हटाकर इसे पेस्ट करें ]
document.addEventListener('DOMContentLoaded', () => {
    const licenseModalEl = document.getElementById('licenseModal');  
    const licenseModal = new bootstrap.Modal(licenseModalEl);
    
    // 🚀 फिक्स: सिर्फ नए लॉगिन कंटेनर को पकड़ें
    const newLoginContainer = document.getElementById('auth-container-new'); 
    
    // 🚀 फिक्स: पुराना कंटेनर अब मौजूद नहीं है, उसे हटा दें
    // const oldLoginContainer = document.getElementById('auth-container'); 

    const token = localStorage.getItem('authToken');
    const user = JSON.parse(localStorage.getItem('authUser'));

    if (token && user) {
        console.log("टोकन मिला, लॉगिन स्थिति की जाँच की जा रही है...");
        saveAuthData(token, user);
        startLicenseTimer(user.licenseExpiryDate);

        const expiryDate = user.licenseExpiryDate ? new Date(user.licenseExpiryDate) : null;
        const now = new Date();

        if (!expiryDate || expiryDate < now) {
            // --- 🚀 केस 1: लाइसेंस एक्सपायर है ---
            console.log("लाइसेंस समाप्त या गुम है। सक्रियण की आवश्यकता है।");
            showMessage('लाइसेंस आवश्यक', 'आपका लाइसेंस समाप्त हो गया है। कृपया सक्रिय करें।', 'warning');

            // 🚀 फिक्स: नया लॉगिन पेज (बैकग्राउंड के लिए) दिखाएँ
            if (newLoginContainer) newLoginContainer.classList.remove('hidden');

            // ऐप के हिस्से (जैसे साइडबार) अनलॉक करें
            document.getElementById('sidebar').classList.remove('locked');
            document.getElementById('menu-toggle').classList.remove('locked');
            document.getElementById('main-content').classList.add('locked'); // मुख्य कंटेंट लॉक रखें
            applyRBAC(user.role);
            licenseModal.show(); // लाइसेंस Modal को बैकग्राउंड के ऊपर दिखाएँ

        } else {
            // --- 🚀 केस 2: सब कुछ सही है (टोकन और लाइसेंस) ---
            console.log("टोकन और लाइसेंस मान्य हैं। ऐप अनलॉक हो रहा है।");
            
            // 🚀 फिक्स: नया लॉगिन पेज छिपाएँ
            if (newLoginContainer) newLoginContainer.classList.add('hidden');
            
            unlockApplication(); // ऐप को पूरी तरह अनलॉक करें
        }

    } else {
        // --- 🚀 केस 3: कोई टोकन नहीं मिला (लॉगआउट है) ---
        console.log("कोई टोकन नहीं मिला। लॉगिन स्क्रीन दिखा रहा है।");
        
        // 🚀 फिक्स: सिर्फ नया लॉगिन पेज दिखाएँ
        if (newLoginContainer) newLoginContainer.classList.remove('hidden');

        // ऐप के बाकी हिस्सों को लॉक रखें
        document.getElementById('sidebar').classList.add('locked');
        document.getElementById('main-content').classList.add('locked');
        document.getElementById('menu-toggle').classList.add('locked');
    }

    // --- बाकी के सभी लिस्नर (Event Listeners) ---
    
    // Login Form
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const msgEl = document.getElementById('login-message');
        const btn = document.getElementById('login-submit-btn');
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> लॉग इन हो रहा है...`;

        try {
            const res = await fetch(__backend_url + '/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await res.json();
            if (!res.ok || !data.success) { throw new Error(data.message || 'लॉगिन विफल'); }

            msgEl.innerText = 'सफलता! लोड हो रहा है...';
            saveAuthData(data.token, data.user);
            startLicenseTimer(data.user.licenseExpiryDate);

            if (data.requiresLicense) {
                // 🚀 फिक्स: लाइसेंस एक्सपायर होने पर सिर्फ Modal दिखाएँ (बैकग्राउंड पहले से ही दिख रहा है)
                showMessage('लाइसेंस आवश्यक', data.message, 'warning');
                if (newLoginContainer) newLoginContainer.classList.remove('hidden'); // सुनिश्चित करें कि बैकग्राउंड दिखे
                document.getElementById('sidebar').classList.remove('locked');
                document.getElementById('menu-toggle').classList.remove('locked');
                document.getElementById('main-content').classList.add('locked');
                applyRBAC(data.user.role);
                licenseModal.show();
            } else {
                unlockApplication(); // सब सही है, ऐप अनलॉक करें
            }
        } catch (error) {
            msgEl.innerText = error.message;
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'लॉगिन';
        }
    });

    // Registration Form
    document.getElementById('register-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const shopName = document.getElementById('register-shop-name').value;
        const name = document.getElementById('register-name').value;
        const email = document.getElementById('register-email').value;
        const mobile = document.getElementById('register-mobile').value;
        const password = document.getElementById('register-password').value;
        const msgEl = document.getElementById('register-message');
        const btn = document.getElementById('register-submit-btn');
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> रजिस्टर हो रहा है...`;

        try {
            const res = await fetch(__backend_url + '/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ shopName, name, email, mobile, password })
            });
            const data = await res.json();
            if (!res.ok || !data.success) { throw new Error(data.message || 'रजिस्ट्रेशन विफल'); }

            msgEl.innerText = 'सफलता! ऐप लोड हो रहा है...';
            saveAuthData(data.token, data.user);
            startLicenseTimer(data.user.licenseExpiryDate);
            showMessage('सफलता!', 'आपका अकाउंट बन गया है। कृपया अपना लाइसेंस सक्रिय करें।', 'success');
            
            // 🚀 फिक्स: रजिस्टर करने के बाद भी नया लॉगिन बैकग्राउंड दिखाएँ
            if (newLoginContainer) newLoginContainer.classList.remove('hidden');
            document.getElementById('sidebar').classList.remove('locked');
            document.getElementById('menu-toggle').classList.remove('locked');
            document.getElementById('main-content').classList.add('locked');
            applyRBAC(data.user.role);
            licenseModal.show();

        } catch (error) {
            msgEl.innerText = error.message;
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'अकाउंट बनाएं';
        }
    });

    // License Activation Form
    document.getElementById('license-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const key = document.getElementById("license-key-input").value.trim();
        const messageEl = document.getElementById("license-message");
        messageEl.innerText = 'सत्यापित किया जा रहा है...';

        try {
           const res = await fetchApi('/api/activate-license', {
                method: 'POST',
                body: { licenseKey: key }
           }, 'लाइसेंस सक्रिय किया जा रहा है...');
            
            if (res.success) {
                saveAuthData(res.token, res.user);
                startLicenseTimer(res.user.licenseExpiryDate);
                licenseModal.hide();
                showMessage('सफलता', res.message, 'success');
                unlockApplication(); // <<< अब ऐप को अनलॉक करें
            } else {
                throw new Error(res.message || 'अमान्य या समाप्त लाइसेंस।');
            }
        } catch (err) {
            messageEl.innerText = '❌ ' + err.message;
        }
    });
    
    // --- बाकी के सभी लिस्नर ---
    document.getElementById('logout-btn').addEventListener('click', logout);
    document.querySelectorAll('#sidebar-nav .nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            renderView(link.getAttribute('data-view'));
            if (window.innerWidth < 992) document.getElementById('sidebar').classList.remove('active');
        });
    });
    document.getElementById('menu-toggle').addEventListener('click', () => {
         document.getElementById('sidebar').classList.toggle('active');
    });
    const posSearchInput = document.getElementById('pos-item-search');
    if (posSearchInput) {
        posSearchInput.addEventListener('input', () => handleItemSearch(false)); 
        posSearchInput.addEventListener('click', () => handleItemSearch(true)); 
        document.addEventListener('click', (e) => {
            if (e.target.id !== 'pos-item-search') {
                document.getElementById('pos-search-results').innerHTML = '';
            }
        });
    }
    updatePOSCartView(); 
    const expenseDateInput = document.getElementById('expense-date');
    if (expenseDateInput) {
        try {
            expenseDateInput.value = new Date().toISOString().split('T')[0];
        } catch(e) { console.error("Expense date set error", e); }
    }
    const barcodeInput = document.getElementById('barcode-scanner-input');
    barcodeInput.addEventListener('change', () => handleBarcodeScan(null));
    document.body.addEventListener('click', focusBarcodeScanner);

    // postMessage Listener
    window.addEventListener('message', function(event) {
        if (event.origin !== window.location.origin) return; 
        if (event.data) {
            const token = localStorage.getItem('authToken');
            const user = AppState.user || JSON.parse(localStorage.getItem('authUser'));
            const shopId = user ? user.shopId : null;
            const backendUrl = __backend_url;

            if (event.data.type === 'REQUEST_AUTH' && token) {
                if (window.scannerWindow && !window.scannerWindow.closed) {
                    window.scannerWindow.postMessage({
                        type: 'AUTH_TOKEN',
                        token: token,
                        shopId: shopId,
                        backendUrl: backendUrl
                    }, window.location.origin);
                }
            }
            if (event.data.type === 'SCANNED_SKU' && event.data.sku) {
                 addSKUToCart(event.data.sku);
            }
        }
    });
});
// [ नया DOMContentLoaded फ़ंक्शन यहाँ समाप्त होता है ]

// [ नया DOMContentLoaded फ़ंक्शन यहाँ समाप्त होता है ]// [ नया DOMContentLoaded फ़ंक्शन यहाँ समाप्त होता है ]    // --- Registration Form Handler - MODIFIED ---
   // Registration Form Handler - MODIFIED to include mobile
document.getElementById('register-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    // --- Get form data ---
    const shopName = document.getElementById('register-shop-name').value;
    const name = document.getElementById('register-name').value;
    const email = document.getElementById('register-email').value;
    const mobile = document.getElementById('register-mobile').value; // <<< नई लाइन जोड़ी गई
    const password = document.getElementById('register-password').value;
    // --- End get form data ---

    const msgEl = document.getElementById('register-message');
    const btn = document.getElementById('register-submit-btn');
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> रजिस्टर हो रहा है...`;

    try {
        const res = await fetch(__backend_url + '/api/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            // --- Include mobile in the body ---
            body: JSON.stringify({ shopName, name, email, mobile, password }) // <<< यहाँ mobile जोड़ा गया
            // --- End include mobile ---
        });
        const data = await res.json();

        if (!res.ok || !data.success) {
            throw new Error(data.message || 'रजिस्ट्रेशन विफल');
        }

        // ... (बाकी का कोड success handling के लिए) ...
        msgEl.innerText = 'सफलता! ऐप लोड हो रहा है...';
        saveAuthData(data.token, data.user);
        startLicenseTimer(data.user.licenseExpiryDate);
        showMessage('सफलता!', 'आपका अकाउंट बन गया है। कृपया अपना लाइसेंस सक्रिय करें।', 'success');
        document.getElementById('auth-container').classList.add('hidden');
        document.getElementById('sidebar').classList.remove('locked');
        document.getElementById('menu-toggle').classList.remove('locked');
        document.getElementById('main-content').classList.add('locked');
        applyRBAC(data.user.role);
        // Ensure licenseModal variable is accessible or get instance
        const licenseModalInstance = bootstrap.Modal.getInstance(document.getElementById('licenseModal')) || new bootstrap.Modal(document.getElementById('licenseModal'));
        licenseModalInstance.show();


    } catch (error) {
        msgEl.innerText = error.message;
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'अकाउंट बनाएं';
    }
});
    // --- License Activation Form Handler - MODIFIED ---
    document.getElementById('license-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const key = document.getElementById("license-key-input").value.trim();
        const messageEl = document.getElementById("license-message");
        messageEl.innerText = 'सत्यापित किया जा रहा है...';

        if (!key) { /* ... */ return; }

        try {
           // सही कोड (इसे बदलें):
const res = await fetchApi('/api/activate-license', {
    method: 'POST', // <<< यह POST बताता है
    // headers are handled by fetchApi, Content-Type will be added automatically for JSON
    body: { licenseKey: key } // <<< यह लाइसेंस Key भेजता है (key वेरिएबल पहले डिफाइन है)
}, 'लाइसेंस सक्रिय किया जा रहा है...');
            if (res.success) {
                saveAuthData(res.token, res.user);
                startLicenseTimer(res.user.licenseExpiryDate);
                licenseModal.hide();
                showMessage('सफलता', res.message, 'success');

                // --- MODIFIED: Unlock FULLY only AFTER successful activation ---
                unlockApplication(); // <<< UNLOCK HERE NOW
                // --- END MODIFIED ---

            } else {
                throw new Error(res.message || 'अमान्य या समाप्त लाइसेंस।');
            }
        } catch (err) {
            messageEl.innerText = '❌ ' + err.message;
        }
    });

    // ... (rest of DOMContentLoaded listeners like logout, sidebar, etc.) ...


        // --- Setup Other Listeners ---
        
        // Logout Button
        document.getElementById('logout-btn').addEventListener('click', logout);

        // Remove old admin login button listener
             
        // Sidebar navigation
        document.querySelectorAll('#sidebar-nav .nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                renderView(link.getAttribute('data-view'));
                if (window.innerWidth < 992) document.getElementById('sidebar').classList.remove('active');
            });
        });

        // Mobile menu toggle
        document.getElementById('menu-toggle').addEventListener('click', () => {
             document.getElementById('sidebar').classList.toggle('active');
        });

        // POS Search (NEW: Added 'click' listener)
        const posSearchInput = document.getElementById('pos-item-search');
        if (posSearchInput) {
            posSearchInput.addEventListener('input', () => handleItemSearch(false)); 
            posSearchInput.addEventListener('click', () => handleItemSearch(true)); 
            // Hide results when clicking away
            document.addEventListener('click', (e) => {
                if (e.target.id !== 'pos-item-search') {
                    document.getElementById('pos-search-results').innerHTML = '';
                }
            });
        }
        updatePOSCartView(); 

        // Expense Date
        const expenseDateInput = document.getElementById('expense-date');
        if (expenseDateInput) {
            expenseDateInput.value = new Date().toISOString().split('T')[0];
        }
        
        // NEW: Barcode Scanner Listener
        const barcodeInput = document.getElementById('barcode-scanner-input');
        barcodeInput.addEventListener('change', handleBarcodeScan);
        // Re-focus scanner input whenever user clicks anywhere
       
        // 🚀 नया फ़ंक्शन: Modal इवेंट सेटअप करता है
   
        
</script>
<div class="modal fade" id="pairingModal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="pairingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pairingModalLabel">मोबाइल स्कैनर कनेक्ट करें</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closePosWebSocket()"></button>
            </div>
            <div class="modal-body text-center">
                <p>अपने Dukan Pro मोबाइल स्कैनर में यह कोड दर्ज करें:</p>
                
                <div id="pairing-code-container" style="min-height: 100px; display: flex; align-items: center; justify-content: center; background: #eee; border-radius: 8px; margin: 20px 0;">
                    
                    <span id="pairing-code-display" style="font-size: 2.5rem; font-weight: bold; letter-spacing: 5px; color: #0d6efd;"></span> 
                    
                    <div id="code-spinner" class="spinner-border text-primary" role="status"> 
                        <span class="visually-hidden">कोड जनरेट हो रहा है...</span>
                    </div>
                </div>
                
                <h4 id="pairing-status" class="text-success"> 
                    <i class="fas fa-check-circle"></i> स्कैनर सफलतापूर्वक कनेक्ट हो गया!
                </h4>
                
                <p class="text-muted small mt-3">यह कोड आपके POS को आपके फ़ोन से सुरक्षित रूप से जोड़ता है।</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closePosWebSocket()">रद्द करें</button>
            </div>
        </div>
    </div>
</div>


</body>
</html>

