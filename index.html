<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dukan Pro - Ultimate Business Suite</title>
    <link rel="icon" type="image/png" href="https://img.icons8.com/color/48/shop.png">
    <link rel="manifest" href="manifest.json">


   

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
   

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ====================================================================
         === DUKAN PRO - MODERN AESTHETIC REDESIGN (INDIGO/CYAN) ===
         ====================================================================
      /* ЁЯУ▒ MOBILE FIX: Final Consolidated Code (Scroll + Buttons) */
@media (max-width: 768px) {
    
    /* 1. рдЯреЗрдмрд▓ рдХрдВрдЯреЗрдирд░ (рдХрд╛рд░реНрдЯ) рдХреА рд╕реЗрдЯрд┐рдВрдЧ */
    .table-responsive {
        display: block;
        width: 100%;
        overflow-x: auto !important; /* тмЕя╕П рдпрд╣ рд▓рд╛рдЗрди рджрд╛рдПрдВ-рдмрд╛рдПрдВ рд╕реНрдХреНрд░реЙрд▓ рдХрд░рд╛рдПрдЧреА */
        overflow-y: auto !important; /* рдКрдкрд░-рдиреАрдЪреЗ рд╕реНрдХреНрд░реЙрд▓ */
        max-height: 45vh; /* рд╕реНрдХреНрд░реАрди рдХрд╛ 45% рд╣рд┐рд╕реНрд╕рд╛ */
        -webkit-overflow-scrolling: touch; /* рд╕реНрдореВрде рд╕реНрдХреНрд░реЙрд▓рд┐рдВрдЧ */
        border: 1px solid #ddd;
        margin-bottom: 80px; /* рдиреАрдЪреЗ рдЬрдЧрд╣ рддрд╛рдХрд┐ рдмрдЯрди рдХреЗ рдкреАрдЫреЗ рди рдЫрд┐рдкреЗ */
    }

    /* 2. рдЯреЗрдмрд▓ рдХреЗ рдЕрдВрджрд░ рдХрд╛ рдЯреЗрдХреНрд╕реНрдЯ (рддрд╛рдХрд┐ рд╡реЛ рд╕рд┐рдХреБрдбрд╝реЗ рдирд╣реАрдВ) */
    .table th, .table td {
        white-space: nowrap !important; /* тмЕя╕П рдпрд╣ рд╕рдмрд╕реЗ рдЬрд░реВрд░реА рд╣реИ рд╕реНрдХреНрд░реЙрд▓ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП */
        vertical-align: middle;
        padding: 8px 5px;
        font-size: 0.9rem;
    }

    /* 3. "рд╣рдЯрд╛рдПрдВ" (Cross Button) рдФрд░ "рдХреБрд▓" рдХреЛ рдЪрд┐рдкрдХрд╛ рдХрд░ рд░рдЦреЗрдВ (Sticky) - Optional */
    .table th:last-child, 
    .table td:last-child {
        position: sticky;
        right: 0;
        background-color: #fff; /* рд╕реНрдХреНрд░реЙрд▓ рд╣реЛрдиреЗ рдкрд░ рдкреАрдЫреЗ рдХрд╛ рди рджрд┐рдЦреЗ */
        z-index: 5;
        border-left: 2px solid #eee;
    }

    /* 4. рдиреАрдЪреЗ рдХреЗ рдмрдЯрди (Sale/Pay) рдлрд┐рдХреНрд╕ рд░рд╣реЗрдВ */
    .card-footer, .pos-footer-buttons {
        position: fixed !important;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        z-index: 9999;
        padding: 10px;
        box-shadow: 0 -4px 15px rgba(0,0,0,0.1);
        border-top: 1px solid #eee;
    }

    /* 5. рдмреЙрдбреА рдХреЛ рдкреИрдбрд┐рдВрдЧ рджреЗрдВ */
    body {
        padding-bottom: 160px !important;
    }
}




    
        /* --- 1. рдирдП рдФрд░ рд╕реБрдВрджрд░ рд░рдВрдЧреЛрдВ рдХреЛ рдбрд┐рдлрд╛рдЗрди рдХрд░рдирд╛ --- */
        :root {
            --dp-bg-light: #f4f7f6;        /* рд╣рд▓реНрдХрд╛ рдЧреНрд░реЗ рдмреИрдХрдЧреНрд░рд╛рдЙрдВрдб */
            --dp-bg-white: #ffffff;
            --dp-sidebar-bg: #111d4a;    /* рдбреАрдк рдЗрдВрдбрд┐рдЧреЛ (рдЧрд╣рд░рд╛ рдиреАрд▓рд╛) */
            --dp-sidebar-text: #a0aed0;   /* рд╣рд▓реНрдХрд╛ рдиреАрд▓рд╛/рдЧреНрд░реЗ рдЯреЗрдХреНрд╕реНрдЯ */
            --dp-sidebar-text-hover: #ffffff;
            --dp-sidebar-active-bg: #1a2b6d;  /* рдПрдХреНрдЯрд┐рд╡ рд▓рд┐рдВрдХ рдХреЗ рд▓рд┐рдП рдЧрд╣рд░рд╛ рдиреАрд▓рд╛ */
            --dp-primary: #00b4d8;       /* рдореБрдЦреНрдп рд╕рд╛рдпрди (Cyan) рд░рдВрдЧ */
            --dp-secondary: #03045e;     /* рдЧрд╣рд░рд╛ рдиреАрд▓рд╛ (Gradient рдХреЗ рд▓рд┐рдП) */
            --dp-text-dark: #1A202C;
            --dp-text-light: #4A5568;
            --dp-border: #E2E8F0;
            --dp-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); /* рд╕реЙрдлреНрдЯ рд╢реИрдбреЛ */
            
            /* рд╣рдорд╛рд░рд╛ рдореБрдЦреНрдп 'рд╕реБрдВрджрд░' рдЧреНрд░реЗрдбрд┐рдПрдВрдЯ */
            --dp-gradient: linear-gradient(135deg, var(--dp-primary) 0%, var(--dp-secondary) 100%);
        }
    
        /* --- 2. рдореБрдЦреНрдп рдмреЙрдбреА рдФрд░ рд▓реЗрдЖрдЙрдЯ --- */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--dp-bg-light); /* рдирдпрд╛ рдмреИрдХрдЧреНрд░рд╛рдЙрдВрдб */
            color: var(--dp-text-dark); /* рдирдпрд╛ рдЯреЗрдХреНрд╕реНрдЯ рдХрд▓рд░ */
        }
    
        .main-content {
            margin-left: 280px;
            padding: 30px; /* рдереЛрдбрд╝реА рдФрд░ рдЬрдЧрд╣ */
            transition: margin-left 0.3s ease;
        }
    
        /* App is hidden until licensed */
        .main-content.locked, .sidebar.locked, .navbar-toggler.locked {
                display: none;
        }
    
        /* --- 3. рд╕рд╛рдЗрдбрдмрд╛рд░ (рдЖрдкрдХрд╛ рдлрд┐рдХреНрд╕реНрдб рд╕реНрдЯреНрд░рдХреНрдЪрд░) --- */
        .sidebar {
            width: 280px;
            background-color: var(--dp-sidebar-bg); /* рдирдпрд╛ рдЗрдВрдбрд┐рдЧреЛ рдмреИрдХрдЧреНрд░рд╛рдЙрдВрдб */
            color: var(--dp-sidebar-text-hover);
            height: 100vh;
            position: fixed; /* тнРя╕П рдпрд╣ рдЖрдкрдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рдпрд╣ рд╡реИрд╕реА рд╣реА рд╣реИ */
            top: 0;
            left: 0;
            padding-top: 20px;
            transition: transform 0.3s ease;
            z-index: 1050;
            border-right: 1px solid var(--dp-border);
            overflow-y: auto; /* рд╕реНрдХреНрд░реЙрд▓ рдХреЗ рд▓рд┐рдП */
            overflow-x: hidden;
        }
        
        /* рд╕рд╛рдЗрдбрдмрд╛рд░ рдореЗрдВ "Dukan Pro" рд╣реЗрдбрд┐рдВрдЧ */
        .sidebar h3 {
            margin-bottom: 2rem;
            text-align: center;
            font-weight: 700;
            color: #fff;
            letter-spacing: 1px;
        }
    
        /* рд╕рд╛рдЗрдбрдмрд╛рд░ рдХреЗ рд▓рд┐рдВрдХреНрд╕ (рдирдпрд╛ рд╕реНрдЯрд╛рдЗрд▓) */
        .sidebar .nav-link {
            color: var(--dp-sidebar-text);
            padding: 15px 25px;
            border-left: 5px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            /* рдирдпрд╛: рджрд╛рдИрдВ рдУрд░ рд╕реЗ рдЧреЛрд▓ рдЗрдлрд╝реЗрдХреНрдЯ */
            border-radius: 0 30px 30px 0;
            margin-right: 15px; 
            margin-bottom: 5px; /* рд▓рд┐рдВрдХреНрд╕ рдХреЗ рдмреАрдЪ рдереЛрдбрд╝реА рдЬрдЧрд╣ */
        }
    
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: var(--dp-sidebar-text-hover); /* рд╕рдлрд╝реЗрдж рдЯреЗрдХреНрд╕реНрдЯ */
            background-color: var(--dp-sidebar-active-bg); /* рдереЛрдбрд╝рд╛ рд╣рд▓реНрдХрд╛ рдиреАрд▓рд╛ */
            border-left-color: var(--dp-primary); /* рд╕рд╛рдпрди рдПрдХреНрд╕реЗрдВрдЯ */
            /* рдЦреВрдмрд╕реВрд░рдд 'Glow' рдЗрдлрд╝реЗрдХреНрдЯ */
            box-shadow: 0 4px 10px rgba(0, 180, 216, 0.2); 
        }
    
        .sidebar .nav-link i {
            margin-right: 12px;
            width: 20px; /* рдЖрдЗрдХрдиреНрд╕ рдХреЛ рдПрдХ рд▓рд╛рдЗрди рдореЗрдВ рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП */
            text-align: center;
        }
        
        /* рдиреАрдЪреЗ рдХрд╛ рдпреВрдЬрд╝рд░ рдЗрдиреНрдлреЛ рдмреЙрдХреНрд╕ */
        #user-info {
            background-color: var(--dp-sidebar-active-bg) !important;
        }
        
    
        /* --- 4. рдореБрдЦреНрдп рдХрдВрдЯреЗрдВрдЯ (рдХрд╛рд░реНрдбреНрд╕, рдмрдЯрди, рдЯреЗрдмрд▓реНрд╕) --- */
    
        /* рд╕реЗрдХреНрд╢рди рдХреА рдореБрдЦреНрдп рд╣реЗрдбрд┐рдВрдЧ (рдЬреИрд╕реЗ "рдбреИрд╢рдмреЛрд░реНрдб") */
        .section > h2 {
            font-weight: 700;
            color: var(--dp-text-dark);
            margin-bottom: 2rem !important;
            /* рдЯреЗрдХреНрд╕реНрдЯ рдкрд░ рдЧреНрд░реЗрдбрд┐рдПрдВрдЯ */
            background-image: var(--dp-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            display: inline-block;
        }
    
        /* рдХрд╛рд░реНрдбреНрд╕ рдХрд╛ рдирдпрд╛ рдбрд┐рдЬрд╝рд╛рдЗрди */
        .card {
            border-radius: 16px; /* рдЬрд╝реНрдпрд╛рджрд╛ рдЧреЛрд▓ рдХреЛрдиреЗ */
            box-shadow: var(--dp-shadow); /* рдирдпрд╛ рд╕реЙрдлреНрдЯ рд╢реИрдбреЛ */
            border: none;
            overflow: hidden; /* рд╣реЗрдбрд░ рдХреЛ рд╕рд╣реА рд╕реЗ рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП */
            margin-bottom: 1.5rem; /* рдХрд╛рд░реНрдбреНрд╕ рдХреЗ рдмреАрдЪ рдЬрдЧрд╣ */
        }
    
        /* рдХрд╛рд░реНрдб рдХрд╛ рд╣реЗрдбрд░ (рдпрд╣ рд╕рдмрд╕реЗ рдмрдбрд╝рд╛ рдмрджрд▓рд╛рд╡ рд╣реИ) */
        .card-header {
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            background: var(--dp-gradient); /* рд╣рдорд╛рд░рд╛ рд╕реБрдВрджрд░ рдЧреНрд░реЗрдбрд┐рдПрдВрдЯ */
            color: white;
            padding: 20px 25px;
            font-weight: 600;
            font-size: 1.1rem;
            border-bottom: none;
        }
        
        /* рдбреИрд╢рдмреЛрд░реНрдб рдХреЗ рдЫреЛрдЯреЗ рдХрд╛рд░реНрдбреНрд╕ */
        .dashboard-card {
            transition: transform 0.2s, box-shadow 0.2s;
            background: var(--dp-bg-white);
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); /* рд╣реЙрд╡рд░ рдкрд░ рдЬрд╝реНрдпрд╛рджрд╛ рд╢реИрдбреЛ */
        }
        /* рдбреИрд╢рдмреЛрд░реНрдб рдХреЗ рдЖрдЗрдХрдиреНрд╕ рдкрд░ рдЧреНрд░реЗрдбрд┐рдПрдВрдЯ */
        .dashboard-card i {
            background: var(--dp-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            font-size: 2.5rem; /* рдереЛрдбрд╝реЗ рдмрдбрд╝реЗ рдЖрдЗрдХрдиреНрд╕ */
        }
    
        /* рдлреЙрд░реНрдореНрд╕ рдФрд░ рдмрдЯрдиреНрд╕ */
        .form-control, .form-select, .btn {
            border-radius: 8px;
            padding: 10px 15px;
            border: 1px solid var(--dp-border);
            transition: all 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--dp-primary);
            box-shadow: 0 0 0 3px rgba(0, 180, 216, 0.15);
        }
    
        .btn {
            font-weight: 600;
            padding: 10px 20px;
        }
        
        /* рдореБрдЦреНрдп рдмрдЯрди (рдирдпрд╛ рд╕реНрдЯрд╛рдЗрд▓) */
        .btn-primary {
            background-color: var(--dp-primary);
            border-color: var(--dp-primary);
            color: #fff;
        }
        .btn-primary:hover {
            background-color: var(--dp-secondary);
            border-color: var(--dp-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 180, 216, 0.3);
        }
        
        /* рдЕрдиреНрдп рдмрдЯрди (рдЬреИрд╕реЗ 'Add') */
        .btn-success { background-color: #1abc9c; border-color: #1abc9c; }
        .btn-success:hover { background-color: #16a085; border-color: #16a085; }
        .btn-info { background-color: #3498db; border-color: #3498db; }
        .btn-info:hover { background-color: #2980b9; border-color: #2980b9; }
        .btn-warning { background-color: #f39c12; border-color: #f39c12; }
        .btn-warning:hover { background-color: #e67e22; border-color: #e67e22; }
    
        /* рдЯреЗрдмрд▓реНрд╕ */
        .table th {
            background-color: var(--dp-bg-light); /* рд╣рд▓реНрдХрд╛ рдмреИрдХрдЧреНрд░рд╛рдЙрдВрдб */
            color: var(--dp-text-light); /* рд╣рд▓реНрдХрд╛ рдЯреЗрдХреНрд╕реНрдЯ */
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            border: none;
            padding: 15px;
        }
        .table-striped > tbody > tr:nth-of-type(odd) > * {
            --bs-table-bg-type: var(--dp-bg-light);
        }
        .table td {
            border-top: 1px solid var(--dp-border); /* рд╣рд▓реНрдХреА рдмреЙрд░реНрдбрд░ */
            vertical-align: middle;
            padding: 15px;
            color: var(--dp-text-dark);
        }
        .table-hover tbody tr:hover {
            background-color: #eaf6f9; /* рд╣рд▓реНрдХрд╛ рд╕рд╛рдпрди рд╣реЙрд╡рд░ */
        }
    
        /* --- 5. рдмрд╛рдХреА рдХреЗ рд╕реНрдЯрд╛рдЗрд▓реНрд╕ (рдкрд╣рд▓реЗ рд╕реЗ рдореМрдЬреВрдж) --- */
        
        /* рдореЛрдмрд╛рдЗрд▓ рдПрдбрдЬрд╕реНрдЯрдореЗрдВрдЯ (рдкрд╣рд▓реЗ рдЬреИрд╕рд╛) */
        @media (max-width: 991.98px) {
            .sidebar { transform: translateX(-280px); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .main-content.sidebar-open { margin-left: 280px; overflow-x: hidden; }
            .navbar-toggler { display: block !important; }
        }
        
        .navbar-toggler {
            position: fixed; top: 10px; left: 10px; z-index: 1060;
            display: none; background-color: var(--dp-sidebar-bg);
            border: 1px solid var(--dp-primary);
        }
        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='white' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }
        
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); display: flex;
            justify-content: center; align-items: center; z-index: 2000;
        }
        .hidden { display: none !important; }
    
        /* --- рдЗрдирд╡реЙрдЗрд╕ рдЬрдирд░реЗрдЯрд░ рд╕реНрдЯрд╛рдЗрд▓реНрд╕ --- */
        #invoice-generator h5 { font-weight: 600; }
        #invoice-preview {
            background: white; padding: 25px; border: 1px solid var(--dp-border);
            min-height: 80vh; font-size: 14px; color: #333;
            border-radius: 16px; box-shadow: var(--dp-shadow);
        }
        .invoice-header {
            border-bottom: 2px solid var(--dp-primary);
            margin-bottom: 20px; padding-bottom: 15px;
        }
        .shop-details h3 { color: var(--dp-secondary); font-weight: 700; }
        .customer-details {
            border: 1px solid #eee; padding: 15px;
            margin-bottom: 20px; border-radius: 8px;
        }
        .invoice-table th { background-color: var(--dp-bg-light); }
        
        /* --- GST рд░рд┐рдкреЛрд░реНрдЯ рдЯреИрдмреНрд╕ --- */
        .gst-report-tabs .nav-link {
            background-color: #f0f0f0; border: 1px solid var(--dp-border);
            color: var(--dp-text-light); font-weight: 600;
        }
        .gst-report-tabs .nav-link.active {
            background-color: var(--dp-bg-white);
            border-bottom: 1px solid var(--dp-bg-white);
            color: var(--dp-secondary); /* рдбрд╛рд░реНрдХ рдмреНрд▓реВ рдПрдХреНрдЯрд┐рд╡ */
            position: relative; top: 1px;
        }
        .gst-report-tab-content {
            background-color: var(--dp-bg-white);
            border: 1px solid var(--dp-border);
            padding: 1.5rem;
            border-radius: 0 8px 8px 8px;
        }
        
        /* --- рдЕрдиреНрдп рд╕рднреА рд╕реНрдЯрд╛рдЗрд▓реНрд╕ (рдмрд╛рд░рдХреЛрдб, рдЯрд╛рдЗрдорд░, рдкреНрд░рд┐рдВрдЯ) --- */
        /* (рдпрд╣ рдмрд╛рдХреА рдХрд╛ CSS рд╣реИ рдЬрд┐рд╕реЗ рдмрджрд▓рдиреЗ рдХреА рдЬрд╝рд░реВрд░рдд рдирд╣реАрдВ рд╣реИ) */
    
        .section { display: none; }
        .section.active { display: block; }
        .text-shadow { text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); }
        #qr-preview img { max-width: 100px; max-height: 100px; border: 1px solid #ccc; padding: 3px; }
        .invoice-table { width: 100%; margin-bottom: 20px; border-collapse: collapse; }
        .invoice-table th, .invoice-table td { padding: 10px; text-align: right; border-bottom: 1px solid #dee2e6; }
        .invoice-table th:first-child, .invoice-table td:first-child { text-align: left; }
        .invoice-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 20px; }
        .totals-table { width: 50%; }
        .totals-table td { padding: 5px 10px; }
        .terms { font-size: 12px; color: #777; }
        .report-table { font-size: 0.9rem; }
        .report-table th { background-color: #f8f9fa; }
        .report-table td { padding: 0.5rem; }
        .report-table .fw-bold { border-top: 2px solid #333; }
        .report-print-area { display: none; }
        #barcode-scanner-input { position: fixed; top: -100px; left: -100px; opacity: 0; }
        #license-timer { font-size: 0.8rem; font-weight: 500; padding: 5px 10px; border-radius: 6px; }
        #license-timer.expiring-soon { background-color: #ffc107; color: #333; cursor: pointer; }
        #license-timer.expired { background-color: #dc3545; color: #fff; cursor: pointer; }
        #license-timer i { margin-right: 5px; }
        .json-viewer { background-color: #282c34; color: #abb2bf; padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto; font-family: 'Courier New', Courier, monospace; font-size: 0.9rem; white-space: pre; }
        @media print {
            body * { visibility: hidden; }
            .printable, .printable * { visibility: visible; }
          .report-print-header, .report-print-header * { visibility: visible; }
            .printable { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 15px; border: none; box-shadow: none; }
            .no-print { display: none; }
        }
        .sidebar::-webkit-scrollbar { width: 8px; }
        .sidebar::-webkit-scrollbar-track { background: #555; }
        .sidebar::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .sidebar::-webkit-scrollbar-thumb:hover { background: #aaa; }
        .gst-report-table { font-size: 0.85rem; margin-top: 15px; border-collapse: collapse; width: 100%; }
        .gst-report-table th, .gst-report-table td { border: 1px solid #dee2e6; padding: 8px 12px; text-align: right; }
        .gst-report-table th { background-color: #f8f9fa; text-align: center; font-weight: 600; vertical-align: middle; }
        .gst-report-table td:first-child { text-align: left; }
        .gst-report-table tfoot tr { font-weight: bold; background-color: #e9ecef; }
        .gst-report-table .group-header td { background-color: #f3f4f6; font-weight: bold; text-align: left; }
    
    
        /* ======================================================== */
        /* === ЁЯЪА SAHI LOGIN AUR LANDING PAGE CSS (YAHAN SE SHURU) === */
        /* ======================================================== */
    
             
/* 1. рдореЙрд▓ рдХрд╛ рдмреИрдХрдЧреНрд░рд╛рдЙрдВрдб (Cache Busting Fix) */
/* 1. рдореЙрд▓ рдХрд╛ рдмреИрдХрдЧреНрд░рд╛рдЙрдВрдб (imgbb Online URL Fix) */
.auth-overlay {
    /*
     * ЁЯЪАЁЯЪАЁЯЪА YEH HAI PERMANENT FIX ЁЯЪАЁЯЪАЁЯЪА
     * Neeche diye gaye URL ko apne imgbb ke "Direct Link" se badal dein.
     */
    background: url(https://i.postimg.cc/1R76fKdh/shopkeeper-dukanpro.png) no-repeat center center fixed;
    
    background-size: cover;
    background-color: rgba(0, 0, 0, 0.45); /* рдбрд╛рд░реНрдХ рд▓реЗрдпрд░ */
    background-blend-mode: multiply;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 20px;
}

/* 2. рд╕реЗрдВрдЯрд░реНрдб рд░реИрдкрд░ (Wrapper) */
        .login-wrapper {
            width: 100%;
            max-width: 950px;
            
            grid-template-columns: 40% 60%; 
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            
            /* ЁЯЪА рд▓реЙрдЧрд┐рди рдмреЙрдХреНрд╕ рдХреЛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдЫрд┐рдкрд╛рдПрдБ */
            display: none; 
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
    
        /* 2b. рдЬрдм 'active' рдХреНрд▓рд╛рд╕ рдЬреЛрдбрд╝реА рдЬрд╛рдП рддрдм рджрд┐рдЦрд╛рдПрдБ */
        .login-wrapper.active {
            display: grid; /* ЁЯЪА рдпрд╣ рдЗрд╕реЗ рд╡рд╛рдкрд╕ рджрд┐рдЦрд╛рддрд╛ рд╣реИ */
            opacity: 1;
            transform: scale(1);
        }
    
        /* 3. рдПрдбрд╡рд░рдЯрд╛рдЗрдЬрд┐рдВрдЧ рд╕рд╛рдЗрдбрдмрд╛рд░ (Left Column) */
        .login-ad-sidebar {
            background: var(--dp-sidebar-bg, #111d4a); 
            color: #fff;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .login-ad-sidebar h3 {
            font-weight: 700;
            letter-spacing: 1px;
        }
        .login-ad-sidebar p {
            font-size: 1.1rem;
            color: var(--dp-sidebar-text, #a0aed0);
            border-bottom: 1px solid var(--dp-sidebar-active-bg, #1a2b6d);
            padding-bottom: 15px;
        }
        .login-ad-sidebar .ad-footer {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid var(--dp-sidebar-active-bg, #1a2b6d);
            color: var(--dp-sidebar-text, #a0aed0);
        }
    
        /* 4. рд▓реЙрдЧрд┐рди рдХрд╛рд░реНрдб (Glass Effect) */
        .login-card-glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            padding: 30px 40px;
        }
        .login-card-glass h3 {
            color: var(--dp-text-dark, #1A202C);
        }
        .login-card-glass .nav-tabs {
            border-bottom: 2px solid var(--dp-border, #E2E8F0);
        }
        .login-card-glass .nav-link {
            color: var(--dp-text-light, #4A5568);
            font-weight: 600;
            padding: 10px 15px;
        }
        .login-card-glass .nav-link.active {
            background-color: rgba(255, 255, 255, 0.8);
            color: var(--dp-primary, #00b4d8);
            border: 2px solid var(--dp-border, #E2E8F0);
            border-bottom-color: transparent;
            border-radius: 8px 8px 0 0;
        }
    
        /* 5. рдПрдирд┐рдореЗрдЯреЗрдб рдлреАрдЪрд░реНрд╕ (Advertising Quotes) */
        .features-list {
            list-style: none;
            padding: 0;
            margin: 25px 0;
            height: 250px; /* рдПрдиреАрдореЗрд╢рди рдХреЗ рд▓рд┐рдП рдКрдВрдЪрд╛рдИ */
            overflow: hidden;
            position: relative;
            font-size: 1.1rem; /* рдореБрдЦреНрдп рдЯреЗрдХреНрд╕реНрдЯ рдХрд╛ рд╕рд╛рдЗреЫ */
        }
        .features-list li {
            font-weight: 500;
            padding: 8px 0;
            position: absolute;
            width: 100%;
            opacity: 0;
            transform: translateY(30px);
            animation: slide-up-fade 18s linear infinite; /* 9 items * 2s = 18s */
            animation-delay: var(--delay);
        }
        .features-list li span {
            display: block; 
            font-size: 0.9rem; 
            color: var(--dp-sidebar-text, #a0aed0); 
            margin-top: 3px;
            font-weight: 400;
        }
    
        /* 9 рдЖрдЗрдЯрдореНрд╕ рдХреЗ рд▓рд┐рдП рдПрдиреАрдореЗрд╢рди рдЯрд╛рдЗрдорд┐рдВрдЧ */
        .features-list li:nth-child(1) { --delay: 0s; }
        .features-list li:nth-child(2) { --delay: 2s; }
        .features-list li:nth-child(3) { --delay: 4s; }
        .features-list li:nth-child(4) { --delay: 6s; }
        .features-list li:nth-child(5) { --delay: 8s; }
        .features-list li:nth-child(6) { --delay: 10s; }
        .features-list li:nth-child(7) { --delay: 12s; }
        .features-list li:nth-child(8) { --delay: 14s; }
        .features-list li:nth-child(9) { --delay: 16s; }
    
        /* рд╕рд╣реА рдПрдиреАрдореЗрд╢рди рдХреА-рдлреНрд░реЗрдореНрд╕ */
        @keyframes slide-up-fade {
            /* рд╣рд░ рдЖрдЗрдЯрдо 18 рд╕реЗрдХрдВрдб рдХреЗ рд▓реВрдк рдореЗрдВ рд╕рд┐рд░реНрдл 2 рд╕реЗрдХрдВрдб рдХреЗ рд▓рд┐рдП рджрд┐рдЦреЗрдЧрд╛ */
            0%    { opacity: 0; transform: translateY(30px); }
            1.1%  { opacity: 1; transform: translateY(0); } /* 0.2s in */
            10%   { opacity: 1; transform: translateY(0); } /* 1.6s hold */
            11.1% { opacity: 0; transform: translateY(-15px); } /* 0.2s out */
            100%  { opacity: 0; }
        }
    
        /* 6. рдореЛрдмрд╛рдЗрд▓ рдХреЗ рд▓рд┐рдП (рдмрд╣реБрдд рдорд╣рддреНрд╡рдкреВрд░реНрдг) */
        @media (max-width: 800px) {
            .login-wrapper {
                grid-template-columns: 1fr;
                width: 95%;
                max-width: 450px;
                max-height: 90vh;
                overflow-y: auto;
            }
            .login-ad-sidebar {
                display: none; 
            }
            .login-card-glass {
                background: rgba(255, 255, 255, 0.98);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
        }
    
        /* 7. рд▓реИрдВрдбрд┐рдВрдЧ рдкреЗрдЬ рдХреЗ рдмрдЯрдиреНрд╕ рдХреЛ рд╕реНрдЯрд╛рдЗрд▓ рдХрд░реЗрдВ */
        .landing-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            padding: 20px;
        }
    
        /* 8. рд▓реИрдВрдбрд┐рдВрдЧ рдЯрд╛рдЗрдЯрд▓ рдФрд░ рд╕рдмрдЯрд╛рдЗрдЯрд▓ */
        .landing-title {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .landing-subtitle {
            font-size: 1.4rem;
            opacity: 0.9;
            margin-bottom: 2.5rem;
        }
    
        /* 9. рд▓реИрдВрдбрд┐рдВрдЧ рдмрдЯрдиреНрд╕ */
        .landing-btn {
            padding: 12px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }
        .landing-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        .landing-btn.btn-primary {
            background: var(--dp-primary, #00b4d8);
            border-color: var(--dp-primary, #00b4d8);
        }
        .landing-btn.btn-success {
            background: #1abc9c;
            border-color: #1abc9c;
        }
    
        /* 10. рдореЛрдмрд╛рдЗрд▓ рдХреЗ рд▓рд┐рдП рдЯрд╛рдЗрдЯрд▓реНрд╕ рдХреЛ рдЫреЛрдЯрд╛ рдХрд░реЗрдВ */
        @media (max-width: 767.98px) {
            .landing-title {
                font-size: 2.5rem;
            }
            .landing-subtitle {
                font-size: 1.1rem;
            }
        }
        /* ======================================================== */
        /* === ЁЯЪА рдирдпрд╛ CSS рдпрд╣рд╛рдБ рд╕рдорд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИ === */
        /* ======================================================== */

/* --- ЁЯЪА FIX: рдХреИрдорд░рд╛ рдФрд░ рд╕реНрдХреИрдирд░ рдХреЛ рд╕рдмрд╕реЗ рдКрдкрд░ рджрд┐рдЦрд╛рдиреЗ рдХреЗ рд▓рд┐рдП --- */
#localScannerModal {
    z-index: 10000 !important; /* рдпрд╣ рд▓рд╛рд▓ рдмрдЯрди рд╡рд╛рд▓реА рд╕реНрдХреНрд░реАрди (1050) рд╕реЗ рдмрд╣реБрдд рдКрдкрд░ рд░рд╣реЗрдЧрд╛ */
}

/* рдЕрдЧрд░ рдмреИрдХрдбреНрд░реЙрдк (рдХрд╛рд▓реА рд╕реНрдХреНрд░реАрди) рднреА рдЧрдбрд╝рдмрдбрд╝ рдХрд░реЗ рддреЛ рдЙрд╕реЗ рднреА рдареАрдХ рдХрд░реЗрдВ */
.modal-backdrop {
    z-index: 1040; /* рдбрд┐рдлреЙрд▓реНрдЯ */
}
/* рдЬрдм рджреВрд╕рд░рд╛ рдореЛрдбрд▓ (рд╕реНрдХреИрдирд░) рдЦреБрд▓реЗ, рддреЛ рдЙрд╕рдХрд╛ рдмреИрдХрдбреНрд░реЙрдк рдКрдкрд░ рдЖрдП */
.modal-backdrop:nth-of-type(2) {
    z-index: 9999 !important;
}


/* ============================================================
   ЁЯФе IMPROVED TABLE UI (BOLDER BORDERS & CLEARER TEXT)
   ============================================================ */

/* 1. рдЯреЗрдмрд▓ рдХрдВрдЯреЗрдирд░ рдХреЛ рд╕реБрдВрджрд░ рдмрдирд╛рдПрдВ */
.table-responsive {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* рдкрд░рдЫрд╛рдИ (Shadow) */
    border-radius: 10px; /* рдЧреЛрд▓ рдХреЛрдиреЗ */
    overflow: auto; /* рдХреЛрдиреЛрдВ рдХреЛ рд╕рд╛рдл рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП */
    border: 1px solid #cbd5e0; /* рдмрд╛рд╣рд░реА рдмреЙрд░реНрдбрд░ */
}

/* 2. рдЯреЗрдмрд▓ рдХреЗ рдмреЙрд░реНрдбрд░ рдХреЛ рдЧрд╣рд░рд╛ рдФрд░ рд╕реНрдкрд╖реНрдЯ рдХрд░реЗрдВ */
.table th, .table td {
    border: 1px solid #a0aec0 !important; /* ЁЯФе рдЧрд╣рд░рд╛ рдЧреНрд░реЗ рдмреЙрд░реНрдбрд░ (Deep Grey) */
    padding: 14px 16px !important; /* рдЦреБрд▓рд╛-рдЦреБрд▓рд╛ рд╕реНрдкреЗрд╕рд┐рдВрдЧ */
    vertical-align: middle; /* рдЯреЗрдХреНрд╕реНрдЯ рдмреАрдЪ рдореЗрдВ рд░рд╣реЗрдЧрд╛ */
}

/* 3. рд╣реЗрдбрд░ (Header) рдХреЛ рдкреНрд░реЛрдлреЗрд╢рдирд▓ рдмрдирд╛рдПрдВ */
.table th {
    background-color: #2d3748 !important; /* рдЧрд╣рд░рд╛ рдиреАрд▓рд╛ рдмреИрдХрдЧреНрд░рд╛рдЙрдВрдб */
    color: #ffffff !important; /* рд╕рдлреЗрдж рдЯреЗрдХреНрд╕реНрдЯ */
    font-weight: 700 !important; /* рдЬреНрдпрд╛рджрд╛ рдореЛрдЯрд╛ (Bold) рдЯреЗрдХреНрд╕реНрдЯ */
    text-transform: uppercase; /* рд╕рд╛рд░реЗ рд╢рдмреНрдж рдмрдбрд╝реЗ рдЕрдХреНрд╖рд░реЛрдВ рдореЗрдВ */
    font-size: 0.85rem; /* рд╕рд╣реА рд╕рд╛рдЗрдЬ */
    letter-spacing: 0.8px; /* рдЕрдХреНрд╖рд░реЛрдВ рдХреЗ рдмреАрдЪ рдЬрдЧрд╣ */
    border-bottom: 2px solid #1a202c !important; /* рдиреАрдЪреЗ рдХреА рд▓рд╛рдЗрди рдФрд░ рдЧрд╣рд░реА */
}

/* 4. рд╕реЗрд▓ рдХреЗ рдЕрдВрджрд░ рдХреЗ рд╢рдмреНрджреЛрдВ рдХреЛ рд╕рд╛рдл рдХрд░реЗрдВ */
.table td {
    color: #1a202c !important; /* рдЧрд╣рд░рд╛ рдХрд╛рд▓рд╛ рд░рдВрдЧ (Dark Black/Blue) */
    font-weight: 600 !important; /* рдереЛрдбрд╝рд╛ рдореЛрдЯрд╛ рдлреЙрдиреНрдЯ (Semi-Bold) */
    font-size: 0.95rem; /* рдкрдврд╝рдиреЗ рдореЗрдВ рдЖрд╕рд╛рди */
}

/* 5. рд╣реЛрд╡рд░ рдЗрдлреЗрдХреНрдЯ (рдорд╛рдЙрд╕ рд▓реЗ рдЬрд╛рдиреЗ рдкрд░ рдЪрдордХрдирд╛) */
.table-hover tbody tr:hover {
    background-color: #e6fffa !important; /* рд╣рд▓реНрдХрд╛ рд╣рд░рд╛/рдиреАрд▓рд╛ рд╣рд╛рдИрд▓рд╛рдЗрдЯ */
    cursor: pointer;
    transition: background-color 0.2s ease;
}

/* 6. рдЬрд╝реЗрдмрд░рд╛ рд╕реНрдЯреНрд░рд┐рдкрд┐рдВрдЧ (рдПрдХ рд▓рд╛рдЗрди рдбрд╛рд░реНрдХ, рдПрдХ рд▓рд╛рдЗрдЯ) */
.table-striped tbody tr:nth-of-type(odd) {
    background-color: #f7fafc !important; /* рдмрд╣реБрдд рд╣рд▓реНрдХрд╛ рдЧреНрд░реЗ */
}


/* ============================================================
   ЁЯФе DATA ENTRY FIELDS (BOLD BORDERS & CLEAR TEXT)
   ============================================================ */

/* 1. рд╕рднреА рдПрдВрдЯреНрд░реА рдмреЙрдХреНрд╕ (Inputs) рдФрд░ рд▓рд┐рд╕реНрдЯ (Select) рдХреЗ рдмреЙрд░реНрдбрд░ рдЧрд╣рд░реЗ рдХрд░реЗрдВ */
.form-control, .form-select, .input-group-text {
    border: 2px solid #718096 !important; /* рдЧрд╣рд░рд╛ рдЧреНрд░реЗ рдмреЙрд░реНрдбрд░ */
    border-radius: 6px; /* рдереЛрдбрд╝реЗ рдЧреЛрд▓ рдХреЛрдиреЗ */
    color: #1a202c !important; /* рдЧрд╣рд░рд╛ рдХрд╛рд▓рд╛ рдЯреЗрдХреНрд╕реНрдЯ */
    font-weight: 600 !important; /* рд╢рдмреНрдж рдореЛрдЯреЗ (Bold) рджрд┐рдЦреЗрдВрдЧреЗ */
    font-size: 1rem !important; /* рд╕рд╛рдЗрдЬрд╝ рдкрдврд╝рдиреЗ рдореЗрдВ рдЖрд╕рд╛рди */
    background-color: #ffffff !important;
}

/* 2. рдЬрдм рдЖрдк рдПрдВрдЯреНрд░реА рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ (Focus) */
.form-control:focus, .form-select:focus {
    border-color: #2b6cb0 !important; /* рдЧрд╣рд░рд╛ рдиреАрд▓рд╛ рдмреЙрд░реНрдбрд░ */
    box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.25) !important; /* рд╣рд▓реНрдХрд╛ рдиреАрд▓рд╛ рдЧреНрд▓реЛ */
    background-color: #f7fafc !important; /* рдмрд╣реБрдд рд╣рд▓реНрдХрд╛ рдмреИрдХрдЧреНрд░рд╛рдЙрдВрдб */
}

/* 3. рдЯреЗрдмрд▓ рдХреЗ рдЕрдВрджрд░ рд╡рд╛рд▓реЗ рдЗрдирдкреБрдЯ (рдЬреИрд╕реЗ POS рдореЗрдВ Qty) */
.table td input.form-control {
    border: 2px solid #a0aec0 !important;
    text-align: center; /* рдирдВрдмрд░ рдмреАрдЪ рдореЗрдВ рджрд┐рдЦреЗрдЧрд╛ */
    font-weight: 700 !important; /* рдФрд░ рдЬрд╝реНрдпрд╛рджрд╛ рдмреЛрд▓реНрдб */
    color: #2d3748 !important;
}

/* 4. рдлрд╝реАрд▓реНрдб рдХреЗ рдКрдкрд░ рд▓рд┐рдЦреЗ рдирд╛рдо (Labels) рдХреЛ рд╕рд╛рдлрд╝ рдХрд░реЗрдВ */
.form-label {
    font-weight: 700 !important; /* рд▓реЗрдмрд▓реНрд╕ рдХреЛ рдмреЛрд▓реНрдб рдХрд░реЗрдВ */
    color: #4a5568 !important; /* рдЧрд╣рд░рд╛ рдЧреНрд░реЗ */
    margin-bottom: 6px;
    letter-spacing: 0.5px;
}

/* 5. рдЗрдирдкреБрдЯ рдЧреНрд░реБрдк (рдЬреИрд╕реЗ тВ╣ рдпрд╛ рдЖрдЗрдХреЙрди рд╡рд╛рд▓реЗ рдмреЙрдХреНрд╕) */
.input-group-text {
    background-color: #e2e8f0 !important;
    border: 2px solid #718096 !important;
    color: #2d3748 !important;
    font-weight: 700 !important;
}


/* ============================================================
   ЁЯдЦ AI INSIGHTS - MODERN UI (FUTURISTIC LOOK)
   ============================================================ */

/* 1. рд╣реЗрдбрд░ рдХреЛ рд╕реБрдВрджрд░ рдФрд░ рдореЙрдбрд░реНрди рдмрдирд╛рдПрдВ (Gradient & Shadow) */
.ai-header-box {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; /* рдмреНрд▓реВ-рд░реНрдкрд▓ рдЧреНрд░реЗрдбрд┐рдПрдВрдЯ */
    color: white !important;
    padding: 30px !important;
    border-radius: 20px !important;
    box-shadow: 0 10px 30px rgba(118, 75, 162, 0.4) !important; /* рдЧреНрд▓реЛрдЗрдВрдЧ рд╢реИрдбреЛ */
    margin-bottom: 35px !important;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.ai-title {
    font-size: 2.2rem !important;
    font-weight: 800 !important;
    letter-spacing: 1px;
    margin-bottom: 5px !important;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.ai-subtitle {
    font-size: 1rem !important;
    opacity: 0.9;
    font-weight: 400;
}

/* 2. рд░рд┐рдлреНрд░реЗрд╢ рдмрдЯрди рдХреЛ рдЧреНрд▓рд╛рд╕ рдЗрдлреЗрдХреНрдЯ рджреЗрдВ */
.ai-refresh-btn {
    background: rgba(255, 255, 255, 0.2) !important;
    border: 1px solid rgba(255, 255, 255, 0.4) !important;
    color: white !important;
    padding: 12px 25px !important;
    border-radius: 50px !important;
    font-weight: 600 !important;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.ai-refresh-btn:hover {
    background: white !important;
    color: #764ba2 !important;
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
}

/* 3. рд╕рд╛рд░реЗ AI рдмреЙрдХреНрд╕ (Cards) рдХреЛ рд╕рд╛рдлрд╝ рдФрд░ рдкреНрд░реЛрдлреЗрд╢рдирд▓ рдмрдирд╛рдПрдВ */
.ai-box {
    background: #ffffff !important;
    border-radius: 16px !important;
    padding: 25px !important;
    margin-bottom: 25px !important;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.06) !important; /* рд╕реЙрдлреНрдЯ рд╢реИрдбреЛ */
    border: 1px solid #e2e8f0 !important;
    transition: transform 0.3s ease;
    position: relative;
    overflow: hidden;
}

.ai-box:hover {
    transform: translateY(-5px); /* рдорд╛рдЙрд╕ рд▓реЗ рдЬрд╛рдиреЗ рдкрд░ рдКрдкрд░ рдЙрдареЗрдЧрд╛ */
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12) !important;
}

.ai-box h3 {
    color: #2d3748;
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid #edf2f7;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* 4. рдЕрд▓рд░реНрдЯ/рдореИрд╕реЗрдЬ (Insights) рдХреЛ рд░рдВрдЧреАрди рдФрд░ рд╕рд╛рдлрд╝ рдХрд░реЗрдВ */
.ai-card-alert {
    border-radius: 12px !important;
    padding: 16px !important;
    margin-bottom: 16px !important;
    border-left: 5px solid !important; /* рдмрд╛рдпреАрдВ рддрд░рдл рдореЛрдЯреА рд▓рд╛рдЗрди */
    background: #f8fafc;
    box-shadow: 0 2px 5px rgba(0,0,0,0.03);
}

/* рдЕрд▓рдЧ-рдЕрд▓рдЧ рд░рдВрдЧреЛрдВ рдХреЗ рд▓рд┐рдП (Success, Warning, Danger) */
.ai-alert-info {
    background-color: #ebf8ff !important;
    border-left-color: #4299e1 !important; /* рдиреАрд▓рд╛ */
    color: #2b6cb0;
}

.ai-alert-warning {
    background-color: #fffff0 !important;
    border-left-color: #ecc94b !important; /* рдкреАрд▓рд╛ */
    color: #975a16;
}

.ai-alert-danger {
    background-color: #fff5f5 !important;
    border-left-color: #f56565 !important; /* рд▓рд╛рд▓ */
    color: #c53030;
}

.ai-alert-success {
    background-color: #f0fff4 !important;
    border-left-color: #48bb78 !important; /* рд╣рд░рд╛ */
    color: #2f855a;
}

/* 5. Health Score Circle (рдЧреЛрд▓ рд╡рд╛рд▓рд╛ рд╕реНрдХреЛрд░) */
.ai-score-circle {
    width: 90px;
    height: 90px;
    background: conic-gradient(#48bb78 0%, #48bb78 var(--score, 100%), #e2e8f0 0%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #2f855a;
    font-size: 2.2rem;
    font-weight: 800;
    border: 5px solid #f0fff4;
    box-shadow: 0 0 15px rgba(72, 187, 120, 0.3);
}

/* 6. Chat Box (рдиреАрдЪреЗ рд╡рд╛рд▓рд╛) - Dark Mode Style */
#ai-chat-box {
    background: #2d3748 !important; /* рдбрд╛рд░реНрдХ рдмреИрдХрдЧреНрд░рд╛рдЙрдВрдб */
    color: white !important;
    border: none !important;
}

#ai-chat-box h3 {
    color: white !important;
    border-bottom-color: #4a5568 !important;
}

.ai-chat-input input {
    background: rgba(255, 255, 255, 0.1) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    color: white !important;
    border-radius: 50px !important;
    padding: 12px 25px !important;
    width: 75% !important;
}

.ai-chat-input input:focus {
    background: rgba(255, 255, 255, 0.2) !important;
    outline: none;
    box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
}

.ai-chat-input button {
    background: #48bb78 !important;
    color: white !important;
    border-radius: 50px !important;
    padding: 10px 25px !important;
    font-weight: bold;
    border: none;
    transition: transform 0.2s;
}

.ai-chat-input button:hover {
    transform: scale(1.05);
    background: #38a169 !important;
}


/* ============================================================
   ЁЯУЦ AI TYPOGRAPHY - TEXT BEAUTIFICATION (READABILITY)
   ============================================================ */

/* 1. рдкреИрд░рд╛рдЧреНрд░рд╛рдл рдФрд░ рд▓рд┐рд╕реНрдЯ рдХреЛ рдЦреБрд▓рд╛-рдЦреБрд▓рд╛ рдФрд░ рд╕рд╛реЮ рдХрд░реЗрдВ */
.ai-box p, .ai-box li, .ai-chat-response {
    font-size: 1.05rem !important; /* рдЕрдХреНрд╖рд░ рдереЛреЬреЗ рдмреЬреЗ */
    line-height: 1.8 !important;    /* рд▓рд╛рдЗрдиреЛрдВ рдХреЗ рдмреАрдЪ рдЧреИрдк (рддрд╛рдХрд┐ рдкреЭрдиреЗ рдореЗрдВ рд╕реБрдХреВрди рдорд┐рд▓реЗ) */
    color: #2d3748 !important;      /* рдЧрд╣рд░рд╛ рд╕реНрд▓реЗрдЯ рдХрд▓рд░ (рдЖрдБрдЦреЛрдВ рдХреЛ рдирд╣реАрдВ рдЪреБрднреЗрдЧрд╛) */
    font-weight: 500 !important;    /* рд╣рд▓реНрдХрд╛ рдореЛрдЯрд╛ (Readable) */
    letter-spacing: 0.3px;          /* рдЕрдХреНрд╖рд░реЛрдВ рдХреЗ рдмреАрдЪ рд╣рд▓реНрдХреА рдЬрдЧрд╣ */
}

/* 2. рдЬреЛ рд╢рдмреНрдж Bold (рдореЛрдЯреЗ) рд╣реИрдВ, рдЙрдиреНрд╣реЗрдВ рдХрд▓рд░рдлреБрд▓ рдмрдирд╛рдПрдВ */
.ai-box b, .ai-box strong {
    color: #3182ce !important; /* рд╕реБрдВрджрд░ рдиреАрд▓рд╛ рд░рдВрдЧ (Highlight) */
    font-weight: 700 !important;
    background: rgba(49, 130, 206, 0.1); /* рдкреАрдЫреЗ рд╣рд▓реНрдХрд╛ рдиреАрд▓рд╛ рдмреИрдХрдЧреНрд░рд╛рдЙрдВрдб */
    padding: 0 4px;
    border-radius: 4px;
}

/* 3. рд╣реЗрдбрд┐рдВрдЧреНрд╕ (Headings) рдХреЛ рдкреНрд░реАрдорд┐рдпрдо рд▓реБрдХ рджреЗрдВ */
.ai-box h3, .ai-box h4, .ai-box h5 {
    color: #1a202c !important; /* рдЬреЗрдб рдмреНрд▓реИрдХ */
    font-weight: 800 !important; /* рдПрдХреНрд╕реНрдЯреНрд░рд╛ рдмреЛрд▓реНрдб */
    margin-bottom: 15px !important;
    letter-spacing: -0.5px; /* рдореЙрдбрд░реНрди рдЯрд╛рдЗрдЯ рд▓реБрдХ */
}

/* 4. AI Chat Response (рдЬреЛ рдЬрд╡рд╛рдм рдЖрддрд╛ рд╣реИ) */
.ai-chat-response {
    background: #f7fafc !important;
    border-radius: 12px;
    padding: 20px !important;
    border: 1px solid #e2e8f0;
    margin-bottom: 15px;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
}

/* 5. рдЫреЛрдЯреЗ рдЯреЗрдХреНрд╕реНрдЯ (Muted Text) рдХреЛ рднреА рд╕рд╛реЮ рдХрд░реЗрдВ */
.text-muted-small {
    font-size: 0.9rem !important;
    color: #718096 !important;
    font-style: italic;
}

/* 6. AI Badges (Pills) рдХреЛ рд╕реБрдВрджрд░ рдмрдирд╛рдПрдВ */
.ai-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 50px;
    font-size: 0.85rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* рдмреИрдЬ рдХреЗ рд░рдВрдЧ */
.ai-badge-blue { background: #ebf8ff; color: #2b6cb0; border: 1px solid #bee3f8; }
.ai-badge-green { background: #f0fff4; color: #2f855a; border: 1px solid #c6f6d5; }
.ai-badge-yellow { background: #fffff0; color: #975a16; border: 1px solid #fefcbf; }
.ai-badge-red { background: #fff5f5; color: #c53030; border: 1px solid #fed7d7; }

/* 7. рд▓рд┐рд╕реНрдЯ рдХреЗ рдбреЙрдЯреНрд╕ рдХреЛ рд╕реБрдВрджрд░ рдмрдирд╛рдПрдВ */
.ai-box ul {
    padding-left: 20px;
    list-style-type: none; /* рдкреБрд░рд╛рдиреЗ рдбреЙрдЯреНрд╕ рд╣рдЯрд╛рдПрдВ */
}

.ai-box ul li {
    position: relative;
    padding-left: 15px;
    margin-bottom: 8px;
}

.ai-box ul li::before {
    content: "тАв";
    color: #667eea; /* рдмреБрд▓реЗрдЯ рдкреЙрдЗрдВрдЯреНрд╕ рдХрд╛ рд░рдВрдЧ */
    font-weight: bold;
    font-size: 1.5em;
    position: absolute;
    left: -10px;
    top: -5px;
}

/* ============================================================
   тЬЕ FIX: WHATSAPP BUTTON VISIBILITY (GREEN COLOR)
   ============================================================ */

/* рд╕рд┐рд░реНрдл AI рдмреЙрдХреНрд╕ рдХреЗ рдЕрдВрджрд░ рд╡рд╛рд▓реЗ рдмрдЯрди рдХреЛ рд╣рд░рд╛ (Green) рдХрд░реЗрдВ */
.ai-box .ai-refresh-btn {
    background: #25D366 !important; /* WhatsApp Official Green */
    color: white !important; /* рд╕рдлрд╝реЗрдж рдЯреЗрдХреНрд╕реНрдЯ */
    border: none !important;
    font-size: 0.85rem !important;
    padding: 8px 16px !important;
    box-shadow: 0 4px 10px rgba(37, 211, 102, 0.3) !important; /* рд╣рд░реА рдкрд░рдЫрд╛рдИ */
    text-shadow: none !important;
    margin-top: 5px;
}

/* рдорд╛рдЙрд╕ рд▓реЗ рдЬрд╛рдиреЗ рдкрд░ (Hover) */
.ai-box .ai-refresh-btn:hover {
    background: #128C7E !important; /* рдЧрд╣рд░рд╛ рд╣рд░рд╛ */
    color: white !important;
    transform: translateY(-2px); /* рдереЛрдбрд╝рд╛ рдКрдкрд░ рдЙрдареЗрдЧрд╛ */
    box-shadow: 0 6px 15px rgba(37, 211, 102, 0.4) !important;
}


/* ============================================================
   тЬЕ FIX: CUSTOMER TARGETING WHATSAPP BUTTON
   ============================================================ */

/* Targeting рд╕реЗрдХреНрд╢рди рдХреЗ рдЕрдВрджрд░ рдХреЗ рд╕рднреА рд▓рд┐рдВрдХ/рдмрдЯрди рдХреЛ рд╣рд░рд╛ рдХрд░реЗрдВ */
#ai-customer-targeting-content a, 
#ai-customer-targeting-content button,
#ai-customer-targeting-content .btn {
    background-color: #25D366 !important; /* WhatsApp рд╣рд░рд╛ */
    color: #ffffff !important; /* рд╕рдлрд╝реЗрдж рдЯреЗрдХреНрд╕реНрдЯ/рдЖрдЗрдХреЙрди */
    border: none !important;
    box-shadow: 0 3px 6px rgba(37, 211, 102, 0.3) !important;
    border-radius: 5px !important;
    padding: 6px 12px !important;
    font-weight: bold !important;
    text-decoration: none !important;
    display: inline-block !important;
    margin-left: 5px !important;
}

/* рдорд╛рдЙрд╕ рд▓реЗ рдЬрд╛рдиреЗ рдкрд░ */
#ai-customer-targeting-content a:hover, 
#ai-customer-targeting-content button:hover {
    background-color: #128C7E !important; /* рдЧрд╣рд░рд╛ рд╣рд░рд╛ */
    transform: scale(1.05);
    box-shadow: 0 5px 12px rgba(37, 211, 102, 0.4) !important;
}

/* рдЕрдЧрд░ рдЖрдЗрдХреЙрди (i tag) рдХрд╛ рд░рдВрдЧ рдЕрд▓рдЧ рд╣реИ рддреЛ рдЙрд╕реЗ рднреА рд╕рдлрд╝реЗрдж рдХрд░реЗрдВ */
#ai-customer-targeting-content i {
    color: #ffffff !important;
}

/* ЁЯЪА FIX: AI Insights Layout Correction */
#ai-insights {
    width: 100%;
    /* рдЕрдЧрд░ рдпрд╣ main-content рдХреЗ рдмрд╛рд╣рд░ рд╣реИ, рддреЛ рдЗрд╕реЗ рд╕рд╣реА рдорд╛рд░реНрдЬрд┐рди рджреЗрдВ */
    padding-left: 0; 
}

/* рдЕрдЧрд░ рд╕реНрдХреНрд░реАрди рдмрдбрд╝реА рд╣реИ (Laptop/PC) рдФрд░ рдпрд╣ рдЧрд▓рддреА рд╕реЗ рдмрд╛рд╣рд░ рд╣реИ */
@media (min-width: 992px) {
    body > #ai-insights {
        margin-left: 280px; /* рд╕рд╛рдЗрдбрдмрд╛рд░ рдХреА рдЬрдЧрд╣ рдЫреЛреЬреЗрдВ */
        width: calc(100% - 280px); /* рдмрд╛рдХреА рдмрдЪреА рдЬрдЧрд╣ рд▓реЗрдВ */
        padding: 30px;
    }
}

/* рд╣реЗрдбрд░ рдмреЙрдХреНрд╕ рдХреЛ рдФрд░ рд╕реБрдВрджрд░ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП */
.ai-header-box {
    margin-top: 10px;
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37) !important;
    border: 1px solid rgba(255, 255, 255, 0.18) !important;
    width: 100%; /* рдлреБрд▓ рд╡рд┐рдбреНрде */
    box-sizing: border-box; /* рдкреИрдбрд┐рдВрдЧ рдХреЛ рд╡рд┐рдбреНрде рдХреЗ рдЕрдВрджрд░ рд░рдЦреЗрдВ */
}


/* ==============================================
   ЁЯУ▒ MOBILE TABLE FIX (STICKY ACTIONS)
   ============================================== */
   @media (max-width: 991px) {
    /* 1. рдЯреЗрдмрд▓ рдХреЛ рд╕рд╛рдЗрдб рдореЗрдВ рд╕реНрдХреНрд░реЙрд▓ рдХрд░рдиреЗ рд▓рд╛рдпрдХ рдмрдирд╛рдПрдВ */
    .table-responsive {
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch;
        display: block;
        width: 100%;
    }

    /* 2. рдЯреЗрдХреНрд╕реНрдЯ рдХреЛ рдПрдХ рд▓рд╛рдЗрди рдореЗрдВ рд░рдЦреЗрдВ */
    .table th, .table td {
        white-space: nowrap;
        font-size: 0.85rem;
        padding: 8px 6px !important;
        vertical-align: middle;
    }

    /* 3. рдмрдЯрди рдХреЛ рдЪрд┐рдкрдХрд╛рдПрдВ (Sticky) */
    .table th:last-child,
    .table td:last-child {
        position: sticky !important;
        right: 0;
        background-color: #ffffff !important;
        box-shadow: -2px 0 5px rgba(0,0,0,0.1);
        z-index: 5;
        width: 120px;
        text-align: center;
    }

    /* рд╣реЗрдбрд░ рдХрд╛ рд░рдВрдЧ */
    .table th:last-child {
        background-color: #2d3748 !important;
        color: white !important;
    }

    /* 4. рдлреНрд▓реЗрдХреНрд╕ рдмрдЯрди */
    .table td:last-child div, 
    .table td:last-child {
        display: flex;
        justify-content: center;
        gap: 5px;
    }
}

/* =======================================================
   ЁЯФе FORCE HIDE: рдлрд╛рд▓рддреВ рдлреЙрд░реНрдо рдФрд░ рдХрдЪрд░рд╛ рд╣рдЯрд╛рдиреЗ рдХрд╛ рдмреНрд░рд╣реНрдорд╛рд╕реНрддреНрд░
   ======================================================= */

/* 1. рдЪрд╢реНрдореЗ рдФрд░ рдЬреВрддреЛрдВ рд╡рд╛рд▓реЗ рдкреБрд░рд╛рдиреЗ рд╕реЗрдХреНрд╢рди рдХреЛ рдЧрд╛рдпрдм рдХрд░реЗрдВ */
#prescription-fields-container, 
#add-custom-field-btn,
.custom-field-wrapper {
    display: none !important;
}

/* 2. рдЕрдЧрд░ рдХреЛрдИ рдкреБрд░рд╛рдиреА 'Bulk Table' HTML рдореЗрдВ рдкрд╣рд▓реЗ рд╕реЗ рд▓рд┐рдЦреА рд╣реИ, рддреЛ рдЙрд╕реЗ рдЫрд┐рдкрд╛рдПрдВ */
/* рдиреЛрдЯ: JS рдЬрдм рдирдпрд╛ рдЯреЗрдмрд▓ рдмрдирд╛рдПрдЧрд╛, рддреЛ рд╡реЛ рдЗрд╕реЗ рдУрд╡рд░рд░рд╛рдЗрдб рдХрд░ рд▓реЗрдЧрд╛ */
#dish-bulk-container {
    display: none; 
}

/* 3. 'Chasme ke liye' рдпрд╛ 'Jooton ke liye' рд╡рд╛рд▓реЗ рдЯреЗрдХреНрд╕реНрдЯ рдХреЛ рдЫрд┐рдкрд╛рдиреЗ рдХреЗ рд▓рд┐рдП */
/* рдпрд╣ рдЙрди h6 рдпрд╛ p рдЯреИрдЧреНрд╕ рдХреЛ рдЯрд╛рд░рдЧреЗрдЯ рдХрд░реЗрдЧрд╛ рдЬрд┐рдирдореЗрдВ рдпрд╣ рдЖрдИрдбреА рд╣реЛ рд╕рдХрддреА рд╣реИ (рдЕрдЧрд░ рдЖрдкрдиреЗ рджреА рд╣реИ) */
[id*="prescription"], [class*="prescription"] {
    display: none !important;
}

/* 4. JS рджреНрд╡рд╛рд░рд╛ рдмрдирд╛рдП рдЧрдП рдкреБрд░рд╛рдиреЗ рдХрдЪрд░реЗ рдХреЛ рднреА рдЫрд┐рдкрд╛ рдХрд░ рд░рдЦреЗрдВ */
#dynamic-business-fields {
    display: none;
}

/* тЬЕ Garments ke liye Anti-Theft Security panel */
#garments-security-fields {
    display: block !important;
}


/* ЁЯЦия╕П THERMAL PRINTER STYLE (58mm / 80mm) */
@media print {
    /* 1. рд╡реЗрдмрд╕рд╛рдЗрдЯ рдХрд╛ рдмрд╛рдХреА рд╕рдм рдХреБрдЫ рдЫрд┐рдкрд╛ рджреЗрдВ */
    body * {
        visibility: hidden;
    }

    /* 2. рд╕рд┐рд░реНрдл рдкрд░реНрдЪреА рдХреЛ рджрд┐рдЦрд╛рдПрдВ */
    #thermal-receipt-area, #thermal-receipt-area * {
        visibility: visible;
    }

    /* 3. рдкрд░реНрдЪреА рдХреА рдкреЛрдЬреАрд╢рди рд╕реЗрдЯ рдХрд░реЗрдВ */
    #thermal-receipt-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%; /* рдкреНрд░рд┐рдВрдЯрд░ рдЕрдкрдиреЗ рдЖрдк рдЪреМрдбрд╝рд╛рдИ рд▓реЗ рд▓реЗрдЧрд╛ */
        margin: 0;
        padding: 0;
    }

    /* 4. рдкреЗрдЬ рдорд╛рд░реНрдЬрд┐рди рд╣рдЯрд╛рдПрдВ (рдХрд╛рдЧрдЬ рдмрдЪрд╛рдиреЗ рдХреЗ рд▓рд┐рдП) */
    @page {
        margin: 0;
        size: auto;
    }
}

/* рд╕реНрдХреНрд░реАрди рдкрд░ рдкрд░реНрдЪреА рдХреИрд╕реА рджрд┐рдЦреЗрдЧреА (рдлрд┐рд▓рд╣рд╛рд▓ рдЫрд┐рдкрд╛ рдХрд░ рд░рдЦреЗрдВ) */
#thermal-receipt-area {
    display: none; /* рд╕реНрдХреНрд░реАрди рдкрд░ рдирд╣реАрдВ рджрд┐рдЦреЗрдЧрд╛ */
    width: 58mm;   /* рд╕реНрдЯреИрдВрдбрд░реНрдб рдЫреЛрдЯреА рдкрд░реНрдЪреА (рдЖрдк 80mm рднреА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ) */
    background: white;
    padding: 10px;
    font-family: 'Courier New', monospace; /* рд░рд╕реАрдж рд╡рд╛рд▓рд╛ рдлреЙрдиреНрдЯ */
    font-size: 12px;
    color: black;
}

.receipt-header { text-align: center; margin-bottom: 10px; border-bottom: 1px dashed #000; padding-bottom: 5px; }
.receipt-bold { font-weight: bold; }
.receipt-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
.receipt-table th { text-align: left; border-bottom: 1px dashed #000; font-size: 10px; }
.receipt-table td { text-align: left; font-size: 11px; padding-top: 2px; }
.receipt-footer { text-align: center; margin-top: 10px; border-top: 1px dashed #000; padding-top: 5px; font-size: 10px; }



    </style>

</head>

<body>



    <input type="text" id="barcode-scanner-input" autocomplete="off">


    <div class="auth-overlay" id="auth-container-new">
        <div class="landing-buttons" id="landing-buttons-container">
            <h1 class="landing-title">Dukan Pro Ultimate</h1>
            <p class="landing-subtitle">рдЗрдВрдбрд┐рдпрд╛ рдХрд╛ рд╕рдмрд╕реЗ рдПрдбрд╡рд╛рдВрд╕ рдмрд┐реЫрдиреЗрд╕ рд╕реВрдЯ</p>
            <div class="d-flex flex-wrap justify-content-center gap-3">
                <button class="btn btn-primary btn-lg landing-btn" id="show-login-btn">
                    <i class="fas fa-sign-in-alt me-2"></i>рд▓реЙрдЧрд┐рди рдХрд░реЗрдВ
                </button>
                <button class="btn btn-success btn-lg landing-btn" id="show-register-btn">
                    <i class="fas fa-user-plus me-2"></i>рдирдпрд╛ рдЕрдХрд╛рдЙрдВрдЯ рдмрдирд╛рдПрдВ
                </button>
            </div>
        </div>
    
        <div class="login-wrapper" id="login-wrapper-main">
        
        <div class="login-ad-sidebar">
            <h3 class="mb-3"><i class="fas fa-store me-2"></i>Dukan Pro Ultimate</h3>
            <p>рдЗрдВрдбрд┐рдпрд╛ рдХрд╛ рд╕рдмрд╕реЗ рдПрдбрд╡рд╛рдВрд╕ рдмрд┐реЫрдиреЗрд╕ рд╕реВрдЯ</p>
            
            <ul class="features-list">
                <li><i class="fas fa-file-alt me-2"></i> GSTR-1, 2, & 3B Reports<br><span>(GSTR-1, 2, рдФрд░ 3B рд░рд┐рдкреЛрд░реНрдЯреНрд╕)</span></li>
                <li><i class="fas fa-university me-2"></i> Automated Bank Reconciliation<br><span>(рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдмреИрдВрдХ рд╕рдорд╛рдзрд╛рди)</span></li>
                <li><i class="fas fa-qrcode me-2"></i> Barcode Scanning via Mobile<br><span>(рдореЛрдмрд╛рдЗрд▓ рд╕реЗ рдмрд╛рд░рдХреЛрдб рд╕реНрдХреИрдирд┐рдВрдЧ)</span></li>
                <li><i class="fas fa-users me-2"></i> Advanced Customer (CRM)<br><span>(рдЙрдиреНрдирдд рдЧреНрд░рд╛рд╣рдХ рд╕рдВрдмрдВрдз рдкреНрд░рдмрдВрдзрди)</span></li>
                <li><i class="fas fa-boxes me-2"></i> Smart Stock & Inventory Control<br><span>(рд╕реНрдорд╛рд░реНрдЯ рд╕реНрдЯреЙрдХ рдФрд░ рдЗрдиреНрд╡реЗрдВрдЯрд░реА рдирд┐рдпрдВрддреНрд░рдг)</span></li>
                <li><i class="fas fa-chart-line me-2"></i> Real-time P&L & Analytics<br><span>(рд░рд┐рдпрд▓-рдЯрд╛рдЗрдо P&L рдФрд░ рд╡рд┐рд╢реНрд▓реЗрд╖рдг)</span></li>
                <li><i class="fas fa-cash-register me-2"></i> Lightning-Fast POS Billing<br><span>(рдмрд┐рдЬрд▓реА рдХреА рддреЗрдЬрд╝реА рд╕реЗ POS рдмрд┐рд▓рд┐рдВрдЧ)</span></li>
                <li><i class="fas fa-receipt me-2"></i> Customizable Invoice Generator<br><span>(рдХрд╕реНрдЯрдорд╛рдЗрдЬреЗрдмрд▓ рдЗрдирд╡реЙрдЗрд╕ рдЬрдирд░реЗрдЯрд░)</span></li>
                <li><i class="fas fa-cloud me-2"></i> Secure Cloud Data Backup<br><span>(рд╕реБрд░рдХреНрд╖рд┐рдд рдХреНрд▓рд╛рдЙрдб рдбреЗрдЯрд╛ рдмреИрдХрдЕрдк)</span></li>
            </ul>

            <div class="ad-footer">
                <p>рдЖрдкрдХреЗ рдмрд┐реЫрдиреЗрд╕ рдХреА рд╣рд░ реЫрд░реВрд░рдд, рдПрдХ рд╕реЙрдлреНрдЯрд╡реЗрдпрд░ рдореЗрдВред</p>
            </div>
        </div>
        
        <div class="login-card-glass">
            <nav>
                <div class="nav nav-tabs" id="nav-tab" role="tablist">
                    <button class="nav-link active w-50" id="nav-login-tab" data-bs-toggle="tab" data-bs-target="#nav-login" type="button" role="tab" aria-controls="nav-login" aria-selected="true">
                        <i class="fas fa-sign-in-alt me-2"></i>рд▓реЙрдЧрд┐рди
                    </button>
                    <button class="nav-link w-50" id="nav-register-tab" data-bs-toggle="tab" data-bs-target="#nav-register" type="button" role="tab" aria-controls="nav-register" aria-selected="false">
                        <i class="fas fa-user-plus me-2"></i>рдирдпрд╛ рдЕрдХрд╛рдЙрдВрдЯ
                    </button>
                </div>
            </nav>
            <div class="tab-content mt-4" id="nav-tabContent">
                <div class="tab-pane fade show active" id="nav-login" role="tabpanel" aria-labelledby="nav-login-tab">
                    <h3 class="text-center mb-4">Dukan Pro рдореЗрдВ рд▓реЙрдЧрд┐рди рдХрд░реЗрдВ</h3>
                    <form id="login-form">
                        <div class="mb-3">
                            <label for="login-email" class="form-label">рдИрдореЗрд▓</label>
                            <input type="email" class="form-control" id="login-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="login-password" class="form-label">рдкрд╛рд╕рд╡рд░реНрдб</label>
                            <input type="password" class="form-control" id="login-password" required>
                        </div>
                        <div id="login-message" class="text-danger small mb-3">&nbsp;</div>
                        <button type="submit" class="btn btn-primary w-100" id="login-submit-btn">рд▓реЙрдЧрд┐рди</button>
                    </form>
                </div>
                <div class="tab-pane fade" id="nav-register" role="tabpanel" aria-labelledby="nav-register-tab">
                    <h3 class="text-center mb-4">рдирдпрд╛ рд╢реЙрдк рдЕрдХрд╛рдЙрдВрдЯ рдмрдирд╛рдПрдВ</h3>
                    <form id="register-form">
                        <div class="mb-3">
                            <label for="register-shop-name" class="form-label">рдЖрдкрдХреА рд╢реЙрдк рдХрд╛ рдирд╛рдо</label>
                            <input type="text" class="form-control" id="register-shop-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="register-name" class="form-label">рдЖрдкрдХрд╛ рдкреВрд░рд╛ рдирд╛рдо (рдПрдбрдорд┐рди)</label>
                            <input type="text" class="form-control" id="register-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="register-email" class="form-label">рдЖрдкрдХрд╛ рдИрдореЗрд▓</label>
                            <input type="email" class="form-control" id="register-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="register-mobile" class="form-label">рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░</label>
                            <input type="tel" class="form-control" id="register-mobile" required pattern="[0-9]{10}">
                        </div>
                        <div class="mb-3">
                            <label for="register-password" class="form-label">рдирдпрд╛ рдкрд╛рд╕рд╡рд░реНрдб</label>
                            <input type="password" class="form-control" id="register-password" required>
                        </div>

                        <!-- Add this in your shop settings / registration form -->
                        <div class="mb-3">
                            <label for="unique-biz-type" class="form-label">рдмрд┐рдЬрдиреЗрд╕ рдХрд╛ рдкреНрд░рдХрд╛рд░ (Business Type)</label>
                            <select id="unique-biz-type" class="form-select" required>
                                <option value="" selected disabled>-- рдЕрдкрдиреА рджреБрдХрд╛рди рдХрд╛ рдкреНрд░рдХрд╛рд░ рдЪреБрдиреЗрдВ --</option>
                                
                                <optgroup label="ЁЯЫНя╕П Retail & Shops">
                                    <option value="RETAIL">General Store / Kirana</option>
                                    <option value="MOBILE_SHOP">Mobile & Accessories</option>
                                    <option value="CLOTHING">Garments / Boutique</option>
                                    <option value="FURNITURE">Furniture Showroom</option>
                                    <option value="JEWELLERY">Jewellery / Imitation</option>
                                    <optgroup label="ЁЯЫая╕П Hardware & Construction">
                                    <option value="HARDWARE_GENERAL">Hardware / Tools / Iron Store</option>
                                        
                                    <option value="PAINT_SHOP">Paint Shop / Color World</option>
                                    <option value="SWEET_SHOP">Sweet Shop / Bakery</option>
                                    <option value="ELECTRONICS">Electronics Showroom</option>
                                    <option value="SIM_STORE">SIM Card & Recharge</option>
                                </optgroup>
                        
                                <optgroup label="тЪХя╕П Medical & Health">
                                    <option value="PHARMACY">Medical Store / Pharmacy</option>
                                    <option value="DOCTOR_CLINIC">General Physician (Clinic)</option>
                                    <option value="ORTHOPEDIC">Orthopedic Clinic</option>
                                    <option value="DENTIST">Dental Clinic</option>
                                    <option value="SONOGRAPHY">Sonography / X-Ray Centre</option>
                                    <option value="PHYSIOTHERAPY">Physiotherapy Centre</option>
                                    <option value="PATHOLOGY">Pathology Lab</option>
                                </optgroup>
                        
                                <optgroup label="тЬВя╕П Services & Personal Care">
                                    <option value="SALON">Salon / Spa</option>
                                    <option value="GYM">Gym / Fitness Center</option>
                                    <option value="TAILOR">Tailor / Boutique</option>
                                    <option value="SERVICE_CENTER">Repairing Center (Electronics)</option>
                                </optgroup>
                        
                                <optgroup label="ЁЯПи Hospitality & Food">
                                    <option value="RESTAURANT">Restaurant / Cafe</option>
                                    <option value="HOTEL">Hotel / Lodging</option>
                                    <option value="TENT_HOUSE">Tent House / Rentals</option>
                                </optgroup>
                        
                                <optgroup label="ЁЯЪЪ Construction & Transport">
                                    <option value="TILES_CERAMIC">Tiles & Sanitaryware</option>
                                    <option value="TRANSPORT">Transport / Logistics</option>
                                </optgroup>
                        
                                <optgroup label="ЁЯТ░ Finance & Agents">
                                    <option value="LOAN_DSA">Loan / Credit Card DSA</option>
                                    <option value="RECOVERY_AGENT">Recovery / Collection Agent</option>
                                    <option value="INSURANCE_AGENCY">Insurance Agent</option>
                                </optgroup>
                        
                                <optgroup label="ЁЯОУ Education & Office">
                                    <option value="SCHOOL">School / Coaching</option>
                                    <option value="ARCHITECT_FIRM">Architect / Interior</option>
                                    <option value="SOFTWARE_COMPANY">Software / IT Firm</option>
                                </optgroup>
                            </select>
                            <div class="form-text text-muted">
                                рд╕рд╣реА рдкреНрд░рдХрд╛рд░ рдЪреБрдиреЗрдВ, рдЗрд╕рд╕реЗ рдЖрдкрдХрд╛ рдбреИрд╢рдмреЛрд░реНрдб рдФрд░ рдлреАрдЪрд░реНрд╕ (рдЬреИрд╕реЗ Expiry, Tables, EMI) рдЕрдкрдиреЗ рдЖрдк рд╕реЗрдЯ рд╣реЛ рдЬрд╛рдПрдВрдЧреЗред
                            </div>
                        </div>
  
                        <div id="register-message" class="text-danger small mb-3">&nbsp;</div>
                        <button type="submit" class="btn btn-success w-100" id="register-submit-btn">рдЕрдХрд╛рдЙрдВрдЯ рдмрдирд╛рдПрдВ</button>
                    </form>
                </div>
            </div>
            </div>

    </div>

</div>



    <div class="modal fade" id="licenseModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="licenseModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="licenseModalLabel">Dukan Pro - License Verification</h5>
                </div>
                <form id="license-form">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="license-key-input" class="form-label fw-bold">рд▓рд╛рдЗрд╕реЗрдВрд╕ рдХреА (License Key)</label>
                            <input type="text" class="form-control" id="license-key-input" required autocomplete="off" placeholder="XXXX-XXXX-XXXX-XXXX">
                        </div>
                        <div id="license-message" class="text-danger small mt-2 mb-3">&nbsp;</div>
                    
                        <div class="alert alert-success text-center p-3">
                            <h6 class="alert-heading fw-bold mb-2">
                                <i class="fas fa-headset"></i> рдирдпрд╛ рд▓рд╛рдЗрд╕реЗрдВрд╕ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
                            </h6>
                            
                            <button type="button" class="btn btn-success w-100 fw-bold py-2 shadow-sm" onclick="requestLicenseKey()">
                                <i class="fab fa-whatsapp fa-lg me-2"></i> рд▓рд╛рдЗрд╕реЗрдВрд╕ рдХреЗ рд▓рд┐рдП рдореИрд╕реЗрдЬ рднреЗрдЬреЗрдВ
                            </button>
                            
                            <small class="text-muted mt-2 d-block">
                                (рдЖрдкрдХреА Shop ID рдЕрдкрдиреЗ рдЖрдк рдПрдбрдорд┐рди рдХреЛ рднреЗрдЬ рджреА рдЬрд╛рдПрдЧреА)
                            </small>
                        </div>
                    
                        <hr>
                        
                        <div class="accordion" id="plansAccordion">
                            
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBasic">
                                        <strong>рдмреЗрд╕рд┐рдХ рдкреНрд▓рд╛рди - тВ╣1000/рдорд╛рд╣</strong> (AMC: тВ╣3000/рд╕рд╛рд▓)
                                    </button>
                                </h2>
                                <div id="collapseBasic" class="accordion-collapse collapse" data-bs-parent="#plansAccordion">
                                    <div class="accordion-body">
                                        рд╕реНрдЯреЙрдХ рдореИрдиреЗрдЬрдореЗрдВрдЯ, рдмреЗрд╕рд┐рдХ POS, рдЗрдирд╡реЙрдЗрд╕рд┐рдВрдЧ, рдЦрд░реАрдж, рдЦрд░реНрдЪ, рдмреЗрд╕рд┐рдХ рд░рд┐рдкреЛрд░реНрдЯреНрд╕, рдФрд░ GST рд░рд┐рдкреЛрд░реНрдЯреНрд╕ред
                                    </div>
                                </div>
                            </div>
                    
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMedium">
                                        <strong>рдореАрдбрд┐рдпрдо рдкреНрд▓рд╛рди - тВ╣3000/рдорд╛рд╣</strong> (AMC: тВ╣5000/рд╕рд╛рд▓)
                                    </button>
                                </h2>
                                <div id="collapseMedium" class="accordion-collapse collapse" data-bs-parent="#plansAccordion">
                                    <div class="accordion-body">
                                        <strong>рдмреЗрд╕рд┐рдХ рдкреНрд▓рд╛рди рдХреЗ рд╕рднреА рдлреАрдЪрд░реНрд╕ +</strong><br>
                                        CRM (рдЧреНрд░рд╛рд╣рдХ рдкреНрд░рдмрдВрдзрди), рдмреИрдВрдХ рд░рд┐рдХреЙрдиреНрд╕рд┐рд▓рд┐рдПрд╢рди, рд╡рд┐рд╕реНрддреГрдд P&L рд░рд┐рдкреЛрд░реНрдЯрд┐рдВрдЧ, рдФрд░ рд╕реНрдЯрд╛рдл рдкреНрд░рдмрдВрдзрдиред
                                    </div>
                                </div>
                            </div>
                    
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePremium">
                                        <strong>рдкреНрд░реАрдорд┐рдпрдо рдкреНрд▓рд╛рди - тВ╣7500/рдорд╛ah</strong> (AMC: тВ╣8000/рд╕рд╛рд▓)
                                    </button>
                                </h2>
                                <div id="collapsePremium" class="accordion-collapse collapse" data-bs-parent="#plansAccordion">
                                    <div class="accordion-body">
                                        <strong>рдореАрдбрд┐рдпрдо рдкреНрд▓рд╛рди рдХреЗ рд╕рднреА рдлреАрдЪрд░реНрд╕ +</strong><br>
                                        рдПрдбрд╡рд╛рдВрд╕реНрдб рд░рд┐рдкреЛрд░реНрдЯрд┐рдВрдЧ, рдорд▓реНрдЯреА-рд▓реЛрдХреЗрд╢рди рд╕рдкреЛрд░реНрдЯ, рдФрд░ рд░рд┐рдпрд▓-рдЯрд╛рдЗрдо рдбреИрд╢рдмреЛрд░реНрдбред
                                    </div>
                                </div>
                            </div>
                    
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOneTime">
                                        <strong>рд╡рди-рдЯрд╛рдЗрдо рдкреНрд▓рд╛рди - тВ╣40,000</strong> (AMC: тВ╣15,000/рд╕рд╛рд▓)
                                    </button>
                                </h2>
                                <div id="collapseOneTime" class="accordion-collapse collapse" data-bs-parent="#plansAccordion">
                                    <div class="accordion-body">
                                        рдкреНрд░реАрдорд┐рдпрдо рдкреНрд▓рд╛рди рдХреЗ рд╕рднреА рдлреАрдЪрд░реНрд╕, рдПрдХ рдмрд╛рд░ рдХреА рдХреАрдордд рдкрд░ред (AMC рдЕрдирд┐рд╡рд╛рд░реНрдп рд╣реИ)ред
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p class="text-muted small mt-3">*5 рджрд┐рди рдХреЗ рдЯреНрд░рд╛рдпрд▓ рдореЗрдВ рд╕рднреА рдлреАрдЪрд░реНрд╕ рдХрд╛ рдПрдХреНрд╕реЗрд╕ рдорд┐рд▓рддрд╛ рд╣реИред</p>
                    </div>                   <div class="modal-footer">
                         <button type="button" class="btn btn-outline-secondary d-none" id="open-admin-login-from-license-btn">рдПрдбрдорд┐рди рд▓реЙрдЧрд┐рди</button>
                         <button type="submit" class="btn btn-primary" id="license-submit-btn">рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="renewalModal" tabindex="-1" aria-labelledby="renewalModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-warning border-3">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="renewalModalLabel"><i class="fas fa-exclamation-triangle"></i> рд▓рд╛рдЗрд╕реЗрдВрд╕ рд░рд┐рдиреНрдпреВрдЕрд▓ рдЪреЗрддрд╛рд╡рдиреА</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="fs-5">рдЖрдкрдХреА Dukan Pro рд▓рд╛рдЗрд╕реЗрдВрд╕ рдХреА рдЬрд▓реНрдж рд╣реА рд╕рдорд╛рдкреНрдд рд╣реЛрдиреЗ рд╡рд╛рд▓реА рд╣реИ!</p>
                    <p>рдЕрд╕реБрд╡рд┐рдзрд╛ рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП, рдХреГрдкрдпрд╛ рд╕рдордп рдкрд░ рд░рд┐рдиреНрдпреВрдЕрд▓ рдХрд░рд╛рдПрдБред</p>
                    <p class="fw-bold">рд░рд┐рдиреНрдпреВрдЕрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП 7303410987 рдкрд░ WhatsApp рдХрд░реЗрдВред</p>
                    <hr>
                    <p class="mb-2 fw-bold">рдЖрдк рдХрд┐рддрдиреЗ рд╕рдордп рдХреЗ рд▓рд┐рдП рд░рд┐рдиреНрдпреВрдЕрд▓ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?</p>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success" onclick="sendWhatsAppRenewal(1)">
                            <i class="fab fa-whatsapp"></i> 1 рдорд╣реАрдиреЗ рдХреЗ рд▓рд┐рдП рдкреВрдЫреЗрдВ
                        </button>
                        <button type="button" class="btn btn-success" onclick="sendWhatsAppRenewal(6)">
                            <i class="fab fa-whatsapp"></i> 6 рдорд╣реАрдиреЗ рдХреЗ рд▓рд┐рдП рдкреВрдЫреЗрдВ
                        </button>
                        <button type="button" class="btn btn-success" onclick="sendWhatsAppRenewal(12)">
                            <i class="fab fa-whatsapp"></i> 12 рдорд╣реАрдиреЗ (1 рд╕рд╛рд▓) рдХреЗ рд▓рд┐рдП рдкреВрдЫреЗрдВ
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">рдмрд╛рдж рдореЗрдВ</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="planLockModal" tabindex="-1" aria-labelledby="planLockModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-primary border-3">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="planLockModalLabel"><i class="fas fa-lock"></i> рдпрд╣ рдлреАрдЪрд░ рдЖрдкрдХреЗ рдкреНрд▓рд╛рди рдореЗрдВ рд╢рд╛рдорд┐рд▓ рдирд╣реАрдВ рд╣реИ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="fs-5">рдпрд╣ рдПрдХ <strong id="plan-lock-feature-name">рдПрдбрд╡рд╛рдВрд╕реНрдб</strong> рдлреАрдЪрд░ рд╣реИ рдЬреЛ <strong id="plan-lock-plan-name">рдмреЗрд╕рд┐рдХ</strong> рдкреНрд▓рд╛рди рдореЗрдВ рдЙрдкрд▓рдмреНрдз рдирд╣реАрдВ рд╣реИред</p>
                    <p>рдЗрд╕ рдлреАрдЪрд░ рдХреЛ рдЕрдирд▓реЙрдХ рдХрд░рдиреЗ рдФрд░ рдЕрдкрдиреЗ рдмрд┐реЫрдиреЗрд╕ рдХреЛ рддреЗрдЬреА рд╕реЗ рдмреЭрд╛рдиреЗ рдХреЗ рд▓рд┐рдП, рдХреГрдкрдпрд╛ рдЕрдкрдирд╛ рдкреНрд▓рд╛рди рдЕрдкрдЧреНрд░реЗрдб рдХрд░реЗрдВред</p>
                    
                    <div class="alert alert-success text-center mt-4">
                        <h5 class="alert-heading mb-0">рдЕрдкрдЧреНрд░реЗрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдВрдкрд░реНрдХ рдХрд░реЗрдВ</h5>
                        <p class="mb-0 fs-4 fw-bold"><i class="fab fa-whatsapp"></i> 7303410987</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">рдмрд╛рдж рдореЗрдВ</button>
                    <a href="https://wa.me/7303410987?text=Hi%2C%20I%20want%20to%20upgrade%20my%20Dukan%20Pro%20plan." target="_blank" class="btn btn-success">
                        <i class="fab fa-whatsapp"></i> рдЕрднреА рдЕрдкрдЧреНрд░реЗрдб рдХрд░реЗрдВ
                    </a>
                </div>
            </div>
        </div>
    </div>




    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="ms-3 text-primary" id="loading-message">рдбреЗрдЯрд╛ рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...</div>
    </div>

    <button class="navbar-toggler locked" type="button" id="menu-toggle">
        <span class="navbar-toggler-icon"></span>
    </button>
    <nav id="sidebar" class="sidebar locked">
        <div class="p-4 d-flex flex-column h-100">
            <div class="text-center mb-3" id="shop-logo-container">
                </div>
            <h3 class="mb-4 text-white text-shadow text-center"><i class="fas fa-store me-2"></i>Dukan Pro</h3>
            
            <ul class="nav flex-column mb-auto" id="sidebar-nav">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-view="dashboard" data-role="ANY"> <i class="fas fa-home"></i> рдбреИрд╢рдмреЛрд░реНрдб
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="stock" data-role="MANAGER"> <i class="fas fa-boxes"></i> рд╕реНрдЯреЙрдХ рдкреНрд░рдмрдВрдзрди
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="sales" data-role="ANY"> <i class="fas fa-cash-register"></i> рдмрд┐рдХреНрд░реА (POS)
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="invoice-generator" data-role="ANY"> <i class="fas fa-file-invoice"></i> рдЗрдирд╡реЙрдЗрд╕ рдЬрдирд░реЗрдЯрд░ Pro
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="purchases" data-role="MANAGER"> <i class="fas fa-shopping-basket"></i> рдЦрд░реАрдж
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="crm" data-role="MANAGER"> <i class="fas fa-users"></i> рдЧреНрд░рд╛рд╣рдХ (CRM)
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="expenses" data-role="MANAGER"> <i class="fas fa-money-bill-wave"></i> рдЦрд░реНрдЪ
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="reports" data-role="MANAGER"> <i class="fas fa-chart-line"></i> рд░рд┐рдкреЛрд░реНрдЯреНрд╕
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="gst-reports" data-role="MANAGER"> <i class="fas fa-file-alt"></i> GST рд░рд┐рдкреЛрд░реНрдЯреНрд╕
                    </a>
                </li>
                <a href="#" class="list-group-item list-group-item-action bg-transparent text-danger fw-bold" onclick="renderView('daily_reports')"> <i class="fas fa-calendar-check me-2"></i> Daily Reports
                </a>

                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="bank-reconciliation" data-role="MANAGER"> <i class="fas fa-university"></i> рдмреИрдВрдХ рд░рд┐рдХреЙрдиреНрд╕рд┐рд▓реЗрд╢рди
                    </a>
                </li>


                <ul class="nav nav-tabs" id="main-nav-tabs">
                    <li class="nav-item" data-role="MANAGER">
                        <a class="nav-link" href="#" data-view="ai-insights">
                            <i class="fas fa-brain me-1"></i> AI рд╕рд▓рд╛рд╣
                        </a>
                    </li>
                              
               <li class="nav-item">
                    <a href="#" class="nav-link" data-view="daily-closing" data-role="MANAGER"> <i class="fas fa-calendar-check"></i> рдбреЗрд▓реА рдХреНрд▓реЛрдЬрд┐рдВрдЧ
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="data-backup" data-role="ADMIN"> <i class="fas fa-download"></i> рдбреЗрдЯрд╛ рдмреИрдХрдЕрдк
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link d-none" data-view="staff" data-role="ADMIN"> <i class="fas fa-user-cog"></i> рд╕реНрдЯрд╛рдл рдкреНрд░рдмрдВрдзрди
                    </a>
                </li>
                 <li class="nav-item">
                    <a href="#" class="nav-link" data-view="shop-settings" data-role="ADMIN"> <i class="fas fa-cogs"></i> рд╢реЙрдк рд╕реЗрдЯрд┐рдВрдЧреНрд╕
                    </a>
                </li>
            </ul>
            
            <hr class="text-white-50">
            
            <div id="user-info" class="text-white-50 p-2 text-center mb-2" style="background-color: #495057; border-radius: 8px;">
                <h5 id="user-shop-name" class="text-white mb-0">Shop Name</h5>
                <small id="user-name-email">User Name (Role)</small>
            </div>

            <div id="license-timer" class="text-center text-white-50 mb-2">
                <i class="fas fa-check-circle text-success"></i> рд▓рд╛рдЗрд╕реЗрдВрд╕ рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...
            </div>
            
            <li class="nav-item ms-2">
                <button class="btn btn-danger fw-bold" data-bs-toggle="modal" data-bs-target="#securityModal" style="border-radius: 20px;">
                    <i class="fas fa-user-shield"></i> Guard Check
                </button>
            </li>

            <button id="logout-btn" class="btn btn-sm btn-danger w-100"><i class="fas fa-sign-out-alt me-2"></i>рд▓реЙрдЧрдЖрдЙрдЯ</button>
            
            <p class="text-muted mt-2 mb-0 text-center small">v1.0.3 Corrected</p>
        </div>
    </nav>

    

    <div id="main-content" class="main-content locked">
        <section id="dashboard" class="section">
            <h2 class="mb-4 text-primary">рдбреИрд╢рдмреЛрд░реНрдб</h2>
            <div class="row g-4">
                <div class="col-md-6 col-lg-3">
                    <div class="card p-3 dashboard-card bg-white">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-rupee-sign fa-2x text-primary me-3"></i>
                            <div>
                                <p class="text-muted mb-0">рдХреБрд▓ рдмрд┐рдХреНрд░реА (рд░реЗрд╡реЗрдиреНрдпреВ)</p>
                                <h4 class="mb-0" id="total-sales-revenue">тВ╣0.00</h4>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="card p-3 dashboard-card bg-white">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-boxes fa-2x text-warning me-3"></i>
                            <div>
                                <p class="text-muted mb-0">рд╕реНрдЯреЙрдХ рдореВрд▓реНрдп (рдЦрд░реАрдж)</p>
                                <h4 class="mb-0" id="total-stock-value">тВ╣0.00</h4>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="card p-3 dashboard-card bg-white">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-users fa-2x text-success me-3"></i>
                            <div>
                                <p class="text-muted mb-0">рдХреБрд▓ рдЧреНрд░рд╛рд╣рдХ</p>
                                <h4 class="mb-0" id="total-customers">0</h4>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="card p-3 dashboard-card bg-white">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle fa-2x text-danger me-3"></i>
                            <div>
                                <p class="text-muted mb-0">рдХрдо рд╕реНрдЯреЙрдХ рд╡рд╛рд▓реЗ рдЖрдЗрдЯрдо</p>
                                <h4 class="mb-0" id="low-stock-count">0</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4 g-4">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header bg-gradient-primary">рдкрд┐рдЫрд▓реЗ 30 рджрд┐рдиреЛрдВ рдХреА рдмрд┐рдХреНрд░реА</div>
                        <div class="card-body">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header bg-warning text-dark">рдХрдо рд╕реНрдЯреЙрдХ рдЪреЗрддрд╛рд╡рдиреА</div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm table-striped mb-0">
                                    <thead>
                                        <tr>
                                            <th>SKU</th>
                                            <th>рдЖрдЗрдЯрдо</th>
                                            <th>Qty</th>
                                        </tr>
                                    </thead>
                                    <tbody id="low-stock-table-body">
                                        <tr><td colspan="3" class="text-center text-muted">рдХреЛрдИ рдХрдо рд╕реНрдЯреЙрдХ рдЖрдЗрдЯрдо рдирд╣реАрдВ</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4 g-4">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header bg-success">рд╣рд╛рд▓ рдХреА рдмрд┐рдХреНрд░реА</div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-striped mb-0">
                                    <thead>
                                        <tr>
                                            <th>рдЪрд╛рд▓рд╛рди рдирдВ.</th>
                                            <th>рдЧреНрд░рд╛рд╣рдХ</th>
                                            <th>рд░рд╛рд╢рд┐</th>
                                            <th>рддрд┐рдерд┐</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-sales-table-body">
                                        <tr><td colspan="4" class="text-center text-muted">рдХреЛрдИ рдмрд┐рдХреНрд░реА рдирд╣реАрдВ</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header bg-info">рд╣рд╛рд▓ рдХреЗ рдЧреНрд░рд╛рд╣рдХ</div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-striped mb-0">
                                    <thead>
                                        <tr>
                                            <th>рдирд╛рдо</th>
                                            <th>рдлрд╝реЛрди</th>
                                            <th>рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-customers-table-body">
                                        <tr><td colspan="3" class="text-center text-muted">рдХреЛрдИ рдЧреНрд░рд╛рд╣рдХ рдирд╣реАрдВ</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


           <!-- SALON DASHBOARD тАФ paste inside the main content (maybe near ai-insights or dashboard) -->
           <div id="salon-dashboard" class="salon-only biz-only" style="display:none;">
    
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="text-primary mb-0"><i class="fas fa-scissors me-2"></i>Salon Dashboard (Pro)</h2>
                
                <button class="btn btn-primary shadow" onclick="openAppointmentModal()">
                    <i class="fas fa-plus-circle me-2"></i> рдирдИ рдмреБрдХрд┐рдВрдЧ (New Appointment)
                </button>
            </div>
        
            <div class="row g-4 mb-4">
                <div class="col-md-6 col-lg-3">
                    <div class="card p-3 dashboard-card bg-white h-100 border-0 shadow-sm">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle p-3 bg-light me-3">
                                <i class="fas fa-rupee-sign fa-2x text-success"></i>
                            </div>
                            <div>
                                <p class="text-muted mb-0 small text-uppercase fw-bold">рдЖрдЬ рдХреА рдХрдорд╛рдИ</p>
                                <h4 class="mb-0 fw-bold text-dark" id="salon-today-sales">тВ╣0</h4>
                            </div>
                        </div>
                    </div>
                </div>
        
                <div class="col-md-6 col-lg-3">
                    <div class="card p-3 dashboard-card bg-white h-100 border-0 shadow-sm">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle p-3 bg-light me-3">
                                <i class="fas fa-calendar-check fa-2x text-primary"></i>
                            </div>
                            <div>
                                <p class="text-muted mb-0 small text-uppercase fw-bold">рдЖрдЬ рдХреЗ рдЧреНрд░рд╛рд╣рдХ</p>
                                <h4 class="mb-0 fw-bold text-dark" id="salon-today-appts">0</h4>
                            </div>
                        </div>
                    </div>
                </div>
        
                <div class="col-md-6 col-lg-3">
                    <div class="card p-3 dashboard-card bg-white h-100 border-0 shadow-sm">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle p-3 bg-light me-3">
                                <i class="fas fa-birthday-cake fa-2x text-warning"></i>
                            </div>
                            <div>
                                <p class="text-muted mb-0 small text-uppercase fw-bold">рдмрд░реНрдердбреЗ (7 рджрд┐рди)</p>
                                <h4 class="mb-0 fw-bold text-dark" id="salon-birthdays-count">0</h4>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-link text-decoration-none mt-2 ps-0" onclick="openBirthdayList()">
                            рд▓рд┐рд╕реНрдЯ рджреЗрдЦреЗрдВ <i class="fas fa-arrow-right ms-1"></i>
                        </button>
                    </div>
                </div>
        
                <div class="col-md-6 col-lg-3">
                    <div class="card p-3 dashboard-card bg-white h-100 border-0 shadow-sm">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle p-3 bg-light me-3">
                                <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                            </div>
                            <div>
                                <p class="text-muted mb-0 small text-uppercase fw-bold">Low Stock</p>
                                <h4 class="mb-0 fw-bold text-dark" id="salon-low-stock">0</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        
            <div class="row g-4">
                
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-gradient-primary text-white border-bottom py-3">
                            <h5 class="mb-0 fw-bold"><i class="fas fa-chart-line me-2"></i>рдкрд┐рдЫрд▓реЗ 30 рджрд┐рдиреЛрдВ рдХреА рдХрдорд╛рдИ</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="salonSalesChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>
                </div>
        
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-white border-bottom py-3">
                            <h5 class="mb-0 fw-bold"><i class="fas fa-users me-2"></i>рд╣рд╛рд▓ рдХреЗ рдЧреНрд░рд╛рд╣рдХ</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 340px; overflow-y: auto;">
                                <table class="table table-hover mb-0 align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>рдирд╛рдо</th>
                                            <th>рдореЛрдмрд╛рдЗрд▓</th>
                                            <th>рдПрдХреНрд╢рди</th>
                                        </tr>
                                    </thead>
                                    <tbody id="salon-recent-customers-body">
                                        <tr><td colspan="3" class="text-center text-muted p-3">рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div id="universal-modules-container" class="mb-4">

            <div id="module-optical-eye-test" class="biz-module card shadow-sm border-dark mb-4" style="display:none;">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-glasses me-2"></i>Eye Prescription (рдирдВрдмрд░)</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered text-center align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Eye</th>
                                    <th>SPH (Spherical)</th>
                                    <th>CYL (Cylindrical)</th>
                                    <th>AXIS</th>
                                    <th>ADD (Near)</th>
                                    <th>VA (Vision)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="fw-bold text-primary">Right (OD)</td>
                                    <td><input type="text" class="form-control form-control-sm text-center" placeholder="+/-"></td>
                                    <td><input type="text" class="form-control form-control-sm text-center" placeholder="+/-"></td>
                                    <td><input type="number" class="form-control form-control-sm text-center" placeholder="Deg"></td>
                                    <td><input type="text" class="form-control form-control-sm text-center" placeholder="Near"></td>
                                    <td><input type="text" class="form-control form-control-sm text-center" placeholder="6/6"></td>
                                </tr>
                                <tr>
                                    <td class="fw-bold text-primary">Left (OS)</td>
                                    <td><input type="text" class="form-control form-control-sm text-center" placeholder="+/-"></td>
                                    <td><input type="text" class="form-control form-control-sm text-center" placeholder="+/-"></td>
                                    <td><input type="number" class="form-control form-control-sm text-center" placeholder="Deg"></td>
                                    <td><input type="text" class="form-control form-control-sm text-center" placeholder="Near"></td>
                                    <td><input type="text" class="form-control form-control-sm text-center" placeholder="6/6"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="row g-2 mt-2">
                        <div class="col-md-6">
                            <label class="small fw-bold">Lens Type</label>
                            <select class="form-select form-select-sm">
                                <option>Single Vision</option>
                                <option>Bifocal (Kryptok/D)</option>
                                <option>Progressive</option>
                                <option>Blue Cut / Anti-Glare</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="small fw-bold">PD (Pupillary Distance)</label>
                            <input type="text" class="form-control form-control-sm" placeholder="e.g. 62mm">
                        </div>
                    </div>
                </div>
            </div>
        
            <div id="module-prescription-pad" class="biz-module card shadow-sm border-primary mb-4" style="display:none;">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-user-md me-2"></i><span id="medical-title-text">Medical Report</span></h5>
                    <div id="pregnancy-badge" style="display:none;">
                        <span class="badge bg-warning text-dark">EDD: <span id="disp_edd">--</span></span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-2 mb-3">
                        <div class="col-md-4">
                            <label class="small fw-bold">Patient ID/Name</label>
                            <div class="input-group input-group-sm">
                                <input type="text" id="medical_patient_search" class="form-control" placeholder="Search...">
                                <button class="btn btn-outline-secondary"><i class="fas fa-search"></i></button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="small fw-bold">Ref. Doctor</label>
                            <input type="text" id="med_ref_doc" class="form-control form-control-sm" placeholder="Dr. Name">
                        </div>
                        <div class="col-md-4" id="box-lmp-calc" style="display:none;">
                            <label class="small fw-bold text-danger">LMP Date</label>
                            <div class="input-group input-group-sm">
                                <input type="date" id="med_lmp_date" class="form-control">
                                <button class="btn btn-danger" onclick="calculateEDD()">Calc</button>
                            </div>
                        </div>
                    </div>
        
                    <div class="mb-2">
                        <label class="small fw-bold">Templates:</label>
                        <div id="medical-template-buttons" class="d-flex flex-wrap gap-2"></div>
                    </div>
        
                    <textarea id="medical_report_editor" class="form-control p-3" rows="8" 
                        style="font-family: monospace; font-size: 14px; border: 2px solid #ccc; background:#f9f9f9;"
                        placeholder="Report content goes here..."></textarea>
                    
                    <div id="box-dentist-chart" class="mt-3 border p-2 bg-light rounded" style="display:none;">
                        <small class="fw-bold d-block mb-1">Select Teeth for Procedure:</small>
                        <div id="teeth-container" class="d-flex flex-wrap justify-content-center gap-1"></div>
                    </div>
        
                    <div class="text-end mt-2">
                        <button class="btn btn-success btn-sm" onclick="saveMedicalReport()"><i class="fas fa-print"></i> Save & Print</button>
                    </div>
                </div>
            </div>
        
            <div id="module-imei-scan" class="biz-module card shadow-sm border-secondary mb-4" style="display:none;">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-mobile-alt me-2"></i>Mobile Operations</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="small fw-bold">New Sale (Scan IMEI)</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-barcode"></i></span>
                                <input type="text" id="item_imei" class="form-control" placeholder="Scan Box IMEI...">
                                <button class="btn btn-dark">Add to Bill</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="small fw-bold">Service Center</label>
                            <button class="btn btn-outline-dark w-100"><i class="fas fa-tools"></i> Create Job Card</button>
                        </div>
                    </div>
                </div>
            </div>
        
            <div id="module-furniture-showroom" class="biz-module card shadow-sm border-warning mb-4" style="display:none;">
                <div class="card-header bg-warning text-dark">
                    <h5><i class="fas fa-truck"></i> Delivery Tracker (рд╢реЗрдбреНрдпреВрд▓ рдХрд░реЗрдВ)</h5>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-6">
                            <input type="text" id="furn_invoice_id" class="form-control form-control-sm" placeholder="Invoice ID (e.g. 64)">
                        </div>
                        <div class="col-6">
                            <input type="date" id="furn_delivery_date" class="form-control form-control-sm">
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="furn_assembly">
                                <label class="form-check-label small">Assembly Required (рдорд┐рд╕реНрддреНрд░реА рдЪрд╛рд╣рд┐рдП?)</label>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-warning w-100 mt-2" onclick="scheduleFurnitureDelivery()">
                        <i class="fas fa-save"></i> Schedule Delivery
                    </button>
                </div>
            </div>

            <div id="hardware-delivery-box" class="biz-module mt-3 border-top pt-2" style="display:none;">
                <h6 class="text-dark small fw-bold">
                    <i class="fas fa-truck-loading"></i> Pending Deliveries (рдбрд┐рд▓реАрд╡рд░реА рд▓рд┐рд╕реНрдЯ)
                    <button class="btn btn-sm btn-link float-end p-0" onclick="loadDeliveryList()">Refresh</button>
                </h6>
                
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd;">
                    <table class="table table-sm table-bordered small mb-0 bg-white">
                        <thead class="table-secondary sticky-top">
                            <tr>
                                <th>Invoice / Item</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th style="width: 50px;">Action</th> </tr>
                            </tr>
                        </thead>
                        <tbody id="delivery-list-final">
                            <tr><td colspan="3" class="text-center text-muted">рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="module-hotel-management" class="biz-module card shadow-sm border-danger mb-4" style="display:none;">
                <div class="card-header bg-danger text-white"><h5><i class="fas fa-hotel"></i> Hotel Front Desk</h5></div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label class="small fw-bold">Room No</label>
                            <input type="text" id="hotel_room_select" class="form-control form-control-sm" placeholder="e.g. 101">
                        </div>
                        <div class="col-md-4">
                            <label class="small fw-bold">Guest Name</label>
                            <input type="text" id="hotel_guest_name" class="form-control form-control-sm">
                        </div>
                        <div class="col-md-4">
                            <label class="small fw-bold">Mobile</label>
                            <input type="number" id="hotel_guest_mobile" class="form-control form-control-sm">
                        </div>
                        <div class="col-md-6">
                            <label class="small fw-bold">Check-In Date</label>
                            <input type="date" id="hotel_checkin_date" class="form-control form-control-sm">
                        </div>
                        <div class="col-md-6">
                            <label class="small fw-bold">Advance Payment (тВ╣)</label>
                            <input type="number" id="hotel_advance" class="form-control form-control-sm">
                        </div>
                    </div>
                    <button class="btn btn-danger w-100 mt-3" onclick="processHotelCheckIn()">
                        <i class="fas fa-key"></i> Check-In Guest
                    </button>
                </div>
            </div>

            <div id="hotel-room-status-section" class="biz-module mt-4" style="display:none;">
    
                <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
                    <h6 class="fw-bold text-secondary mb-0">
                        <i class="fas fa-bed"></i> Room Status (Live)
                    </h6>
                    <div>
                        <button class="btn btn-sm btn-outline-dark me-2" onclick="setupHotelRooms()" title="Create 10 dummy rooms">
                            <i class="fas fa-magic"></i> Auto Setup
                        </button>
                        
                        <button class="btn btn-sm btn-primary shadow-sm" onclick="addRoomManually()" title="Add a specific room">
                            <i class="fas fa-plus-circle"></i> Add Room
                        </button>
                    </div>
                </div>
            
                <div id="hotel-room-list" class="row g-3" style="max-height: 450px; overflow-y: auto; padding: 4px;">
                    
                    <div class="col-12 text-center text-muted mt-5">
                        <div class="spinner-border text-secondary" role="status"></div>
                        <p class="mt-2 small">Loading Room Status...</p>
                    </div>
            
                </div>
            </div>

           
            <div id="module-paint-mixer" class="biz-module card shadow-sm border-primary mb-4" style="display:none;">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-fill-drip me-2"></i> Paint Color Mixer (Diary)</h5>
                    <span class="badge bg-white text-primary">Live</span>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-12">
                            <input type="text" id="paint_cust_name" class="form-control form-control-sm" placeholder="Customer Name (рдЧреНрд░рд╛рд╣рдХ рдХрд╛ рдирд╛рдо)">
                        </div>
            
                        <div class="col-6">
                            <input type="text" id="paint_code" class="form-control form-control-sm" placeholder="Color Code (e.g. 9012)">
                        </div>
            
                        <div class="col-6">
                            <input type="text" id="paint_base" class="form-control form-control-sm" placeholder="Base Product (e.g. Apex)">
                        </div>
            
                        <div class="col-12">
                            <label class="small fw-bold text-muted">Formula / Notes:</label>
                            <textarea id="paint_formula" class="form-control form-control-sm" rows="2" placeholder='Example: Red-20ml, Yellow-5ml (Machine 2)'></textarea>
                        </div>
                    </div>
            
                    <button class="btn btn-primary w-100 mt-3" onclick="savePaintFormula()">
                        <i class="fas fa-save me-1"></i> Save Formula
                    </button>
                    
                    <div class="mt-4">
                        <h6 class="text-secondary border-bottom pb-2 mb-2" style="font-size: 0.9rem; font-weight: 600;">
                            <i class="fas fa-history me-1"></i> рд╣рд╛рд▓ рд╣реА рдореЗрдВ рдорд┐рдХреНрд╕ рдХрд┐рдП рдЧрдП (Recent Mixes)
                        </h6>
                        
                        <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                            <table class="table table-sm table-bordered table-striped mb-0" style="font-size: 0.8rem;">
                                <thead class="table-light">
                                    <tr>
                                        <th>рддрд╛рд░реАрдЦ</th>
                                        <th>рдЧреНрд░рд╛рд╣рдХ</th>
                                        <th>рд╢реЗрдб / рдмреЗрд╕</th>
                                        <th>рдлрд╛рд░реНрдореВрд▓рд╛</th>
                                    </tr>
                                </thead>
                                <tbody id="paint-history-body">
                                    <tr><td colspan="4" class="text-center text-muted">рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    </div>
            </div>
            
            <div id="module-repair-job" class="biz-module card shadow-sm border-dark mb-4" style="display:none;">
                <div class="card-header bg-dark text-white"><h5><i class="fas fa-tools"></i> Repair Job Card</h5></div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-6"><input type="text" id="repair_customer" class="form-control form-control-sm" placeholder="Customer Name"></div>
                        <div class="col-6"><input type="text" id="repair_mobile" class="form-control form-control-sm" placeholder="Mobile"></div>
                        <div class="col-6">
                            <input type="text" id="repair_invoice_id" class="form-control form-control-sm" placeholder="Original Bill No (Optional)">
                        </div>
                        <div class="col-6"><input type="text" id="repair_device" class="form-control form-control-sm" placeholder="Device Model"></div>
                        <div class="col-6"><input type="text" id="repair_imei" class="form-control form-control-sm" placeholder="IMEI / Serial"></div>
                        <div class="col-12"><textarea id="repair_issue" class="form-control form-control-sm" placeholder="Problem Description"></textarea></div>
                        <div class="col-6"><input type="number" id="repair_cost" class="form-control form-control-sm" placeholder="Est. Cost"></div>
                        <div class="col-6"><input type="number" id="repair_advance" class="form-control form-control-sm" placeholder="Advance"></div>
                    </div>
                    <button class="btn btn-warning w-100 mt-2" onclick="createRepairJob()">Generate Job Card</button>
                </div>
            </div>
        
            <div id="module-restaurant-kot" class="biz-module card shadow-sm border-warning mb-4" style="display:none;">

                <button class="btn btn-dark btn-sm w-100 mb-3" onclick="enableKitchenMode()">
                    <i class="fas fa-tv"></i> Switch to Kitchen Display Screen
                </button>
    
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold"><i class="fas fa-utensils me-2"></i> KOT Manager</h5>
                </div>
                
                <div class="card-body">
                    
                    <div class="mb-4 p-3 bg-light border rounded shadow-sm">
                        <label class="fw-bold text-dark mb-2 d-block">
                            <i class="fas fa-bullseye text-primary"></i> Order For (рдСрд░реНрдбрд░ рдХрд┐рд╕рдХреЗ рд▓рд┐рдП рд╣реИ?):
                        </label>
                        
                        <div class="d-flex gap-4 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="orderType" id="type_table" value="table" checked onchange="toggleOrderSource()" style="cursor: pointer; transform: scale(1.3);">
                                <label class="form-check-label fw-bold text-dark ms-2" for="type_table" style="cursor: pointer; font-size: 1.1rem;">
                                    ЁЯН╜я╕П Table (Restaurant)
                                </label>
                            </div>
                            
                            <div class="form-check ms-2 border-start border-secondary ps-4">
                                <input class="form-check-input" type="radio" name="orderType" id="type_room" value="room" onchange="toggleOrderSource()" style="cursor: pointer; transform: scale(1.3);">
                                <label class="form-check-label fw-bold text-danger ms-2" for="type_room" style="cursor: pointer; font-size: 1.1rem;">
                                    ЁЯЫОя╕П Room Service
                                </label>
                            </div>
                        </div>

                        <div class="mb-2">
                            <label class="small fw-bold text-muted">Order Taken By (рд╡реЗрдЯрд░):</label>
                            <select id="waiter_select" class="form-select form-select-sm fw-bold">
                                <option value="Self">-- Select Name --</option>
                                <option value="Ramesh">Ramesh</option>
                                <option value="Suresh">Suresh</option>
                                <option value="Mahesh">Mahesh</option>
                                <option value="Raju">Raju</option>
                                <option value="Deepak">Deepak</option>
                                </select>
                        </div>
            
                        <label class="small text-muted fw-bold mb-1" id="order_hint">Select Location:</label>
                        <select id="rest_table_select" class="form-select form-select-lg border-primary fw-bold shadow-sm" style="height: 50px; font-size: 1.1rem;">
                            <option value="">-- Loading List... --</option>
                        </select>
                    </div>
                    <div class="position-relative mb-3">
                        <label class="small fw-bold text-muted">рдЖрдЗрдЯрдо рдЦреЛрдЬреЗрдВ (Search Item)</label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-white"><i class="fas fa-search text-primary"></i></span>
                            <input type="text" id="kot-search-input" class="form-control fw-bold" 
                                   placeholder="рдбрд┐рд╢ рдХрд╛ рдирд╛рдо рд▓рд┐рдЦреЗрдВ..." 
                                   autocomplete="off" 
                                   onclick="handleKotSearch(true)" 
                                   oninput="handleKotSearch(false)">
                        </div>
                        <ul id="kot-search-results" class="list-group position-absolute w-100 shadow start-0" 
                            style="z-index: 1050; max-height: 250px; overflow-y: auto; display:none; top: 100%;">
                        </ul>
                    </div>
                    
                    <div class="bg-white p-2 border rounded mb-3 shadow-sm" style="min-height: 100px;">
                        <h6 class="small fw-bold text-secondary border-bottom pb-1 mb-2">Selected Items (рдСрд░реНрдбрд░ рд▓рд┐рд╕реНрдЯ):</h6>
                        <div id="kot-added-list">
                            <div class="text-center text-muted small mt-3 p-3 bg-light rounded">
                                <i class="fas fa-basket-shopping fa-2x mb-2 text-secondary"></i><br>
                                рдЕрднреА рдХреЛрдИ рдЖрдЗрдЯрдо рдирд╣реАрдВ рдЪреБрдирд╛
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-success btn-lg w-100 fw-bold shadow" onclick="sendKotToKitchen()">
                        <i class="fas fa-paper-plane me-2"></i> Send to Kitchen
                    </button>
            
                    <div class="mt-4 pt-3 border-top border-2">
                        <h5 class="fw-bold text-dark mb-3">
                            <i class="fas fa-fire text-danger"></i> Active Orders (Running)
                        </h5>
                        <div id="active-kot-list" class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
                            <div class="text-center text-muted p-4 fs-5 bg-light rounded border">
                                No active orders
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary w-100 mt-3 fw-bold shadow-sm" onclick="transferTableToPOS()">
                        <i class="fas fa-file-invoice-dollar me-2"></i> Create Final Bill (POS)
                    </button>
                </div>
            </div>


            <div id="standalone-kitchen-view" class="mt-3 border-top pt-3" style="display:none;">
                <h5 class="fw-bold text-dark mb-3">
                    <i class="fas fa-fire text-danger"></i> Active Orders (Kitchen)
                </h5>
                
                <div id="active-kot-list-kitchen" class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center text-muted p-4 fs-5">No active orders</div>
                </div>
            </div>

            <div id="module-school-fees" class="biz-module card shadow-sm border-info mb-4" style="display:none;">
                <div class="card-header bg-info text-white"><h5><i class="fas fa-graduation-cap"></i> School Fee Counter</h5></div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-8">
                            <label class="small fw-bold">Student ID / Roll No</label>
                            <input type="text" id="school_student_id" class="form-control form-control-sm" placeholder="Enter ID">
                        </div>
                        <div class="col-4">
                            <label class="small fw-bold">Amount (тВ╣)</label>
                            <input type="number" id="school_fee_amount" class="form-control form-control-sm">
                        </div>
                        <div class="col-12">
                            <label class="small fw-bold">For Month</label>
                            <select id="school_fee_month" class="form-select form-select-sm">
                                <option value="JAN">January</option><option value="FEB">February</option>
                                <option value="MAR">March</option><option value="APR">April</option>
                                <option value="MAY">May</option><option value="JUN">June</option>
                                </select>
                        </div>
                    </div>
                    <button class="btn btn-info text-white w-100 mt-2" onclick="processSchoolFee()">
                        <i class="fas fa-receipt"></i> Collect Fee
                    </button>
                </div>
            </div>
        
            <div id="module-tailor-measurements" class="biz-module card shadow-sm border-secondary mb-4" style="display:none;">
                <div class="card-header bg-secondary text-white"><h5><i class="fas fa-cut"></i> Measurements</h5></div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-12"><input type="text" id="tailor_cust_id" class="form-control form-control-sm" placeholder="Customer ID"></div>
                        <div class="col-6"><select id="tailor_item_type" class="form-select form-select-sm"><option>Shirt</option><option>Pant</option><option>Suit</option></select></div>
                        <div class="col-6"><input type="date" id="tailor_delivery" class="form-control form-control-sm"></div>
                        
                        <div class="col-3"><input type="text" id="tm_length" class="form-control form-control-sm" placeholder="Len"></div>
                        <div class="col-3"><input type="text" id="tm_waist" class="form-control form-control-sm" placeholder="Waist"></div>
                        <div class="col-3"><input type="text" id="tm_chest" class="form-control form-control-sm" placeholder="Chest"></div>
                        <div class="col-3"><input type="text" id="tm_shoulder" class="form-control form-control-sm" placeholder="Shldr"></div>
                        
                        <div class="col-12"><input type="text" id="tm_notes" class="form-control form-control-sm" placeholder="Special Notes"></div>
                    </div>
                    <button class="btn btn-secondary w-100 mt-2" onclick="saveTailorMeasurements()">Save Measurements</button>
                </div>
            </div>

            <div id="module-gym-access" class="biz-module card shadow-sm border-dark mb-4" style="display:none;">
                <div class="card-header bg-dark text-white"><h5><i class="fas fa-dumbbell"></i> Gym Access</h5></div>
                <div class="card-body">
                    <div class="input-group mb-3">
                        <input type="text" id="gym_member_id" class="form-control" placeholder="Member ID / Phone">
                        <button class="btn btn-success" onclick="markGymAttendance()">Mark Attendance</button>
                    </div>
                    <small class="text-muted">Diet Plan feature coming soon.</small>
                </div>
            </div>
        
            <div id="module-transport-trip" class="biz-module card shadow-sm border-secondary mb-4" style="display:none;">
                <div class="card-header bg-secondary text-white"><h5><i class="fas fa-truck-moving"></i> Trip Manager</h5></div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-6"><input type="text" id="trans_vehicle" class="form-control form-control-sm" placeholder="Vehicle No"></div>
                        <div class="col-6"><input type="text" id="trans_driver" class="form-control form-control-sm" placeholder="Driver Name"></div>
                        <div class="col-6"><input type="text" id="trans_start" class="form-control form-control-sm" placeholder="Start Location"></div>
                        <div class="col-6"><input type="text" id="trans_end" class="form-control form-control-sm" placeholder="End Location"></div>
                        <div class="col-6"><input type="number" id="trans_freight" class="form-control form-control-sm" placeholder="Freight Rate (тВ╣)"></div>
                        <div class="col-6"><input type="number" id="trans_advance" class="form-control form-control-sm" placeholder="Advance Given"></div>
                        <div class="col-12"><button class="btn btn-dark w-100 btn-sm" onclick="createTransportTrip()">Create New Trip</button></div>
                    </div>
                </div>
            </div>

        <div id="module-security-panel" class="biz-module card shadow-sm border-danger mb-4" style="display:none;">
            <div class="card-header bg-danger text-white d-flex justify-content-between">
                <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Store Security & Anti-Theft</h5>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="security-arm-switch" onchange="toggleSecurityMode()">
                    <label class="form-check-label text-white" for="security-arm-switch">System ARMED</label>
                </div>
            </div>
            <div class="card-body text-center">
                
                <div class="row">
                    <div class="col-md-6">
                        <p class="small fw-bold">Live Gate Camera</p>
                        <video id="security-video" width="100%" autoplay style="border: 2px solid red; border-radius: 5px;"></video>
                    </div>
                    <div class="col-md-6">
                        <p class="small fw-bold">Last Security Alert</p>
                        <canvas id="security-canvas" style="display:none;"></canvas>
                        <img id="thief-photo-display" src="" class="img-fluid border border-dark" style="min-height: 150px; background: #eee;">
                        <p id="alert-timestamp" class="text-danger fw-bold mt-2"></p>
                    </div>
                </div>
        
                <div id="security-status-box" class="alert alert-secondary mt-3">
                    System is Idle. Waiting for RFID Signal...
                </div>
        
                <button class="btn btn-outline-dark btn-sm mt-2" onclick="testAlarm()">ЁЯФФ Test Alarm (Demo)</button>
            </div>
        </div>

        <div id="module-paint-estimator" class="biz-module card shadow-sm border-warning mb-4" style="display:none;">
            <div class="card-header bg-warning text-dark d-flex justify-content-between">
                <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Paint Budget Estimator</h5>
                <small>Area Input</small>
            </div>
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label class="fw-bold">Area (Square Feet)</label>
                        <input type="number" id="est-area" class="form-control" placeholder="e.g. 500 (10x50 wall)">
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-dark w-100" onclick="calculatePaintEstimate()">
                            <i class="fas fa-magic"></i> Calculate
                        </button>
                    </div>
                </div>
                
                <div id="est-result" class="mt-3 p-3 bg-light border rounded d-none">
                    <table class="table table-sm table-bordered mb-0 bg-white">
                        <thead class="table-dark"><tr><th>Item</th><th>Quantity (Approx)</th></tr></thead>
                        <tbody>
                            <tr><td>Putty (2 Coats)</td><td id="res-putty" class="fw-bold">-</td></tr>
                            <tr><td>Primer (1 Coat)</td><td id="res-primer" class="fw-bold">-</td></tr>
                            <tr><td>Paint (2 Coats)</td><td id="res-paint" class="fw-bold">-</td></tr>
                        </tbody>
                    </table>
                    <button class="btn btn-sm btn-outline-success w-100 mt-2" onclick="printEstimate()"><i class="fas fa-print"></i> Print Quote for Customer</button>
                </div>
            </div>
        </div>



        </section>





        <section id="stock" class="section">
            <h2 class="mb-4 text-primary">рд╕реНрдЯреЙрдХ рдкреНрд░рдмрдВрдзрди</h2>
            <div class="card mb-4">
                <div class="card-header">рдирдпрд╛ рд╕реНрдЯреЙрдХ рдЖрдЗрдЯрдо рдЬреЛрдбрд╝реЗрдВ</div>
                <div class="card-body">
                    <form id="add-stock-form" class="row g-3">


                        <input type="hidden" id="stock-action-type" value="add">
                        <div class="col-md-3">
                            <label for="stock-sku" class="form-label">SKU / рдХреЛрдб</label>
                            <input type="text" class="form-control" id="stock-sku" required>
                        </div>
                        <div class="col-md-5">
                            <label for="stock-name" class="form-label">рдЖрдЗрдЯрдо рдХрд╛ рдирд╛рдо</label>
                            <input type="text" class="form-control" id="stock-name" required>
                        </div>
                        <div class="col-md-2">
                            <label for="stock-quantity" class="form-label">рдорд╛рддреНрд░рд╛ (Qty)</label>
                            <input type="number" class="form-control" id="stock-quantity" required min="0">
                        </div>
                        <div class="col-md-2">
                            <label for="stock-unit" class="form-label">рдЗрдХрд╛рдИ (Unit)</label>
                            <input type="text" class="form-control" id="stock-unit" placeholder="рдЬреИрд╕реЗ: Bottle, Pcs, ml" required>
                        </div>
                      <div class="col-md-3">
                            <label for="stock-purchase-price" class="form-label">рдЦрд░реАрдж рдореВрд▓реНрдп (тВ╣)</label>
                            <input type="number" step="0.01" class="form-control" id="stock-purchase-price" required min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="stock-sale-price" class="form-label">рдмрд┐рдХреНрд░реА рдореВрд▓реНрдп (тВ╣)</label>
                            <input type="number" step="0.01" class="form-control" id="stock-sale-price" required min="0">
                        </div>
                        <div class="col-md-2" id="stock-duration-div" style="display:none;"> 
                            <label for="stock-duration" class="form-label">рд╕рдордп (Min)</label>
                            <input type="number" class="form-control" id="stock-duration" placeholder="e.g. 30">
                        </div>
                        <div class="col-md-3">
                            <label for="stock-gst" class="form-label">GST (%)</label>
                            <input type="number" step="0.01" class="form-control" id="stock-gst" value="0" min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="stock-hsn-code" class="form-label">HSN рдХреЛрдб (рд╡реИрдХрд▓реНрдкрд┐рдХ)</label>
                            <input type="text" class="form-control" id="stock-hsn-code">
                        </div>
                        <hr class="my-3 col-12">
                        <h6 class="col-12 text-info small">**рдЕрддрд┐рд░рд┐рдХреНрдд рд╡рд┐рд╡рд░рдг (Optional)**</h6>
                        <p class="col-12 text-muted small">Chasme ke liye (SPH, CYL) ya Jooton ke liye (Color, Size) jaise extra field yahaan jodein.</p>
                        
                        <div id="prescription-fields-container" class="col-12" style="display: none;">
                            
                            <div class="row g-3">
                                
                                <div class="col-md-6">
                                    <h6 class="text-center text-primary" style="font-size: 0.9rem;">Right Eye (RE) - рджрд╛рдИрдВ рдЖрдБрдЦ</h6>
                                    <table class="table table-bordered table-sm text-center">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="font-size: 0.8rem;"></th>
                                                <th style="font-size: 0.8rem;">SPH</th>
                                                <th style="font-size: 0.8rem;">CYL</th>
                                                <th style="font-size: 0.8rem;">AXLS</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="fw-bold" style="font-size: 0.8rem;">Distance (рджреВрд░)</td>
                                                
                                                <td><input type="text" inputmode="text" class="form-control form-control-sm" id="stock_sph_od_dist"></td>
                                                <td><input type="text" inputmode="text" class="form-control form-control-sm" id="stock_cyl_od_dist"></td>
                                                <td><input type="text" inputmode="text" class="form-control form-control-sm" id="stock_axs_od_dist"></td>
                                            </tr>
                                            <tr>
                                                <td class="fw-bold" style="font-size: 0.8rem;">Near (рдиреЫрджреАрдХ)</td>
                                                
                                                <td><input type="text" inputmode="text" class="form-control form-control-sm" id="stock_sph_od_near"></td>
                                                <td><input type="text" inputmode="text" class="form-control form-control-sm" id="stock_cyl_od_near"></td>
                                                <td><input type="text" inputmode="text" class="form-control form-control-sm" id="stock_axs_od_near"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                        
                                <div class="col-md-6">
                                    <h6 class="text-center text-primary" style="font-size: 0.9rem;">Left Eye (LE) - рдмрд╛рдИрдВ рдЖрдБрдЦ</h6>
                                    <table class="table table-bordered table-sm text-center">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="font-size: 0.8rem;"></th>
                                                <th style="font-size: 0.8rem;">SPH</th>
                                                <th style="font-size: 0.8rem;">CYL</th>
                                                <th style="font-size: 0.8rem;">AXLS</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="fw-bold" style="font-size: 0.8rem;">Distance (рджреВрд░)</td>
                                                
                                                <td><input type="text" inputmode="text" class="form-control form-control-sm" id="stock_sph_os_dist"></td>
                                                <td><input type="text" inputmode="text" class="form-control form-control-sm" id="stock_cyl_os_dist"></td>
                                                <td><input type="text" inputmode="text" class="form-control form-control-sm" id="stock_axs_os_dist"></td>
                                            </tr>
                                            <tr>
                                                <td class="fw-bold" style="font-size: 0.8rem;">Near (рдиреЫрджреАрдХ)</td>
                                                
                                                <td><input type="text" inputmode="text" class="form-control form-control-sm" id="stock_sph_os_near"></td>
                                                <td><input type="text" inputmode="text" class="form-control form-control-sm" id="stock_cyl_os_near"></td>
                                                <td><input type="text" inputmode="text" class="form-control form-control-sm" id="stock_axs_os_near"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div> <div class="text-center mt-3">
                                <h4 style="font-weight: bold; color: #444; letter-spacing: 2px;">ADD</h4>
                            </div>
                            </div> <div class="col-12">
                            <button type="button" class="btn btn-sm btn-outline-info" id="add-custom-field-btn">
                                <i class="fas fa-plus me-1"></i> Naya Field Jodein (Optical)
                            </button>
                        </div>

                        <div id="module-tiles-calc" class="biz-module col-12 border p-3 bg-light rounded mt-2" style="display:none;">
                            <h6 class="text-secondary small fw-bold"><i class="fas fa-th me-2"></i> Tiles/Ceramic Coverage Details</h6>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="small fw-bold">Coverage (Sq.Ft per Box)</label>
                                    <input type="number" id="stock-sqft-per-box" class="form-control form-control-sm" placeholder="e.g. 16">
                                </div>
                                <div class="col-md-4">
                                    <label class="small fw-bold">Pieces per Box</label>
                                    <input type="number" id="stock-pcs-per-box" class="form-control form-control-sm" placeholder="e.g. 4">
                                </div>
                                <div class="col-md-4">
                                    <label class="small fw-bold">Breakage Rate (%)</label>
                                    <input type="number" id="stock-breakage" class="form-control form-control-sm" value="0">
                                </div>
                            </div>
                        </div>
                        
                        <div id="module-rental-stock" class="biz-module col-12 border p-3 bg-warning bg-opacity-10 rounded mt-2 border-warning" style="display:none;">
                            <h6 class="text-dark small fw-bold"><i class="fas fa-campground me-2"></i> Rental / Tent Settings</h6>
                            <div class="row g-2 align-items-end">
                                <div class="col-md-4">
                                    <label class="small fw-bold">Security Deposit (тВ╣)</label>
                                    <input type="number" id="rental-security" class="form-control form-control-sm" placeholder="Per Item">
                                </div>
                                <div class="col-md-4">
                                    <label class="small fw-bold">Rent Per Day (тВ╣)</label>
                                    <input type="number" id="rental-daily-price" class="form-control form-control-sm" placeholder="Daily Charge">
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="rental-is-active" checked>
                                        <label class="form-check-label small fw-bold">Available for Rent</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    
<hr class="my-3 col-12">


                        <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-primary w-100">рд╕реНрдЯреЙрдХ рдореЗрдВ рдЖрдЗрдЯрдо рдЬреЛрдбрд╝реЗрдВ</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">рдЙрдкрд▓рдмреНрдз рд╕реНрдЯреЙрдХ рд╕реВрдЪреА</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>SKU</th>
                                    <th>рдЖрдЗрдЯрдо</th>
                                    <th>Qty</th>
                                    <th>рдЦрд░реАрдж рдореВрд▓реНрдп</th>
                                    <th>рдмрд┐рдХреНрд░реА рдореВрд▓реНрдп</th>
                                    <th>GST %</th>
                                    <th>Last Updated</th>
                                    <th>рдПрдХреНрд╢рди</th> 
                                </tr>
                            </thead>
                            <tbody id="stock-table-body">
                                <tr><td colspan="8" class="text-center text-muted">рдХреЛрдИ рд╕реНрдЯреЙрдХ рдЖрдЗрдЯрдо рдирд╣реАрдВ рдорд┐рд▓рд╛</td></tr>
                            </tbody>
                            <tfoot id="stock-table-foot"></tfoot> 
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="sales" class="section">
            <h2 class="mb-4 text-primary">рдмрд┐рдХреНрд░реА (рдкреЙрдЗрдВрдЯ рдСрдл рд╕реЗрд▓)</h2>
            <div class="row g-4">
                <div class="col-lg-5"> <div class="card">
                        <div class="card-header">рдирдпрд╛ рдЪрд╛рд▓рд╛рди рдмрдирд╛рдПрдВ</div>
                        <div class="card-body">
                            <form id="pos-form">
                                <div class="mb-3">
                                    <label for="pos-customer" class="form-label">рдЧреНрд░рд╛рд╣рдХ рдХрд╛ рдирд╛рдо</label>
                                    <input type="text" class="form-control" id="pos-customer" list="customer-datalist" placeholder="рдЕрдирд╛рдо рдЧреНрд░рд╛рд╣рдХ рдпрд╛ рдирд╛рдо рдЯрд╛рдЗрдк рдХрд░реЗрдВ">
                                    <datalist id="customer-datalist"></datalist>
                                </div>
                                <div class="row g-2 mb-3 p-2 bg-light border rounded paint-only biz-only">
                                    <div class="col-md-6">
                                        <label class="small fw-bold text-primary"><i class="fas fa-brush"></i> рдкреЗрдВрдЯрд░ (рдХрдореАрд╢рди рдХреЗ рд▓рд┐рдП)</label>
                                        
                                        <div class="input-group input-group-sm mb-2">
                                            <select id="pos-painter-select" class="form-select">
                                                <option value="" selected>-- Select Painter --</option>
                                            </select>
                                            <button class="btn btn-outline-primary" type="button" onclick="addNewPainterPrompt()" title="рдирдпрд╛ рдкреЗрдВрдЯрд░ рдЬреЛрдбрд╝реЗрдВ">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            <button class="btn btn-outline-dark" type="button" onclick="viewSelectedPainterLedger()" title="рд╣рд┐рд╕рд╛рдм (Ledger) рджреЗрдЦреЗрдВ">
                                                <i class="fas fa-file-invoice-dollar"></i> рд╣рд┐рд╕рд╛рдм
                                            </button>
                                        </div>
                                
                                        <input type="tel" id="pos-painter-mobile" class="form-control form-control-sm mb-2" placeholder="рдкреЗрдВрдЯрд░ рдореЛрдмрд╛рдЗрд▓ (Optional)">
                                        
                                        <div class="d-flex align-items-center gap-1 p-1 border border-success rounded bg-white">
                                            <label class="small fw-bold text-success mb-0 me-1">рдХрдореАрд╢рди:</label>
                                            <select class="form-select form-select-sm border-success" id="pos-commission-mode" style="width: 70px;">
                                                <option value="PERCENT" selected>%</option> 
                                                <option value="FLAT">тВ╣</option>       
                                            </select>
                                            <input type="number" class="form-control form-control-sm border-success" id="pos-commission-value" placeholder="Ex: 2 or 100">
                                        </div>
                                    </div>
                                
                                    <div class="col-md-6">
                                        <label class="small fw-bold text-danger"><i class="fas fa-fill-drip"></i> рд╕реНрдорд╛рд░реНрдЯ рдорд┐рдХреНрд╕рд┐рдВрдЧ (Rate Fixer)</label>
                                        <button type="button" class="btn btn-sm btn-danger w-100" style="height: 100px;" data-bs-toggle="modal" data-bs-target="#paintMixingModal">
                                            <i class="fas fa-vial fa-2x mb-2"></i><br> Base + Colorant <br>рдЬреЛрдбрд╝реЗрдВ
                                        </button>
                                    </div>
                                </div>       
                                <div class="mb-3">
                                    <label for="pos-customer-mobile" class="form-label">рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░</label>
                                    <input type="tel" class="form-control" id="pos-customer-mobile" placeholder="рдЧреНрд░рд╛рд╣рдХ рдХрд╛ рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░ (рд╡реИрдХрд▓реНрдкрд┐рдХ)">
                                </div>
                                
                                <div id="module-finance-collection" class="mb-3" style="display:none;">
                                    <label for="pos-loan-account" class="form-label fw-bold text-danger">Account / Loan Number</label>
                                    <input type="text" class="form-control border-danger" id="pos-loan-account" placeholder="e.g. LN-889900">
                                </div>
                                
                                <div class="mb-3 position-relative">
                                    <label for="pos-item-search" class="form-label">рдЖрдЗрдЯрдо рдЦреЛрдЬреЗрдВ / SKU</label>
                                    <div class="input-group"> 
                                        <input 
                                            type="text" 
                                            class="form-control" 
                                            id="pos-item-search" 
                                            placeholder="рдЖрдЗрдЯрдо рдХрд╛ рдирд╛рдо рдпрд╛ SKU рдЯрд╛рдЗрдк рдХрд░реЗрдВ (рдпрд╛ рд╕рднреА рдХреЗ рд▓рд┐рдП рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ)" 
                                            autocomplete="off"
                                        >
                                        <button class="btn btn-warning" type="button" onclick="openMobileScanner()">
                                            <i class="fas fa-qrcode"></i> рдореЛрдмрд╛рдЗрд▓ рд╕реНрдХреИрдирд░
                                        </button>
                                    </div>
                                    <button class="btn btn-info" type="button" id="manual-add-item-btn" title="Naya Item Manually Jodein">
                                        <i class="fas fa-plus"></i> рдирдпрд╛ рдЖрдЗрдЯрдо
                                    </button>

                                    <div id="inline-pairing-box" class="mt-2 p-2 border border-warning rounded bg-light text-center" style="display: none;">
                                        <p class="mb-1 small text-muted">рд╕реНрдХреИрдирд░ рдХрдиреЗрдХреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдпрд╣ рдХреЛрдб рдореЛрдмрд╛рдЗрд▓ рдореЗрдВ рдбрд╛рд▓реЗрдВ:</p>
                                        <span id="inline-pairing-code" style="font-size: 1.8rem; font-weight: bold; letter-spacing: 3px; color: #dc3545;"></span> <div id="inline-pairing-spinner" class="spinner-border spinner-border-sm text-warning ms-2" role="status"> <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p id="inline-pairing-status" class="mt-1 mb-0 small text-success" style="display: none;">
                                            <i class="fas fa-check-circle"></i> рд╕реНрдХреИрдирд░ рдХрдиреЗрдХреНрдЯреЗрдбред
                                        </p>
                                    </div>
                                    <ul 
                                        id="pos-search-results" 
                                        class="list-group position-absolute w-100" 
                                        style="z-index: 100; max-height: 300px; overflow-y: auto;"
                                        onclick="handleSearchResultClick(event)"
                                    ></ul>
                                </div>
                                <hr>
        
                                <h5>рдмрд┐рд▓рд┐рдВрдЧ рдХрд╛рд░реНрдЯ</h5>
<div class="table-responsive mb-3" style="min-height: 150px;">
    <table class="table table-sm">
        <thead>
            <tr>
                <th style="width: 40%;">рдЖрдЗрдЯрдо</th>

                <th style="width: 15%;">Qty</th>

                <th style="width: 15%;">рджрд░</th>

                <th style="width: 15%;">рдХреБрд▓</th>

                <th style="width: 15%; text-align: center;">рд╣рдЯрд╛рдПрдВ</th>
            </tr>
        </thead>
        <tbody id="pos-cart-body">
            <tr><td colspan="5" class="text-center text-muted">рдХрд╛рд░реНрдЯ рдЦрд╛рд▓реА рд╣реИред</td></tr>
        </tbody>
    </table>
</div>
                                
                                <div class="d-flex justify-content-between fw-bold mb-2">
                                    <span>рдХреБрд▓ рдЯреИрдХреНрд╕реЗрдмрд▓ рд░рд╛рд╢рд┐:</span>
                                    <span id="pos-subtotal">тВ╣0.00</span>
                                </div>
                                <div class="d-flex justify-content-between fw-bold mb-2 text-danger">
                                    <span>рдХреБрд▓ GST рд░рд╛рд╢рд┐:</span>
                                    <span id="pos-gst-amount">тВ╣0.00</span>
                                </div>
                                <div class="d-flex justify-content-between fw-bold fs-5 border-top pt-2">
                                    <span>рднреБрдЧрддрд╛рди рдХреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рдХреБрд▓ рд░рд╛рд╢рд┐:</span>
                                    <span id="pos-total-amount">тВ╣0.00</span>
                                </div>

                                <div id="module-geo-tagging" class="biz-module alert alert-warning p-2 mt-2" style="display:none;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <small class="fw-bold text-dark"><i class="fas fa-map-marker-alt"></i> рд╡рд┐рдЬрд┐рдЯ рд▓реЛрдХреЗрд╢рди (Visit Location)</small>
                                            <div id="gps-status" class="text-danger small" style="font-size: 0.75rem;">Not Captured</div>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-dark" onclick="captureGPS()">
                                            <i class="fas fa-crosshairs"></i> рд▓реЛрдХреЗрд╢рди рд▓реЗрдВ
                                        </button>
                                    </div>
                                    <input type="hidden" id="pos-lat">
                                    <input type="hidden" id="pos-long">
                                </div>

                                <div id="pos-god-mode-delivery" class="mb-3 p-2 border border-primary rounded bg-light" style="display:none;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="text-primary m-0 fw-bold"><i class="fas fa-truck-fast"></i> Instant Delivery & Alert</h6>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="pos_auto_deliver_check" onchange="togglePosDeliveryDate()">
                                            <label class="form-check-label fw-bold small" for="pos_auto_deliver_check">Enable</label>
                                        </div>
                                    </div>
                                    
                                    <div id="pos_delivery_inputs" style="display:none;" class="mt-2">
                                        <label class="small text-muted">Delivery Date:</label>
                                        <input type="date" id="pos_auto_date" class="form-control form-control-sm mb-2">
                                        
                                        <input type="tel" id="pos_auto_mistri_mobile" class="form-control form-control-sm mb-2" placeholder="Mistri Mobile (Optional)">
                                
                                        <div class="d-flex gap-3 border-top pt-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="pos_send_cust_wa" checked>
                                                <label class="form-check-label small fw-bold text-success" for="pos_send_cust_wa">
                                                    Customer Msg?
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="pos_send_mistri_wa">
                                                <label class="form-check-label small fw-bold text-primary" for="pos_send_mistri_wa">
                                                    Mistri Msg?
                                                </label>
                                            </div>
                                        </div>
                                
                                        <div class="mt-2 border-top pt-2">
                                            <label class="small fw-bold text-dark d-flex justify-content-between">
                                                <span>ЁЯТм Auto-Message Template</span>
                                                <span class="text-primary cursor-pointer" onclick="resetTemplate()">Reset</span>
                                            </label>
                                            <textarea id="pos_wa_template" class="form-control form-control-sm" rows="4" style="font-size: 0.85rem; background: #f0f8ff;">
                                рдирдорд╕реНрддреЗ *{name}*,
                                рдЖрдкрдХрд╛ рдСрдбрд░ рдХрдВрдлрд░реНрдо рд╣реЛ рдЧрдпрд╛ рд╣реИ! ЁЯОЙ
                                ЁЯз╛ рдмрд┐рд▓ рдирдВрдмрд░: *#{bill_no}*
                                ЁЯТ░ рдХреБрд▓ рд░рд╛рд╢рд┐: *{amount}*
                                ЁЯУж рд╕рд╛рдорд╛рди: {items}
                                ЁЯЪЪ рдбрд┐рд▓реАрд╡рд░реА: {date}
                                
                                рдХреГрдкрдпрд╛ рд╕рд╛рде рдореЗрдВ рднреЗрдЬрд╛ рдЧрдпрд╛ PDF рдмрд┐рд▓ рджреЗрдЦреЗрдВред
                                рдзрдиреНрдпрд╡рд╛рдж! ЁЯЩП
                                </textarea>
                                            <div class="text-muted mt-1" style="font-size: 10px;">
                                                <strong>Variables:</strong> {name}, {bill_no}, {amount}, {items}, {date} (рдпреЗ рдЕрдкрдиреЗ рдЖрдк рднрд░ рдЬрд╛рдПрдВрдЧреЗ)
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3 p-2 border border-success rounded bg-light">
                                    <label class="fw-bold small text-success">Payment Mode (рднреБрдЧрддрд╛рди рдХрд╛ рддрд░реАрдХрд╛)</label>
                                    <select id="pos-payment-mode" class="form-select form-select-sm fw-bold">
                                        <option value="Cash" selected>ЁЯТ╡ Cash (рдирдХрдж)</option>
                                        <option value="UPI">ЁЯУ▒ UPI / PhonePe / GPay</option>
                                        <option value="Card">ЁЯТ│ Card</option>
                                        <option value="Credit">ЁЯУХ Udhaar (Credit)</option>
                                    </select>
                                </div>

                                <div class="mt-4 d-flex gap-2">
                                    <button 
                                        type="button" 
                                        class="btn btn-success btn-lg flex-grow-1" 
                                        id="complete-sale-btn"
                                        onclick="handleCompleteSale()"
                                    >
                                        <i class="fas fa-check-circle"></i> рдмрд┐рдХреНрд░реА рдкреВрд░реА рдХрд░реЗрдВ
                                    </button>
                                
                                    <button 
                                        type="button" 
                                        class="btn btn-danger btn-lg" 
                                        onclick="resetPOSButton()" 
                                        title="рдХрд╛рд░реНрдЯ рдЦрд╛рд▓реА рдХрд░реЗрдВ (Reset)"
                                    >
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-7"> <div class="card">
                        <div class="card-header">рд╣рд╛рд▓ рдХреЗ рдЪрд╛рд▓рд╛рди</div>
                        <div class="card-body">
                            <div class="mb-3 d-flex justify-content-end">
                                <button class="btn btn-sm btn-outline-secondary" id="refresh-sales-btn" onclick="fetchAndRenderSales()"><i class="fas fa-sync-alt"></i> рддрд╛рдЬрд╝рд╛ рдХрд░реЗрдВ</button>
                                <div class="mb-3 d-flex justify-content-end">
                                    <button class="btn btn-sm btn-outline-secondary" id="refresh-sales-btn" onclick="fetchAndRenderSales()">
                                        <i class="fas fa-sync-alt"></i> рддрд╛рдЬрд╝рд╛ рдХрд░реЗрдВ
                                    </button>
                                
                                    <button class="btn btn-dark btn-sm ms-2" onclick="SecurityLogger.showLogs()" title="View Security Logs">
                                        <i class="fas fa-shield-alt"></i> Logs
                                    </button>
                                </div>

                            </div>
                            <div class="table-responsive" style="max-height: 700px; overflow-y: auto;">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>рдЪрд╛рд▓рд╛рди рдирдВ.</th>
                                            <th>рдЧреНрд░рд╛рд╣рдХ</th>
                                            <th>GST</th>
                                            <th>рдХреБрд▓ рд░рд╛рд╢рд┐</th>
                                            <th>рддрд┐рдерд┐</th>
                                            <th>рдПрдХреНрд╢рди</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sales-table-body">
                                        <tr><td colspan="5" class="text-center text-muted">рдХреЛрдИ рдмрд┐рдХреНрд░реА рд░рд┐рдХреЙрд░реНрдб рдирд╣реАрдВред</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="invoice-generator" class="section">
            <h2 class="mb-4 text-primary">ЁЯЗоЁЯЗ│ India's Best Invoice Generator Pro</h2>
            <div class="row g-4">
                <div class="col-lg-5 no-print">
                    <div class="card">
                        <div class="card-header">
                            <h2>ЁЯУЭ Create New Invoice</h2>
                        </div>
                        <div class="card-body p-4">
                            <div class="row g-3 mb-4">
                                <h5>ЁЯПк Shop Details</h5>
                                <div class="col-md-6">
                                    <input type="text" id="shopName" class="form-control" placeholder="Shop Name" onkeyup="updateInvoicePreview()">
                                </div>
                                <div class="col-md-6">
                                    <input type="text" id="shopContact" class="form-control" placeholder="Contact No." onkeyup="updateInvoicePreview()">
                                </div>
                                <div class="col-12">
                                    <input type="text" id="shopAddress" class="form-control" placeholder="Shop Address" onkeyup="updateInvoicePreview()">
                                </div>
                                 <div class="col-md-6">
                                     <input type="text" id="shopGstin" class="form-control" placeholder="GSTIN (Optional)" onkeyup="updateInvoicePreview()">
                                 </div>
                                 <div class="col-md-6">
                                     <label for="qrUpload" class="form-label small">Upload UPI QR (Optional)</label>
                                     <input type="file" class="form-control form-control-sm" id="qrUpload" accept="image/*">
                                 </div>
                            </div>
        
                            <div class="row g-3 mb-4">
                                <h5>ЁЯСд Customer Details</h5>
                                 <div class="col-md-6">
                                     <input type="text" id="customerName" class="form-control" placeholder="Customer Name" onkeyup="updateInvoicePreview()">
                                 </div>
                                 <div class="col-md-6">
                                     <input type="text" id="customerContact" class="form-control" placeholder="Contact No." onkeyup="updateInvoicePreview()">
                                 </div>
                                <div class="col-12">
                                    <input type="text" id="customerAddress" class="form-control" placeholder="Customer Address" onkeyup="updateInvoicePreview()">
                                </div>
                            </div>
        
                            <h5 class="mb-3">тЮХ Add Items</h5>
                            <form id="item-form" class="row g-2 align-items-center">
                                <div class="col-sm-12 mb-2">
                                    <input type="text" id="itemName" class="form-control" placeholder="Item Name">
                                </div>
                                <div class="col-sm-3">
                                    <input type="number" id="quantity" class="form-control" placeholder="Qty">
                                </div>
                                 <div class="col-sm-4">
                                     <input type="number" id="price" class="form-control" placeholder="Rate">
                                 </div>
                                 <div class="col-sm-3">
                                     <input type="number" id="gst" class="form-control" placeholder="GST %">
                                 </div>
                                <div class="col-sm-2">
                                    <button type="button" class="btn btn-success w-100" onclick="addItem()">Add</button>
                                </div>
                            </form>
                            <hr>
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button class="btn btn-info text-white" onclick="printInvoice()">ЁЯЦия╕П Print Invoice</button>
                                <button class="btn btn-danger" onclick="clearBill()">ЁЯЧСя╕П Clear Bill</button>
                            </div>
                        </div>
                    </div>
                </div>
        
                <div class="col-lg-7">
                    <div id="invoice-preview">
                        <div class="text-center text-muted p-5">Please fill details and add items to see the invoice preview.</div>
                    </div>
                </div>
            </div>
        </section>

        <section id="purchases" class="section">
            <h2 class="mb-4 text-primary">рдЦрд░реАрдж рд░рд┐рдХреЙрд░реНрдб</h2>
            <div class="card mb-4">
                <div class="card-header">рдирдИ рдЦрд░реАрдж рджрд░реНрдЬ рдХрд░реЗрдВ</div>
                <div class="card-body">
                    <form id="add-purchase-form" class="row g-3">
                        <div class="col-md-3">
                            <label for="purchase-bill-number" class="form-label">рдмрд┐рд▓ / рдЪрд╛рд▓рд╛рди рдирдВ.</label>
                            <input type="text" class="form-control" id="purchase-bill-number" required>
                        </div>
                        <div class="col-md-3">
                            <label for="purchase-supplier" class="form-label">рдЖрдкреВрд░реНрддрд┐рдХрд░реНрддрд╛ рдХрд╛ рдирд╛рдо</label>
                            <input type="text" class="form-control" id="purchase-supplier" required>
                        </div>
                        <div class="col-md-3">
                            <label for="purchase-date" class="form-label">рдЦрд░реАрдж рдХреА рддрд╛рд░реАрдЦ</label>
                            <input type="date" class="form-control" id="purchase-date" required>
                        </div>
                        <div class="col-md-3">
                            <label for="purchase-total-cost" class="form-label">рдХреБрд▓ рдмрд┐рд▓ рд░рд╛рд╢рд┐ (тВ╣)</label>
                            <input type="number" step="0.01" class="form-control" id="purchase-total-cost" required min="0">
                        </div>
                        <div class="col-12">
                            <label for="purchase-item-details" class="form-label">рд╕рд╛рдорд╛рди рдХрд╛ рд╡рд┐рд╡рд░рдг (Item Details)</label>
                            <textarea class="form-control" id="purchase-item-details" rows="2" placeholder="рдЙрджрд╛рд╣рд░рдг: 50kg рдЖрд▓реВ, 10kg рдкрдиреАрд░, 5L рддреЗрд▓..."></textarea>
                        </div>
                    
                        <hr class="my-3 col-12">
                        <h6 class="col-12 text-primary">GST рд╡рд┐рд╡рд░рдг (GSTR-2 рдХреЗ рд▓рд┐рдП)</h6>
                        
                        <div class="col-md-3">
                            <label for="purchase-taxable-value" class="form-label">рдЯреИрдХреНрд╕реЗрдмрд▓ рд╡реИрд▓реНрдпреВ (тВ╣)</label>
                            <input type="number" step="0.01" class="form-control" id="purchase-taxable-value" min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="purchase-cgst" class="form-label">CGST (тВ╣)</label>
                            <input type="number" step="0.01" class="form-control" id="purchase-cgst" value="0" min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="purchase-sgst" class="form-label">SGST (тВ╣)</label>
                            <input type="number" step="0.01" class="form-control" id="purchase-sgst" value="0" min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="purchase-igst" class="form-label">IGST (тВ╣)</label>
                            <input type="number" step="0.01" class="form-control" id="purchase-igst" value="0" min="0">
                        </div>
                    
                        <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-success w-100">рдЦрд░реАрдж рд░рд┐рдХреЙрд░реНрдб рдХрд░реЗрдВ</button>
                        </div>
                    </form>                </div>
            </div>

            <div class="card">
                <div class="card-header">рд╣рд╛рд▓ рдХреА рдЦрд░реАрдж рдХрд╛ рдЗрддрд┐рд╣рд╛рд╕</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>рдмрд┐рд▓ рдирдВ.</th>
                                    <th>рдЖрдкреВрд░реНрддрд┐рдХрд░реНрддрд╛</th>
                                    <th>рдЖрдЗрдЯрдо</th>
                                    <th>рдХреБрд▓ рд░рд╛рд╢рд┐</th>
                                    <th>рддрд┐рдерд┐</th>
                                    <th>рдПрдХреНрд╢рди</th>
                                </tr>
                            </thead>
                            <tbody id="purchases-table-body">
                                <tr><td colspan="6" class="text-center text-muted">рдХреЛрдИ рдЦрд░реАрдж рд░рд┐рдХреЙрд░реНрдб рдирд╣реАрдВ рдорд┐рд▓рд╛</td></tr>
                            </tbody>
                            <tfoot id="purchases-table-foot"></tfoot> 
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="crm" class="section">
            <h2 class="mb-4 text-primary">рдЧреНрд░рд╛рд╣рдХ рд╕рдВрдмрдВрдз рдкреНрд░рдмрдВрдзрди (CRM)</h2>
            <div class="card mb-4">
                <div class="card-header">рдирдпрд╛ рдЧреНрд░рд╛рд╣рдХ рдЬреЛрдбрд╝реЗрдВ</div>
                <div class="card-body">
                    <form id="add-customer-form" class="row g-3">
                        <div class="col-md-4">
                            <label for="customer-name" class="form-label">рдирд╛рдо</label>
                            <input type="text" class="form-control" id="customer-name" required>
                        </div>
                        <div class="col-md-4">
                            <label for="customer-phone" class="form-label">рдлрд╝реЛрди рдирдВрдмрд░</label>
                            <input type="tel" class="form-control" id="customer-phone">
                        </div>
                        <div class="form-group">
                            <label for="cust-dob">DOB (optional)</label>
                            <input id="cust-dob" type="date" class="form-control" placeholder="YYYY-MM-DD">
                          </div>
                          
                        <div class="col-md-4">
                            <label for="customer-email" class="form-label">рдИрдореЗрд▓ (рд╡реИрдХрд▓реНрдкрд┐рдХ)</label>
                            <input type="email" class="form-control" id="customer-email">
                        </div>
                        <div class="col-12">
                            <label for="customer-address" class="form-label">рдкрддрд╛ (Address)</label>
                            <textarea class="form-control" id="customer-address" rows="1"></textarea>
                        </div>
                         <div class="col-md-6">
                            <label for="customer-gstin" class="form-label">GSTIN (рд╡реИрдХрд▓реНрдкрд┐рдХ)</label>
                            <input type="text" class="form-control" id="customer-gstin" maxlength="15">
                        </div>
                        <div class="col-md-6">
                            <label for="customer-balance" class="form-label">рдкрд┐рдЫрд▓рд╛ рдмрдХрд╛рдпрд╛ (тВ╣)</label>
                            <input type="number" step="0.01" class="form-control" id="customer-balance" value="0" min="0">
                        </div>
                       <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-primary w-100">рдЧреНрд░рд╛рд╣рдХ рдХреЛ рдЬреЛрдбрд╝реЗрдВ</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="card">
                <div class="card-header">рдЧреНрд░рд╛рд╣рдХ рд╕реВрдЪреА</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>рдирд╛рдо</th>
                                    <th>рдлрд╝реЛрди</th>
                                    <th>рдкрддрд╛</th>
                                    <th>рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛</th>
                                    <th>рдПрдХреНрд╢рди</th>
                                </tr>
                            </thead>
                            <tbody id="crm-table-body">
                                <tr><td colspan="6" class="text-center text-muted">рдХреЛрдИ рдЧреНрд░рд╛рд╣рдХ рдирд╣реАрдВ рдорд┐рд▓рд╛</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="expenses" class="section">
            <h2 class="mb-4 text-primary">рдЦрд░реНрдЪ рдкреНрд░рдмрдВрдзрди</h2>
            <div class="card mb-4">
                <div class="card-header">рдирдпрд╛ рдЦрд░реНрдЪ рджрд░реНрдЬ рдХрд░реЗрдВ</div>
                <div class="card-body">
                    <form id="add-expense-form" class="row g-3">
                        <div class="col-md-4">
                            <label for="expense-date" class="form-label">рддрд┐рдерд┐</label>
                            <input type="date" class="form-control" id="expense-date" value="" required>
                        </div>
                        <div class="col-md-4">
                            <label for="expense-category" class="form-label">рд╢реНрд░реЗрдгреА</label>
                            <select class="form-select" id="expense-category" required>
                                <option value="" disabled selected>рд╢реНрд░реЗрдгреА рдЪреБрдиреЗрдВ</option>
                                <option value="Salary">рд╡реЗрддрди (Salary)</option>
                                <option value="Rent">рдХрд┐рд░рд╛рдпрд╛ (Rent)</option>
                                <option value="Utilities">рдпреВрдЯрд┐рд▓рд┐рдЯреАрдЬ (рдмрд┐рдЬрд▓реА/рдкрд╛рдиреА)</option>
                                <option value="Marketing">рдорд╛рд░реНрдХреЗрдЯрд┐рдВрдЧ</option>
                                <option value="Miscellaneous">рд╡рд┐рд╡рд┐рдз</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="expense-amount" class="form-label">рд░рд╛рд╢рд┐ (тВ╣)</label>
                            <input type="number" step="0.01" class="form-control" id="expense-amount" required min="0">
                        </div>
                        <div class="col-12">
                            <label for="expense-description" class="form-label">рд╡рд┐рд╡рд░рдг</label>
                            <input type="text" class="form-control" id="expense-description" required>
                        </div>
                        <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-warning w-100">рдЦрд░реНрдЪ рджрд░реНрдЬ рдХрд░реЗрдВ</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="card">
                <div class="card-header">рдЦрд░реНрдЪ рдХрд╛ рдЗрддрд┐рд╣рд╛рд╕</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>рддрд┐рдерд┐</th>
                                    <th>рд╢реНрд░реЗрдгреА</th>
                                    <th>рд╡рд┐рд╡рд░рдг</th>
                                    <th>рд░рд╛рд╢рд┐</th>
                                    <th>рдПрдХреНрд╢рди</th>
                                </tr>
                            </thead>
                            <tbody id="expenses-table-body">
                                <tr><td colspan="5" class="text-center text-muted">рдХреЛрдИ рдЦрд░реНрдЪ рд░рд┐рдХреЙрд░реНрдб рдирд╣реАрдВ рдорд┐рд▓рд╛</td></tr>
                            </tbody>
                            <tfoot id="expenses-table-foot"></tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="reports" class="section">
            <h2 class="mb-4 text-primary">рд░рд┐рдкреЛрд░реНрдЯреНрд╕ рдФрд░ рдПрдирд╛рд▓рд┐рдЯрд┐рдХреНрд╕</h2>
            <div class="row g-4">
                <div class="col-lg-12 mb-4">
                    <div class="card" id="pl-card">
                        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                            <span>рд▓рд╛рдн рдФрд░ рд╣рд╛рдирд┐ (Profit & Loss)</span>
                            <div class="no-print">
                                <button class="btn btn-sm btn-light me-2" onclick="handleReportAction('profit_loss', 'download')"><i class="fas fa-file-download"></i> рдбрд╛рдЙрдирд▓реЛрдб</button>
                                <button class="btn btn-sm btn-light" onclick="handleReportAction('profit_loss', 'print')"><i class="fas fa-print"></i> рдкреНрд░рд┐рдВрдЯ</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-sm report-table">
                                        <thead><tr><th colspan="2" class="text-center">рдЦрд░реНрдЪ (Debit)</th></tr></thead>
                                        <tbody>
                                            <tr><td>рдХреБрд▓ рдЦрд░реАрдж (Purchases)</td><td class="text-end" id="report-pl-purchases">тВ╣0.00</td></tr>
                                            <tr><td>рдХреБрд▓ рдЦрд░реНрдЪ (Expenses)</td><td class="text-end" id="report-pl-expenses">тВ╣0.00</td></tr>
                                            <tr id="report-pl-profit-row" class="d-none"><td><b>рд╢реБрджреНрдз рд▓рд╛рдн (Net Profit)</b></td><td class="text-end fw-bold text-success" id="report-pl-profit">тВ╣0.00</td></tr>
                                        </tbody>
                                        <tfoot>
                                            <tr class="fw-bold bg-light"><td >рдХреБрд▓ рдбреЗрдмрд┐рдЯ</td><td class="text-end" id="report-pl-total-debit">тВ╣0.00</td></tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <table class="table table-sm report-table">
                                        <thead><tr><th colspan="2" class="text-center">рдЖрдп (Credit)</th></tr></thead>
                                        <tbody>
                                            <tr><td>рдХреБрд▓ рдмрд┐рдХреНрд░реА (Revenue)</td><td class="text-end" id="report-pl-revenue">тВ╣0.00</td></tr>
                                            <tr id="report-pl-loss-row" class="d-none"><td><b>рд╢реБрджреНрдз рд╣рд╛рдирд┐ (Net Loss)</b></td><td class="text-end fw-bold text-danger" id="report-pl-loss">тВ╣0.00</td></tr>
                                        </tbody>
                                        <tfoot>
                                            <tr class="fw-bold bg-light"><td>рдХреБрд▓ рдХреНрд░реЗрдбрд┐рдЯ</td><td class="text-end" id="report-pl-total-credit">тВ╣0.00</td></tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-12">
                    <div class="card" id="bs-card">
                        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                            <span>рдмреИрд▓реЗрдВрд╕ рд╢реАрдЯ (Balance Sheet)</span>
                             <div class="no-print">
                                <button class="btn btn-sm btn-light me-2" onclick="handleReportAction('balance_sheet', 'download')"><i class="fas fa-file-download"></i> рдбрд╛рдЙрдирд▓реЛрдб</button>
                                <button class="btn btn-sm btn-light" onclick="handleReportAction('balance_sheet', 'print')"><i class="fas fa-print"></i> рдкреНрд░рд┐рдВрдЯ</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-sm report-table">
                                        <thead><tr><th colspan="2" class="text-center">рджреЗрдирджрд╛рд░рд┐рдпрд╛рдВ рдФрд░ рдЗрдХреНрд╡рд┐рдЯреА (Liabilities & Equity)</th></tr></thead>
                                        <tbody>
                                            <tr><td>GST рдЬрдорд╛ рдХрд░рдиреЗ рдпреЛрдЧреНрдп (Payable)</td><td class="text-end" id="report-bs-gst-payable">тВ╣0.00</td></tr>
                                            <tr><td>рд╡реЗрдВрдбрд░ рдХреЛ рджреЗрдп (Payable)</td><td class="text-end" id="report-bs-vendors-payable">тВ╣0.00</td></tr>
                                            <tr><td>рдорд╛рд▓рд┐рдХ рдХреА рдЗрдХреНрд╡рд┐рдЯреА (Owner's Equity)</td><td class="text-end" id="report-bs-owner-equity">тВ╣0.00</td></tr>
                                        </tbody>
                                        <tfoot>
                                            <tr class="fw-bold bg-light"><td>рдХреБрд▓ рджреЗрдирджрд╛рд░рд┐рдпрд╛рдВ рдФрд░ рдЗрдХреНрд╡рд┐рдЯреА</td><td class="text-end" id="report-bs-total-liabilities">тВ╣0.00</td></tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                     <table class="table table-sm report-table">
                                        <thead><tr><th colspan="2" class="text-center">рдкрд░рд┐рд╕рдВрдкрддреНрддрд┐рдпрд╛рдВ (Assets)</th></tr></thead>
                                        <tbody>
                                            <tr><td>рд╕реНрдЯреЙрдХ рдХрд╛ рдореВрд▓реНрдп (Stock Value)</td><td class="text-end" id="report-bs-stock-value">тВ╣0.00</td></tr>
                                            <tr><td>рдмреИрдВрдХ/рдХреИрд╢ рдмреИрд▓реЗрдВрд╕ (Profit)</td><td class="text-end" id="report-bs-cash-balance">тВ╣0.00</td></tr>
                                        </tbody>
                                        <tfoot>
                                            <tr class="fw-bold bg-light"><td>рдХреБрд▓ рдкрд░рд┐рд╕рдВрдкрддреНрддрд┐рдпрд╛рдВ</td><td class="text-end" id="report-bs-total-assets">тВ╣0.00</td></tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-12">
                    <div class="card" id="product-sales-card">
                        <div class="card-header bg-dark text-white">
                            <span>рдЙрддреНрдкрд╛рдж-рд╡рд╛рд░ рдмрд┐рдХреНрд░реА рдФрд░ рд▓рд╛рдн (Product-wise Sales & Profit)</span>
                        </div>
                        <div class="card-body">
                            <div class="row g-3 mb-3">
                                <div class="col-md-5">
                                    <label for="product-report-start-date" class="form-label">рд╢реБрд░реВрдЖрддреА рддрд╛рд░реАрдЦ</label>
                                    <input type="date" id="product-report-start-date" class="form-control">
                                </div>
                                <div class="col-md-5">
                                    <label for="product-report-end-date" class="form-label">рдЕрдВрддрд┐рдо рддрд╛рд░реАрдЦ</label>
                                    <input type="date" id="product-report-end-date" class="form-control">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" id="fetch-product-sales-report-btn">рд░рд┐рдкреЛрд░реНрдЯ рджреЗрдЦреЗрдВ</button>
                                </div>
                            </div>
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>SKU</th>
                                            <th>рдЖрдЗрдЯрдо</th>
                                            <th>рдорд╛рддреНрд░рд╛ рдмрд┐рдХреА</th>
                                            <th>рдХреБрд▓ рд░реЗрд╡реЗрдиреНрдпреВ</th>
                                            <th>рдХреБрд▓ рд▓рд╛рдЧрдд</th>
                                            <th>рдХреБрд▓ рд▓рд╛рдн</th>
                                        </tr>
                                    </thead>
                                    <tbody id="product-sales-report-body">
                                        <tr><td colspan="6" class="text-center text-muted">рдХреГрдкрдпрд╛ рддрд╛рд░реАрдЦ рдЪреБрдиреЗрдВ рдФрд░ 'рд░рд┐рдкреЛрд░реНрдЯ рджреЗрдЦреЗрдВ' рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВред</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="staff" class="section">
            <h2 class="mb-4 text-primary">рд╕реНрдЯрд╛рдл рдкреНрд░рдмрдВрдзрди (рдПрдбрдорд┐рди)</h2>
            
            <div class="card mb-4">
                <div class="card-header bg-success text-white">рдирдпрд╛ рд╕реНрдЯрд╛рдл рд╕рджрд╕реНрдп рдЬреЛрдбрд╝реЗрдВ</div>
                <div class="card-body">
                    <form id="add-staff-form" class="row g-3">
                        <div class="col-md-4">
                            <label for="staff-name" class="form-label">рдирд╛рдо</label>
                            <input type="text" class="form-control" id="staff-name" required placeholder="рдЬреИрд╕реЗ: рд░рд╛рд╣реБрд▓ рдХреБрдорд╛рд░">
                        </div>
                        <div class="col-md-4">
                            <label for="staff-email" class="form-label">рдИрдореЗрд▓</label>
                            <input type="email" class="form-control" id="staff-email" required placeholder="рдЬреИрд╕реЗ: rahul@example.com">
                        </div>
                        <div class="col-md-4">
                            <label for="staff-password" class="form-label">рдкрд╛рд╕рд╡рд░реНрдб</label>
                            <input type="password" class="form-control" id="staff-password" required placeholder="рдПрдХ рдордЬрдмреВрдд рдкрд╛рд╕рд╡рд░реНрдб рдЪреБрдиреЗрдВ">
                        </div>
                        <div class="col-md-6">
                            <label for="staff-role" class="form-label">рд░реЛрд▓ (рднреВрдорд┐рдХрд╛)</label>
                            <select id="staff-role" class="form-select">
                                <option value="CASHIER" selected>рдХреИрд╢рд┐рдпрд░ (Cashier)</option>
                                <option value="MANAGER">рдореИрдиреЗрдЬрд░ (Manager)</option>
                                <option value="ACCOUNTANT">Accountant (CA Access)</option>
                                <option value="ADMIN">рдПрдбрдорд┐рди (Admin)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="staff-status" class="form-label">рд╕реНрдерд┐рддрд┐ (Status)</label>
                            <select id="staff-status" class="form-select">
                                <option value="pending" selected>рдкреЗрдВрдбрд┐рдВрдЧ (Pending)</option>
                                <option value="active">рд╕рдХреНрд░рд┐рдп (Active)</option>
                                <option value="disabled">рдЕрдХреНрд╖рдо (Disabled)</option>
                            </select>
                        </div>
                        <div class="col-12 mt-3">
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-user-plus me-2"></i>рд╕реНрдЯрд╛рдл рд╕рджрд╕реНрдп рдЬреЛрдбрд╝реЗрдВ
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        
            <div class="card">
                <div class="card-header">рдореМрдЬреВрджрд╛ рд╕реНрдЯрд╛рдл рд╕рджрд╕реНрдп</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>рдирд╛рдо</th>
                                    <th>рдИрдореЗрд▓</th>
                                    <th>рд░реЛрд▓</th>
                                    <th>рд╕реНрдерд┐рддрд┐</th>
                                    <th>рдмрдирд╛рдпрд╛ рдЧрдпрд╛</th>
                                    <th>рдПрдХреНрд╢рди</th>
                                </tr>
                            </thead>
                            <tbody id="staff-table-body">
                                <tr><td colspan="7" class="text-center text-muted py-4">рд╕реНрдЯрд╛рдл рд╕реВрдЪреА рд▓реЛрдб рд╣реЛ рд░рд╣реА рд╣реИ...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        
            <div class="modal fade" id="editStaffModal" tabindex="-1" aria-labelledby="editStaffModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="editStaffModalLabel">
                        <i class="fas fa-user-edit me-2"></i>рд╕реНрдЯрд╛рдл рд╕рджрд╕реНрдп рд╕рдВрдкрд╛рджрд┐рдд рдХрд░реЗрдВ
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <form id="edit-staff-form">
                      <div class="modal-body">
                          <input type="hidden" id="edit-staff-id">
                          <div class="mb-3">
                              <label for="edit-staff-name" class="form-label">рдирд╛рдо</label>
                              <input type="text" class="form-control" id="edit-staff-name" required>
                          </div>
                          <div class="mb-3">
                              <label for="edit-staff-email" class="form-label">рдИрдореЗрд▓ (рдмрджрд▓рд╛ рдирд╣реАрдВ рдЬрд╛ рд╕рдХрддрд╛)</label>
                              <input type="email" class="form-control" id="edit-staff-email" disabled readonly>
                          </div>
                          <div class="mb-3">
                            <label for="edit-staff-role" class="form-label">рд░реЛрд▓ (рднреВрдорд┐рдХрд╛)</label>
                            <select id="edit-staff-role" class="form-select">
                                <option value="CASHIER">рдХреИрд╢рд┐рдпрд░ (Cashier)</option>
                                <option value="MANAGER">рдореИрдиреЗрдЬрд░ (Manager)</option>
                                <option value="ACCOUNTANT">Accountant (CA Access)</option>
                                <option value="ADMIN">рдПрдбрдорд┐рди (Admin)</option>
                            </select>
                          </div>
                          <div class="mb-3">
                            <label for="edit-staff-status" class="form-label">рд╕реНрдерд┐рддрд┐ (Status)</label>
                            <select id="edit-staff-status" class="form-select">
                                <option value="pending">рдкреЗрдВрдбрд┐рдВрдЧ (Pending)</option>
                                <option value="active">рд╕рдХреНрд░рд┐рдп (Active)</option>
                                <option value="disabled">рдЕрдХреНрд╖рдо (Disabled)</option>
                            </select>
                          </div>
                           <div class="mb-3">
                              <label for="edit-staff-password" class="form-label">рдирдпрд╛ рдкрд╛рд╕рд╡рд░реНрдб (рдЕрдЧрд░ рдмрджрд▓рдирд╛ рд╣реИ)</label>
                              <input type="password" class="form-control" id="edit-staff-password" placeholder="рдЦрд╛рд▓реА рдЫреЛрдбрд╝ рджреЗрдВ рдЕрдЧрд░ рдирд╣реАрдВ рдмрджрд▓рдирд╛ рд╣реИ">
                              <div class="form-text">рдкрд╛рд╕рд╡рд░реНрдб рдмрджрд▓рдиреЗ рдХреА рд╕реБрд╡рд┐рдзрд╛ рд╕рд░реНрд╡рд░ рдкрд░ рд▓рд╛рдЧреВ рд╣реЛрдиреЗ рдкрд░ рдХрд╛рдо рдХрд░реЗрдЧреАред</div>
                          </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">рд░рджреНрдж рдХрд░реЗрдВ</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>рдмрджрд▓рд╛рд╡ рд╕реЗрд╡ рдХрд░реЗрдВ
                        </button>
                      </div>
                  </form>
                </div>
              </div>
            </div>
        </section>

        <section id="gst-reports" class="section">
            <h2 class="mb-4 text-primary">GST рд░рд┐рдкреЛрд░реНрдЯреНрд╕ (Simplified)</h2>
            <p class="text-muted">рдпреЗ рдЖрдкрдХреЗ рд╕рд░реНрд╡рд░ рджреНрд╡рд╛рд░рд╛ рдкреНрд░рджрд╛рди рдХреА рдЧрдИ рд╕рд░рд▓реАрдХреГрдд (simplified) GST рд░рд┐рдкреЛрд░реНрдЯ рд╣реИрдВред </p>
            
            <div class="card">
                <div class="card-header">рд░рд┐рдкреЛрд░реНрдЯреНрд╕ рдЬреЗрдирд░реЗрдЯ рдХрд░реЗрдВ</div>
                <div class="card-body">
                    <div class="row g-3 mb-4">
                        <div class="col-md-5">
                            <label for="gst-report-start-date" class="form-label">рд╢реБрд░реВрдЖрддреА рддрд╛рд░реАрдЦ</label>
                            <input type="date" id="gst-report-start-date" class="form-control" value="">
                        </div>
                        <div class="col-md-5">
                            <label for="gst-report-end-date" class="form-label">рдЕрдВрддрд┐рдо рддрд╛рд░реАрдЦ</label>
                            <input type="date" id="gst-report-end-date" class="form-control" value="">
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <button class="btn btn-info w-100" id="fetch-gstr1-report-btn">GSTR-1 (рдмрд┐рдХреНрд░реА) рд░рд┐рдкреЛрд░реНрдЯ рджреЗрдЦреЗрдВ</button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-warning w-100" id="fetch-gstr2-report-btn">GSTR-2 (рдЦрд░реАрдж) рд░рд┐рдкреЛрд░реНрдЯ рджреЗрдЦреЗрдВ</button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-secondary w-100" id="fetch-gstr3b-report-btn">GSTR-3B (рд╕рд╛рд░рд╛рдВрд╢) рджреЗрдЦреЗрдВ</button>
                        </div>
                    </div>
                    <p class="text-muted small mt-3">рдиреЛрдЯ: рдпрд╣ GSTR рд░рд┐рдкреЛрд░реНрдЯ рдЖрдкрдХреЗ рджреНрд╡рд╛рд░рд╛ 'рдмрд┐рдХреНрд░реА (POS)' рдФрд░ 'рдЧреНрд░рд╛рд╣рдХ (CRM)' рдореЗрдВ рджрд░реНрдЬ рдХрд┐рдП рдЧрдП рдбреЗрдЯрд╛ рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реИред </p>

                    <hr class="my-4">
                    
                    <h5 id="gst-report-title">рд░рд┐рдкреЛрд░реНрдЯ рд░рд┐рдЬрд▓реНрдЯ</h5>
                    <div id="gst-report-result">
                        <div class="text-muted text-center py-4">рдХреГрдкрдпрд╛ рддрд╛рд░реАрдЦ рдЪреБрдиреЗрдВ рдФрд░ рд░рд┐рдкреЛрд░реНрдЯ рдмрдЯрди рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВред</div>
                        
                        <div id="gstr1-report-template" style="display: none;">


                            
                           <!-- ============ TALLY-STYLE GST REPORT HTML START ============ -->
<!-- рдпрд╣ Tally-Style рдЯреИрдм рд▓реЗрдЖрдЙрдЯ рд╣реИ -->

<!-- Tab Navigation (GSTR-1, 2, 3B) -->
<nav class="gst-report-tabs mt-4">
    <div class="nav nav-tabs" id="gstReportTab" role="tablist">
        <button class="nav-link active" id="gst-gstr1-tab" data-bs-toggle="tab" data-bs-target="#gst-gstr1" type="button" role="tab" aria-controls="gst-gstr1" aria-selected="true">
            GSTR-1 (рдмрд┐рдХреНрд░реА)
        </button>
        <button class="nav-link" id="gst-gstr2-tab" data-bs-toggle="tab" data-bs-target="#gst-gstr2" type="button" role="tab" aria-controls="gst-gstr2" aria-selected="false">
            GSTR-2 (рдЦрд░реАрдж ITC)
        </button>
        <button class="nav-link" id="gst-gstr3b-tab" data-bs-toggle="tab" data-bs-target="#gst-gstr3b" type="button" role="tab" aria-controls="gst-gstr3b" aria-selected="false">
            GSTR-3B (рд╕рдорд░реА)
        </button>
    </div>
</nav>

<!-- Tab Content (Main Body) -->
<div class="tab-content gst-report-tab-content" id="gstReportTabContent">
    
    <!-- GSTR-1 Pane (рдпрд╣ GSTR-1 рдмрдЯрди рд╕реЗ рдЬреБрдбрд╝рд╛ рд╣реИ) -->
    <div class="tab-pane fade show active" id="gst-gstr1" role="tabpanel" aria-labelledby="gst-gstr1-tab">
        <div id="gstr1-report-content" class="report-content-area">
            <p class="text-muted text-center py-4">рдХреГрдкрдпрд╛ рдКрдкрд░ рджрд┐рдП рдЧрдП 'GSTR-1 (рдмрд┐рдХреНрд░реА) рд░рд┐рдкреЛрд░реНрдЯ рджреЗрдЦреЗрдВ' рдмрдЯрди рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВред</p>
            <!-- GSTR-1 рдбреЗрдЯрд╛ JavaScript рджреНрд╡рд╛рд░рд╛ рдпрд╣рд╛рдБ рднрд░рд╛ рдЬрд╛рдПрдЧрд╛ -->
        </div>
        
        <!-- GSTR-1 рдХреЗ рд▓рд┐рдП рдЫрд┐рдкрд╛ рд╣реБрдЖ рдЯреЗрдореНрдкрд▓реЗрдЯ (JavaScript рдЗрд╕рдХрд╛ рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд░реЗрдЧрд╛) -->
        <div id="gstr1-report-template" style="display: none;">
            <nav class="gst-report-tabs">
                <div class="nav nav-tabs" id="gstr1-inner-tab" role="tablist">
                    <button class="nav-link active" id="gstr1-b2b-tab" data-bs-toggle="tab" data-bs-target="#gstr1-b2b" type="button" role="tab">B2B (GSTIN рд╡рд╛рд▓реА рдмрд┐рдХреНрд░реА)</button>
                    <button class="nav-link" id="gstr1-b2c-tab" data-bs-toggle="tab" data-bs-target="#gstr1-b2c" type="button" role="tab">B2C (рдЫреЛрдЯреА рдмрд┐рдХреНрд░реА)</button>
                    <button class="nav-link" id="gstr1-hsn-tab" data-bs-toggle="tab" data-bs-target="#gstr1-hsn" type="button" role="tab">HSN/SAC рд╕рдорд░реА</button>
                </div>
            </nav>
            <div class="tab-content gst-report-tab-content" id="gstr1-inner-tabContent">
                <div class="tab-pane fade show active" id="gstr1-b2b" role="tabpanel">
                    <h6>GSTR-1: B2B (рдкрдВрдЬреАрдХреГрдд рдЧреНрд░рд╛рд╣рдХреЛрдВ рдХреЛ рдмрд┐рдХреНрд░реА)</h6>
                    <p class="small text-muted">рд╡рд╣ рдмрд┐рдХреНрд░реА рдЬрд╣рд╛рдБ рдЧреНрд░рд╛рд╣рдХ рдХрд╛ GSTIN рджрд░реНрдЬ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред</p>
                    <div class="table-responsive">
                        <table class="table gst-report-table" id="gstr1-b2b-table">
                            <thead><tr><th>рдЧреНрд░рд╛рд╣рдХ GSTIN</th><th class="text-left">рдЧреНрд░рд╛рд╣рдХ рдХрд╛ рдирд╛рдо</th><th>рдЗрдирд╡реЙрдЗрд╕ рдирдВ.</th><th>рдЗрдирд╡реЙрдЗрд╕ рддрд╛рд░реАрдЦ</th><th>рдЯреИрдХреНрд╕реЗрдмрд▓ рд╡реИрд▓реНрдпреВ (тВ╣)</th><th>IGST (тВ╣)</th><th>CGST (тВ╣)</th><th>SGST (тВ╣)</th></tr></thead>
                            <tbody></tbody>
                            <tfoot></tfoot>
                        </table>
                    </div>
                </div>
                <div class="tab-pane fade" id="gstr1-b2c" role="tabpanel">
                    <h6>GSTR-1: B2C(S) (рдЫреЛрдЯреА рдмрд┐рдХреНрд░реА рд╕рдорд░реА)</h6>
                    <p class="small text-muted">рд╡рд╣ рдмрд┐рдХреНрд░реА рдЬрд╣рд╛рдБ рдЧреНрд░рд╛рд╣рдХ рдХрд╛ GSTIN рджрд░реНрдЬ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ (рд░рд╛рдЬреНрдп рдФрд░ GST рджрд░ рдХреЗ рдЕрдиреБрд╕рд╛рд░)ред</p>
                    <div class="table-responsive">
                        <table class="table gst-report-table" id="gstr1-b2c-table">
                            <thead><tr><th class="text-left">рд╕рдкреНрд▓рд╛рдИ рдХрд╛ рд░рд╛рдЬреНрдп</th><th>GST рджрд░ (%)</th><th>рдЯреИрдХреНрд╕реЗрдмрд▓ рд╡реИрд▓реНрдпреВ (тВ╣)</th><th>IGST (тВ╣)</th><th>CGST (тВ╣)</th><th>SGST (тВ╣)</th><th>рдХреБрд▓ рдЯреИрдХреНрд╕ (тВ╣)</th></tr></thead>
                            <tbody></tbody>
                            <tfoot></tfoot>
                        </table>
                    </div>
                </div>
                <div class="tab-pane fade" id="gstr1-hsn" role="tabpanel">
                    <h6>GSTR-1: HSN/SAC рд╕рдорд░реА (рдмрд┐рдХреНрд░реА)</h6>
                    <p class="small text-muted">рдмреЗрдЪреЗ рдЧрдП рдЖрдЗрдЯрдо рдХреА HSN рдХреЛрдб рдХреЗ рдЕрдиреБрд╕рд╛рд░ рд╕рдорд░реАред</p>
                    <div class="table-responsive">
                        <table class="table gst-report-table" id="gstr1-hsn-table">
                            <thead><tr><th>HSN рдХреЛрдб</th><th class="text-left">рдЖрдЗрдЯрдо рдХрд╛ рдирд╛рдо</th><th>рдпреВрдирд┐рдЯ</th><th>рдорд╛рддреНрд░рд╛ (Qty)</th><th>рдЯреИрдХреНрд╕реЗрдмрд▓ рд╡реИрд▓реНрдпреВ (тВ╣)</th><th>IGST (тВ╣)</th><th>CGST (тВ╣)</th><th>SGST (тВ╣)</th><th>рдХреБрд▓ рдЯреИрдХреНрд╕ (тВ╣)</th></tr></thead>
                            <tbody></tbody>
                            <tfoot></tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GSTR-2 Pane (рдпрд╣ GSTR-2 рдмрдЯрди рд╕реЗ рдЬреБрдбрд╝рд╛ рд╣реИ) -->
    <div class="tab-pane fade" id="gst-gstr2" role="tabpanel" aria-labelledby="gst-gstr2-tab">
        <div id="gstr2-report-content" class="report-content-area">
            <p class="text-muted text-center py-4">рдХреГрдкрдпрд╛ рдКрдкрд░ рджрд┐рдП рдЧрдП 'GSTR-2 (рдЦрд░реАрдж) рд░рд┐рдкреЛрд░реНрдЯ рджреЗрдЦреЗрдВ' рдмрдЯрди рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВред</p>
            <!-- GSTR-2 рдбреЗрдЯрд╛ JavaScript рджреНрд╡рд╛рд░рд╛ рдпрд╣рд╛рдБ рднрд░рд╛ рдЬрд╛рдПрдЧрд╛ -->
        </div>
    </div>

    <!-- GSTR-3B Pane (рдпрд╣ GSTR-3B рдмрдЯрди рд╕реЗ рдЬреБрдбрд╝рд╛ рд╣реИ) -->
    <div class="tab-pane fade" id="gst-gstr3b" role="tabpanel" aria-labelledby="gst-gstr3b-tab">
        <div id="gstr3b-report-content" class="report-content-area">
            <p class="text-muted text-center py-4">рдХреГрдкрдпрд╛ рдКрдкрд░ рджрд┐рдП рдЧрдП 'GSTR-3B (рд╕рд╛рд░рд╛рдВрд╢) рджреЗрдЦреЗрдВ' рдмрдЯрди рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВред</p>
            <!-- GSTR-3B рдбреЗрдЯрд╛ JavaScript рджреНрд╡рд╛рд░рд╛ рдпрд╣рд╛рдБ рднрд░рд╛ рдЬрд╛рдПрдЧрд╛ -->
        </div>
    </div>
</div>
</section>
<!-- ============ TALLY-STYLE GST REPORT HTML END ============ -->


<section id="bank-reconciliation" class="section">
    <h2 class="mb-4 text-primary">рдмреИрдВрдХ рд░рд┐рдХреЙрдиреНрд╕рд┐рд▓реЗрд╢рди</h2>
    
    <div class="card mb-4" id="reconciliation-setup">
        <div class="card-header">
            рдирдпрд╛ рд░рд┐рдХреЙрдиреНрд╕рд┐рд▓реЗрд╢рди рд╢реБрд░реВ рдХрд░реЗрдВ
        </div>
        <div class="card-body">
            <form id="reconciliation-start-form">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="recon-statement-date" class="form-label">рдмреИрдВрдХ рд╕реНрдЯреЗрдЯрдореЗрдВрдЯ рдХреА рдЕрдВрддрд┐рдо рддрд┐рдерд┐</label>
                        <input type="date" class="form-control" id="recon-statement-date" required>
                    </div>
                    <div class="col-md-4">
                        <label for="recon-statement-balance" class="form-label">рд╕реНрдЯреЗрдЯрдореЗрдВрдЯ рдХрд╛ рдЕрдВрддрд┐рдо рдмреИрд▓реЗрдВрд╕ (тВ╣)</label>
                        <input type="number" step="0.01" class="form-control" id="recon-statement-balance" required>
                    </div>
                    <div class="col-md-4">
                        <label for="recon-statement-csv" class="form-label">рдмреИрдВрдХ рд╕реНрдЯреЗрдЯрдореЗрдВрдЯ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ (.csv)</label>
                        <input type="file" class="form-control" id="recon-statement-csv" accept=".csv" required>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <p class="text-muted small">рдпрд╣ рдлрд╝рд╛рдЗрд▓ рдЖрдк рдЕрдкрдиреЗ рдмреИрдВрдХ рдХреА рдиреЗрдЯ рдмреИрдВрдХрд┐рдВрдЧ рд╡реЗрдмрд╕рд╛рдЗрдЯ рдкрд░ 'Account Statement' > 'Download Statement' рд╕реЗрдХреНрд╢рди рд╕реЗ CSV рдлреЙрд░реНрдореЗрдЯ рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдХреГрдкрдпрд╛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ рдЙрд╕рдореЗрдВ 'Date', 'Description', 'Debit'/'Withdrawal', рдФрд░ 'Credit'/'Deposit' рдХреЙрд▓рдо рд╣реЛрдВред
                    </div>
                </div>
                <hr>
                <div class="text-end">
                    <button type="submit" class="btn btn-primary btn-lg" id="start-reconciliation-btn">
                        <i class="fas fa-play me-2"></i> рд░рд┐рдХреЙрдиреНрд╕рд┐рд▓реЗрд╢рди рд╢реБрд░реВ рдХрд░реЗрдВ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="reconciliation-matching-area" class="hidden">
        <h3 class="mb-3">рдПрдВрдЯреНрд░реАрдЬрд╝ рдХрд╛ рдорд┐рд▓рд╛рди рдХрд░реЗрдВ</h3>
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        Dukan Pro (рдмреБрдХ) рдЯреНрд░рд╛рдВрдЬреИрдХреНрд╢рди
                        <span id="book-total" class="badge bg-light text-dark float-end">тВ╣0.00</span>
                    </div>
                    <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="check-all-book"></th>
                                    <th>рд╡рд┐рд╡рд░рдг</th>
                                    <th>рд░рд╛рд╢рд┐ (тВ╣)</th>
                                </tr>
                            </thead>
                            <tbody id="book-transactions-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        рдмреИрдВрдХ рд╕реНрдЯреЗрдЯрдореЗрдВрдЯ рдЯреНрд░рд╛рдВрдЬреИрдХреНрд╢рди
                        <span id="bank-total" class="badge bg-light text-dark float-end">тВ╣0.00</span>
                    </div>
                    <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="check-all-bank"></th>
                                    <th>рд╡рд┐рд╡рд░рдг</th>
                                    <th>рд░рд╛рд╢рд┐ (тВ╣)</th>
                                </tr>
                            </thead>
                            <tbody id="bank-transactions-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header bg-dark text-white">
                рд░рд┐рдХреЙрдиреНрд╕рд┐рд▓реЗрд╢рди рд░рд┐рдкреЛрд░реНрдЯ (рд╕рд╛рд░рд╛рдВрд╢)
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <table class="table" id="reconciliation-report-table">
                            <tbody>
                                <tr>
                                    <td>рдмреИрдВрдХ рд╕реНрдЯреЗрдЯрдореЗрдВрдЯ рдХрд╛ рдЕрдВрддрд┐рдо рдмреИрд▓реЗрдВрд╕</td>
                                    <td class="text-end" id="report-statement-balance">тВ╣0.00</td>
                                </tr>
                                <tr>
                                    <td>рд╡реЗ рдкреЗрдореЗрдВрдЯреНрд╕ рдЬреЛ рдЕрднреА рдХреНрд▓рд┐рдпрд░ рдирд╣реАрдВ рд╣реБрдП (Uncleared Payments)</td>
                                    <td class="text-end" id="report-uncleared-payments">тВ╣0.00</td>
                                </tr>
                                <tr>
                                    <td>рд╡реЗ рдбрд┐рдкреЙрдЬрд┐рдЯ рдЬреЛ рдЕрднреА рдХреНрд▓рд┐рдпрд░ рдирд╣реАрдВ рд╣реБрдП (Uncleared Deposits)</td>
                                    <td class="text-end" id="report-uncleared-deposits">тВ╣0.00</td>
                                </tr>
                                <tr class="fw-bold">
                                    <td>Dukan Pro (рдмреБрдХ) рдореЗрдВ рдПрдбрдЬрд╕реНрдЯреЗрдб рдмреИрд▓реЗрдВрд╕</td>
                                    <td class="text-end" id="report-adjusted-balance">тВ╣0.00</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-4 d-flex align-items-center justify-content-center">
                        <div id="reconciliation-status-box" class="p-3 text-center">
                            <h4 id="difference-amount" class="text-danger fw-bold">тВ╣0.00 рдХрд╛ рдЕрдВрддрд░</h4>
                            <p id="difference-status" class="text-muted">рдмреИрд▓реЗрдВрд╕ рдореИрдЪ рдирд╣реАрдВ рд╣реБрдЖ</p>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="text-end">
                    <button class="btn btn-secondary" id="cancel-reconciliation-btn">рд░рджреНрдж рдХрд░реЗрдВ</button>
                    <button class="btn btn-success" id="save-reconciliation-btn" disabled>
                        <i class="fas fa-save me-2"></i> рд░рд┐рдкреЛрд░реНрдЯ рд╕реЗрд╡ рдХрд░реЗрдВ
                    </button>
                </div>
            </div>
        </div>
    </div> 
    <div class="card mt-4" id="previous-reports-area">
        <div class="card-header bg-secondary text-white">
            рдкрд┐рдЫрд▓реА рд░рд┐рдХреЙрдиреНрд╕рд┐рд▓реЗрд╢рди рд░рд┐рдкреЛрд░реНрдЯреНрд╕
        </div>
        <div class="card-body">
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>рд░рд┐рдкреЛрд░реНрдЯ ID</th>
                            <th>рд╕реНрдЯреЗрдЯрдореЗрдВрдЯ рдХреА рддрд╛рд░реАрдЦ</th>
                            <th>рдмреИрдВрдХ рдмреИрд▓реЗрдВрд╕ (тВ╣)</th>
                            <th>рдЕрдирдХреНрд▓рд┐рдпрд░рд░реНрдб рдЕрдорд╛рдЙрдВрдЯ (тВ╣)</th>
                            <th>рд╕реЗрд╡ рдХреА рдЧрдИ рддрд╛рд░реАрдЦ</th>
                        </tr>
                    </thead>
                    <tbody id="previous-reports-body">
                        <tr><td colspan="5" class="text-center text-muted">рдХреЛрдИ рдкреБрд░рд╛рдиреА рд░рд┐рдкреЛрд░реНрдЯ рдирд╣реАрдВ рдорд┐рд▓реАред</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    </section>

        <section id="daily-closing" class="section">
            <h2 class="mb-4 text-primary">рдбреЗрд▓реА рдХреНрд▓реЛрдЬрд┐рдВрдЧ</h2>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header bg-success text-white">рдЖрдЬ рдХреА рдХреНрд▓реЛрдЬрд┐рдВрдЧ рд░рди рдХрд░реЗрдВ</div>
                        <div class="card-body text-center">
                            <p>рдЖрдЬ рдХреА рд╕рднреА рдмрд┐рдХреНрд░реА, рдЦрд░реНрдЪ рдФрд░ рд▓рд╛рдн рдХреЛ рдлрд╛рдЗрдирд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреНрд▓реЛрдЬрд┐рдВрдЧ рд░рди рдХрд░реЗрдВред</p>
                            <button class="btn btn-success btn-lg" id="run-daily-closing-btn">
                                <i class="fas fa-play-circle me-2"></i> рдЖрдЬ рдХреА рдХреНрд▓реЛрдЬрд┐рдВрдЧ рд░рди рдХрд░реЗрдВ
                            </button>
                            <div id="closing-message" class="mt-3"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">рдкрд┐рдЫрд▓реА рдХреНрд▓реЛрдЬрд┐рдВрдЧ рд░рд┐рдкреЛрд░реНрдЯреНрд╕</div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>рддрд╛рд░реАрдЦ</th>
                                            <th>рдХреБрд▓ рдмрд┐рдХреНрд░реА</th>
                                            <th>рдХреБрд▓ рд▓рд╛рдЧрдд (COGS)</th>
                                            <th>рдХреБрд▓ рдЦрд░реНрдЪ</th>
                                            <th>рд╢реБрджреНрдз рд▓рд╛рдн</th>
                                        </tr>
                                    </thead>
                                    <tbody id="daily-closing-table-body">
                                        <tr><td colspan="5" class="text-center text-muted">рдХреЛрдИ рд░рд┐рдкреЛрд░реНрдЯ рдирд╣реАрдВ рдорд┐рд▓реАред</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="data-backup" class="section">
            <h2 class="mb-4 text-primary">рдбреЗрдЯрд╛ рдмреИрдХрдЕрдк (рдПрдбрдорд┐рди)</h2>
            <div class="card">
                <div class="card-header">рдЕрдкрдирд╛ рдбреЗрдЯрд╛ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ</div>
                <div class="card-body">
                    <p>рдпрд╣рд╛рдБ рдЖрдк рдЕрдкрдиреА рд╢реЙрдк рдХрд╛ рдкреВрд░рд╛ рдбреЗрдЯрд╛ рдмреИрдХрдЕрдк рдпрд╛ рд╡рд┐рд╢рд┐рд╖реНрдЯ рд░рд┐рдкреЛрд░реНрдЯ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред</p>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="card p-3 text-center">
                                <h5>рдлреБрд▓ рд╢реЙрдк рдмреИрдХрдЕрдк (JSON)</h5>
                                <p class="small text-muted">рд╕реНрдЯреЙрдХ, рдЧреНрд░рд╛рд╣рдХ, рдмрд┐рдХреНрд░реА, рдЦрд░реНрдЪ рдЖрджрд┐ рд╕рдм рдХреБрдЫред (рддрдХрдиреАрдХреА рдЙрдкрдпреЛрдЧ рдХреЗ рд▓рд┐рдП)</p>
                                <button class="btn btn-primary" id="download-json-backup-btn">
                                    <i class="fas fa-file-code"></i> JSON рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card p-3 text-center">
                                <h5>рдлреБрд▓ рд╢реЙрдк рдмреИрдХрдЕрдк (Excel)</h5>
                                <p class="small text-muted">рд╕рднреА рдбреЗрдЯрд╛ рдПрдХ Excel рдлрд╝рд╛рдЗрд▓ рдореЗрдВ (рдЕрд▓рдЧ-рдЕрд▓рдЧ рд╢реАрдЯреНрд╕ рдореЗрдВ)ред</p>
                                <button class="btn btn-success" id="download-excel-backup-btn">
                                    <i class="fas fa-file-excel"></i> Excel (.xlsx) рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card p-3 text-center">
                                <h5>рдЙрддреНрдкрд╛рдж рдмрд┐рдХреНрд░реА рд░рд┐рдкреЛрд░реНрдЯ (CSV)</h5>
                                <p class="small text-muted">рддрд╛рд░реАрдЦ-рд╡рд╛рд░ рдЙрддреНрдкрд╛рдж рдмрд┐рдХреНрд░реА рд░рд┐рдкреЛрд░реНрдЯ (CSV рдлреЙрд░реНрдореЗрдЯ)ред</p>
                                <button class="btn btn-info" id="download-product-sales-csv-btn">
                                    <i class="fas fa-file-csv"></i> CSV рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="shop-settings" class="section">
            <h2 class="mb-4 text-primary">рд╢реЙрдк рд╕реЗрдЯрд┐рдВрдЧреНрд╕ (рдПрдбрдорд┐рди)</h2>
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-info">рдХрдВрдкрдиреА рдкреНрд░реЛрдлрд╛рдЗрд▓ (GST рдФрд░ рдЗрдирд╡реЙрдЗрд╕ рдХреЗ рд▓рд┐рдП)</div>
                        <div class="card-body">
                            <form id="company-profile-form">
                                <div class="mb-3">
                                    <label for="company-legal-name" class="form-label">рд╢реЙрдк рдХрд╛ рдХрд╛рдиреВрдиреА рдирд╛рдо</label>
                                    <input type="text" class="form-control" id="company-legal-name">
                                </div>
                                <div class="mb-3">
                                    <label for="company-gstin" class="form-label">рд╢реЙрдк рдХрд╛ GSTIN</label>
                                    <input type="text" class="form-control" id="company-gstin" maxlength="15">
                                </div>
                                <div class="mb-3">
                                    <label for="company-address" class="form-label">рд╢реЙрдк рдХрд╛ рдкрддрд╛</label>
                                    <textarea class="form-control" id="company-address" rows="2"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="company-opening-capital" class="form-label">рдУрдкрдирд┐рдВрдЧ рдХреИрдкрд┐рдЯрд▓ (рд╢реБрд░реБрдЖрддреА рдкреВрдВрдЬреА)</label>
                                    <input type="number" step="0.01" class="form-control" id="company-opening-capital" value="0" min="0">
                                </div>
                                <button type="submit" class="btn btn-primary w-100">рдкреНрд░реЛрдлрд╛рдЗрд▓ рд╕реЗрд╡ рдХрд░реЗрдВ</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">рд╢реЙрдк рдбрд┐рд╕реНрдкреНрд▓реЗ рд╕реЗрдЯрд┐рдВрдЧреНрд╕</div>
                        <div class="card-body">
                            <form id="shop-display-form">
                                <div class="mb-3">
                                    <label for="shop-display-name" class="form-label">рд╢реЙрдк рдХрд╛ рдбрд┐рд╕реНрдкреНрд▓реЗ рдирд╛рдо</label>
                                    <input type="text" class="form-control" id="shop-display-name">
                                    <div class="form-text">рдпрд╣ рдирд╛рдо рд╕рд╛рдЗрдбрдмрд╛рд░ рдореЗрдВ рд╕рдмрд╕реЗ рдКрдкрд░ рджрд┐рдЦрд╛рдИ рджреЗрдЧрд╛ред</div>
                                </div>
                                <div class="mb-3">
                                    <label for="shop-logo-upload" class="form-label">рд╢реЙрдк рд▓реЛрдЧреЛ (рд╡реИрдХрд▓реНрдкрд┐рдХ)</label>
                                    <input type="file" class="form-control" id="shop-logo-upload" accept="image/png, image/jpeg">
                                    <div class="form-text">рд╕рдмрд╕реЗ рдЕрдЪреНрдЫреЗ рд░рд┐рдЬрд▓реНрдЯ рдХреЗ рд▓рд┐рдП 1:1 (рд╕реНрдХреНрд╡рд╛рдпрд░) рдЗрдореЗрдЬ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВред</div>
                                    <img id="shop-logo-preview" src="" alt="Logo Preview" class="img-thumbnail mt-2" style="max-height: 100px; display: none;">
                                </div>
                                    <button type="button" id="remove-shop-logo-btn" class="btn btn-sm btn-outline-danger mt-2 d-none" onclick="removeShopLogo()">
                                    <i class="fas fa-trash"></i> рд▓реЛрдЧреЛ рд╣рдЯрд╛рдПрдБ
                                </button>
                                <button type="submit" class="btn btn-primary w-100">рдбрд┐рд╕реНрдкреНрд▓реЗ рд╕реЗрд╡ рдХрд░реЗрдВ</button>
                            </form>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="daily_reports" class="section">
            <div class="container-fluid p-4">
                
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="fw-bold text-primary"><i class="fas fa-calendar-alt"></i> Daily & Operational Reports</h3>
                    <button class="btn btn-outline-secondary btn-sm" onclick="renderDashboard()">Back</button>
                </div>
        
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-body bg-light rounded">
                        <div class="row g-3 align-items-end">
                            
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Select Report:</label>
                                <select id="daily-report-type" class="form-select border-primary fw-bold">
                                    <option value="DAILY_SALES_LIST">ЁЯУЕ Daily Sales List</option>
                                    <option value="ITEM_WISE_SALES">ЁЯУж Item Sales Analysis</option>
                                    <option value="TOP_CUSTOMERS">ЁЯПЖ Top Customers</option>
                                    <option value="CUSTOMER_OUTSTANDING">тЪая╕П Customer Udhari</option>
                                    <option value="LOW_STOCK">ЁЯУЙ Low Stock Alert</option>
                                    <option value="EXPIRY_REPORT">ЁЯТК Expiry Report</option>
                                    <option value="DEAD_STOCK">ЁЯТА Dead Stock</option>
                                    <option value="PAINTER_COMMISSION">ЁЯОи Painter Commission</option>
                                    <option value="PAINT_MIXING_HISTORY">ЁЯЦМя╕П Mixing History</option>
                                    <option value="STAFF_PERFORMANCE">ЁЯТЗ Staff Performance</option>
                                    <option value="REPAIR_JOB_HISTORY">ЁЯЫая╕П Repair Job History (рдЬреЙрдм рдХрд╛рд░реНрдбреНрд╕)</option>
                                    <option value="DELIVERY_REPORT">ЁЯЪЪ Delivery Schedule (рдбрд┐рд▓реАрд╡рд░реА рд▓рд┐рд╕реНрдЯ)</option>
                                </select>
                            </div>
        
                            <div class="col-md-3">
                                <label class="form-label fw-bold">From:</label>
                                <input type="date" id="daily-start-date" class="form-control">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">To:</label>
                                <input type="date" id="daily-end-date" class="form-control">
                            </div>
        
                            <div class="col-md-2">
                                <button class="btn btn-primary w-100 fw-bold" onclick="generateDailyReport()">
                                    Show Data
                                </button>

                                <button class="btn btn-success w-100 fw-bold" onclick="downloadDailyReportExcel()">
                                    <i class="fas fa-file-excel"></i> Excel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
        
                <div class="card shadow border-0">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0 fw-bold text-dark" id="daily-report-title">Results</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-dark sticky-top">
                                    <tr id="daily-report-head"><th>Select a report...</th></tr>
                                </thead>
                                <tbody id="daily-report-body"> <tr><td class="text-center p-5 text-muted">No data yet.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="appToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto" id="toast-title"></strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body" id="toast-body">
                    Hello, world! This is a toast message.
                </div>
            </div>
        </div>
		
		
				<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
                <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    

<script>

    // [ тЬЕ рдЗрдиреНрд╣реЗрдВ <script> рд╢реБрд░реВ рд╣реЛрддреЗ рд╣реА рд╕рдмрд╕реЗ рдКрдкрд░ рдкреЗрд╕реНрдЯ рдХрд░реЗрдВ ]

    
// рдЧреНрд▓реЛрдмрд▓ рд╡реЗрд░рд┐рдПрдмрд▓ (рдЗрд╕реЗ рд╕рдмрд╕реЗ рдКрдкрд░ рд░рдЦреЗрдВ)
// тЬЕ GLOBAL BUSINESS TYPE


    let isMixingModeActive = false;
    let posWebSocket = null;
	let mySalesChart = null;
    let qrCodeDataUrl = null; // ЁЯЪА рдирдпрд╛: QR рдХреЛрдб рдЗрдореЗрдЬ рдбреЗрдЯрд╛ рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП
    let isWaitingForQr = false; // ЁЯЪА рдирдпрд╛: рдмрддрд╛рдПрдЧрд╛ рдХрд┐ QR рдХрд╛ рдЗрдВрддрдЬрд╝рд╛рд░ рд╣реЛ рд░рд╣рд╛ рд╣реИ
    
    function isMobile() {
    // рдЕрдЧрд░ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдЦреБрдж рдмрддрд╛рддрд╛ рд╣реИ рдХрд┐ рдпрд╣ рдореЛрдмрд╛рдЗрд▓ рд╣реИ
    try {
        if (navigator.userAgentData && navigator.userAgentData.mobile) {
            return true;
        }
    } catch (e) {}

    // рдпрд╛ рдлрд┐рд░ UserAgent рд╕реНрдЯреНрд░рд┐рдВрдЧ рдЪреЗрдХ рдХрд░реЗрдВ (Android, iPhone, etc.)
    return /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}
    
   

// ЁЯЫбя╕П MASTER CHECK: рдХреНрдпрд╛ рдпрд╣ рдХрдкреЬреЗ рдХреА рджреБрдХрд╛рди рд╣реИ?
function isGarmentBusiness() {
    // рдпрд╣рд╛рдБ рд╣рдо рдЪреЗрдХ рдХрд░реЗрдВрдЧреЗ рдХрд┐ рд╕реЗрдЯрд┐рдВрдЧ рдореЗрдВ рдмрд┐реЫрдиреЗрд╕ рдЯрд╛рдЗрдк рдХреНрдпрд╛ рд╣реИ
    // рдЕрдЧрд░ рдЖрдкрдиреЗ business type рдХрд┐рд╕реА рдФрд░ рдирд╛рдо рд╕реЗ save рдХрд┐рдпрд╛ рд╣реИ рддреЛ 'business_type' рдХреЛ рдмрджрд▓ рджреЗрдВ
    const type = localStorage.getItem('business_type') || ''; 
    
    // рдЕрдЧрд░ рдЯрд╛рдЗрдк рдореЗрдВ 'garment', 'cloth', 'fashion' рдпрд╛ 'boutique' рд╢рдмреНрдж рд╣реИ рддреЛ TRUE рдорд┐рд▓реЗрдЧрд╛
    return /garment|cloth|fashion|boutique|tailor/i.test(type);
}

// [ initPosWebSocket рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдЗрд╕ рдХреЛрдб рд╕реЗ рдмрджрд▓ рджреЗрдВ ]

// [ рдпрд╣ initPosWebSocket рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдирдпрд╛ рдХреЛрдб рд╣реИ ]

function initPosWebSocket() {
    // рдЕрдЧрд░ рдХрдиреЗрдХреНрд╢рди рдкрд╣рд▓реЗ рд╕реЗ рдЦреБрд▓рд╛ рд╣реИ, рддреЛ рдирдпрд╛ рдХреЛрдб рдорд╛рдВрдЧреЗрдВ рдФрд░ рдмрд╛рд╣рд░ рдЖ рдЬрд╛рдПрдВ
    if (posWebSocket && posWebSocket.readyState === WebSocket.OPEN) {
        posWebSocket.send(JSON.stringify({ type: 'REGISTER_POS', token: AppState.token }));
        return;
    }

    const wsUrl = __backend_url.replace('https', 'wss').replace('http', 'ws');
    posWebSocket = new WebSocket(wsUrl);

    posWebSocket.onopen = () => {
        console.log("POS WebSocket Connected");
        posWebSocket.send(JSON.stringify({ type: 'REGISTER_POS', token: AppState.token }));
    };

    posWebSocket.onmessage = (event) => {
        const data = JSON.parse(event.data);

        // =========================================================
        // ЁЯЪА NEW LOGIC: рдЪреЗрдХ рдХрд░реЗрдВ рдХрд┐ рдХреНрдпрд╛ "рдкреЗрдВрдЯ рдорд┐рдХреНрд╕рд┐рдВрдЧ" рд╡рд┐рдВрдбреЛ рдЦреБрд▓реА рд╣реИ?
        // =========================================================
        const paintModal = document.getElementById('paintMixingModal');
        const isPaintMode = paintModal && paintModal.classList.contains('show');

        // --- 1. рдкреБрд░рд╛рдиреЗ (POS Inline) рд╕реНрдХреИрдирд░ рдХреЗ рдПрд▓рд┐рдореЗрдВрдЯреНрд╕ ---
        const inlineCode = document.getElementById('inline-pairing-code');
        const inlineSpinner = document.getElementById('inline-pairing-spinner');
        const inlineStatus = document.getElementById('inline-pairing-status');
        const inlineBox = document.getElementById('inline-pairing-box');

        // --- 2. рдирдП (Paint OTP Box) рдХреЗ рдПрд▓рд┐рдореЗрдВрдЯреНрд╕ ---
        // (рдиреЛрдЯ: рд╣рдордиреЗ HTML рдореЗрдВ рдЗрдирдХреЗ ID 'paint-otp-...' рд░рдЦреЗ рдереЗ)
        const paintBox = document.getElementById('paint-otp-box');
        const paintCode = document.getElementById('paint-otp-code');
        const paintSpinner = document.getElementById('paint-otp-spinner');
        const paintStatus = document.getElementById('paint-otp-status');

        switch (data.type) {
            case 'PAIR_CODE_GENERATED':
                console.log("PAIR_CODE:", data.pairCode);
                
                if (isPaintMode) {
                    // ЁЯСЙ рдЕрдЧрд░ рдкреЗрдВрдЯ рд╕реНрдХреНрд░реАрди рдЦреБрд▓реА рд╣реИ -> рдХреЛрдб рд▓рд╛рд▓ рдмрдЯрди рд╡рд╛рд▓реЗ рдмреЙрдХреНрд╕ рдореЗрдВ рджрд┐рдЦрд╛рдПрдВ
                    if (paintBox) paintBox.style.display = 'block';
                    if (paintCode) paintCode.innerText = data.pairCode;
                    if (paintSpinner) paintSpinner.style.display = 'none';
                    if (paintStatus) paintStatus.style.display = 'none';

                    // рдкреБрд░рд╛рдиреЗ рд╡рд╛рд▓реЗ рдХреЛ рдЫрд┐рдкрд╛ рджреЗрдВ рддрд╛рдХрд┐ рдХрдиреНрдлреНрдпреВрдЬрди рди рд╣реЛ
                    if (inlineBox) inlineBox.style.display = 'none';
                } else {
                    // ЁЯСЙ рдЕрдЧрд░ рдиреЙрд░реНрдорд▓ POS рд╣реИ -> рдХреЛрдб рдкреБрд░рд╛рдиреЗ рдмреЙрдХреНрд╕ рдореЗрдВ рджрд┐рдЦрд╛рдПрдВ
                    if (inlineBox) inlineBox.style.display = 'block';
                    if (inlineCode) { inlineCode.textContent = data.pairCode; inlineCode.style.display = 'inline-block'; }
                    if (inlineSpinner) inlineSpinner.style.display = 'none';
                    if (inlineStatus) inlineStatus.style.display = 'none';

                    // рдкреЗрдВрдЯ рд╡рд╛рд▓реЗ рдХреЛ рдЫрд┐рдкрд╛ рджреЗрдВ
                    if (paintBox) paintBox.style.display = 'none';
                }
                break;

            case 'SCANNER_PAIRED':
                console.log("рд╕реНрдХреИрдирд░ рдХрдиреЗрдХреНрдЯ рд╣реЛ рдЧрдпрд╛!");
                
                // рджреЛрдиреЛрдВ рдЬрдЧрд╣реЛрдВ рдкрд░ "Success" рджрд┐рдЦрд╛рдПрдВ (рддрд╛рдХрд┐ рдпреВрдЬрд░ рдХрд╣реАрдВ рднреА рд╣реЛ рдЙрд╕реЗ рдкрддрд╛ рдЪрд▓реЗ)
                if (inlineSpinner) inlineSpinner.style.display = 'none';
                if (inlineCode) inlineCode.style.display = 'none';
                if (inlineStatus) { 
                    inlineStatus.style.display = 'block'; 
                    inlineStatus.innerHTML = '<i class="fas fa-check-circle"></i> рд╕реНрдХреИрдирд░ рдХрдиреЗрдХреНрдЯреЗрдб!';
                }

                if (paintSpinner) paintSpinner.style.display = 'none';
                if (paintStatus) {
                    paintStatus.style.display = 'block';
                    paintStatus.innerHTML = '<i class="fas fa-check-circle"></i> рдХрдиреЗрдХреНрдЯреЗрдб!';
                }
                break;

            case 'SKU_SCANNED':
                console.log("SKU рдкреНрд░рд╛рдкреНрдд рд╣реБрдЖ:", data.sku);
                // handleBarcodeScan рдЕрдкрдиреЗ рдЖрдк рддрдп рдХрд░реЗрдЧрд╛ рдХрд┐ рдПрдВрдЯреНрд░реА рд▓рд╛рд▓ рдмрдЯрди рдореЗрдВ рдЬрд╛рдиреА рд╣реИ рдпрд╛ рдХрд╛рд░реНрдЯ рдореЗрдВ
                handleBarcodeScan(data.sku); 
                break;

            case 'SCANNER_DISCONNECTED':
                // рдЕрдЧрд░ рдбрд┐рд╕реНрдХрдиреЗрдХреНрдЯ рд╣реЛ рдЬрд╛рдП, рддреЛ рджреЛрдиреЛрдВ рдЬрдЧрд╣реЛрдВ рдкрд░ рд░рд┐рд╕реЗрдЯ рдХрд░реЗрдВ
                if (inlineSpinner) inlineSpinner.style.display = 'inline-block';
                if (inlineCode) { inlineCode.textContent = '------'; inlineCode.style.display = 'inline-block'; }
                
                if (paintSpinner) paintSpinner.style.display = 'inline-block';
                if (paintCode) paintCode.innerText = '------';
                
                // рдирдпрд╛ рдХреЛрдб рдорд╛рдВрдЧреЗрдВ
                if (posWebSocket.readyState === WebSocket.OPEN) {
                    posWebSocket.send(JSON.stringify({ type: 'REGISTER_POS', token: AppState.token }));
                }
                break;
        }
    };

    posWebSocket.onclose = () => {
        console.log("WebSocket Disconnected");
        posWebSocket = null;
    };
}

// [ closePosWebSocket рдлрд╝рдВрдХреНрд╢рди рдмрджрд▓реЗрдВ ]
function closePosWebSocket() {
    if (posWebSocket) {
        posWebSocket.close();
        posWebSocket = null;
        console.log("WebSocket connection closed.");
    }
    // рд╕рд┐рд░реНрдл рдЗрдирд▓рд╛рдЗрди рдмреЙрдХреНрд╕ рдЫрд┐рдкрд╛рдПрдБ
    const inlineBox = document.getElementById('inline-pairing-box');
    if(inlineBox) inlineBox.style.display = 'none';
}


// [ рдЗрд╕реЗ рдЗрд╕рд╕реЗ рдмрджрд▓реЗрдВ ]
    function closePosWebSocket() {
        // WebSocket рдмрдВрдж рдХрд░реЗрдВ (рдЕрдЧрд░ рдЦреБрд▓рд╛ рд╣реИ)
        if (posWebSocket) {
            posWebSocket.close();
            posWebSocket = null;
            console.log("WebSocket connection closed by user.");
        }
        
        // ЁЯЪА рдирдпрд╛: Modal рдХреЛ рднреА рдмрдВрдж рдХрд░реЗрдВ (рдЕрдЧрд░ рдЦреБрд▓рд╛ рд╣реИ)
        if (pairingModalInstance) {
            pairingModalInstance.hide();
            console.log("Pairing modal hidden.");
        }
    }



   const __backend_url = 'https://dukan-pro-ultimate.onrender.com';
    const SERVER_TIMEOUT = 20000; // 20 seconds for slow connections

// ==========================================
// ЁЯЪА MISSING CONFIGURATION (рдЗрд╕реЗ рдкреЗрд╕реНрдЯ рдХрд░реЗрдВ)
// ==========================================
// ==========================================================
// ЁЯЪА MASTER BUSINESS CONFIGURATION (ALL 31 TYPES)
// ==========================================================
const MASTER_BUSINESS_CONFIG = {
    // --- 1. RETAIL & SHOPS ---
    'RETAIL': {
        name: 'General Store / Kirana',
        labels: { customer: 'Customer', stock: 'Qty' },
        features: ['expiry_date'],
        dashboard_view: 'retail_grid'
    },
    'MOBILE_SHOP': {
        name: 'Mobile & Accessories',
        labels: { customer: 'Customer', stock: 'Qty' },
        features: ['imei_scan', 'repair_status'],
        dashboard_view: 'retail_grid'
    },
    'CLOTHING': {
        name: 'Garments / Boutique',
        labels: { customer: 'Customer', stock: 'Qty' },
        features: ['size_color', 'tailoring_measurements'],
        dashboard_view: 'retail_grid'
    },
    'FURNITURE': {
        name: 'Furniture Showroom',
        labels: { customer: 'Customer', stock: 'Qty' },
        features: ['delivery_tracking', 'assembly'],
        dashboard_view: 'retail_grid'
    },
    'JEWELLERY': {
        name: 'Jewellery / Imitation',
        labels: { customer: 'Customer', stock: 'Pcs/Grams' },
        features: ['weight_calc'],
        dashboard_view: 'retail_grid'
    },
    // MASTER_BUSINESS_CONFIG рдХреЗ рдЕрдВрджрд░ рдЗрд╕реЗ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ:

    // --- 1. HARDWARE (Updated for Locks & Safes) ---
   // --- 1. HARDWARE (Updated for Locks & Safes) ---
   'HARDWARE_GENERAL': {
        name: 'Hardware, Locks & Safes',
        labels: { customer: 'Customer', stock: 'Qty/Pcs' },
        
        // ЁЯЪА рдЗрди рджреЛ рдлреАрдЪрд░реНрд╕ рд╕реЗ рдбрд┐рд▓реАрд╡рд░реА рдФрд░ рд░рд┐рдкреЗрдпрд░рд┐рдВрдЧ рдЪрд╛рд▓реВ рд╣реЛ рдЬрд╛рдПрдЧреА
        features: ['delivery_tracking', 'job_card'], 
        
        dashboard_view: 'retail_grid'
    },

    // --- 2. PAINT SHOP (Full Features) ---
    'PAINT_SHOP': {
        name: 'Paint Shop (Color Studio)',
        labels: { customer: 'Painter/Customer', stock: 'Ltr/Drum' },
        features: ['paint_mixing', 'estimate'], // рдпрд╣рд╛рдБ рдорд┐рдХреНрд╕рд░ рдФрд░ рдПрд╕реНрдЯреАрдореЗрдЯрд░ рдЪрд╛рд▓реВ рд░рд╣реЗрдЧрд╛
        dashboard_view: 'retail_grid'
    },
    'SWEET_SHOP': {
        name: 'Sweet Shop / Bakery',
        labels: { customer: 'Customer', stock: 'Kg/Pcs' },
        features: ['expiry_date', 'manufacturing_date'],
        dashboard_view: 'retail_grid'
    },
    'ELECTRONICS': {
        name: 'Electronics Showroom',
        labels: { customer: 'Customer', stock: 'Qty' },
        features: ['imei_scan', 'serial_no'],
        dashboard_view: 'retail_grid'
    },
    'SIM_STORE': {
        name: 'SIM Card & Recharge',
        labels: { customer: 'Customer', stock: 'Qty' },
        features: ['mobile_no_entry'],
        dashboard_view: 'retail_grid'
    },

    // --- 2. MEDICAL & HEALTH (Features: Prescriptions, Expiry) ---
    'PHARMACY': {
        name: 'Medical Store / Pharmacy',
        labels: { customer: 'Patient', stock: 'Strip/Box' },
        features: ['expiry_date', 'batch_no', 'doctor_ref'],
        dashboard_view: 'retail_grid'
    },
    'DOCTOR_CLINIC': {
        name: 'Doctor Clinic',
        labels: { customer: 'Patient', stock: 'Medicine' },
        features: ['prescription_pad', 'report_templates'],
        dashboard_view: 'retail_grid'
    },
    'ORTHOPEDIC': {
        name: 'Orthopedic Clinic',
        labels: { customer: 'Patient', stock: 'Equipment' },
        features: ['prescription_pad', 'xray_attach'],
        dashboard_view: 'retail_grid'
    },
    'DENTIST': {
        name: 'Dental Clinic',
        labels: { customer: 'Patient', stock: 'Kit' },
        features: ['tooth_chart', 'prescription_pad'],
        dashboard_view: 'retail_grid'
    },
    'SONOGRAPHY': {
        name: 'Sonography Centre',
        labels: { customer: 'Patient', stock: 'Consumables' },
        features: ['lmp_calc', 'report_templates'],
        dashboard_view: 'retail_grid'
    },
    'PHYSIOTHERAPY': {
        name: 'Physiotherapy Centre',
        labels: { customer: 'Patient', stock: 'Sessions' },
        features: ['appointment_booking', 'prescription_pad'],
        dashboard_view: 'retail_grid'
    },
    'PATHOLOGY': {
        name: 'Pathology Lab',
        labels: { customer: 'Patient', stock: 'Reagents' },
        features: ['report_templates', 'sample_tracking'],
        dashboard_view: 'retail_grid'
    },

    // --- 3. SERVICES & PERSONAL CARE (Special Dashboard for Salon) ---
    'SALON': {
        name: 'Luxury Salon / Spa',
        labels: { customer: 'Client', stock: 'Unit/Usage' },
        features: ['appointment_booking', 'staff_commission'],
        dashboard_view: 'salon_dashboard' // рдпрд╣ Salon Dashboard рд▓реЛрдб рдХрд░реЗрдЧрд╛
    },
    'GYM': {
        name: 'Gym / Fitness Center',
        labels: { customer: 'Member', stock: 'Supplements' },
        features: ['attendance', 'subscription_expiry'],
        dashboard_view: 'retail_grid'
    },
    'TAILOR': {
        name: 'Tailor / Boutique',
        labels: { customer: 'Customer', stock: 'Fabric' },
        features: ['tailoring_measurements', 'delivery_date'],
        dashboard_view: 'retail_grid'
    },
    'SERVICE_CENTER': {
        name: 'Repairing Center',
        labels: { customer: 'Customer', stock: 'Spare Parts' },
        features: ['job_card', 'repair_status'],
        dashboard_view: 'retail_grid'
    },

    // --- 4. HOSPITALITY & FOOD ---
    'RESTAURANT': {
        name: 'Restaurant / Cafe',
        labels: { customer: 'Guest', stock: 'Ingredients' },
        features: ['table_kot', 'kitchen_display'],
        dashboard_view: 'retail_grid'
    },
    'HOTEL': {
        name: 'Hotel / Lodging',
        labels: { customer: 'Guest', stock: 'Amenities' },
        features: ['room_checkin', 'table_kot'],
        dashboard_view: 'retail_grid'
    },
    'TENT_HOUSE': {
        name: 'Tent House / Rentals',
        labels: { customer: 'Customer', stock: 'Item' },
        features: ['rental_dates', 'security_deposit'],
        dashboard_view: 'retail_grid'
    },

    // --- 5. CONSTRUCTION & TRANSPORT ---
    'TILES_CERAMIC': {
        name: 'Tiles & Sanitaryware',
        labels: { customer: 'Customer', stock: 'Box/Sq.Ft' },
        features: ['sqft_calc', 'breakage_entry'],
        dashboard_view: 'retail_grid'
    },
    'TRANSPORT': {
        name: 'Transport / Logistics',
        labels: { customer: 'Party/Client', stock: 'Vehicle' },
        features: ['trip_management', 'fuel_expense'],
        dashboard_view: 'retail_grid'
    },

    // --- 6. FINANCE & AGENTS ---
    'LOAN_DSA': {
        name: 'Loan / Credit Card DSA',
        labels: { customer: 'Applicant', stock: 'File' },
        features: ['geo_tagging', 'commission_calc', 'loan_status'],
        dashboard_view: 'retail_grid'
    },
    'RECOVERY_AGENT': {
        name: 'Recovery / Collection',
        labels: { customer: 'Borrower', stock: 'Case' },
        features: ['geo_tagging', 'recovery_collection', 'visit_log'],
        dashboard_view: 'retail_grid'
    },
    'INSURANCE_AGENCY': {
        name: 'Insurance Agent',
        labels: { customer: 'Policy Holder', stock: 'Policy' },
        features: ['renewal_date', 'commission_calc'],
        dashboard_view: 'retail_grid'
    },

    // --- 7. EDUCATION & OFFICE ---
    'SCHOOL': {
        name: 'School / Coaching',
        labels: { customer: 'Student', stock: 'Books/Uniform' },
        features: ['fees_management', 'attendance'],
        dashboard_view: 'retail_grid'
    },
    'ARCHITECT_FIRM': {
        name: 'Architect / Interior',
        labels: { customer: 'Client', stock: 'Material' },
        features: ['project_billing', 'site_visit'],
        dashboard_view: 'retail_grid'
    },
    'SOFTWARE_COMPANY': {
        name: 'Software / IT Firm',
        labels: { customer: 'Client', stock: 'License' },
        features: ['project_billing', 'amc_renewal'],
        dashboard_view: 'retail_grid'
    }
};

    const AppState = {
        token: null,     // Will store the JWT
        user: null,      // Will store user info (id, email, role, shopId)
        currentView: 'dashboard',
        licenseTimerId: null, // NEW: To store the license timer
    };
    
    // --- INVOICE GENERATOR PRO VARIABLES ---
    let items = [];
    let qrCodeImage = '';

    // --- POS (SALES) SECTION STATE ---
    let posCart = [];
    let currentStock = [];
    
    // --- CORE UTILITY FUNCTIONS ---
    const showLoader = (message = 'рдбреЗрдЯрд╛ рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...') => {
        document.getElementById('loading-message').innerText = message;
        document.getElementById('loading-overlay').classList.remove('hidden');
    };

    const hideLoader = () => {
        document.getElementById('loading-overlay').classList.add('hidden');
    };
    

/* ==============================================
   ЁЯУ▒ MOBILE TABLE FIX (STICKY ACTIONS)
   ============================================== */
   /* ==============================================
   ЁЯУ▒ MOBILE TABLE FIX (STICKY ACTIONS)
   ============================================== */


// [ рдпрд╣ рдХреЛрдб рдЕрдкрдиреЗ HTML рдХреА <script> рдореЗрдВ рдбрд╛рд▓реЗрдВ ]

    let dashboardSocket = null; // Dashboard WebSocket рдХреЗ рд▓рд┐рдП рдирдпрд╛ рд╡реЗрд░рд┐рдПрдмрд▓

/**
 * ЁЯЪА NAYA: Live Dashboard WebSocket рдХреЛ рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИ
 */
function initDashboardSocket() {
    // рдЕрдЧрд░ рдкрд╣рд▓реЗ рд╕реЗ рдХрдиреЗрдХреНрдЯ рд╣реИ, рддреЛ рдХреБрдЫ рди рдХрд░реЗрдВ
    if (dashboardSocket && dashboardSocket.readyState === WebSocket.OPEN) {
        return;
    }

    // рд╕рд░реНрд╡рд░ URL рдХреЛ http рд╕реЗ ws/wss рдореЗрдВ рдмрджрд▓реЗрдВ
    const wsUrl = __backend_url.replace('https', 'wss').replace('http', 'ws');
    dashboardSocket = new WebSocket(wsUrl);

    // 1. рдХрдиреЗрдХреНрд╢рди рдЦреБрд▓рдиреЗ рдкрд░
    dashboardSocket.onopen = () => {
        console.log("тЬЕ Live Dashboard WebSocket рдХрдиреЗрдХреНрдЯ рд╣реЛ рдЧрдпрд╛ред");
        // рд╕рд░реНрд╡рд░ рдХреЛ рдЕрдкрдирд╛ рдЯреЛрдХрди рднреЗрдЬрдХрд░ рдЦреБрдж рдХреЛ рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд░реЗрдВ
        dashboardSocket.send(JSON.stringify({
            type: 'REGISTER_DASHBOARD',
            token: AppState.token // рдЖрдкрдХрд╛ рд▓реЙрдЧрд┐рди рдЯреЛрдХрди
        }));
    };

    // 2. рд╕рд░реНрд╡рд░ рд╕реЗ рдореИрд╕реЗрдЬ рдорд┐рд▓рдиреЗ рдкрд░
    dashboardSocket.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === 'DASHBOARD_REGISTERED') {
            console.log("рд╕рд░реНрд╡рд░ рдиреЗ рдкреБрд╖реНрдЯрд┐ рдХреА:", data.message);
        }

        // 3. ЁЯЪА рдпрд╣ рд╕рдмрд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ!
        if (data.type === 'DASHBOARD_UPDATE') {
            console.log('ЁЯФе Live Update рдкреНрд░рд╛рдкреНрдд рд╣реБрдЖ! рдбреЗрдЯрд╛ рд░реАрдлреНрд░реЗрд╢ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ...', data.view);
            
            // (рдПрдХ рдЫреЛрдЯрд╛ рд╕рд╛ рдореИрд╕реЗрдЬ рджрд┐рдЦрд╛рдПрдБ)
            showMessage('рд▓рд╛рдЗрд╡ рдЕрдкрдбреЗрдЯ', `рдПрдХ рдирдИ '${data.view}' рджрд░реНрдЬ рд╣реБрдИ рд╣реИ, рдбреИрд╢рдмреЛрд░реНрдб рдЕрдкрдбреЗрдЯ рд╣реЛ рд░рд╣рд╛ рд╣реИ...`, 'info');

            // 4. рдЕрдкрдиреЗ рдбреИрд╢рдмреЛрд░реНрдб рдХреЛ рд░реАрдлреНрд░реЗрд╢ рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рдореБрдЦреНрдп рдлрдВрдХреНрд╢рди рдЪрд▓рд╛рдПрдБ
            // (рдпрд╣ рдлрдВрдХреНрд╢рди рдЖрдкрдХреЗ HTML рдореЗрдВ рдкрд╣рд▓реЗ рд╕реЗ рдореМрдЬреВрдж рд╣реИ)
            if (typeof renderDashboard === 'function') {
                renderDashboard();
            }
            
            // (рд╡реИрдХрд▓реНрдкрд┐рдХ: рдпрджрд┐ рдЖрдк рдХреЗрд╡рд▓ рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╣рд┐рд╕реНрд╕реЛрдВ рдХреЛ рд░реАрдлреНрд░реЗрд╢ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ)
            // if (data.view === 'sales' && typeof fetchAndRenderSales === 'function') {
            //     fetchAndRenderSales();
            // }
        }
    };

    // 3. рдХрдиреЗрдХреНрд╢рди рдмрдВрдж рд╣реЛрдиреЗ рдкрд░
    dashboardSocket.onclose = () => {
        console.log("тЭМ Live Dashboard WebSocket рдбрд┐рд╕реНрдХрдиреЗрдХреНрдЯ рд╣реЛ рдЧрдпрд╛ред 5 рд╕реЗрдХрдВрдб рдореЗрдВ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛...");
        dashboardSocket = null;
        // 5 рд╕реЗрдХрдВрдб рдмрд╛рдж рдлрд┐рд░ рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВ
        setTimeout(initDashboardSocket, 5000);
    };

    // 4. рдПрд░рд░ рд╣реЛрдиреЗ рдкрд░
    dashboardSocket.onerror = (error) => {
        console.error("WebSocket Error:", error);
        dashboardSocket.close(); // рдмрдВрдж рдХрд░реЗрдВ (onclose рдЗрд╕реЗ рд░реАрд╕реНрдЯрд╛рд░реНрдЯ рдХрд░реЗрдЧрд╛)
    };
}
/**
 * рд╕реНрдХреИрди рдХрд┐рдП рдЧрдП рдбреЗрдЯрд╛ рдХреЛ рд╣реИрдВрдбрд▓ рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рдлрд╝рдВрдХреНрд╢рдиред
 */
// рдмрджрд▓рдиреЗ рд╡рд╛рд▓рд╛ рдХреЛрдб: handleBarcodeScan (рдкреВрд░рд╛ рдлрдВрдХреНрд╢рди рдмрджрд▓реЗрдВ)
// рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдпрд╣ рдлрд╝рдВрдХреНрд╢рди рдЗрдирдкреБрдЯ рд╕реЗ рдпрд╛ рдореЛрдмрд╛рдЗрд▓ рд╕реНрдХреИрдирд░ рд╕реЗ SKU рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рддрд╛ рд╣реИред
// [ тЬЕ Is Poore Naye "Smart Scan" Code ko Line 2307 par Paste Karein ]

/**
 * NAYA "SMART SCAN" HANDLER (Point 1, 2, 4)
 * Yeh function sab kuchh handle karta hai:
 * 1. Physical scanner (null SKU)
 * 2. WebSocket scanner (scanned SKU)
 * 3. Smart QR (JSON data)
 * 4. Naya item (404 Error)
 */
 // [ тЬЕ ULTRA-SMART SCANNER FUNCTION - рдЗрд╕реЗ рдкреЗрд╕реНрдЯ рдХрд░реЗрдВ ]

 async function handleBarcodeScan(skuFromScanner = null) {
    let scannedData;

    // 1. рдЗрдирдкреБрдЯ рд╕реЛрд░реНрд╕ рдЪреЗрдХ рдХрд░реЗрдВ
    if (skuFromScanner) {
        scannedData = skuFromScanner;
    } else {
        const barcodeInput = document.getElementById('barcode-scanner-input');
        if (barcodeInput) {
            scannedData = barcodeInput.value.trim();
            barcodeInput.value = ''; 
        }
    }

    if (!scannedData) return; 

    // =========================================================
    // ЁЯЪА NEW: рдкреЗрдВрдЯ рдорд┐рдХреНрд╕рд┐рдВрдЧ рд▓реЙрдЬрд┐рдХ (Safe Mode)
    // =========================================================
    const paintModal = document.getElementById('paintMixingModal');
    
    // рдЪреЗрдХ: рдХреНрдпрд╛ рдореЛрдбрд▓ рдЦреБрд▓рд╛ рд╣реИ рдпрд╛ рдлреНрд▓реИрдЧ рдПрдХреНрдЯрд┐рд╡ рд╣реИ?
    const isPaintOpen = paintModal && (paintModal.classList.contains('show') || (typeof isMixingModeActive !== 'undefined' && isMixingModeActive));

    if (isPaintOpen) {
        // рдЕрдЧрд░ рд╕реНрдХреНрд░реАрди рдЧрд▓рддреА рд╕реЗ рдмрдВрдж рд╣реИ, рддреЛ рд╡рд╛рдкрд╕ рдЦреЛрд▓реЗрдВ
        if (paintModal && !paintModal.classList.contains('show')) {
            const modalInstance = new bootstrap.Modal(paintModal);
            modalInstance.show();
        }

        // рд╕реНрдЯреЙрдХ рдЪреЗрдХ рдХрд░реЗрдВ
        const existingItem = (typeof currentStock !== 'undefined') ? currentStock.find(s => s.sku === scannedData) : null;

        if (existingItem) {
            // тЬЕ рдЖрдЗрдЯрдо рдорд┐рд▓ рдЧрдпрд╛ -> рд▓рд╛рд▓ рд╕реНрдХреНрд░реАрди рдореЗрдВ рднрд░реЗрдВ
            const baseSkuInput = document.getElementById('mix-base-sku');
            if(baseSkuInput) baseSkuInput.value = scannedData;
            
            if (typeof fetchBaseDetails === 'function') {
                fetchBaseDetails(scannedData);
            }
            
            if (typeof showMessage === 'function') {
                showMessage('рд╕реНрдХреИрди рд╕рдлрд▓', 'рдмреЗрд╕: ' + existingItem.name + ' рд▓реЛрдб рд╣реЛ рдЧрдпрд╛', 'success');
            }

        } else {
            // тЭМ рдЖрдЗрдЯрдо рдирд╣реАрдВ рдорд┐рд▓рд╛
            if (typeof stopLocalScanner === 'function') stopLocalScanner();

            if(confirm('рдЖрдЗрдЯрдо (SKU: ' + scannedData + ') рд╕реНрдЯреЙрдХ рдореЗрдВ рдирд╣реАрдВ рдорд┐рд▓рд╛ред\nрдХреНрдпрд╛ рдЖрдк рдЗрд╕реЗ рдЕрднреА рдирдпрд╛ рдЬреЛрдбрд╝рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?')) {
                const quickModalEl = document.getElementById('quickAddItemModal');
                if (quickModalEl) {
                    const quickAddModal = new bootstrap.Modal(quickModalEl);
                    document.getElementById('quick-add-item-form').reset();
                    document.getElementById('quick-add-sku').value = scannedData;
                    quickAddModal.show();
                    
                    quickModalEl.addEventListener('shown.bs.modal', function() {
                        document.getElementById('quick-add-name').focus();
                    }, { once: true });
                }
            }
        }
        
        // рдХреИрдорд░рд╛ рдмрдВрдж рдХрд░реЗрдВ рдФрд░ рдлреНрд▓реИрдЧ рд╣рдЯрд╛рдПрдВ
        if (typeof stopLocalScanner === 'function') stopLocalScanner();
        if (typeof isMixingModeActive !== 'undefined') isMixingModeActive = false;
        
        return; // рдкреЗрдВрдЯ рдХрд╛ рдХрд╛рдо рдЦрддреНрдо, рдпрд╣реАрдВ рд░реБрдХреЗрдВ
    }

    // =========================================================
    // ЁЯЪА Normal Billing / Smart QR Logic (Old Code)
    // =========================================================
    if (scannedData.startsWith('{') && scannedData.endsWith('}')) {
        try {
            const itemData = JSON.parse(scannedData);
            if (itemData.sku && itemData.name && itemData.sale_price) {
                if(typeof showLoader === 'function') showLoader('Smart QR Processing...');
                
                try {
                    const res = await fetchApi('/api/stock', {
                        method: 'POST',
                        body: {
                            sku: itemData.sku,
                            name: itemData.name,
                            sale_price: itemData.sale_price,
                            purchase_price: itemData.purchase_price || 0,
                            quantity: 1,
                            unit: 'Pcs',
                            product_attributes: {
                                "Size": itemData.size || "N/A",
                                "Color": itemData.color || "N/A"
                            }
                        }
                    }, null);

                    const finalItem = (res.success && res.stock) ? res.stock : itemData;
                    if(typeof currentStock !== 'undefined') {
                        const existingIdx = currentStock.findIndex(s => s.sku === finalItem.sku);
                        if (existingIdx > -1) currentStock[existingIdx] = { ...currentStock[existingIdx], ...finalItem };
                        else currentStock.push(finalItem);
                    }
                } catch (err) {
                    console.log("Server save skipped, adding to local cart.");
                    if(typeof currentStock !== 'undefined') {
                        currentStock.push({...itemData, quantity: 100});
                    }
                }

                if(typeof addSKUToCart === 'function') addSKUToCart(itemData.sku);
                if(typeof hideLoader === 'function') hideLoader();
                if(typeof showMessage === 'function') showMessage('рд╕рдлрд▓рддрд╛', 'Smart QR Added!', 'success');
                return;
            }
        } catch (e) {
            console.warn("QR JSON Parse Error", e);
        }
    }

    // Standard Barcode Check
    try {
        const stockItem = await fetchApi('/api/get-stock-item/' + scannedData, { method: 'GET' }, null);

        if (stockItem.success) {
            if(typeof addSKUToCart === 'function') addSKUToCart(scannedData);
        } else {
            throw new Error(stockItem.message);
        }

    } catch (error) {
        if (error.message.includes('404') || error.message.includes('рдирд╣реАрдВ рдорд┐рд▓рд╛')) {
            const modalElement = document.getElementById('quickAddItemModal');
            if (modalElement) {
                const quickAddModal = new bootstrap.Modal(modalElement);
                document.getElementById('quick-add-item-form').reset();
                document.getElementById('quick-add-sku').value = scannedData;
                quickAddModal.show();
                modalElement.addEventListener('shown.bs.modal', function() {
                    document.getElementById('quick-add-name').focus();
                }, { once: true });
            }
        } else {
            if(typeof showMessage === 'function') showMessage('рддреНрд░реБрдЯрд┐', 'Scan Error: ' + error.message, 'danger');
        }
    }
}


   // [ тЬЕ Is Poore Naye Code ko Line 2290 par Paste Karein ]

// Global variable naye (Kadam 7) local scanner ke liye
let localScanControls = null;
let localScannerModalInstance = null;

/**
 * KADAM 7: Naya "Smart Scan" Button Logic
 * Yeh check karta hai ki user computer par hai ya mobile par
 */
function openMobileScanner() {
    if (isMobile()) {
        // SCENARIO 1: User mobile par hai
        // -> Direct isi mobile ka camera kholein
        console.log("Mobile device detected. Opening local camera scanner...");
        startLocalScanner();
    } else {
        // SCENARIO 2: User computer par hai
        // -> Purana WebSocket pairing system chalu karein
        console.log("Desktop device detected. Opening WebSocket pairing modal...");

        // (Yeh aapka purana 'openMobileScanner' function ka code hai)
        const inlineBox = document.getElementById('inline-pairing-box');
        if (!inlineBox) {
            console.error("Inline pairing box not found!");
            return;
        }
        inlineBox.style.display = 'block';
        const spinner = document.getElementById('inline-pairing-spinner');
        const codeDisplay = document.getElementById('inline-pairing-code');
        const statusDisplay = document.getElementById('inline-pairing-status');
        if(spinner) spinner.style.display = 'inline-block';
        if(codeDisplay) codeDisplay.textContent = '------';
        if(statusDisplay) statusDisplay.style.display = 'none';
        initPosWebSocket(); //
    }
}

/**
 * KADAM 7: Local Mobile Camera ko Chalu Karta Hai
 */
// [ тЬЕ YEH NAYA 'startLocalScanner' FUNCTION HAI (html5-qrcode ke liye) ]

// [ тЬЕ рдЗрд╕ рдЕрдкрдбреЗрдЯреЗрдб рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдкреБрд░рд╛рдиреЗ startLocalScanner рдХреА рдЬрдЧрд╣ рдкреЗрд╕реНрдЯ рдХрд░реЗрдВ ]

async function startLocalScanner() {
    if (!localScannerModalInstance) {
        localScannerModalInstance = new bootstrap.Modal(document.getElementById('localScannerModal'));
    }
    localScannerModalInstance.show();

    const messageEl = document.getElementById('local-scanner-message');

    try {
        localScanControls = new Html5Qrcode("local-scanner-video");

        const onScanSuccess = (decodedText, decodedResult) => {
            console.log("Local Scan Result:", decodedText);
            stopLocalScanner(); 
            handleBarcodeScan(decodedText); 
        };

        const onScanFailure = (error) => {
            // рдорд╛рдЗрдирд░ рдПрд░рд░ рдХреЛ рдЗрдЧреНрдиреЛрд░ рдХрд░реЗрдВ
        };

        messageEl.innerText = "рдХреИрдорд░рд╛ рд╢реБрд░реВ рд╣реЛ рд░рд╣рд╛ рд╣реИ...";
        messageEl.style.display = 'block';

        // ЁЯЪА рдмрджрд▓рд╛рд╡ рдпрд╣рд╛рдБ рд╣реИ: рдмрд╛рд░рдХреЛрдб рдХреЗ рд▓рд┐рдП 'config' рдХреЛ рдмреЗрд╣рддрд░ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ
        const config = { 
            fps: 10, 
            // 1. qrbox рдХреЛ 'рдЪреМрдбрд╝рд╛' (Rectangular) рдмрдирд╛рдПрдВ рддрд╛рдХрд┐ рд▓рдВрдмрд╛ рдмрд╛рд░рдХреЛрдб рдлрд┐рдЯ рд╣реЛ рд╕рдХреЗ
            qrbox: { width: 300, height: 150 }, 
            // 2. рдореЛрдмрд╛рдЗрд▓ рдкрд░ рдмреЗрд╣рддрд░ рдлреЛрдХрд╕ рдХреЗ рд▓рд┐рдП
            aspectRatio: 1.0 
        };

        await localScanControls.start(
            { facingMode: "environment" }, 
            config,
            onScanSuccess,
            onScanFailure
        );

        messageEl.style.display = 'none';

        document.getElementById('local-scanner-close-btn').onclick = stopLocalScanner;
        document.getElementById('local-scanner-cancel-btn').onclick = stopLocalScanner;

    } catch (e) {
        console.error("Scanner Error:", e);
        showMessage('рдХреИрдорд░рд╛ рдПрд░рд░', `рдХреИрдорд░рд╛ рд╢реБрд░реВ рдирд╣реАрдВ рд╣реЛ рд╕рдХрд╛: ${e.message}`, 'danger');
        stopLocalScanner();
    }
}



/**
 * KADAM 7: Local Mobile Camera ko Band Karta Hai
 */
// [ тЬЕ YEH NAYA 'stopLocalScanner' FUNCTION HAI (html5-qrcode ke liye) ]

function stopLocalScanner() {
    if (localScanControls && localScanControls.isScanning) {
        localScanControls.stop().then(() => {
            console.log("html5-qrcode scanner stopped.");
            localScanControls.clear();
            localScanControls = null;
        }).catch(err => {
            console.error("Failed to stop html5-qrcode scanner: ", err);
            // Force clear
            localScanControls.clear();
            localScanControls = null;
        });
    }
    if (localScannerModalInstance) {
        localScannerModalInstance.hide(); // Modal band karein
    }
    document.getElementById('local-scanner-message').style.display = 'none';
}

    function formatCurrency(amount) {
        if (amount === null || amount === undefined) return 'тВ╣0.00';
        return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 2 }).format(amount);
    }
    
// [ тЬЕ 1. рдЗрд╕ рдирдП рдлрд╝рдВрдХреНрд╢рди рдХреЛ formatCurrency рдХреЗ рдмрд╛рдж (рд▓рд╛рдЗрди 2203 рдХреЗ рдЖрд╕рдкрд╛рд╕) рдкреЗрд╕реНрдЯ рдХрд░реЗрдВ ]

function sendWhatsAppMessage(phone, name) {
        if (!phone || phone === 'N/A') {
            return showMessage('рддреНрд░реБрдЯрд┐', 'рдЗрд╕ рдЧреНрд░рд╛рд╣рдХ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рдлрд╝реЛрди рдирдВрдмрд░ рд╕реЗрд╡ рдирд╣реАрдВ рд╣реИред', 'danger');
        }

        // рдлрд╝реЛрди рдирдВрдмрд░ рдХреЛ рд╕рд╛рдлрд╝ рдХрд░реЗрдВ рдФрд░ '91' (India code) рдЬреЛрдбрд╝реЗрдВ
        let cleanPhone = phone.replace(/[^0-9]/g, ''); // рд╕рд┐рд░реНрдл рдирдВрдмрд░ рд░рдЦреЗрдВ
        
        if (cleanPhone.length === 10) {
            cleanPhone = '91' + cleanPhone; // 10 рдЕрдВрдХреЛрдВ рд╡рд╛рд▓реЗ рдирдВрдмрд░ рдкрд░ 91 рд▓рдЧрд╛рдПрдБ
        } else if (cleanPhone.length === 12 && cleanPhone.startsWith('91')) {
            // рдирдВрдмрд░ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рд╕рд╣реА рд╣реИ (91XXXXXXXXXX)
        } else {
            // рдЕрдорд╛рдиреНрдп рдирдВрдмрд░
            return showMessage('рддреНрд░реБрдЯрд┐', `рдпрд╣ рдПрдХ рдЕрдорд╛рдиреНрдп рдлрд╝реЛрди рдирдВрдмрд░ (${phone}) рд╣реИред`, 'warning');
        }

        const message = `рдирдорд╕реНрддреЗ ${name},`; // рдЖрдк рдореИрд╕реЗрдЬ рдХреЛ рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВ
        const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
        
        // WhatsApp рдХреЛ рдирдП рдЯреИрдм рдореЗрдВ рдЦреЛрд▓реЗрдВ
        window.open(whatsappUrl, '_blank');
    }

    // NEW: Function to format dates as YYYY-MM-DD
    function getISODate(date = new Date()) {
        return date.toISOString().split('T')[0];
    }

    const showMessage = (title, body, type = 'primary') => {
        const toastElement = document.getElementById('appToast');
        const toastTitle = document.getElementById('toast-title');
        const toastBody = document.getElementById('toast-body');
        
        toastTitle.innerText = title;
        toastBody.innerText = body;
        toastElement.querySelector('.toast-header').className = `toast-header bg-${type} text-white`;
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
    };

    // [REPLACE THIS FUNCTION IN HTML <script>]


      

        async function fetchApi(path, options = {}, loadingMessage = 'рдбреЗрдЯрд╛ рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...') {
        showLoader(loadingMessage);
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), SERVER_TIMEOUT);

        // get token
        const token = AppState.token || localStorage.getItem('authToken');

        // start with default headers, keep any provided headers
        const headers = {
            'Content-Type': 'application/json',
            ...options.headers,
        };

        if (token) headers['Authorization'] = `Bearer ${token}`;

        // Prepare body:
        let body = options.body === undefined ? null : options.body;

        // If body is FormData -> let fetch set Content-Type (remove header)
        if (body instanceof FormData) {
            delete headers['Content-Type'];
        } else if (body !== null) {
            // If user already passed a string (JSON string), use it as-is
            if (typeof body === 'string') {
                // assume valid JSON string
            } else {
                // otherwise stringify a plain object / number / array safely
                try {
                    body = JSON.stringify(body);
                } catch (err) {
                    // fallback: keep as-is (so we don't break existing behaviour)
                    console.warn('fetchApi: body stringify failed, sending raw body', err);
                }
            }
        }

        try {
            const response = await fetch(__backend_url + path, {
                ...options,
                headers,
                body,
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            // try parse JSON even if body empty
            const text = await response.text().catch(() => '');
            let responseData = {};
            try { responseData = text ? JSON.parse(text) : {}; } catch (e) { responseData = {}; }

            if (!response.ok) {
                // ЁЯЪА FIX: рд╕рд┐рд░реНрдл 401 (Invalid Token) рдкрд░ рд▓реЙрдЧрдЖрдЙрдЯ рдХрд░реЗрдВ
                if (response.status === 401) {
                    showMessage('рд╕рддреНрд░ рд╕рдорд╛рдкреНрдд', 'рдЖрдкрдХрд╛ рд╕рддреНрд░ рд╕рдорд╛рдкреНрдд рд╣реЛ рдЧрдпрд╛ рд╣реИред рдХреГрдкрдпрд╛ рдкреБрдирдГ рд▓реЙрдЧрд┐рди рдХрд░реЗрдВред', 'danger');
                    logout();
                }
                
                // 403 (Plan Locked) рдпрд╛ рдЕрдиреНрдп рдПрд░рд░ рдкрд░ рд╕рд┐рд░реНрдл рдПрд░рд░ рдлреЗрдВрдХреЗрдВ (рддрд╛рдХрд┐ рдХреИрдЪ рдмреНрд▓реЙрдХ рдЙрд╕реЗ рд╕рдВрднрд╛рд▓ рд▓реЗ)
                // рдЗрд╕рд╕реЗ рд▓реЙрдЧрдЖрдЙрдЯ рдирд╣реАрдВ рд╣реЛрдЧрд╛
                throw new Error(responseData.message || `рд╕рд░реНрд╡рд░ рдПрд░рд░: ${response.status}`);
            }

            return responseData;

        } catch (error) {
            // ============================================================
            // ЁЯЪА NEW UPDATION: OFFLINE LOGIC ADDED HERE
            // ============================================================
            if (!navigator.onLine && options.method && options.method !== 'GET') {
                // рдЕрдЧрд░ рдиреЗрдЯ рдирд╣реАрдВ рд╣реИ рдФрд░ рд╣рдо рдХреБрдЫ рд╕реЗрд╡ (POST/PUT/DELETE) рдХрд░ рд░рд╣реЗ рд╣реИрдВ
                // рддреЛ рдЙрд╕реЗ рд▓реЛрдХрд▓ рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рд╕реЗрд╡ рдХрд░ рд▓реЛ
                saveOfflineRequest(path, options.method, options.body);
                
                // рдпреВрдЬрд░ рдХреЛ рдПрд░рд░ рди рджрд┐рдЦрд╛рдХрд░ success return рдХрд░реЛ рддрд╛рдХрд┐ рдРрдк рди рд░реБрдХреЗ
                return { success: true, message: "тЪая╕П рдСрдлрд▓рд╛рдЗрди: рдбреЗрдЯрд╛ рдХрддрд╛рд░ рдореЗрдВ рд╣реИ (Queued)" };
            }
            // ============================================================

            if (error.name === 'AbortError') throw new Error('рд╕рд░реНрд╡рд░ рд╕реЗ рдХрдиреЗрдХреНрдЯ рд╣реЛрдиреЗ рдореЗрдВ рдмрд╣реБрдд рд╕рдордп рд▓рдЧрд╛ред');
            throw error;
        } finally {
            hideLoader();
        }
    }
// ==========================================================
// ========== ЁЯЪАЁЯЪАЁЯЪА NAYA PLAN LOCK LOGIC (YAHAN PASTE KAREIN) ЁЯЪАЁЯЪАЁЯЪА ==========
// ==========================================================

/**
 * Client-side checkPlan: 
 * рдпрд╣ рд╕рд░реНрд╡рд░ ('checkPlan') рд▓реЙрдЬрд┐рдХ рдХреА рдирдХрд▓ рдХрд░рддрд╛ рд╣реИ, рдпрд╣ AppState.user рд╕реЗ рдкрдврд╝рддрд╛ рд╣реИред
 */
 function checkUserPlan(requiredPlans, requiredAddOn = null) {
    const plans = { 'PREMIUM': 4, 'ONE_TIME': 4, 'MEDIUM': 3, 'BASIC': 2, 'TRIAL': 1 };

    if (!AppState.user) return false; // рдпреВрдЬрд╝рд░ рд▓реЛрдб рдирд╣реАрдВ рд╣реБрдЖ

    const userPlan = AppState.user.plan_type || 'TRIAL';
    const userPlanLevel = plans[userPlan.toUpperCase()] || 0;
    const userAddOns = AppState.user.add_ons || {};
    const expiryDate = AppState.user.licenseExpiryDate ? new Date(AppState.user.licenseExpiryDate) : null;
    const now = new Date();

    // 1. рд▓рд╛рдЗрд╕реЗрдВрд╕ рдЪреЗрдХ рдХрд░реЗрдВ
    if (!expiryDate || expiryDate < now) {
        return false; // рд▓рд╛рдЗрд╕реЗрдВрд╕ рдПрдХреНрд╕рдкрд╛рдпрд░ рд╣реИ
    }

    // 2. рдЯреНрд░рд╛рдпрд▓ рдкреНрд▓рд╛рди рдЪреЗрдХ рдХрд░реЗрдВ (рд╕рдм рдХреБрдЫ рдЕрд▓рд╛рдК рдХрд░реЗрдВ)
    if (userPlan === 'TRIAL') {
        return true;
    }

    // 3. рдореБрдЦреНрдп рдкреНрд▓рд╛рди рд▓реЗрд╡рд▓ рдЪреЗрдХ рдХрд░реЗрдВ (Medium/Premium)
    const isPlanAuthorized = requiredPlans.some(plan => {
        const requiredLevel = plans[plan.toUpperCase()] || 0;
        return userPlanLevel >= requiredLevel;
    });

    if (isPlanAuthorized) {
        return true; // рдкреНрд▓рд╛рди рд╕рд╣реА рд╣реИ
    }

    // 4. рдРрдб-рдСрди рдЪреЗрдХ рдХрд░реЗрдВ (Basic + AddOn)
    if (requiredAddOn && userPlan === 'BASIC' && userAddOns[requiredAddOn] === true) {
        return true; // рдмреЗрд╕рд┐рдХ рдпреВрдЬрд╝рд░ рдХреЗ рдкрд╛рд╕ рдРрдб-рдСрди рд╣реИ
    }

    // 5. рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рд╣реИ
    return false;
}

/**
 * "рдЕрдкрдЧреНрд░реЗрдб" рдкреЙрдкрдЕрдк рджрд┐рдЦрд╛рддрд╛ рд╣реИ
 */
function showPlanLockModal(featureName, requiredPlanOrAddOn) {
    if (!planLockModalInstance) {
        planLockModalInstance = new bootstrap.Modal(document.getElementById('planLockModal'));
    }

    // Modal рдХрд╛ рдЯреЗрдХреНрд╕реНрдЯ рдмрджрд▓реЗрдВ
    document.getElementById('plan-lock-feature-name').innerText = featureName;
    document.getElementById('plan-lock-plan-name').innerText = `'${AppState.user.plan_type}'`;

    // WhatsApp рд▓рд┐рдВрдХ рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ (рд╡реИрдХрд▓реНрдкрд┐рдХ)
    const waLink = document.querySelector('#planLockModal .btn-success');
    const message = `рдирдорд╕реНрддреЗ, рдореИрдВ рдЕрдкрдирд╛ Dukan Pro рдкреНрд▓рд╛рди '${AppState.user.plan_type}' рд╕реЗ рдЕрдкрдЧреНрд░реЗрдб рдХрд░рдХреЗ '${requiredPlanOrAddOn}' рд▓реЗрдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реВрдБред (Shop ID: ${AppState.user.shopId})`;
    waLink.href = `https://wa.me/7303410987?text=${encodeURIComponent(message)}`;

    planLockModalInstance.show();
}

// ==========================================================
// ========== ЁЯЪА NAYA LOGIC YAHAN SAMAPT HOTA HAI ЁЯЪА ==========
// ==========================================================

/**
 * рдПрдХ рд╕рд╛рдзрд╛рд░рдг CSV рдЯреЗрдХреНрд╕реНрдЯ рдХреЛ JSON рдСрдмреНрдЬреЗрдХреНрдЯ рдРрд░реЗ рдореЗрдВ рдкрд╛рд░реНрд╕ рдХрд░рддрд╛ рд╣реИ
 */
 function parseCSV(csvText) {
    const lines = csvText.split('\n');
    if (lines.length === 0) return [];
    
    // рд╣реЗрдбрд░ (Date, Description, Debit, Credit) рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдПрдБ
    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
    
    // рдХреЙрд▓рдо рдЗрдВрдбреЗрдХреНрд╕ рдвреВрдБрдвреЗрдВ
    const dateIdx = headers.findIndex(h => h.includes('date'));
    const descIdx = headers.findIndex(h => h.includes('description') || h.includes('narration'));
    const debitIdx = headers.findIndex(h => h.includes('debit') || h.includes('withdrawal'));
    const creditIdx = headers.findIndex(h => h.includes('credit') || h.includes('deposit'));

    if (dateIdx === -1 || descIdx === -1 || debitIdx === -1 || creditIdx === -1) {
        showMessage('CSV рдПрд░рд░', 'CSV рдореЗрдВ Date, Description, Debit/Withdrawal, рдпрд╛ Credit/Deposit рдХреЙрд▓рдо рдирд╣реАрдВ рдорд┐рд▓реЗред', 'danger');
        throw new Error('Invalid CSV headers');
    }

    const items = [];
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line) continue;
        
        const values = line.split(',');
        
        const dateStr = values[dateIdx];
        // рддрд╛рд░реАрдЦ рдХреЛ YYYY-MM-DD рдореЗрдВ рдмрджрд▓реЗрдВ (рдорд╛рди рд▓реЗрдВ рдХрд┐ рдпрд╣ DD/MM/YYYY рдпрд╛ MM/DD/YYYY рд╣реИ)
        let dateObj;
        if (dateStr.includes('/')) {
            const parts = dateStr.split('/');
            // рдорд╛рди рд▓реЗрдВ рдХрд┐ рдпрд╣ MM/DD/YYYY рд╣реИ (рдЗрд╕реЗ рдЕрдкрдиреЗ рдмреИрдВрдХ рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдмрджрд▓реЗрдВ)
            // рдЕрдЧрд░ DD/MM/YYYY рд╣реИ, рддреЛ new Date(parts[2], parts[1] - 1, parts[0]) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ
            dateObj = new Date(parts[2], parts[0] - 1, parts[1]); 
        } else {
            dateObj = new Date(dateStr); // ISO 8601 (YYYY-MM-DD)
        }
        
        const debitAmount = parseFloat(values[debitIdx].replace(/[^0-9.]/g, '')) || 0;
        const creditAmount = parseFloat(values[creditIdx].replace(/[^0-9.]/g, '')) || 0;

        items.push({
            date: dateObj.toISOString().split('T')[0],
            description: values[descIdx],
            debit: debitAmount,
            credit: creditAmount
        });
    }
    return items;
}



    function updateBalanceSheet(data) {
    // рдЕрдЧрд░ рдХреЛрдИ рдбреЗрдЯрд╛ рдирд╣реАрдВ рдЖрддрд╛ рд╣реИ, рддреЛ рдлрд╝рдВрдХреНрд╢рди рдпрд╣реАрдВ рд░реБрдХ рдЬрд╛рдПрдЧрд╛
    if (!data) return; 

    // --- рджреЗрдирджрд╛рд░рд┐рдпрд╛рдВ рдФрд░ рдЗрдХреНрд╡рд┐рдЯреА (Liabilities & Equity) рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ ---
    
    // GST рдЬрдорд╛ рдХрд░рдиреЗ рдпреЛрдЧреНрдп (Payable)
    document.getElementById('report-bs-gst-payable').innerText = formatCurrency(data.gstPayable || 0);
    
    // рд╡реЗрдВрдбрд░ рдХреЛ рджреЗрдп (Payable)
    document.getElementById('report-bs-vendors-payable').innerText = formatCurrency(data.vendorsPayable || 0);
    
    // рдорд╛рд▓рд┐рдХ рдХреА рдЗрдХреНрд╡рд┐рдЯреА (Owner's Equity) = Net Profit
    document.getElementById('report-bs-owner-equity').innerText = formatCurrency(data.ownerEquity || 0);
    
    // рдХреБрд▓ рджреЗрдирджрд╛рд░рд┐рдпрд╛рдВ рдФрд░ рдЗрдХреНрд╡рд┐рдЯреА
    document.getElementById('report-bs-total-liabilities').innerText = formatCurrency(data.totalLiabilitiesAndEquity || 0);

    // --- рдкрд░рд┐рд╕рдВрдкрддреНрддрд┐рдпрд╛рдВ (Assets) рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ ---
    
    // рд╕реНрдЯреЙрдХ рдХрд╛ рдореВрд▓реНрдп (Stock Value)
    document.getElementById('report-bs-stock-value').innerText = formatCurrency(data.stockValue || 0);
    
    // рдХреИрд╢/рдмреИрдВрдХ рдмреИрд▓реЗрдВрд╕ (рдЖрдкрдХреЗ рдореМрдЬреВрджрд╛ рдмреИрдХрдПрдВрдб рдореЗрдВ рдЗрд╕реЗ рдЯреНрд░реИрдХ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП 0.00 рд░рдЦреЗрдВ)
    document.getElementById('report-bs-cash-balance').innerText = formatCurrency(data.cashBalance || 0);
    
    // рдХреБрд▓ рдкрд░рд┐рд╕рдВрдкрддреНрддрд┐рдпрд╛рдВ
    document.getElementById('report-bs-total-assets').innerText = formatCurrency(data.totalAssets || 0);
    
    console.log('Balance Sheet data successfully updated in HTML with correct IDs.');
}



// NEW: Function to fetch and populate Company Profile into Invoice Generator
function fetchAndPopulateShopData() {
        console.log("Populating Shop Data for Invoice...");
        try {
            // 1. рд╢реЙрдк рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рд╕реЗ рдбреЗрдЯрд╛ рдЙрдард╛рдПрдБ
            const legalName = document.getElementById('company-legal-name').value;
            const gstin = document.getElementById('company-gstin').value;
            const address = document.getElementById('company-address').value;
            
            // 2. AppState (рд▓реЙрдЧ-рдЗрди рдпреВрдЬрд╝рд░) рд╕реЗ рдбреЗрдЯрд╛ рдЙрдард╛рдПрдБ
            const displayName = AppState.user?.shopName || '';
            const mobile = AppState.user?.mobile || ''; // (рдпрд╣ рд╕рд░реНрд╡рд░ рд╕реЗ рдЖрдирд╛ рдЪрд╛рд╣рд┐рдП)

            // 3. рдЗрдирд╡реЙрдЗрд╕ рдЬрдирд░реЗрдЯрд░ рдХреЗ рдлреЙрд░реНрдо рдореЗрдВ рдпрд╣ рдбреЗрдЯрд╛ рднрд░реЗрдВ
            document.getElementById('shopName').value = legalName || displayName; //
            document.getElementById('shopContact').value = mobile; //
            document.getElementById('shopAddress').value = address; //
            document.getElementById('shopGstin').value = gstin; //
            
            // 4. рдкреНрд░реАрд╡реНрдпреВ рдХреЛ рддреБрд░рдВрдд рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ
            updateInvoicePreview();

        } catch (e) {
            console.warn("Could not pre-populate shop data:", e.message);
        }
    }// рдпрд╣ рднреА рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ 'renderReports' рдлрд╝рдВрдХреНрд╢рди рдХреЗ рдЕрдВрджрд░ API рдХреЙрд▓ рдХреЗ рдмрд╛рдж 
// рдпрд╣ рдлрд╝рдВрдХреНрд╢рди рдХреЙрд▓ рд╣реЛ рд░рд╣рд╛ рд╣реИ, рдЬреИрд╕рд╛ рдХрд┐ рдиреАрдЪреЗ рд╣реИ:

// (Multiuser.html рдореЗрдВ рд▓рд╛рдЗрди 2049 рдХреЗ рдЖрд╕рдкрд╛рд╕, renderView рд╕реЗ рдареАрдХ рдкрд╣рд▓реЗ)

    /**
     * ЁЯЪА NAYA FUNCTION: Plan-Aadhaar par Navigation ko Handle karta hai
     * Yeh function sidebar clicks ko rokta hai aur plan check karta hai.
     * Yahi aapki "Problem 1" ka solution hai.
     */
     // [REPLACE THIS FUNCTION IN HTML <script>]

function handleNavClick(viewId) {
    // 1. Un views ko define karein jinke liye plan ki aavashyakta hai
    // (Yeh aapke server-side 'checkPlan' logic se mel khana chahiye)
    const planRequirements = {
        'crm': { plans: ['MEDIUM', 'PREMIUM'], featureName: 'CRM (рдЧреНрд░рд╛рд╣рдХ рдкреНрд░рдмрдВрдзрди)' },
        'reports': { plans: ['MEDIUM', 'PREMIUM'], featureName: 'Advanced Reports' },
        'gst-reports': { plans: ['MEDIUM', 'PREMIUM'], featureName: 'GST Reports' },
        'bank-reconciliation': { plans: ['MEDIUM', 'PREMIUM'], featureName: 'Bank Reconciliation' },
        
        // ЁЯЪА UPDATED: AI Insights Logic
        // (Ab Basic plan wale bhi ise 'Add-on' khareed kar chala sakte hain)
        'ai-insights': { plans: ['MEDIUM', 'PREMIUM'], addOn: 'has_ai_insights', featureName: 'AI Business Insights' },

        'daily-closing': { plans: ['MEDIUM', 'PREMIUM'], addOn: 'has_closing', featureName: 'Daily Closing' },
        'data-backup': { plans: ['MEDIUM', 'PREMIUM'], addOn: 'has_backup', featureName: 'Data Backup' },
        'staff': { plans: ['MEDIUM', 'PREMIUM'], featureName: 'Staff Management' }
        
        // Views not listed: dashboard, stock, sales, invoice-generator,
        // purchases, expenses, shop-settings sabke liye available hain.
    };

    const req = planRequirements[viewId];

    if (req) {
        // 2. Is view ke liye plan ya add-on check karein
        // 'checkUserPlan' рдлрд╝рдВрдХреНрд╢рди (line ~1968) рдЪреЗрдХ рдХрд░реЗрдЧрд╛ рдХрд┐ рдХреНрдпрд╛ рдкреНрд▓рд╛рди рдпрд╛ рдРрдб-рдСрди рд╣реИ
        if (checkUserPlan(req.plans, req.addOn)) {
            renderView(viewId); // тЬЕ Anumati hai (Access Granted)
        } else {
            // тЭМ Anumati nahi hai - Lock modal dikhayein
            // Agar add-on available hai to message mein dikhayen
            const requiredName = req.addOn ? req.featureName + " (Add-on)" : req.plans.join('/');
            
            // 'showPlanLockModal' рдлрд╝рдВрдХреНрд╢рди (line ~2000) рдкреЙрдкрдЕрдк рджрд┐рдЦрд╛рдПрдЧрд╛
            showPlanLockModal(req.featureName, requiredName);
        }
    } else {
        // 4. Is view ke liye koi plan requirement nahi hai (Sabke liye khula hai)
        renderView(viewId);
    }
}
    // --- Yahaan naya function samapt hota hai ---


   
    // --- RENDER FUNCTIONS FOR EACH SECTION ---
    const renderView = (viewId) => {
        AppState.currentView = viewId;
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        
        // рдпрд╣ рд▓рд╛рдЗрди рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддреА рд╣реИ рдХрд┐ рд╕реЗрдХреНрд╢рди рдХреЛ active рдХреНрд▓рд╛рд╕ рдорд┐рд▓реЗ
        const sectionElement = document.getElementById(viewId);
        if (sectionElement) {
             sectionElement.classList.add('active');
             console.log(`тЬЕ Activated section: #${viewId}`); // рдХрдиреНрдлрд░реНрдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд▓реЙрдЧ
        } else {
             console.error(`тЭМ Section not found for ID: ${viewId}`); // рдЕрдЧрд░ ID рдЧрд▓рдд рд╣реИ
        }

        document.querySelectorAll('#sidebar-nav .nav-link').forEach(l => {
            l.classList.remove('active');
            if (l.getAttribute('data-view') === viewId) l.classList.add('active');
        });
        
        // --- ЁЯЪА рдЕрд╕реНрдерд╛рдпреА рд░реВрдк рд╕реЗ рдХрдореЗрдВрдЯ рдЖрдЙрдЯ ---
        switch (viewId) {
            case 'dashboard': renderDashboard(); break;
            case 'stock':
    document.getElementById('stock').classList.add('active');
    fetchAndRenderStockList();

    // тЬЕ SALON ONLY STOCK FORM
   // const salonStockForm = document.getElementById('add-stock-form');
    //if (salonStockForm) {
      //  salonStockForm.style.display =
        //    currentBusinessType === 'SALON' ? 'flex' : 'none';
    //}

    // тЬЕ SALON ONLY DURATION FIELD
    const durationDiv = document.getElementById('stock-duration-div');
if (durationDiv) {
    durationDiv.style.display =
        (AppState.user?.businessType || '') === 'SALON' ? 'block' : 'none';
}


    break;

            case 'crm': fetchAndRenderCustomers(); break;
            case 'purchases': fetchAndRenderPurchases(); break;
            case 'expenses': fetchAndRenderExpenses(); break;
            case 'reports': renderReports(); break;
            case 'sales': 
                fetchAndRenderSales(); 
                fetchApi('/api/stock', { method: 'GET' }).then(res => {
                    if (res.success) currentStock = res.stock;
                });
                focusBarcodeScanner(); 
                break;
                case 'invoice-generator':
            fetchAndPopulateShopData();
            initializeQRUpload();
            break;
             // Note: Duplicate 'sales' case removed below
            
            case 'gst-reports': 
                // Ensure getISODate function exists or handle potential error
                try {
                    document.getElementById('gst-report-start-date').value = getISODate(new Date(new Date().setDate(1))); 
                    document.getElementById('gst-report-end-date').value = getISODate(); 
                } catch (e) { console.error("Error setting GST dates:", e); }
                break;
            case 'bank-reconciliation':
            // рдЬрдм рд╣рдо рдЯреИрдм рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░рддреЗ рд╣реИрдВ рддреЛ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдХреЛ рд░реАрд╕реЗрдЯ рдХрд░реЗрдВ
                document.getElementById('reconciliation-setup').classList.remove('hidden');
                document.getElementById('reconciliation-matching-area').classList.add('hidden');
                document.getElementById('reconciliation-start-form').reset();
                fetchAndRenderSavedReports();
                break;    
            case 'daily-closing': fetchAndRenderClosingReports(); break; 
            case 'data-backup': break; 
            case 'shop-settings': fetchAndRenderShopSettings(); break; 
            case 'staff': renderStaff(); break; 
            case 'ai-insights':
            loadUltimateAI();
            break;
            case 'daily_reports': 
        // ЁЯЪА рдпрд╣рд╛рдБ рдирдпрд╛ рдлрдВрдХреНрд╢рди рдХреЙрд▓ рдХрд░реЗрдВ
        filterReportOptions(); 
        break;

        }
        
        // --- ЁЯЪА рдХрдореЗрдВрдЯ рдЦрддреНрдо ---
    };


    /**
     * ЁЯЪА NAYA: AI Insights рд╡реНрдпреВ рдХреЛ рд░реЗрдВрдбрд░ рдХрд░рддрд╛ рд╣реИ
     */
     const renderAiInsights = async () => {
        const contentDiv = document.getElementById('ai-insights-content');
        contentDiv.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">AI рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░ рд░рд╣рд╛ рд╣реИ...</p></div>`;

        try {
            const response = await fetchApi('/api/ai/stock-insights', { method: 'GET' });
            
            if (!response.success) {
                throw new Error(response.message);
            }

            const { fast_moving, dead_stock } = response.insights;
            let html = '<div class="row g-4">';

            // 1. рдбреЗрдб рд╕реНрдЯреЙрдХ (Dead Stock) рдХрд╛рд░реНрдбреНрд╕
            if (dead_stock.length > 0) {
                html += '<h4><i class="fas fa-exclamation-triangle text-danger me-2"></i>рдкреИрд╕реЗ рдмрдЪрд╛рдиреЗ рдХреА рд╕рд▓рд╛рд╣ (рдбреЗрдб рд╕реНрдЯреЙрдХ)</h4>';
                dead_stock.forEach(item => {
                    html += `
                        <div class="col-md-6">
                            <div class="card border-danger shadow-sm h-100">
                                <div class="card-body">
                                    <h5 class="card-title text-danger">${item.title}</h5>
                                    <p class="card-text">${item.text}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<p>рдмрдзрд╛рдИ рд╣реЛ! рдЖрдкрдХрд╛ рдХреЛрдИ рднреА рдкреИрд╕рд╛ рдбреЗрдб рд╕реНрдЯреЙрдХ рдореЗрдВ рдирд╣реАрдВ рдлрдБрд╕рд╛ рд╣реИред</p>';
            }

            // 2. рдлрд╛рд╕реНрдЯ рдореВрд╡рд┐рдВрдЧ (Fast Moving) рдХрд╛рд░реНрдбреНрд╕
            if (fast_moving.length > 0) {
                html += '<h4 class="mt-5"><i class="fas fa-shipping-fast text-success me-2"></i>рдмрд┐рдХреНрд░реА рдмрдврд╝рд╛рдиреЗ рдХреА рд╕рд▓рд╛рд╣ (рдлрд╛рд╕реНрдЯ рдореВрд╡рд┐рдВрдЧ)</h4>';
                fast_moving.forEach(item => {
                    html += `
                        <div class="col-md-6">
                            <div class="card border-success shadow-sm h-100">
                                <div class="card-body">
                                    <h5 class="card-title text-success">${item.title}</h5>
                                    <p class="card-text">${item.text}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<p>рдЖрдкрдХрд╛ рд╕реНрдЯреЙрдХ рдирд┐рдпрдВрддреНрд░рдг рдореЗрдВ рд╣реИред рдЕрднреА рдХреЛрдИ рдЖрдЗрдЯрдо рддреБрд░рдВрдд рдЦрддреНрдо рдирд╣реАрдВ рд╣реЛ рд░рд╣рд╛ рд╣реИред</p>';
            }

            html += '</div>'; // row
            contentDiv.innerHTML = html;

        } catch (error) {
            contentDiv.innerHTML = `<div class="alert alert-danger">AI рд╕рд▓рд╛рд╣ рд▓реЛрдб рдХрд░рдиреЗ рдореЗрдВ рд╡рд┐рдлрд▓: ${error.message}</div>`;
        }
    };




  // [ тЬЕ FIXED: SALES TABLE WITH ROBUST DATE ]
async function fetchAndRenderSales() {
    const salesTableBody = document.getElementById('sales-table-body');  
    if (!salesTableBody) return;

    salesTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-3"><div class="spinner-border text-primary spinner-border-sm"></div> рд▓реЛрдбрд┐рдВрдЧ...</td></tr>`;
    
    try {
        const salesRes = await fetchApi('/api/invoices', { method: 'GET' }, null); 
        salesTableBody.innerHTML = ''; 

        if (salesRes.success && salesRes.sales && salesRes.sales.length > 0) {
            salesRes.sales.forEach(sale => {
                
                // ЁЯЪА DATE FIX: рдЬрдмрд░рджрд╕реНрддреА рддрд╛рд░реАрдЦ рдирд┐рдХрд╛рд▓реЗрдВ
                let dateStr = "---";
                if (sale.created_at) {
                    const d = new Date(sale.created_at);
                    if (!isNaN(d.getTime())) {
                        // рд╕рд╣реА рддрд╛рд░реАрдЦ рдорд┐рд▓реА
                        dateStr = d.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: '2-digit' });
                    } else {
                        // рдЕрдЧрд░ рддрд╛рд░реАрдЦ рдХрд╛ рдлреЙрд░реНрдореЗрдЯ рдЧрд▓рдд рд╣реИ
                        dateStr = String(sale.created_at).split('T')[0]; 
                    }
                }

                let custName = sale.customer_name || 'рдЕрдирд╛рдо';
                if(custName.length > 15) custName = custName.substring(0, 15) + '..';

                salesTableBody.innerHTML += `
                    <tr>
                        <td class="fw-bold">#${sale.id}</td>
                        <td>
                            <span class="text-dark fw-bold">${custName}</span>
                            ${sale.customer_phone ? `<br><small class="text-muted">${sale.customer_phone}</small>` : ''}
                        </td>
                        <td>${formatCurrency(sale.total_gst || 0).replace('тВ╣','')}</td>
                        <td class="fw-bold text-success">${formatCurrency(sale.total_amount || 0)}</td>
                        
                        <td class="fw-bold text-dark">${dateStr}</td> 
                        
                        <td>
                            <div class="d-flex">
                                <button class="btn btn-sm btn-secondary py-1 px-2 shadow-sm" onclick="printPOSInvoice(${sale.id})" title="Print">
                                    <i class="fas fa-print"></i>
                                </button>
                                <button class="btn btn-sm btn-success py-1 px-2 ms-1 shadow-sm" 
                                    onclick="sendWhatsAppMessage('${sale.customer_phone || ''}', '${sale.customer_name}')" 
                                    ${!(sale.customer_phone) ? 'disabled' : ''}>
                                    <i class="fab fa-whatsapp"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        } else {
             salesTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">рдХреЛрдИ рдмрд┐рдХреНрд░реА рд░рд┐рдХреЙрд░реНрдб рдирд╣реАрдВред</td></tr>`; 
        }
    } catch (error) {
        console.error(error);
        salesTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">рддреНрд░реБрдЯрд┐: ${error.message}</td></tr>`; 
    }
}

// NEW: Show Invoice Detail Modal (Placeholder, needs a modal)
    async function showInvoiceDetail(invoiceId) {
        try {
            const res = await fetchApi(`/api/invoices/${invoiceId}`, { method: 'GET' });
            if (res.success) {
                // TODO: Create a modal to show this data
                console.log(res.invoice);
                alert(`рдЪрд╛рд▓рд╛рди #${res.invoice.id}\nрдЧреНрд░рд╛рд╣рдХ: ${res.invoice.customer_name}\nрдХреБрд▓: ${formatCurrency(res.invoice.total_amount)}\nрдЖрдЗрдЯрдо:\n` + 
                    res.invoice.items.map(item => `${item.item_name} (Qty: ${item.quantity})`).join('\n')
                );
            } else {
                showMessage('рддреНрд░реБрдЯрд┐', res.message, 'danger');
            }
        } catch (e) {
            showMessage('рддреНрд░реБрдЯрд┐', e.message, 'danger');
        }
    }

/**
    
  /**
     * (рдирдпрд╛ рдлрд╝рдВрдХреНрд╢рди - рдкреНрд░рд┐рдВрдЯ рдХреНрд▓реАрдирдЕрдк рдХреЗ рд╕рд╛рде рдлрд┐рдХреНрд╕реНрдб)
     * POS рд╕реЗ рд╕реЗрд╡ рдХрд┐рдпреЗ рдЧрдП рдЗрдирд╡реЙрдЗрд╕ рдХреЛ рдлрд╝реЗрдЪ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдкреНрд░рд┐рдВрдЯ рдХрд░рддрд╛ рд╣реИред
     */
     async function printPOSInvoice(invoiceId) {
        showLoader('рдЗрдирд╡реЙрдЗрд╕ рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...');
        
        // ЁЯЪА рд╣рдо рдЗрд╕ 'printArea' рдХреЛ рдмрд╛рдж рдореЗрдВ рд╣рдЯрд╛рдПрдВрдЧреЗ
        let printArea = document.getElementById('report-print-area');

        try {
            // 1. рд╕рд░реНрд╡рд░ рд╕реЗ рдЗрдирд╡реЙрдЗрд╕ рдХрд╛ рдкреВрд░рд╛ рдбреЗрдЯрд╛ рд▓рд╛рдПрдБ
            const res = await fetchApi(`/api/invoices/${invoiceId}`, { method: 'GET' }, null);
            if (!res.success || !res.invoice) {
                throw new Error(res.message || 'рдЗрдирд╡реЙрдЗрд╕ рдбреЗрдЯрд╛ рдирд╣реАрдВ рдорд┐рд▓рд╛ред');
            }
            
            const invoice = res.invoice;
            
            // 2. рд╢реЙрдк рдХреА рдбрд┐рдЯреЗрд▓реНрд╕ AppState рд╕реЗ рд▓реЗрдВ
            const profileRes = await fetchApi('/api/shop/company-profile', { method: 'GET' }, null);
            const shopProfile = profileRes.success ? profileRes.profile : {};
            const shopDisplayName = AppState.user?.shopName || 'Shop Name';

            // 3. рдЗрдирд╡реЙрдЗрд╕ HTML рддреИрдпрд╛рд░ рдХрд░реЗрдВ
            let itemRows = '';
            let totalTax = 0;
            let subTotal = 0;

            invoice.items.forEach((item, index) => {
                const itemSubTotal = (item.sale_price || 0) * (item.quantity || 0);
                const itemGst = itemSubTotal * ((item.gst_rate || 0) / 100); 
                
                subTotal += itemSubTotal;
                totalTax += itemGst;
                
                itemRows += `
                    <tr>
                        <td>${index + 1}</td>
                        <td style="text-align: left;">
    ${item.item_name}
    <small class="d-block" style="color: #555;">${formatAttributes(item.product_attributes)}</small>
</td>
                        <td>${item.quantity}</td>
                        <td>${formatCurrency(item.sale_price)}</td>
                        <td>${item.gst_rate || 0}%</td> 
                        <td>${formatCurrency(itemSubTotal)}</td>
                        <td class="no-print"></td>
                    </tr>
                `;
            });

            const cgst = totalTax / 2;
            const sgst = totalTax / 2;

            // 4. рдПрдХ рдЕрд╕реНрдерд╛рдпреА рдкреНрд░рд┐рдВрдЯ рдХрд░рдиреЗ рдпреЛрдЧреНрдп (printable) div рдмрдирд╛рдПрдБ
            if (!printArea) {
                printArea = document.createElement('div');
                printArea.id = 'report-print-area';
                printArea.className = 'printable'; // [cite: 1-267]
                document.body.appendChild(printArea);
            }

            // 5. рдЗрдирд╡реЙрдЗрд╕ HTML рдХреЛ рдкреНрд░рд┐рдВрдЯ рдПрд░рд┐рдпрд╛ рдореЗрдВ рдЗрдВрдЬреЗрдХреНрдЯ рдХрд░реЗрдВ
            printArea.innerHTML = `
                <div id="invoice-preview-printable" class="printable"> 
                    <div class="invoice-header">
                        <div class="shop-details">
                            <h3>${shopProfile.legal_name || shopDisplayName}</h3>
                            <p class="mb-0">${shopProfile.address || 'Shop Address'}</p>
                            <p class="mb-0">Ph: ${shopProfile.contact || 'Contact No.'}</p>
                            ${shopProfile.gstin ? `<p class="mb-0"><strong>GSTIN: ${shopProfile.gstin}</strong></p>` : ''}
                        </div>
                        <h2 style="color: #333; align-self: center;">INVOICE</h2>
                    </div>
                    
                    <div class="customer-details row">
                        <div class="col-8">
                            <strong>Bill To:</strong>
                            <p class="mb-0">${invoice.customer_name || 'N/A'}</p>
                            <p class="mb-0">Ph: ${invoice.customer_mobile || 'N/A'}</p>
                        </div>
                        <div class="col-4 text-end">
                            <p class="mb-0"><strong>Invoice No:</strong> INV-${invoice.id}</p>
                            <p class="mb-0"><strong>Date:</strong> ${new Date(invoice.created_at).toLocaleDateString()}</p>
                        </div>
                    </div>

                    <table class="invoice-table">
                        <thead>
                            <tr>
                                <th style="width: 5%;">#</th>
                                <th style="text-align: left;">Item</th>
                                <th style="width: 10%;">Qty</th>
                                <th style="width: 15%;">Rate</th>
                                <th style="width: 10%;">GST%</th>
                                <th style="width: 15%;">Amount</th>
                                <th style="width: 5%;" class="no-print"></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemRows}
                        </tbody>
                    </table>
                    
                    <div class="invoice-footer">
                        <div>
                            </div>
                        <table class="totals-table">
                            <tbody>
                                <tr><td>Subtotal:</td><td style="text-align: right;">${formatCurrency(subTotal)}</td></tr>
                                <tr><td>CGST:</td><td style="text-align: right;">${formatCurrency(cgst)}</td></tr>
                                <tr><td>SGST:</td><td style="text-align: right;">${formatCurrency(sgst)}</td></tr>
                                <tr style="font-weight: bold; font-size: 1.2em; border-top: 2px solid #333;">
                                    <td>Grand Total:</td>
                                    <td style="text-align: right;">${formatCurrency(invoice.total_amount)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // ЁЯЪАЁЯЪАЁЯЪА рдпрд╣ рд░рд╣рд╛ рдлрд┐рдХреНрд╕ ЁЯЪАЁЯЪАЁЯЪА
            // 6. рдПрдХ рдХреНрд▓реАрдирдЕрдк рдлрд╝рдВрдХреНрд╢рди рдмрдирд╛рдПрдБ
            function cleanupPrint() {
                if (printArea) {
                    printArea.remove(); // рдЕрд╕реНрдерд╛рдпреА div рдХреЛ рд╣рдЯрд╛ рджреЗрдВ
                }
                window.onafterprint = null; // рдЗрд╡реЗрдВрдЯ рд▓рд┐рд╕реНрдирд░ рдХреЛ рд╣рдЯрд╛ рджреЗрдВ
            }
            
            // 7. 'afterprint' (рдкреНрд░рд┐рдВрдЯ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж) рдЗрд╡реЗрдВрдЯ рдкрд░ рдХреНрд▓реАрдирдЕрдк рдлрд╝рдВрдХреНрд╢рди рд╕реЗрдЯ рдХрд░реЗрдВ
            window.onafterprint = cleanupPrint;
            
            // 8. рдкреНрд░рд┐рдВрдЯ рдХрд░реЗрдВ
            window.print();
            // ЁЯЪАЁЯЪАЁЯЪА рдлрд┐рдХреНрд╕ рд╕рдорд╛рдкреНрдд ЁЯЪАЁЯЪАЁЯЪА

        } catch (e) {
            showMessage('рддреНрд░реБрдЯрд┐', `рдЗрдирд╡реЙрдЗрд╕ рдкреНрд░рд┐рдВрдЯ рдХрд░рдиреЗ рдореЗрдВ рд╡рд┐рдлрд▓: ${e.message}`, 'danger');
            // ЁЯЪА рдЕрдЧрд░ рдПрд░рд░ рдЖрдП рддреЛ рднреА рдХреНрд▓реАрдирдЕрдк рдХрд░реЗрдВ
            if (printArea) {
                printArea.remove();
            }
        } finally {
            hideLoader();
        }
    }


	// [ тЬЕ Is Poore Naye Function ko Line 2611 se pehle Paste Karein ]

async function renderSalesChart() {
    try {
        // 1. Chart data API se laayein
        const res = await fetchApi('/api/dashboard/sales-by-day?days=30', { method: 'GET' }, null); 

        if (!res.success || !res.data) {
            throw new Error(res.message || 'Sales chart data not found');
        }

        const chartData = res.data;

        // 2. Data ko Chart.js ke liye process karein
        const labels = chartData.map(d => new Date(d.date).toLocaleDateString('hi-IN', { day: 'numeric', month: 'short' }));
        const salesValues = chartData.map(d => d.sales);
        const profitValues = chartData.map(d => d.profit);

        // 3. Canvas element ko pakdein
        const ctx = document.getElementById('salesChart').getContext('2d');

        // 4. Purana chart (agar hai) toh destroy karein
        if (mySalesChart) {
            mySalesChart.destroy();
        }

        // 5. Naya chart banayein
        mySalesChart = new Chart(ctx, {
            type: 'line', 
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'рдмрд┐рдХреНрд░реА (Sales)',
                        data: salesValues,
                        borderColor: 'rgba(0, 180, 216, 1)',
                        backgroundColor: 'rgba(0, 180, 216, 0.1)',
                        fill: true,
                        tension: 0.3
                    },
                    {
                        label: 'рд▓рд╛рдн (Profit)',
                        data: profitValues,
                        borderColor: 'rgba(26, 188, 156, 1)',
                        backgroundColor: 'rgba(26, 188, 156, 0.1)',
                        fill: true,
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) { return 'тВ╣' + value; }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatCurrency(context.raw);
                            }
                        }
                    }
                }
            }
        });

    } catch (error) {
        console.error("Error rendering sales chart:", error.message);
        const ctx = document.getElementById('salesChart').getContext('2d');
        if (ctx) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.font = '16px Poppins';
            ctx.fillStyle = '#dc3545';
            ctx.textAlign = 'center';
            ctx.fillText('рдЪрд╛рд░реНрдЯ рд▓реЛрдб рдХрд░рдиреЗ рдореЗрдВ рд╡рд┐рдлрд▓: ' + error.message, ctx.canvas.width / 2, ctx.canvas.height / 2);
        }
    }
}

    // [ рдкреБрд░рд╛рдиреЗ renderDashboard() рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдЗрд╕ рдирдП рдлрд╝рдВрдХреНрд╢рди рд╕реЗ рдкреВрд░реА рддрд░рд╣ рдмрджрд▓ рджреЗрдВ ]
    // [ multiuser.html рдореЗрдВ рд▓рд╛рдЗрди 2174 рдкрд░ рдкреЗрд╕реНрдЯ рдХрд░реЗрдВ ]


    // [ рдкреБрд░рд╛рдиреЗ renderDashboard() рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдЗрд╕ рдирдП рдлрд╝рдВрдХреНрд╢рди рд╕реЗ рдкреВрд░реА рддрд░рд╣ рдмрджрд▓ рджреЗрдВ ]

   // [ тЬЕ FIXED: ULTIMATE DASHBOARD RENDERER - ALL 31 BUSINESS TYPES EXPLICITLY HANDLED ]
// [ тЬЕ FIXED: ULTIMATE DASHBOARD RENDERER - ALL 31 BUSINESS TYPES EXPLICITLY HANDLED ]
// [ тЬЕ FIXED: ULTIMATE DASHBOARD - DATA LOADING FIXED ]
// [ тЬЕ FIXED: DASHBOARD WITH DATE UPDATES ]
async function renderDashboard() {
    const user = AppState.user;
    if (!user) return;

    const btype = user.businessType;
    const config = (typeof MASTER_BUSINESS_CONFIG !== 'undefined') ? MASTER_BUSINESS_CONFIG[btype] : null;
    const viewMode = config ? config.dashboard_view : 'retail_grid';

    console.log(`ЁЯЪА Loading Dashboard for: ${btype} (View: ${viewMode})`);

    // ============================================================
    // 1. SALON DASHBOARD (Custom UI)
    // ============================================================
    if (viewMode === 'salon_dashboard') {
        document.querySelectorAll('#dashboard > .row').forEach(el => el.style.display = 'none');
        const salonDash = document.getElementById('salon-dashboard');
        if (salonDash) {
            salonDash.style.display = 'block';
            if (typeof loadSalonDashboard === 'function') await loadSalonDashboard();
        }
        return; 
    }

    // ============================================================
    // 2. STANDARD DASHBOARD (For remaining 30 Types)
    // ============================================================
    else {
        // UI Reset
        document.querySelectorAll('#dashboard > .row').forEach(el => el.style.display = 'flex');
        const salonDash = document.getElementById('salon-dashboard');
        if (salonDash) salonDash.style.display = 'none';
        
        // Modules Visibility Logic (Business Type Switch)
        const uniContainer = document.getElementById('universal-modules-container');
        if (uniContainer) uniContainer.style.display = 'block';

        switch (btype) {
            case 'RETAIL': break;
            case 'MOBILE_SHOP': case 'ELECTRONICS': 
                if(document.getElementById('module-imei-scan')) document.getElementById('module-imei-scan').style.display = 'block';
                break;
            case 'HARDWARE_PAINT':
                if (typeof loadPainters === 'function') loadPainters();
                if(document.getElementById('module-paint-estimator')) document.getElementById('module-paint-estimator').style.display = 'block';
                break;
            case 'FURNITURE':
                if(document.getElementById('module-furniture-showroom')) document.getElementById('module-furniture-showroom').style.display = 'block';
                break;
            case 'DOCTOR_CLINIC': case 'ORTHOPEDIC': case 'PHYSIOTHERAPY': case 'DENTIST': case 'SONOGRAPHY': case 'PATHOLOGY':
                if(document.getElementById('module-prescription-pad')) document.getElementById('module-prescription-pad').style.display = 'block';
                if(btype === 'DENTIST' && document.getElementById('box-dentist-chart')) document.getElementById('box-dentist-chart').style.display = 'block';
                if(btype === 'SONOGRAPHY' && document.getElementById('box-lmp-calc')) document.getElementById('box-lmp-calc').style.display = 'block';
                break;
            case 'GYM':
                if(document.getElementById('module-gym-access')) document.getElementById('module-gym-access').style.display = 'block';
                break;
            case 'TAILOR':
                if(document.getElementById('module-tailor-measurements')) document.getElementById('module-tailor-measurements').style.display = 'block';
                break;
            case 'SERVICE_CENTER':
                if(document.getElementById('module-repair-job')) document.getElementById('module-repair-job').style.display = 'block';
                break;
            case 'RESTAURANT': case 'HOTEL':
                if(document.getElementById('module-restaurant-kot')) document.getElementById('module-restaurant-kot').style.display = 'block';
                if(btype === 'HOTEL' && document.getElementById('module-hotel-management')) document.getElementById('module-hotel-management').style.display = 'block';
                break;
            case 'TILES_CERAMIC':
                if(document.getElementById('module-tiles-calc')) document.getElementById('module-tiles-calc').style.display = 'block';
                break;
            case 'TRANSPORT':
                if(document.getElementById('module-transport-trip')) document.getElementById('module-transport-trip').style.display = 'block';
                break;
            case 'SCHOOL':
                if(document.getElementById('module-school-fees')) document.getElementById('module-school-fees').style.display = 'block';
                break;
            case 'LOAN_DSA': case 'RECOVERY_AGENT': case 'INSURANCE_AGENCY':
                if(document.getElementById('module-finance-collection')) document.getElementById('module-finance-collection').style.display = 'block';
                if(document.getElementById('module-geo-tagging')) document.getElementById('module-geo-tagging').style.display = 'block';
                break;
            case 'TENT_HOUSE':
                if(document.getElementById('module-rental-stock')) document.getElementById('module-rental-stock').style.display = 'block';
                break;
            default: break;
        }

        // ============================================================
        // 3. DASHBOARD DATA LOADING
        // ============================================================
        try {
            // A. Financial Summary (Top Cards)
            const sumRes = await fetchApi('/api/dashboard/summary', { method: 'GET' }, null);
            if (sumRes.success) {
                document.getElementById('total-sales-revenue').innerText = formatCurrency(sumRes.summary.totalSales);
                document.getElementById('total-stock-value').innerText = formatCurrency(sumRes.summary.currentStockValue);
            }

            // B. Fetch Data for Dashboard Tables
            const [stockRes, salesRes] = await Promise.all([
                fetchApi('/api/stock', { method: 'GET' }, null),
                fetchApi('/api/invoices', { method: 'GET' }, null)
            ]);

            // --- 1. Low Stock Logic ---
            const lowStockItems = stockRes.success ? stockRes.stock.filter(item => item.quantity < 10) : [];
            const lowStockCountEl = document.getElementById('low-stock-count');
            const lowStockBody = document.getElementById('low-stock-table-body');

            if (lowStockCountEl) lowStockCountEl.innerText = lowStockItems.length;
            
            if (lowStockBody) {
                lowStockBody.innerHTML = '';
                if (lowStockItems.length > 0) {
                    lowStockItems.slice(0, 5).forEach(item => {
                        lowStockBody.innerHTML += `
                            <tr>
                                <td>${item.sku}</td>
                                <td>${item.name}</td>
                                <td class="text-danger fw-bold">${item.quantity}</td>
                            </tr>`;
                    });
                } else {
                    lowStockBody.innerHTML = `<tr><td colspan="3" class="text-center text-muted small">рд╕рдм рдареАрдХ рд╣реИ!</td></tr>`;
                }
            }

            // --- 2. Recent Sales Logic (UPDATED WITH DATE) ---
            const recentSalesBody = document.getElementById('recent-sales-table-body');
            if (recentSalesBody) {
                recentSalesBody.innerHTML = '';
                if (salesRes.success && salesRes.sales.length > 0) {
                    salesRes.sales.slice(0, 5).forEach(sale => {
                        
                        // ЁЯЪА NEW CODE ADDED HERE (Date Formatting)
                        let dateStr = "---";
                        if(sale.created_at) {
                            dateStr = new Date(sale.created_at).toLocaleDateString('en-IN', {
                                day: 'numeric', month: 'short'
                            });
                        }
                        // ЁЯЪА END NEW CODE

                        recentSalesBody.innerHTML += `
                            <tr>
                                <td>INV-${sale.id}</td>
                                <td>${sale.customer_name || 'Cash'}</td>
                                <td class="fw-bold">${formatCurrency(sale.total_amount)}</td>
                                <td class="small text-muted fw-bold">${dateStr}</td>
                            </tr>`;
                    });
                } else {
                    recentSalesBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted small">рдХреЛрдИ рдмрд┐рдХреНрд░реА рдирд╣реАрдВ</td></tr>`;
                }
            }

            // --- 3. Total Customers Logic (UPDATED WITH DATE) ---
            const canAccessCRM = (typeof checkUserPlan === 'function') ? checkUserPlan(['MEDIUM', 'PREMIUM']) : true;
            const totalCustEl = document.getElementById('total-customers');
            
            if (canAccessCRM && totalCustEl) {
                const custRes = await fetchApi('/api/customers', { method: 'GET' }, null);
                if (custRes.success) {
                    totalCustEl.innerText = custRes.customers.length;
                    
                    const recentCustBody = document.getElementById('recent-customers-table-body');
                    if(recentCustBody) {
                        recentCustBody.innerHTML = '';
                        const sorted = custRes.customers.sort((a,b) => new Date(b.created_at) - new Date(a.created_at)).slice(0, 5);
                        
                        if(sorted.length > 0) {
                            sorted.forEach(c => {
                                
                                // ЁЯЪА NEW CODE ADDED HERE (Date Formatting)
                                let joinDate = "---";
                                if(c.created_at) {
                                    joinDate = new Date(c.created_at).toLocaleDateString('en-IN', {
                                        day: 'numeric', month: 'short'
                                    });
                                }
                                // ЁЯЪА END NEW CODE

                                recentCustBody.innerHTML += `
                                    <tr>
                                        <td>${c.name}</td>
                                        <td>${c.phone || '-'}</td>
                                        <td class="small text-muted">${joinDate}</td>
                                    </tr>`;
                            });
                        } else {
                            recentCustBody.innerHTML = `<tr><td colspan="3" class="text-center text-muted small">рдХреЛрдИ рдЧреНрд░рд╛рд╣рдХ рдирд╣реАрдВ</td></tr>`;
                        }
                    }
                }
            } else if (totalCustEl) {
                totalCustEl.innerText = 'N/A';
            }

            // C. Refresh Charts
            if (typeof renderSalesChart === 'function') {
                renderSalesChart();
            }

        } catch (error) {
            console.error("Dashboard Data Loading Error:", error);
        }
    }
}
    // [ рдирдпрд╛ renderDashboard() рдлрд╝рдВрдХреНрд╢рди рдпрд╣рд╛рдБ рд╕рдорд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИ ]
    // ==========================================================
// ========== UPDATED: renderReports (Bank-Style Detail) ==========
// ==========================================================
async function renderReports() {
    // 1. Get date range (assuming server defaults if not provided, but server code requires it)
    const endDate = getISODate();
    const startDate = getISODate(new Date(new Date().setDate(new Date().getDate() - 90))); // 90-day default

    try {
        // 2. Fetch P&L Report first
     
// [ рд▓рд╛рдЗрди 2274 рд╕реЗ рдареАрдХ рдкрд╣рд▓реЗ рдпрд╣ 4 рд▓рд╛рдЗрдиреЗрдВ рдЬреЛрдбрд╝реЗрдВ ]
if (!checkUserPlan(['MEDIUM', 'PREMIUM'])) {
    document.getElementById('pl-card').querySelectorAll('tbody')[0].innerHTML = '<tr><td colspan="2" class="text-center text-muted">P&L рд░рд┐рдкреЛрд░реНрдЯ рдЗрд╕ рдкреНрд▓рд╛рди рдореЗрдВ рдирд╣реАрдВ рд╣реИред</td></tr>';
    document.getElementById('bs-card').querySelectorAll('tbody')[0].innerHTML = '<tr><td colspan="2" class="text-center text-muted">рдмреИрд▓реЗрдВрд╕ рд╢реАрдЯ рдХреЗ рд▓рд┐рдП P&L рдЖрд╡рд╢реНрдпрдХ рд╣реИред</td></tr>';
    return; // 'BASIC' рдпреВреЫрд░ рдХреЗ рд▓рд┐рдП рдлрдВрдХреНрд╢рди рдХреЛ рдпрд╣реАрдВ рд░реЛрдХ рджреЗрдВ
}
      
      
        const plRes = await fetchApi(`/api/reports/profit-loss?startDate=${startDate}&endDate=${endDate}`, { method: 'GET' }, 'P&L рд░рд┐рдкреЛрд░реНрдЯ рд▓реЛрдб рд╣реЛ рд░рд╣реА рд╣реИ...');
        
        if (!plRes.success) {
            throw new Error(plRes.message || 'P&L рд░рд┐рдкреЛрд░реНрдЯ рд▓реЛрдб рдХрд░рдиреЗ рдореЗрдВ рд╡рд┐рдлрд▓ред');
        }
        
        const pl = plRes.report;
        const netProfit = pl.netProfit; // Save this for the Balance Sheet

        // 3. Populate P&L Table (Debit Side)
        // [рдпрд╣ 'pl-card' рдХреЗ рдЕрдВрджрд░ рдкрд╣рд▓реЗ <tbody> рдХреЛ рдЪреБрдирддрд╛ рд╣реИ]
        const plDebitBody = document.getElementById('pl-card').querySelectorAll('tbody')[0];
        plDebitBody.innerHTML = ''; // Clear existing static rows
        pl.debit.forEach(item => {
            plDebitBody.innerHTML += `<tr>
                                        <td>${item.description}</td>
                                        <td class="text-end">${formatCurrency(item.amount)}</td>
                                      </tr>`;
        });
        // Total Debit
        document.getElementById('report-pl-total-debit').innerText = formatCurrency(pl.totalDebit);

        // 4. Populate P&L Table (Credit Side)
        // [рдпрд╣ 'pl-card' рдХреЗ рдЕрдВрджрд░ рджреВрд╕рд░реЗ <tbody> рдХреЛ рдЪреБрдирддрд╛ рд╣реИ]
        const plCreditBody = document.getElementById('pl-card').querySelectorAll('tbody')[1];
        plCreditBody.innerHTML = ''; // Clear existing static rows
        pl.credit.forEach(item => {
            plCreditBody.innerHTML += `<tr>
                                        <td>${item.description}</td>
                                        <td class="text-end">${formatCurrency(item.amount)}</td>
                                      </tr>`;
        });
        // Total Credit
        document.getElementById('report-pl-total-credit').innerText = formatCurrency(pl.totalCredit);

        // 5. Fetch Balance Sheet Report (passing the calculated netProfit)
        // [рдпрд╣ P&L рд╕реЗ рдкреНрд░рд╛рдкреНрдд рд╢реБрджреНрдз рд▓рд╛рдн рдХреЛ рдмреИрд▓реЗрдВрд╕ рд╢реАрдЯ API рдХреЛ рднреЗрдЬрддрд╛ рд╣реИ]
        const bsRes = await fetchApi(`/api/reports/balance-sheet?netProfit=${netProfit}`, { method: 'GET' }, 'рдмреИрд▓реЗрдВрд╕ рд╢реАрдЯ рд▓реЛрдб рд╣реЛ рд░рд╣реА рд╣реИ...');

        if (!bsRes.success) {
            throw new Error(bsRes.message || 'рдмреИрд▓реЗрдВрд╕ рд╢реАрдЯ рд▓реЛрдб рдХрд░рдиреЗ рдореЗрдВ рд╡рд┐рдлрд▓ред');
        }
        
        const bs = bsRes.report;

        // 6. Populate Balance Sheet (Liabilities & Equity Side)
        // [рдпрд╣ 'bs-card' рдХреЗ рдЕрдВрджрд░ рдкрд╣рд▓реЗ <tbody> рдХреЛ рдЪреБрдирддрд╛ рд╣реИ]
        const bsLiabilitiesBody = document.getElementById('bs-card').querySelectorAll('tbody')[0];
        bsLiabilitiesBody.innerHTML = ''; // Clear existing static rows
        
        // Liabilities (рджреЗрдирджрд╛рд░рд┐рдпрд╛рдВ)
        bs.liabilities.forEach(item => {
            bsLiabilitiesBody.innerHTML += `<tr>
                                                <td>${item.description}</td>
                                                <td class="text-end">${formatCurrency(item.amount)}</td>
                                            </tr>`;
        });
        // Equity (рдЗрдХреНрд╡рд┐рдЯреА)
        bs.equity.forEach(item => {
            bsLiabilitiesBody.innerHTML += `<tr>
                                                <td>${item.description}</td>
                                                <td class="text-end">${formatCurrency(item.amount)}</td>
                                            </tr>`;
        });
        // Total Liabilities & Equity
        document.getElementById('report-bs-total-liabilities').innerText = formatCurrency(bs.totalLiabilitiesAndEquity);

        // 7. Populate Balance Sheet (Assets Side)
        // [рдпрд╣ 'bs-card' рдХреЗ рдЕрдВрджрд░ рджреВрд╕рд░реЗ <tbody> рдХреЛ рдЪреБрдирддрд╛ рд╣реИ]
        const bsAssetsBody = document.getElementById('bs-card').querySelectorAll('tbody')[1];
        bsAssetsBody.innerHTML = ''; // Clear existing static rows
        
        // Assets (рдкрд░рд┐рд╕рдВрдкрддреНрддрд┐рдпрд╛рдВ)
        bs.assets.forEach(item => {
            let note = item.note ? `<small class="text-muted d-block">${item.note}</small>` : '';
            bsAssetsBody.innerHTML += `<tr>
                                        <td>${item.description} ${note}</td>
                                        <td class="text-end">${formatCurrency(item.amount)}</td>
                                      </tr>`;
        });
        // Total Assets
        document.getElementById('report-bs-total-assets').innerText = formatCurrency(bs.totalAssets);
        
        console.log("тЬЕ Reports updated successfully with details.");

    } catch (error) {
        console.error("renderReports рддреНрд░реБрдЯрд┐:", error);
        showMessage('рд╕рд░реНрд╡рд░ рддреНрд░реБрдЯрд┐', `рд░рд┐рдкреЛрд░реНрдЯреНрд╕ рд▓реЛрдб рдирд╣реАрдВ рд╣реЛ рд╕рдХреА: ${error.message}`, 'danger');
        
        // Clear tables on error to avoid showing old data
        document.getElementById('pl-card').querySelectorAll('tbody')[0].innerHTML = '<tr><td colspan="2" class="text-danger text-center">P&L рд▓реЛрдб рдХрд░рдиреЗ рдореЗрдВ рд╡рд┐рдлрд▓ред</td></tr>';
        document.getElementById('pl-card').querySelectorAll('tbody')[1].innerHTML = '<tr><td colspan="2" class="text-danger text-center"></td></tr>';
        document.getElementById('bs-card').querySelectorAll('tbody')[0].innerHTML = '<tr><td colspan="2" class="text-danger text-center">BS рд▓реЛрдб рдХрд░рдиреЗ рдореЗрдВ рд╡рд┐рдлрд▓ред</td></tr>';
        document.getElementById('bs-card').querySelectorAll('tbody')[1].innerHTML = '<tr><td colspan="2" class="text-danger text-center"></td></tr>';
    }
}
// ==========================================================
// ========== END OF UPDATED FUNCTION ==========
// ==========================================================



async function fetchAndRenderStockList() {
    console.log('Fetching Stock List & Configuring View...');

    // 1. Business Type Detection
    const btype = AppState.user && AppState.user.businessType ? AppState.user.businessType.trim().toUpperCase() : 'RETAIL';
    
    // Group Classifications for logic
    const isSalon = (btype === 'SALON');
    const isGarments = [ 'CLOTHING', 'GARMENTS', 'BOUTIQUE', 'FASHION' ].includes(btype);
    const isEating = [ 'RESTAURANT', 'HOTEL', 'CAFE', 'BAKERY' ].includes(btype);

    // --- PART A: FORM CLEANUP & RESET ---
    // Remove all dynamic fields to prevent duplication
    document.querySelectorAll('#dynamic-business-fields').forEach(el => el.remove()); 
    const existingGarmentForm = document.getElementById('garments-security-fields');
    if (existingGarmentForm) existingGarmentForm.remove();

    const cDiv = document.getElementById('consumption-ui-area');
    if(cDiv) cDiv.remove();
    const typeDiv = document.getElementById('stock-type-selector-area');
    if(typeDiv) typeDiv.remove();
    
    // Remove Bulk Container if exists
    const bulkDiv = document.getElementById('dish-bulk-container');
    if(bulkDiv) bulkDiv.remove();

    // 2. FORM ELEMENTS SELECTORS
    const form = document.getElementById('add-stock-form');
    const submitBtnDiv = form.querySelector('button[type="submit"]').parentElement;
    
    // Field Wrappers
    const skuDiv = document.querySelector('label[for="stock-sku"]').parentElement;
    const qtyDiv = document.querySelector('label[for="stock-quantity"]').parentElement;
    const unitDiv = document.querySelector('label[for="stock-unit"]').parentElement;
    const gstDiv = document.querySelector('label[for="stock-gst"]').parentElement;
    const hsnDiv = document.querySelector('label[for="stock-hsn-code"]').parentElement;
    const durationDiv = document.getElementById('stock-duration-div'); 

    // Labels
    const nameLabel = document.querySelector('label[for="stock-name"]');
    const pPriceLabel = document.querySelector('label[for="stock-purchase-price"]');
    const sPriceLabel = document.querySelector('label[for="stock-sale-price"]');
    const qtyLabel = document.querySelector('label[for="stock-quantity"]');
    const unitInput = document.getElementById('stock-unit');

    // =========================================================
    // ЁЯФе FIX: OPTICAL / EXTRA DETAILS KO DEFAULT MEIN CHUPANA
    // =========================================================
    const opticalBtn = document.getElementById('add-custom-field-btn');
    const opticalContainer = document.getElementById('prescription-fields-container');
    let extraHeader = null, extraDesc = null, extraHr = null;

    document.querySelectorAll('#add-stock-form > *').forEach(el => {
        if (el.tagName === 'H6' && el.innerText.includes('рдЕрддрд┐рд░рд┐рдХреНрдд рд╡рд┐рд╡рд░рдг')) {
            extraHeader = el; el.style.display = 'none';
        }
        if (el.tagName === 'P' && el.innerText.includes('Chasme ke liye')) {
            extraDesc = el; el.style.display = 'none';
        }
        if (el.tagName === 'HR' && el.nextElementSibling && el.nextElementSibling.innerText.includes('рдЕрддрд┐рд░рд┐рдХреНрдд рд╡рд┐рд╡рд░рдг')) {
             extraHr = el; el.style.display = 'none';
        }
    });

    if (opticalBtn) {
        const wrapper = opticalBtn.closest('.col-12') || opticalBtn.parentElement;
        if(wrapper) wrapper.style.display = 'none';
    }
    if (opticalContainer) opticalContainer.style.display = 'none';

    // Reset Standard Visibility
    skuDiv.style.display = 'block';
    qtyDiv.style.display = 'block';
    unitDiv.style.display = 'block';
    hsnDiv.style.display = 'block';
    gstDiv.style.display = 'block';
    if(durationDiv) durationDiv.style.display = 'none';

    // Reset Labels
    nameLabel.innerText = 'рдЖрдЗрдЯрдо рдХрд╛ рдирд╛рдо';
    pPriceLabel.innerText = 'рдЦрд░реАрдж рдореВрд▓реНрдп (тВ╣)';
    sPriceLabel.innerText = 'рдмрд┐рдХреНрд░реА рдореВрд▓реНрдп (тВ╣)';
    qtyLabel.innerText = 'рдорд╛рддреНрд░рд╛ (Qty)';
    unitInput.placeholder = "Pcs / Kg / Box";

    // =========================================================
    // ЁЯФе GARMENTS SPECIAL: ANTI-THEFT FORM
    // =========================================================
    if (isGarments) {
        nameLabel.innerText = 'Design Name / Article No.';
        unitInput.placeholder = "Pcs";

        const securityDiv = document.createElement('div');
        securityDiv.id = 'garments-security-fields';
        securityDiv.className = 'col-12 p-3 mb-3 border rounded border-danger bg-danger bg-opacity-10';
        securityDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="text-danger fw-bold m-0"><i class="fas fa-shield-alt"></i> Anti-Theft Security</h6>
                <span class="badge bg-danger">SECURE MODE</span>
            </div>
            <div class="row g-3">
                <div class="col-12">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="sec-tag-attached" checked>
                        <label class="form-check-label fw-bold text-dark" for="sec-tag-attached">Hard Tag Attached (рд╣рд╛рд░реНрдб рдЯреИрдЧ)</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold">Scan RFID / Barcode</label>
                    <input type="text" id="sec-rfid-code" class="form-control form-control-sm" placeholder="Scan Tag Here">
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold">Section</label>
                    <select id="sec-floor-loc" class="form-select form-select-sm">
                        <option>Men's Section</option>
                        <option>Women's Section</option>
                        <option>Kids Section</option>
                    </select>
                </div>
            </div>`;
        form.insertBefore(securityDiv, submitBtnDiv);
    }

    // =========================================================
    // ЁЯПЧя╕П BUSINESS SPECIFIC LOGIC (FULL 31 TYPES LISTED)
    // =========================================================

    switch (btype) {
        // --- 1. SALON & FOOD (Menu / Service Mode) ---
        case 'SALON':
        case 'RESTAURANT':
        case 'HOTEL':
        case 'CAFE':
        case 'BAKERY':
            const typeALabel = (btype === 'SALON') ? 'рд╕рд░реНрд╡рд┐рд╕ (Service)' : 'рдбрд┐рд╢ (Dish / Food)';
            const typeBLabel = 'рдкреНрд░реЛрдбрдХреНрдЯ (Inventory)';

            const typeSelectDiv = document.createElement('div');
            typeSelectDiv.id = 'stock-type-selector-area';
            typeSelectDiv.className = 'col-12 mb-3 p-2 bg-warning bg-opacity-10 border border-warning rounded';
            typeSelectDiv.innerHTML = `
                <label class="fw-bold small text-dark mb-1">рдЖрдк рдХреНрдпрд╛ рдЬреЛрдбрд╝ рд░рд╣реЗ рд╣реИрдВ?</label>
                <div class="d-flex gap-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="itemType" id="typeService" value="SERVICE" checked onchange="toggleSmartFields()">
                        <label class="form-check-label fw-bold text-primary" for="typeService"><i class="fas fa-utensils"></i> ${typeALabel}</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="itemType" id="typeProduct" value="PRODUCT" onchange="toggleSmartFields()">
                        <label class="form-check-label fw-bold text-success" for="typeProduct"><i class="fas fa-box-open"></i> ${typeBLabel}</label>
                    </div>
                </div>`;
            form.insertBefore(typeSelectDiv, form.firstChild);

            window.toggleSmartFields = function() {
                const isService = document.getElementById('typeService').checked;
                hsnDiv.style.display = 'none';
                gstDiv.style.display = 'none';
                
                if (isService) {
                    qtyDiv.style.display = 'none';
                    unitDiv.style.display = 'none';
                    skuDiv.style.display = 'none';
                    pPriceLabel.parentElement.style.display = 'none';
                    sPriceLabel.parentElement.style.display = 'none'; 
                    nameLabel.parentElement.style.display = 'none';
                    if(durationDiv) durationDiv.style.display = 'none';

                    let multiRowContainer = document.getElementById('dish-bulk-container');
                    if (!multiRowContainer) {
                        multiRowContainer = document.createElement('div');
                        multiRowContainer.id = 'dish-bulk-container';
                        multiRowContainer.className = 'col-12 mt-2 p-3 border rounded bg-light';
                        multiRowContainer.innerHTML = `
                            <div id="hotel-bulk-dish-section">
                                <h6 class="text-primary mb-3"></h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered mb-0 bg-white">
                                        <thead class="table-warning">
                                            <tr><th style="width: 60%;">Name</th><th style="width: 30%;">Price (тВ╣)</th><th style="width: 10%;"></th></tr>
                                        </thead>
                                        <tbody id="dish-bulk-body"></tbody>
                                    </table>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-secondary w-100 mt-2" id="bulk-add-btn" onclick="addDishRow()">
                                    <i class="fas fa-plus"></i> Add More
                                </button>
                            </div>`;
                        form.insertBefore(multiRowContainer, submitBtnDiv);
                        if(typeof window.addDishRow === 'function') window.addDishRow();
                    }
                    multiRowContainer.style.display = 'block';
                    const titleEl = multiRowContainer.querySelector('h6');
                    const btnEl = document.getElementById('bulk-add-btn');
                    if (isSalon) {
                        if(titleEl) titleEl.innerHTML = '<i class="fas fa-cut"></i> Bulk Services Entry';
                        if(btnEl) btnEl.innerHTML = '<i class="fas fa-plus"></i> Add Service';
                    } else {
                        if(titleEl) titleEl.innerHTML = '<i class="fas fa-utensils"></i> Bulk Menu Entry';
                        if(btnEl) btnEl.innerHTML = '<i class="fas fa-plus"></i> Add Dish';
                    }
                    document.getElementById('stock-quantity').value = '10000';
                    document.getElementById('stock-unit').value = isSalon ? 'Session' : 'Plate';
                    document.getElementById('stock-purchase-price').value = '0';
                    document.getElementById('stock-sku').value = 'BULK-' + Date.now();
                    document.getElementById('stock-name').value = 'BULK_ENTRY'; 
                    document.getElementById('stock-sale-price').value = '0';
                } else {
                    const multiRowContainer = document.getElementById('dish-bulk-container');
                    if (multiRowContainer) multiRowContainer.style.display = 'none';
                    qtyDiv.style.display = 'block';
                    unitDiv.style.display = 'block';
                    skuDiv.style.display = 'block';
                    pPriceLabel.parentElement.style.display = 'block';
                    sPriceLabel.parentElement.style.display = 'block';
                    nameLabel.parentElement.style.display = 'block';
                    document.getElementById('stock-quantity').value = '';
                    document.getElementById('stock-unit').value = 'Pcs';
                    document.getElementById('stock-sku').value = '';
                    document.getElementById('stock-purchase-price').value = '';
                    document.getElementById('stock-name').value = '';
                    document.getElementById('stock-sale-price').value = '';
                }
            };
            window.toggleSmartFields();
            break;
            
        // --- 2. RETAIL & FOOD (Expiry/Batch) ---
        case 'PHARMACY':
        case 'SWEET_SHOP':
        case 'GYM': 
        case 'RETAIL': 
        case 'GROCERY':
            const expiryDiv = document.createElement('div');
            expiryDiv.id = 'dynamic-business-fields';
            expiryDiv.className = 'col-12 border rounded p-3 mt-2 bg-light mb-3';
            expiryDiv.innerHTML = `
                <h6 class="text-primary small fw-bold"><i class="fas fa-clock"></i> Expiry & Batch Details</h6>
                <div class="row g-2">
                    <div class="col-md-6"><label class="form-label small">Expiry Date</label><input type="date" id="stock-expiry" class="form-control form-control-sm"></div>
                    <div class="col-md-6"><label class="form-label small">Batch Number</label><input type="text" id="stock-batch" class="form-control form-control-sm" placeholder="Batch No."></div>
                </div>`;
            form.insertBefore(expiryDiv, submitBtnDiv);
            break;

        // --- 3. ELECTRONICS (IMEI) ---
        case 'MOBILE_SHOP':
        case 'ELECTRONICS':
        case 'SIM_STORE':
            const imeiDiv = document.createElement('div');
            imeiDiv.id = 'dynamic-business-fields';
            imeiDiv.className = 'col-12 mb-3';
            imeiDiv.innerHTML = `
                <label class="form-label small text-info fw-bold">Device Details</label>
                <div class="row g-2">
                    <div class="col-md-6"><input type="text" id="item_imei" class="form-control form-control-sm" placeholder="IMEI / Serial No"></div>
                    <div class="col-md-6"><input type="text" id="item_model" class="form-control form-control-sm" placeholder="Model / Color"></div>
                </div>`;
            form.insertBefore(imeiDiv, submitBtnDiv);
            break;

        // --- 4. HARDWARE ---
        case 'HARDWARE_PAINT':
            unitInput.placeholder = "Liters / Kg / Drum";
            break;

        // --- 5. TILES ---
        case 'TILES_CERAMIC':
            qtyLabel.innerText = "Quantity (Boxes)";
            if(document.getElementById('module-tiles-calc')) 
               document.getElementById('module-tiles-calc').style.display = 'block';
            break;

        // --- 6. TENT HOUSE ---
        case 'TENT_HOUSE':
            if(document.getElementById('module-rental-stock')) 
               document.getElementById('module-rental-stock').style.display = 'block';
            sPriceLabel.innerText = "Replacement Cost (If Lost)";
            break;

        // --- 7. MEDICAL (No Optical Fields) ---
        case 'DENTIST': 
        case 'DOCTOR_CLINIC':
        case 'ORTHOPEDIC':
        case 'SONOGRAPHY':
        case 'PHYSIOTHERAPY':
        case 'PATHOLOGY':
             break; // Standard behavior, don't show optical fields

        // --- 8. OPTICAL (SHOW HIDDEN FIELDS) ---
        case 'OPTICAL':
            if (extraHeader) extraHeader.style.display = 'block';
            if (extraDesc) extraDesc.style.display = 'block';
            if (extraHr) extraHr.style.display = 'block';
            if (opticalBtn) {
                const wrapper = opticalBtn.closest('.col-12') || opticalBtn.parentElement;
                if(wrapper) wrapper.style.display = 'block';
            }
            break;

        // --- 9. SERVICES / OFFICE / MISC ---
        case 'LOAN_DSA':
        case 'RECOVERY_AGENT':
        case 'INSURANCE_AGENCY':
        case 'ARCHITECT_FIRM':
        case 'SOFTWARE_COMPANY':
        case 'SCHOOL':
        case 'TRANSPORT':
        case 'SERVICE_CENTER':
            break; // Standard entry

        // --- 10. CLOTHING / LIFESTYLE (Garments Logic handled globally) ---
        case 'TAILOR':
        case 'CLOTHING':
        case 'FURNITURE':
        case 'JEWELLERY':
        case 'GARMENTS':
        case 'BOUTIQUE':
        case 'FASHION':
            break;

        default:
            break;
    }

    // --- PART B: TABLE RENDER ---
    const tableHead = document.querySelector('#stock table thead');
    const tableBody = document.getElementById('stock-table-body');
    const tableFoot = document.getElementById('stock-table-foot');

    // 1. SET TABLE HEADERS
    if (isSalon) {
        tableHead.innerHTML = `<tr><th style="width:10%">Type</th><th style="width:25%">Name</th><th style="width:15%">Stock/Unit</th><th style="width:15%">Cost (тВ╣)</th><th style="width:15%">Price (тВ╣)</th><th style="width:20%">Action</th></tr>`;
    } else if (isGarments) {
        // тЬЕ Corrected Headers for Garments (7 Cols)
        tableHead.innerHTML = `<tr>
            <th style="width:15%">Article/SKU</th>
            <th style="width:20%">Design Name</th>
            <th style="width:10%">Stock</th>
            <th style="width:10%">Cost (тВ╣)</th>
            <th style="width:10%">Price (тВ╣)</th>
            <th style="width:15%">Last Updated</th>
            <th style="width:20%">Action</th>
        </tr>`;
    } else {
        tableHead.innerHTML = `<tr><th>SKU</th><th>Item Name</th><th>Qty</th><th>Purchase</th><th>Sale</th><th>GST %</th><th>Updated</th><th>Attributes/Expiry</th><th>Action</th></tr>`;
    }

    const initialColSpan = isSalon ? 6 : (isGarments ? 7 : 9); 
    tableBody.innerHTML = `<tr><td colspan="${initialColSpan}" class="text-center py-3"><div class="spinner-border text-primary"></div></td></tr>`;
    if(tableFoot) tableFoot.innerHTML = '';

    try {
        const res = await fetchApi('/api/stock', { method: 'GET' });
        tableBody.innerHTML = '';
        const items = res.stock || [];

        if (res.success && items.length > 0) {
            let totalPurchaseValue = 0;
            let totalSaleValue = 0;

            items.forEach(item => {
                const row = tableBody.insertRow();
                const attrs = item.product_attributes || {};
                
                const safeSku = item.sku.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const itemDataSafe = JSON.stringify({ sku: item.sku, name: item.name, sale_price: item.sale_price, purchase_price: item.purchase_price }).replace(/"/g, '&quot;');

                // 1. SALON ROW
                if (isSalon) {
                    const isSvc = (item.sku && String(item.sku).startsWith('SVC-')) || item.unit === 'Session';
                    const typeBadge = isSvc ? `<span class="badge bg-primary">Service</span>` : `<span class="badge bg-success">Product</span>`;
                    const stockDisplay = isSvc ? `<span class="text-muted small">N/A</span>` : `<span class="fw-bold text-dark">${item.quantity} <small class="text-muted">${item.unit}</small></span>`;

                    row.innerHTML = `
                        <td>${typeBadge}</td>
                        <td class="fw-bold text-dark">${item.name} <br><small class="text-muted" style="font-size:0.75rem">${item.code || item.sku}</small></td>
                        <td>${stockDisplay}</td>
                        <td>${formatCurrency(item.purchase_price || 0)}</td> 
                        <td>${formatCurrency(item.price || item.sale_price)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editStockItem('${safeSku}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-outline-danger" data-role="ADMIN" onclick="deleteEntry('stock', '${safeSku}')"><i class="fas fa-trash"></i></button>
                        </td>`;
                } 
                // 2. GARMENTS ROW
                else if (isGarments) {
                    totalPurchaseValue += (item.purchase_price || 0) * (item.quantity || 0);
                    totalSaleValue += (item.sale_price || 0) * (item.quantity || 0);

                    const anti = item.product_attributes || {};
                    const lockIcon = anti.is_secured
                    ? `<i class="fas fa-lock text-danger ms-1" title="Anti-Theft Enabled"></i>`
                    : '';


                    row.innerHTML = `
                        <td><span class="badge bg-secondary">${item.sku}</span></td>
                        <td class="fw-bold text-dark">
                            ${item.name} ${lockIcon}
                        </td>
                        <td><span class="fw-bold">${item.quantity}</span> Pcs</td>
                        <td>${formatCurrency(item.purchase_price || 0)}</td>
                        <td>${formatCurrency(item.sale_price)}</td>
                        <td>${new Date(item.updated_at).toLocaleDateString()}</td> 
                        <td>
                            <button class="btn btn-sm btn-primary me-1" onclick="editStockItem('${safeSku}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-info text-white me-1" onclick="printItemSticker(${itemDataSafe})"><i class="fas fa-qrcode"></i></button>
                            <button class="btn btn-sm btn-danger" data-role="ADMIN" onclick="deleteEntry('stock', '${safeSku}')"><i class="fas fa-trash"></i></button>
                        </td>`;
                } 
                // 3. STANDARD ROW
                else {
                    totalPurchaseValue += (item.purchase_price || 0) * (item.quantity || 0);
                    totalSaleValue += (item.sale_price || 0) * (item.quantity || 0);

                    let attrDisplay = formatAttributes(attrs); 
                    if (attrs.expiry) attrDisplay += `<br><span class="badge bg-danger">Exp: ${attrs.expiry}</span>`;
                    if (attrs.batch) attrDisplay += ` <small class="text-muted">Batch: ${attrs.batch}</small>`;

                    row.innerHTML = `
                        <td>${item.sku}</td>
                        <td>${item.name}</td>
                        <td>${item.quantity} ${item.unit || ''}</td>
                        <td>${formatCurrency(item.purchase_price)}</td>
                        <td>${formatCurrency(item.sale_price)}</td>
                        <td>${item.gst || 0}%</td>
                        <td>${new Date(item.updated_at).toLocaleDateString()}</td>
                        <td>${attrDisplay}</td>
                        <td>
                            <button class="btn btn-sm btn-primary me-1 mb-1" onclick="editStockItem('${safeSku}')" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-info text-white mb-1" onclick="printItemSticker(${itemDataSafe})" title="Print QR"><i class="fas fa-qrcode"></i></button>
                            <button class="btn btn-sm btn-danger mb-1" data-role="ADMIN" onclick="deleteEntry('stock', '${safeSku}')" title="Delete"><i class="fas fa-trash"></i></button>
                        </td>`;
                }
            });

            if (!isSalon) {
                // Gap Calculation: Garments = 2 (7 cols - 5 used). Standard = 4 (9 cols - 5 used).
                const footerGap = isGarments ? 2 : 4;
                tableFoot.innerHTML = `<tr class="fw-bold bg-light"><td colspan="3">рдХреБрд▓ (Total)</td><td>${formatCurrency(totalPurchaseValue)}</td><td>${formatCurrency(totalSaleValue)}</td><td colspan="${footerGap}"></td></tr>`;
            }
        } else {
            const emptyColSpan = isSalon ? 6 : (isGarments ? 7 : 9);
            tableBody.innerHTML = `<tr><td colspan="${emptyColSpan}" class="text-center text-muted py-4">рдХреЛрдИ рдбреЗрдЯрд╛ рдирд╣реАрдВ рдорд┐рд▓рд╛ред</td></tr>`;
        }
    } catch (e) {
        console.error(e);
        const errorColSpan = isSalon ? 6 : (isGarments ? 7 : 9);
        tableBody.innerHTML = `<tr><td colspan="${errorColSpan}" class="text-center text-danger">рддреНрд░реБрдЯрд┐: ${e.message}</td></tr>`;
    }
}

function editStockItem(sku) {
    // 1. Fetch Fresh Data
    fetchApi(`/api/get-stock-item/${sku}`, { method: 'GET' }, 'рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...').then(res => {
        if(res.success && res.data) {
            const item = res.data;
            const form = document.getElementById('add-stock-form');
            
            // 2. Scroll to Form
            form.scrollIntoView({ behavior: 'smooth' });

            // 3. Handle Salon Type (Service/Product)
            const isService = (String(sku).startsWith('SVC-') || item.unit === 'Session');
            if (document.getElementById('typeService')) {
                document.getElementById(isService ? 'typeService' : 'typeProduct').checked = true;
                if (window.toggleSalonFields) window.toggleSalonFields();
            }

            // 4. Fill Fields
            document.getElementById('stock-name').value = item.name;
            document.getElementById('stock-purchase-price').value = item.purchase_price;
            document.getElementById('stock-sale-price').value = item.sale_price;
            document.getElementById('stock-gst').value = item.gst_rate || 0;
            
            if (!isService) {
                document.getElementById('stock-quantity').value = item.quantity;
                document.getElementById('stock-unit').value = item.unit || 'Pcs';
            }

            // 5. SKU Handling (CRITICAL: Lock SKU so it updates instead of adding new)
            const skuInput = document.getElementById('stock-sku');
            skuInput.value = sku; 
            skuInput.disabled = true; // Disable to prevent change
            skuInput.style.backgroundColor = '#e9ecef'; // Visual cue

            // 6. Change Button to "Update"
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<i class="fas fa-save"></i> рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ (Update)';
            submitBtn.classList.remove('btn-primary');
            submitBtn.classList.add('btn-warning');

            // 7. Set Mode to 'set' (Edit Mode)
            const actionInput = document.getElementById('stock-action-type');
            if(actionInput) actionInput.value = 'set';

            // 8. Add Cancel Button
            if (!document.getElementById('cancel-edit-btn')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.id = 'cancel-edit-btn';
                cancelBtn.type = 'button';
                cancelBtn.className = 'btn btn-secondary ms-2';
                cancelBtn.innerHTML = 'рд░рджреНрдж рдХрд░реЗрдВ';
                cancelBtn.onclick = resetStockForm;
                submitBtn.parentElement.appendChild(cancelBtn);
            }
        } else {
            alert('рдЖрдЗрдЯрдо рдХрд╛ рдбреЗрдЯрд╛ рдирд╣реАрдВ рдорд┐рд▓рд╛ред');
        }
    });
}

// [ тЬЕ MISSING FUNCTION: Form рдХреЛ рд░рд┐рд╕реЗрдЯ рдФрд░ рдЕрдирд▓реЙрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП ]

function resetStockForm() {
    const form = document.getElementById('add-stock-form');
    if (!form) return;

    form.reset(); // Clear inputs
    
    // Unlock SKU
    const skuInput = document.getElementById('stock-sku');
    skuInput.disabled = false;
    skuInput.style.backgroundColor = '';
    
    // Reset Button
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.innerHTML = 'рд╕реНрдЯреЙрдХ рдореЗрдВ рдЖрдЗрдЯрдо рдЬреЛрдбрд╝реЗрдВ';
    submitBtn.classList.remove('btn-warning');
    submitBtn.classList.add('btn-primary');
    
    // Remove Cancel Button
    const cancelBtn = document.getElementById('cancel-edit-btn');
    if (cancelBtn) cancelBtn.remove();
    
    // Reset Mode to 'add'
    const actionInput = document.getElementById('stock-action-type');
    if(actionInput) actionInput.value = 'add';
}

    // [ тЬЕ 2. рдЗрд╕ рдкреВрд░реЗ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдЕрдкрдиреЗ рдкреБрд░рд╛рдиреЗ fetchAndRenderCustomers (рд▓рд╛рдЗрди 2404) рд╕реЗ рдмрджрд▓реЗрдВ ]

   // [ тЬЕ NEW: Unified Customer/WhatsApp Ledger for All Business Types ]

// [ тЬЕ FIXED: CUSTOMER TABLE WITH DATE FIX ]
// [ тЬЕ FIXED: CUSTOMER TABLE WITH ROBUST DATE ]
async function fetchAndRenderCustomers() {
    const tableBody = document.getElementById('crm-table-body');
    if (!tableBody) return;

    const isSalon = (AppState.user && AppState.user.businessType === 'SALON');
    
    // рд╣реЗрдбрд░реНрд╕ рд╕реЗрдЯ рдХрд░реЗрдВ
    const tableHead = document.querySelector('#crm table thead tr');
    if (tableHead) {
        tableHead.innerHTML = `
            <th>рдЧреНрд░рд╛рд╣рдХ рдХрд╛ рдирд╛рдо</th>
            <th>рдореЛрдмрд╛рдЗрд▓</th>
            <th>рдмрдХрд╛рдпрд╛</th>
            <th>рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛ (Date)</th> <th>рдПрдХреНрд╢рди</th>
        `;
    }

    tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary"></div></td></tr>`;

    try {
        const res = await fetchApi('/api/customers', { method: 'GET' });
        tableBody.innerHTML = '';
        
        if (res.success && res.customers && res.customers.length > 0) {
            const sortedCustomers = res.customers.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            sortedCustomers.forEach(c => {
                // ЁЯЪА DATE FIX
                let joinDate = "---";
                if (c.created_at) {
                    const d = new Date(c.created_at);
                    if (!isNaN(d.getTime())) {
                        joinDate = d.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: '2-digit' });
                    }
                }

                const displayPhone = (c.phone && c.phone.length > 5) 
                    ? `<span class="fw-bold text-dark">${c.phone}</span>` 
                    : '<span class="text-muted small">--</span>';
                
                const waButton = (c.phone && c.phone.length > 5)
                    ? `<button class="btn btn-sm btn-success py-0 px-2" onclick="sendWhatsAppMessage('${c.phone}', '${c.name}')"><i class="fab fa-whatsapp"></i></button>`
                    : ``;

                const balanceClass = c.balance > 0 ? 'text-danger fw-bold' : 'text-success';

                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="fw-bold">${c.name}</td>
                    <td>${displayPhone}</td>
                    <td class="${balanceClass}">тВ╣${formatCurrency(c.balance || 0).replace('тВ╣', '')}</td>
                    
                    <td class="text-muted fw-bold small">${joinDate}</td>
                    
                    <td>
                        ${waButton}
                        <a class="btn btn-sm btn-primary ms-1" onclick="showEditCustomerModal(${c.id})"><i class="fas fa-edit"></i></a>
                    </td>
                `;
            });
        } else {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4">рдХреЛрдИ рдбреЗрдЯрд╛ рдирд╣реАрдВред</td></tr>`;
        }
    } catch (e) {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">рддреНрд░реБрдЯрд┐: ${e.message}</td></tr>`;
    }
}

// --- (... рдкрд┐рдЫрд▓рд╛ рдЬрд╛рд╡рд╛рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛрдб рдкрд╛рд░реНрдЯ 2 рд╕реЗ рдЬрд╛рд░реА ...) ---

    async function fetchAndRenderPurchases() {
        const tableBody = document.getElementById('purchases-table-body');
        const tableFoot = document.getElementById('purchases-table-foot');
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center">рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...</td></tr>`;
        tableFoot.innerHTML = '';
        try {
            const res = await fetchApi('/api/purchases', { method: 'GET' });
            tableBody.innerHTML = '';
            let totalCost = 0;
            if (res.success && res.purchases.length > 0) {
                res.purchases.forEach(p => {
                    totalCost += parseFloat(p.total_cost || 0);
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${p.id}</td>
                        <td>${p.supplier_name || 'N/A'}</td>
                        <td>${p.item_details}</td>
                        <td>${formatCurrency(p.total_cost)}</td>
                        <td>${new Date(p.created_at).toLocaleDateString()}</td>
                        <td><button class="btn btn-sm btn-danger" data-role="ADMIN" onclick="deleteEntry('purchase', ${p.id})">рд╣рдЯрд╛рдПрдВ</button></td>
                    `;
                });
                tableFoot.innerHTML = `<tr class="fw-bold bg-light"><td colspan="3">рдХреБрд▓ рдЦрд░реАрдж рд░рд╛рд╢рд┐</td><td>${formatCurrency(totalCost)}</td><td colspan="2"></td></tr>`;
            } else {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">рдХреЛрдИ рдЦрд░реАрдж рд░рд┐рдХреЙрд░реНрдб рдирд╣реАрдВ рдорд┐рд▓рд╛ред</td></tr>`;
            }
        } catch (e) {
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">рддреНрд░реБрдЯрд┐: ${e.message}</td></tr>`;
        }
    }

    async function fetchAndRenderExpenses() {
        const tableBody = document.getElementById('expenses-table-body');
        const tableFoot = document.getElementById('expenses-table-foot');
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center">рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...</td></tr>`;
        tableFoot.innerHTML = '';
        try {
            const res = await fetchApi('/api/expenses', { method: 'GET' });
            tableBody.innerHTML = '';
            let totalExpenses = 0;
            if (res.success && res.expenses.length > 0) {
                res.expenses.forEach(ex => {
                    totalExpenses += parseFloat(ex.amount || 0);
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${new Date(ex.created_at).toLocaleDateString()}</td>
                        <td>${ex.category}</td>
                        <td>${ex.description}</td>
                        <td>${formatCurrency(ex.amount)}</td>
                        <td><button class="btn btn-sm btn-danger" data-role="ADMIN" onclick="deleteEntry('expense', ${ex.id})">рд╣рдЯрд╛рдПрдВ</button></td>
                    `;
                });
                tableFoot.innerHTML = `<tr class="fw-bold bg-light"><td colspan="3">рдХреБрд▓ рдЦрд░реНрдЪ рд░рд╛рд╢рд┐</td><td>${formatCurrency(totalExpenses)}</td><td></td></tr>`;
            } else {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">рдХреЛрдИ рдЦрд░реНрдЪ рд░рд┐рдХреЙрд░реНрдб рдирд╣реАрдВ рдорд┐рд▓рд╛ред</td></tr>`;
            }
        } catch (e) {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">рддреНрд░реБрдЯрд┐: ${e.message}</td></tr>`;
        }
    }    
    // --- POS (SALES) SECTION LOGIC ---

    // NEW: Modified to show all items on click (showAll = true)
    // [ тЬЕ SKU рд╕рд░реНрдЪ рдХреЛ рд╕реНрдорд╛рд░реНрдЯ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╕реЗ рдкреЗрд╕реНрдЯ рдХрд░реЗрдВ ]

// тЬЕ UPDATED SEARCH: рдЕрдм рд╕рд░реНрдЪ рд▓рд┐рд╕реНрдЯ рдореЗрдВ рднреА ЁЯФТ (Lock) рджрд┐рдЦреЗрдЧрд╛
function handleItemSearch(showAll = false) {
    const query = document.getElementById('pos-item-search').value.toLowerCase().trim();
    const resultsUl = document.getElementById('pos-search-results');

    if (!showAll && query.length < 1) {
        resultsUl.innerHTML = '';
        return;
    }

    const results = (showAll && query.length === 0) ? currentStock
        : currentStock.filter(item => (item.name && item.name.toLowerCase().includes(query)) || (item.sku && item.sku.toLowerCase().includes(query)));

    if (results.length > 0) {
        resultsUl.innerHTML = results.slice(0, 50).map(item => {
            
            // --- ЁЯФе NEW: LOCK ICON LOGIC ---
            // рдЪреЗрдХ рдХрд░реЗрдВ рдХрд┐ рдЖрдЗрдЯрдо рдкрд░ рд▓реЙрдХ рд▓рдЧрд╛ рд╣реИ рдпрд╛ рдирд╣реАрдВ
            const isSecured = item.is_secured === true || (item.product_attributes && item.product_attributes.is_secured === true);
            const lockIcon = isSecured ? '<i class="fas fa-lock text-danger ms-2" title="Anti-Theft Protected"></i>' : '';
            // --------------------------------

            return `
            <li class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" data-sku="${item.sku}" style="cursor: pointer;">
                <div>
                    <strong>${item.name}</strong> ${lockIcon} <br>
                    <small class="text-muted"> Stock: ${item.quantity} ${item.unit || ''} ${item.product_attributes && item.product_attributes.Size ? `| Size: ${item.product_attributes.Size}` : ''} </small>
                </div>
                <div class="text-end">
                    <span class="badge bg-warning text-dark mb-1">${item.sku}</span> <br>
                    <span class="fw-bold text-success">${formatCurrency(item.sale_price)}</span>
                </div>
            </li>
        `}).join('');
    } else {
        resultsUl.innerHTML = '<li class="list-group-item text-muted">рдХреЛрдИ рдЖрдЗрдЯрдо рдирд╣реАрдВ рдорд┐рд▓рд╛ (SKU рдЪреЗрдХ рдХрд░реЗрдВ)</li>';
    }
}    // [ тЬЕ рдХреНрд▓рд┐рдХ рдлрд┐рдХреНрд╕: рддрд╛рдХрд┐ рд▓рд┐рд╕реНрдЯ рдореЗрдВ рдХрд╣реАрдВ рднреА рдХреНрд▓рд┐рдХ рдХрд░рдиреЗ рдкрд░ рдЖрдЗрдЯрдо рдРрдб рд╣реЛ рдЬрд╛рдП ]

function handleSearchResultClick(e) {
    // рдЬрд┐рд╕ рдПрд▓рд┐рдореЗрдВрдЯ рдкрд░ рдХреНрд▓рд┐рдХ рд╣реБрдЖ, рдЙрд╕рдХреЗ рд╕рдмрд╕реЗ рдХрд░реАрдмреА 'li' рдХреЛ рдвреВрдВрдвреЗрдВ
    const li = e.target.closest('li');
    
    if (li && li.dataset.sku) {
        const sku = li.dataset.sku;
        addSKUToCart(sku); // рдХрд╛рд░реНрдЯ рдореЗрдВ рдЬреЛрдбрд╝реЗрдВ
        
        // рдЬреЛрдбрд╝рдиреЗ рдХреЗ рдмрд╛рдж рд╕рд░реНрдЪ рдмреЙрдХреНрд╕ рдЦрд╛рд▓реА рдХрд░реЗрдВ рдФрд░ рд▓рд┐рд╕реНрдЯ рд╣рдЯрд╛рдПрдВ
        document.getElementById('pos-item-search').value = '';
        document.getElementById('pos-search-results').innerHTML = '';
        document.getElementById('pos-item-search').focus(); // рд╡рд╛рдкрд╕ рдЯрд╛рдЗрдкрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдлреЛрдХрд╕ рдХрд░реЗрдВ
    }
}    
    // NEW: Centralized function to add SKU to cart (used by barcode and search)
   // тЬЕ UPDATED FUNCTION: Cart me Security Data safe tarike se add karega
// тЬЕ UPDATED: addSKUToCart (With Timestamp for Smart Delete)
function addSKUToCart(sku) {
    const selectedItem = currentStock.find(item => item.sku === sku);
        
    if (selectedItem) {

        // ============================================================
        // ЁЯЪи NEW ADDITION: TICKET SWITCH ALERT (Visual Verification)
        // ============================================================
        // рдпрд╣ рдХреЛрдб рдЧрд╛рд░рдореЗрдВрдЯреНрд╕ рдореЗрдВ рдЖрдЗрдЯрдо рдХреА рдлреЛрдЯреЛ рд╕реНрдХреНрд░реАрди рдкрд░ рдлреНрд▓реИрд╢ рдХрд░реЗрдЧрд╛
        // рддрд╛рдХрд┐ рдХреИрд╢рд┐рдпрд░ рджреЗрдЦ рд╕рдХреЗ рдХрд┐ рдЯреИрдЧ рдФрд░ рдХрдкреЬрд╛ рдореИрдЪ рд╣реЛ рд░рд╣рд╛ рд╣реИ рдпрд╛ рдирд╣реАрдВред
        const businessType = localStorage.getItem('business_type');
        
        // рдЪреЗрдХ рдХрд░реЗрдВ: рдХреНрдпрд╛ рдпрд╣ рдЧрд╛рд░рдореЗрдВрдЯреНрд╕ рдмрд┐рдЬрд╝рдиреЗрд╕ рд╣реИ?
        if (businessType === 'Garments' || businessType === 'GARMENTS' || businessType === 'CLOTHING') {
            // рдЕрдЧрд░ рдлреЛрдЯреЛ рдирд╣реАрдВ рд╣реИ рддреЛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдлреЛрдЯреЛ рд▓реЛ
            const itemImg = selectedItem.image || 'https://cdn-icons-png.flaticon.com/512/2652/2652218.png';
            
            if(typeof Swal !== 'undefined') {
                Swal.fire({
                    // рдирд╛рдо рдФрд░ рджрд╛рдо рдмрдбрд╝реЗ рдЕрдХреНрд╖рд░реЛрдВ рдореЗрдВ рджрд┐рдЦрд╛рдУ
                    title: `<span style="color:#2c3e50">${selectedItem.name}</span>`,
                    html: `
                        <div style="font-size: 28px; font-weight: bold; color: #d35400;">тВ╣${selectedItem.sale_price}</div>
                        <p style="color: #7f8c8d; font-size: 12px; margin-top:5px;">SKU: ${selectedItem.sku}</p>
                    `,
                    imageUrl: itemImg,
                    imageWidth: 250,  // рдлреЛрдЯреЛ рдХрд╛ рд╕рд╛рдЗреЫ
                    imageHeight: 250,
                    imageAlt: 'Product Image',
                    timer: 2000,       // 2 рд╕реЗрдХрдВрдб рдмрд╛рдж рдЕрдкрдиреЗ рдЖрдк рдмрдВрдж рд╣реЛ рдЬрд╛рдПрдЧрд╛
                    showConfirmButton: false, // рдмрдЯрди рджрдмрд╛рдиреЗ рдХреА рдЬрд░реВрд░рдд рдирд╣реАрдВ
                    backdrop: `rgba(0,0,0,0.5)`, // рдкреАрдЫреЗ рдХрд╛ рдмреИрдХрдЧреНрд░рд╛рдЙрдВрдб рдзреБрдВрдзрд▓рд╛ рдХрд░реЗрдВ
                    background: '#ffffff'
                });
            }
        }
        // ============================================================


        // 1. Stock Check (OLD CODE STARTS HERE - UNTOUCHED)
        if(selectedItem.quantity <= 0) {
            return showMessage('рд╕реНрдЯреЙрдХ рдирд╣реАрдВ рд╣реИ', `${selectedItem.name} рд╕реНрдЯреЙрдХ рдореЗрдВ рд╕рдорд╛рдкреНрдд рд╣реЛ рдЧрдпрд╛ рд╣реИред`, 'danger');
        }
        
        const existingCartItem = posCart.find(item => item.sku === sku);
        
        if (existingCartItem) {
            // 2. Quantity Check
            if(existingCartItem.quantity >= selectedItem.quantity) {
                return showMessage('рд╕реНрдЯреЙрдХ рдирд╣реАрдВ рд╣реИ', `рдЖрдкрдХреЗ рдкрд╛рд╕ рд╕реНрдЯреЙрдХ рдореЗрдВ рдХреЗрд╡рд▓ ${selectedItem.quantity} ${selectedItem.name} рд╣реИрдВред`, 'warning');
            }
            existingCartItem.quantity++;
            // рдиреЛрдЯ: рдкреБрд░рд╛рдиреЗ рдЖрдЗрдЯрдо рдХрд╛ рдЯрд╛рдЗрдо рдЕрдкрдбреЗрдЯ рдирд╣реАрдВ рдХрд░реЗрдВрдЧреЗ, рддрд╛рдХрд┐ 1 рдорд┐рдирдЯ рд╡рд╛рд▓рд╛ рд░реВрд▓ рд╕рд╣реА рдЪрд▓реЗ
        } else {
            // 3. New Item Logic (With Security Check)
            
            // --- SAFE SECURITY CHECK START ---
            const attributes = selectedItem.product_attributes || {};
            const isSecured = attributes.is_secured === true;
            // --- SAFE SECURITY CHECK END ---

            posCart.push({ 
                ...selectedItem, 
                quantity: 1,
                purchase_price: parseFloat(selectedItem.purchase_price || 0),
                
                // тЬЕ рдпреЗ рджреЛ рд▓рд╛рдЗрдиреЗрдВ рд╕рдмрд╕реЗ рдЬрд░реВрд░реА рд╣реИрдВ (Step 2 рдХреЗ рд▓рд┐рдП)
                product_attributes: attributes, 
                is_secured: isSecured,

                // ЁЯФе NEW UPDATE: Smart Delete Time Tracking
                addedAt: Date.now() 
            });
        }
        
        updatePOSCartView(); // View update
        
    } else {
         showMessage('рдирд╣реАрдВ рдорд┐рд▓рд╛', `SKU ${sku} рд╕реНрдЯреЙрдХ рдореЗрдВ рдирд╣реАрдВ рдорд┐рд▓рд╛ред`, 'warning');
    }
    
    // Search Box Clear
    const searchInput = document.getElementById('pos-item-search');
    if(searchInput) {
        searchInput.value = '';
        searchInput.focus();
    }
}

// тЬЕ UPDATED VIEW: рдЕрдм рдирд╛рдо рдХреЗ рдЖрдЧреЗ ЁЯФТ (Red Lock) рджрд┐рдЦреЗрдЧрд╛
// тЬЕ UPDATED VIEW (Smart Display)
function updatePOSCartView() {
    const cartBody = document.getElementById('pos-cart-body');
    if(!cartBody) return;

    if (posCart.length === 0) {
        cartBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">рдХрд╛рд░реНрдЯ рдЦрд╛рд▓реА рд╣реИред</td></tr>`;
    } else {
        // ЁЯФе CHECK: рдХреНрдпрд╛ рдпрд╣ рдЧрд╛рд░рдореЗрдВрдЯ рдмрд┐реЫрдиреЗрд╕ рд╣реИ?
        const showSecurity = isGarmentBusiness(); 

        cartBody.innerHTML = posCart.map((item, index) => {
            const saleTotal = item.sale_price * item.quantity;
            const stockItem = currentStock.find(s => s.sku === item.sku);
            const maxStock = stockItem ? stockItem.quantity : item.quantity;
            
            // --- LOCK LOGIC ---
            // рдЕрдЧрд░ рдЧрд╛рд░рдореЗрдВрдЯ рдмрд┐реЫрдиреЗрд╕ рд╣реИ, рддрднреА рд▓реЙрдХ рджрд┐рдЦрд╛рдУ, рд╡рд░рдирд╛ рдирд╣реАрдВ
            let lockIcon = '';
            if (showSecurity) {
                const isSecured = item.is_secured === true || (item.product_attributes && item.product_attributes.is_secured === true);
                lockIcon = isSecured ? '<span class="text-danger ms-2" title="Anti-Theft Protected"><i class="fas fa-lock"></i></span>' : '';
            }
            // ------------------

            return `
                <tr>
                    <td>
                        ${item.name} ${lockIcon}
                        <small class="d-block text-info">${formatAttributes(item.product_attributes)}</small>
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm" style="width: 100px;"
                            value="${item.quantity}" min="1" max="${maxStock}"
                            onchange="updateCartQuantity(${index}, this.value)"
                            onblur="validateCartQuantity(${index}, this.value, ${maxStock})">
                    </td>
                    <td>${formatCurrency(item.sale_price)}</td>
                    <td>${formatCurrency(saleTotal)}</td>
                    <td><button class="btn btn-danger btn-sm" onclick="removeFromCart(${index})">&times;</button></td>
                </tr>
            `;
        }).join('');
    }
    calculatePOSTotals();
}


// NEW: Validate quantity on blur (after changing)
    function validateCartQuantity(index, newQuantity, maxStock) {
        const quantity = parseInt(newQuantity);
        if (quantity > maxStock) {
             showMessage('рд╕реНрдЯреЙрдХ рд╕реАрдорд┐рдд рд╣реИ', `рдЖрдкрдХреЗ рдкрд╛рд╕ рдХреЗрд╡рд▓ ${maxStock} рдЖрдЗрдЯрдо рдЙрдкрд▓рдмреНрдз рд╣реИрдВред`, 'warning');
             posCart[index].quantity = maxStock;
             updatePOSCartView();
        }
    }


    function updateCartQuantity(index, newQuantity) {
        const quantity = parseInt(newQuantity);
        
        if (isNaN(quantity) || quantity < 1) {
            showMessage('рдЪреЗрддрд╛рд╡рдиреА', 'рдорд╛рддреНрд░рд╛ 1 рдпрд╛ рдЙрд╕рд╕реЗ рдЕрдзрд┐рдХ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдПред', 'warning');
            updatePOSCartView(); 
            return;
        }
        
        posCart[index].quantity = quantity;
        updatePOSCartView(); 
    }

    // ЁЯЫбя╕П SECURITY UPDATE: Single Item Remove
// рдЕрдм рдПрдХ рдЖрдЗрдЯрдо рд╣рдЯрд╛рдиреЗ рдкрд░ рднреА рдкрд╛рд╕рд╡рд░реНрдб/рд╡рд╛рд░реНрдирд┐рдВрдЧ рдорд╛рдВрдЧреЗрдЧрд╛
// тЬЕ UPDATED SINGLE REMOVE
// ЁЯЫбя╕П SMART DELETE SYSTEM (1 Minute Rule)
function removeFromCart(index) {
    // 1. рдЕрдЧрд░ рдЧрд╛рд░рдореЗрдВрдЯреНрд╕ рдмрд┐реЫрдиреЗрд╕ рдирд╣реАрдВ рд╣реИ, рддреЛ рд╕реАрдзрд╛ рд╣рдЯрд╛рдУ
    if (typeof isGarmentBusiness === 'function' && !isGarmentBusiness()) {
        performSingleDelete(index);
        return;
    }

    const item = posCart[index];
    // рд▓реЙрдХ рдЪреЗрдХ рдХрд░реЗрдВ
    const isSecured = item.is_secured === true || (item.product_attributes && item.product_attributes.is_secured === true);
    
    // --- тП░ TIME CHECK ---
    const timeNow = Date.now();
    const timeAdded = item.addedAt || timeNow; // рдЕрдЧрд░ рдЯрд╛рдЗрдо рдирд╣реАрдВ рд╣реИ рддреЛ рдЕрднреА рдХрд╛ рдорд╛рди рд▓реЛ
    const timeDiff = (timeNow - timeAdded) / 1000; // рд╕реЗрдХрдВрдбреНрд╕ рдореЗрдВ рдЕрдВрддрд░
    const ALLOWED_TIME = 60; // 60 рд╕реЗрдХрдВрдб (1 рдорд┐рдирдЯ) рдХреА рдЫреВрдЯ

    // CASE A: рдЕрдЧрд░ 1 рдорд┐рдирдЯ рдХреЗ рдЕрдВрджрд░ рдЧрд▓рддреА рд╕реБрдзрд╛рд░реА рдЬрд╛ рд░рд╣реА рд╣реИ
    if (timeDiff <= ALLOWED_TIME) {
        // рд╕рд┐рд░реНрдл рдХрдиреНрдлрд░реНрдореЗрд╢рди рдорд╛рдВрдЧреЛ (PIN рдирд╣реАрдВ)
        // Toast message рджрд┐рдЦрд╛рдПрдВ рдХрд┐ рдмрд┐рдирд╛ рдкрд┐рди рдХреЗ рд╣рдЯрд╛ рджрд┐рдпрд╛ рдЧрдпрд╛
        const toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timer: 2000
        });
        toast.fire({ icon: 'info', title: 'Quick Delete (Under 1 min)' });
        
        performSingleDelete(index); 
        return;
    }

    // CASE B: рдЕрдЧрд░ 1 рдорд┐рдирдЯ рд╕реЗ рдЬреНрдпрд╛рджрд╛ рд╣реЛ рдЧрдпрд╛ (рдЕрдм PIN рдЪрд╛рд╣рд┐рдП)
    if (isSecured) {
        Swal.fire({
            title: 'ЁЯФР Manager Approval Required',
            html: `Item: <b>${item.name}</b><br>Time elapsed: ${Math.floor(timeDiff/60)} mins.<br><br>рдЗрд╕реЗ рд╣рдЯрд╛рдиреЗ рдХреЗ рд▓рд┐рдП <b>Manager PIN</b> рдбрд╛рд▓реЗрдВ:`,
            icon: 'warning',
            input: 'password', 
            inputPlaceholder: 'Enter PIN (Default: 1234)',
            showCancelButton: true,
            confirmButtonText: 'Unlock & Delete',
            confirmButtonColor: '#d33'
        }).then((result) => {
            if (result.isConfirmed) {
                const enteredPin = result.value;
                const managerPin = "1234"; // ЁЯФС рдпрд╣рд╛рдБ рдЕрдкрдирд╛ рдЕрд╕рд▓реА рдкрд┐рди рд╕реЗрдЯ рдХрд░реЗрдВ

                if (enteredPin === managerPin) {
                    // ЁЯХ╡я╕ПтАНтЩВя╕П рд▓реЙрдЧ рдореЗрдВ рдХрд╛рд░рдг рдХреЗ рд╕рд╛рде рдиреЛрдЯ рдХрд░реЗрдВ
                    if(typeof SecurityLogger !== 'undefined') {
                        SecurityLogger.log('FORCE_DELETE_LATE', `Authorized by Manager: Removed ${item.name}`);
                    }
                    performSingleDelete(index);
                    Swal.fire('Deleted', 'рдЖрдЗрдЯрдо рд╣рдЯрд╛ рджрд┐рдпрд╛ рдЧрдпрд╛ред', 'success');
                } else {
                    Swal.fire('Error', 'рдЧрд▓рдд рдкрд┐рди! рдЖрдЗрдЯрдо рдирд╣реАрдВ рд╣рдЯрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ред', 'error');
                }
            }
        });
    } else {
        // рдЕрдЧрд░ рд▓реЙрдХ рдирд╣реАрдВ рд╣реИ рддреЛ рдирд╛рд░реНрдорд▓ рдбрд┐рд▓реАрдЯ
        performSingleDelete(index);
    }
}


// рдЕрд╕рд▓реА рдбрд┐рд▓реАрдЯ рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рдлрдВрдХреНрд╢рди
function performSingleDelete(index) {
    posCart.splice(index, 1); // рд▓рд┐рд╕реНрдЯ рд╕реЗ рд╣рдЯрд╛рдПрдВ
    updatePOSCartView(); // рд╡реНрдпреВ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ
}

    function calculatePOSTotals() {
        let subtotal = 0;
        let gstAmount = 0;
        let totalAmount = 0;
        
        posCart.forEach(item => {
            const itemTotalWithGST = item.sale_price * item.quantity;
            const gstValue = parseFloat(item.gst) || 0;
            // This calculation assumes sale_price INCLUDES GST.
            // const subtotalWithoutGST = itemTotalWithGST / (1 + (gstValue / 100)); 
            
            // This calculation assumes sale_price EXCLUDES GST.
            const subtotalWithoutGST = itemTotalWithGST;
            const itemGstAmount = subtotalWithoutGST * (gstValue / 100);
            
            subtotal += subtotalWithoutGST;
            gstAmount += itemGstAmount;
        });
        
        totalAmount = subtotal + gstAmount;
        
        document.getElementById('pos-subtotal').innerText = formatCurrency(subtotal);
        document.getElementById('pos-gst-amount').innerText = formatCurrency(gstAmount);
        document.getElementById('pos-total-amount').innerText = formatCurrency(totalAmount);

        return totalAmount;
    }

// ЁЯЪА MAIN SALE FUNCTION (Computer = Auto PDF, Mobile = No PDF/Only WhatsApp)
// ЁЯЪА FINAL UPDATED SALE FUNCTION
// (Includes: Anti-Theft Unlock + Mistri Message + Mobile No-Crash Logic)
// тЬЕ UPDATED: Complete Sale Function (WhatsApp + Thermal Print + PDF Choice)
async function handleCompleteSale() {
    // --- 1. рдХрд╛рд░реНрдЯ рдЪреЗрдХ ---
    if (posCart.length === 0) {
        if(typeof showMessage !== 'undefined') showMessage('Error', 'Cart is empty!', 'warning');
        else alert('Cart is empty!');
        return;
    }

    // тЬЕ ANTI-THEFT GUARD: рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдХреЛ рдмрддрд╛рдПрдВ рдХрд┐ рдмрд┐рд▓рд┐рдВрдЧ рдЪрд▓ рд░рд╣реА рд╣реИ
    window.isBillingProcess = true; 

    const finalTotalAmount = parseFloat(document.getElementById('pos-total-amount').innerText.replace(/[^0-9.]/g, ''));
    
    // --- 2. рдбреЗрдЯрд╛ рддреИрдпрд╛рд░ рдХрд░рдирд╛ ---
    const itemsForApi = posCart.map(item => ({
        sku: item.sku, name: item.name, quantity: item.quantity,
        sale_price: item.sale_price, purchase_price: parseFloat(item.purchase_price || 0),
        gst: item.gst
    }));

    const custMobile = document.getElementById('pos-customer-mobile').value || null;
    
    // рдорд┐рд╕реНрддреНрд░реА (Painter) рдХрд╛ рдбреЗрдЯрд╛
    const painterId = document.getElementById('pos-painter-select')?.value;
    const painterMobile = document.getElementById('pos-painter-mobile')?.value;
    const painterSelect = document.getElementById('pos-painter-select');
    const painterName = painterSelect && painterSelect.selectedIndex >= 0 ? painterSelect.options[painterSelect.selectedIndex].text : 'Partner';

    const deliveryDateRaw = document.getElementById('pos_auto_date')?.value;
    const deliveryDate = deliveryDateRaw ? new Date(deliveryDateRaw).toLocaleDateString('en-IN') : new Date().toLocaleDateString('en-IN');

    const saleData = {
        customerName: document.getElementById('pos-customer').value || 'Cash Customer',
        customerMobile: custMobile,
        total_amount: finalTotalAmount,
        sale_items: itemsForApi,
        painterId: painterId,
        painterMobile: painterMobile
    };

    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    const sendToCust = document.getElementById('pos_send_cust_wa')?.checked;

    // --- 3. рд╕рд░реНрд╡рд░ рдХреЙрд▓ ---
    try {
        if(typeof Swal !== 'undefined') Swal.showLoading();

        const res = await fetchApi('/api/invoices', { method: 'POST', body: saleData });

        if (res.success) {
            
            // --- ЁЯТм MESSAGE 1: рдЧреНрд░рд╛рд╣рдХ рдХреЗ рд▓рд┐рдП (Customer Message) ---
            const itemDetails = itemsForApi.map(i => `${i.name} (x${i.quantity})`).join(', ');
            const whatsappMsg = `рдирдорд╕реНрддреЗ *${saleData.customerName}*,\n` +
                                `рдЖрдкрдХрд╛ рдСрдбрд░ рдХрдВрдлрд░реНрдо рд╣реЛ рдЧрдпрд╛ рд╣реИ! ЁЯОЙ\n` +
                                `ЁЯз╛ рдмрд┐рд▓ рдирдВрдмрд░: *#${res.invoiceId}*\n` +
                                `ЁЯТ░ рдХреБрд▓ рд░рд╛рд╢рд┐: *тВ╣${finalTotalAmount.toFixed(2)}*\n` +
                                `ЁЯУж рд╕рд╛рдорд╛рди: ${itemDetails}\n` +
                                `ЁЯЪЪ рдбрд┐рд▓реАрд╡рд░реА: ${deliveryDate}\n\n` +
                                `рдХреГрдкрдпрд╛ рд╕рд╛рде рдореЗрдВ рднреЗрдЬрд╛ рдЧрдпрд╛ PDF рдмрд┐рд▓ рджреЗрдЦреЗрдВред рдзрдиреНрдпрд╡рд╛рдж! ЁЯЩП`;

            // --- ЁЯТм MESSAGE 2: рдорд┐рд╕реНрддреНрд░реА рдХреЗ рд▓рд┐рдП (Mistri/Painter Message) ---
            let mistriMsg = "";
            if (painterMobile) {
                mistriMsg = `рдирдорд╕реНрддреЗ *${painterName}*,\n` +
                            `рдЖрдкрдХреЗ рд░реЗрдлрд░реЗрдиреНрд╕ рд╕реЗ рдирдИ рдмрд┐рдХреНрд░реА рд╣реБрдИ рд╣реИ! ЁЯдЭ\n` +
                            `рдЧреНрд░рд╛рд╣рдХ: ${saleData.customerName}\n` +
                            `рдмрд┐рд▓ рдирдВрдмрд░: #${res.invoiceId}\n` +
                            `рдХреБрд▓ рд░рд╛рд╢рд┐: тВ╣${finalTotalAmount.toFixed(2)}\n\n` +
                            `рдЖрдкрдХрд╛ рдХрдореАрд╢рди рдЖрдкрдХреЗ рдЦрд╛рддреЗ рдореЗрдВ рдЬреЛрдбрд╝ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред рдзрдиреНрдпрд╡рд╛рдж!`;
            }

            // ============================================================
            // ЁЯТ╗ CASE 1: рдХрдВрдкреНрдпреВрдЯрд░ (DESKTOP) -> Ask Choice (PDF vs Thermal)
            // ============================================================
            if (!isMobile) {
                
                // --- WhatsApp (рдмреИрдХрдЧреНрд░рд╛рдЙрдВрдб рдореЗрдВ рднреЗрдЬреЗрдВ) ---
                if (sendToCust && saleData.customerMobile) {
                    setTimeout(() => { openSmartWhatsApp(saleData.customerMobile, whatsappMsg); }, 1000);
                }
                if (painterMobile && mistriMsg) {
                    setTimeout(() => { openSmartWhatsApp(painterMobile, mistriMsg); }, 3000);
                }

                // --- ЁЯМЯ NEW POPUP: PDF рдпрд╛ Thermal Print? ---
                Swal.fire({
                    title: 'тЬЕ рдмрд┐рд▓ рдмрди рдЧрдпрд╛!',
                    text: `Invoice #${res.invoiceId} рд╕рд╣реЗрдЬрд╛ рдЧрдпрд╛ред рдЕрдм рдЖрдк рдХреНрдпрд╛ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?`,
                    icon: 'success',
                    showDenyButton: true,       // рджреВрд╕рд░рд╛ рдмрдЯрди (Thermal)
                    showCancelButton: true,     // рддреАрд╕рд░рд╛ рдмрдЯрди (Close)
                    confirmButtonText: 'ЁЯУД PDF рдбрд╛рдЙрдирд▓реЛрдб (A4)',
                    denyButtonText: 'ЁЯЦия╕П рдерд░реНрдорд▓ рдкреНрд░рд┐рдВрдЯ (Parchi)',
                    cancelButtonText: 'тЭМ рдмрдВрдж рдХрд░реЗрдВ',
                    confirmButtonColor: '#0d6efd',
                    denyButtonColor: '#ffc107',
                    cancelButtonColor: '#6c757d',
                    allowOutsideClick: false
                }).then((result) => {
                    
                    // A. рдЕрдЧрд░ PDF рдмрдЯрди рджрдмрд╛рдпрд╛
                    if (result.isConfirmed) {
                        if (typeof generateAndDownloadPDF === 'function') {
                            generateAndDownloadPDF(res.invoiceId, saleData.customerName, itemsForApi, finalTotalAmount);
                        } else if (typeof downloadBillFinal === 'function') {
                            downloadBillFinal(res.invoiceId, saleData.customerName, itemsForApi, finalTotalAmount);
                        }
                    } 
                    
                    // B. рдЕрдЧрд░ Thermal Print рдмрдЯрди рджрдмрд╛рдпрд╛
                    else if (result.isDenied) {
                        generateThermalPrint(res.invoiceId, saleData.customerName, posCart, finalTotalAmount);
                    }

                    // C. рдЕрдВрдд рдореЗрдВ рдХрд╛рд░реНрдЯ рдЦрд╛рд▓реА рдХрд░реЗрдВ
                    resetPOSButton(true);
                    window.isBillingProcess = false;
                });

                return;
            }

            // ============================================================
            // ЁЯУ▒ CASE 2: рдореЛрдмрд╛рдЗрд▓ (MOBILE) -> Only Messages (рдЬреИрд╕рд╛ рдкрд╣рд▓реЗ рдерд╛)
            // ============================================================
            Swal.fire({
                icon: 'success',
                title: 'рдмрд┐рдХреНрд░реА рд╕рдлрд▓! ЁЯОЙ',
                html: `<p>Bill <b>#${res.invoiceId}</b> generated.</p>`,
                timer: 2000, 
                showConfirmButton: false
            }).then(() => {
                
                // WhatsApp 1: Customer
                if (sendToCust && saleData.customerMobile) {
                    openSmartWhatsApp(saleData.customerMobile, whatsappMsg);
                }

                // WhatsApp 2: Mistri
                else if (painterMobile && mistriMsg) {
                    setTimeout(() => { openSmartWhatsApp(painterMobile, mistriMsg); }, 1000);
                }
                
                // тЬЕ ANTI-THEFT UNLOCK: рдпрд╣рд╛рдБ true рднреЗрдЬреЗрдВ
                resetPOSButton(true);
                window.isBillingProcess = false;
            });

        } else {
            throw new Error(res.message);
        }

    } catch (error) {
        window.isBillingProcess = false; // рдкреНрд░реЛрд╕реЗрд╕ рд░реЛрдХреЗрдВ
        if(typeof Swal !== 'undefined') Swal.fire('Error', error.message, 'error');
        else alert('Error: ' + error.message);
    }
}


    // --- FORM SUBMISSION HANDLERS (Fixed & Updated) ---
    
    function setupForm(formId, apiPath, successCallback) {
        const form = document.getElementById(formId);
        
        // Check if form exists to avoid null errors
        if (form && !form.dataset.initialized) {
            form.dataset.initialized = 'true';
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = form.querySelector('button[type="submit"]');
                const originalBtnText = btn.innerHTML;
                
                // Disable button to prevent double submit
                btn.disabled = true;
                btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> рд╕реЗрд╡ рд╣реЛ рд░рд╣рд╛ рд╣реИ...`;
                
                const data = {};

                // ============================================================
                // 1. STOCK FORM LOGIC (Updated for Bulk & Retail & Salon)
                // ============================================================
                if (formId === 'add-stock-form') {
                    
                    // --- ЁЯЪА NEW: BULK ENTRY CHECK ---
                    const bulkContainer = document.getElementById('dish-bulk-container');
                    const isBulkMode = bulkContainer && bulkContainer.style.display !== 'none';

                    if (isBulkMode) {
                        // --- BULK DISH SAVING LOGIC ---
                        const rows = document.querySelectorAll('.dish-entry-row');
                        const promises = [];
                        const btype = AppState.user.businessType;
                        const isSalon = (btype === 'SALON');

                        rows.forEach(row => {
                            const dName = row.querySelector('.dish-name').value;
                            const dPrice = row.querySelector('.dish-price').value;

                            if (dName && dPrice) {
                                const singleDishData = {
                                    sku: (isSalon ? 'SVC-' : 'DISH-') + Date.now() + Math.floor(Math.random() * 1000),
                                    name: dName,
                                    sale_price: dPrice,
                                    purchase_price: 0,
                                    quantity: 10000,
                                    unit: isSalon ? 'Session' : 'Plate',
                                    product_attributes: { type: 'SERVICE' }
                                };
                                promises.push(fetchApi('/api/stock', { method: 'POST', body: singleDishData }));
                            }
                        });

                        try {
                            await Promise.all(promises);
                            showMessage('рд╕рдлрд▓рддрд╛', `тЬЕ ${promises.length} рдбрд┐рд╢реЗрдЬ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдЬреБрдбрд╝ рдЧрдИрдВ!`, 'success');
                            
                            // Reset Form & Table
                            form.reset();
                            document.getElementById('dish-bulk-body').innerHTML = '';
                            if(typeof addDishRow === 'function') addDishRow(); 
                            
                            if (successCallback) successCallback();
                            
                        } catch (err) {
                            showMessage('рддреНрд░реБрдЯрд┐', 'рдХреБрдЫ рдбрд┐рд╢реЗрдЬ рд╕реЗрд╡ рдирд╣реАрдВ рд╣реЛ рдкрд╛рдИрдВ: ' + err.message, 'danger');
                        } finally {
                            btn.disabled = false;
                            btn.innerHTML = originalBtnText;
                        }
                        return; // Stop here for Bulk Mode
                    }

                    // --- NORMAL STOCK ENTRY LOGIC ---
                    data.sku = document.getElementById('stock-sku').value;
                    data.name = document.getElementById('stock-name').value;
                    data.quantity = document.getElementById('stock-quantity').value;
                    data.unit = document.getElementById('stock-unit').value;
                    data.purchase_price = document.getElementById('stock-purchase-price').value;
                    data.sale_price = document.getElementById('stock-sale-price').value;
                    data.gst = document.getElementById('stock-gst').value;
                    data.hsn_code = document.getElementById('stock-hsn-code').value;
                    data.action_type = document.getElementById('stock-action-type').value;

                    // Recipe Data
                    const recipeElement = document.getElementById('stock-recipe-data');
                    if (recipeElement && recipeElement.value) {
                        try { data.recipe = JSON.parse(recipeElement.value); } catch (e) { console.error("Recipe parse error", e); }
                    }

                    // Attributes
                    data.product_attributes = {};

                    if (document.getElementById('stock-expiry')) {
                        data.product_attributes.expiry = document.getElementById('stock-expiry').value;
                        data.product_attributes.batch = document.getElementById('stock-batch').value;
                    }
                    
                    if (document.getElementById('stock-size')) {
                        data.product_attributes.Size = document.getElementById('stock-size').value;
                        data.product_attributes.Color = document.getElementById('stock-color').value;
                    }

                    if (document.getElementById('typeService') && document.getElementById('typeService').checked) {
                        data.product_attributes.type = 'SERVICE';
                    }

                    // Optical Fields
                    const addAttr = (obj, key, id) => {
                        const el = document.getElementById(id);
                        if (el && el.value && el.value.trim() !== '') { obj[key] = el.value.trim(); }
                    };

                    const presContainer = document.getElementById('prescription-fields-container');
                    if (presContainer && presContainer.style.display === 'block') {
                        addAttr(data.product_attributes, 'sph_od_dist', 'stock_sph_od_dist');
                        addAttr(data.product_attributes, 'cyl_od_dist', 'stock_cyl_od_dist');
                        addAttr(data.product_attributes, 'axs_od_dist', 'stock_axs_od_dist');
                        addAttr(data.product_attributes, 'sph_od_near', 'stock_sph_od_near');
                        addAttr(data.product_attributes, 'cyl_od_near', 'stock_cyl_od_near');
                        addAttr(data.product_attributes, 'axs_od_near', 'stock_axs_od_near');

                        addAttr(data.product_attributes, 'sph_os_dist', 'stock_sph_os_dist');
                        addAttr(data.product_attributes, 'cyl_os_dist', 'stock_cyl_os_dist');
                        addAttr(data.product_attributes, 'axs_os_dist', 'stock_axs_os_dist');
                        addAttr(data.product_attributes, 'sph_os_near', 'stock_sph_os_near');
                        addAttr(data.product_attributes, 'cyl_os_near', 'stock_cyl_os_near');
                        addAttr(data.product_attributes, 'axs_os_near', 'stock_axs_os_near');
                    }

// ЁЯСЗЁЯСЗЁЯСЗ рдпрд╣ рдХреЛрдб 'setupForm' рдХреЗ рдЕрдВрджрд░ 'add-stock-form' рд╡рд╛рд▓реЗ рд╣рд┐рд╕реНрд╕реЗ рдореЗрдВ рдкреЗрд╕реНрдЯ рдХрд░реЗрдВ ЁЯСЗЁЯСЗЁЯСЗ

// ===============================================
// ЁЯФе GARMENTS ANTI-THEFT DATA (рдпрд╣рд╛рдБ рдЬреЛрдбрд╝реЗрдВ)
// ===============================================
const tagCheck = document.getElementById('sec-tag-attached');
if (tagCheck) { 
    // рдЕрдЧрд░ рд╕реНрдХреНрд░реАрди рдкрд░ рд▓рд╛рд▓ рдбрдмреНрдмрд╛ (Anti-Theft) рдореМрдЬреВрдж рд╣реИ
    data.product_attributes.is_secured = true;
    data.product_attributes.has_hard_tag = tagCheck.checked;
    data.product_attributes.rfid_code = document.getElementById('sec-rfid-code')?.value || '';
    data.product_attributes.floor_section = document.getElementById('sec-floor-loc')?.value || '';
}
// ===============================================


                // ============================================================
                // 2. CUSTOMER FORM LOGIC
                // ============================================================
                } else if (formId === 'add-customer-form') {
                    data.name = document.getElementById('customer-name').value;
                    data.phone = document.getElementById('customer-phone').value;
                    data.email = document.getElementById('customer-email').value;
                    data.address = document.getElementById('customer-address').value;
                    data.gstin = document.getElementById('customer-gstin').value;
                    const balEl = document.getElementById('customer-balance');
                    data.balance = balEl ? (balEl.value || 0) : 0;

                // ============================================================
                // 3. PURCHASE FORM LOGIC (Corrected)
                // ============================================================
                } else if (formId === 'add-purchase-form') {
                    data.supplier_name = document.getElementById('purchase-supplier').value;
                    data.total_cost = parseFloat(document.getElementById('purchase-total-cost').value) || 0;
                    data.date = document.getElementById('purchase-date').value;

                    // User Details / Bill No Logic
                    const userDetails = document.getElementById('purchase-item-details') ? document.getElementById('purchase-item-details').value : '';
                    const billNo = document.getElementById('purchase-bill-number').value;
                    
                    data.item_details = userDetails ? userDetails : `Bill No: ${billNo}`;

                    data.gst_details = {
                        invoice_number: billNo,
                        taxable_value: parseFloat(document.getElementById('purchase-taxable-value').value) || 0,
                        cgst: parseFloat(document.getElementById('purchase-cgst').value) || 0,
                        sgst: parseFloat(document.getElementById('purchase-sgst').value) || 0,
                        igst: parseFloat(document.getElementById('purchase-igst').value) || 0
                    };

                    // Validation
                    const calculatedTotal = data.gst_details.taxable_value + data.gst_details.cgst + data.gst_details.sgst + data.gst_details.igst;
                    
                    if (calculatedTotal > 0 && Math.abs(calculatedTotal - data.total_cost) > 1.0) {
                        const confirmMsg = "рдЪреЗрддрд╛рд╡рдиреА: рдХреБрд▓ рдмрд┐рд▓ рд░рд╛рд╢рд┐ (" + data.total_cost + ") рдФрд░ GST рдЯреЛрдЯрд▓ (" + calculatedTotal + ") рдореИрдЪ рдирд╣реАрдВ рд╣реЛ рд░рд╣реЗред рдХреНрдпрд╛ рдЖрдк рдЖрдЧреЗ рдмреЭрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?";
                        if (!confirm(confirmMsg)) {
                            btn.disabled = false;
                            btn.innerHTML = originalBtnText;
                            return; 
                        }
                    }

                // ============================================================
                // 4. EXPENSE FORM LOGIC (Corrected)
                // ============================================================
                } else if (formId === 'add-expense-form') {
                    data.description = document.getElementById('expense-description').value;
                    data.category = document.getElementById('expense-category').value;
                    data.amount = document.getElementById('expense-amount').value;
                    data.created_at = document.getElementById('expense-date').value;
                }

                // ============================================================
                // API CALL (Universal)
                // ============================================================
                try {
                    let correctApiPath = apiPath;
                    if (apiPath === '/api/customer') correctApiPath = '/api/customers';
                    if (apiPath === '/api/purchase') correctApiPath = '/api/purchases';
                    if (apiPath === '/api/expense') correctApiPath = '/api/expenses';

                    const res = await fetchApi(correctApiPath, { method: 'POST', body: data });
                    
                    if (res.success) {
                        showMessage('рд╕рдлрд▓рддрд╛', res.message, 'success');
                        form.reset();
                        if (successCallback) successCallback();
                    } else {
                        throw new Error(res.message);
                    }
                } catch (error) {
                    console.error(error);
                    showMessage('рддреНрд░реБрдЯрд┐', `рд╕реЗрд╡ рдирд╣реАрдВ рд╣реЛ рд╕рдХрд╛: ${error.message}`, 'danger');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalBtnText;
                }
            });
        }
    }

// ЁЯЪА рдирдпрд╛ рд╣реЗрд▓реНрдкрд░ рдлрд╝рдВрдХреНрд╢рди: QR рдЗрдореЗрдЬ рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИ рдФрд░ Modal рджрд┐рдЦрд╛рддрд╛ рд╣реИ
function displayQrModal() {
         const modalBody = document.querySelector('#pairingModal .modal-body'); 
         if (!modalBody || !qrCodeDataUrl) {
             console.error("тЭМ displayQrModal: Modal рдмреЙрдбреА рдпрд╛ QR рдХреЛрдб URL рдирд╣реАрдВ рдорд┐рд▓рд╛!");
             showMessage('рддреНрд░реБрдЯрд┐', 'QR рдХреЛрдб рджрд┐рдЦрд╛рдиреЗ рдореЗрдВ рд╡рд┐рдлрд▓ред', 'danger');
             return;
         }
         
         // Modal рдмреЙрдбреА рдХреЛ рд╕рд╛рдлрд╝ рдХрд░реЗрдВ рдФрд░ рдЗрдореЗрдЬ рджрд┐рдЦрд╛рдПрдБ
         modalBody.innerHTML = `
            <p>рдЕрдкрдиреЗ Dukan Pro рдореЛрдмрд╛рдЗрд▓ рд╕реНрдХреИрдирд░ рдРрдк рд╕реЗ рдпрд╣ QR рдХреЛрдб рд╕реНрдХреИрди рдХрд░реЗрдВред</p>
            <div style="min-height: 260px; display: flex; align-items: center; justify-content: center;">
                <img src="${qrCodeDataUrl}" alt="QR Code" style="width: 256px; height: 256px; border: 1px solid #ccc;">
            </div>
             <p class="text-muted small mt-3">рдпрд╣ QR рдХреЛрдб рдЖрдкрдХреЗ POS рдХреЛ рдЖрдкрдХреЗ рдлрд╝реЛрди рд╕реЗ рд╕реБрд░рдХреНрд╖рд┐рдд рд░реВрдк рд╕реЗ рдЬреЛрдбрд╝рддрд╛ рд╣реИред</p>
         `;
         
         // Modal рджрд┐рдЦрд╛рдПрдБ
         if (pairingModalInstance) {
             pairingModalInstance.show();
         }
         isWaitingForQr = false; // рдЗрдВрддрдЬрд╝рд╛рд░ рдЦрддреНрдо
    }


    // ===================================
// STAFF MANAGEMENT FUNCTIONS (NEW)
// ===================================
let staffEditModal = null; // To hold the modal instance
let planLockModalInstance = null; // ЁЯЪА NAYA: Plan Lock Modal

async function renderStaff() {
    // Only admin can see and manage staff
    if (!AppState.user || AppState.user.role !== 'ADMIN') {
        // Optionally hide the staff section link if not admin, though RBAC should handle it
        const staffLink = document.querySelector('a[data-view="staff"]');
        if(staffLink) staffLink.classList.add('d-none');
        // Clear the table if somehow accessed by non-admin
        document.getElementById('staff-table-body').innerHTML = `<tr><td colspan="7" class="text-center text-danger">рдЗрд╕ рд╕реЗрдХреНрд╢рди рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдбрдорд┐рди рдЕрдиреБрдорддрд┐ рдЖрд╡рд╢реНрдпрдХ рд╣реИред</td></tr>`;
        return;
    }

    const tableBody = document.getElementById('staff-table-body');
    tableBody.innerHTML = `<tr><td colspan="7" class="text-center">рд╕реНрдЯрд╛рдл рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...</td></tr>`;

    try {
        // Fetch users for the current shop using the correct endpoint
        const res = await fetchApi('/api/users', { method: 'GET' });
        if (res.success && res.users) {
            if (res.users.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">рдЗрд╕ рд╢реЙрдк рдореЗрдВ рдХреЛрдИ рд╕реНрдЯрд╛рдл рд╕рджрд╕реНрдп рдирд╣реАрдВ рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛ рд╣реИред</td></tr>`;
                 return;
            }
            // Populate table rows
            tableBody.innerHTML = res.users.map(staff => `
                <tr>
                    <td>${staff.id}</td>
                    <td>${staff.name}</td>
                    <td>${staff.email}</td>
                    <td><span class="badge bg-${staff.role === 'ADMIN' ? 'danger' : staff.role === 'MANAGER' ? 'warning' : 'info'}">${staff.role}</span></td>
                    <td><span class="badge bg-${staff.status === 'active' ? 'success' : staff.status === 'pending' ? 'secondary' : 'dark'}">${staff.status}</span></td>
                    <td>${new Date(staff.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-primary ${staff.id === AppState.user.id ? 'disabled' : ''}" onclick='openEditStaffModal(${JSON.stringify(staff)})' title="рд╕рдВрдкрд╛рджрд┐рдд рдХрд░реЗрдВ">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger ${staff.id === AppState.user.id ? 'disabled' : ''}" onclick="handleDeleteStaff(${staff.id})" title="рд╣рдЯрд╛рдПрдВ">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } else {
            throw new Error(res.message || 'рд╕реНрдЯрд╛рдл рд╕реВрдЪреА рд▓реЛрдб рдХрд░рдиреЗ рдореЗрдВ рд╡рд┐рдлрд▓ред');
        }
    } catch (e) {
        tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">рддреНрд░реБрдЯрд┐: ${e.message}</td></tr>`;
    }
}

// Opens the Edit Staff modal with pre-filled data
function openEditStaffModal(staff) {
    if (!staffEditModal) {
        staffEditModal = new bootstrap.Modal(document.getElementById('editStaffModal'));
    }
    // Populate the modal form fields
    document.getElementById('edit-staff-id').value = staff.id;
    document.getElementById('edit-staff-name').value = staff.name;
    document.getElementById('edit-staff-email').value = staff.email; // Email is disabled, just for display
    document.getElementById('edit-staff-role').value = staff.role;
    document.getElementById('edit-staff-status').value = staff.status;
    document.getElementById('edit-staff-password').value = ''; // Clear password field for security
    staffEditModal.show(); // Show the modal
}

// Handles the submission of the "Add Staff" form
async function handleAddStaff(event) {
    event.preventDefault(); // Prevent default form submission
    const btn = event.target.querySelector('button[type="submit"]');
    const originalBtnText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> рдЬреЛрдбрд╝рд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ...`;

    // Collect data from the add form
    const data = {
        name: document.getElementById('staff-name').value,
        email: document.getElementById('staff-email').value,
        password: document.getElementById('staff-password').value,
        role: document.getElementById('staff-role').value,
        status: document.getElementById('staff-status').value,
    };

    try {
        // Send POST request to add user endpoint
        const res = await fetchApi('/api/users', { method: 'POST', body: data });
        if (res.success) {
            showMessage('рд╕рдлрд▓рддрд╛', 'рд╕реНрдЯрд╛рдл рд╕рджрд╕реНрдп рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛ред', 'success');
            document.getElementById('add-staff-form').reset(); // Reset form fields
            renderStaff(); // Refresh the staff list
        } else {
            throw new Error(res.message);
        }
    } catch (e) {
        showMessage('рддреНрд░реБрдЯрд┐', `рд╕реНрдЯрд╛рдл рдЬреЛрдбрд╝рдиреЗ рдореЗрдВ рд╡рд┐рдлрд▓: ${e.message}`, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalBtnText;
    }
}







 // Handles the submission of the "Edit Staff" modal form
 async function handleUpdateStaff(event) {
    event.preventDefault(); // Prevent default form submission
    const staffId = document.getElementById('edit-staff-id').value;
    const btn = event.target.querySelector('button[type="submit"]');
    const originalBtnText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> рд╕реЗрд╡ рд╣реЛ рд░рд╣рд╛ рд╣реИ...`;

    // Collect data from the edit form
    const data = {
        name: document.getElementById('edit-staff-name').value,
        role: document.getElementById('edit-staff-role').value,
        status: document.getElementById('edit-staff-status').value,
    };
    // Note: Password update logic is currently commented out as per previous code
    const newPassword = document.getElementById('edit-staff-password').value;
    if (newPassword) {
         showMessage('рдЪреЗрддрд╛рд╡рдиреА', 'рдкрд╛рд╕рд╡рд░реНрдб рдмрджрд▓рдиреЗ рдХреА рд╕реБрд╡рд┐рдзрд╛ рдЕрднреА рд▓рд╛рдЧреВ рдирд╣реАрдВ рд╣реИред рдХреГрдкрдпрд╛ рдПрдбрдорд┐рди рдкреИрдирд▓ рд╕реЗ рдмрджрд▓реЗрдВ рдпрд╛ рд╕рдВрдкрд░реНрдХ рдХрд░реЗрдВред', 'warning');
         // If you implement password change on the server via PUT /api/users/:userId, uncomment below
         // data.password = newPassword;
    }

    try {
        // Send PUT request to update user endpoint
        const res = await fetchApi(`/api/users/${staffId}`, { method: 'PUT', body: data });
        if (res.success) {
            showMessage('рд╕рдлрд▓рддрд╛', 'рд╕реНрдЯрд╛рдл рд╕рджрд╕реНрдп рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдЕрдкрдбреЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ред', 'success');
            if (staffEditModal) staffEditModal.hide(); // Hide the modal
            renderStaff(); // Refresh the staff list
        } else {
            throw new Error(res.message);
        }
    } catch (e) {
        showMessage('рддреНрд░реБрдЯрд┐', `рд╕реНрдЯрд╛рдл рдЕрдкрдбреЗрдЯ рдХрд░рдиреЗ рдореЗрдВ рд╡рд┐рдлрд▓: ${e.message}`, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalBtnText;
    }
}

// Handles the deletion of a staff member
async function handleDeleteStaff(staffId) {
    // Prevent admin from deleting themselves
    if (staffId === AppState.user.id) {
        showMessage('рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ', 'рдЖрдк рдЦреБрдж рдХреЛ рдбрд┐рд▓реАрдЯ рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗред', 'warning');
        return;
    }

    if (!confirm(`рдХреНрдпрд╛ рдЖрдк рд╡рд╛рдХрдИ рд╕реНрдЯрд╛рдл рд╕рджрд╕реНрдп ID ${staffId} рдХреЛ рд╣рдЯрд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╣ рдХреНрд░рд┐рдпрд╛ рд╡рд╛рдкрд╕ рдирд╣реАрдВ рд▓реА рдЬрд╛ рд╕рдХрддреАред`)) return;

    try {
        // Send DELETE request to delete user endpoint
        const res = await fetchApi(`/api/users/${staffId}`, { method: 'DELETE' });
         if (res.success) {
            showMessage('рд╕рдлрд▓рддрд╛', 'рд╕реНрдЯрд╛рдл рд╕рджрд╕реНрдп рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рд╣рдЯрд╛рдпрд╛ рдЧрдпрд╛ред', 'success');
            renderStaff(); // Refresh the staff list
        } else {
            throw new Error(res.message);
        }
    } catch (e) {
         showMessage('рддреНрд░реБрдЯрд┐', `рд╕реНрдЯрд╛рдл рд╣рдЯрд╛рдиреЗ рдореЗрдВ рд╡рд┐рдлрд▓: ${e.message}`, 'danger');
    }
}

    // --- APPLICATION UNLOCK & INITIALIZATION ---
   // ... (unlockApplication рдлрд╝рдВрдХреНрд╢рди)
   const unlockApplication = () => {
        // ЁЯЪА рдирдпрд╛: рдирдП рд▓реЙрдЧрд┐рди рдкреЗрдЬ рдХреЛ рдЫрд┐рдкрд╛рдПрдБ
        const authContainerNew = document.getElementById('auth-container-new');
        if (authContainerNew) authContainerNew.classList.add('hidden');
        
        // рдкреБрд░рд╛рдирд╛ рдХреЛрдб (auth-container рдХреЛ рдЫрд┐рдкрд╛рдиреЗ рдХреЗ рд▓рд┐рдП)
        //document.getElementById('auth-container').classList.add('hidden');//
        
        // рдмрд╛рдХреА рдХрд╛ рдЖрдкрдХрд╛ рдХреЛрдб...
        document.getElementById('sidebar').classList.remove('locked');
        document.getElementById('main-content').classList.remove('locked');
        // ... (рдЖрджрд┐) ...
        
        applyRBAC(AppState.user.role);
        applyBusinessTypeUI(AppState.user.businessType || 'RETAIL');
     setupForm('add-stock-form', '/api/stock', fetchAndRenderStockList);
  setupForm('add-customer-form', '/api/customers', fetchAndRenderCustomers); 
setupForm('add-purchase-form', '/api/purchases', fetchAndRenderPurchases);
setupForm('add-expense-form', '/api/expenses', fetchAndRenderExpenses);
        // ... (рдЖрдкрдХреЗ рд╕рднреА setupForm рдФрд░ setupNewFormHandlers рдХреЙрд▓реНрд╕) ...
        setupNewFormHandlers();
      // ... (setupNewFormHandlers(); рдХреЗ рдареАрдХ рдмрд╛рдж)

        // ЁЯЪА NAYA FIX: Role рдХреЗ рд╣рд┐рд╕рд╛рдм рд╕реЗ рдкрд╣рд▓рд╛ рдкреЗрдЬ рджрд┐рдЦрд╛рдПрдБ
        if (AppState.user.role === 'ACCOUNTANT') {
            renderView('reports'); // CA рдХреЛ рд╕реАрдзреЗ рд░рд┐рдкреЛрд░реНрдЯреНрд╕ рджрд┐рдЦрд╛рдПрдБ
        } else {
            renderView('dashboard'); // рдмрд╛рдХреА рд╕рдмрдХреЛ рдбреИрд╢рдмреЛрд░реНрдб (POS) рджрд┐рдЦрд╛рдПрдБ
        }
        
        initDashboardSocket();
        fetchAndRenderPaintHistory();
    };

    /**
     * Hides/Shows UI elements based on user role
     * Roles: ADMIN (3) > MANAGER (2) > CASHIER (1)
     */
     function applyRBAC(role) {
    
    // 1. Role levels ko define karein
    // (Accountant, Manager ke barabar hai, yaani Level 2)
    const roles = { 'ADMIN': 3, 'MANAGER': 2, 'ACCOUNTANT': 2, 'CASHIER': 1, 'ANY': 0 };
    
    const userRole = role.toUpperCase();
    const userLevel = roles[userRole] || 0;

    // 2. Sabhi [data-role] wale elements ko check karein
    document.querySelectorAll('[data-role]').forEach(el => {
        const requiredRole = el.dataset.role.toUpperCase();
        
        // Agar data-role define nahi hai, to use 'ANY' maanein
        const requiredLevel = roles[requiredRole] || 0; 

        let show = false; // Default: Sab chhupa do

        // 3. Logic: Kise kya dikhana hai?
        if (userRole === 'ACCOUNTANT') {
            
            // --- ЁЯЪА ACCOUNTANT KA LOGIC ---
            // CA sirf 'ANY', 'ACCOUNTANT', ya 'MANAGER' (reports ke liye)
            // wali cheezein dekh sakta hai.
            if (requiredRole === 'ANY' || requiredRole === 'ACCOUNTANT' || requiredRole === 'MANAGER') {
                show = true;
            }
            // --- Yeh Line Sabse Zaroori Hai ---
            // Agar element 'CASHIER' ka hai, to CA ko *mat* dikhao
            if (requiredRole === 'CASHIER') {
                show = false;
            }

        } else {
            // --- ЁЯЪА ADMIN/MANAGER/CASHIER KA PURANA LOGIC ---
            // (Level-based: Admin > Manager > Cashier)
            if (requiredRole === 'ANY' || userLevel >= requiredLevel) {
                show = true;
            }
        }

        // 4. Faisla laagu (apply) karein
        if (show) {
            el.classList.remove('d-none'); // Dikhao
        } else {
            el.classList.add('d-none'); // Chhupao
        }
    });

// [ YEH NAYA CODE YAHAN PASTE KAREIN ]

    // --- ЁЯЪА NAYA FIX (v4): CA KE LIYE ACTION FORMS/BUTTONS ALAG SE CHHUPAO ---
    // (Yeh code [data-role] loop ke *baad* chalta hai)

       // Sabhi "Add" forms ke ID
    //┬аSabhi┬а"Add"┬аforms┬аke┬аID
    ┬а┬а┬а┬аconst┬аallActionForms┬а=┬а[
┬а┬а┬а┬а┬а┬а┬а┬а'#add-stock-form',┬а'#add-expense-form',┬а'#add-purchase-form',┬а
┬а┬а┬а┬а┬а┬а┬а┬а'#add-staff-form',┬а'#company-profile-form', 
┬а┬а┬а ┬а┬а┬а┬а'#daily-closing'
┬а┬а┬а┬а];
    
    // Sabhi "Edit/Delete/Submit" buttons ke Class/Selectors
    // (List ko file [SAgar SAGArLatest 2 (2)(1).html] ke hisaab se update kiya gaya hai)
    const allActionButtons = document.querySelectorAll(
        '.edit-stock-btn, button[onclick^="deleteStock"], .delete-stock-btn,' +
        '.edit-customer-btn, .delete-customer-btn,' +
        '.edit-expense-btn, .delete-expense-btn,' +
        '.edit-purchase-btn, .delete-purchase-btn,' +
        '.edit-staff-btn, .delete-staff-btn, button[onclick^="deleteStaff"],' +
        'button[onclick^="editStaff"], button[type="submit"],' +
        '#editStaffModal .modal-footer .btn-primary,' +
        'a[onclick^="showEditCustomerModal"], #editCustomerModal .modal-footer .btn-primary,' +
        'a[onclick^="showEditStockModal"], #editStockModal .modal-footer .btn-primary'
    );

    if (userRole === 'ACCOUNTANT') {
        // Agar CA hai, to sabhi forms aur action buttons ko chhupao
        allActionForms.forEach(selector => {
            const el = document.querySelector(selector);
            if (el) el.classList.add('d-none');
        });
        allActionButtons.forEach(btn => btn.classList.add('d-none'));

    } else {
        // Agar CA nahi hai, to sabhi ko (wapas) dikhao
        // (Yeh zaroori hai agar user logout karke Admin jaisa login kare)
        allActionForms.forEach(selector => {
            const el = document.querySelector(selector);
            if (el) el.classList.remove('d-none');
        });
        allActionButtons.forEach(btn => btn.classList.remove('d-none'));
    }
    // --- NAYA FIX YAHAN KHATM HOTA HAI ---
}


    // --- INVOICE GENERATOR FUNCTIONS ---
    function initializeQRUpload() {
        console.log("Initializing QR Upload...");
        const qrUploadInput = document.getElementById('qrUpload'); //
        if (qrUploadInput) {
            qrUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) {
                    qrCodeImage = '';
                    updateInvoicePreview();
                    return;
                }
                
                // рдлрд╝рд╛рдЗрд▓ рдХреЛ Base64 рд╕реНрдЯреНрд░рд┐рдВрдЧ рдореЗрдВ рдмрджрд▓реЗрдВ
                const reader = new FileReader();
                reader.onload = (event) => {
                    qrCodeImage = event.target.result; // Base64 рдбреЗрдЯрд╛
                    updateInvoicePreview(); // рдкреНрд░реАрд╡реНрдпреВ рдХреЛ QR рдХреЛрдб рдХреЗ рд╕рд╛рде рд░реАрдлреНрд░реЗрд╢ рдХрд░реЗрдВ
                };
                reader.readAsDataURL(file);
            });
        }
    }
    // --- REPORT ACTION HANDLER ---

    
    function handleReportAction(reportType, action) {
        // рдкреНрд░рд┐рдВрдЯ рд▓реЙрдЬрд┐рдХ рдХреЗ рд▓рд┐рдП рд░рд┐рдкреЛрд░реНрдЯ рдХрд╛рд░реНрдб рдХрд╛ ID
        const reportCardId = reportType === 'profit_loss' ? 'pl-card' : 'bs-card';
        const reportElement = document.getElementById(reportCardId);

        if (action === 'print') {
            // --- PRINT LOGIC (рдЗрд╕реЗ рдирд╣реАрдВ рдмрджрд▓рд╛ рдЧрдпрд╛ рд╣реИ) ---
            document.querySelectorAll('.printable').forEach(el => el.classList.remove('printable'));
            reportElement.classList.add('printable');

            const headerHtml = `
                <div class="printable text-center mb-3">
                    <h3>${AppState.user.shopName}</h3>
                    <p class="mb-0">рд░рд┐рдкреЛрд░реНрдЯ: ${reportType.replace('_', ' ')}</p>
                    <p class="mb-0">рддрд╛рд░реАрдЦ: ${new Date().toLocaleDateString()}</p>
                </div>
            `;

            let headerDiv = reportElement.querySelector('.report-print-header');
            if (headerDiv) {
                headerDiv.innerHTML = headerHtml;
            } else {
                headerDiv = document.createElement('div');
                headerDiv.className = 'report-print-header';
                headerDiv.innerHTML = headerHtml;
                reportElement.prepend(headerDiv);
            }

            window.print();

        } else if (action === 'download') {

            // --- ЁЯЪА рдпрд╣ рд░рд╣рд╛ рдЖрдкрдХрд╛ рдлрд┐рдХреНрд╕ EXCEL DOWNLOAD LOGIC ---
            
            showMessage('Info', 'Excel (.xlsx) рдлрд╝рд╛рдЗрд▓ рдмрдирд╛рдИ рдЬрд╛ рд░рд╣реА рд╣реИ, рдХреГрдкрдпрд╛ рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░реЗрдВ...', 'info');

            try {
                // 1. рдирдпрд╛ Excel Workbook (рдЦрд╛рд▓реА рдлрд╝рд╛рдЗрд▓) рдмрдирд╛рдПрдБ
                const wb = XLSX.utils.book_new();
                
                // ЁЯЪА NAYA HELPER: рджреЛ рдЯреЗрдмрд▓реЛрдВ рдХреЛ рдЕрдЧрд▓-рдмрдЧрд▓ рдорд░реНрдЬ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП
                const mergeTablesSideBySide = (table1, table2) => {
                    const t1Rows = table1.querySelectorAll('tr');
                    const t2Rows = table2.querySelectorAll('tr');
                    const maxRows = Math.max(t1Rows.length, t2Rows.length);
                    const mergedData = [];

                    for (let i = 0; i < maxRows; i++) {
                        const newRow = [];
                        
                        // 1. Get Left Table Data (Cols A, B)
                        if (t1Rows[i]) {
                            const cells = t1Rows[i].querySelectorAll('th, td');
                            newRow.push(cells[0] ? cells[0].innerText.trim() : ''); // Col A
                            newRow.push(cells[1] ? cells[1].innerText.trim() : ''); // Col B
                        } else {
                            newRow.push('', ''); // Empty placeholders
                        }

                        // 2. Get Spacer (Col C)
                        newRow.push(''); // Blank column

                        // 3. Get Right Table Data (Cols D, E)
                        if (t2Rows[i]) {
                            const cells = t2Rows[i].querySelectorAll('th, td');
                            newRow.push(cells[0] ? cells[0].innerText.trim() : ''); // Col D
                            newRow.push(cells[1] ? cells[1].innerText.trim() : ''); // Col E
                        } else {
                            newRow.push('', ''); // Empty placeholders
                        }
                        
                        mergedData.push(newRow);
                    }
                    return mergedData;
                };
                // ЁЯЪА NAYA HELPER YAHAN KHATM HOTA HAI

                if (reportType === 'profit_loss') {
                    // --- P&L рдЯреЗрдмрд▓реНрд╕ рдХреЛ рдЙрдирдХреЗ рдХрд╛рд░реНрдб рд╕реЗ рдвреВрдБрдвреЗрдВ ---
                    const plCard = document.getElementById('pl-card');
                    const plTables = plCard.querySelectorAll('table.report-table'); // рджреЛрдиреЛрдВ P&L рдЯреЗрдмрд▓ рдЪреБрдиреЗрдВ
                    if (plTables.length < 2) throw new Error('P&L рдЯреЗрдмрд▓реНрд╕ рдирд╣реАрдВ рдорд┐рд▓реАрдВред');
                    
                    const mergedPLData = mergeTablesSideBySide(plTables[0], plTables[1]);
                    const ws_pl = XLSX.utils.aoa_to_sheet(mergedPLData);
                    ws_pl['!cols'] = [ { wch: 30 }, { wch: 20 }, { wch: 5 }, { wch: 30 }, { wch: 20 } ];
                    
                    XLSX.utils.book_append_sheet(wb, ws_pl, 'Profit & Loss (Side-by-Side)');
                    XLSX.writeFile(wb, `P&L_report_${getISODate()}.xlsx`);


                } else if (reportType === 'balance_sheet') {
                    // --- Balance Sheet рдЯреЗрдмрд▓реНрд╕ рдХреЛ рдЙрдирдХреЗ рдХрд╛рд░реНрдб рд╕реЗ рдвреВрдБрдвреЗрдВ ---
                    const bsCard = document.getElementById('bs-card');
                    const bsTables = bsCard.querySelectorAll('table.report-table'); // рджреЛрдиреЛрдВ BS рдЯреЗрдмрд▓ рдЪреБрдиреЗрдВ
                    if (bsTables.length < 2) throw new Error('рдмреИрд▓реЗрдВрд╕ рд╢реАрдЯ рдЯреЗрдмрд▓реНрд╕ рдирд╣реАрдВ рдорд┐рд▓реАрдВред');

                    // ЁЯЪА NAYA LOGIC: рджреЛрдиреЛрдВ рдХреЛ рдорд░реНрдЬ рдХрд░реЗрдВ
                    const mergedBSData = mergeTablesSideBySide(bsTables[0], bsTables[1]);
                    
                    // 4. Create worksheet from the merged data
                    const ws_bs = XLSX.utils.aoa_to_sheet(mergedBSData);
                    
                    // (Optional but good) Adjust column widths
                    ws_bs['!cols'] = [ { wch: 30 }, { wch: 20 }, { wch: 5 }, { wch: 30 }, { wch: 20 } ];

                    // 5. Create workbook and download
                    XLSX.utils.book_append_sheet(wb, ws_bs, 'Balance Sheet (Side-by-Side)');
                    XLSX.writeFile(wb, `balance_sheet_side_by_side_${getISODate()}.xlsx`);
                }

            } catch (err) {
                showMessage('рддреНрд░реБрдЯрд┐', 'Excel рдлрд╝рд╛рдЗрд▓ рдмрдирд╛рдиреЗ рдореЗрдВ рд╡рд┐рдлрд▓: ' + err.message, 'danger');
                console.error("Excel download error:", err);
            }
            
            // --- ЁЯЪА рдирдпрд╛ рдФрд░ рд╕рд╣реА EXCEL DOWNLOAD LOGIC рдпрд╣рд╛рдБ рдЦрддреНрдо рд╣реЛрддрд╛ рд╣реИ ---
        }
    }



	
    // --- UNIVERSAL DELETE FUNCTION ---
   async function deleteEntry(type, id) {
        // 'id' is now the primary key or SKU
        const messages = {
            sale: `(рдЕрд╕рдорд░реНрдерд┐рдд) рдХреНрдпрд╛ рдЖрдк рд╡рд╛рдХрдИ рдЗрд╕ рдмрд┐рдХреНрд░реА (ID: ${id}) рдХреЛ рд╣рдЯрд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?`,
            stock: `рдХреНрдпрд╛ рдЖрдк рд╡рд╛рдХрдИ рдЗрд╕ рд╕реНрдЯреЙрдХ рдЖрдЗрдЯрдо (SKU: ${id}) рдХреЛ рд╣рдЯрд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?`, // Changed to SKU
            customer: `(рдЕрд╕рдорд░реНрдерд┐рдд) рдХреНрдпрд╛ рдЖрдк рд╡рд╛рдХрдИ рдЗрд╕ рдЧреНрд░рд╛рд╣рдХ (ID: ${id}) рдХреЛ рд╣рдЯрд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?`,
            purchase: `рдХреНрдпрд╛ рдЖрдк рд╡рд╛рдХрдИ рдЗрд╕ рдЦрд░реАрдж рд░рд┐рдХреЙрд░реНрдб (ID: ${id}) рдХреЛ рд╣рдЯрд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?`,
            expense: `рдХреНрдпрд╛ рдЖрдк рд╡рд╛рдХрдИ рдЗрд╕ рдЦрд░реНрдЪ рд░рд┐рдХреЙрд░реНрдб (ID: ${id}) рдХреЛ рд╣рдЯрд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?`
        };

        if (!confirm(messages[type])) return;

        let apiPath = '';
        let successCallback;

        switch (type) {
            case 'stock': apiPath = `/api/stock/${id}`; successCallback = fetchAndRenderStockList; break;
            case 'purchase': apiPath = `/api/purchases/${id}`; successCallback = fetchAndRenderPurchases; break; 
            case 'expense': apiPath = `/api/expenses/${id}`; successCallback = fetchAndRenderExpenses; break; 
            
            case 'sale': 
            case 'customer':
            default: 
                showMessage('рддреНрд░реБрдЯрд┐', 'рдпрд╣ рдХреНрд░рд┐рдпрд╛ (delete) рд╕рд░реНрд╡рд░ рджреНрд╡рд╛рд░рд╛ рд╕рдорд░реНрдерд┐рдд рдирд╣реАрдВ рд╣реИред', 'danger'); 
                return;
        }

        try {
            const res = await fetchApi(apiPath, { method: 'DELETE' }, 'рд╣рдЯрд╛рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ...');
            if (res.success) {
                showMessage('рд╕рдлрд▓рддрд╛', res.message, 'success');
                if (successCallback) successCallback();
                renderDashboard();
                renderReports();
            } else {
                throw new Error(res.message);
            }
        } catch (error) {
            showMessage('рддреНрд░реБрдЯрд┐', `рд╣рдЯрд╛рдиреЗ рдореЗрдВ рд╡рд┐рдлрд▓: ${error.message}`, 'danger');
        }
    }


    function addItem() {
    const itemName = document.getElementById('itemName').value;
    const quantity = parseFloat(document.getElementById('quantity').value);
    const price = parseFloat(document.getElementById('price').value);
    const gst = parseFloat(document.getElementById('gst').value) || 0;

    // ЁЯФО Current selected stock item (assume POS dropdown / search se aata hai)
    const selectedStockItem = currentStock.find(i => i.name === itemName);

    // ЁЯФР ANTI-THEFT CHECK (тнР рдпрд╣реА MAIN рдЪреАрдЬ рд╣реИ)
    if (selectedStockItem?.product_attributes?.is_secured) {
        alert('тЪая╕П Anti-Theft Item Detected!\nBilling ke bina exit allowed nahi.');
    }

    if (!itemName || !quantity || !price) {
        showMessage('Error', 'Please fill Item Name, Quantity, and Rate.', 'danger');
        return;
    }

    items.push({
        name: itemName,
        quantity: quantity,
        price: price,
        gst: gst,
        is_secured: selectedStockItem?.product_attributes?.is_secured || false
    });

    updateInvoicePreview();
    document.getElementById('item-form').reset();
    document.getElementById('itemName').focus();
}


    function deleteItem(index) {
        if (confirm('Are you sure you want to delete this item?')) {
            items.splice(index, 1);
            updateInvoicePreview();
        }
    }

    function updateInvoicePreview() {
        const shopName = document.getElementById('shopName').value || 'Shop Name';
        const shopContact = document.getElementById('shopContact').value || 'Contact No.';
        const shopAddress = document.getElementById('shopAddress').value || 'Shop Address';
        const shopGstin = document.getElementById('shopGstin').value || '';
        
        const customerName = document.getElementById('customerName').value || 'Customer Name';
        const customerContact = document.getElementById('customerContact').value || 'Contact No.';
        const customerAddress = document.getElementById('customerAddress').value || 'Customer Address';
        
        const preview = document.getElementById('invoice-preview'); //
        
        let itemRows = '';
        let totalAmount = 0;
        let totalTax = 0;
        let subTotal = 0;
        
        items.forEach((item, index) => {
            const itemSubTotal = (item.price || 0) * (item.quantity || 0);
            const itemGst = itemSubTotal * ((item.gst || 0) / 100);
            const itemTotal = itemSubTotal + itemGst;
            
            subTotal += itemSubTotal;
            totalTax += itemGst;
            totalAmount += itemTotal;
            
            itemRows += `
                <tr>
                    <td>${index + 1}</td>
                    <td style="text-align: left;">${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${formatCurrency(item.price)}</td>
                    <td>${item.gst}%</td>
                    <td>${formatCurrency(itemSubTotal)}</td>
                    <td>
                        <button class="btn btn-danger btn-sm py-0 px-1 no-print" onclick="deleteItem(${index})">&times;</button>
                    </td>
                </tr>
            `;
        });

        const cgst = totalTax / 2;
        const sgst = totalTax / 2;
        
        // ЁЯЪА (рдлрд┐рдХреНрд╕) QR рдХреЛрдб рдХреЗ рд▓рд┐рдП HTML
        const qrHtml = qrCodeImage ? `
            <div id="qr-preview" class="text-center">
                <p class="small mb-1">Scan to Pay:</p>
                <img src="${qrCodeImage}" alt="UPI QR Code" style="max-width: 100px; max-height: 100px; border: 1px solid #ccc; padding: 3px;">
            </div>` : '';

        // рдкреВрд░рд╛ рдЗрдирд╡реЙрдЗрд╕ HTML
        preview.innerHTML = `
            <div class="printable">
                <div class="invoice-header">
                    <div class="shop-details">
                        <h3>${shopName}</h3>
                        <p class="mb-0">${shopAddress}</p>
                        <p class="mb-0">Ph: ${shopContact}</p>
                        ${shopGstin ? `<p class="mb-0"><strong>GSTIN: ${shopGstin}</strong></p>` : ''}
                    </div>
                    <h2 style="color: #333; align-self: center;">INVOICE</h2>
                </div>
                
                <div class="customer-details row">
                    <div class="col-8">
                        <strong>Bill To:</strong>
                        <p class="mb-0">${customerName}</p>
                        <p class="mb-0">${customerAddress}</p>
                        <p class="mb-0">Ph: ${customerContact}</p>
                    </div>
                    <div class="col-4 text-end">
                        <p class="mb-0"><strong>Invoice No:</strong> INV-${Date.now().toString().slice(-6)}</p>
                        <p class="mb-0"><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                    </div>
                </div>

                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">#</th>
                            <th style="text-align: left;">Item</th>
                            <th style="width: 10%;">Qty</th>
                            <th style="width: 15%;">Rate</th>
                            <th style="width: 10%;">GST%</th>
                            <th style="width: 15%;">Amount</th>
                            <th style="width: 5%;" class="no-print"></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemRows || `<tr><td colspan="7" class="text-center text-muted p-4">No items added.</td></tr>`}
                    </tbody>
                </table>
                
                <div class="invoice-footer">
                    <div>
                        ${qrHtml} <div class="terms mt-3">
                            <strong>Terms & Conditions:</strong>
                            <p class="mb-0">1. Goods once sold will not be taken back.</p>
                            <p class="mb-0">2. All disputes are subject to jurisdiction.</p>
                        </div>
                    </div>
                    
                    <table class="totals-table">
                        <tbody>
                            <tr>
                                <td>Subtotal:</td>
                                <td style="text-align: right;">${formatCurrency(subTotal)}</td>
                            </tr>
                            <tr>
                                <td>CGST:</td>
                                <td style="text-align: right;">${formatCurrency(cgst)}</td>
                            </tr>
                            <tr>
                                <td>SGST:</td>
                                <td style="text-align: right;">${formatCurrency(sgst)}</td>
                            </tr>
                            <tr style="font-weight: bold; font-size: 1.2em; border-top: 2px solid #333;">
                                <td>Grand Total:</td>
                                <td style="text-align: right;">${formatCurrency(totalAmount)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }


   function downloadInvoicePDF() {
        if (items.length === 0) {
            return showMessage('рддреНрд░реБрдЯрд┐', 'PDF рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХреГрдкрдпрд╛ рдкрд╣рд▓реЗ рдЖрдЗрдЯрдо рдЬреЛрдбрд╝реЗрдВред', 'warning');
        }
        handleReportAction('invoice', 'download');
    }

    function printInvoice() {
        window.print();
    }

    function clearBill() {
        if (confirm('Are you sure you want to clear the entire bill?')) {
            items = [];
            qrCodeImage = '';
            document.getElementById('qrUpload').value = null;
            document.getElementById('customerName').value = '';
            document.getElementById('customerContact').value = '';
            document.getElementById('customerAddress').value = '';
            document.getElementById('item-form').reset();
            
            // рд╢реЙрдк рдХреА рдбрд┐рдЯреЗрд▓реНрд╕ рдХреЛ рдлрд┐рд░ рд╕реЗ рднрд░реЗрдВ (рдЙрдиреНрд╣реЗрдВ рдХреНрд▓рд┐рдпрд░ рди рдХрд░реЗрдВ)
            fetchAndPopulateShopData(); 
            
            showMessage('Success', 'Bill cleared.', 'success');
        }
    }
   // ===================================
    // STEP 6: NEW AUTHENTICATION FLOW & NEW FEATURES
    // ===================================

    /**
     * Saves auth data to AppState and localStorage
     */
     function saveAuthData(token, user) {
        AppState.token = token;
        AppState.user = user;
        localStorage.setItem('authToken', token);
        localStorage.setItem('authUser', JSON.stringify(user));
        
        // Update UI with user info
        updateShopDisplay(user);
    }
    
    // NEW: Update Shop Name/Logo in UI
   // NEW: Update Shop Name/Logo in UI
  // NEW: Update Shop Name/Logo in UI
 // [REPLACE THIS FUNCTION IN HTML <script>]

function updateShopDisplay(user) {
    if (!user) return;
    const shopName = user.shopName || 'Dukan Pro';
    
    // 1. рд▓реЛрдЧреЛ рд▓реЙрдЬрд┐рдХ (Logo Logic)
    const storedLogo = localStorage.getItem('shopLogoData');
    const shopLogo = user.shopLogo || storedLogo; 

    // 2. рдпреВрдЬрд░ рдЗрдиреНрдлреЛ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ (рдиреАрдЪреЗ рд╡рд╛рд▓рд╛ рдмреЙрдХреНрд╕)
    document.getElementById('user-shop-name').innerText = shopName;
    
    // ЁЯЪА NEW: Shop ID рдХреЛ рдпрд╣рд╛рдБ рдмреЛрд▓реНрдб рдФрд░ рд╣рд╛рдИрд▓рд╛рдЗрдЯ рдХрд░рдХреЗ рджрд┐рдЦрд╛рдПрдВ
    document.getElementById('user-name-email').innerHTML = `
        ${user.name} (${user.role}) <br>
        <span class="badge bg-warning text-dark mt-2 w-100 shadow-sm" style="font-size: 0.9rem;">
            <i class="fas fa-id-badge me-1"></i> Shop ID: ${user.shopId}
        </span>
    `;
    
    // 3. рд╕рд╛рдЗрдбрдмрд╛рд░ рд╣реЗрдбрд░ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ (рд╕рдмрд╕реЗ рдКрдкрд░ рд╡рд╛рд▓рд╛ рдЯрд╛рдЗрдЯрд▓)
    // ЁЯЪА NEW: Shop ID рдХреЛ "Dukan Pro" рдХреЗ рдмрдЧрд▓ рдореЗрдВ рднреА рджрд┐рдЦрд╛рдПрдВ
    const sidebarHeader = document.querySelector('.sidebar h3');
    if (sidebarHeader) {
        sidebarHeader.innerHTML = `
            <i class="fas fa-store me-2"></i>Dukan Pro 
            <sup class="badge bg-danger rounded-pill ms-1" style="font-size: 0.5em; top: -10px;">ID: ${user.shopId}</sup>
        `;
    }

    // 4. рд▓реЛрдЧреЛ рдбрд┐рд╕реНрдкреНрд▓реЗ (Logo Display)
    const logoContainer = document.getElementById('shop-logo-container');
    if (shopLogo) {
        logoContainer.innerHTML = `<img src="${shopLogo}" alt="Shop Logo" class="img-fluid rounded-circle" style="max-height: 100px; border: 3px solid #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">`;
        
        // Settings рдкреЗрдЬ рдкрд░ рднреА рд▓реЛрдЧреЛ рджрд┐рдЦрд╛рдПрдВ
        const removeBtn = document.getElementById('remove-shop-logo-btn');
        const preview = document.getElementById('shop-logo-preview');
        if (removeBtn) removeBtn.classList.remove('d-none');
        if (preview) {
            preview.src = shopLogo; 
            preview.style.display = 'block';
        }
    } else {
        if (logoContainer) logoContainer.innerHTML = '';
        const removeBtn = document.getElementById('remove-shop-logo-btn');
        const preview = document.getElementById('shop-logo-preview');
        if (removeBtn) removeBtn.classList.add('d-none');
        if (preview) preview.style.display = 'none';
    }
}


    /**
     * Clears auth data and reloads the page to show login screen
     */
     function logout() {
    AppState.token = null;
    AppState.user = null;
    localStorage.removeItem('authToken');
    localStorage.removeItem('authUser');
    if(AppState.licenseTimerId) clearInterval(AppState.licenseTimerId);
    
    // window.location.reload(); // тЬЕ рдЗрд╕реЗ рд╣рдЯрд╛ рджрд┐рдпрд╛ (рдХрдореЗрдВрдЯ рдХрд░ рджрд┐рдпрд╛)
    
    // рд░рд┐рдлреНрд░реЗрд╢ рдХреА рдЬрдЧрд╣ рд▓реЙрдЧрд┐рди рд╕реНрдХреНрд░реАрди рджрд┐рдЦрд╛рдПрдВ
    document.getElementById('login-wrapper-main').classList.add('active');
    document.getElementById('auth-container-new').classList.remove('hidden');
    document.getElementById('sidebar').classList.add('locked');
    document.getElementById('main-content').classList.add('locked');
}
    
    // NEW: License Timer and Renewal Warning
    function startLicenseTimer(expiryDateStr) {
        const timerEl = document.getElementById('license-timer');
        const renewalModal = new bootstrap.Modal(document.getElementById('renewalModal'));
        if (AppState.licenseTimerId) clearInterval(AppState.licenseTimerId);
        
        if (!expiryDateStr) {
            timerEl.innerHTML = `<i class="fas fa-times-circle text-danger"></i> рд▓рд╛рдЗрд╕реЗрдВрд╕ рд╕рдХреНрд░рд┐рдп рдирд╣реАрдВ рд╣реИ`;
            timerEl.className = 'text-center mb-2 expired';
            timerEl.onclick = () => renewalModal.show();
            return;
        }

        const expiryDate = new Date(expiryDateStr);
        
        function updateTimer() {
            const now = new Date();
            const timeLeft = expiryDate.getTime() - now.getTime();
            
            const daysLeft = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hoursLeft = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutesLeft = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const secondsLeft = Math.floor((timeLeft % (1000 * 60)) / 1000);

            if (timeLeft <= 0) {
                timerEl.innerHTML = `<i class="fas fa-times-circle"></i> рд▓рд╛рдЗрд╕реЗрдВрд╕ рд╕рдорд╛рдкреНрдд рд╣реЛ рдЧрдпрд╛ рд╣реИ`;
                timerEl.className = 'text-center mb-2 expired';
                timerEl.onclick = () => renewalModal.show();
                clearInterval(AppState.licenseTimerId);
            } else if (daysLeft < 7) {
                // Requirement 9: Expiring soon warning
                timerEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${daysLeft}d ${hoursLeft}h рдореЗрдВ рд╕рдорд╛рдкреНрдд рд╣реЛрдЧрд╛!`;
                timerEl.className = 'text-center mb-2 expiring-soon';
                timerEl.onclick = () => renewalModal.show();
            } else {
                timerEl.innerHTML = `<i class="fas fa-check-circle text-success"></i> ${daysLeft} рджрд┐рди ${hoursLeft} рдШрдВрдЯреЗ рд╢реЗрд╖`;
                timerEl.className = 'text-center text-white-50 mb-2';
                timerEl.onclick = null;
            }
        }
        
        updateTimer();
        AppState.licenseTimerId = setInterval(updateTimer, 1000); // Update every second
    }
    
    // NEW: Send WhatsApp Renewal Request
    function sendWhatsAppRenewal(months) {
        const adminPhone = "7303410987";
        let message = `рдирдорд╕реНрддреЗ Dukan Pro рдПрдбрдорд┐рди,\n\n`;
        message += `рдореЗрд░рд╛ рдирд╛рдо ${AppState.user.name} рд╣реИ рдФрд░ рдореЗрд░реА рд╢реЙрдк рдХрд╛ рдирд╛рдо ${AppState.user.shopName} (Shop ID: ${AppState.user.shopId}) рд╣реИред\n`;
        message += `рдореЗрд░рд╛ рдИрдореЗрд▓: ${AppState.user.email}\n\n`;
        message += `рдореИрдВ рдЕрдкрдирд╛ Dukan Pro рд▓рд╛рдЗрд╕реЗрдВрд╕ ${months} рдорд╣реАрдиреЗ рдХреЗ рд▓рд┐рдП рд░рд┐рдиреНрдпреВ рдХрд░рдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реВрдБред рдХреГрдкрдпрд╛ рднреБрдЧрддрд╛рди рд╡рд┐рд╡рд░рдг рдкреНрд░рджрд╛рди рдХрд░реЗрдВред\n\nрдзрдиреНрдпрд╡рд╛рджред`;
        
        const whatsappUrl = `https://wa.me/${adminPhone}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
    }
    
    // NEW: Barcode Scanning Functions
    function focusBarcodeScanner() {
        const scannerInput = document.getElementById('barcode-scanner-input');
        // Only focus if we are on the sales page
        if(AppState.currentView === 'sales') {
            scannerInput.focus();
        }
    }
    
       
    // NEW: Functions for New Sections
    async function fetchAndRenderClosingReports() {
    console.log("ЁЯЪА fetchAndRenderClosingReports() рд╢реБрд░реВ рд╣реБрдЖ..."); // Log Start
    const tableBody = document.getElementById('daily-closing-table-body');
    if (!tableBody) {
         console.error("тЭМ рдПрд░рд░: daily-closing-table-body рдирд╣реАрдВ рдорд┐рд▓рд╛!");
         return;
    }
    tableBody.innerHTML = `<tr><td colspan="5" class="text-center">рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...</td></tr>`;
    try {
        console.log("ЁЯУб API рдХреЙрд▓ /api/closing/reports рднреЗрдЬрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ...");
        const res = await fetchApi('/api/closing/reports', { method: 'GET' });
        console.log("ЁЯУД API рд░рд┐рд╕реНрдкрд╛рдВрд╕ рдорд┐рд▓рд╛:", res); // Log Response

        if (res.success && res.reports && res.reports.length > 0) {
             console.log(`ЁЯУК ${res.reports.length} рд░рд┐рдкреЛрд░реНрдЯреНрд╕ рдорд┐рд▓реАрдВред HTML рдмрдирд╛ рд░рд╣рд╛ рд╣реВрдБ...`);
            tableBody.innerHTML = res.reports.map(r => `
                <tr>
                    <td>${new Date(r.closing_date).toLocaleDateString()}</td>
                    <td>${formatCurrency(r.total_sales)}</td>
                    <td>${formatCurrency(r.total_cogs)}</td>
                    <td>${formatCurrency(r.total_expenses)}</td>
                    <td class="fw-bold ${r.net_profit >= 0 ? 'text-success' : 'text-danger'}">
                        ${formatCurrency(r.net_profit)}
                    </td>
                </tr>
            `).join('');
             console.log("тЬЕ рдЯреЗрдмрд▓ HTML рдЕрдкрдбреЗрдЯ рд╣реЛ рдЧрдпрд╛ред");
        } else {
             console.log("тД╣я╕П рдХреЛрдИ рд░рд┐рдкреЛрд░реНрдЯ рдирд╣реАрдВ рдорд┐рд▓реА рдпрд╛ API рд╡рд┐рдлрд▓ред");
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">рдХреЛрдИ рдХреНрд▓реЛрдЬрд┐рдВрдЧ рд░рд┐рдкреЛрд░реНрдЯ рдирд╣реАрдВ рдорд┐рд▓реАред</td></tr>`;
        }
    } catch (e) {
        console.error("тЭМ fetchAndRenderClosingReports рдПрд░рд░:", e); // Log Error
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">рддреНрд░реБрдЯрд┐: ${e.message}</td></tr>`;
    }
     console.log("ЁЯПБ fetchAndRenderClosingReports() рдЦрддреНрдо рд╣реБрдЖред"); // Log End
}
    
    async function fetchAndRenderShopSettings() {
        try {
            // Fetch company profile (GST info) [cite: 349]
            const profileRes = await fetchApi('/api/shop/company-profile', { method: 'GET' });
            if (profileRes.success && profileRes.profile) {
                document.getElementById('company-legal-name').value = profileRes.profile.legal_name || '';
                document.getElementById('company-gstin').value = profileRes.profile.gstin || '';
                document.getElementById('company-address').value = profileRes.profile.address || '';
                // ЁЯЪА FIX: рдкреВрдВрдЬреА рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдпрд╣ рд▓рд╛рдЗрди рдЬреЛрдбрд╝реА
                document.getElementById('company-opening-capital').value = profileRes.profile.opening_capital || '0'; 
            }
            
            // Fetch display settings (from user object)
            document.getElementById('shop-display-name').value = AppState.user.shopName || '';
            const logoPreview = document.getElementById('shop-logo-preview');
            if (AppState.user.shopLogo) {
                logoPreview.src = AppState.user.shopLogo;
                logoPreview.style.display = 'block';
            } else {
                logoPreview.style.display = 'none';
            }
        } catch (e) {
            showMessage('рддреНрд░реБрдЯрд┐', `рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рд▓реЛрдб рдХрд░рдиреЗ рдореЗрдВ рд╡рд┐рдлрд▓: ${e.message}`, 'danger');
        }
    }
    
    // NEW: Handle complex backup downloads
    async function handleBackupDownloads(type) {
        if (type === 'json') {
            try {
                const res = await fetchApi('/api/backup', { method: 'GET' }, 'JSON рдмреИрдХрдЕрдк рдмрдирд╛рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ...');
                if (res.success) {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(res.backupData, null, 2));
                    const dlAnchorElem = document.createElement('a');
                    dlAnchorElem.setAttribute("href", dataStr);
                    dlAnchorElem.setAttribute("download", `dukan_pro_backup_${AppState.user.shopId}_${getISODate()}.json`);
                    dlAnchorElem.click();
                } else {
                    showMessage('рддреНрд░реБрдЯрд┐', res.message, 'danger');
                }
            } catch (e) { showMessage('рддреНрд░реБрдЯрд┐', e.message, 'danger'); }
        
        } else if (type === 'excel') {
            try {
                const res = await fetchApi('/api/backup', { method: 'GET' }, 'Excel рдмреИрдХрдЕрдк рдмрдирд╛рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ...');
                if (res.success) {
                    const wb = XLSX.utils.book_new();
                    for (const tableName in res.backupData) {
                        const ws = XLSX.utils.json_to_sheet(res.backupData[tableName]);
                        XLSX.utils.book_append_sheet(wb, ws, tableName.slice(0, 31)); // Sheet name limit 31 chars
                    }
                    XLSX.writeFile(wb, `dukan_pro_backup_${AppState.user.shopId}_${getISODate()}.xlsx`);
                } else {
                    showMessage('рддреНрд░реБрдЯрд┐', res.message, 'danger');
                }
            } catch (e) { showMessage('рддреНрд░реБрдЯрд┐', e.message, 'danger'); }
            
        } else if (type === 'csv') {
            const startDate = document.getElementById('product-report-start-date').value;
            const endDate = document.getElementById('product-report-end-date').value;
            if (!startDate || !endDate) {
                return showMessage('рддрд╛рд░реАрдЦ рдЪреБрдиреЗрдВ', "рдХреГрдкрдпрд╛ рдЙрддреНрдкрд╛рдж рдмрд┐рдХреНрд░реА CSV рдХреЗ рд▓рд┐рдП 'Reports' рдЯреИрдм рдореЗрдВ рддрд╛рд░реАрдЦ рдЪреБрдиреЗрдВред", 'warning');
            }
            // Use the dedicated server endpoint [cite: 331]
            const url = `${__backend_url}/api/reports/product-sales/download?startDate=${startDate}&endDate=${endDate}&token=${AppState.token}`;
            // Hacky way to download with token (GET request)
            window.open(url, '_blank');
        }
    }

// [ тЬЕ Naya Helper Function yahaan (Line 2505) add karein ]

// [ тЬЕ рдЗрд╕ рдкреВрд░реЗ рдкреБрд░рд╛рдиреЗ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдирдП рд╡рд╛рд▓реЗ рд╕реЗ рдмрджрд▓реЗрдВ ]

function formatAttributes(attrs) {
    if (!attrs || Object.keys(attrs).length === 0) return '';

    // ЁЯЪА NAYA, ZYADA SMART "CHASHME WALA" CHECK
    // Ab hum _dist ya _near keys ko check karenge
    const hasDist = attrs.sph_od_dist || attrs.cyl_od_dist || attrs.sph_os_dist || attrs.cyl_os_dist;
    const hasNear = attrs.sph_od_near || attrs.cyl_od_near || attrs.sph_os_near || attrs.cyl_os_near;

    if (hasDist || hasNear) {
        let parts = [];
        
        // 1. Right Eye (OD) - DISTANCE
        if (attrs.sph_od_dist || attrs.cyl_od_dist || attrs.axs_od_dist) {
            parts.push(
                // "Right" (OD) рдХрд╛ рдорддрд▓рдм рд╣реИ "рджрд╛рдИрдВ рдЖрдБрдЦ"
                `<strong>Right (Dist):</strong> ${attrs.sph_od_dist || '-'} / ${attrs.cyl_od_dist || '-'} / ${attrs.axs_od_dist || '-'}`
            );
        }
        
        // 2. Left Eye (OS) - DISTANCE
        if (attrs.sph_os_dist || attrs.cyl_os_dist || attrs.axs_os_dist) {
            parts.push(
                // "Left" (OS) рдХрд╛ рдорддрд▓рдм рд╣реИ "рдмрд╛рдИрдВ рдЖрдБрдЦ"
                `<strong>Left (Dist):</strong> ${attrs.sph_os_dist || '-'} / ${attrs.cyl_os_dist || '-'} / ${attrs.axs_os_dist || '-'}`
            );
        }

        // 3. Right Eye (OD) - NEAR
        if (attrs.sph_od_near || attrs.cyl_od_near || attrs.axs_od_near) {
            parts.push(
                `<strong>Right (Near):</strong> ${attrs.sph_od_near || '-'} / ${attrs.cyl_od_near || '-'} / ${attrs.axs_od_near || '-'}`
            );
        }

        // 4. Left Eye (OS) - NEAR
        if (attrs.sph_os_near || attrs.cyl_os_near || attrs.axs_os_near) {
            parts.push(
                `<strong>Left (Near):</strong> ${attrs.sph_os_near || '-'} / ${attrs.cyl_os_near || '-'} / ${attrs.axs_os_near || '-'}`
            );
        }

        return parts.join('<br>'); // Har entry ko nayi line par dikhao
    }

    // Purana fallback logic (Color/Size ke liye)
    let parts = [];
    for (const key in attrs) {
        if (attrs[key]) {
            parts.push(`<strong>${key}:</strong> ${attrs[key]}`);
        }
    }
    return parts.join('<br>');
}

    // рдЕрдкрдиреЗ рдЕрдиреНрдп JavaScript рдлрдВрдХреНрд╢рдиреНрд╕ рдХреЗ рд╕рд╛рде рдЗрд╕реЗ рдЬреЛрдбрд╝реЗрдВ
function removeShopLogo() {
    // 1. рдЧреНрд▓реЛрдмрд▓ рд╡реЗрд░рд┐рдПрдмрд▓ рдХреЛ рд░реАрд╕реЗрдЯ рдХрд░реЗрдВ
    shopLogoBase64 = null; 
    // 2. HTML рд╕рд╛рдлрд╝ рдХрд░реЗрдВ
    document.getElementById('shop-logo-preview').src = '';
    document.getElementById('shop-logo-preview').style.display = 'none';
    document.getElementById('shop-logo-upload').value = null; // рдлрд╝рд╛рдЗрд▓ рдЗрдирдкреБрдЯ рд╕рд╛рдлрд╝ рдХрд░реЗрдВ
    document.getElementById('remove-shop-logo-btn').classList.add('d-none');
    
    showMessage('рд╕рд╛рд╡рдзрд╛рди', 'рд▓реЛрдЧреЛ рд╣рдЯрд╛рдиреЗ рдХреЗ рд▓рд┐рдП "рдбрд┐рд╕реНрдкреНрд▓реЗ рд╕реЗрд╡ рдХрд░реЗрдВ" рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВред', 'warning');
}
    
    // NEW: Setup listeners for all new forms and buttons
    function setupNewFormHandlers() {
    
    // ============================================================
    // 1. PRODUCT SALES REPORT BUTTON (REPORT LOGIC)
    // ============================================================
    const reportBtn = document.getElementById('fetch-product-sales-report-btn');
    if (reportBtn) {
        reportBtn.addEventListener('click', async () => {
            const startDate = document.getElementById('product-report-start-date').value;
            const endDate = document.getElementById('product-report-end-date').value;
            
            if (!startDate || !endDate) {
                return showMessage('рддрд╛рд░реАрдЦ рдЪреБрдиреЗрдВ', 'рдХреГрдкрдпрд╛ рддрд╛рд░реАрдЦ рдЪреБрдиреЗрдВред', 'warning');
            }
            
            const tableBody = document.getElementById('product-sales-report-body');
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center">рд░рд┐рдкреЛрд░реНрдЯ рд▓реЛрдб рд╣реЛ рд░рд╣реА рд╣реИ...</td></tr>`;
            
            try {
                const res = await fetchApi(`/api/reports/product-sales?startDate=${startDate}&endDate=${endDate}`, { method: 'GET' });
                if (res.success && res.report.length > 0) {
                    tableBody.innerHTML = res.report.map(r => `
                        <tr>
                            <td>${r.item_sku}</td>
                            <td>${r.item_name}</td>
                            <td>${r.total_quantity_sold}</td>
                            <td>${formatCurrency(r.total_revenue)}</td>
                            <td>${formatCurrency(r.total_cost)}</td>
                            <td class="fw-bold ${r.total_profit >= 0 ? 'text-success' : 'text-danger'}">
                                ${formatCurrency(r.total_profit)}
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">рдЗрд╕ рдЕрд╡рдзрд┐ рдореЗрдВ рдХреЛрдИ рдмрд┐рдХреНрд░реА рдирд╣реАрдВ рдорд┐рд▓реАред</td></tr>`;
                }
            } catch (e) { 
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">рддреНрд░реБрдЯрд┐: ${e.message}</td></tr>`; 
            }
        });
    }

   

        // GST Report Buttons
        const gstResultEl = document.getElementById('gst-report-result');
        const gstTitleEl = document.getElementById('gst-report-title');
        
        // --- TALLY UPDATE START: GSTR-1 Button Logic ---
        document.getElementById('fetch-gstr1-report-btn').addEventListener('click', async () => {
            const startDate = document.getElementById('gst-report-start-date').value;
            const endDate = document.getElementById('gst-report-end-date').value;
            if (!startDate || !endDate) return showMessage('рддреНрд░реБрдЯрд┐', 'рдХреГрдкрдпрд╛ рддрд╛рд░реАрдЦ рдЪреБрдиреЗрдВред', 'warning');
            
            // рдирдП HTML рдЯреИрдм рдХрдВрдЯреЗрдВрдЯ рдПрд░рд┐рдпрд╛ рдХреЛ рдЯрд╛рд░рдЧреЗрдЯ рдХрд░реЗрдВ
            const gstr1ContentEl = document.getElementById('gstr1-report-content');
            const mainGstTitleEl = document.getElementById('gst-report-title'); // рдпрд╣ рдкреБрд░рд╛рдирд╛ рдЯрд╛рдЗрдЯрд▓ рд╣реИ, рдЗрд╕реЗ рдЫрд┐рдкрд╛ рднреА рд╕рдХрддреЗ рд╣реИрдВ
            
            if(mainGstTitleEl) mainGstTitleEl.innerText = "GSTR-1 (рдмрд┐рдХреНрд░реА) рд░рд┐рдкреЛрд░реНрдЯ (рд▓реЛрдб рд╣реЛ рд░рд╣реА рд╣реИ...)";
            gstr1ContentEl.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

            // GSTR-1 рдЯреИрдм рдХреЛ рд╕рдХреНрд░рд┐рдп рдХрд░реЗрдВ
            new bootstrap.Tab(document.getElementById('gst-gstr1-tab')).show();

            try {
                const res = await fetchApi(`/api/reports/gstr1?startDate=${startDate}&endDate=${endDate}`, { method: 'GET' });
                if (!res.success) throw new Error(res.message || 'GSTR-1 рд░рд┐рдкреЛрд░реНрдЯ рд▓рд╛рдиреЗ рдореЗрдВ рд╡рд┐рдлрд▓ред');
                
                if(mainGstTitleEl) mainGstTitleEl.innerText = `GSTR-1 (рдмрд┐рдХреНрд░реА) рд░рд┐рдкреЛрд░реНрдЯ (${startDate} рд╕реЗ ${endDate})`;
                const report = res.report;
                
                // 1. Tally-Style HTML Template рдХреЛ рдХреНрд▓реЛрди рдХрд░реЗрдВ
                const template = document.getElementById('gstr1-report-template');
                gstr1ContentEl.innerHTML = template.innerHTML; // рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреЛ рд░рд┐рдЬрд▓реНрдЯ рдПрд░рд┐рдпрд╛ рдореЗрдВ рдХреЙрдкреА рдХрд░реЗрдВ

                // 2. B2B рдЯреЗрдмрд▓ рднрд░реЗрдВ
                const b2bTableBody = document.getElementById('gstr1-b2b-table').querySelector('tbody');
                const b2bTableFoot = document.getElementById('gstr1-b2b-table').querySelector('tfoot');
                let b2bTotalTaxable = 0, b2bTotalIgst = 0, b2bTotalCgst = 0, b2bTotalSgst = 0;
                b2bTableBody.innerHTML = ''; // рдкреБрд░рд╛рдиреА рдкрдВрдХреНрддрд┐рдпрд╛рдБ рд╕рд╛рдлрд╝ рдХрд░реЗрдВ
                
                if (report.b2b && report.b2b.length > 0) {
                    report.b2b.forEach(item => {
                        const taxable = parseFloat(item.total_taxable_value) || 0;
                        const igst = parseFloat(item.total_igst) || 0;
                        const cgst = parseFloat(item.total_cgst) || 0;
                        const sgst = parseFloat(item.total_sgst) || 0;
                        b2bTotalTaxable += taxable;
                        b2bTotalIgst += igst;
                        b2bTotalCgst += cgst;
                        b2bTotalSgst += sgst;
                        
                        b2bTableBody.innerHTML += `
                            <tr>
                                <td class="text-left">${item.customer_gstin}</td>
                                <td class="text-left">${item.customer_name || 'N/A'}</td>
                                <td class="text-center">${item.invoice_number}</td>
                                <td class="text-center">${new Date(item.invoice_date).toLocaleDateString()}</td>
                                <td>${formatCurrency(taxable)}</td>
                                <td>${formatCurrency(igst)}</td>
                                <td>${formatCurrency(cgst)}</td>
                                <td>${formatCurrency(sgst)}</td>
                            </tr>
                        `;
                    });
                } else {
                    b2bTableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">рдЗрд╕ рдЕрд╡рдзрд┐ рдореЗрдВ рдХреЛрдИ B2B (GSTIN рд╡рд╛рд▓реА) рдмрд┐рдХреНрд░реА рдирд╣реАрдВ рдорд┐рд▓реАред</td></tr>';
                }
                b2bTableFoot.innerHTML = `<tr><td colspan="4" class="text-left">B2B рдХреБрд▓</td><td>${formatCurrency(b2bTotalTaxable)}</td><td>${formatCurrency(b2bTotalIgst)}</td><td>${formatCurrency(b2bTotalCgst)}</td><td>${formatCurrency(b2bTotalSgst)}</td></tr>`;

                // 3. B2C рдЯреЗрдмрд▓ рднрд░реЗрдВ
                const b2cTableBody = document.getElementById('gstr1-b2c-table').querySelector('tbody');
                const b2cTableFoot = document.getElementById('gstr1-b2c-table').querySelector('tfoot');
                let b2cTotalTaxable = 0, b2cTotalIgst = 0, b2cTotalCgst = 0, b2cTotalSgst = 0, b2cTotalTax = 0;
                b2cTableBody.innerHTML = ''; // рдкреБрд░рд╛рдиреА рдкрдВрдХреНрддрд┐рдпрд╛рдБ рд╕рд╛рдлрд╝ рдХрд░реЗрдВ
                
                if (report.b2c && report.b2c.length > 0) {
                    report.b2c.forEach(item => {
                        const taxable = parseFloat(item.taxable_value) || 0;
                        const igst = parseFloat(item.total_igst) || 0;
                        const cgst = parseFloat(item.total_cgst) || 0;
                        const sgst = parseFloat(item.total_sgst) || 0;
                        const tax = parseFloat(item.total_tax) || 0;
                        b2cTotalTaxable += taxable;
                        b2cTotalIgst += igst;
                        b2cTotalCgst += cgst;
                        b2cTotalSgst += sgst;
                        b2cTotalTax += tax;

                        b2cTableBody.innerHTML += `
                            <tr>
                                <td class="text-left">${item.place_of_supply || 'N/A'}</td>
                                <td class="text-center">${item.gst_rate}%</td>
                                <td>${formatCurrency(taxable)}</td>
                                <td>${formatCurrency(igst)}</td>
                                <td>${formatCurrency(cgst)}</td>
                                <td>${formatCurrency(sgst)}</td>
                                <td>${formatCurrency(tax)}</td>
                            </tr>
                        `;
                    });
                } else {
                    b2cTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">рдЗрд╕ рдЕрд╡рдзрд┐ рдореЗрдВ рдХреЛрдИ B2C (рдЫреЛрдЯреА) рдмрд┐рдХреНрд░реА рдирд╣реАрдВ рдорд┐рд▓реАред</td></tr>';
                }
                b2cTableFoot.innerHTML = `<tr><td colspan="2" class="text-left">B2C рдХреБрд▓</td><td>${formatCurrency(b2cTotalTaxable)}</td><td>${formatCurrency(b2cTotalIgst)}</td><td>${formatCurrency(b2cTotalCgst)}</td><td>${formatCurrency(b2cTotalSgst)}</td><td>${formatCurrency(b2cTotalTax)}</td></tr>`;

                // 4. HSN рдЯреЗрдмрд▓ рднрд░реЗрдВ
                const hsnTableBody = document.getElementById('gstr1-hsn-table').querySelector('tbody');
                const hsnTableFoot = document.getElementById('gstr1-hsn-table').querySelector('tfoot'); // tfoot рднреА рдЬреЛрдбрд╝реЗрдВ
                let hsnTotalQty = 0, hsnTotalTaxable = 0, hsnTotalIgst = 0, hsnTotalCgst = 0, hsnTotalSgst = 0, hsnTotalTax = 0;
                hsnTableBody.innerHTML = ''; // рдкреБрд░рд╛рдиреА рдкрдВрдХреНрддрд┐рдпрд╛рдБ рд╕рд╛рдлрд╝ рдХрд░реЗрдВ
                
                if (report.hsn_summary && report.hsn_summary.length > 0) {
                    report.hsn_summary.forEach(item => {
                        const qty = parseFloat(item.total_quantity) || 0;
                        const taxable = parseFloat(item.total_taxable_value) || 0;
                        const igst = parseFloat(item.total_igst) || 0;
                        const cgst = parseFloat(item.total_cgst) || 0;
                        const sgst = parseFloat(item.total_sgst) || 0;
                        const tax = parseFloat(item.total_tax) || 0;
                        
                        hsnTotalQty += qty;
                        hsnTotalTaxable += taxable;
                        hsnTotalIgst += igst;
                        hsnTotalCgst += cgst;
                        hsnTotalSgst += sgst;
                        hsnTotalTax += tax;
                        
                        hsnTableBody.innerHTML += `
                            <tr>
                                <td class="text-center">${item.hsn_code || 'N/A'}</td>
                                <td class="text-left">${item.item_name}</td>
                                <td class="text-center">${item.unit || 'Pcs'}</td>
                                <td class="text-center">${qty}</td>
                                <td>${formatCurrency(taxable)}</td>
                                <td>${formatCurrency(igst)}</td>
                                <td>${formatCurrency(cgst)}</td>
                                <td>${formatCurrency(sgst)}</td>
                                <td>${formatCurrency(tax)}</td>
                            </tr>
                        `;
                    });
                } else {
                    hsnTableBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">рдЗрд╕ рдЕрд╡рдзрд┐ рдХреЗ рд▓рд┐рдП рдХреЛрдИ HSN рд╕рдорд░реА рдирд╣реАрдВ рдорд┐рд▓реАред</td></tr>';
                }
                // HSN Total Foot
                if (hsnTableFoot) {
                    hsnTableFoot.innerHTML = `<tr><td colspan="3" class="text-left">HSN рдХреБрд▓</td><td class="text-center">${hsnTotalQty}</td><td>${formatCurrency(hsnTotalTaxable)}</td><td>${formatCurrency(hsnTotalIgst)}</td><td>${formatCurrency(hsnTotalCgst)}</td><td>${formatCurrency(hsnTotalSgst)}</td><td>${formatCurrency(hsnTotalTax)}</td></tr>`;
                }


                // 5. Tabs рдХреЛ рдлрд┐рд░ рд╕реЗ рд╕рдХреНрд░рд┐рдп рдХрд░реЗрдВ (рдХреНрдпреЛрдВрдХрд┐ рд╣рдордиреЗ HTML рдХреЛ рдлрд┐рд░ рд╕реЗ рд▓рд┐рдЦрд╛ рд╣реИ)
                var triggerTabList = [].slice.call(document.querySelectorAll('#gstr1-inner-tab button'));
                triggerTabList.forEach(function (triggerEl) {
                    var tabTrigger = new bootstrap.Tab(triggerEl);
                    triggerEl.addEventListener('click', function (event) {
                        event.preventDefault();
                        tabTrigger.show();
                    });
                });
                // рдкрд╣рд▓реЗ рдЯреИрдм (B2B) рдХреЛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рджрд┐рдЦрд╛рдПрдВ
                new bootstrap.Tab(document.getElementById('gstr1-b2b-tab')).show();


            } catch (e) { 
                if(mainGstTitleEl) mainGstTitleEl.innerText = "GSTR-1 рд░рд┐рдкреЛрд░реНрдЯ";
                gstr1ContentEl.innerHTML = `<div class="text-danger p-4">рддреНрд░реБрдЯрд┐: ${e.message}</div>`;
            }
        });
        // --- TALLY UPDATE END: GSTR-1 Button Logic ---
        
        
        // --- TALLY UPDATE START: GSTR-2 Button Logic ---
        document.getElementById('fetch-gstr2-report-btn').addEventListener('click', async () => {
            const startDate = document.getElementById('gst-report-start-date').value;
            const endDate = document.getElementById('gst-report-end-date').value;
            if (!startDate || !endDate) return showMessage('рддреНрд░реБрдЯрд┐', 'рдХреГрдкрдпрд╛ рддрд╛рд░реАрдЦ рдЪреБрдиреЗрдВред', 'warning');
            
            const gstr2ContentEl = document.getElementById('gstr2-report-content');
            const mainGstTitleEl = document.getElementById('gst-report-title'); // рдкреБрд░рд╛рдирд╛ рдЯрд╛рдЗрдЯрд▓
            
            if(mainGstTitleEl) mainGstTitleEl.innerText = "GSTR-2 (рдЦрд░реАрдж) рд░рд┐рдкреЛрд░реНрдЯ (рд▓реЛрдб рд╣реЛ рд░рд╣реА рд╣реИ...)";
            gstr2ContentEl.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-warning" role="status"><span class="visually-hidden">Loading...</span></div></div>';

            // GSTR-2 рдЯреИрдм рдХреЛ рд╕рдХреНрд░рд┐рдп рдХрд░реЗрдВ
            new bootstrap.Tab(document.getElementById('gst-gstr2-tab')).show();

            try {
                const res = await fetchApi(`/api/reports/gstr2?startDate=${startDate}&endDate=${endDate}`, { method: 'GET' });
                if (!res.success) throw new Error(res.message || 'GSTR-2 рд░рд┐рдкреЛрд░реНрдЯ рд▓рд╛рдиреЗ рдореЗрдВ рд╡рд┐рдлрд▓ред');
                
                if(mainGstTitleEl) mainGstTitleEl.innerText = `GSTR-2 (рдЦрд░реАрдж) рд░рд┐рдкреЛрд░реНрдЯ (${startDate} рд╕реЗ ${endDate})`;
                const report = res.report;
                let tableHtml = '';

                // B2B Purchases Table
                tableHtml += '<h6>B2B (рдкрдВрдЬреАрдХреГрдд рд╕рдкреНрд▓рд╛рдпрд░ рд╕реЗ рдЦрд░реАрдж)</h6>';
                if (report.b2b_purchases && report.b2b_purchases.length > 0) {
                    tableHtml += '<table class="table gst-report-table"><thead><tr><th class="text-left">рд╕рдкреНрд▓рд╛рдпрд░</th><th>рдмрд┐рд▓ рдирдВ.</th><th>рддрд╛рд░реАрдЦ</th><th>рдЯреИрдХреНрд╕реЗрдмрд▓ рд╡реИрд▓реНрдпреВ (тВ╣)</th><th>IGST (тВ╣)</th><th>CGST (тВ╣)</th><th>SGST (тВ╣)</th></tr></thead><tbody>';
                    report.b2b_purchases.forEach(item => {
                        const details = item.gst_details || {}; // Get the JSONB data
                        tableHtml += `
                            <tr>
                                <td class="text-left">${item.supplier_name}</td>
                                <td class="text-center">${details.invoice_number || item.id}</td>
                                <td class="text-center">${new Date(item.created_at).toLocaleDateString()}</td>
                                <td>${formatCurrency(details.taxable_value)}</td>
                                <td>${formatCurrency(details.igst)}</td>
                                <td>${formatCurrency(details.cgst)}</td>
                                <td>${formatCurrency(details.sgst)}</td>
                            </tr>
                        `;
                    });
                    tableHtml += '</tbody></table>';
                } else {
                    tableHtml += '<p class="text-muted">рдЗрд╕ рдЕрд╡рдзрд┐ рдореЗрдВ рдХреЛрдИ GST рд╡рд╛рд▓реА рдЦрд░реАрдж рджрд░реНрдЬ рдирд╣реАрдВ рдХреА рдЧрдИред (рдХреГрдкрдпрд╛ \'рдЦрд░реАрдж\' рд╕реЗрдХреНрд╢рди рдореЗрдВ GST Details рдЬреЛрдбрд╝реЗрдВ)</p>';
                }

                // ITC Summary Table
                tableHtml += '<h6 class="mt-4">рдЗрдирдкреБрдЯ рдЯреИрдХреНрд╕ рдХреНрд░реЗрдбрд┐рдЯ (ITC) рд╕рдорд░реА</h6>';
                const itc = report.itc_summary || {};
                const totalTaxable = parseFloat(itc.total_taxable_value) || 0;
                const totalIgst = parseFloat(itc.total_igst) || 0;
                const totalCgst = parseFloat(itc.total_cgst) || 0;
                const totalSgst = parseFloat(itc.total_sgst) || 0;
                
                tableHtml += '<table class="table gst-report-table"><thead><tr><th class="text-left">рд╡рд┐рд╡рд░рдг</th><th>рдЯреИрдХреНрд╕реЗрдмрд▓ рд╡реИрд▓реНрдпреВ (тВ╣)</th><th>IGST (тВ╣)</th><th>CGST (тВ╣)</th><th>SGST (тВ╣)</th></tr></thead><tbody>';
                tableHtml += `
                    <tr class="subtotal-row">
                        <td class="text-left">рдХреБрд▓ рдЙрдкрд▓рдмреНрдз ITC</td>
                        <td>${formatCurrency(totalTaxable)}</td>
                        <td>${formatCurrency(totalIgst)}</td>
                        <td>${formatCurrency(totalCgst)}</td>
                        <td>${formatCurrency(totalSgst)}</td>
                    </tr>
                `;
                tableHtml += '</tbody></table>';
                
                gstr2ContentEl.innerHTML = tableHtml;

            } catch (e) {
                if(mainGstTitleEl) mainGstTitleEl.innerText = "GSTR-2 рд░рд┐рдкреЛрд░реНрдЯ";
                gstr2ContentEl.innerHTML = `<div class="text-danger p-4">рддреНрд░реБрдЯрд┐: ${e.message}</div>`;
            }
        });
        // --- TALLY UPDATE END: GSTR-2 Button Logic ---


        // --- TALLY UPDATE START: GSTR-3B Button Logic ---
        document.getElementById('fetch-gstr3b-report-btn').addEventListener('click', async () => {
            const startDate = document.getElementById('gst-report-start-date').value;
            const endDate = document.getElementById('gst-report-end-date').value;
            if (!startDate || !endDate) return showMessage('рддреНрд░реБрдЯрд┐', 'рдХреГрдкрдпрд╛ рддрд╛рд░реАрдЦ рдЪреБрдиреЗрдВред', 'warning');

            const gstr3bContentEl = document.getElementById('gstr3b-report-content');
            const mainGstTitleEl = document.getElementById('gst-report-title'); // рдкреБрд░рд╛рдирд╛ рдЯрд╛рдЗрдЯрд▓
            
            if(mainGstTitleEl) mainGstTitleEl.innerText = "GSTR-3B (рд╕рдорд░реА) рд░рд┐рдкреЛрд░реНрдЯ (рд▓реЛрдб рд╣реЛ рд░рд╣реА рд╣реИ...)";
            gstr3bContentEl.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

            // GSTR-3B рдЯреИрдм рдХреЛ рд╕рдХреНрд░рд┐рдп рдХрд░реЗрдВ
            new bootstrap.Tab(document.getElementById('gst-gstr3b-tab')).show();

            try {
                const res = await fetchApi(`/api/reports/gstr3b?startDate=${startDate}&endDate=${endDate}`, { method: 'GET' });
                if (!res.success) throw new Error(res.message || 'GSTR-3B рд░рд┐рдкреЛрд░реНрдЯ рд▓рд╛рдиреЗ рдореЗрдВ рд╡рд┐рдлрд▓ред');
                
                if(mainGstTitleEl) mainGstTitleEl.innerText = `GSTR-3B (рд╕рдорд░реА) рд░рд┐рдкреЛрд░реНрдЯ (${startDate} рд╕реЗ ${endDate})`;
                const report = res.report;
                let tableHtml = '';

                // Table 3.1: Outward Supplies (Sales)
                tableHtml += '<h6>3.1: рдмрд┐рдХреНрд░реА рдФрд░ рдЯреИрдХреНрд╕ (Outward Supplies)</h6>';
                tableHtml += '<table class="table gst-report-table"><thead><tr><th class="text-left">рд╡рд┐рд╡рд░рдг</th><th>рдЯреИрдХреНрд╕реЗрдмрд▓ рд╡реИрд▓реНрдпреВ (тВ╣)</th><th>IGST (тВ╣)</th><th>CGST (тВ╣)</th><th>SGST (тВ╣)</th></tr></thead><tbody>';
                tableHtml += `
                    <tr class="subtotal-row">
                        <td class="text-left">(a) рдЯреИрдХреНрд╕реЗрдмрд▓ рдмрд┐рдХреНрд░реА</td>
                        <td>${formatCurrency(report.outward_supplies.taxable_value)}</td>
                        <td>${formatCurrency(report.outward_supplies.igst)}</td>
                        <td>${formatCurrency(report.outward_supplies.cgst)}</td>
                        <td>${formatCurrency(report.outward_supplies.sgst)}</td>
                    </tr>
                `;
                tableHtml += '</tbody></table>';

                // Table 4: Eligible ITC (Purchases)
                tableHtml += '<h6 class="mt-4">4: рдпреЛрдЧреНрдп рдЗрдирдкреБрдЯ рдЯреИрдХреНрд╕ рдХреНрд░реЗрдбрд┐рдЯ (ITC)</h6>';
                tableHtml += '<table class="table gst-report-table"><thead><tr><th class="text-left">рд╡рд┐рд╡рд░рдг</th><th>IGST (тВ╣)</th><th>CGST (тВ╣)</th><th>SGST (тВ╣)</th></tr></thead><tbody>';
                tableHtml += `
                    <tr>
                        <td class="text-left">(A) (5) рд╕рднреА рдЕрдиреНрдп ITC (B2B рдЦрд░реАрдж)</td>
                        <td>${formatCurrency(report.inward_supplies_itc.igst)}</td>
                        <td>${formatCurrency(report.inward_supplies_itc.cgst)}</td>
                        <td>${formatCurrency(report.inward_supplies_itc.sgst)}</td>
                    </tr>
                    <tr class="subtotal-row">
                        <td class="text-left">(D) рдХреБрд▓ рдЙрдкрд▓рдмреНрдз ITC (A)</td>
                        <td>${formatCurrency(report.inward_supplies_itc.igst)}</td>
                        <td>${formatCurrency(report.inward_supplies_itc.cgst)}</td>
                        <td>${formatCurrency(report.inward_supplies_itc.sgst)}</td>
                    </tr>
                `;
                tableHtml += '</tbody></table>';

                // Table 6.1: Payment of Tax (Net Tax)
                tableHtml += '<h6 class="mt-4">6.1: рдЯреИрдХреНрд╕ рднреБрдЧрддрд╛рди (Net Tax Payable)</h6>';
                tableHtml += '<table class="table gst-report-table"><thead><tr><th class="text-left">рд╡рд┐рд╡рд░рдг</th><th>IGST (тВ╣)</th><th>CGST (тВ╣)</th><th>SGST (тВ╣)</th><th>рдХреБрд▓ рджреЗрдп рдЯреИрдХреНрд╕ (тВ╣)</th></tr></thead><tbody>';
                tableHtml += `
                    <tr class="subtotal-row">
                        <td class="text-left">рдХреБрд▓ рджреЗрдп рдЯреИрдХреНрд╕ (рдмрд┐рдХреНрд░реА - рдЦрд░реАрдж)</td>
                        <td>${formatCurrency(report.net_tax_payable.igst)}</td>
                        <td>${formatCurrency(report.net_tax_payable.cgst)}</td>
                        <td>${formatCurrency(report.net_tax_payable.sgst)}</td>
                        <td>${formatCurrency(report.net_tax_payable.total)}</td>
                    </tr>
                `;
                tableHtml += '</tbody></table>';

                gstr3bContentEl.innerHTML = tableHtml;

            } catch (e) {
                if(mainGstTitleEl) mainGstTitleEl.innerText = "GSTR-3B рд░рд┐рдкреЛрд░реНрдЯ";
                gstr3bContentEl.innerHTML = `<div class="text-danger p-4">рддреНрд░реБрдЯрд┐: ${e.message}</div>`;
            }
        });
        // --- TALLY UPDATE END: GSTR-3B Button Logic ---

        
        // Daily Closing Button
        document.getElementById('run-daily-closing-btn').addEventListener('click', async () => {
            if (!confirm('рдХреНрдпрд╛ рдЖрдк рд╡рд╛рдХрдИ рдЖрдЬ рдХреА рдХреНрд▓реЛрдЬрд┐рдВрдЧ рд░рди рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╣ рдХреНрд░рд┐рдпрд╛ рдПрдХ рдмрд╛рд░ рд╣реА рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИред')) return;
            const msgEl = document.getElementById('closing-message');
            msgEl.className = 'mt-3 alert alert-info';
            msgEl.innerText = 'рдХреНрд▓реЛрдЬрд┐рдВрдЧ рд░рди рдХреА рдЬрд╛ рд░рд╣реА рд╣реИ...';
            try {
                const res = await fetchApi('/api/closing/run', { method: 'POST' });
                if (res.success) {
                    msgEl.className = 'mt-3 alert alert-success';
                    msgEl.innerText = res.message;
                    fetchAndRenderClosingReports(); // Refresh the list
                } else {
                    throw new Error(res.message);
                }
            } catch (e) {
                msgEl.className = 'mt-3 alert alert-danger';
                msgEl.innerText = `рддреНрд░реБрдЯрд┐: ${e.message}`;
            }
        });
        
        // Backup Buttons
        document.getElementById('download-json-backup-btn').addEventListener('click', () => handleBackupDownloads('json'));
        document.getElementById('download-excel-backup-btn').addEventListener('click', () => handleBackupDownloads('excel'));
        document.getElementById('download-product-sales-csv-btn').addEventListener('click', () => handleBackupDownloads('csv'));
        // [ тЬЕ Is Naye Code ko Line 2915 par Paste Karein ]



// Naya "Manual Entry" Button Listener (Point 3 & 5)
document.getElementById('manual-add-item-btn').addEventListener('click', async () => {
    try {
        // 1. Server se agla available SKU laayein (Kadam 1 ka API)
        showLoader('рдЕрдЧрд▓рд╛ SKU рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...');
        const res = await fetchApi('/api/stock/next-sku', { method: 'GET' }, null);
        hideLoader();

        if (!res.success) {
            throw new Error(res.message || 'Server se SKU nahi mila');
        }

        // 2. Naya Modal (Kadam 2 waala) kholein
        const modalElement = document.getElementById('quickAddItemModal');
        const quickAddModal = new bootstrap.Modal(modalElement);

        // 3. Modal ke form ko reset karein
        document.getElementById('quick-add-item-form').reset();

        // 4. SKU ko automatic bhar dein
        document.getElementById('quick-add-sku').value = res.nextSku;

        // 5. Modal dikhayein
        quickAddModal.show();

        // 6. Focus "Item Name" par karein
        modalElement.addEventListener('shown.bs.modal', () => {
            document.getElementById('quick-add-name').focus();
        }, { once: true });

    } catch (e) {
        hideLoader();
        showMessage('рддреНрд░реБрдЯрд┐', `рдЕрдЧрд▓рд╛ SKU рд▓рд╛рдиреЗ рдореЗрдВ рд╡рд┐рдлрд▓: ${e.message}`, 'danger');
    }
});
        
// [ тЬЕ Is Naye Code ko pichhle code ke baad (Line ~2945) Paste Karein ]

// Naya "Quick Add Modal" Save Button Listener (Point 4)
document.getElementById('quick-add-save-btn').addEventListener('click', async () => {
    const btn = document.getElementById('quick-add-save-btn');
    const originalBtnText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> рд╕реЗрд╡ рд╣реЛ рд░рд╣рд╛ рд╣реИ...`;

    // 1. Modal se data nikalein
    const itemData = {
        sku: document.getElementById('quick-add-sku').value,
        name: document.getElementById('quick-add-name').value,
        sale_price: document.getElementById('quick-add-sale-price').value,
        purchase_price: document.getElementById('quick-add-purchase-price').value,
        quantity: 1, // Quick Add hamesha 1 quantity add karta hai
        unit: 'Pcs'  // Default unit
    };


    // 2. Jaanch karein ki data bhara hai ya nahi
    if (!itemData.sku || !itemData.name || !itemData.sale_price || !itemData.purchase_price) {
        showMessage('рддреНрд░реБрдЯрд┐', 'рдХреГрдкрдпрд╛ рд╕рднреА рдлрд╝реАрд▓реНрдб (SKU, рдирд╛рдо, рдмрд┐рдХреНрд░реА рдореВрд▓реНрдп, рдЦрд░реАрдж рдореВрд▓реНрдп) рднрд░реЗрдВред', 'danger');
        btn.disabled = false;
        btn.innerHTML = originalBtnText;
        return;
    }

    try {
        // 3. "Stock Prabandhan" mein item save karein (Server API Call)
        // Yeh wahi API hai jo aapka 'Stock Management' page istemaal karta hai
        console.log('FINAL ITEM DATA SENT TO SERVER:', itemData);
        console.log('SENDING TO SERVER тЖТ', JSON.stringify(itemData, null, 2));
        console.log('ЁЯЪА FINAL PAYLOAD TO SERVER ЁЯСЙ', JSON.stringify(itemData, null, 2));
        const res = await fetchApi('/api/stock', {
            method: 'POST',
            body: itemData
        }, 'рдирдпрд╛ рдЖрдЗрдЯрдо рд╕реЗрд╡ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ...');

        if (!res.success) {
            // Agar server ne error diya (jaise SKU pehle se hai)
            throw new Error(res.message);
        }

        // 4. "Bikri (POS) Cart" mein item add karein
        // Hum server se mile data ka istemaal karenge
        const newItemForCart = {
    sku: res.stock.sku,
    name: res.stock.name,
    sale_price: parseFloat(res.stock.sale_price),
    purchase_price: parseFloat(res.stock.purchase_price || 0),
    gst: parseFloat(res.stock.gst || 0),
    quantity: 1,

    // ЁЯФР MUST ADD
    product_attributes: res.stock.product_attributes || {}
};



        // 'currentStock' list ko bhi update karein (taaki quantity check kaam kare)
        currentStock.push(res.stock);

        // 'posCart' array mein add karein
        posCart.push(newItemForCart);
        updatePOSCartView(); // POS Cart table ko refresh karein

        // 5. Modal band karein
        const quickAddModal = bootstrap.Modal.getInstance(document.getElementById('quickAddItemModal'));
        quickAddModal.hide();

        showMessage('рд╕рдлрд▓рддрд╛', `${itemData.name} рдХреЛ рд╕реНрдЯреЙрдХ рдореЗрдВ рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛ рдФрд░ рдХрд╛рд░реНрдЯ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рдХрд┐рдпрд╛ рдЧрдпрд╛ред`, 'success');

    } catch (e) {
        showMessage('рддреНрд░реБрдЯрд┐', `рдЖрдЗрдЯрдо рд╕реЗрд╡ рдХрд░рдиреЗ рдореЗрдВ рд╡рд┐рдлрд▓: ${e.message}`, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalBtnText;
    }
});


        // Shop Settings Forms
        document.getElementById('company-profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                legal_name: document.getElementById('company-legal-name').value,
                gstin: document.getElementById('company-gstin').value,
                address: document.getElementById('company-address').value,
                // ЁЯЪА FIX: рдкреВрдВрдЬреА рдбреЗрдЯрд╛ рдпрд╣рд╛рдБ рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛
                opening_capital: document.getElementById('company-opening-capital').value 
            };
            try {
                const res = await fetchApi('/api/shop/company-profile', { method: 'POST', body: data });
                showMessage('рд╕рдлрд▓рддрд╛', res.message, 'success');
            } catch (err) { showMessage('рддреНрд░реБрдЯрд┐', err.message, 'danger'); }
        });
        
        let shopLogoBase64 = null; // Store logo data
        document.getElementById('shop-logo-upload').addEventListener('change', (e) => {
             const file = e.target.files[0];
             if (!file) return;
             const reader = new FileReader();
             reader.onload = (event) => {
                 shopLogoBase64 = event.target.result;
                 document.getElementById('shop-logo-preview').src = shopLogoBase64;
                 document.getElementById('shop-logo-preview').style.display = 'block';
                 document.getElementById('remove-shop-logo-btn').classList.remove('d-none');
             };
             reader.readAsDataURL(file);
        });
        
       // ... (рдмрд╛рдХреА рдХреЛрдб)
  // ... (рд▓рд╛рдЗрди 2244 рдХреЗ рдЖрд╕рдкрд╛рд╕)

  document.getElementById('shop-display-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            shop_name: document.getElementById('shop-display-name').value,
            shop_logo: shopLogoBase64 || AppState.user.shopLogo // Send new logo or old one
        };
        try {
            const res = await fetchApi('/api/shop/settings', { method: 'POST', body: data });
            if (res.success) {
                // CRITICAL: Update token and user data with new shop name/logo
                saveAuthData(res.token, res.user);
                
                // ЁЯЪА FIX: рдЗрдореЗрдЬ рдХреЛ Local Storage рдореЗрдВ рднреА рд╕реЗрд╡ рдХрд░реЗрдВ (рд╕рдлрд▓рддрд╛ рдкрд░)
                if (res.user.shopLogo) {
                    localStorage.setItem('shopLogoData', res.user.shopLogo);
                } else {
                    localStorage.removeItem('shopLogoData');
                }
                
                showMessage('рд╕рдлрд▓рддрд╛', res.message, 'success');
            } else {
                // ЁЯЪА FIX: рдпрджрд┐ рд╕рд░реНрд╡рд░ 500 рдПрд░рд░ рджреЗ, рддреЛ рднреА рд▓реЛрдХрд▓ рд╕реНрдЯреЛрд░реЗрдЬ рдореЗрдВ рд╕реЗрд╡ рдХрд░реЗрдВ (FallBack)
                if (shopLogoBase64) {
                     localStorage.setItem('shopLogoData', shopLogoBase64);
                     // Note: We don't call saveAuthData because the server update failed
                     showMessage('рдЪреЗрддрд╛рд╡рдиреА', 'рд╕рд░реНрд╡рд░ рдЯрд╛рдЗрдордЖрдЙрдЯ рд╣реБрдЖред рд▓реЛрдЧреЛ рд▓реЛрдХрд▓ (Local) рдореЗрдВ рд╕реЗрд╡ рд╣реЛ рдЧрдпрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЕрдиреНрдп рдпреВрдЬрд╝рд░реНрд╕ рдХреЛ рджреЗрдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдпрд╣ рдЕрднреА рднреА рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рд╕реЗрд╡ рд╣реЛ рд░рд╣рд╛ рд╣реИред', 'warning');
                } else {
                    throw new Error(res.message);
                }
            }
        } catch (err) { 
             // рдпрджрд┐ Fetch API рд╣реА рд╡рд┐рдлрд▓ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ
             showMessage('рддреНрд░реБрдЯрд┐', err.message, 'danger');
        }
    });

// ... (рдмрд╛рдХреА рдХреЛрдб)

// Staff Form Listeners
const addStaffForm = document.getElementById('add-staff-form');
        if (addStaffForm && !addStaffForm.dataset.initialized) {
            addStaffForm.dataset.initialized = 'true';
            addStaffForm.addEventListener('submit', handleAddStaff);
        }
        const editStaffForm = document.getElementById('edit-staff-form');
         if (editStaffForm && !editStaffForm.dataset.initialized) {
            editStaffForm.dataset.initialized = 'true';
            editStaffForm.addEventListener('submit', handleUpdateStaff);
        }

    }

// [ тЬЕ Is Naye Listener ko Line 2912 par (function ke andar) Paste Karein ]

// [ тЬЕ NAYA "Naya Field Jodein" рдмрдЯрди рдХрд╛ рд▓реЙрдЬрд┐рдХ (Optical рдлреЙрд░реНрдо рджрд┐рдЦрд╛рдиреЗ рдХреЗ рд▓рд┐рдП) ]

document.getElementById('add-custom-field-btn').addEventListener('click', () => {
    // 1. рдЫрд┐рдкреЗ рд╣реБрдП рдЪрд╢реНрдореЗ рд╡рд╛рд▓реЗ рдлреЙрд░реНрдо рдХреЛ рджрд┐рдЦрд╛рдПрдБ
    const container = document.getElementById('prescription-fields-container');
    container.style.display = 'block';
    
    // 2. "+ Naya Field Jodein" рдмрдЯрди рдХреЛ рдЫрд┐рдкрд╛ рджреЗрдВ (рддрд╛рдХрд┐ рджреЛрдмрд╛рд░рд╛ рдХреНрд▓рд┐рдХ рди рд╣реЛ)
    document.getElementById('add-custom-field-btn').style.display = 'none';
});

// removeCustomField рдлрд╝рдВрдХреНрд╢рди рдХреА рдЕрдм рдЬрд╝рд░реВрд░рдд рдирд╣реАрдВ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЙрд╕реЗ рд╣рдЯрд╛ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред


 // ============================================================
    // ЁЯЪА 2. FIX: рд▓рд╛рд▓ рд╕реНрдХреНрд░реАрди (Paint Modal) рд╡рд╛рд▓рд╛ рдХреЛрдб - рдЕрдм рдпрд╣ рдмрд╛рд╣рд░ рд╣реИ
    // ============================================================
    const paintModalElement = document.getElementById('paintMixingModal');
    if (paintModalElement) {
        // рдпрд╣ рд▓рд┐рд╕реНрдирд░ рдЕрдм рдкреЗрдЬ рд▓реЛрдб рд╣реЛрддреЗ рд╣реА рд╕реЗрдЯ рд╣реЛ рдЬрд╛рдПрдЧрд╛
        paintModalElement.addEventListener('hidden.bs.modal', function () {
            console.log("Paint Modal Closed. Resetting Mixing Mode.");
            
            // тЬЕ рдлреНрд▓реИрдЧ рд░рд┐рд╕реЗрдЯ рдХрд░реЗрдВ
            if (typeof isMixingModeActive !== 'undefined') {
                isMixingModeActive = false; 
            }
            
            // тЬЕ рдлреЙрд░реНрдо рд╕рд╛рдлрд╝ рдХрд░реЗрдВ
            if(document.getElementById('mix-base-sku')) document.getElementById('mix-base-sku').value = '';
            if(document.getElementById('mix-base-name')) document.getElementById('mix-base-name').value = '';
            if(document.getElementById('mix-base-price')) document.getElementById('mix-base-price').value = '';
            if(document.getElementById('mix-code')) document.getElementById('mix-code').value = '';
            if(document.getElementById('mix-color-cost')) document.getElementById('mix-color-cost').value = '';
            if(document.getElementById('mix-final-price')) document.getElementById('mix-final-price').innerText = 'тВ╣0';
            if(document.getElementById('mix-stock-status')) document.getElementById('mix-stock-status').innerText = '';
        });
    }




// ==============================================
// ЁЯЪА рдмреИрдВрдХ рд░рд┐рдХреЙрдиреНрд╕рд┐рд▓реЗрд╢рди рд▓реЙрдЬрд┐рдХ рдлрд╝рдВрдХреНрд╢рдВрд╕
// ==============================================

/**
 * рдЪрд░рдг 1: рдмреИрдВрдХ рд╕реНрдЯреЗрдЯрдореЗрдВрдЯ CSV рдХреЛ рдЕрдкрд▓реЛрдб рдФрд░ рдкрд╛рд░реНрд╕ рдХрд░рддрд╛ рд╣реИ
 */
/**
 * рдЪрд░рдг 1: рдмреИрдВрдХ рд╕реНрдЯреЗрдЯрдореЗрдВрдЯ CSV рдХреЛ рдЕрдкрд▓реЛрдб рдФрд░ рдкрд╛рд░реНрд╕ рдХрд░рддрд╛ рд╣реИ
 */
 async function handleStatementUpload(event) {
    event.preventDefault();
    const btn = document.getElementById('start-reconciliation-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> рдЕрдкрд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...';

    // 1. рдлреЙрд░реНрдо рдбреЗрдЯрд╛ рдЗрдХрдЯреНрдард╛ рдХрд░реЗрдВ
    const statementFile = document.getElementById('recon-statement-csv').files[0];
    const statementDate = document.getElementById('recon-statement-date').value;
    const statementBalance = parseFloat(document.getElementById('recon-statement-balance').value);

    if (!statementFile) {
        showMessage('рддреНрд░реБрдЯрд┐', 'рдХреГрдкрдпрд╛ рдПрдХ CSV рдлрд╝рд╛рдЗрд▓ рдЪреБрдиреЗрдВред', 'danger');
        btn.disabled = false; btn.innerHTML = '<i class="fas fa-play me-2"></i> рд░рд┐рдХреЙрдиреНрд╕рд┐рд▓реЗрд╢рди рд╢реБрд░реВ рдХрд░реЗрдВ';
        return;
    }

    try {
        // 2. CSV рдлрд╝рд╛рдЗрд▓ рдХреЛ рдЯреЗрдХреНрд╕реНрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдкрдврд╝реЗрдВ
        const csvText = await statementFile.text();
        
        // 3. рдЯреЗрдХреНрд╕реНрдЯ рдХреЛ JSON рдореЗрдВ рдкрд╛рд░реНрд╕ рдХрд░реЗрдВ
        const statementItems = parseCSV(csvText);

        if (!statementItems || statementItems.length === 0) {
            throw new Error('CSV рдЦрд╛рд▓реА рд╣реИ рдпрд╛ рдкрд╛рд░реНрд╕ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрд╛ред');
        }

        // 4. рдбреЗрдЯрд╛ рдХреЛ рдирдП API рдПрдВрдбрдкреЙрдЗрдВрдЯ рдкрд░ рднреЗрдЬреЗрдВ
        const res = await fetchApi('/api/reconciliation/upload-statement', {
            method: 'POST',
            body: {
                statementDate,
                statementBalance,
                statementItems
            }
        }, 'рдЯреНрд░рд╛рдВрдЬреИрдХреНрд╢рди рдХрд╛ рдорд┐рд▓рд╛рди рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ...');

        if (res.success) {
            // 5. UI рдХреЛ "рдореИрдЪрд┐рдВрдЧ" рдореЛрдб рдореЗрдВ рдмрджрд▓реЗрдВ
            document.getElementById('reconciliation-setup').classList.add('hidden');
            document.getElementById('reconciliation-matching-area').classList.remove('hidden');
            
            // 6. рдореИрдЪрд┐рдВрдЧ рдЯреЗрдмрд▓ рд░реЗрдВрдбрд░ рдХрд░реЗрдВ
            renderReconciliationTables(res.bookItems, res.bankItems, statementBalance);
            showMessage('рд╕рдлрд▓рддрд╛', 'рд╕реНрдЯреЗрдЯрдореЗрдВрдЯ рдЕрдкрд▓реЛрдб рд╣реБрдЖред рдЕрдм рдПрдВрдЯреНрд░реАрдЬрд╝ рдХрд╛ рдорд┐рд▓рд╛рди рдХрд░реЗрдВред', 'success');
        } else {
            throw new Error(res.message);
        }

    } catch (e) {
        showMessage('рддреНрд░реБрдЯрд┐', `рдЕрдкрд▓реЛрдб рд╡рд┐рдлрд▓: ${e.message}`, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-play me-2"></i> рд░рд┐рдХреЙрдиреНрд╕рд┐рд▓реЗрд╢рди рд╢реБрд░реВ рдХрд░реЗрдВ';
    }
}


 /**
 * рдЪрд░рдг 2: рдмреБрдХ рдФрд░ рдмреИрдВрдХ рдЯреНрд░рд╛рдВрдЬреИрдХреНрд╢рди рдХреЛ рд▓рд╛рддрд╛ рд╣реИ рдФрд░ рдЯреЗрдмрд▓ рдореЗрдВ рджрд┐рдЦрд╛рддрд╛ рд╣реИ
 * (рдЗрд╡реЗрдВрдЯ рд▓рд┐рд╕реНрдирд░ рдХреЗ рд╕рд╛рде рдлрд┐рдХреНрд╕реНрдб)
 */
function renderReconciliationTables(bookItems, bankItems, statementBalance) {
    const bookBody = document.getElementById('book-transactions-body');  
    const bankBody = document.getElementById('bank-transactions-body'); 
    bookBody.innerHTML = '';
    bankBody.innerHTML = '';

    let bookTotal = 0;
    let bankTotal = 0;

    // Dukan Pro (рдмреБрдХ) рдЖрдЗрдЯрдореНрд╕ рдХреЛ рднрд░реЗрдВ
    bookItems.forEach(item => {
        bookTotal += parseFloat(item.amount);
        bookBody.innerHTML += `
            <tr data-id="${item.type}-${item.id}" data-amount="${item.amount}">
                <td><input type="checkbox" class="recon-check-book"></td>
                <td>
                    ${item.description}
                    <small class="d-block text-muted">${new Date(item.date).toLocaleDateString()}</small>
                </td>
                <td>${formatCurrency(item.amount)}</td>
            </tr>
        `;
    });

    // рдмреИрдВрдХ рд╕реНрдЯреЗрдЯрдореЗрдВрдЯ рдЖрдЗрдЯрдореНрд╕ рдХреЛ рднрд░реЗрдВ
    bankItems.forEach(item => {
        bankTotal += parseFloat(item.amount);
        bankBody.innerHTML += `
            <tr data-id="${item.id}" data-amount="${item.amount}">
                <td><input type="checkbox" class="recon-check-bank"></td>
                <td>
                    ${item.description}
                    <small class="d-block text-muted">${new Date(item.date).toLocaleDateString()}</small>
                </td>
                <td>${formatCurrency(item.amount)}</td>
            </tr>
        `;
    });

    // рдЯреЛрдЯрд▓реНрд╕ рджрд┐рдЦрд╛рдПрдБ
    document.getElementById('book-total').innerText = formatCurrency(bookTotal);  
    document.getElementById('bank-total').innerText = formatCurrency(bankTotal);  
    
    // рд░рд┐рдкреЛрд░реНрдЯ рдореЗрдВ рд╕реНрдЯреЗрдЯрдореЗрдВрдЯ рдмреИрд▓реЗрдВрд╕ рд╕реЗрдЯ рдХрд░реЗрдВ
    document.getElementById('report-statement-balance').innerText = formatCurrency(statementBalance);  
    
    // ЁЯЪАЁЯЪАЁЯЪА рдпрд╣ рдирдпрд╛ рдХреЛрдб рд╣реИ (рдлрд╝рдВрдХреНрд╢рди рдХреЗ рдЕрдВрджрд░) ЁЯЪАЁЯЪАЁЯЪА
    // рд╕рднреА рдЪреЗрдХрдмреЙрдХреНрд╕ рдореЗрдВ 'change' рдЗрд╡реЗрдВрдЯ рд▓рд┐рд╕реНрдирд░ рдЬреЛрдбрд╝реЗрдВ
    const allCheckboxes = document.querySelectorAll('.recon-check-book, .recon-check-bank, #check-all-book, #check-all-bank'); 
    allCheckboxes.forEach(cb => {
        cb.addEventListener('change', () => {
            // 'Select All' рд▓реЙрдЬрд┐рдХ
            if (cb.id === 'check-all-book') {  
                document.querySelectorAll('.recon-check-book').forEach(bookCb => bookCb.checked = cb.checked);  
            }
            if (cb.id === 'check-all-bank') {  
                document.querySelectorAll('.recon-check-bank').forEach(bankCb => bankCb.checked = cb.checked);  
            }
            
            // рдореБрдЦреНрдп рдЧрдгрдирд╛ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд░реЗрдВ
            calculateReconciliation();
        });
    });
    
    // рдкрд╣рд▓реА рдмрд╛рд░ рдЧрдгрдирд╛ (Calculate) рдЪрд▓рд╛рдПрдБ
    calculateReconciliation();
    // ЁЯЪАЁЯЪАЁЯЪА рдирдпрд╛ рдХреЛрдб рд╕рдорд╛рдкреНрдд ЁЯЪАЁЯЪАЁЯЪА
}
/**
 * рдЪрд░рдг 3: рдорд┐рд▓рд╛рди рдХреА рдЧрдИ рдПрдВрдЯреНрд░реАрдЬрд╝ рдФрд░ рд░рд┐рдкреЛрд░реНрдЯ рдХреЛ рд╕реЗрд╡ рдХрд░рддрд╛ рд╣реИ
 */
/**
 * рдЪрд░рдг 3: рдорд┐рд▓рд╛рди рдХреА рдЧрдИ рдПрдВрдЯреНрд░реАрдЬрд╝ рдФрд░ рд░рд┐рдкреЛрд░реНрдЯ рдХреЛ рд╕реЗрд╡ рдХрд░рддрд╛ рд╣реИ
 */
 async function saveReconciliationReport() {
    const btn = document.getElementById('save-reconciliation-btn');  
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> рд╕реЗрд╡ рд╣реЛ рд░рд╣рд╛ рд╣реИ...';

    try {
        // 1. рдЪреЗрдХреНрдб (matched) рдмреИрдВрдХ IDs рдЗрдХрдЯреНрдард╛ рдХрд░реЗрдВ
        const reconciledBankIds = [];
        document.querySelectorAll('.recon-check-bank:checked').forEach(cb => {  
            reconciledBankIds.push(cb.closest('tr').dataset.id);
        });

        // 2. рдЪреЗрдХреНрдб (matched) рдмреБрдХ Items рдЗрдХрдЯреНрдард╛ рдХрд░реЗрдВ
        const reconciledBookItems = [];
        document.querySelectorAll('.recon-check-book:checked').forEach(cb => {  
            const idParts = cb.closest('tr').dataset.id.split('-'); // рдЬреИрд╕реЗ "invoice-123"
            reconciledBookItems.push({
                type: idParts[0],
                id: parseInt(idParts[1])
            });
        });
        
        // 3. рд░рд┐рдкреЛрд░реНрдЯ рдХрд╛ рд╕рд╛рд░рд╛рдВрд╢ (Summary) рдЗрдХрдЯреНрдард╛ рдХрд░реЗрдВ 
        const unclearedPaymentsAmount = parseFloat(document.getElementById('report-uncleared-payments').innerText.replace(/[^0-9.-]/g, '')); 
        const unclearedDepositsAmount = parseFloat(document.getElementById('report-uncleared-deposits').innerText.replace(/[^0-9.-]/g, '')); 
        
        const reportData = {
             clearedPayments: 0, // (рдпрд╣ рдЕрднреА рдЯреНрд░реИрдХ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, 0 рднреЗрдЬреЗрдВ)
             clearedDeposits: 0, // (рдпрд╣ рдЕрднреА рдЯреНрд░реИрдХ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, 0 рднреЗрдЬреЗрдВ)
             unclearedCount: document.querySelectorAll('.recon-check-book:not(:checked)').length,  
             unclearedTotal: unclearedPaymentsAmount + unclearedDepositsAmount
        };

        // 4. рдореБрдЦреНрдп рдбреЗрдЯрд╛ рдЗрдХрдЯреНрдард╛ рдХрд░реЗрдВ
        const dataToSend = {
            statementEndDate: document.getElementById('recon-statement-date').value,  
            statementEndBalance: parseFloat(document.getElementById('report-statement-balance').innerText.replace(/[^0-9.-]/g, '')),  
            reportSummary: reportData,
            reconciledBankIds: reconciledBankIds,
            reconciledBookItems: reconciledBookItems
        };

        // 5. рд╕рд░реНрд╡рд░ рдкрд░ рднреЗрдЬреЗрдВ
        const res = await fetchApi('/api/reconciliation/save', {
            method: 'POST',
            body: dataToSend
        }, 'рд░рд┐рдкреЛрд░реНрдЯ рд╕реЗрд╡ рдХреА рдЬрд╛ рд░рд╣реА рд╣реИ...');

        if (res.success) {
            showMessage('рд╕рдлрд▓рддрд╛', 'рд░рд┐рдХреЙрдиреНрд╕рд┐рд▓реЗрд╢рди рд░рд┐рдкреЛрд░реНрдЯ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рд╕реЗрд╡ рдХреА рдЧрдИ!', 'success');
            renderView('bank-reconciliation'); // рд╕рдм рдХреБрдЫ рд░реАрд╕реЗрдЯ рдХрд░реЗрдВ
        } else {
            throw new Error(res.message);
        }

    } catch (e) {
        showMessage('рддреНрд░реБрдЯрд┐', `рд░рд┐рдкреЛрд░реНрдЯ рд╕реЗрд╡ рдХрд░рдиреЗ рдореЗрдВ рд╡рд┐рдлрд▓: ${e.message}`, 'danger');
        btn.disabled = false; // рдмрдЯрди рдХреЛ рдлрд┐рд░ рд╕реЗ рдЗрдиреЗрдмрд▓ рдХрд░реЗрдВ
        btn.innerHTML = '<i class="fas fa-save me-2"></i> рд░рд┐рдкреЛрд░реНрдЯ рд╕реЗрд╡ рдХрд░реЗрдВ';
    }
}


    /**
 * рдЪрд░рдг 4: рдкрд┐рдЫрд▓реА рд╕реЗрд╡ рдХреА рдЧрдИ рд░рд┐рдкреЛрд░реНрдЯреНрд╕ рдХреЛ рд▓рд╛рддрд╛ рд╣реИ рдФрд░ рдЯреЗрдмрд▓ рдореЗрдВ рджрд┐рдЦрд╛рддрд╛ рд╣реИ
 */
async function fetchAndRenderSavedReports() {
    const tableBody = document.getElementById('previous-reports-body');
    tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">рд░рд┐рдкреЛрд░реНрдЯреНрд╕ рд▓реЛрдб рд╣реЛ рд░рд╣реА рд╣реИрдВ...</td></tr>`;

    try {
        const res = await fetchApi('/api/reconciliation/reports', { method: 'GET' }, null); // рд▓реЛрдбрд░ рдирд╣реАрдВ рджрд┐рдЦрд╛рдПрдБ

        if (res.success && res.reports.length > 0) {
            tableBody.innerHTML = res.reports.map(report => `
                <tr>
                    <td>REP-${report.id}</td>
                    <td>${new Date(report.statement_end_date).toLocaleDateString()}</td>
                    <td>${formatCurrency(report.statement_end_balance)}</td>
                    <td class="${parseFloat(report.uncleared_items_total) !== 0 ? 'text-danger' : ''}">
                        ${formatCurrency(report.uncleared_items_total)}
                    </td>
                    <td>${new Date(report.reconciled_at).toLocaleString()}</td>
                </tr>
            `).join('');
        } else {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">рдХреЛрдИ рдкреБрд░рд╛рдиреА рд░рд┐рдкреЛрд░реНрдЯ рдирд╣реАрдВ рдорд┐рд▓реАред</td></tr>`;
        }
    } catch (e) {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">рддреНрд░реБрдЯрд┐: ${e.message}</td></tr>`;
    }
}
    /**
     * Main startup logic
     */
    // ==========================================================
// ========== 1. LICENSE CHECK & APP LOCK LOGIC ==========
// ==========================================================

/**
 * Main startup logic - MODIFIED
 */
// [ рдпрд╣ рд░рд╣рд╛ рдирдпрд╛ рдФрд░ рд╕рд╣реА DOMContentLoaded - рдкреБрд░рд╛рдиреЗ рд╡рд╛рд▓реЗ рдХреЛ рд╣рдЯрд╛рдХрд░ рдЗрд╕реЗ рдкреЗрд╕реНрдЯ рдХрд░реЗрдВ ]

document.addEventListener('DOMContentLoaded', () => {
    const licenseModalEl = document.getElementById('licenseModal');  
    const licenseModal = new bootstrap.Modal(licenseModalEl);
    
    // ЁЯЪА рдлрд┐рдХреНрд╕: рд╕рд┐рд░реНрдл рдирдП рд▓реЙрдЧрд┐рди рдХрдВрдЯреЗрдирд░ рдХреЛ рдкрдХрдбрд╝реЗрдВ
    const newLoginContainer = document.getElementById('auth-container-new'); 
    
    // ЁЯЪА рдлрд┐рдХреНрд╕: рдкреБрд░рд╛рдирд╛ рдХрдВрдЯреЗрдирд░ рдЕрдм рдореМрдЬреВрдж рдирд╣реАрдВ рд╣реИ, рдЙрд╕реЗ рд╣рдЯрд╛ рджреЗрдВ
    // const oldLoginContainer = document.getElementById('auth-container'); 

    const token = localStorage.getItem('authToken');
    const user = JSON.parse(localStorage.getItem('authUser'));

    if (token && user) {
        console.log("рдЯреЛрдХрди рдорд┐рд▓рд╛, рд▓реЙрдЧрд┐рди рд╕реНрдерд┐рддрд┐ рдХреА рдЬрд╛рдБрдЪ рдХреА рдЬрд╛ рд░рд╣реА рд╣реИ...");
        saveAuthData(token, user);
        startLicenseTimer(user.licenseExpiryDate);

        const expiryDate = user.licenseExpiryDate ? new Date(user.licenseExpiryDate) : null;
        const now = new Date();

        if (!expiryDate || expiryDate < now) {
            // --- ЁЯЪА рдХреЗрд╕ 1: рд▓рд╛рдЗрд╕реЗрдВрд╕ рдПрдХреНрд╕рдкрд╛рдпрд░ рд╣реИ ---
            console.log("рд▓рд╛рдЗрд╕реЗрдВрд╕ рд╕рдорд╛рдкреНрдд рдпрд╛ рдЧреБрдо рд╣реИред рд╕рдХреНрд░рд┐рдпрдг рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред");
            showMessage('рд▓рд╛рдЗрд╕реЗрдВрд╕ рдЖрд╡рд╢реНрдпрдХ', 'рдЖрдкрдХрд╛ рд▓рд╛рдЗрд╕реЗрдВрд╕ рд╕рдорд╛рдкреНрдд рд╣реЛ рдЧрдпрд╛ рд╣реИред рдХреГрдкрдпрд╛ рд╕рдХреНрд░рд┐рдп рдХрд░реЗрдВред', 'warning');

            // ЁЯЪА рдлрд┐рдХреНрд╕: рд▓реИрдВрдбрд┐рдВрдЧ рдмрдЯрди рдХреЛ рдЫрд┐рдкрд╛рдПрдБ
            document.getElementById('landing-buttons-container').classList.add('hidden');
            
            // ЁЯЪА рдлрд┐рдХреНрд╕: рд▓реЙрдЧрд┐рди рд░реИрдкрд░ (Wrapper) рдХреЛ рджрд┐рдЦрд╛рдПрдБ
            document.getElementById('login-wrapper-main').classList.add('active'); 

            // ЁЯЪА рдлрд┐рдХреНрд╕: рдирдпрд╛ рд▓реЙрдЧрд┐рди рдкреЗрдЬ (рдмреИрдХрдЧреНрд░рд╛рдЙрдВрдб рдХреЗ рд▓рд┐рдП) рджрд┐рдЦрд╛рдПрдБ
            if (newLoginContainer) newLoginContainer.classList.remove('hidden');

            // рдРрдк рдХреЗ рд╣рд┐рд╕реНрд╕реЗ (рдЬреИрд╕реЗ рд╕рд╛рдЗрдбрдмрд╛рд░) рдЕрдирд▓реЙрдХ рдХрд░реЗрдВ
            document.getElementById('sidebar').classList.remove('locked');
            document.getElementById('menu-toggle').classList.remove('locked');
            document.getElementById('main-content').classList.add('locked'); // рдореБрдЦреНрдп рдХрдВрдЯреЗрдВрдЯ рд▓реЙрдХ рд░рдЦреЗрдВ
            applyRBAC(user.role);
            licenseModal.show(); // рд▓рд╛рдЗрд╕реЗрдВрд╕ Modal рдХреЛ рдлреЙрд░реНрдо рдХреЗ рдКрдкрд░ рджрд┐рдЦрд╛рдПрдБ

        } else {
            // --- ЁЯЪА рдХреЗрд╕ 2: рд╕рдм рдХреБрдЫ рд╕рд╣реА рд╣реИ (рдЯреЛрдХрди рдФрд░ рд▓рд╛рдЗрд╕реЗрдВрд╕) ---
            console.log("рдЯреЛрдХрди рдФрд░ рд▓рд╛рдЗрд╕реЗрдВрд╕ рдорд╛рдиреНрдп рд╣реИрдВред рдРрдк рдЕрдирд▓реЙрдХ рд╣реЛ рд░рд╣рд╛ рд╣реИред");
            
            // ЁЯЪА рдлрд┐рдХреНрд╕: рдирдпрд╛ рд▓реЙрдЧрд┐рди рдкреЗрдЬ рдЫрд┐рдкрд╛рдПрдБ
            if (newLoginContainer) newLoginContainer.classList.add('hidden');
            
            unlockApplication(); // рдРрдк рдХреЛ рдкреВрд░реА рддрд░рд╣ рдЕрдирд▓реЙрдХ рдХрд░реЗрдВ
        }

    } else {
        // --- ЁЯЪА рдХреЗрд╕ 3: рдХреЛрдИ рдЯреЛрдХрди рдирд╣реАрдВ рдорд┐рд▓рд╛ (рд▓реЙрдЧрдЖрдЙрдЯ рд╣реИ) ---
        console.log("рдХреЛрдИ рдЯреЛрдХрди рдирд╣реАрдВ рдорд┐рд▓рд╛ред рд▓реЙрдЧрд┐рди рд╕реНрдХреНрд░реАрди рджрд┐рдЦрд╛ рд░рд╣рд╛ рд╣реИред");
        
        // ЁЯЪА рдлрд┐рдХреНрд╕: рд╕рд┐рд░реНрдл рдирдпрд╛ рд▓реЙрдЧрд┐рди рдкреЗрдЬ рджрд┐рдЦрд╛рдПрдБ
        if (newLoginContainer) newLoginContainer.classList.remove('hidden');

        // рдРрдк рдХреЗ рдмрд╛рдХреА рд╣рд┐рд╕реНрд╕реЛрдВ рдХреЛ рд▓реЙрдХ рд░рдЦреЗрдВ
        document.getElementById('sidebar').classList.add('locked');
        document.getElementById('main-content').classList.add('locked');
        document.getElementById('menu-toggle').classList.add('locked');
    }

    // --- рдмрд╛рдХреА рдХреЗ рд╕рднреА рд▓рд┐рд╕реНрдирд░ (Event Listeners) ---
// --- ЁЯЪА (рдирдпрд╛) рд▓реИрдВрдбрд┐рдВрдЧ рдкреЗрдЬ рдмрдЯрди рд▓рд┐рд╕реНрдирд░ ---

const landingButtons = document.getElementById('landing-buttons-container');
    const loginWrapper = document.getElementById('login-wrapper-main');
    const showLoginBtn = document.getElementById('show-login-btn');
    const showRegisterBtn = document.getElementById('show-register-btn');

    // (рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ рдпреЗ рдЯреИрдм рдореМрдЬреВрдж рд╣реИрдВ)
    const loginTabBtn = document.getElementById('nav-login-tab');
    const registerTabBtn = document.getElementById('nav-register-tab');
    
    // рдПрдХ 'рд╢реЛ' рдлрд╝рдВрдХреНрд╢рди рдмрдирд╛рдПрдБ
    function showLoginWrapper(tabToShow) {
        if (!loginWrapper || !landingButtons) return;

        // 1. рд▓реЙрдЧрд┐рди рдмреЙрдХреНрд╕ рдХреЛ 'active' рдХреНрд▓рд╛рд╕ рджреЗрдВ
        loginWrapper.classList.add('active');
        
        // 2. рд▓реИрдВрдбрд┐рдВрдЧ рдмрдЯрдиреНрд╕ рдХреЛ рдЫрд┐рдкрд╛рдПрдБ (рдореМрдЬреВрджрд╛ 'hidden' рдХреНрд▓рд╛рд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ)
        landingButtons.classList.add('hidden');
        
        // 3. рд╕рд╣реА рдЯреИрдм рджрд┐рдЦрд╛рдПрдБ
        if (tabToShow === 'login' && loginTabBtn) {
            new bootstrap.Tab(loginTabBtn).show();
        } else if (tabToShow === 'register' && registerTabBtn) {
            new bootstrap.Tab(registerTabBtn).show();
        }
    }

    // 'рд▓реЙрдЧрд┐рди' рдмрдЯрди рдкрд░ рдХреНрд▓рд┐рдХ
    if(showLoginBtn) {
        showLoginBtn.addEventListener('click', () => {
            showLoginWrapper('login');
        });
    }

    // 'рд░рдЬрд┐рд╕реНрдЯрд░' рдмрдЯрди рдкрд░ рдХреНрд▓рд┐рдХ
    if(showRegisterBtn) {
        showRegisterBtn.addEventListener('click', () => {
            showLoginWrapper('register');
        });
    }

    // --- (рдпрд╣рд╛рдБ рд╕реЗ 'рдмрд╛рдХреА рдХреЗ рд╕рднреА рд▓рд┐рд╕реНрдирд░' рд╢реБрд░реВ рд╣реЛрддреЗ рд╣реИрдВ) ---



    
    // Login Form
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const msgEl = document.getElementById('login-message');
        const btn = document.getElementById('login-submit-btn');
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> рд▓реЙрдЧ рдЗрди рд╣реЛ рд░рд╣рд╛ рд╣реИ...`;

        try {
            const res = await fetch(__backend_url + '/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await res.json();
            if (!res.ok || !data.success) { throw new Error(data.message || 'рд▓реЙрдЧрд┐рди рд╡рд┐рдлрд▓'); }

            msgEl.innerText = 'рд╕рдлрд▓рддрд╛! рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...';
            saveAuthData(data.token, data.user);
            startLicenseTimer(data.user.licenseExpiryDate);

            if (data.requiresLicense) {
                // ЁЯЪА рдлрд┐рдХреНрд╕: рд▓рд╛рдЗрд╕реЗрдВрд╕ рдПрдХреНрд╕рдкрд╛рдпрд░ рд╣реЛрдиреЗ рдкрд░ рд╕рд┐рд░реНрдл Modal рджрд┐рдЦрд╛рдПрдБ (рдмреИрдХрдЧреНрд░рд╛рдЙрдВрдб рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рджрд┐рдЦ рд░рд╣рд╛ рд╣реИ)
                showMessage('рд▓рд╛рдЗрд╕реЗрдВрд╕ рдЖрд╡рд╢реНрдпрдХ', data.message, 'warning');
                if (newLoginContainer) newLoginContainer.classList.remove('hidden'); // рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ рдмреИрдХрдЧреНрд░рд╛рдЙрдВрдб рджрд┐рдЦреЗ
                document.getElementById('sidebar').classList.remove('locked');
                document.getElementById('menu-toggle').classList.remove('locked');
                document.getElementById('main-content').classList.add('locked');
                applyRBAC(data.user.role);
                licenseModal.show();
            } else {
                unlockApplication(); // рд╕рдм рд╕рд╣реА рд╣реИ, рдРрдк рдЕрдирд▓реЙрдХ рдХрд░реЗрдВ
            }
        } catch (error) {
            msgEl.innerText = error.message;
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'рд▓реЙрдЧрд┐рди';
        }
    });

    // Registration Form
// [ тЬЕ FIXED: Registration Form Handler - Correct ID Used ]

// [ тЬЕ FIXED: Registration Logic with Unique ID ]

document.getElementById('register-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const shopName = document.getElementById('register-shop-name').value;
    const name = document.getElementById('register-name').value;
    const email = document.getElementById('register-email').value;
    const mobile = document.getElementById('register-mobile').value;
    const password = document.getElementById('register-password').value;
    
    // ЁЯЪА FIX: рдирдИ рдпреВрдирд┐рдХ ID рд╕реЗ рд╡реИрд▓реНрдпреВ рдЙрдард╛рдПрдВ
    const typeElement = document.getElementById('unique-biz-type');
    const businessType = typeElement ? typeElement.value : ''; 

    // ЁЯЫС рдЪреЗрдХ: рдЕрдЧрд░ рдХреБрдЫ рдирд╣реАрдВ рдЪреБрдирд╛, рддреЛ рд░реЛрдХ рджреЗрдВ
    if (!businessType) {
        alert("рдХреГрдкрдпрд╛ рдмрд┐рдЬрдиреЗрд╕ рдХрд╛ рдкреНрд░рдХрд╛рд░ рдЪреБрдиреЗрдВ!");
        return;
    }

    // ЁЯУв рдбрд┐рдмрдЧ: рдпрд╣ рдЕрд▓рд░реНрдЯ рдЖрдкрдХреЛ рдмрддрд╛рдПрдЧрд╛ рдХрд┐ рдХреНрдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ
    // alert("рд░рдЬрд┐рд╕реНрдЯрд░ рд╣реЛ рд░рд╣рд╛ рд╣реИ: " + businessType); 

    const msgEl = document.getElementById('register-message');
    const btn = document.getElementById('register-submit-btn');
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> рд░рдЬрд┐рд╕реНрдЯрд░ рд╣реЛ рд░рд╣рд╛ рд╣реИ...`;

    try {
        const res = await fetch(__backend_url + '/api/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                shopName, 
                name, 
                email, 
                mobile, 
                password, 
                business_type: businessType // рдпрд╣ 'SALON' рднреЗрдЬреЗрдЧрд╛
            })
        });
        const data = await res.json();
        if (!res.ok || !data.success) { throw new Error(data.message || 'рд░рдЬрд┐рд╕реНрдЯреНрд░реЗрд╢рди рд╡рд┐рдлрд▓'); }

        msgEl.innerText = 'рд╕рдлрд▓рддрд╛! рдРрдк рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...';
        
        saveAuthData(data.token, data.user);
        
        // ЁЯЪА UI рдХреЛ рддреБрд░рдВрдд рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ
        applyBusinessTypeUI(data.user.businessType);
        
        startLicenseTimer(data.user.licenseExpiryDate);
        showMessage('рд╕рдлрд▓рддрд╛!', `рдЖрдкрдХрд╛ ${data.user.businessType} рдЕрдХрд╛рдЙрдВрдЯ рдмрди рдЧрдпрд╛ рд╣реИ!`, 'success');
        
        if (typeof newLoginContainer !== 'undefined') newLoginContainer.classList.remove('hidden');
        document.getElementById('sidebar').classList.remove('locked');
        document.getElementById('menu-toggle').classList.remove('locked');
        document.getElementById('main-content').classList.add('locked');
        
        if (typeof applyRBAC === 'function') applyRBAC(data.user.role);
        
        const licenseModal = new bootstrap.Modal(document.getElementById('licenseModal'));
        licenseModal.show();

    } catch (error) {
        msgEl.innerText = error.message;
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'рдЕрдХрд╛рдЙрдВрдЯ рдмрдирд╛рдПрдВ';
    }
});

    // License Activation Form
    document.getElementById('license-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const key = document.getElementById("license-key-input").value.trim();
        const messageEl = document.getElementById("license-message");
        messageEl.innerText = 'рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ...';

        try {
           const res = await fetchApi('/api/activate-license', {
                method: 'POST',
                body: { licenseKey: key }
           }, 'рд▓рд╛рдЗрд╕реЗрдВрд╕ рд╕рдХреНрд░рд┐рдп рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ...');
            
            if (res.success) {
                saveAuthData(res.token, res.user);
                startLicenseTimer(res.user.licenseExpiryDate);
                licenseModal.hide();
                showMessage('рд╕рдлрд▓рддрд╛', res.message, 'success');
                unlockApplication(); // <<< рдЕрдм рдРрдк рдХреЛ рдЕрдирд▓реЙрдХ рдХрд░реЗрдВ
            } else {
                throw new Error(res.message || 'рдЕрдорд╛рдиреНрдп рдпрд╛ рд╕рдорд╛рдкреНрдд рд▓рд╛рдЗрд╕реЗрдВрд╕ред');
            }
        } catch (err) {
            messageEl.innerText = 'тЭМ ' + err.message;
        }
    });
    
    // --- рдмрд╛рдХреА рдХреЗ рд╕рднреА рд▓рд┐рд╕реНрдирд░ ---
    document.getElementById('logout-btn').addEventListener('click', logout);
    document.querySelectorAll('#sidebar-nav .nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            handleNavClick(link.getAttribute('data-view'));
            if (window.innerWidth < 992) document.getElementById('sidebar').classList.remove('active');
        });
    });
    document.getElementById('menu-toggle').addEventListener('click', () => {
         document.getElementById('sidebar').classList.toggle('active');
    });
    const posSearchInput = document.getElementById('pos-item-search');
    if (posSearchInput) {
        posSearchInput.addEventListener('input', () => handleItemSearch(false)); 
        posSearchInput.addEventListener('click', () => handleItemSearch(true)); 
        document.addEventListener('click', (e) => {
            if (e.target.id !== 'pos-item-search') {
                document.getElementById('pos-search-results').innerHTML = '';
            }
        });
    }
    updatePOSCartView(); 
    const expenseDateInput = document.getElementById('expense-date');
    if (expenseDateInput) {
        try {
            expenseDateInput.value = new Date().toISOString().split('T')[0];
        } catch(e) { console.error("Expense date set error", e); }
    }
    const barcodeInput = document.getElementById('barcode-scanner-input');
    barcodeInput.addEventListener('change', () => handleBarcodeScan(null));
    // [ рдпрд╣ рдЖрдкрдХрд╛ рдлрд┐рдХреНрд╕ рд╣реИ - рдЙрд╕ рдПрдХ рд▓рд╛рдЗрди рдХреА рдЬрдЧрд╣ рдЗрд╕реЗ рдкреЗрд╕реНрдЯ рдХрд░реЗрдВ ]
// [ тЬЕ FIXED: Global Scanner Focus Logic ]
    // рдпрд╣ рдХреЛрдб рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдЬрдм рдЖрдк рдЯрд╛рдЗрдк рдХрд░ рд░рд╣реЗ рд╣реЛрдВ рдпрд╛ рд▓рд╛рд▓ рд╕реНрдХреНрд░реАрди рдЦреБрд▓реА рд╣реЛ,
    // рддреЛ рд╕реНрдХреИрдирд░ рдлреЛрдХрд╕ рди рдЫреАрдиреЗред

    document.body.addEventListener('click', (e) => {
        // 1. рдЪреЗрдХ рдХрд░реЗрдВ рдХрд┐ рдХреНрдпрд╛ рд▓рд╛рд▓ рд╕реНрдХреНрд░реАрди (рдпрд╛ рдХреЛрдИ рднреА рдореЙрдбрд▓) рдЦреБрд▓реА рд╣реИ?
        const isModalOpen = document.querySelector('.modal.show');
        
        // рдЕрдЧрд░ рдХреЛрдИ рд╕реНрдХреНрд░реАрди рдЦреБрд▓реА рд╣реИ, рддреЛ рдпрд╣ 'Auto Focus' рд╡рд╛рд▓рд╛ рд▓реЙрдЬрд┐рдХ рди рдЪрд▓рд╛рдПрдВред
        // рдЗрд╕рд╕реЗ рдЖрдк рдЖрд░рд╛рдо рд╕реЗ рдЯрд╛рдЗрдк рдХрд░ рдкрд╛рдПрдВрдЧреЗред
        if (isModalOpen) {
            return; 
        }

        // --- рдиреАрдЪреЗ рдХрд╛ рдХреЛрдб рддрднреА рдЪрд▓реЗрдЧрд╛ рдЬрдм рдХреЛрдИ рд╕реНрдХреНрд░реАрди рдирд╣реАрдВ рдЦреБрд▓реА рд╣реЛ ---

        const targetElement = e.target;
        const targetTagName = targetElement.tagName.toUpperCase();

        // рдЪреЗрдХ рдХрд░реЗрдВ рдХрд┐ рдХреНрдпрд╛ рдЖрдкрдиреЗ рдХрд┐рд╕реА рдХрд╛рдо рдХреА рдЪреАрдЬрд╝ рдкрд░ рдХреНрд▓рд┐рдХ рдХрд┐рдпрд╛ рд╣реИ
        const isClickable = (
            targetTagName === 'INPUT' ||
            targetTagName === 'TEXTAREA' ||
            targetTagName === 'SELECT' ||
            targetTagName === 'BUTTON' ||
            targetElement.closest('a') || 
            targetElement.closest('.nav-link') || 
            targetElement.closest('.list-group-item-action') ||
            targetElement.closest('.modal-content') // ЁЯЪА Extra Safety: рдЕрдЧрд░ рдореЙрдбрд▓ рдХреЗ рдЕрдВрджрд░ рдХреНрд▓рд┐рдХ рд╣реБрдЖ
        );

        // рдЕрдЧрд░ рдЦрд╛рд▓реА рдЬрдЧрд╣ рдкрд░ рдХреНрд▓рд┐рдХ рдХрд┐рдпрд╛ рд╣реИ, рддрднреА рд╕реНрдХреИрдирд░ рдЪрд╛рд▓реВ рдХрд░реЗрдВ
        if (!isClickable) {
            focusBarcodeScanner();
        }
    });

    // postMessage Listener
    window.addEventListener('message', function(event) {
        if (event.origin !== window.location.origin) return; 
        if (event.data) {
            const token = localStorage.getItem('authToken');
            const user = AppState.user || JSON.parse(localStorage.getItem('authUser'));
            const shopId = user ? user.shopId : null;
            const backendUrl = __backend_url;

            if (event.data.type === 'REQUEST_AUTH' && token) {
                if (window.scannerWindow && !window.scannerWindow.closed) {
                    window.scannerWindow.postMessage({
                        type: 'AUTH_TOKEN',
                        token: token,
                        shopId: shopId,
                        backendUrl: backendUrl
                    }, window.location.origin);
                }
            }
            if (event.data.type === 'SCANNED_SKU' && event.data.sku) {
                 addSKUToCart(event.data.sku);
            }
        }
    });


// ЁЯЪАЁЯЪАЁЯЪА рдмреИрдВрдХ рд░рд┐рдХреЙрдиреНрд╕рд┐рд▓реЗрд╢рди рд▓рд┐рд╕реНрдирд░ рдпрд╣рд╛рдБ рдЬреЛрдбрд╝реЗрдВ ЁЯЪАЁЯЪАЁЯЪА
document.getElementById('reconciliation-start-form').addEventListener('submit', handleStatementUpload);
        document.getElementById('save-reconciliation-btn').addEventListener('click', saveReconciliationReport);
        document.getElementById('cancel-reconciliation-btn').addEventListener('click', () => {
            if(confirm('рдХреНрдпрд╛ рдЖрдк рд╡рд╛рдХрдИ рд░рд┐рдХреЙрдиреНрд╕рд┐рд▓реЗрд╢рди рд░рджреНрдж рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?')) {
                renderView('bank-reconciliation'); // рдкреЗрдЬ рдХреЛ рд░реАрд╕реЗрдЯ рдХрд░реЗрдВ
            }
        });
        // ЁЯЪАЁЯЪАЁЯЪА рдХреЛрдб рдпрд╣рд╛рдБ рд╕рдорд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИ ЁЯЪАЁЯЪАЁЯЪА

});


// [ рдирдпрд╛ DOMContentLoaded рдлрд╝рдВрдХреНрд╢рди рдпрд╣рд╛рдБ рд╕рдорд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИ ]

// [ рдирдпрд╛ DOMContentLoaded рдлрд╝рдВрдХреНрд╢рди рдпрд╣рд╛рдБ рд╕рдорд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИ ]// [ рдирдпрд╛ DOMContentLoaded рдлрд╝рдВрдХреНрд╢рди рдпрд╣рд╛рдБ рд╕рдорд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИ ]    // --- Registration Form Handler - MODIFIED ---
   // Registration Form Handler - MODIFIED to include mobile
 

</script>

<div class="modal fade" id="pairingModal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="pairingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pairingModalLabel">рдореЛрдмрд╛рдЗрд▓ рд╕реНрдХреИрдирд░ рдХрдиреЗрдХреНрдЯ рдХрд░реЗрдВ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closePosWebSocket()"></button>
            </div>
            <div class="modal-body text-center">
                <p>рдЕрдкрдиреЗ Dukan Pro рдореЛрдмрд╛рдЗрд▓ рд╕реНрдХреИрдирд░ рдореЗрдВ рдпрд╣ рдХреЛрдб рджрд░реНрдЬ рдХрд░реЗрдВ:</p>
                
                <div id="pairing-code-container" style="min-height: 100px; display: flex; align-items: center; justify-content: center; background: #eee; border-radius: 8px; margin: 20px 0;">
                    
                    <span id="pairing-code-display" style="font-size: 2.5rem; font-weight: bold; letter-spacing: 5px; color: #0d6efd;"></span> 
                    
                    <div id="code-spinner" class="spinner-border text-primary" role="status"> 
                        <span class="visually-hidden">рдХреЛрдб рдЬрдирд░реЗрдЯ рд╣реЛ рд░рд╣рд╛ рд╣реИ...</span>
                    </div>
                </div>
                
                <h4 id="pairing-status" class="text-success"> 
                    <i class="fas fa-check-circle"></i> рд╕реНрдХреИрдирд░ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдХрдиреЗрдХреНрдЯ рд╣реЛ рдЧрдпрд╛!
                </h4>
                
                <p class="text-muted small mt-3">рдпрд╣ рдХреЛрдб рдЖрдкрдХреЗ POS рдХреЛ рдЖрдкрдХреЗ рдлрд╝реЛрди рд╕реЗ рд╕реБрд░рдХреНрд╖рд┐рдд рд░реВрдк рд╕реЗ рдЬреЛрдбрд╝рддрд╛ рд╣реИред</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closePosWebSocket()">рд░рджреНрдж рдХрд░реЗрдВ</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="quickAddItemModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="quickAddItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="quickAddItemModalLabel"><i class="fas fa-plus-circle me-2"></i>рдирдпрд╛ рдЖрдЗрдЯрдо рддреБрд░рдВрдд рдЬреЛрдбрд╝реЗрдВ</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="quick-add-item-form">
                    <div class="mb-3">
                        <label for="quick-add-sku" class="form-label">SKU / Barcode Number</label>
                        <input type="text" class="form-control" id="quick-add-sku" required>
                    </div>

                    <div class="mb-3">
                        <label for="quick-add-name" class="form-label">рдЖрдЗрдЯрдо рдХрд╛ рдирд╛рдо</label>
                        <input type="text" class="form-control" id="quick-add-name" required>
                    </div>

                    <div class="row g-2">
                        <div class="col-md-6">
                            <label for="quick-add-sale-price" class="form-label">рдмрд┐рдХреНрд░реА рдореВрд▓реНрдп (Sale Price) (тВ╣)</label>
                            <input type="number" step="0.01" class="form-control" id="quick-add-sale-price" required min="0">
                        </div>
                        <div class="col-md-6">
                            <label for="quick-add-purchase-price" class="form-label">рдЦрд░реАрдж рдореВрд▓реНрдп (Purchase Price) (тВ╣)</label>
                            <input type="number" step="0.01" class="form-control" id="quick-add-purchase-price" required min="0">
                        </div>
                    </div>

                    <div class="modal-footer pb-0">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">рд░рджреНрдж рдХрд░реЗрдВ</button>
                        <button type="button" class="btn btn-success" id="quick-add-save-btn">
                            <i class="fas fa-save me-2"></i>рд╕реЗрд╡ рдХрд░реЗрдВ рдФрд░ рдХрд╛рд░реНрдЯ рдореЗрдВ рдЬреЛрдбрд╝реЗрдВ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="localScannerModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="localScannerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="localScannerModalLabel"><i class="fas fa-camera me-2"></i>Live Barcode Scanner</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" id="local-scanner-close-btn"></button>
            </div>
            <div class="modal-body" style="padding: 0; min-height: 250px;">
                <div id="local-scanner-video" style="width: 100%;"></div>
                <div id="local-scanner-message" class="alert alert-info m-2" style="display: none;">
                    рдХреИрдорд░рд╛ рд╢реБрд░реВ рд╣реЛ рд░рд╣рд╛ рд╣реИ...
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="local-scanner-cancel-btn">рд░рджреНрдж рдХрд░реЗрдВ</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="appointmentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-calendar-check me-2"></i>рдирдИ рдЕрдкреЙрдЗрдВрдЯрдореЗрдВрдЯ рдмреБрдХ рдХрд░реЗрдВ</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="appointment-form">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">рдЧреНрд░рд╛рд╣рдХ рдХрд╛ рдирд╛рдо</label>
                        <input type="text" id="appt-name" class="form-control" required placeholder="e.g. Rahul">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░</label>
                        <input type="tel" id="appt-mobile" class="form-control" placeholder="e.g. 9876543210">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">рд╕рд░реНрд╡рд┐рд╕ (Service)</label>
                        <input type="text" id="appt-service" class="form-control" required placeholder="e.g. Hair Cut">
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label small fw-bold">рддрд╛рд░реАрдЦ (Date)</label>
                            <input type="date" id="appt-date" class="form-control" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label small fw-bold">рд╕рдордп (Time)</label>
                            <input type="time" id="appt-time" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="mt-4 d-grid">
                        <button type="submit" class="btn btn-success">рдмреБрдХрд┐рдВрдЧ рдкрдХреНрдХреА рдХрд░реЗрдВ (Book Now)</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ========================== -->
<!--   ULTIMATE AI INSIGHTS     -->
<!-- ========================== -->

<section id="ai-insights" class="section">

    <!-- TOP HEADER -->
    <div class="ai-header-box">
        <div>
            <h2 class="ai-title"><i class="fas fa-brain me-2"></i> Ultimate AI Insights</h2>
            <p class="ai-subtitle">Your Business тАФ Deep AI Analysis, Predictions & Strategies</p>
        </div>
        <button class="ai-refresh-btn" onclick="loadUltimateAI()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>

    <!-- MAIN CONTENT -->
    <div id="ai-insights-container">

        <!-- BUSINESS HEALTH -->
        <div id="ai-business-health" class="ai-box">
            <h3><i class="fas fa-heartbeat"></i> Business Health Overview</h3>
            <div id="ai-health-content">
                <div class="ai-loading">
                    <div class="spinner-border text-primary"></div>
                    <p>Analyzing business performance...</p>
                </div>
            </div>
        </div>

        <!-- CUSTOMER INTELLIGENCE -->
        <div id="ai-customer-intel" class="ai-box">
            <h3><i class="fas fa-users"></i> Customer Intelligence</h3>
            <div id="ai-customer-content">
                <div class="ai-loading">
                    <div class="spinner-border text-primary"></div>
                    <p>Analyzing customer patterns...</p>
                </div>
            </div>
        </div>

        <!-- PRODUCT INTELLIGENCE -->
        <div id="ai-product-intel" class="ai-box">
            <h3><i class="fas fa-box-open"></i> Product Intelligence</h3>
            <div id="ai-product-content">
                <div class="ai-loading">
                    <div class="spinner-border text-primary"></div>
                    <p>Checking product performance...</p>
                </div>
            </div>
        </div>


<!-- LOSS FINDER BOX -->
<div id="ai-loss-finder" class="ai-box">
    <h3><i class="fas fa-exclamation-triangle"></i> Loss Finder (рдиреБрдХрд╕рд╛рди рдкрдХрдбрд╝рдиреЗ рд╡рд╛рд▓рд╛ AI)</h3>
    <div id="ai-loss-content">
        <div class="ai-loading">
            <div class="spinner-border text-danger"></div>
            <p>рдиреБрдХрд╕рд╛рди рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рд╣реЛ рд░рд╣рд╛ рд╣реИ...</p>
        </div>
    </div>
</div>


        <!-- FESTIVAL STRATEGY -->
        <div id="ai-festival-strategy" class="ai-box">
            <h3><i class="fas fa-fireworks"></i> Festival Strategy</h3>
            <div id="ai-festival-content">
                <div class="ai-loading">
                    <div class="spinner-border text-primary"></div>
                    <p>Preparing festival recommendations...</p>
                </div>
            </div>
        </div>

        <!-- MARKETING / ADS AI -->
        <div id="ai-marketing-intel" class="ai-box">
            <h3><i class="fas fa-bullhorn"></i> Marketing & Advertisement AI</h3>
            <div id="ai-marketing-content">
                <div class="ai-loading">
                    <div class="spinner-border text-primary"></div>
                    <p>Generating ad ideas...</p>
                </div>
            </div>
        </div>

        <!-- SALES PREDICTION -->
        <div id="ai-prediction" class="ai-box">
            <h3><i class="fas fa-chart-line"></i> Sales & Stock Prediction</h3>
            <div id="ai-prediction-content">
                <div class="ai-loading">
                    <div class="spinner-border text-primary"></div>
                    <p>Generating predictions...</p>
                </div>
            </div>
        </div>

    </div>

    
<div class="ai-box" id="ai-chat-box">
    <h3><i class="fas fa-comments"></i> AI рд╡реНрдпрд╡рд╕рд╛рдп рд╕рд▓рд╛рд╣</h3>
  
    <div id="ai-chat-response" class="ai-chat-response">
       <p class="text-muted-small">AI рдЖрдкрдХреЗ рд╕рд╡рд╛рд▓реЛрдВ рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░реЗрдЧрд╛...</p>
    </div>
  
    <div class="ai-chat-input">
      <input id="ai-chat-question" type="text" placeholder="рдЕрдкрдирд╛ рд╕рд╡рд╛рд▓ рд▓рд┐рдЦреЗрдВ... (рдЬреИрд╕реЗ - рдореЗрд░рд╛ profit рдХреИрд╕реЗ рдмрдврд╝реЗ?)">
      <button type="button" onclick="askBusinessAI()" class="ai-refresh-btn">рдкреВрдЫреЗрдВ</button>
    </div>
  </div>


  
<!-- (A) small HTML container тАФ add inside your ai-insights section (where you want it to appear) -->
<div id="ai-customer-targeting" class="ai-box">
    <h3><i class="fas fa-bullseye"></i> Personalised Customer Targeting</h3>
    <div id="ai-customer-targeting-content">
      <div class="ai-loading"><div class="spinner-border text-primary"></div><p>рд▓реЛрдЧреЛрдВ рдХрд╛ рдЪрдпрди рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ...</p></div>
    </div>
  </div>

  <!-- ========================= -->
<!-- SALOON AI INSIGHTS (UI)  -->
<!-- ========================= -->
<div id="ai-saloon" class="ai-box" style="display:none;">
    <h3><i class="fas fa-scissors"></i> Saloon Dashboard</h3>
  
    <div id="ai-saloon-dashboard">
      <div class="ai-loading">
        <div class="spinner-border text-primary"></div>
        <p>Saloon рдбреЗрдЯрд╛ рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...</p>
      </div>
    </div>
  
    <hr>
  
    <div id="ai-saloon-services" style="margin-top:12px;">
      <h5><i class="fas fa-concierge-bell"></i> Services / Items</h5>
      <div class="ai-loading">
        <div class="spinner-border text-primary"></div>
        <p>Services рд▓реЛрдб рд╣реЛ рд░рд╣реЗ рд╣реИрдВ...</p>
      </div>
    </div>
  
    <hr>
  
    <div id="ai-saloon-birthdays" style="margin-top:12px;">
      <h5><i class="fas fa-birthday-cake"></i> Upcoming Birthdays (7 days)</h5>
      <div class="ai-loading">
        <div class="spinner-border text-primary"></div>
        <p>Birthday list рд▓реЛрдб рд╣реЛ рд░рд╣реА рд╣реИ...</p>
      </div>
    </div>
  </div>
  
<div id="ai-saloon-box" class="ai-box" style="display:none;">
    <h3><i class="fas fa-scissors"></i> Salon Insights</h3>
    <div id="ai-saloon-content">
      <div class="ai-loading">
        <div class="spinner-border text-primary"></div>
        <p>Saloon data рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...</p>
      </div>
    </div>
</div>
  
</section>





<script>


async function askBusinessAI(){
  const q = document.getElementById("ai-chat-question").value.trim();
  if(!q) return;

  document.getElementById("ai-chat-response").innerHTML = `<p class="text-muted-small">рд╕реЛрдЪ рд░рд╣рд╛ рд╣реВрдБ...</p>`;

  try {
    const res = await fetchApi("/api/ai/business-chat", {
      method: "POST",
      body: { question: q }   // pass as object тАФ fetchApi will stringify safely
    });

    if(res && res.success){
      document.getElementById("ai-chat-response").innerHTML = `<p>${res.answer.replace(/\n/g,"<br>")}</p>`;
    } else {
      document.getElementById("ai-chat-response").innerHTML = `<p class="text-danger">${res.message || 'рдХреЛрдИ рдЙрддреНрддрд░ рдирд╣реАрдВ рдорд┐рд▓рд╛'}</p>`;
    }
  } catch (err) {
    document.getElementById("ai-chat-response").innerHTML = `<p class="text-danger">Error: ${err.message}</p>`;
  }
}


    async function renderAiInsightsFinal(){
        const box = document.getElementById("ai-insights-content");
    
        box.innerHTML = `
            <div class="ai-loading">
                <div class="spinner-border text-primary"></div>
                <p>AI Analysis рдЪрд▓ рд░рд╣рд╛ рд╣реИ...</p>
            </div>
        `;
    
        try{
    
            const response = await fetchApi('/api/ai/stock-insights',{method:'GET'});
            if(!response.success){
                box.innerHTML = `<div class='alert alert-danger'>${response.message}</div>`;
                return;
            }
    
            const i = response.insights;
    
            box.innerHTML = `
                <div class="ai-health-box">
                    <h3>Business Health Score: <b>${i.business_health_score}/100</b></h3>
                    <div class="ai-progress"><div class="ai-progress-inner" style="width:${i.business_health_score}%"></div></div>
                </div>
    
                <div class="ai-card">
                    <h4>ЁЯУж Fast Moving Items 
                        <span class="ai-badge ai-badge-yellow">${i.fast_moving.length}</span>
                    </h4>
                    ${i.fast_moving.length ? 
                        i.fast_moving.map(item => `
                            <div class="alert alert-warning">
                                <b>${item.name}</b> (SKU: ${item.sku})  
                                <br>тП│ рдЦрддреНрдо рд╣реЛрдиреЗ рдХрд╛ рд╕рдордп: <b>${item.days_left} рджрд┐рди</b>  
                                <br>ЁЯУМ рд╕реНрдЯреЙрдХ: ${item.current_qty} pcs  
                            </div>
                        `).join('')
                    : `<p class='text-muted'>рдХреЛрдИ fast moving item рдирд╣реАрдВ рд╣реИ</p>`}
                </div>
    
                <div class="ai-card">
                    <h4>ЁЯЫС Dead Stock 
                        <span class="ai-badge ai-badge-red">${i.dead_stock.length}</span>
                    </h4>
                    ${i.dead_stock.length ?
                        i.dead_stock.map(item => `
                            <div class="alert alert-danger">
                                <b>${item.name}</b> (SKU: ${item.sku})  
                                <br>ЁЯЪл рдкрд┐рдЫрд▓реЗ 30 рджрд┐рдиреЛрдВ рдореЗрдВ рдирд╣реАрдВ рдмрд┐рдХрд╛  
                                <br>ЁЯТ░ рдлрдБрд╕рд╛ рд╣реБрдЖ рдкреИрд╕рд╛: тВ╣${item.stock_value}  
                            </div>
                        `).join('')
                    : `<p class='text-muted'>Dead stock рдирд╣реАрдВ рд╣реИ</p>`}
                </div>
    
                <div class="ai-card">
                    <h4>ЁЯФД Restock Suggestions 
                        <span class="ai-badge ai-badge-blue">${i.restock.length}</span>
                    </h4>
                    ${i.restock.length ?
                        i.restock.map(item => `
                            <div class="alert alert-info">
                                <b>${item.name}</b> (SKU: ${item.sku})  
                                <br>ЁЯУМ Current: ${item.current_qty} pcs  
                                <br>тнХ Suggested Reorder: <b>${item.suggested_reorder}</b> pcs  
                            </div>
                        `).join('')
                    : `<p class='text-muted'>рдХрд┐рд╕реА рднреА item рдХреА рдЕрднреА restock рдЬрд░реВрд░рдд рдирд╣реАрдВ</p>`}
                </div>
            `;
        }
        catch(err){
            box.innerHTML = `<div class='alert alert-danger'>Error: ${err.message}</div>`;
        }
    }
    
  

    </script>
        
        <script>
            /* ================================
               ULTIMATE AI INSIGHTS тАУ MAIN LOGIC
               ================================ */
            
        
               async function loadUltimateAI() {
  try {
    // show loading
    const ids = [
      "ai-health-content",
      "ai-customer-content",
      "ai-product-content",
      "ai-festival-content",
      "ai-marketing-content",
      "ai-prediction-content",
      "ai-saloon-content",
      // ЁЯЪА NEW: рдЗрди рддреАрдиреЛрдВ рдХреЛ рднреА рд▓реЛрдбрд┐рдВрдЧ рд▓рд┐рд╕реНрдЯ рдореЗрдВ рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛ рд╣реИ
      "ai-saloon-dashboard",
      "ai-saloon-services",
      "ai-saloon-birthdays"
    ];

    ids.forEach(id => {
      const box = document.getElementById(id);
      if (box) {
        box.innerHTML = `
          <div class="ai-loading">
            <div class="spinner-border text-primary"></div>
            <p>рдбрд╛рдЯрд╛ рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...</p>
          </div>`;
      }
    });

    // API CALLS
    const stockData      = await fetchApi("/api/ai/stock-insights", { method:"GET" });
    const customerData   = await fetchApi("/api/ai/customers-intel", { method:"GET" });
    const productData    = await fetchApi("/api/ai/products-intel", { method:"GET" });
    const predictionData = await fetchApi("/api/ai/prediction", { method:"GET" });
    const whatsappData   = await fetchApi("/api/ai/clients-whatsapp", { method:"GET" });
    const probData       = await fetchApi("/api/ai/customer-probability", { method:"GET" });
    const monthlyData    = await fetchApi("/api/ai/monthly-strategy", { method:"GET" });
    const lossData       = await fetchApi("/api/ai/loss-finder", { method:"GET" });
    const targetingData  = await fetchApi("/api/ai/customer-targeting", { method:"GET" });
    const saloonData     = await fetchApi("/api/ai/saloon-insights", { method:"GET" });

    // Render sections
    renderBusinessHealth(stockData);
    renderCustomerIntel(customerData);
    renderProductIntel(productData, stockData);
    renderFestivalStrategy(productData);
    renderMarketingIdeas(productData);
    renderPrediction(predictionData);
    renderCustomerProbability(probData);
    renderMonthlyStrategy(monthlyData);
    renderLossFinder(lossData);
    renderCustomerTargeting(targetingData.customers || targetingData);

    // NEW тЖТ Saloon Insights Rendering (Bottom Part)
    renderSaloonInsights(saloonData);

    // WhatsApp Advisor
    renderWhatsappAdvisor(whatsappData);
    
    // ЁЯЪАЁЯЪАЁЯЪА NEW LOGIC ADDED HERE ЁЯЪАЁЯЪАЁЯЪА
    // (рдпрд╣ рд▓рд╛рдЗрди рд╕реИрд▓реВрди рдбреИрд╢рдмреЛрд░реНрдб, рд╕рд░реНрд╡рд┐рд╕реЗрд╕ рдФрд░ рдмрд░реНрдердбреЗ рдХреЛ рд▓реЛрдб рдХрд░реЗрдЧреА)
    if (typeof loadSaloonAI === 'function') {
        await loadSaloonAI(); 
    }

    // ============================================================
    // ЁЯЪАЁЯФе SPECIAL CHECK: SALON ONLY (NEW UPDATION)
    // ============================================================
    const userType = AppState.user?.businessType; 
    
    // Salon рдХреЗ рдХрдВрдЯреЗрдирд░реНрд╕ IDs (HTML рдореЗрдВ рдпреЗ рд╣реЛрдиреЗ рдЪрд╛рд╣рд┐рдП)
    const salonBox = document.getElementById('ai-saloon-box');
    const salonDash = document.getElementById('ai-saloon');

    if (userType === 'SALON') {
        // рдЕрдЧрд░ рд╕реИрд▓реВрди рд╣реИ, рддреЛ рдмреЙрдХреНрд╕ рджрд┐рдЦрд╛рдПрдВ
        if (salonBox) salonBox.style.display = 'block';
        if (salonDash) salonDash.style.display = 'block';
    } else {
        // рдЕрдЧрд░ рд╕реИрд▓реВрди рдирд╣реАрдВ рд╣реИ (рдЬреИрд╕реЗ Paint, Mobile), рддреЛ рдЫреБрдкрд╛ рджреЗрдВ
        if (salonBox) salonBox.style.display = 'none';
        if (salonDash) salonDash.style.display = 'none';
    }
    // ============================================================

  } catch (err) {
    alert("AI Error: " + err.message);
    console.error(err);
  }
}            
            /* =============== SECTION 1 =============== */
            function renderBusinessHealth(stock) {
  const el = document.getElementById("ai-health-content");

  const fast = stock.insights.fast_moving.length;
  const dead = stock.insights.dead_stock.length;

  // Business score logic
  let score = 100;
  score -= dead * 5;
  score += fast * 3;
  if(score<20) score=20;

  el.innerHTML = `
    <div class="ai-health-card">
      <div class="ai-score-circle">${score}</div>
      <div class="ai-health-meta">
        <p><b>рд╡реНрдпрд╛рдкрд╛рд░ рд╕реНрд╡рд╛рд╕реНрдереНрдп:</b> ${score >=80 ? "рдмрд╣реБрдд рдЕрдЪреНрдЫрд╛" : "рд╕рд╛рдорд╛рдиреНрдп"}</p>
        <p>рддреЗрдЬреА рд╕реЗ рдмрд┐рдХрдиреЗ рд╡рд╛рд▓реЗ рд╕рд╛рдорд╛рди: <b>${fast}</b></p>
        <p>рдлрдБрд╕рд╛ рд╣реБрдЖ рд╕реНрдЯреЙрдХ: <b>${dead}</b></p>
      </div>
    </div>
  `;
}
            
            /* =============== SECTION 2 =============== */
            function renderCustomerIntel(data){
  const el=document.getElementById("ai-customer-content");

  let html="";

  data.customers.forEach(c=>{

    // рд╕рдмрд╕реЗ рдЬреНрдпрд╛рджрд╛ рдЦрд░реАрджреА рдЧрдИ рд╡рд╕реНрддреБ рдвреВрдВрдвреЗрдВ
    let topItem = "-";
    let topCount = 0;
    c.items.forEach(it=>{
      if(it.buy_count > topCount){
        topItem = it.name;
        topCount = it.buy_count;
      }
    });

    html+=`
      <div class="ai-card-alert ai-alert-info">
        <div>
          <b>${c.name}</b><br>
          рдЖрдЦрд░реА рдЦрд░реАрдж: ${c.last_buy ? c.last_buy.split("T")[0] : "тАФ"}<br>
          рд╕рдмрд╕реЗ рдЬреНрдпрд╛рджрд╛ рдЦрд░реАрджрд╛: <b>${topItem}</b>
        </div>
        <span class="ai-badge ai-badge-blue">${c.items.length} рдкреНрд░реЛрдбрдХреНрдЯреНрд╕</span>
      </div>
    `;
  });

  html += `<p class='text-muted-small'>рд╕рд▓рд╛рд╣: рдЯреЙрдк рдЧреНрд░рд╛рд╣рдХреЛрдВ рдХреЛ 2% рдбрд┐рд╕реНрдХрд╛рдЙрдВрдЯ рдСрдлрд╝рд░ рднреЗрдЬреЗрдВред</p>`;
  el.innerHTML=html;
}

            
            /* =============== SECTION 3 =============== */
            function renderProductIntel(pData, stockData){
  const el=document.getElementById("ai-product-content");
  let html="";

  const fast = stockData.insights.fast_moving;
  const dead = stockData.insights.dead_stock;

  if(fast.length){
    html+=`<h4>ЁЯЪА рддреЗрдЬрд╝реА рд╕реЗ рдмрд┐рдХрдиреЗ рд╡рд╛рд▓реЗ рдкреНрд░реЛрдбрдХреНрдЯ</h4>`;
    fast.forEach(f=>{
      html+=`
        <div class="ai-card-alert ai-alert-warning">
          <div><b>${f.title}</b><br>${f.text}</div>
        </div>`;
    });
  }

  if(dead.length){
    html+=`<h4>ЁЯЫС рди рдмрд┐рдХрдиреЗ рд╡рд╛рд▓рд╛ (Dead) рд╕реНрдЯреЙрдХ</h4>`;
    dead.forEach(d=>{
      html+=`
        <div class="ai-card-alert ai-alert-danger">
          <div><b>${d.title}</b><br>${d.text}</div>
        </div>`;
    });
  }

  if(!fast.length && !dead.length){
    html+="<p>рд╕рднреА рдкреНрд░реЛрдбрдХреНрдЯ рд╕рд╛рдорд╛рдиреНрдп рдкреНрд░рджрд░реНрд╢рди рдХрд░ рд░рд╣реЗ рд╣реИрдВред</p>";
  }

  el.innerHTML=html;
}
            
            /* =============== SECTION 4 =============== */
            function renderFestivalStrategy(pData){
  const el=document.getElementById("ai-festival-content");

  const month = new Date().getMonth()+1;
  let festival = "рдЖрдиреЗ рд╡рд╛рд▓рд╛ рддреНрдпреМрд╣рд╛рд░";

  if(month===10) festival="рджреАрд╡рд╛рд▓реА";
  if(month===3) festival="рд╣реЛрд▓реА";
  if(month===12) festival="рдирдпрд╛ рд╕рд╛рд▓";

  el.innerHTML=`
    <div class="ai-card-alert ai-alert-info">
      <div>
        <b>${festival} рд╡рд┐рд╢реЗрд╖ рд░рдгрдиреАрддрд┐</b><br>
        тАв рддреЗрдЬрд╝реА рд╕реЗ рдмрд┐рдХрдиреЗ рд╡рд╛рд▓рд╛ рд╕реНрдЯреЙрдХ рдмрдврд╝рд╛рдПрдБ<br>
        тАв WhatsApp рдкрд░ 10% OFF рдХреВрдкрди рднреЗрдЬреЗрдВ<br>
        тАв Dead stock рдкрд░ Buy 1 Get 1 рдСрдлрд░ рд░рдЦреЗрдВ
      </div>
    </div>`;
}
            
            /* =============== SECTION 5 =============== */
            function renderMarketingIdeas(pData){
  const el=document.getElementById("ai-marketing-content");

  el.innerHTML = `
    <div class="ai-card-alert ai-alert-info">
      <div>
        <b>рдЗрд╕ рд╕рдкреНрддрд╛рд╣ рдХреА рдорд╛рд░реНрдХреЗрдЯрд┐рдВрдЧ рд░рдгрдиреАрддрд┐</b><br>
        тАв Fast Moving items рдХрд╛ Reel рдмрдирд╛рдПрдВ<br>
        тАв Dead Stock рдкрд░ тАЬрдзреАрдореА рдХреАрдорддреЗрдВтАЭ рдкреЛрд╕реНрдЯ рдХрд░реЗрдВ<br>
        тАв рд╣рд░ рджреВрд╕рд░реЗ рджрд┐рди рдПрдХ рдЫреЛрдЯрд╛ рдРрдб рдЪрд▓рд╛рдПрдБ<br>
      </div>
    </div>
    <p class="text-muted-small">AI рд╕реБрдЭрд╛рд╡: рд╢рд╛рдо 6тАУ9 рдмрдЬреЗ рдкреЛрд╕реНрдЯ рдХрд░реЗрдВред</p>
  `;
}
            
            /* =============== SECTION 6 =============== */
            function renderPrediction(data){
  const el=document.getElementById("ai-prediction-content");

  const labels = data.sales.map(r=>r.day);
  const values = data.sales.map(r=>Number(r.total_sales));

  el.innerHTML=`<canvas id="salesPredictionChart" class="ai-chart"></canvas>`;
  const ctx=document.getElementById("salesPredictionChart").getContext("2d");

  new Chart(ctx,{
    type:"line",
    data:{
      labels:labels,
      datasets:[{
        label:"рдкрд┐рдЫрд▓реЗ 30 рджрд┐рдиреЛрдВ рдХреА рдмрд┐рдХреНрд░реА",
        data:values,
        borderColor:"#007bff",
        backgroundColor:"rgba(0,123,255,0.1)",
        fill:true,
        tension:0.3
      }]
    },
    options:{ plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });
}

function renderWhatsappAdvisor(data){
  const el = document.getElementById("ai-marketing-content");

  let html = `<h4>ЁЯУ▓ WhatsApp рдСрдЯреЛ рдореИрд╕реЗрдЬрд┐рдВрдЧ</h4>`;

  data.clients.forEach(c => {
    const last = c.last_purchase ? c.last_purchase.split("T")[0] : "тАФ";
    const inactiveDays = c.last_purchase ? 
        Math.floor((Date.now() - new Date(c.last_purchase)) / (1000*60*60*24)) : 999;

    // Personalized Message
    let msg = `рдирдорд╕реНрддреЗ ${c.name}, 
рдЖрдкрдХреА рдкрд┐рдЫрд▓реА рдЦрд░реАрджреА (${c.last_item || "тАФ"}) рдХреЛ рдХрд╛рдлрд╝реА рд╕рдордп рд╣реЛ рдЧрдпрд╛ рд╣реИред 
рдЖрдЬ рдЖрдкрдХреЗ рд▓рд┐рдП 5% рд╡рд┐рд╢реЗрд╖ рдЫреВрдЯ рдЙрдкрд▓рдмреНрдз рд╣реИред 
рдЕрдЧрд░ рдЖрдкрдХреЛ рдХреБрдЫ рдЪрд╛рд╣рд┐рдП рддреЛ рд░рд┐рдкреНрд▓рд╛рдИ рдХрд░реЗрдВред`;

    html += `
      <div class="ai-card-alert ai-alert-info">
        <div>
            <b>${c.name}</b> (${c.phone || "рдирдВрдмрд░ рдирд╣реАрдВ"})
            <br>рдЖрдЦрд╝рд░реА рдЦрд░реАрджреА: ${last}
            <br>Inactive: <b>${inactiveDays} рджрд┐рди</b>
        </div>
        <button 
            onclick="sendWhatsapp('${c.phone}','${encodeURIComponent(msg)}')"
            class="ai-refresh-btn"
            style="padding:6px 12px;font-size:0.8rem;">
            WhatsApp рднреЗрдЬреЗрдВ
        </button>
      </div>
    `;
  });

  el.innerHTML = html + `
    <p class='text-muted-small'>
    AI рд╕реБрдЭрд╛рд╡: Inactive рдЧреНрд░рд╛рд╣рдХреЛрдВ рдХреЛ рд╣рд▓реНрдХрд╛ рдСрдлрд╝рд░ рджреЗрдирд╛ рд╕рдмрд╕реЗ рдЕрдЪреНрдЫреЗ results рджреЗрддрд╛ рд╣реИред
    </p>
  `;
}


function renderCustomerProbability(data){
  const el = document.getElementById("ai-customer-content");

  let html = `<h4>ЁЯФе рдЧреНрд░рд╛рд╣рдХ рдЦрд░реАрджрдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ (AI Prediction)</h4>`;

  data.customers.forEach(c => {

    const color = c.probability >= 70 ? "ai-badge-green" :
                  c.probability >= 40 ? "ai-badge-yellow" :
                  "ai-badge-red";

    const msg = `рдирдорд╕реНрддреЗ ${c.name}, рдЖрдкрдХреЛ ${c.frequent_item} рдкрд░ ${
        c.offer.includes("%") ? "рд╡рд┐рд╢реЗрд╖ "+c.offer : ""
    } рдСрдлрд╝рд░ рдЙрдкрд▓рдмреНрдз рд╣реИред`;

    html += `
      <div class="ai-card-alert ai-alert-info">
        <div>
           <b>${c.name}</b><br>
           рдЖрдЦрд░реА рдЦрд░реАрджреА: ${c.last_purchase ? c.last_purchase.split("T")[0] : "тАФ"}<br>
           рдкрд╕рдВрджреАрджрд╛ рд╕рд╛рдорд╛рди: <b>${c.frequent_item || "тАФ"}</b><br>
           рд╕рд▓рд╛рд╣: ${c.offer}
        </div>

        <div style="text-align:right;">
          <span class="ai-badge ${color}" style="margin-bottom:5px;">
            ${c.probability}% рд╕рдВрднрд╛рд╡рдирд╛
          </span>
          <br>
          <button 
            onclick="sendWhatsapp('${c.phone}', '${encodeURIComponent(msg)}')"
            class="ai-refresh-btn"
            style="padding:6px 10px;font-size:0.8rem;">
            WP рднреЗрдЬреЗрдВ
          </button>
        </div>
      </div>
    `;
  });

  el.innerHTML = html + `
    <p class="text-muted-small">
      AI рд╕реБрдЭрд╛рд╡: High-probability рдЧреНрд░рд╛рд╣рдХреЛрдВ рдХреЛ рд╣рд▓реНрдХрд╛ рдСрдлрд╝рд░ рджреЗрдВред
    </p>`;
}


function sendWhatsapp(phone, msg){
  if(!phone || phone=="null"){
    return alert("рдЗрд╕ рдЧреНрд░рд╛рд╣рдХ рдХрд╛ рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░ рд╕реЗрд╡ рдирд╣реАрдВ рд╣реИред");
  }
  window.open(`https://wa.me/91${phone}?text=${msg}`, "_blank");
}


function renderMonthlyStrategy(data){
  const el = document.getElementById("ai-festival-content");
  if(!data || !data.success){
    el.innerHTML = `<div class="ai-card-alert ai-alert-danger">рдорд╣реАрдиреЗ рдХреА рд░рдгрдиреАрддрд┐ рд▓реЛрдб рдирд╣реАрдВ рд╣реЛ рд╕рдХреАред</div>`;
    return;
  }

  const d = data;
  const topCats = (d.top_categories || []).map(t=>`${t.category} (тВ╣${t.revenue})`).join(', ') || 'тАФ';
  const fastList = (d.fast_movers || []).slice(0,6).map(f=>`${f.name} (${f.current_qty} stk)`).join(', ') || 'тАФ';
  const deadList = (d.dead_stock || []).slice(0,6).map(x=>`${x.name} (${x.current_qty})`).join(', ') || 'тАФ';

  let html = `
    <div class="ai-card">
      <h4>ЁЯУЕ ${d.month} / ${d.year} рдХреЗ рд▓рд┐рдП рд╕рдВрдХреНрд╖реЗрдк рд░рдгрдиреАрддрд┐</h4>
      <p><b>рдЕрдиреБрдорд╛рдирд┐рдд рдорд╛рд╕рд┐рдХ рдмрд┐рдХреНрд░реА:</b> тВ╣${d.forecast_month_amount}</p>
      <p><b>рджрд┐рди рдХрд╛ рдФрд╕рдд рдмрд┐рдХреНрд░реА (рдкрд┐рдЫрд▓реЗ 30d):</b> тВ╣${d.avg_daily_sales}</p>
      <p><b>рдореБрдЦреНрдп рдХреИрдЯреЗрдЧрд░реА (Top):</b> ${topCats}</p>
      <p><b>рддреЗрдЬрд╝реА рд╕реЗ рдмрд┐рдХрдиреЗ рд╡рд╛рд▓реЗ (Top):</b> ${fastList}</p>
      <p><b>Dead stock (рдирд┐рдХрд▓рд╡рд╛рдиреЗ рдХреЗ рд▓рд┐рдП):</b> ${deadList}</p>
      <hr>
      <h5>ЁЯУг Campaign Calendar (Weekly)</h5>
      <ul>
        ${ (d.campaign_calendar || []).map(c => `<li><b>Week ${c.week}:</b> ${c.action}</li>`).join('') }
      </ul>
      <hr>
      <h5>ЁЯОЙ рддреНрдпреЛрд╣рд╛рд░</h5>
      <p>${ (d.festivals && d.festivals.length) ? d.festivals.join(', ') : 'рдХреЛрдИ рдкреНрд░рдореБрдЦ рддреНрдпреМрд╣рд╛рд░ рдирд╣реАрдВ' }</p>

      <h5>ЁЯФз Reorder рд╕реБрдЭрд╛рд╡ (Top 6)</h5>
      <table class="ai-mini-table">
        <thead><tr><th>Item</th><th>Current</th><th>Suggest</th></tr></thead>
        <tbody>
          ${ (d.reorder || []).slice(0,6).map(r => `<tr><td>${r.name}</td><td>${r.current_qty}</td><td>${r.suggested_reorder}</td></tr>`).join('') }
        </tbody>
      </table>

      <hr>
      <p><b>AI рд╕реБрдЭрд╛рд╡ тАФ рд╕рдВрдХреНрд╖реЗрдк:</b><br> ${ (d.strategy_text || '').replace(/\n/g,'<br>') }</p>
    </div>
  `;

  el.innerHTML = html;
}


    



          
async function renderFestivalStrategy() {
  const box = document.getElementById('ai-festival-content');
  if (!box) return;
  box.innerHTML = `
    <div style="padding:30px; text-align:center;">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2">рддреНрдпреЛрд╣рд╛рд░ рд░рдгрдиреАрддрд┐ рддреИрдпрд╛рд░ рдХреА рдЬрд╛ рд░рд╣реА рд╣реИ...</p>
    </div>
  `;

  try {
    const res = await fetchApi('/api/ai/festival-strategy', { method: 'GET' });
    if (!res || !res.success) {
      box.innerHTML = `<div class="alert alert-warning">${(res && res.message) ? res.message : 'рддреАрд░реНрде рдбреЗрдЯрд╛ рдЙрдкрд▓рдмреНрдз рдирд╣реАрдВ рд╣реИред'}</div>`;
      return;
    }

    const festivals = res.festivals || [];
    if (!festivals.length) {
      box.innerHTML = `<div class="p-3">рдХреЛрдИ festival data рдЙрдкрд▓рдмреНрдз рдирд╣реАрдВ рд╣реИред</div>`;
      return;
    }

    // Build HTML
    let html = `<div class="festival-grid" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:16px;">`;

    festivals.forEach(f => {
      html += `
        <div class="card" style="padding:15px; border-radius:8px; box-shadow:var(--card-shadow); background:#fff;">
          <h5 style="margin:0 0 6px 0;">${f.name} тАФ Next: ${f.nextDate}</h5>
          <p style="margin:0 0 8px 0; color:#666; font-size:0.9rem;">Top products (by festival lift)</p>
          <div style="font-size:0.9rem; color:#333; line-height:1.4;">
            ${ (f.topProducts && f.topProducts.length) ? f.topProducts.slice(0,6).map(p => `
              <div style="padding:6px 0; border-bottom:1px dashed #eee;">
                <b>${shortText(p.name || p.sku, 33)}</b><br>
                lift: ${p.liftPercent}% тАв estRevenue: тВ╣${p.revenue} тАв samples:${p.samples}
              </div>
            `).join('') : `<div style="color:#888">No clear winners</div>` }
          </div>

          <div style="margin-top:10px; font-size:0.9rem; color:#444;">
            <b>Suggestions:</b>
            <pre style="white-space:pre-wrap; font-family:inherit; font-size:0.9rem; background:#f8f9fa; padding:8px; border-radius:6px;">${f.recommendationText || 'No suggestions'}</pre>
          </div>

          <div style="display:flex; gap:8px; margin-top:10px;">
            <button class="btn btn-sm btn-primary" onclick='createWhatsAppCampaign(${JSON.stringify(f.suggestions || []).replace(/'/g,"\\'")})'>WhatsApp Campaign</button>
            <button class="btn btn-sm btn-outline-secondary" onclick='showPurchasePlan(${JSON.stringify(f.suggestions || []).replace(/'/g,"\\'")})'>Purchase Plan</button>
          </div>
        </div>
      `;
    });

    html += `</div>`;
    box.innerHTML = html;

  } catch (err) {
    box.innerHTML = `<div class="alert alert-danger">рдПрд░рд░: ${err.message}</div>`;
  }
}

// small helper for UI
function shortText(s, n=40){ if(!s) return ''; return (s.length>n)? s.slice(0,n-1)+'тАж':s; }

// Action handlers (example - frontend helpers)
function createWhatsAppCampaign(suggestions) {
  // suggestions = [{sku, suggestedQty, liftPercent, revenue}, ...]
  // Build a simple message and open wa share (demo)
  if(!suggestions || !suggestions.length) {
    alert('рдХреЛрдИ рд╕реБрдЭрд╛рд╡ рдЙрдкрд▓рдмреНрдз рдирд╣реАрдВред');
    return;
  }
  const top = suggestions[0];
  const msg = `Special Offer: рдЗрд╕ ${top.sku} рдкрд░ рд╕реАрдорд┐рдд рд╕рдордп рдХреЗ рд▓рд┐рдП рдСрдлрд╝рд░ рд░рдЦреЗрдВ тАФ рд╕рд┐рд░реНрдл ${top.suggestedQty} рдпреВрдирд┐рдЯ рд░реЗрдХреЛрдореЗрдВрдб рдХрд┐рдП рдЧрдПред рдЬрд▓реНрджреА рдЖрдЗрдП!`;
  // For demo: open WhatsApp (phone number optional) - user will edit before send
  const waUrl = `https://web.whatsapp.com/send?text=${encodeURIComponent(msg)}`;
  window.open(waUrl, '_blank');
}

function showPurchasePlan(suggestions) {
  if(!suggestions || !suggestions.length) {
    alert('рдХреЛрдИ рд╕реБрдЭрд╛рд╡ рдЙрдкрд▓рдмреНрдз рдирд╣реАрдВред');
    return;
  }
  let txt = 'Suggested purchase plan (1-week buffer):\n\n';
  suggestions.forEach(s =>{
    txt += `SKU:${s.sku} тЖТ Qty: ${s.suggestedQty} (lift:${s.liftPercent}%)\n`;
  });
  alert(txt);
}

// Optionally call this on load of AI insights (if you have a global loader)
document.querySelector('[data-view="ai-insights"]')?.addEventListener('click', () => {
  // When AI Insights tab clicked, also render festival strategy
  // (you might already call renderAiInsightsV2; ensure this is included)
  renderFestivalStrategy();
});




async function renderMarketingAI() {
  const box = document.getElementById('ai-marketing-content');
  if (!box) return;
  box.innerHTML = `
    <div style="padding:30px; text-align:center;">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2">Marketing & Ads ideas рддреИрдпрд╛рд░ рдХрд┐рдП рдЬрд╛ рд░рд╣реЗ рд╣реИрдВ...</p>
    </div>
  `;

  try {
    const res = await fetchApi('/api/ai/marketing-ads', { method: 'GET' });
    if (!res || !res.success) {
      box.innerHTML = `<div class="alert alert-warning">${res && res.message ? res.message : 'No marketing data'}</div>`;
      return;
    }

    const { topProducts, segments, adIdeas, timeframeDays } = res;
    let html = `<div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:12px;">`;

    // Left: Top Products
    html += `<div class="card" style="padding:12px;">
      <h5>Top Products (last ${timeframeDays} days)</h5>
      <ul style="padding-left:16px;">${
        (topProducts && topProducts.length) ? topProducts.slice(0,8).map(p=>`<li><b>${shortText(p.name,40)}</b> тАФ sold: ${p.qty} тАв rev: тВ╣${p.revenue} тАв avg/day: ${p.avgPerDay}</li>`).join('') : '<li>No data</li>'
      }</ul>
    </div>`;

    // Middle: Segments
    html += `<div class="card" style="padding:12px;">
      <h5>Customer Segments</h5>
      <p><b>Top customers:</b> ${segments.topCustomers.map(c=>shortText(c.name||'тАФ',20)).join(', ') || 'тАФ'}</p>
      <p><b>At-risk (inactive):</b> ${segments.atRisk.map(c=>shortText(c.name||'тАФ',20)).join(', ') || 'тАФ'}</p>
      <button class="btn btn-sm btn-primary" onclick="openSegmentDialog()">View segments</button>
    </div>`;

    // Right: Ad Ideas
    html += `<div class="card" style="padding:12px;">
      <h5>Ad Ideas & Campaigns</h5>
      ${adIdeas.map((a,idx)=>`
        <div style="margin-bottom:8px; padding:8px; border-radius:6px; background:#f8f9fa;">
          <b>${a.title}</b>
          <p style="margin:6px 0;">${shortText(a.script || '', 140)}</p>
          <small>Budget тЙИ тВ╣${a.budgetSuggestion} тАв expected uplift тЙИ ${a.expectedUpliftPercent}%</small>
          <div style="margin-top:8px; display:flex; gap:8px;">
            <button class="btn btn-sm btn-outline-secondary" onclick='copyText(${JSON.stringify(a.script).replace(/'/g,"\\'")})'>Copy Script</button>
            <button class="btn btn-sm btn-primary" onclick='openWhatsAppForAd(${JSON.stringify(a.script).replace(/'/g,"\\'")})'>Open WhatsApp</button>
            <button class="btn btn-sm btn-success" onclick='createAdCampaign(${JSON.stringify(a).replace(/'/g,"\\'")})'>Create Campaign</button>
          </div>
        </div>
      `).join('')}
    </div>`;

    html += `</div>`;
    box.innerHTML = html;

    // helper small UI functions (ensure these declared globally once)
    window.shortText = (s,n=60) => { if(!s) return ''; return s.length>n? s.slice(0,n-1)+'тАж': s; };
    window.copyText = txt => {
      navigator.clipboard?.writeText(txt).then(()=> alert('Script copied to clipboard'));
    };
    window.openWhatsAppForAd = (txt) => {
      const url = `https://web.whatsapp.com/send?text=${encodeURIComponent(txt)}`;
      window.open(url,'_blank');
    };
    window.createAdCampaign = (idea) => {
      // Simple demo: store campaign in localStorage or call backend (optional)
      const campaigns = JSON.parse(localStorage.getItem('dp_campaigns' || '[]') || '[]');
      campaigns.push({ idea, created_at: new Date().toISOString() });
      localStorage.setItem('dp_campaigns', JSON.stringify(campaigns));
      alert('Campaign created (demo). Use Campaigns page to review.');
    };

  } catch (err) {
    box.innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
  }
}






async function renderLossFinder() {
  const box = document.getElementById('ai-loss-content');
  if (!box) return;

  box.innerHTML = `
    <div style="padding:24px; text-align:center;">
      <div class="spinner-border text-danger" role="status"></div>
      <p class="mt-2">рдиреБрдХрд╕рд╛рди рдХреА рд░рд┐рдкреЛрд░реНрдЯ рддреИрдпрд╛рд░ рдХреА рдЬрд╛ рд░рд╣реА рд╣реИ...</p>
    </div>
  `;

  try {
    const res = await fetchApi('/api/ai/loss-finder', { method: 'GET' });
    if (!res || !res.success) {
      box.innerHTML = `<div class="alert alert-warning">${res && res.message ? res.message : 'Loss Finder рдбреЗрдЯрд╛ рдирд╣реАрдВ рдорд┐рд▓рд╛ред'}</div>`;
      return;
    }

    const s = res.summary || {};
    const rateMistakes = res.rate_mistakes_24h || [];
    const deadStock = res.dead_stock || [];
    const lowMargin = res.low_margin_items || [];
    const excess = res.excess_stock || [];
    const riskyCust = res.risky_customers || [];

    // SUMMARY TOP
    let html = `
      <div class="row g-3">
        <div class="col-md-4">
          <div class="card p-3 border-danger">
            <h6 class="text-danger mb-1">рдкрд┐рдЫрд▓реЗ 24 рдШрдВрдЯреЗ рдХрд╛ рдЕрдиреБрдорд╛рдирд┐рдд рдиреБрдХрд╕рд╛рди</h6>
            <h3 class="mb-0">тВ╣${s.rate_mistake_loss_24h || 0}</h3>
            <small>рдЧрд▓рдд rate / рдЧрд▓рдд billing рд╕реЗ</small>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3 border-warning">
            <h6 class="text-warning mb-1">Dead Stock рдореЗрдВ рдлрдБрд╕рд╛ рдкреИрд╕рд╛</h6>
            <h3 class="mb-0">тВ╣${s.dead_stock_locked_value || 0}</h3>
            <small>30+ рджрд┐рди рд╕реЗ рди рдмрд┐рдХрдиреЗ рд╡рд╛рд▓рд╛ stock</small>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3 border-info">
            <h6 class="text-info mb-1">рдЙрдзрд╛рд░ рдкрд░ рдЕрдЯрдХрд╛ рд╣реБрдЖ рдкреИрд╕рд╛</h6>
            <h3 class="mb-0">тВ╣${s.risky_customers_outstanding || 0}</h3>
            <small>${s.risky_customers_count || 0} risky рдЧреНрд░рд╛рд╣рдХ</small>
          </div>
        </div>
      </div>

      <hr class="my-3">

      <div class="row g-3">
        <div class="col-md-6">
          <h5>Rate Mistake (рдкрд┐рдЫрд▓реЗ 24 рдШрдВрдЯреЗ)</h5>
          <div style="max-height:220px; overflow:auto; font-size:0.9rem;">
            ${
              rateMistakes.length
              ? rateMistakes.map(r => `
                <div style="padding:6px 0; border-bottom:1px dashed #eee;">
                  <b>${r.item_name}</b> (SKU: ${r.sku || '-'})<br>
                  Qty: ${r.qty} тАв P: тВ╣${r.purchase_price} тАв S: тВ╣${r.sale_price}<br>
                  <span class="text-danger">Loss тЙИ тВ╣${r.loss}</span>
                </div>
              `).join('')
              : `<div class="text-muted">рдкрд┐рдЫрд▓реЗ 24 рдШрдВрдЯреЗ рдореЗрдВ рдХреЛрдИ rate mistake detect рдирд╣реАрдВ рд╣реБрдИред</div>`
            }
          </div>
        </div>

        <div class="col-md-6">
          <h5>Dead Stock (30+ рджрд┐рди рд╕реЗ рдирд╣реАрдВ рдмрд┐рдХрд╛)</h5>
          <div style="max-height:220px; overflow:auto; font-size:0.9rem;">
            ${
              deadStock.length
              ? deadStock.map(d => `
                <div style="padding:6px 0; border-bottom:1px dashed #eee;">
                  <b>${d.name}</b> (SKU: ${d.sku || '-'})<br>
                  Qty: ${d.qty} тАв Value: тВ╣${d.stock_value}<br>
                  Last Sold: ${d.last_sold_date || 'рдХрднреА рдирд╣реАрдВ'}
                </div>
              `).join('')
              : `<div class="text-muted">рдЕрднреА рдХреЛрдИ рдмрдбрд╝рд╛ dead stock рдирд╣реАрдВ рджрд┐рдЦ рд░рд╣рд╛ред</div>`
            }
          </div>
        </div>
      </div>

      <hr class="my-3">

      <div class="row g-3">
        <div class="col-md-6">
          <h5>Low / Zero Profit Items</h5>
          <div style="max-height:220px; overflow:auto; font-size:0.9rem;">
            ${
              lowMargin.length
              ? lowMargin.map(i => `
                <div style="padding:6px 0; border-bottom:1px dashed #eee;">
                  <b>${i.name}</b> (SKU: ${i.sku || '-'})<br>
                  Avg P: тВ╣${i.avg_purchase} тАв Avg S: тВ╣${i.avg_sale}<br>
                  Margin тЙИ ${i.margin_percent}% тАв Sold Qty: ${i.total_qty}
                </div>
              `).join('')
              : `<div class="text-muted">рдХреЛрдИ clear low-margin item detect рдирд╣реАрдВ рд╣реБрдЖред</div>`
            }
          </div>
        </div>

        <div class="col-md-6">
          <h5>Risky Customers (High Outstanding)</h5>
          <div style="max-height:220px; overflow:auto; font-size:0.9rem;">
            ${
              riskyCust.length
              ? riskyCust.map(c => `
                <div style="padding:6px 0; border-bottom:1px dashed #eee;">
                  <b>${c.name}</b> тАв тВ╣${c.balance}<br>
                  ${c.mobile ? `ЁЯУЮ ${c.mobile}` : ''}
                  <button class="btn btn-sm btn-outline-primary ms-2" onclick="openWhatsAppForDue('${(c.mobile||'').replace(/'/g,'')}', '${c.name.replace(/'/g,'')}', ${c.balance})">
                    WhatsApp Reminder
                  </button>
                </div>
              `).join('')
              : `<div class="text-muted">рдХреЛрдИ high-risk рдЙрдзрд╛рд░ customer рдирд╣реАрдВ рдорд┐рд▓рд╛ред</div>`
            }
          </div>
        </div>
      </div>
    `;

    box.innerHTML = html;

  } catch (err) {
    box.innerHTML = `<div class="alert alert-danger">Loss Finder Error: ${err.message}</div>`;
  }
}




// (B) Fetch + render functions
async function fetchCustomerTargeting() {
  try {
    const res = await fetchApi('/api/ai/customer-targeting', { method: 'GET' });
    if (!res.success) throw new Error(res.message || 'No data');
    return res.customers || [];
  } catch (e) {
    console.error('fetchCustomerTargeting error', e);
    return [];
  }
}

function renderCustomerTargeting(customers) {
  const el = document.getElementById('ai-customer-targeting-content');
  if (!customers || !customers.length) {
    el.innerHTML = `<div class="ai-card-alert ai-alert-danger">рдХреЛрдИ рдЯрд╛рд░реНрдЧреЗрдЯ рд╕реБрдЭрд╛рд╡ рдЙрдкрд▓рдмреНрдз рдирд╣реАрдВред</div>`;
    return;
  }

  let html = '';
  // top 10 customers by probability
  customers.slice(0, 10).forEach(c => {
    html += `
      <div class="ai-card-alert ${c.will_return_soon ? 'ai-alert-success' : 'ai-alert-info'}">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <b>${c.name}</b> ${c.phone ? `<small>(${c.phone})</small>` : ''}
            <div class="text-muted-small">Last: ${c.last_purchase || 'тАФ'} (${c.days_since_last === null ? 'тАФ' : c.days_since_last + 'd'})</div>
            <div class="text-muted-small">Top: ${c.top_items.map(t=>t.name).join(', ') || 'тАФ'}</div>
          </div>
          <div style="text-align:right;">
            <div class="ai-badge ai-badge-blue">Score: ${c.probability_score}</div>
            <div style="margin-top:6px;">
              <a class="btn btn-sm btn-outline-primary" href="https://wa.me/${c.phone.replace(/[^0-9]/g,'') || ''}?text=${encodeURIComponent(c.suggested_message)}" target="_blank">WhatsApp рднреЗрдЬреЗрдВ</a>
            </div>
          </div>
        </div>
      </div>
    `;
  });

  el.innerHTML = html;
}










// WhatsApp reminder helper (global)
function openWhatsAppForDue(mobile, name, amount){
  if(!mobile){
    alert('рдЗрд╕ customer рдХрд╛ рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░ рд╕реЗрд╡ рдирд╣реАрдВ рд╣реИред');
    return;
  }
  const msg = `Namaste ${name},\\n\\nAapka approximate baki rakam: тВ╣${amount}. Kripya apne suvidha anusar jama kar dijiye. Dhanyavaad.`;
  const url = `https://wa.me/91${mobile}?text=${encodeURIComponent(msg)}`;
  window.open(url, '_blank');
}





async function saveShopSettings() {
  // existing settings code...
  const bt = document.getElementById('shop-business-type').value;
  await fetchApi('/api/shop/set-business-type', { method:'POST', body: { business_type: bt }});
  // show success
}


async function saveCustomer() {
  const name = document.getElementById('cust-name').value;
  const phone = document.getElementById('cust-phone').value;
  const address = document.getElementById('cust-address').value;
  const dob = document.getElementById('cust-dob').value || null;

  const res = await fetchApi('/api/customers', {
    method:'POST',
    body: { name, phone, address, dob }
  });

  if(res.success) {
    showMessage('рдЧреНрд░рд╛рд╣рдХ рдЬреБрдбрд╝ рдЧрдпрд╛');
    // refresh customers
    fetchAndRenderCustomers();
  } else {
    showMessage('Error: '+res.message,'danger');
  }
}


// [ тЬЕ FIXED: ULTRA-PRO Universal Business UI Applicator - ALL 31 TYPES ]
// рдпрд╣ рдХреЛрдб рдЖрдкрдХреЗ рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ рд╡рд╛рд▓реЗ рд╕рднреА 31 рдмрд┐рдЬрдиреЗрд╕ рдЯрд╛рдЗрдкреНрд╕ рдХреЛ рд╕рдкреЛрд░реНрдЯ рдХрд░рддрд╛ рд╣реИред
function applyBusinessTypeUI(btype) {
    console.log("Applying UI for Business Type:", btype);

    // 1. рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рд╕рднреА рд╕реНрдкреЗрд╢рд▓ рдмрд┐рдЬрдиреЗрд╕ рд╡рд╛рд▓реЗ рд╕реЗрдХреНрд╢рди/рдмрдЯрди рдФрд░ рдореЙрдбреНрдпреВрд▓ рдЫреБрдкрд╛ рджреЗрдВ (Global Reset)
    document.querySelectorAll('.biz-module').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.paint-only, .salon-only, .mobile-only, .medical-only, .restaurant-only').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.input-group-special').forEach(el => el.style.display = 'none');

    // 2. MASTER CONFIG рд╕реЗ рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рд▓рд╛рдПрдВ
    const config = (typeof MASTER_BUSINESS_CONFIG !== 'undefined') ? MASTER_BUSINESS_CONFIG[btype] : null;

    if (!config) {
        console.warn(`Unknown Business Type: ${btype}. Defaulting to Retail view.`);
        return; 
    }

    // 3. рд▓реЗрдмрд▓реНрд╕ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ
    const custLabel = document.querySelector('label[for="pos-customer"]');
    if (custLabel) custLabel.innerText = config.labels.customer || "рдЧреНрд░рд╛рд╣рдХ рдХрд╛ рдирд╛рдо";
    
    const stockQtyLabel = document.querySelector('label[for="stock-quantity"]');
    if(stockQtyLabel) stockQtyLabel.innerText = `рдорд╛рддреНрд░рд╛ (${config.labels.stock || 'Qty'})`;

    // 4. рдлреАрдЪрд░реНрд╕ рдХреА рд▓рд┐рд╕реНрдЯ рдирд┐рдХрд╛рд▓реЗрдВ
    const features = config.features || [];

    // ============================================================
    // ЁЯПЧя╕П MODULE ACTIVATION LOGIC
    // ============================================================

    // --- GROUP 3: HARDWARE & PAINT LOGIC ---
    if (btype === 'PAINT_SHOP') {
        document.querySelectorAll('.paint-only').forEach(el => el.style.display = 'block');
        if(document.getElementById('module-paint-mixer')) document.getElementById('module-paint-mixer').style.display = 'block';
        if(document.getElementById('module-paint-estimator')) document.getElementById('module-paint-estimator').style.display = 'block';
        if (typeof loadPainters === 'function') loadPainters();
        if (typeof fetchAndRenderPaintHistory === 'function') fetchAndRenderPaintHistory();
    } 
    else if (btype === 'HARDWARE_GENERAL') {
        document.querySelectorAll('.paint-only').forEach(el => el.style.display = 'none');
        if(document.getElementById('module-paint-mixer')) document.getElementById('module-paint-mixer').style.display = 'none';
        if(document.getElementById('module-paint-estimator')) document.getElementById('module-paint-estimator').style.display = 'none';

        if(document.getElementById('module-furniture-showroom')) {
            document.getElementById('module-furniture-showroom').style.display = 'block';
            if(typeof loadDeliveryList === 'function') {
                setTimeout(loadDeliveryList, 1000); 
            }
        }

        if(document.getElementById('hardware-delivery-box')) {
            document.getElementById('hardware-delivery-box').style.display = 'block';
        }

        const godBox = document.getElementById('pos-god-mode-delivery');
        if (godBox) godBox.style.display = 'block';
    }

    // Mobile, Electronics, SIM Store
    if (features.includes('imei_scan')) {
        if(document.getElementById('module-imei-scan')) document.getElementById('module-imei-scan').style.display = 'block';
        const searchInput = document.getElementById('pos-item-search');
        if(searchInput) searchInput.placeholder = "рдЖрдЗрдЯрдо рдХрд╛ рдирд╛рдо, SKU рдпрд╛ IMEI рд╕реНрдХреИрди рдХрд░реЗрдВ...";
    }

    // Furniture Showroom
    if (features.includes('delivery_tracking')) {
        if(document.getElementById('module-furniture-showroom')) document.getElementById('module-furniture-showroom').style.display = 'block';
    }

    // Sweet Shop (Expiry logic handled in stock form)

    // --- GROUP 2: MEDICAL & HEALTH ---
    if (features.includes('prescription_pad') || features.includes('report_templates')) {
        const medMod = document.getElementById('module-prescription-pad');
        if(medMod) {
            medMod.style.display = 'block';
            const titleEl = document.getElementById('medical-title-text');
            if(titleEl) titleEl.innerText = config.name + " Report";
        }
        if(typeof setupDoctorDashboard === 'function') setupDoctorDashboard(btype);
    }

    if (features.includes('tooth_chart')) {
        const teethBox = document.getElementById('box-dentist-chart');
        if(teethBox) teethBox.style.display = 'block';
    }

    if (btype === 'SONOGRAPHY') {
        const lmpBox = document.getElementById('box-lmp-calc');
        if(lmpBox) lmpBox.style.display = 'block';
    }

    // --- GROUP 3: SERVICES & PERSONAL CARE ---
    if (btype === 'SALON') {
        document.querySelectorAll('.salon-only').forEach(el => el.style.display = '');
    }

    if (features.includes('attendance')) {
        if(document.getElementById('module-gym-access')) document.getElementById('module-gym-access').style.display = 'block';
    }

    if (features.includes('tailoring_measurements')) {
        if(document.getElementById('module-tailor-measurements')) document.getElementById('module-tailor-measurements').style.display = 'block';
    }

    if (features.includes('job_card')) {
        if(document.getElementById('module-repair-job')) document.getElementById('module-repair-job').style.display = 'block';
    }

    // --- GROUP 4: HOSPITALITY & FOOD ---
    if (features.includes('table_kot')) {
        if(document.getElementById('module-restaurant-kot')) document.getElementById('module-restaurant-kot').style.display = 'block';
        if(document.getElementById('standalone-kitchen-view')) document.getElementById('standalone-kitchen-view').style.display = 'block';
        loadLiveKOTs();
    }

    if (features.includes('room_checkin')) {
        if(document.getElementById('module-hotel-management')) document.getElementById('module-hotel-management').style.display = 'block';
        if(document.getElementById('hotel-room-status-section')) document.getElementById('hotel-room-status-section').style.display = 'block';
        if (typeof loadHotelRooms === 'function') loadHotelRooms();
    }

    // --- GROUP 5: CONSTRUCTION & TRANSPORT ---
    if (features.includes('sqft_calc')) {
        if(document.getElementById('module-tiles-calc')) document.getElementById('module-tiles-calc').style.display = 'block';
    }

    if (features.includes('trip_management')) {
        if(document.getElementById('module-transport-trip')) document.getElementById('module-transport-trip').style.display = 'block';
    }

    // --- GROUP 6: EDUCATION ---
    if (features.includes('fees_management')) {
        if(document.getElementById('module-school-fees')) document.getElementById('module-school-fees').style.display = 'block';
    }

    // --- GROUP 7: FINANCE & OTHERS ---
    if (features.includes('geo_tagging') || features.includes('commission_calc') || btype === 'RECOVERY_AGENT') {
        if(document.getElementById('module-geo-tagging')) document.getElementById('module-geo-tagging').style.display = 'block';
        if(document.getElementById('module-finance-collection')) document.getElementById('module-finance-collection').style.display = 'block';
        
        const searchInput = document.getElementById('pos-item-search');
        if(searchInput) searchInput.placeholder = "EMI Account, Loan No рдпрд╛ Policy рдЦреЛрдЬреЗрдВ...";
    }

    // HARDWARE SPECIAL FIX
    if (btype === 'HARDWARE_GENERAL') {
        const deviceInput = document.getElementById('repair_device');
        if (deviceInput) deviceInput.placeholder = "Item Name (Lock/Safe)";
        const imeiInput = document.getElementById('repair_imei');
        if (imeiInput) imeiInput.placeholder = "Key Code / Serial No";
        const issueInput = document.getElementById('repair_issue');
        if (issueInput) issueInput.placeholder = "Problem (e.g. Key Stuck, Handle Broken)";
    }

    // ЁЯЪА GOD MODE VISIBILITY CONTROLLER
    const MISTRI_BUSINESS_TYPES = ['HARDWARE_GENERAL', 'FURNITURE', 'TILES_CERAMIC', 'ELECTRONICS', 'PAINT_SHOP', 'TENT_HOUSE', 'SERVICE_CENTER', 'TRANSPORT'];
    const godModeBox = document.getElementById('pos-god-mode-delivery');
    const mistriInput = document.getElementById('pos_auto_mistri_mobile');
    const mistriCheckbox = document.getElementById('pos_send_mistri_wa');

    if (godModeBox) {
        godModeBox.style.display = 'block';
        if (MISTRI_BUSINESS_TYPES.includes(btype)) {
            if(mistriInput) {
                mistriInput.style.display = 'block';
                if(btype === 'PAINT_SHOP') mistriInput.placeholder = "Painter Mobile (Optional)";
                else if(btype === 'TRANSPORT') mistriInput.placeholder = "Driver Mobile (Optional)";
                else if(btype === 'ELECTRONICS') mistriInput.placeholder = "Technician Mobile (Optional)";
                else mistriInput.placeholder = "Mistri Mobile (Optional)";
            }
            if(mistriCheckbox && mistriCheckbox.closest('.form-check')) {
                mistriCheckbox.closest('.form-check').style.display = 'block';
            }
        } else {
            if(mistriInput) mistriInput.style.display = 'none';
            if(mistriCheckbox && mistriCheckbox.closest('.form-check')) {
                mistriCheckbox.closest('.form-check').style.display = 'none';
            }
        }
    }

    // ============================================================
    // ЁЯЪи NEW UPDATE: ANTI-THEFT BUTTON LOGIC (For Garments Only)
    // ============================================================
    // рдпрд╣ рдХреЛрдб рдЪреЗрдХ рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдмрд┐рдЬрд╝рдиреЗрд╕ Garments рд╣реИ рдпрд╛ рдирд╣реАрдВред
    
    const theftBtnId = 'dynamic-theft-btn-container';
    const existingBtn = document.getElementById(theftBtnId);
    
    // рдпрд╣рд╛рдБ рд╣рдордиреЗ Garments рдФрд░ Clothing рджреЛрдиреЛрдВ рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд┐рдпрд╛ рд╣реИ
    if (btype === 'Garments' || btype === 'GARMENTS' || btype === 'CLOTHING') {
        
        // тЬЕ рдЕрдЧрд░ Garments рд╣реИ, рддреЛ рдмрдЯрди рдмрдирд╛рдУ (рдЕрдЧрд░ рдкрд╣рд▓реЗ рд╕реЗ рдирд╣реАрдВ рд╣реИ)
        if (!existingBtn) {
            const btnDiv = document.createElement('div');
            btnDiv.id = theftBtnId;
            btnDiv.style.position = 'fixed';
            btnDiv.style.top = '10px';
            btnDiv.style.left = '50%'; 
            btnDiv.style.transform = 'translateX(-50%)'; // рд╕реЗрдВрдЯрд░ рдореЗрдВ
            btnDiv.style.zIndex = '99999';
            btnDiv.innerHTML = `
                <button class="btn btn-danger btn-sm shadow" onclick="triggerTheftAlarm('Test Item')">
                    <i class="fas fa-exclamation-triangle"></i> Anti-Theft Test
                </button>
            `;
            document.body.appendChild(btnDiv);
        }
    } 
    // тЭМ рдЕрдЧрд░ Retail рдпрд╛ рдХреЛрдИ рдФрд░ рдмрд┐рдЬрд╝рдиреЗрд╕ рд╣реИ, рддреЛ рдмрдЯрди рд╣рдЯрд╛ рджреЛ
    else {
        if (existingBtn) {
            existingBtn.remove();
        }
    }

    console.log(`тЬЕ UI Configured Successfully for: ${config.name}`);
}

// Call this when you need (after applyBusinessTypeUI detects SALON) or on click
// [ тЬЕ ADVANCED: Salon Dashboard Loader with Graph & Customer List ]

// [ тЬЕ FIXED: Salon Dashboard Loader (With Date/Time Sorting) ]

async function loadSalonDashboard() {
    let res = null;   // тЬЕ res ko function scope me lao

    try {
        res = await fetchApi('/api/salon/dashboard');
    } catch (e) {
        console.warn('Salon dashboard failed, continuing UI', e);
        return; // тЭЧ dashboard data nahi aaya, aage ka code mat chalao
    }

    // 2. рдХрд╛рд░реНрдбреНрд╕ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ
    document.getElementById('salon-today-sales').innerText =
        formatCurrency(res.today_sales || 0);

    document.getElementById('salon-today-appts').innerText =
        (res.appointments || []).length;

    document.getElementById('salon-birthdays-count').innerText =
        res.upcoming_birthdays || 0;

    document.getElementById('salon-low-stock').innerText =
        res.low_stock_count || 0;

    // 3. "Recent Customers / Booking List"
    const custBody = document.getElementById('salon-recent-customers-body');
    const appts = res.appointments || [];

    if (appts.length > 0) {
        custBody.innerHTML = appts.map(a => {
            const dateObj = new Date(a.event_time);
            const today = new Date();
            const isToday = dateObj.toDateString() === today.toDateString();

            const dateStr = dateObj.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
            const timeStr = dateObj.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });

            const dayDisplay = isToday
                ? `<span class="badge bg-success">Today</span>`
                : `<span class="badge bg-warning text-dark">${dateStr}</span>`;

            const typeIcon = a.type === 'SALE'
                ? `<i class="fas fa-check-circle text-success"></i>`
                : `<i class="fas fa-clock text-primary"></i>`;

            const wpMsg = isToday
                ? `рдирдорд╕реНрддреЗ ${a.customer_name}, рдЖрдкрдХреА рдЖрдЬ рдХреА рдмреБрдХрд┐рдВрдЧ ${timeStr} рдкрд░ рд╣реИред`
                : `рдирдорд╕реНрддреЗ ${a.customer_name}, рдЖрдкрдХреА рдмреБрдХрд┐рдВрдЧ ${dateStr} рдХреЛ ${timeStr} рдкрд░ рдкрдХреНрдХреА рд╣реИред`;

            return `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="me-2">${typeIcon}</div>
                        <div>
                            <div class="fw-bold text-dark">${a.customer_name}</div>
                            <small class="text-muted">${a.service_name || 'Service'}</small>
                        </div>
                    </div>
                </td>
                <td>
                    ${dayDisplay}<br>
                    <small class="fw-bold text-dark">${timeStr}</small>
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <span class="me-2 small">${a.customer_mobile || '--'}</span>
                        <button class="btn btn-sm btn-success py-0 px-2"
                            onclick="sendWhatsAppMessage('${a.customer_mobile}', '${wpMsg}')">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                    </div>
                </td>
            </tr>`;
        }).join('');
    } else {
        custBody.innerHTML =
            `<tr><td colspan="3" class="text-center text-muted p-3">
                рдХреЛрдИ рдмреБрдХрд┐рдВрдЧ рдпрд╛ рдЧреНрд░рд╛рд╣рдХ рдирд╣реАрдВред
            </td></tr>`;
    }

    // 4. рдЧреНрд░рд╛рдл рдЕрдкрдбреЗрдЯ
    renderSalonChart();
}

// --- Salon Chart Function ---
// [ тЬЕ SOLUTION: Salon Chart Rendering Function ]
// рдЗрд╕реЗ renderSalesChart рдХреЗ рдареАрдХ рдиреАрдЪреЗ рдкреЗрд╕реНрдЯ рдХрд░реЗрдВ

let salonChartInstance = null; // рдЪрд╛рд░реНрдЯ рдХреЛ рд╕реНрдЯреЛрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╡реЗрд░рд┐рдПрдмрд▓

// [ тЬЕ FINAL: Premium TradingView Style Chart & Empty State ]

// [ тЬЕ FINAL: Ultimate TradingView Style Chart ]

// [ тЬЕ FINAL: Same Design as Retail Dashboard ]

async function renderSalonChart() {
    try {
        // 1. рдкреБрд░рд╛рдиреЗ "Share Market" рд╡рд╛рд▓реЗ рдПрд▓реАрдореЗрдВрдЯреНрд╕ (рдЕрдЧрд░ рд╣реИрдВ) рддреЛ рд╣рдЯрд╛ рджреЗрдВ
        const oldHeader = document.getElementById('pro-market-header');
        if (oldHeader) oldHeader.remove();
        const oldEmpty = document.getElementById('pro-empty-state');
        if (oldEmpty) oldEmpty.remove();
        
        // рдХреИрдирд╡рд╛рд╕ рдХреЛ рд╡рд╛рдкрд╕ рджрд┐рдЦрд╛рдПрдВ
        const chartCanvas = document.getElementById('salonSalesChart');
        if (!chartCanvas) return;
        chartCanvas.style.display = 'block';

        // 2. рдбреЗрдЯрд╛ рдордВрдЧрд╛рдПрдВ
        const res = await fetchApi('/api/dashboard/sales-by-day?days=30', { method: 'GET' }, null); 

        if (res.success && res.data) {
            const chartData = res.data;
            
            // рдбреЗрдЯрд╛ рддреИрдпрд╛рд░ рдХрд░реЗрдВ
            const labels = chartData.map(d => new Date(d.date).toLocaleDateString('hi-IN', { day: 'numeric', month: 'short' }));
            const salesValues = chartData.map(d => d.sales);
            const profitValues = chartData.map(d => d.profit); // рдкреНрд░реЙрдлрд┐рдЯ рднреА рджрд┐рдЦрд╛рдПрдВрдЧреЗ

            // рдкреБрд░рд╛рдирд╛ рдЪрд╛рд░реНрдЯ рд╣рдЯрд╛рдПрдВ
            if (window.salonChartInstance) {
                window.salonChartInstance.destroy();
            }

            // 3. рдирдпрд╛ рдЪрд╛рд░реНрдЯ рдмрдирд╛рдПрдВ (рдмрд┐рд▓реНрдХреБрд▓ Retail рдЬреИрд╕рд╛)
            const ctx = chartCanvas.getContext('2d');
            window.salonChartInstance = new Chart(ctx, {
                type: 'line', // рд▓рд╛рдЗрди рдЪрд╛рд░реНрдЯ
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'рдмрд┐рдХреНрд░реА (Sales)',
                            data: salesValues,
                            borderColor: 'rgba(0, 180, 216, 1)', // рд╡рд╣реА рдиреАрд▓рд╛ рд░рдВрдЧ
                            backgroundColor: 'rgba(0, 180, 216, 0.1)',
                            fill: true,
                            tension: 0.3 // рд╕реНрдореВрде рдХрд░реНрд╡
                        },
                        {
                            label: 'рд▓рд╛рдн (Profit)',
                            data: profitValues,
                            borderColor: 'rgba(26, 188, 156, 1)', // рд╡рд╣реА рд╣рд░рд╛ рд░рдВрдЧ
                            backgroundColor: 'rgba(26, 188, 156, 0.1)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) { return 'тВ╣' + value; }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    }
                }
            });
        }
    } catch (e) {
        console.error("Salon Chart Error:", e);
    }
}

async function openBirthdayList() {
  try {
    const res = await fetchApi('/api/saloon/upcoming-birthdays?days=7', { method:'GET' });
    if(!res.success) throw new Error(res.message || 'No data');

    const area = document.getElementById('salon-birthday-list-area');
    if(!res.customers || !res.customers.length) {
      area.innerHTML = `<div class="p-3">рдЕрдЧрд▓реЗ 7 рджрд┐рдиреЛрдВ рдореЗрдВ рдХреЛрдИ рдЬрдиреНрдорджрд┐рди рдирд╣реАрдВ рд╣реИред</div>`;
      return;
    }

    let html = `<div class="card p-3"><h5>Upcoming Birthdays</h5>`;
    html += res.customers.map(c => `
      <div style="padding:8px 0;border-bottom:1px dashed #eee; display:flex; justify-content:space-between;">
        <div>
          <b>${c.name}</b><br>
          ${c.dob ? 'DOB: ' + c.dob.split('T')[0] : ''} <br>
          ${c.address ? c.address + '<br>' : ''} ${c.mobile ? 'ЁЯУЮ ' + c.mobile : ''}
        </div>
        <div style="text-align:right;">
          <button class="btn btn-sm btn-primary" onclick="sendBirthdayWhatsApp('${(c.mobile||'').replace(/[^0-9]/g,'')}', '${c.name}')">Send WP</button>
        </div>
      </div>
    `).join('');
    html += `</div>`;
    area.innerHTML = html;
  } catch(err) {
    console.error(err);
    alert('Birthday list load error: '+err.message);
  }
}

function sendBirthdayWhatsApp(mobile, name) {
  if(!mobile) return alert('Customer mobile not available');
  const msg = `Happy Birthday ${name}! ЁЯОЙ Enjoy 20% off on your next salon visit. Book today!`;
  window.open(`https://wa.me/91${mobile}?text=${encodeURIComponent(msg)}`, '_blank');
}



// -----------------------------
// SALOON: Frontend render helpers
// Paste into the same script where other renderX functions exist.
// -----------------------------

async function loadSaloonAI() {
  // Safe fetch: call saloon APIs and render
  try {
    const [dash, services, birthdays] = await Promise.all([
      fetchApi('/api/saloon/dashboard', { method: 'GET' }).catch(()=>({ success:false })),
      fetchApi('/api/saloon/services', { method: 'GET' }).catch(()=>({ success:false })),
      fetchApi('/api/saloon/upcoming-birthdays?days=7', { method: 'GET' }).catch(()=>({ success:false }))
    ]);

    renderSaloonDashboard(dash);
    renderSaloonServices(services);
    renderSaloonBirthdays(birthdays);
  } catch(err){
    console.error('loadSaloonAI error', err);
  }
}

function renderSaloonDashboard(data) {
  const box = document.getElementById('ai-saloon-dashboard');
  if (!box) return;
  if (!data || !data.success) {
    box.innerHTML = `<div class="ai-card-alert ai-alert-danger">Saloon dashboard рд▓реЛрдб рдирд╣реАрдВ рд╣реБрдЖред</div>`;
    return;
  }

  const appts = data.appointments || [];
  box.innerHTML = `
    <div class="ai-card">
      <h4>Today's Sales: тВ╣${data.today_sales || 0} тАв Appointments: ${data.today_appointments || 0}</h4>
      <p>Upcoming Birthdays (7d): <b>${data.upcoming_birthdays || 0}</b></p>
      <hr>
      <h5>Next appointments</h5>
      <div style="max-height:220px; overflow:auto;">
        ${ appts.length ? appts.map(a => `
            <div style="padding:8px 0; border-bottom:1px dashed #eee;">
              <b>${a.customer_name}</b> тАв ${a.service || '-'} тАв ${new Date(a.scheduled_at).toLocaleString()}
              ${a.mobile ? `<br/><small> ${a.mobile}</small>` : ''}
            </div>
          `).join('') : '<div class="text-muted">No upcoming appointments</div>'
        }
      </div>
    </div>
  `;
}

function renderSaloonServices(data) {
  const box = document.getElementById('ai-saloon-services');
  if (!box) return;
  if (!data || !data.success) {
    box.innerHTML = `<div class="ai-card-alert ai-alert-danger">Services data unavailable.</div>`;
    return;
  }

  const list = data.services || [];
  box.innerHTML = `
    <div class="ai-card">
      <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:8px;">
        ${ list.length ? list.map(s => `
            <div style="padding:8px; border-radius:6px; background:#fff; box-shadow:var(--card-shadow);">
              <b>${s.name}</b><br>
              ${s.price ? `Price: тВ╣${s.price}` : ''} ${s.duration_minutes ? `тАв ${s.duration_minutes}m` : ''}
            </div>
          `).join('') : '<div class="text-muted">No services defined</div>'
        }
      </div>
    </div>
  `;
}

function renderSaloonBirthdays(data) {
  const box = document.getElementById('ai-saloon-birthdays');
  if (!box) return;
  if (!data || !data.success) {
    box.innerHTML = `<div class="ai-card-alert ai-alert-danger">Birthday list unavailable.</div>`;
    return;
  }

  const list = data.customers || [];
  box.innerHTML = `
    <div class="ai-card">
      <div style="max-height:220px; overflow:auto;">
        ${
          list.length ? list.map(c => `
            <div style="padding:8px 0; border-bottom:1px dashed #eee; display:flex; justify-content:space-between; align-items:center;">
              <div>
                <b>${c.name}</b> ${c.mobile ? `<small> тАв ${c.mobile}</small>` : ''}
                <div class="text-muted-small">DOB: ${c.dob ? c.dob.split('T')[0] : '-'}</div>
              </div>
              <div>
                <a class="btn btn-sm btn-outline-primary" href="https://wa.me/91${(c.mobile||'').replace(/[^0-9]/g,'')||''}?text=${encodeURIComponent(`Namaste ${c.name}, Happy Birthday in advance! Enjoy 20% off on your next visit.`)}" target="_blank">Send WP</a>
              </div>
            </div>
          `).join('') : `<div class="text-muted">No upcoming birthdays</div>`
        }
      </div>
    </div>
  `;
}

// Helper: call saloon load from main loadUltimateAI
// -> In loadUltimateAI() add: await loadSaloonAI(); (see below where to insert)




// Add this function near other render* functions (in same script block)
function renderSaloonInsights(data) {
  const box = document.getElementById('ai-saloon-content');
  if(!box) return;

  if(!data || !data.success){
    box.innerHTML = `<div class="ai-card-alert ai-alert-danger">Saloon insights not available.</div>`;
    return;
  }

  const appts = data.appointments || [];
  const repeat = data.repeat_customers || [];
  const topServices = data.top_services || [];
  const noShows = data.no_shows || {no_shows:0,cancelled:0};
  const birthdays = data.upcoming_birthdays || [];
  const todayRev = data.today_revenue || 0;

  let html = `
    <div class="row g-3">
      <div class="col-md-4">
        <div class="card p-3">
          <h6>рдЖрдЬ рдХреА рдЖрдорджрдиреА</h6>
          <h3>тВ╣${todayRev}</h3>
          <small>Appointments: ${appts.length}</small>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card p-3">
          <h6>No-shows / Cancelled (30d)</h6>
          <p class="mb-0">No-shows: <b>${noShows.no_shows}</b></p>
          <p class="mb-0">Cancelled: <b>${noShows.cancelled}</b></p>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card p-3">
          <h6>Top Services (60d)</h6>
          <ul style="padding-left:16px; margin:0;">
            ${topServices.length ? topServices.map(s=>`<li>${s.service_name} тАФ ${s.cnt} bookings тАв тВ╣${s.revenue}</li>`).join('') : '<li>тАФ</li>'}
          </ul>
        </div>
      </div>
    </div>

    <hr>

    <div class="row g-3">
      <div class="col-md-6">
        <h5>Repeat Customers (Top)</h5>
        <div style="max-height:220px; overflow:auto;">
          ${repeat.length ? repeat.map(r=>`
            <div style="padding:6px 0; border-bottom:1px dashed #eee;">
              <b>${r.name}</b> (${r.phone || 'тАФ'}) тАФ Visits: ${r.visits} тАв Last: ${r.last_visit ? r.last_visit.split('T')[0] : 'тАФ'}
              <button class="btn btn-sm btn-outline-primary ms-2" onclick="openWhatsAppForSalon('${(r.phone||'').replace(/[^0-9]/g,'')}','${encodeURIComponent('рдирдорд╕реНрддреЗ '+r.name+', рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдЖрдкрдХреЗ рдкрд╕рдВрджреАрджрд╛ рд╕рд░реНрд╡рд┐рд╕ рдкрд░ рд╡рд┐рд╢реЗрд╖ рдСрдлрд░ рд╣реИ')}')">WhatsApp</button>
            </div>
          `).join('') : `<div class="text-muted">No repeat customers yet.</div>`}
        </div>
      </div>

      <div class="col-md-6">
        <h5>Upcoming Birthdays (7 days)</h5>
        <div style="max-height:220px; overflow:auto;">
          ${birthdays.length ? birthdays.map(b=>`
            <div style="padding:6px 0; border-bottom:1px dashed #eee;">
              <b>${b.name}</b> тАв DOB: ${b.dob ? b.dob.split('T')[0] : 'тАФ'} тАв ${b.phone || ''}
              <button class="btn btn-sm btn-outline-success ms-2" onclick="openWhatsAppForSalon('${(b.phone||'').replace(/[^0-9]/g,'')}','${encodeURIComponent('Happy Birthday '+b.name+'! Special Birthday Offer: 20% off on salon services.')}')">Send Offer</button>
            </div>
          `).join('') : `<div class="text-muted">No birthdays in next 7 days.</div>`}
        </div>
      </div>
    </div>
  `;

  box.innerHTML = html;
}

// helper openWhatsAppForSalon
function openWhatsAppForSalon(mobile, msg){
  if(!mobile) return alert('Mobile missing');
  const url = `https://wa.me/91${mobile}?text=${encodeURIComponent(msg)}`;
  window.open(url, '_blank');
}




// [ тЬЕ Multiuser.html: Script рдЯреИрдЧ рдХреЗ рдЕрдВрджрд░ рдкреЗрд╕реНрдЯ рдХрд░реЗрдВ ]

let currentRecipe = [];

function addRecipeRow() {
    const sku = document.getElementById('recipe-consumable-sku').value;
    const qty = document.getElementById('recipe-qty').value;
    
    if(!sku || !qty) return alert("SKU рдФрд░ рдорд╛рддреНрд░рд╛ рднрд░реЗрдВ");
    
    currentRecipe.push({ sku, qty });
    renderRecipeList();
    
    // рдЗрдирдкреБрдЯ рд╕рд╛рдлрд╝ рдХрд░реЗрдВ
    document.getElementById('recipe-consumable-sku').value = '';
    document.getElementById('recipe-qty').value = '';
}

function renderRecipeList() {
    const list = document.getElementById('recipe-list');
    const input = document.getElementById('stock-recipe-data');
    
    list.innerHTML = currentRecipe.map((r, i) => `
        <div class="d-flex justify-content-between small border-bottom py-1">
            <span>Item: <b>${r.sku}</b>, Qty: <b>${r.qty}</b></span>
            <span class="text-danger cursor-pointer" onclick="currentRecipe.splice(${i},1); renderRecipeList()">├Ч</span>
        </div>
    `).join('');
    
    // рдбреЗрдЯрд╛ рдХреЛ JSON рд╕реНрдЯреНрд░рд┐рдВрдЧ рдмрдирд╛рдХрд░ рдЫрд┐рдкреЗ рд╣реБрдП рдЗрдирдкреБрдЯ рдореЗрдВ рдбрд╛рд▓реЗрдВ рддрд╛рдХрд┐ рдлреЙрд░реНрдо рд╕рдмрдорд┐рдЯ рд╣реЛ рд╕рдХреЗ
    input.value = JSON.stringify(currentRecipe);
}


// [ тЬЕ Multiuser.html: рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ рдкреЗрд╕реНрдЯ рдХрд░реЗрдВ ]

// 1. Modal рдЦреЛрд▓рдиреЗ рдХрд╛ рдлрдВрдХреНрд╢рди
function openAppointmentModal() {
    // рдЖрдЬ рдХреА рддрд╛рд░реАрдЦ рд╕реЗрдЯ рдХрд░реЗрдВ
    document.getElementById('appt-date').value = new Date().toISOString().split('T')[0];
    
    const modal = new bootstrap.Modal(document.getElementById('appointmentModal'));
    modal.show();
}

// 2. рдлреЙрд░реНрдо рд╕рдмрдорд┐рдЯ рд╣реЛрдиреЗ рдкрд░ (Booking Logic)
document.getElementById('appointment-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const btn = e.target.querySelector('button[type="submit"]');
    const oldText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = 'рдмреБрдХрд┐рдВрдЧ рд╣реЛ рд░рд╣реА рд╣реИ...';

    const data = {
        name: document.getElementById('appt-name').value,
        mobile: document.getElementById('appt-mobile').value,
        service: document.getElementById('appt-service').value,
        date: document.getElementById('appt-date').value,
        time: document.getElementById('appt-time').value
    };

    try {
        const res = await fetchApi('/api/appointments', { method: 'POST', body: data });
        
        if (res.success) {
            showMessage('рд╕рдлрд▓рддрд╛', res.message, 'success');
            
            // Modal рдмрдВрдж рдХрд░реЗрдВ
            const modalEl = document.getElementById('appointmentModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
            
            // рдлреЙрд░реНрдо рд╕рд╛рдлрд╝ рдХрд░реЗрдВ
            document.getElementById('appointment-form').reset();
            
            // рдбреИрд╢рдмреЛрд░реНрдб рд░реАрдлреНрд░реЗрд╢ рдХрд░реЗрдВ (рддрд╛рдХрд┐ рдирдИ рдмреБрдХрд┐рдВрдЧ рджрд┐рдЦреЗ)
            loadSalonDashboard();
        } else {
            throw new Error(res.message);
        }
    } catch (error) {
        showMessage('рддреНрд░реБрдЯрд┐', error.message, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = oldText;
    }
});

// ==========================================
// ЁЯОи PAINT SHOP LOGIC (The "Brahmastra")
// ==========================================

// 1. Load Painters into Dropdown
async function loadPainters() {
    const select = document.getElementById('pos-painter-select');
    if(!select) return;
    
    try {
        const res = await fetchApi('/api/painters', { method: 'GET' });
        if(res.success) {
            select.innerHTML = '<option value="">-- рдХреЛрдИ рдкреЗрдВрдЯрд░ рдирд╣реАрдВ --</option>';
            res.painters.forEach(p => {
                select.innerHTML += `<option value="${p.id}">${p.name} (${p.mobile})</option>`;
            });
        }
    } catch(e) { console.error(e); }
}

// ==========================================
// ЁЯОи SAVE FORMULA FUNCTION (DASHBOARD DIARY)
// ==========================================
async function savePaintFormula() {
    // рдлреЙрд░реНрдо рд╕реЗ рдбреЗрдЯрд╛ рдЙрдард╛рдПрдВ
    const name = document.getElementById('paint_cust_name').value;
    const code = document.getElementById('paint_code').value;
    const base = document.getElementById('paint_base').value;
    const formula = document.getElementById('paint_formula').value;

    if (!name || !code) {
        return showMessage('рдЕрдзреВрд░рд╛ рдбреЗрдЯрд╛', 'рдЧреНрд░рд╛рд╣рдХ рдХрд╛ рдирд╛рдо рдФрд░ рдХреЛрдб рдЬрд░реВрд░реА рд╣реИред', 'warning');
    }

    const data = {
        customer_name: name,
        color_code: code,
        base_product: base,
        formula_text: formula
    };

    // 2. рд╕рд░реНрд╡рд░ рдкрд░ рднреЗрдЬреЗрдВ (API Call)
    try {
        const res = await fetchApi('/api/paint/save-formula', { 
            method: 'POST', 
            body: data 
        }, 'рд╕рд░реНрд╡рд░ рдкрд░ рд╕реЗрд╡ рд╣реЛ рд░рд╣рд╛ рд╣реИ...');

        if (res.success) {
            showMessage('рд╕рдлрд▓рддрд╛', 'рдПрдВрдЯреНрд░реА рдкрд░рдорд╛рдиреЗрдВрдЯ рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рд╕реЗрд╡ рд╣реЛ рдЧрдИ!', 'success');
            
            // 3. рдлреЙрд░реНрдо рдЦрд╛рд▓реА рдХрд░реЗрдВ
            document.getElementById('paint_cust_name').value = '';
            document.getElementById('paint_code').value = '';
            document.getElementById('paint_base').value = '';
            document.getElementById('paint_formula').value = '';

            // 4. рд▓рд┐рд╕реНрдЯ рдХреЛ рд░рд┐рдлреНрд░реЗрд╢ рдХрд░реЗрдВ (рддрд╛рдХрд┐ рдирдИ рдПрдВрдЯреНрд░реА рджрд┐рдЦреЗ)
            fetchAndRenderPaintHistory(); 

        } else {
            throw new Error(res.message || 'рд╕рд░реНрд╡рд░ рдиреЗ рд╕реЗрд╡ рдирд╣реАрдВ рдХрд┐рдпрд╛ред');
        }
    } catch (e) {
        console.error(e);
        showMessage('рддреНрд░реБрдЯрд┐', `рд╕реЗрд╡ рдирд╣реАрдВ рд╣реБрдЖ: ${e.message}`, 'danger');
    }
}


// 2. Add New Painter Prompt
async function addNewPainterPrompt() {
    const name = prompt("рдкреЗрдВрдЯрд░ рдХрд╛ рдирд╛рдо:");
    if(!name) return;
    const mobile = prompt("рдкреЗрдВрдЯрд░ рдХрд╛ рдореЛрдмрд╛рдЗрд▓:");
    
    await fetchApi('/api/painters', { method:'POST', body: { name, mobile } });
    loadPainters(); // Refresh list
    showMessage('Success', 'Painter Added!', 'success');
}

// 3. Paint Estimator Logic (The "Estimate")
function calculatePaintEstimate() {
    const area = parseFloat(document.getElementById('est-area').value);
    if(!area) return alert("Area daalein (Sq.Ft)");

    // Standard Formulas
    const putty = Math.ceil(area / 12); // 1kg covers ~12 sqft (2 coats)
    const primer = Math.ceil(area / 130); // 1L covers ~130 sqft
    const paint = Math.ceil(area / 110); // 1L covers ~110 sqft (2 coats)

    document.getElementById('res-putty').innerText = `${putty} Kg`;
    document.getElementById('res-primer').innerText = `${primer} Liters`;
    document.getElementById('res-paint').innerText = `${paint} Liters`;
    
    document.getElementById('est-result').classList.remove('d-none');
}

function printEstimate() {
    const area = document.getElementById('est-area').value;
    const putty = document.getElementById('res-putty').innerText;
    const primer = document.getElementById('res-primer').innerText;
    const paint = document.getElementById('res-paint').innerText;
    
    const win = window.open('', '', 'width=400,height=400');
    win.document.write(`
        <h3>Paint Estimate (Area: ${area} sq.ft)</h3>
        <hr>
        <p><b>Wall Putty:</b> ${putty}</p>
        <p><b>Primer:</b> ${primer}</p>
        <p><b>Paint (Emulsion):</b> ${paint}</p>
        <hr>
        <small>Generated by Dukan Pro</small>
        <script>window.print();<\/script>
    `);
}

// 4. Mixing Logic (The "Base + Colorant" Problem)
// 1. рдмреЗрд╕ рдХрд╛ рдмрд╛рд░рдХреЛрдб рд╕реНрдХреИрди рдХрд░рддреЗ рд╣реА рдбрд┐рдЯреЗрд▓ рдЕрдкрдиреЗ рдЖрдк рдЖ рдЬрд╛рдПрдЧреА
async function fetchBaseDetails(sku) {
    if (!sku) return;
    
    // рд╕реНрдЯреЙрдХ рд▓рд┐рд╕реНрдЯ рдореЗрдВ рд╕реЗ рдЖрдЗрдЯрдо рдвреВрдБрдвреЛ
    const item = currentStock.find(s => s.sku === sku);
    
    if (item) {
        document.getElementById('mix-base-name').value = item.name;
        document.getElementById('mix-base-price').value = item.sale_price;
        document.getElementById('mix-stock-status').innerHTML = 
            `<span class="text-success"><i class="fas fa-check"></i> рд╕реНрдЯреЙрдХ рдореЗрдВ рдЙрдкрд▓рдмреНрдз: <b>${item.quantity}</b> ${item.unit}</span>`;
        document.getElementById('mix-stock-status').className = "small text-success";
    } else {
        document.getElementById('mix-stock-status').innerHTML = 
            `<span class="text-danger"><i class="fas fa-times"></i> рдпрд╣ SKU рд╕реНрдЯреЙрдХ рдореЗрдВ рдирд╣реАрдВ рдорд┐рд▓рд╛!</span>`;
        document.getElementById('mix-base-name').value = "";
        document.getElementById('mix-base-price').value = "";
    }
}

// 2. рдХрд╛рд░реНрдЯ рдореЗрдВ рдЬреЛрдбрд╝рдиреЗ рд╡рд╛рд▓рд╛ рдЕрдкрдбреЗрдЯреЗрдб рдлрдВрдХреНрд╢рди
function addMixedPaintToCart() {
    const baseSku = document.getElementById('mix-base-sku').value;
    const baseName = document.getElementById('mix-base-name').value;
    const basePrice = parseFloat(document.getElementById('mix-base-price').value) || 0;
    const colorCost = parseFloat(document.getElementById('mix-color-cost').value) || 0;
    const colorCode = document.getElementById('mix-code').value;

    if(!baseSku || !baseName) return alert("рдХреГрдкрдпрд╛ рдкрд╣рд▓реЗ рдмреЗрд╕ рдмрд╛рд▓реНрдЯреА рдХрд╛ SKU рд╕реНрдХреИрди рдХрд░реЗрдВ рдпрд╛ рдбрд╛рд▓реЗрдВред");

    const finalPrice = basePrice + colorCost; 

    // рдЕрд╕рд▓реА рдЬрд╛рджреВ рдпрд╣рд╛рдБ рд╣реИ: рд╣рдо SKU рд╡рд╣реА рд░рдЦреЗрдВрдЧреЗ рдЬреЛ рдмрд╛рд▓реНрдЯреА рдХрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдирд╛рдо рдФрд░ рдХреАрдордд рдмрджрд▓ рджреЗрдВрдЧреЗ
    // рдЗрд╕рд╕реЗ рд╕реНрдЯреЙрдХ 'APEX-BASE' рдХрд╛ рд╣реА рдХрдо рд╣реЛрдЧрд╛!
    const item = {
        sku: baseSku,  // <--- рдпрд╣ рдмрд╛рд▓реНрдЯреА рдХрд╛ рд╣реА SKU рд╣реИ
        name: `${baseName} (Mix: ${colorCode})`, // рдмрд┐рд▓ рдкрд░ рдирд╛рдо рдмрджрд▓рдХрд░ рдЖрдПрдЧрд╛
        quantity: 1,
        sale_price: finalPrice, // рдХреАрдордд рдмрдврд╝ рдЧрдИ (рдмреЗрд╕ + рдХрд▓рд░)
        purchase_price: 0, // (рдпрд╣ рдмреИрдХрдПрдВрдб рд╕реЗ рдЖ рдЬрд╛рдПрдЧрд╛)
        gst: 18,
        product_attributes: { 
            "Type": "Custom Mix", 
            "Colorant Cost": colorCost,
            "Color Code": colorCode
        }
    };

    // рдХрд╛рд░реНрдЯ рдореЗрдВ рдбрд╛рд▓реЗрдВ
    addSKUToCartFromMix(item);
    
    // рдореЙрдбрд▓ рдмрдВрдж рдХрд░реЗрдВ
    const modalEl = document.getElementById('paintMixingModal');
    const modal = bootstrap.Modal.getInstance(modalEl);
    modal.hide();
    
    // рдлреЙрд░реНрдо рд╕рд╛рдлрд╝ рдХрд░реЗрдВ
    document.getElementById('mix-base-sku').value = '';
    document.getElementById('mix-base-name').value = '';
    document.getElementById('mix-code').value = '';
    document.getElementById('mix-color-cost').value = '';
    document.getElementById('mix-stock-status').innerText = '';
}

// рдпрд╣ рд╣реЗрд▓реНрдкрд░ рдлрдВрдХреНрд╢рди рд╣реИ рдЬреЛ рдорд┐рдХреНрд╕ рдЖрдЗрдЯрдо рдХреЛ рд╕реАрдзреЗ рдХрд╛рд░реНрдЯ рдореЗрдВ рдкреБрд╢ рдХрд░рддрд╛ рд╣реИ
function addSKUToCartFromMix(mixedItem) {
    // рдЪреЗрдХ рдХрд░реЗрдВ рдХрд┐ рд╕реНрдЯреЙрдХ рд╣реИ рдпрд╛ рдирд╣реАрдВ
    const stockItem = currentStock.find(s => s.sku === mixedItem.sku);
    if (stockItem && stockItem.quantity < 1) {
        return showMessage('рд╕реНрдЯреЙрдХ рдирд╣реАрдВ рд╣реИ', 'рдпрд╣ рдмрд╛рд▓реНрдЯреА рд╕реНрдЯреЙрдХ рдореЗрдВ рдЦрддреНрдо рд╣реЛ рдЪреБрдХреА рд╣реИ!', 'danger');
    }

    // рдХрд╛рд░реНрдЯ рдореЗрдВ рдвреВрдБрдвреЗрдВ
    const existingCartItem = posCart.find(item => item.sku === mixedItem.sku);
    
    if (existingCartItem) {
        // рдЕрдЧрд░ рдкрд╣рд▓реЗ рд╕реЗ рдХрд╛рд░реНрдЯ рдореЗрдВ рд╣реИ, рддреЛ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ
        existingCartItem.quantity++;
        // рдорд┐рдХреНрд╕рд┐рдВрдЧ рдбрд┐рдЯреЗрд▓ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ (рдиреЛрдЯ: рдПрдХ рд╣реА SKU рдХреЗ рдЕрд▓рдЧ-рдЕрд▓рдЧ рд░рдВрдЧ рдПрдХ рд╕рд╛рде рдмрд┐рд▓ рдирд╣реАрдВ рд╣реЛ рд╕рдХрддреЗ рдЗрд╕ рд▓реЙрдЬрд┐рдХ рдореЗрдВ, рдЬреЛ рдареАрдХ рд╣реИ)
        existingCartItem.name = mixedItem.name;
        existingCartItem.sale_price = mixedItem.sale_price;
    } else {
        // рдирдпрд╛ рдЬреЛрдбрд╝реЗрдВ
        posCart.push(mixedItem);
    }
    updatePOSCartView();
    showMessage('рд╕рдлрд▓рддрд╛', 'рдкреЗрдВрдЯ рдорд┐рдХреНрд╕ рд╣реЛрдХрд░ рдмрд┐рд▓ рдореЗрдВ рдЬреБрдбрд╝ рдЧрдпрд╛!', 'success');
}


// ==========================================
// ЁЯУ╖ NEW: PAINT MIXING SCANNER BUTTON
// ==========================================
function openMobileScannerForMix() {
    console.log("Scanner button clicked for Mixing...");

    // ЁЯЪА NEW: рдорд┐рдХреНрд╕рд┐рдВрдЧ рдореЛрдб рдПрдХреНрдЯрд┐рд╡ рдХрд░реЗрдВ
    isMixingModeActive = true; 

    if (isMobile()) {
        console.log("Mobile detected. Opening Local Camera...");
        const paintOtpBox = document.getElementById('paint-otp-box');
        if (paintOtpBox) paintOtpBox.style.display = 'none';
        
        // рдХреИрдорд░рд╛ рд╢реБрд░реВ рдХрд░реЗрдВ
        if (typeof startLocalScanner === 'function') {
            startLocalScanner(); 
        } else {
            alert("Error: startLocalScanner function not found!");
        }

    } else {
        console.log("PC detected. Generating OTP...");
        const paintOtpBox = document.getElementById('paint-otp-box');
        const paintSpinner = document.getElementById('paint-otp-spinner');
        const paintCode = document.getElementById('paint-otp-code');
        const paintStatus = document.getElementById('paint-otp-status');

        if (paintOtpBox) {
            paintOtpBox.style.display = 'block';
            if (paintSpinner) paintSpinner.style.display = 'inline-block';
            if (paintCode) paintCode.innerText = '------';
            if (paintStatus) paintStatus.style.display = 'none';
        }

        const posBox = document.getElementById('inline-pairing-box');
        if (posBox) posBox.style.display = 'none';

        if (typeof initPosWebSocket === 'function') {
            initPosWebSocket(); 
        }
    }
}


// рдЗрд╕реЗ <script> рдХреЗ рдЕрдВрджрд░ рдХрд╣реАрдВ рднреА рдкреЗрд╕реНрдЯ рдХрд░реЗрдВ

    async function fetchAndRenderPaintHistory() {
    const tableBody = document.getElementById('paint-history-body');
    if (!tableBody) return; // рдЕрдЧрд░ рдЯреЗрдмрд▓ рдирд╣реАрдВ рд╣реИ рддреЛ рд░реБрдХ рдЬрд╛рдПрдВ

    tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...</td></tr>`;

    try {
        // рд╕рд░реНрд╡рд░ рд╕реЗ рдбреЗрдЯрд╛ рдорд╛рдВрдЧреЗрдВ (GET Request)
        const res = await fetchApi('/api/paint/formulas', { method: 'GET' });

        if (res.success && res.formulas && res.formulas.length > 0) {
            // рдбреЗрдЯрд╛ рдорд┐рд▓ рдЧрдпрд╛, рдЕрдм рдЯреЗрдмрд▓ рдореЗрдВ рджрд┐рдЦрд╛рдПрдВ
            tableBody.innerHTML = res.formulas.map(item => `
                <tr>
                    <td>${new Date(item.created_at).toLocaleDateString('en-IN', { day: 'numeric', month: 'short' })}</td>
                    <td class="fw-bold">${item.customer_name}</td>
                    <td>
                        <span class="badge bg-info text-dark">${item.color_code}</span><br>
                        <small class="text-muted">${item.base_product || ''}</small>
                    </td>
                    <td class="text-danger small fw-bold" style="font-family: monospace;">
                        ${item.formula_text}
                    </td>
                </tr>
            `).join('');
        } else {
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">рдЕрднреА рдХреЛрдИ рд░рд┐рдХреЙрд░реНрдб рдирд╣реАрдВ рд╣реИред</td></tr>`;
        }
    } catch (e) {
        console.error("History Error:", e);
        tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">рдбреЗрдЯрд╛ рд▓реЛрдб рдирд╣реАрдВ рд╣реЛ рд╕рдХрд╛ред</td></tr>`;
    }
}

// [ рдЗрд╕реЗ script рдЯреИрдЧ рдореЗрдВ рдЬреЛрдбрд╝реЗрдВ ]

// Global variable to store current painter ID in view
let currentViewingPainterId = null;

async function viewSelectedPainterLedger() {
    const select = document.getElementById('pos-painter-select');
    const painterId = select.value;
    const painterName = select.options[select.selectedIndex]?.text || 'Unknown';

    if (!painterId) {
        return showMessage('рддреНрд░реБрдЯрд┐', 'рдХреГрдкрдпрд╛ рдкрд╣рд▓реЗ рд▓рд┐рд╕реНрдЯ рд╕реЗ рдПрдХ рдкреЗрдВрдЯрд░ рдЪреБрдиреЗрдВред', 'warning');
    }

    currentViewingPainterId = painterId; // ЁЯЪА ID рд╕реЗрд╡ рдХрд░реЗрдВ рддрд╛рдХрд┐ Pay рдмрдЯрди рдХреЛ рдкрддрд╛ рд░рд╣реЗ рдХрд┐рд╕реЗ рдкреИрд╕реЗ рджреЗрдиреЗ рд╣реИрдВ

    const modal = new bootstrap.Modal(document.getElementById('painterLedgerModal'));
    document.getElementById('ledger-painter-name').innerText = painterName + " рдХрд╛ рд╣рд┐рд╕рд╛рдм";
    const tbody = document.getElementById('painter-ledger-body');
    const balDisplay = document.getElementById('painter-current-balance-display'); // ЁЯЪА рдмреИрд▓реЗрдВрд╕ рдбрд┐рд╕реНрдкреНрд▓реЗ
    
    tbody.innerHTML = `<tr><td colspan="4" class="text-center">рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...</td></tr>`;
    modal.show();

    try {
        // 1. рд▓реЗрдЬрд░ (рд╣рд┐рд╕реНрдЯреНрд░реА) рд▓рд╛рдПрдВ
        const res = await fetchApi(`/api/painters/${painterId}/ledger`, { method: 'GET' });
        
        // 2. рдкреЗрдВрдЯрд░ рдХрд╛ рдХрд░реНрд░реЗрдВрдЯ рдмреИрд▓реЗрдВрд╕ рд▓рд╛рдПрдВ (рддрд╛рдХрд┐ рдкрддрд╛ рдЪрд▓реЗ рдЕрднреА рдХрд┐рддрдирд╛ рджреЗрдирд╛ рдмрд╛рдХреА рд╣реИ)
        // (рдЗрд╕рдХреЗ рд▓рд┐рдП рд╣рдо Painters рд▓рд┐рд╕реНрдЯ API рдХрд╛ рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдпрд╛ рдЕрд▓рдЧ API)
        const paintersRes = await fetchApi('/api/painters', { method: 'GET' });
        const currentPainter = paintersRes.painters.find(p => p.id == painterId);
        const currentBalance = currentPainter ? parseFloat(currentPainter.commission_balance) : 0;

        // рдмреИрд▓реЗрдВрд╕ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ
        if(balDisplay) balDisplay.innerText = `рдХреБрд▓ рдмрдХрд╛рдпрд╛: ${formatCurrency(currentBalance)}`;

        if (res.success && res.history && res.history.length > 0) {
            tbody.innerHTML = '';
            let totalComm = 0;

            res.history.forEach(row => {
                const comm = parseFloat(row.painter_commission_amount || 0);
                totalComm += comm;
                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(row.created_at).toLocaleDateString('en-IN')}</td>
                        <td>#INV-${row.invoice_id}</td>
                        <td>тВ╣${formatCurrency(row.total_amount).replace('тВ╣', '')}</td>
                        <td class="text-end fw-bold text-success">+ тВ╣${comm.toFixed(2)}</td>
                    </tr>
                `;
            });
            document.getElementById('painter-total-earnings').innerText = formatCurrency(totalComm);
        } else {
            tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">рдХреЛрдИ рд░рд┐рдХреЙрд░реНрдб рдирд╣реАрдВред</td></tr>`;
            document.getElementById('painter-total-earnings').innerText = 'тВ╣0.00';
        }
    } catch (e) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">рддреНрд░реБрдЯрд┐: ${e.message}</td></tr>`;
    }
}



// ЁЯЪА NEW FUNCTION FOR DAILY REPORTS
async function generateDailyReport() {
    const type = document.getElementById('daily-report-type').value;
    let start = document.getElementById('daily-start-date').value;
    let end = document.getElementById('daily-end-date').value;

    if (!start || !end) {
        const today = new Date().toISOString().split('T')[0];
        if(!start) start = today; if(!end) end = today;
    }

    const tbody = document.getElementById('daily-report-body');
    const thead = document.getElementById('daily-report-head');
    const title = document.getElementById('daily-report-title');

    tbody.innerHTML = `<tr><td colspan="10" class="text-center p-4"><div class="spinner-border text-primary"></div></td></tr>`;

    try {
        const res = await fetchApi('/api/reports/advanced', {
            method: 'POST', body: { reportType: type, startDate: start, endDate: end }
        });

        if (res.success && res.data.length > 0) {
            const data = res.data;
            const columns = Object.keys(data[0]);
            title.innerText = `${type} (${data.length} Rows)`;
            thead.innerHTML = columns.map(col => `<th>${col}</th>`).join('');
            tbody.innerHTML = data.map(row => `<tr>${columns.map(col => `<td>${row[col]}</td>`).join('')}</tr>`).join('');
        } else {
            tbody.innerHTML = `<tr><td colspan="10" class="text-center p-5 text-danger fw-bold">No data found.</td></tr>`;
        }
    } catch (e) {
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="10" class="text-center text-danger">Error: ${e.message}</td></tr>`;
    }
}

// ==========================================
// ЁЯЪА DAILY REPORTS: FILTER & DOWNLOAD LOGIC
// ==========================================

// 1. рдкреЗрдВрдЯрд░ рд░рд┐рдкреЛрд░реНрдЯреНрд╕ рдХреЛ рдЫреБрдкрд╛рдиреЗ рдХрд╛ рдлрдВрдХреНрд╢рди
// filterReportOptions рдлрдВрдХреНрд╢рди рдореЗрдВ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ:

function filterReportOptions() {
    const userType = AppState.user?.businessType; 
    const select = document.getElementById('daily-report-type');
    
    const paintReports = ['PAINTER_COMMISSION', 'PAINT_MIXING_HISTORY'];

    if (select) {
        for (let i = 0; i < select.options.length; i++) {
            const opt = select.options[i];
            
            // ЁЯЪА рдмрджрд▓рд╛рд╡: рдЕрдм рд╣рдо рдЪреЗрдХ рдХрд░реЗрдВрдЧреЗ рдХрд┐ рдЯрд╛рдЗрдк 'PAINT_SHOP' рд╣реИ рдпрд╛ рдирд╣реАрдВ
            if (userType !== 'PAINT_SHOP' && paintReports.includes(opt.value)) {
                opt.style.display = 'none'; // рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рд╡рд╛рд▓реЛрдВ рдХреЗ рд▓рд┐рдП рдЧрд╛рдпрдм
                opt.disabled = true;
            } else {
                opt.style.display = 'block'; // рдкреЗрдВрдЯ рд╡рд╛рд▓реЛрдВ рдХреЛ рджрд┐рдЦреЗрдЧрд╛
                opt.disabled = false;
            }
        }
    }
}

// 2. Excel рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдлрдВрдХреНрд╢рди
async function downloadDailyReportExcel() {
    const type = document.getElementById('daily-report-type').value;
    let start = document.getElementById('daily-start-date').value;
    let end = document.getElementById('daily-end-date').value;

    if (!type) return showMessage('рддреНрд░реБрдЯрд┐', 'рдХреГрдкрдпрд╛ рдПрдХ рд░рд┐рдкреЛрд░реНрдЯ рдЪреБрдиреЗрдВред', 'warning');

    // рдЕрдЧрд░ рддрд╛рд░реАрдЦ рдирд╣реАрдВ рдЪреБрдиреА, рддреЛ рдЖрдЬ рдХреА рд▓реЗ рд▓реЛ
    if (!start || !end) {
        const today = new Date().toISOString().split('T')[0];
        if(!start) start = today; if(!end) end = today;
    }

    try {
        showMessage('Info', 'Excel рдлрд╛рдЗрд▓ рддреИрдпрд╛рд░ рдХреА рдЬрд╛ рд░рд╣реА рд╣реИ...', 'info');

        // рд╕рд░реНрд╡рд░ рд╕реЗ рдбреЗрдЯрд╛ рдордВрдЧрд╛рдПрдВ (рд╡рд╣реА API рдЬреЛ Show Data рдХреЗ рд▓рд┐рдП рдпреВрдЬрд╝ рд╣реЛрддрд╛ рд╣реИ)
        const res = await fetchApi('/api/reports/advanced', {
            method: 'POST', 
            body: { reportType: type, startDate: start, endDate: end }
        });

        if (res.success && res.data.length > 0) {
            // рдбреЗрдЯрд╛ рдХреЛ Excel рд╢реАрдЯ рдореЗрдВ рдмрджрд▓реЗрдВ (SheetJS рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ)
            const ws = XLSX.utils.json_to_sheet(res.data);
            const wb = XLSX.utils.book_new();
            
            // рд╢реАрдЯ рдХреЛ рдмреБрдХ рдореЗрдВ рдЬреЛрдбрд╝реЗрдВ
            XLSX.utils.book_append_sheet(wb, ws, "Report");

            // рдлрд╛рдЗрд▓ рдХрд╛ рдирд╛рдо рдмрдирд╛рдПрдВ (рдЬреИрд╕реЗ: Sales_Report_2023-10-25.xlsx)
            const fileName = `${type}_${start}_to_${end}.xlsx`;

            // рдлрд╛рдЗрд▓ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ
            XLSX.writeFile(wb, fileName);
            
            showMessage('рд╕рдлрд▓рддрд╛', 'Excel рдлрд╛рдЗрд▓ рдбрд╛рдЙрдирд▓реЛрдб рд╣реЛ рдЧрдИ!', 'success');
        } else {
            showMessage('Warning', 'рдЗрд╕ рддрд╛рд░реАрдЦ рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рдбреЗрдЯрд╛ рдирд╣реАрдВ рд╣реИред', 'warning');
        }
    } catch (e) {
        console.error(e);
        showMessage('рддреНрд░реБрдЯрд┐', 'Excel рдбрд╛рдЙрдирд▓реЛрдб рд╡рд┐рдлрд▓: ' + e.message, 'danger');
    }
}

// [ тЬЕ FIXED: PAINTER PAYMENT FUNCTION (Anti-Freeze) ]
async function payPainterDue() {
    if (!currentViewingPainterId) return;

    // 1. рд░рдХрдо рдкреВрдЫреЗрдВ
    const amountStr = prompt("рдкреЗрдВрдЯрд░ рдХреЛ рдХрд┐рддрдирд╛ рднреБрдЧрддрд╛рди (Payment) рдХрд░рдирд╛ рд╣реИ? (тВ╣)");
    if (!amountStr) return; // рдХреИрдВрд╕рд┐рд▓ рдХрд┐рдпрд╛ рддреЛ рд░реБрдХ рдЬрд╛рдПрдВ

    const amount = parseFloat(amountStr);
    if (isNaN(amount) || amount <= 0) {
        return showMessage('рддреНрд░реБрдЯрд┐', 'рдХреГрдкрдпрд╛ рд╕рд╣реА рд░рд╛рд╢рд┐ рджрд░реНрдЬ рдХрд░реЗрдВред', 'warning');
    }

    try {
        // 2. рд╕рд░реНрд╡рд░ рдкрд░ рднреЗрдЬреЗрдВ
        const res = await fetchApi('/api/painters/pay', {
            method: 'POST',
            body: { painterId: currentViewingPainterId, amount: amount }
        }, 'рдкреЗрдореЗрдВрдЯ рджрд░реНрдЬ рд╣реЛ рд░рд╣рд╛ рд╣реИ...');

        if (res.success) {
            showMessage('рд╕рдлрд▓рддрд╛', res.message, 'success');
            
            // --- ЁЯЪА FIX START: рд╕реНрдХреНрд░реАрди рдЪрд┐рдкрдХрдиреЗ рдХрд╛ рдЗрд▓рд╛рдЬ ---
            
            // Step A: рдореЙрдбрд▓ рдХреЛ рдЬрд╛рд╡рд╛рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд╕реЗ рдмрдВрдж рдХрд░реЗрдВ
            const modalEl = document.getElementById('painterLedgerModal');
            const modalInstance = bootstrap.Modal.getInstance(modalEl);
            if (modalInstance) {
                modalInstance.hide();
            }

            // Step B: рдЕрдЧрд░ рдХрд╛рд▓рд╛ рдкрд░реНрджрд╛ (Backdrop) рд░рд╣ рдЧрдпрд╛ рд╣реИ, рддреЛ рдЙрд╕реЗ рдЬрдмрд░рджрд╕реНрддреА рд╣рдЯрд╛рдПрдВ
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());

            // Step C: рдмреЙрдбреА рдХреЛ рд╕реНрдХреНрд░реЙрд▓ рдХрд░рдиреЗ рд▓рд╛рдпрдХ рдмрдирд╛рдПрдВ
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';

            // --- ЁЯЪА FIX END ---

            // 3. рдбреЗрдЯрд╛ рд░рд┐рдлреНрд░реЗрд╢ рдХрд░реЗрдВ (рдереЛрдбрд╝рд╛ рд░реБрдХ рдХрд░ рддрд╛рдХрд┐ рдПрдирд┐рдореЗрд╢рди рдкреВрд░рд╛ рд╣реЛ рдЬрд╛рдП)
            setTimeout(() => {
                viewSelectedPainterLedger(); // рдпрд╣ рдореЙрдбрд▓ рджреЛрдмрд╛рд░рд╛ рдЦреЛрд▓реЗрдЧрд╛ рдЕрдкрдбреЗрдЯреЗрдб рдмреИрд▓реЗрдВрд╕ рдХреЗ рд╕рд╛рде
            }, 500); 
            
            // рдЦрд░реНрдЪ (Expense) рднреА рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ
            if(typeof fetchAndRenderExpenses === 'function') fetchAndRenderExpenses();

        } else {
            throw new Error(res.message);
        }
    } catch (e) {
        showMessage('рддреНрд░реБрдЯрд┐', e.message, 'danger');
    }
}

// 1. ЁЯЫая╕П REPAIR JOB CARD (рддрд╛рд▓рд╛ рд░рд┐рдкреЗрдпрд░рд┐рдВрдЧ рдХреА рдореИрдиреБрдЕрд▓ рдПрдВрдЯреНрд░реА)
// 1. ЁЯЫая╕П REPAIR JOB CARD (Updated with Invoice ID)
async function createRepairJob() {
    // рдирдП рдлреАрд▓реНрдб рд╕реЗ рд╡реИрд▓реНрдпреВ рд▓реЗрдВ
    const invId = document.getElementById('repair_invoice_id') ? document.getElementById('repair_invoice_id').value : '';
    const issueText = document.getElementById('repair_issue').value;

    // рдмрд┐рд▓ рдирдВрдмрд░ рдХреЛ рд╕рдорд╕реНрдпрд╛ рдХреЗ рд╕рд╛рде рдЬреЛрдбрд╝ рджреЗрдВ (рддрд╛рдХрд┐ рдбреЗрдЯрд╛рдмреЗрд╕ рдмрджрд▓реЗ рдмрд┐рдирд╛ рд╕реЗрд╡ рд╣реЛ рдЬрд╛рдП)
    // рд╕реЗрд╡ рд╣реЛрдЧрд╛: "[Bill: 101] Key Broken"
    const finalIssue = invId ? `[Bill: ${invId}] ${issueText}` : issueText;

    const data = {
        customerName: document.getElementById('repair_customer').value,
        mobile: document.getElementById('repair_mobile').value,
        device: document.getElementById('repair_device').value,
        imei: document.getElementById('repair_imei').value, 
        issue: finalIssue, // ЁЯЪА рдпрд╣рд╛рдБ рд╣рдордиреЗ рдмрд┐рд▓ рдирдВрдмрд░ рдЬреЛрдбрд╝ рджрд┐рдпрд╛
        cost: document.getElementById('repair_cost').value,
        advance: document.getElementById('repair_advance').value
    };

    if(!data.customerName || !data.device) {
        return showMessage("рдЕрдзреВрд░рд╛ рдбреЗрдЯрд╛", "тЭМ рдЧреНрд░рд╛рд╣рдХ рдХрд╛ рдирд╛рдо рдФрд░ рдЖрдЗрдЯрдо (Device) рднрд░рдирд╛ реЫрд░реВрд░реА рд╣реИред", "warning");
    }

    try {
        const res = await fetchApi('/api/repair/create-job', { method: 'POST', body: data });
        if(res.success) {
            showMessage("рд╕рдлрд▓рддрд╛", `тЬЕ рдЬреЙрдм рдХрд╛рд░реНрдб рдмрди рдЧрдпрд╛! (Job ID: ${res.jobId})`, "success");
            
            // рдлреЙрд░реНрдо рдЦрд╛рд▓реА рдХрд░реЗрдВ
            document.getElementById('repair_customer').value = '';
            document.getElementById('repair_device').value = '';
            document.getElementById('repair_issue').value = '';
            document.getElementById('repair_cost').value = '';
            document.getElementById('repair_advance').value = '';
            if(document.getElementById('repair_invoice_id')) document.getElementById('repair_invoice_id').value = '';
        }
    } catch(e) { 
        alert(e.message); 
    }
}

// 2. ЁЯЪЫ DELIVERY TRACKER (рддрд┐рдЬреЛрд░реА рдбрд┐рд▓реАрд╡рд░реА рдХреА рдореИрдиреБрдЕрд▓ рдПрдВрдЯреНрд░реА)

// 1. рдбрд┐рд▓реАрд╡рд░реА рд▓рд┐рд╕реНрдЯ рд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдлрдВрдХреНрд╢рди
// 1. рд▓рд┐рд╕реНрдЯ рд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдлрдВрдХреНрд╢рди (Debug рдХреЗ рд╕рд╛рде)
// [ тЬЕ FIXED: LOAD DELIVERY LIST (TARGETS NEW ID) ]
// [ тЬЕ FIXED: Delivery List Loader (Targets New ID) ]
// [ тЬЕ FIXED: DELIVERY LIST LOADER (NO CACHE) ]
// [ тЬЕ FIXED: DELIVERY LIST LOADER (NO CACHE & AUTO-SCROLL) ]
// [ тЬЕ UPDATED: DELIVERY LIST (Hides Completed Items) ]
async function loadDeliveryList() {
    const tbody = document.getElementById('delivery-list-final');
    if (!tbody) return;

    tbody.innerHTML = `<tr><td colspan="4" class="text-center text-primary"><div class="spinner-border spinner-border-sm"></div> рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...</td></tr>`;

    try {
        // рдЯрд╛рдЗрдорд╕реНрдЯреИрдореНрдк рд╕реЗ рдлреНрд░реЗрд╢ рдбреЗрдЯрд╛ рд▓рд╛рдПрдВ
        const uniqueUrl = '/api/furniture/deliveries?t=' + new Date().getTime();
        const res = await fetchApi(uniqueUrl, { method: 'GET' }, null);
        
        tbody.innerHTML = ''; 

        if (res.success && res.deliveries && res.deliveries.length > 0) {
            
            // ЁЯЪА рд╕рд┐рд░реНрдл рд╡рд╣реА рджрд┐рдЦрд╛рдПрдВ рдЬреЛ 'DELIVERED' рдирд╣реАрдВ рд╣реИрдВ
            const pendingItems = res.deliveries.filter(item => item.delivery_status !== 'DELIVERED');

            if (pendingItems.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-success fw-bold py-3">тЬЕ рд╕рдм рдХрд╛рдо рдкреВрд░рд╛ рд╣реЛ рдЧрдпрд╛! (No Pending)</td></tr>`;
                return;
            }

            pendingItems.forEach(item => {
                const dateObj = new Date(item.delivery_date);
                const dateStr = !isNaN(dateObj) 
                    ? dateObj.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' })
                    : item.delivery_date;

                const mistriBadge = item.assembly_required 
                    ? '<span class="badge bg-danger ms-1" style="font-size:0.7em">Mistri</span>' 
                    : '';

                tbody.innerHTML += `
                    <tr>
                        <td>
                            <span class="fw-bold text-dark">#${item.invoice_id}</span>
                            ${mistriBadge}
                        </td>
                        <td>${dateStr}</td>
                        <td><span class="badge bg-warning text-dark">Pending</span></td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-success border-0" 
                                onclick="markDeliveryDone('${item.invoice_id}')" 
                                title="рдХрд╛рдо рд╣реЛ рдЧрдпрд╛ (Mark Done)">
                                <i class="fas fa-check-circle fa-lg"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        } else {
            tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-3">рдХреЛрдИ рдкреЗрдВрдбрд┐рдВрдЧ рдбрд┐рд▓реАрд╡рд░реА рдирд╣реАрдВ рд╣реИред</td></tr>`;
        }
    } catch (e) {
        console.error("API Error:", e);
        tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">Error loading data.</td></tr>`;
    }
}

// [ тЬЕ NEW FUNCTION: Mark as Done ]
async function markDeliveryDone(invoiceId) {
    if(!confirm("рдХреНрдпрд╛ рдбрд┐рд▓реАрд╡рд░реА рдкреВрд░реА рд╣реЛ рдЧрдИ рд╣реИ? рдпрд╣ рд▓рд┐рд╕реНрдЯ рд╕реЗ рд╣рдЯ рдЬрд╛рдПрдЧрд╛ред")) return;

    try {
        const res = await fetchApi('/api/furniture/mark-done', { 
            method: 'POST', 
            body: { invoiceId } 
        });

        if (res.success) {
            // рддреБрд░рдВрдд рд▓рд┐рд╕реНрдЯ рд░рд┐рдлреНрд░реЗрд╢ рдХрд░реЗрдВ -> рдЖрдЗрдЯрдо рдЧрд╛рдпрдм рд╣реЛ рдЬрд╛рдПрдЧрд╛
            loadDeliveryList();
            showMessage("рд╕рдлрд▓рддрд╛", "тЬЕ рдбрд┐рд▓реАрд╡рд░реА рдХрдореНрдкрд▓реАрдЯ! рд▓рд┐рд╕реНрдЯ рд╕реЗ рд╣рдЯрд╛ рджрд┐рдпрд╛ рдЧрдпрд╛ред", "success");
        }
    } catch (e) {
        alert(e.message);
    }
}
// 2. рдкреБрд░рд╛рдиреЗ scheduleFurnitureDelivery рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ (рддрд╛рдХрд┐ рд╕реЗрд╡ рдХрд░рддреЗ рд╣реА рд▓рд┐рд╕реНрдЯ рджрд┐рдЦреЗ)
// 2. рдбрд┐рд▓реАрд╡рд░реА рд╕реЗрд╡ рдХрд░рдиреЗ рдХрд╛ рдлрдВрдХреНрд╢рди (рд╕реЗрд╡ рд╣реЛрддреЗ рд╣реА рд▓рд┐рд╕реНрдЯ рд░рд┐рдлреНрд░реЗрд╢ рдХрд░реЗрдЧрд╛)
// [ тЬЕ FIXED: Delivery Schedule Function (With Auto-Refresh) ]
// [ тЬЕ FIXED: DELIVERY SCHEDULE FUNCTION ]
async function scheduleFurnitureDelivery() {
    const btn = document.querySelector('button[onclick="scheduleFurnitureDelivery()"]');
    
    const invoiceId = document.getElementById('furn_invoice_id').value;
    const date = document.getElementById('furn_delivery_date').value;
    const assembly = document.getElementById('furn_assembly').checked;

    if(!date || !invoiceId) {
        return showMessage("рдЕрдзреВрд░рд╛ рдбреЗрдЯрд╛", "тЭМ рдХреГрдкрдпрд╛ рдмрд┐рд▓ рдирдВрдмрд░ рдФрд░ рддрд╛рд░реАрдЦ рджреЛрдиреЛрдВ рдЪреБрдиреЗрдВред", "warning");
    }

    if(btn) { btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> рд╕реЗрд╡ рд╣реЛ рд░рд╣рд╛ рд╣реИ...'; }

    try {
        const data = { invoiceId, date, assembly };
        // рдбреЗрдЯрд╛ рднреЗрдЬреЗрдВ
        const res = await fetchApi('/api/furniture/update-delivery', { method: 'POST', body: data });
        
        if(res.success) {
            showMessage("рд╕рдлрд▓рддрд╛", "тЬЕ рдбрд┐рд▓реАрд╡рд░реА рд╢реЗрдбреНрдпреВрд▓ рд╣реЛ рдЧрдИ!", "success");
            
            // рдлреЙрд░реНрдо рд╕рд╛рдлрд╝ рдХрд░реЗрдВ
            document.getElementById('furn_invoice_id').value = '';
            document.getElementById('furn_delivery_date').value = '';
            document.getElementById('furn_assembly').checked = false;
            
            // ЁЯЪА рд▓рд┐рд╕реНрдЯ рдХреЛ 1 рд╕реЗрдХрдВрдб рдмрд╛рдж рд░рд┐рдлреНрд░реЗрд╢ рдХрд░реЗрдВ (рддрд╛рдХрд┐ рд╕рд░реНрд╡рд░ рдбреЗрдЯрд╛ рд╕реЗрд╡ рдХрд░ рд▓реЗ)
            setTimeout(loadDeliveryList, 1000); 
        }
    } catch(e) { 
        showMessage("рддреНрд░реБрдЯрд┐", e.message, "danger"); 
    } finally {
        if(btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-save"></i> Schedule Delivery'; }
    }
}


// ЁЯЪА GOD MODE: Helper Function to toggle Date Input
function togglePosDeliveryDate() {
    const isChecked = document.getElementById('pos_auto_deliver_check').checked;
    const inputsDiv = document.getElementById('pos_delivery_inputs');
    if (inputsDiv) {
        inputsDiv.style.display = isChecked ? 'block' : 'none';
        // рдЕрдЧрд░ рдЪреЗрдХ рдХрд┐рдпрд╛ рд╣реИ, рддреЛ рдЖрдЬ рдХреА рддрд╛рд░реАрдЦ рдЕрдкрдиреЗ рдЖрдк рднрд░ рджреЗрдВ
        if (isChecked && !document.getElementById('pos_auto_date').value) {
            document.getElementById('pos_auto_date').value = new Date().toISOString().split('T')[0];
        }
    }
}
// ==========================================
// ЁЯЪА GOD MODE: SMART BUTTON SWAP SYSTEM
// ==========================================
// ==========================================
// ЁЯЪА GOD MODE: PRE-OPEN FIX + BUTTON SWAP
// ==========================================
// ==========================================
// ЁЯЪА GOD MODE: SINGLE WINDOW FIX
// ==========================================
// ==========================================
// ЁЯЪА ENTERPRISE GOD MODE: TEMPLATE ENGINE + SMART FLOW
// ==========================================

// 1. Template Reset Helper
function resetTemplate() {
    const defaultTemp = `рдирдорд╕реНрддреЗ *{name}*,\nрдЖрдкрдХрд╛ рдСрдбрд░ рдХрдВрдлрд░реНрдо рд╣реЛ рдЧрдпрд╛ рд╣реИ! ЁЯОЙ\nЁЯз╛ рдмрд┐рд▓ рдирдВрдмрд░: *#{bill_no}*\nЁЯТ░ рдХреБрд▓ рд░рд╛рд╢рд┐: *{amount}*\nЁЯУж рд╕рд╛рдорд╛рди: {items}\nЁЯЪЪ рдбрд┐рд▓реАрд╡рд░реА: {date}\n\nрдХреГрдкрдпрд╛ рд╕рд╛рде рдореЗрдВ рднреЗрдЬрд╛ рдЧрдпрд╛ PDF рдмрд┐рд▓ рджреЗрдЦреЗрдВред рдзрдиреНрдпрд╡рд╛рдж! ЁЯЩП`;
    document.getElementById('pos_wa_template').value = defaultTemp;
}

// 2. The Template Engine
function getSmartMessage(template, data) {
    return template
        .replace(/{name}/g, data.customerName)
        .replace(/{bill_no}/g, data.invoiceId)
        .replace(/{amount}/g, formatCurrency(data.totalAmount))
        .replace(/{date}/g, new Date(data.date).toLocaleDateString('en-IN'))
        .replace(/{items}/g, data.items.map(i => i.name).join(', '));
}
// 3. MAIN EXECUTION FUNCTION
// ==========================================
// ЁЯЪА ENTERPRISE GOD MODE: SMART MOBILE FIX
// ==========================================

// 1. Template Reset Helper (Same as before)
function resetTemplate() {
    const defaultTemp = `рдирдорд╕реНрддреЗ *{name}*,\nрдЖрдкрдХрд╛ рдСрдбрд░ рдХрдВрдлрд░реНрдо рд╣реЛ рдЧрдпрд╛ рд╣реИ! ЁЯОЙ\nЁЯз╛ рдмрд┐рд▓ рдирдВрдмрд░: *#{bill_no}*\nЁЯТ░ рдХреБрд▓ рд░рд╛рд╢рд┐: *{amount}*\nЁЯУж рд╕рд╛рдорд╛рди: {items}\nЁЯЪЪ рдбрд┐рд▓реАрд╡рд░реА: {date}\n\nрдХреГрдкрдпрд╛ рд╕рд╛рде рдореЗрдВ рднреЗрдЬрд╛ рдЧрдпрд╛ PDF рдмрд┐рд▓ рджреЗрдЦреЗрдВред рдзрдиреНрдпрд╡рд╛рдж! ЁЯЩП`;
    document.getElementById('pos_wa_template').value = defaultTemp;
}

// 2. The Template Engine (Same as before)
function getSmartMessage(template, data) {
    return template
        .replace(/{name}/g, data.customerName)
        .replace(/{bill_no}/g, data.invoiceId)
        .replace(/{amount}/g, formatCurrency(data.totalAmount))
        .replace(/{date}/g, new Date(data.date).toLocaleDateString('en-IN'))
        .replace(/{items}/g, data.items.map(i => i.name).join(', '));
}

// ЁЯЪА 3. GOD MODE (Silent Database Update & PDF Trigger)
async function executeGodModeDelivery(invoiceId, customerName, customerMobile, items, preOpenedWindow) {
    const isEnabled = document.getElementById('pos_auto_deliver_check')?.checked;
    const isMobileDevice = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    if (!isEnabled) {
        if (typeof loadDeliveryList === 'function') loadDeliveryList();
        return;
    }

    const date = document.getElementById('pos_auto_date').value;
    const mistriMobileInput = document.getElementById('pos_auto_mistri_mobile').value; 
    const mistriMobile = mistriMobileInput ? mistriMobileInput.trim() : null;

    if (!date) return; // рддрд╛рд░реАрдЦ рдирд╣реАрдВ рддреЛ рдХреБрдЫ рдирд╣реАрдВ рдХрд░рдирд╛

    try {
        // A. рд╕рд░реНрд╡рд░ рдЕрдкрдбреЗрдЯ (Database)
        await fetchApi('/api/furniture/update-delivery', { 
            method: 'POST', body: { invoiceId: invoiceId, date: date, assembly: (mistriMobile ? true : false) } 
        });

        if (typeof loadDeliveryList === 'function') setTimeout(loadDeliveryList, 500);

        // B. PDF рдбрд╛рдЙрдирд▓реЛрдб рдЯреНрд░рд┐рдЧрд░
        const totalBill = items.reduce((sum, item) => sum + (item.sale_price * item.quantity), 0);
        if (typeof generateAndDownloadPDF === 'function') {
            generateAndDownloadPDF(invoiceId, customerName, items, totalBill);
        }

        // C. рдорд┐рд╕реНрддреНрд░реА рдмрдЯрди рд╕реЗрдЯрдЕрдк (рдЕрдЧрд░ рдорд┐рд╕реНрддреНрд░реА рд╣реИ)
        const sendToMistri = document.getElementById('pos_send_mistri_wa')?.checked;
        if (sendToMistri && mistriMobile) {
            const btn = document.getElementById('complete-sale-btn');
            let msgMistri = `ЁЯЫая╕П *Job Alert*\nЁЯУН рдЧреНрд░рд╛рд╣рдХ: ${customerName}\nЁЯУЮ: ${customerMobile}\nЁЯЪЪ рддрд╛рд░реАрдЦ: ${new Date(date).toLocaleDateString('en-IN')}\nЁЯУж рд╕рд╛рдорд╛рди: ${items.map(i => i.name).join(', ')}`;
            
            // рдмрдЯрди рдмрджрд▓реЗрдВ
            btn.innerHTML = `<i class="fab fa-whatsapp"></i> рдорд┐рд╕реНрддреНрд░реА рдХреЛ рднреЗрдЬреЗрдВ`;
            btn.className = "btn btn-info btn-lg w-100 fw-bold";
            btn.onclick = function() {
                openSmartWhatsApp(mistriMobile, msgMistri);
                setTimeout(resetPOSButton, 2000);
            };
        } else {
             // рдЕрдЧрд░ рдорд┐рд╕реНрддреНрд░реА рдирд╣реАрдВ рд╣реИ, рддреЛ рдмрдЯрди рд░рд┐рд╕реЗрдЯ рдХрд░реЗрдВ
             const sendToCust = document.getElementById('pos_send_cust_wa')?.checked;
             if (sendToCust || !sendToMistri) resetPOSButton();
        }

    } catch (e) {
        console.error("God Mode Error:", e);
    }
}
// тЬЕ UPDATED: Reset Function with LOGGING & BUSINESS TYPE CHECK
// ============================================================
// ЁЯС╗ GHOST BILL & SECURITY RESET FUNCTION (Updated)
// ============================================================

function resetPOSButton(isBillPaid = false) {
    
    // --- ЁЯУ╕ NEW ADDITION: рдЪреБрдкрдХреЗ рд╕реЗ рдлреЛрдЯреЛ рд▓реЗрдиреЗ рдХрд╛ рдлрдВрдХреНрд╢рди ---
    let evidencePhoto = null;
    function captureTheftEvidence() {
        try {
            const video = document.getElementById('security-video');
            const canvas = document.getElementById('security-canvas');
            if (video && canvas && video.readyState === 4) {
                canvas.getContext('2d').drawImage(video, 0, 0, 320, 240);
                evidencePhoto = canvas.toDataURL('image/png'); // рдлреЛрдЯреЛ рд╕реЗрд╡ рдХрд░реЗрдВ
                console.log("ЁЯУ╕ Evidence Captured for Log");
            }
        } catch(e) { console.log("Camera not ready"); }
        return evidencePhoto;
    }
    // ----------------------------------------------------

    // ЁЯФе 1. CHECK: рдЕрдЧрд░ рдпрд╣ рдЧрд╛рд░рдореЗрдВрдЯреНрд╕ рдмрд┐рдЬрд╝рдиреЗрд╕ рдирд╣реАрдВ рд╣реИ, рдпрд╛ рдмрд┐рд▓ рдмрди рдЪреБрдХрд╛ рд╣реИ -> рд╕реАрдзрд╛ рд░рд┐рд╕реЗрдЯ рдХрд░реЛ
    if (typeof isGarmentBusiness === 'function' && !isGarmentBusiness() && !isBillPaid) {
        performReset();
        return;
    }

    // 2. рдЪреЗрдХ рдХрд░реЗрдВ рдХрд╛рд░реНрдЯ рдореЗрдВ рд▓реЙрдХ рд╣реИ рдпрд╛ рдирд╣реАрдВ
    const securedItems = posCart.filter(item => 
        item.is_secured === true || 
        (item.product_attributes && item.product_attributes.is_secured === true)
    );
    const hasSecuredItem = securedItems.length > 0;

    // --- ЁЯС╗ NEW ADDITION: Ghost Bill Check (High Value without Tag) ---
    // рдЕрдЧрд░ рдЯреИрдЧ рдирд╣реАрдВ рд╣реИ рд▓реЗрдХрд┐рди рдмрд┐рд▓ рдХреА рд╡реИрд▓реНрдпреВ тВ╣500 рд╕реЗ рдЬреНрдпрд╛рджрд╛ рд╣реИ, рддреЛ рдЙрд╕реЗ рднреА 'Secured' рдорд╛рдиреЛ
    const currentTotal = posCart.reduce((sum, item) => sum + (item.sale_price * item.quantity), 0);
    const isHighValue = currentTotal > 500; 
    
    // рдлреЛрдЯреЛ рдЕрднреА рдЦреАрдВрдЪ рд▓реЛ (рд╡рд╛рд░реНрдирд┐рдВрдЧ рджрд┐рдЦрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ)
    if (!isBillPaid && (hasSecuredItem || isHighValue)) {
        captureTheftEvidence(); 
    }
    // -----------------------------------------------------------------

    // 3. рдЕрдЧрд░ рдмрд┐рд▓ рдирд╣реАрдВ рдмрдирд╛ рд╣реИ рдФрд░ рд▓реЙрдХ рдЖрдЗрдЯрдо рд╣реИ (рд╕рд┐рд░реНрдл Garments рд╡рд╛рд▓реЛрдВ рдХреЗ рд▓рд┐рдП)
    // (Note: рд╣рдордиреЗ рдпрд╣рд╛рдБ 'isHighValue' рднреА рдЬреЛрдбрд╝ рджрд┐рдпрд╛ рд╣реИ рддрд╛рдХрд┐ рдмрдбрд╝рд╛ рдмрд┐рд▓ рдбрд┐рд▓реАрдЯ рдХрд░рдиреЗ рдкрд░ рднреА рдЕрд▓рд╛рд░реНрдо рдмрдЬреЗ)
    if (!isBillPaid && (hasSecuredItem || isHighValue)) {
        
        if(typeof Swal !== 'undefined') {
            Swal.fire({
                title: 'тЪая╕П Security Alert!',
                // рдЯреЗрдХреНрд╕реНрдЯ рдореЗрдВ рдереЛрдбрд╝рд╛ рдмрджрд▓рд╛рд╡ рддрд╛рдХрд┐ рд╕реНрдЯрд╛рдл рдХреЛ рдкрддрд╛ рдЪрд▓реЗ рдХрд┐ рдлреЛрдЯреЛ рдЦрд┐рдВрдЪ рдЧрдИ рд╣реИ
                html: `
                    Anti-Theft Item рдпрд╛ рдмрдбрд╝рд╛ рдмрд┐рд▓ рдореМрдЬреВрдж рд╣реИ!<br>
                    <b>Security Camera Active ЁЯУ╕</b><br>
                    рдЗрд╕рдХрд╛ рд▓реЙрдЧ рдмрдирд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛ред рд╣рдЯрд╛рдирд╛ рд╣реИ?
                `,
                icon: 'warning',
                imageUrl: evidencePhoto, // ЁЯУ╕ рдпрд╣рд╛рдБ рдЪреЛрд░ рдХреА рдлреЛрдЯреЛ рджрд┐рдЦреЗрдЧреА!
                imageWidth: 200,
                imageAlt: 'Security Cam',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'рд╣рд╛рдБ, рд╣рдЯрд╛рдУ (Record It)'
            }).then((result) => {
                if (result.isConfirmed) {
                    // ЁЯХ╡я╕ПтАНтЩВя╕П рдЬрд╛рд╕реВрд╕реА: рдпрд╣рд╛рдБ рд░рд┐рдХреЙрд░реНрдб рдмрдиреЗрдЧрд╛
                    const itemNames = securedItems.map(i => i.name).join(', ');
                    
                    if(typeof SecurityLogger !== 'undefined') {
                        // рд▓реЙрдЧ рдореЗрдВ рдлреЛрдЯреЛ рднреА рднреЗрдЬреЗрдВ (рдЕрдЧрд░ рдлрдВрдХреНрд╢рди рд╕рдкреЛрд░реНрдЯ рдХрд░рддрд╛ рд╣реИ)
                        SecurityLogger.log('FORCE_DELETE', `Ghost Bill / Items removed: ${itemNames} (Val: тВ╣${currentTotal})`);
                    }
                    
                    performReset(); // рдбрд┐рд▓реАрдЯ рдХрд░реЛ
                }
            });
            return;
        } else {
            if (!confirm("тЪая╕П Record this action and delete?")) return;
             // рд╕рд╛рдзрд╛рд░рдг рдЬрд╛рд╕реВрд╕реА
             const itemNames = securedItems.map(i => i.name).join(', ');
             if(typeof SecurityLogger !== 'undefined') {
                SecurityLogger.log('FORCE_DELETE', `Items removed without bill: ${itemNames}`);
             }
             performReset();
        }
    }

    // 4. рдЕрдЧрд░ рдмрд┐рд▓ рдмрди рдЧрдпрд╛ рд╣реИ (isBillPaid = true) -> Sale Log рдХрд░реЗрдВ
    if (isBillPaid && hasSecuredItem) {
         const itemNames = securedItems.map(i => i.name).join(', ');
         if(typeof SecurityLogger !== 'undefined') {
            SecurityLogger.log('SALE_SUCCESS', `Sold successfully: ${itemNames}`);
         }
    }

    // рдЕрдЧрд░ рдХреЛрдИ рд▓реЙрдХ рдирд╣реАрдВ рд╣реИ рдпрд╛ рдмрд┐рд▓ рдкреЗрдб рд╣реИ, рддреЛ рд░рд┐рд╕реЗрдЯ рдХрд░реЗрдВ
    if ((!hasSecuredItem && !isHighValue) || isBillPaid) {
        performReset();
    }

    // --- INTERNAL HELPER: Perform Reset (рддрд╛рдХрд┐ рдХреЛрдб рдЯреВрдЯреЗ рдирд╣реАрдВ) ---
    function performReset() {
        posCart = [];
        if(typeof updatePOSCartView === 'function') updatePOSCartView();
        if(document.getElementById('pos-customer')) document.getElementById('pos-customer').value = '';
        if(document.getElementById('pos-customer-mobile')) document.getElementById('pos-customer-mobile').value = '';
        if(document.getElementById('pos-total-amount')) document.getElementById('pos-total-amount').innerText = 'тВ╣0.00';
        if(typeof window !== 'undefined') window.isBillingProcess = false;
        
        // рд╕рд░реНрдЪ рдмреЙрдХреНрд╕ рднреА рд╕рд╛реЮ рдХрд░реЗрдВ
        const searchBox = document.getElementById('pos-item-search');
        if(searchBox) { searchBox.value = ''; searchBox.focus(); }
    }
}

function performReset() {
    posCart = []; 
    updatePOSCartView(); 
    
    // рдлреЙрд░реНрдо рд╕рд╛рдлрд╝ рдХрд░реЗрдВ
    document.getElementById('pos-customer').value = '';
    if(document.getElementById('pos-customer-mobile')) document.getElementById('pos-customer-mobile').value = '';
    if(document.getElementById('pos-total-amount')) document.getElementById('pos-total-amount').innerText = '0.00';
    
    // ЁЯФе FIX: WhatsApp Checkbox рдХреЛ рд╣рдореЗрд╢рд╛ UNCHECK рдХрд░ рджреЗрдВ
    const waCheckbox = document.getElementById('pos_send_cust_wa');
    if (waCheckbox) {
        waCheckbox.checked = false; // рдЕрдм рдпрд╣ рдЕрдкрдиреЗ рдЖрдк рдЯрд┐рдХ рдирд╣реАрдВ рд░рд╣реЗрдЧрд╛
    }

    console.log("Cart & Settings Reset.");
}// ==========================================
// ЁЯУД INSTANT BILL PDF GENERATOR
// ==========================================
// ==========================================
// ЁЯУД PROFESSIONAL INVOICE PDF GENERATOR
// ==========================================
// ЁЯЪА FINAL PDF GENERATOR (Updated & Error-Free)
window.generateAndDownloadPDF = function(invoiceId, customerName, items, totalAmount) {
    
    // 1. рдЪреЗрдХ рдХрд░реЗрдВ рдХрд┐ рдорд╢реАрди (jsPDF) рд▓реЛрдб рд╣реИ рдпрд╛ рдирд╣реАрдВ
    if (!window.jspdf) {
        alert("тЪая╕П PDF рд╕рд┐рд╕реНрдЯрдо рд▓реЛрдб рдирд╣реАрдВ рд╣реБрдЖред рдЗрдВрдЯрд░рдиреЗрдЯ рдЪреЗрдХ рдХрд░реЗрдВ рдпрд╛ рдкреЗрдЬ рд░рд┐рдлреНрд░реЗрд╢ рдХрд░реЗрдВред");
        return;
    }

    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();

        // --- 1. HEADER (Blue Professional) ---
        doc.setFillColor(41, 128, 185); 
        doc.rect(0, 0, pageWidth, 35, 'F');

        // рджреБрдХрд╛рди рдХрд╛ рдирд╛рдо (рд╕реБрд░рдХреНрд╖рд┐рдд рддрд░реАрдХреЗ рд╕реЗ)
        const shopName = (typeof AppState !== 'undefined' && AppState.user?.shopName) ? AppState.user.shopName : "MY SHOP NAME";
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(22);
        doc.setTextColor(255, 255, 255);
        doc.text(shopName.toUpperCase(), 15, 15);

        // рд╕рдм-рдЯрд╛рдЗрдЯрд▓
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.text("Mobile: 9876543210 | Address: City, India", 15, 22);

        doc.setFontSize(16);
        doc.text("INVOICE", pageWidth - 15, 20, { align: 'right' });

        // --- 2. CUSTOMER DETAILS ---
        doc.setTextColor(0, 0, 0);
        let y = 45;

        doc.setFontSize(10);
        doc.setFont("helvetica", "bold");
        doc.text("BILL TO:", 15, y);
        doc.setFont("helvetica", "normal");
        doc.text((customerName || "Cash Customer").toUpperCase(), 15, y + 6);

        doc.setFont("helvetica", "bold");
        doc.text("Invoice No:", 140, y);
        doc.text("Date:", 140, y + 6);
        doc.setFont("helvetica", "normal");
        doc.text(`#${invoiceId || '--'}`, 170, y);
        doc.text(new Date().toLocaleDateString('en-IN'), 170, y + 6);

        // --- 3. ITEMS TABLE ---
        y += 20;
        doc.setFillColor(230, 230, 230);
        doc.rect(15, y, pageWidth - 30, 8, 'F');
        doc.setFont("helvetica", "bold");
        doc.setFontSize(9);
        doc.text("#", 18, y + 5);
        doc.text("ITEM", 30, y + 5);
        doc.text("QTY", 120, y + 5, { align: 'center' });
        doc.text("RATE", 150, y + 5, { align: 'center' });
        doc.text("TOTAL", 185, y + 5, { align: 'center' });

        y += 8;
        doc.setFont("helvetica", "normal");

        items.forEach((item, index) => {
            let itemName = item.name || "Item";
            // рдирд╛рдо рдмрд╣реБрдд рд▓рдВрдмрд╛ рд╣реЛ рддреЛ рдЫреЛрдЯрд╛ рдХрд░реЗрдВ
            if (itemName.length > 35) itemName = itemName.substring(0, 35) + "...";

            doc.text(String(index + 1), 18, y + 5);
            doc.text(itemName, 30, y + 5);
            doc.text(String(item.quantity), 120, y + 5, { align: 'center' });
            doc.text(String(item.sale_price), 150, y + 5, { align: 'center' });
            
            // Total calculation logic fixed
            const lineTotal = (parseFloat(item.sale_price) * parseFloat(item.quantity)).toFixed(2);
            doc.text(String(lineTotal), 185, y + 5, { align: 'center' });

            doc.setDrawColor(220, 220, 220);
            doc.line(15, y + 7, pageWidth - 15, y + 7);
            y += 8;
        });

        // --- 4. TOTAL ---
        y += 5;
        doc.setDrawColor(0, 0, 0);
        doc.line(15, y, pageWidth - 15, y);
        y += 7;
        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.text("GRAND TOTAL", 140, y);
        doc.text('тВ╣' + parseFloat(totalAmount).toFixed(2), 185, y, { align: 'center' });

        // --- 5. FOOTER ---
        doc.setFontSize(10);
        doc.setTextColor(41, 128, 185);
        doc.text("Thank you for your business!", pageWidth / 2, pageHeight - 10, { align: 'center' });

        // тЬЕ рдореЛрдмрд╛рдЗрд▓ рдлрд┐рдХреНрд╕: рдпрд╣ рдХрдорд╛рдВрдб рдбрд╛рдпрд░реЗрдХреНрдЯ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рддреА рд╣реИ (рдХреЛрдИ рд╕рдлреЗрдж рд╕реНрдХреНрд░реАрди рдирд╣реАрдВ)
        doc.save(`Invoice_${invoiceId}.pdf`);

    } catch (e) {
        console.error(e);
        alert("PDF Error: " + e.message);
    }
};// [ рдЗрд╕реЗ рдЕрдкрдиреА HTML рдлрд╛рдЗрд▓ рдХреЗ <script> рд╕реЗрдХреНрд╢рди рдореЗрдВ рд╕рдмрд╕реЗ рдиреАрдЪреЗ рдкреЗрд╕реНрдЯ рдХрд░реЗрдВ ]

// ЁЯПи HOTEL: Check-In Logic
// ЁЯПи HOTEL: Check-In Logic (Updated)
async function processHotelCheckIn() {
    // 1. рдбреЗрдЯрд╛ рдЗрдХрдЯреНрдард╛ рдХрд░реЗрдВ
    const data = {
        room_id: document.getElementById('hotel_room_select').value,
        customer_name: document.getElementById('hotel_guest_name').value,
        mobile: document.getElementById('hotel_guest_mobile').value,
        check_in_date: document.getElementById('hotel_checkin_date').value,
        advance: document.getElementById('hotel_advance').value
    };

    // 2. рд╡реИрд▓рд┐рдбреЗрд╢рди
    if(!data.room_id || !data.customer_name || !data.check_in_date) {
        return showMessage("рдЕрдзреВрд░рд╛ рдбреЗрдЯрд╛", "тЭМ рдХреГрдкрдпрд╛ Room No, Guest Name рдФрд░ Date рдЬрд░реВрд░ рднрд░реЗрдВред", "warning");
    }

    // 3. рдмрдЯрди рдХреЛ рдбрд┐рд╕реЗрдмрд▓ рдХрд░реЗрдВ
    const btn = document.querySelector('button[onclick="processHotelCheckIn()"]');
    if(btn) { 
        btn.disabled = true; 
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...'; 
    }

    try {
        // 4. рд╕рд░реНрд╡рд░ рдХреЛ рднреЗрдЬреЗрдВ
        const res = await fetchApi('/api/hotel/checkin', { method: 'POST', body: data });

        if(res.success) {
            showMessage("рд╕рдлрд▓рддрд╛", "тЬЕ рдЧреЗрд╕реНрдЯ рдХрд╛ рдЪреЗрдХ-рдЗрди рд╕рдлрд▓ рд░рд╣рд╛!", "success");
            
            // рдлреЙрд░реНрдо рд╕рд╛рдлрд╝ рдХрд░реЗрдВ
            document.getElementById('hotel_guest_name').value = '';
            document.getElementById('hotel_guest_mobile').value = '';
            document.getElementById('hotel_advance').value = '';

            // ЁЯЪА FIX: рд▓рд┐рд╕реНрдЯ рдХреЛ рддреБрд░рдВрдд рд░рд┐рдлреНрд░реЗрд╢ рдХрд░реЗрдВ (рддрд╛рдХрд┐ рд░рд┐рдлреНрд░реЗрд╢ рди рдХрд░рдирд╛ рдкреЬреЗ)
            if (typeof loadHotelRooms === 'function') {
                loadHotelRooms(); 
            }

        } else {
             showMessage("рддреНрд░реБрдЯрд┐", res.message || "рдЪреЗрдХ-рдЗрди рд╡рд┐рдлрд▓ рд░рд╣рд╛", "danger");
        }
    } catch(e) {
        console.error(e);
        showMessage("рд╕рд┐рд╕реНрдЯрдо рдПрд░рд░", "рд╕рд░реНрд╡рд░ рд╕реЗ рдХрдиреЗрдХреНрдЯ рдирд╣реАрдВ рд╣реЛ рд╕рдХрд╛: " + e.message, "danger");
    } finally {
        // 5. рдмрдЯрди рдХреЛ рд╡рд╛рдкрд╕ рдареАрдХ рдХрд░реЗрдВ
        if(btn) { 
            btn.disabled = false; 
            btn.innerHTML = '<i class="fas fa-key"></i> Check-In Guest'; 
        }
    }
}

// [ рдЗрд╕реЗ script рдореЗрдВ рд╕рдмрд╕реЗ рдиреАрдЪреЗ рдкреЗрд╕реНрдЯ рдХрд░реЗрдВ ]

// [ HTML рдлрд╛рдЗрд▓ рдХреЗ <script> рдореЗрдВ рдЗрд╕реЗ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ ]

// 1. ЁЯПи LIST LOAD FUNCTION (рдЗрд╕реЗ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ)
async function loadHotelRooms() {
    const container = document.getElementById('hotel-room-list'); 
    if (!container) return;

    // Table view рд╣рдЯрд╛рдХрд░ Grid View (рдбрд┐рдмреНрдмреЗ) рдмрдирд╛ рд░рд╣реЗ рд╣реИрдВ
    container.parentElement.innerHTML = `<div id="room-grid-area" class="row g-3"></div>`;
    const grid = document.getElementById('room-grid-area');

    try {
        const res = await fetchApi('/api/hotel/rooms', { method: 'GET' }, null);

        if (res.success && res.rooms.length > 0) {
            grid.innerHTML = res.rooms.map(room => {
                const isOccupied = room.status === 'OCCUPIED';
                const colorClass = isOccupied ? 'bg-danger text-white' : 'bg-success text-white';
                const icon = isOccupied ? 'fa-bed' : 'fa-door-open';
                
                // рдЧреЗрд╕реНрдЯ рдХрд╛ рдирд╛рдо рджрд┐рдЦрд╛рдПрдВ (рдЕрдЧрд░ рд╣реИ рддреЛ)
                const guestName = room.current_guest_name || 'Guest';
                const guestInfo = isOccupied ? `<small>${guestName}</small>` : '<small>Empty</small>';
                
                // ЁЯЪА [рдпрд╣рд╛рдБ рдХрд┐рдпрд╛ рд╣реИ рдмрджрд▓рд╛рд╡] ЁЯЪА
                // рднрд░рд╛ рд╣реИ рддреЛ 'checkoutGuest' (рдирд╛рдо рдХреЗ рд╕рд╛рде), рдЦрд╛рд▓реА рд╣реИ рддреЛ 'selectRoom'
                const action = isOccupied 
                    ? `checkoutGuest('${room.room_number}', '${guestName}')` 
                    : `selectRoom('${room.room_number}')`;

                return `
                    <div class="col-6 col-md-3 col-lg-2">
                        <div class="card shadow-sm ${colorClass} text-center p-3" 
                             style="cursor: pointer; transition: 0.3s;"
                             onclick="${action}">
                            <h4 class="mb-1">${room.room_number}</h4>
                            <i class="fas ${icon} fa-2x mb-2"></i>
                            <div class="text-truncate">${guestInfo}</div>
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            grid.innerHTML = `<div class="alert alert-warning col-12">рдХреЛрдИ рдХрдорд░рд╛ рдирд╣реАрдВ рдорд┐рд▓рд╛ред '+ Add Room' рдмрдЯрди рджрдмрд╛рдПрдВред</div>`;
        }
    } catch (e) { console.error(e); }
}
// 2. ЁЯПи CHECK-OUT FUNCTION (рдирдпрд╛)
// [ тЬЕ NEW: Open Checkout Modal ]
let currentCheckoutRoom = null;
let currentCheckoutGuest = null;

function checkoutGuest(roomNo, guestName = 'Guest') {
    // 1. рдбреЗрдЯрд╛ рд╕реЗрдЯ рдХрд░реЗрдВ
    currentCheckoutRoom = roomNo;
    currentCheckoutGuest = guestName; // (рдЕрдЧрд░ guestName рдирд╣реАрдВ рдЖ рд░рд╣рд╛ рддреЛ рдХреЛрдИ рдмрд╛рдд рдирд╣реАрдВ)

    // 2. Modal рдореЗрдВ рджрд┐рдЦрд╛рдПрдВ
    document.getElementById('co_room_no').innerText = `Room ${roomNo}`;
    document.getElementById('co_guest_name').innerText = `Guest: ${guestName}`;
    document.getElementById('co_amount').value = ''; // рдЦрд╛рд▓реА рдХрд░реЗрдВ

    // 3. Modal рдЦреЛрд▓реЗрдВ
    const modal = new bootstrap.Modal(document.getElementById('hotelCheckoutModal'));
    modal.show();
}

/// [ тЬЕ FIXED: CHECKOUT FORM LISTENER (Safety Check Added) ]
document.addEventListener("DOMContentLoaded", () => {
    
    const checkoutForm = document.getElementById('checkout-form');

    if (checkoutForm) {
        checkoutForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const amount = document.getElementById('co_amount').value;
            const mode = document.getElementById('co_mode').value;

            if(!amount || amount <= 0) {
                if(!confirm("рдмрд┐рд▓ рдЕрдорд╛рдЙрдВрдЯ 0 рд╣реИред рдХреНрдпрд╛ рдЖрдк рдмрд┐рдирд╛ рдкреИрд╕реЗ рд▓рд┐рдП рдЪреЗрдХ-рдЖрдЙрдЯ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?")) return;
            }

            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true; 
            btn.innerHTML = 'Processing...';

            try {
                // Global variables (currentCheckoutRoom, etc) defined outside
                const res = await fetchApi('/api/hotel/checkout', { 
                    method: 'POST', 
                    body: { 
                        room_number: window.currentCheckoutRoom, // Using window to be safe
                        total_bill: amount,
                        payment_mode: mode,
                        customer_name: window.currentCheckoutGuest
                    } 
                });

                if(res.success) {
                    showMessage("Success", res.message, "success");
                    
                    // Modal рдмрдВрдж рдХрд░реЗрдВ
                    const modalEl = document.getElementById('hotelCheckoutModal');
                    if (modalEl) {
                        const modal = bootstrap.Modal.getInstance(modalEl);
                        if (modal) modal.hide();
                    }

                    if (typeof loadHotelRooms === 'function') loadHotelRooms();
                } else {
                    showMessage("Error", res.message, "danger");
                }
            } catch(e) {
                alert(e.message);
            } finally {
                if(btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Collect & Checkout';
                }
            }
        });
        console.log("тЬЕ Checkout Form initialized successfully.");
    } else {
        console.warn("тЪая╕П Warning: 'checkout-form' not found. Make sure HTML Modal is placed correctly.");
    }
});

// 3. рд░реВрдо рд╕реЗрд▓реЗрдХреНрдЯ рдХрд░рдиреЗ рдХрд╛ рдЫреЛрдЯрд╛ рд╣реЗрд▓реНрдкрд░
// [ тЬЕ FIXED: SELECT ROOM FUNCTION ]
function selectRoom(roomNo) {
    // 1. рдЗрдирдкреБрдЯ рдмреЙрдХреНрд╕ рдвреВрдВрдвреЗрдВ
    const roomInput = document.getElementById('hotel_room_select');
    const guestInput = document.getElementById('hotel_guest_name');

    if (roomInput) {
        // 2. рд╡реИрд▓реНрдпреВ рд╕реЗрдЯ рдХрд░реЗрдВ
        roomInput.value = roomNo;
        
        // 3. рдлреЙрд░реНрдо рдХреА рддрд░рдл рд╕реНрдХреНрд░реЙрд▓ рдХрд░реЗрдВ (рддрд╛рдХрд┐ рдпреВрдЬрд░ рдХреЛ рджрд┐рдЦреЗ)
        document.getElementById('module-hotel-management').scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
        });

        // 4. рдЧреЗрд╕реНрдЯ рдХреЗ рдирд╛рдо рдкрд░ рдлреЛрдХрд╕ рдХрд░реЗрдВ (рддрд╛рдХрд┐ рдЯрд╛рдЗрдкрд┐рдВрдЧ рд╢реБрд░реВ рдХрд░ рд╕рдХреЗрдВ)
        setTimeout(() => {
            if(guestInput) guestInput.focus();
        }, 500);

        // 5. рдПрдХ рдЫреЛрдЯрд╛ рдореИрд╕реЗрдЬ рджрд┐рдЦрд╛рдПрдВ
        // (рдЕрдЧрд░ рдЖрдкрдХреЗ рдкрд╛рд╕ showMessage рдлрдВрдХреНрд╢рди рд╣реИ рддреЛ)
        if(typeof showMessage === 'function') {
            showMessage("Room Selected", `Room ${roomNo} рдЪреБрдирд╛ рдЧрдпрд╛ред рдЕрдм рдЧреЗрд╕реНрдЯ рдХрд╛ рдирд╛рдо рднрд░реЗрдВред`, "info");
        }
    } else {
        console.error("Error: 'hotel_room_select' рдЗрдирдкреБрдЯ рдмреЙрдХреНрд╕ рдирд╣реАрдВ рдорд┐рд▓рд╛!");
        alert("Error: рдлреЙрд░реНрдо рд▓реЛрдб рдирд╣реАрдВ рд╣реБрдЖ рд╣реИред рдкреЗрдЬ рд░рд┐рдлреНрд░реЗрд╢ рдХрд░реЗрдВред");
    }
}// 1. "+ Add More Item" рдмрдЯрди рдХрд╛ рдлрдВрдХреНрд╢рди

// [ тЬЕ FIXED: KOT LIST (With Permanent Buttons & Manual Refresh) ]
// [ тЬЕ FIXED: COMPACT KOT LIST (Auto Height + Visible Buttons) ]
async function loadLiveKOTs() {
    const containerWaiter = document.getElementById('active-kot-list');
    const containerKitchen = document.getElementById('active-kot-list-kitchen');

    if (!containerWaiter && !containerKitchen) return;

    // 1. ЁЯУП рд▓рд┐рд╕реНрдЯ рдХреА рдКрдВрдЪрд╛рдИ рдмреЭрд╛рдирд╛ (рддрд╛рдХрд┐ рдмрдЯрди рди рдХрдЯреЗ)
    if(containerWaiter) containerWaiter.style.maxHeight = '85vh'; // рд╕реНрдХреНрд░реАрди рдХрд╛ 85% рд╣рд┐рд╕реНрд╕рд╛
    if(containerKitchen) containerKitchen.style.maxHeight = '85vh'; 

    try {
        const res = await fetchApi('/api/restaurant/active-kots', { method: 'GET' }, null);
        
        if (res.success && res.kots && res.kots.length > 0) {
            
            const cardsHtml = res.kots.map(kot => {
                let data = {};
                try { data = typeof kot.items_json === 'string' ? JSON.parse(kot.items_json) : kot.items_json; } catch(e) {}
                
                const tableNo = data.tableNo || '??';
                const waiter = data.waiter || 'Waitr';

                // 2. ЁЯУЙ рдЫреЛрдЯрд╛ рдФрд░ рд╕рд╛реЮ рдЖрдЗрдЯрдо рд▓рд┐рд╕реНрдЯ (Compact List)
                const itemsList = (data.items || []).map(i => 
                    `<div class="d-flex justify-content-between border-bottom border-light py-1" style="font-size: 0.85rem;">
                        <span class="text-dark fw-bold">${i.item}</span>
                        <span class="badge bg-secondary" style="font-size: 0.8em;">x${i.qty}</span>
                    </div>`
                ).join('');

                // 3. тЬи рдЫреЛрдЯрд╛ рдХрд╛рд░реНрдб рдбрд┐рдЬрд╝рд╛рдЗрди (рддрд╛рдХрд┐ рдмрдЯрди рд╣рдореЗрд╢рд╛ рджрд┐рдЦреЗ)
                return `
                    <div class="card mb-2 shadow-sm border-0" style="border-radius: 8px; border-left: 4px solid #0d6efd !important;">
                        <div class="card-header bg-white p-2 d-flex justify-content-between align-items-center border-bottom">
                            <div>
                                <span class="badge bg-primary me-1">${tableNo}</span>
                                <small class="text-muted fw-bold" style="font-size: 0.75rem;">ЁЯСд ${waiter}</small>
                            </div>
                            <small class="text-dark fw-bold" style="font-size: 0.75rem;">
                                ЁЯХТ ${new Date(kot.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                            </small>
                        </div>
                        <div class="card-body p-2 bg-light">
                            ${itemsList}
                            
                            <button class="btn btn-success btn-sm w-100 mt-2 fw-bold shadow-sm" style="font-size: 0.85rem;" onclick="completeKOT(${kot.id})">
                                <i class="fas fa-check"></i> Done
                            </button>
                        </div>
                    </div>`;
            }).join('');

            // HTML рд╕реЗрдЯ рдХрд░реЗрдВ
            if (containerWaiter) containerWaiter.innerHTML = cardsHtml;
            if (containerKitchen) containerKitchen.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="badge bg-dark">${res.kots.length} Pending</span>
                    <button class="btn btn-sm btn-outline-dark py-0" onclick="loadLiveKOTs()">тЖ╗ Refresh</button>
                </div>
                ${cardsHtml}`;

        } else {
            const emptyHtml = `<div class="text-center text-muted p-4 border rounded bg-light"><small>No Active Orders</small><br><button class="btn btn-sm btn-link text-decoration-none" onclick="loadLiveKOTs()">Refresh</button></div>`;
            if (containerWaiter) containerWaiter.innerHTML = emptyHtml;
            if (containerKitchen) containerKitchen.innerHTML = emptyHtml;
        }
    } catch(e) { console.error(e); }
}
// [ тЬЕ FUNCTION: Complete Order ]
async function completeKOT(kotId) {
    if(!confirm("рдХреНрдпрд╛ рдСрд░реНрдбрд░ рдкреВрд░рд╛ рд╣реЛ рдЧрдпрд╛ рд╣реИ?")) return;
    try {
        await fetchApi('/api/restaurant/complete-kot', { method: 'POST', body: { kotId } });
        loadLiveKOTs(); // рд▓рд┐рд╕реНрдЯ рд░рд┐рдлреНрд░реЗрд╢ рдХрд░реЗрдВ
    } catch(e) { alert(e.message); }
}


// [ тЬЕ Ensure this function exists too ]
async function completeKOT(kotId) {
    if(!confirm("рдХреНрдпрд╛ рдпрд╣ рдЖрд░реНрдбрд░ рдкреВрд░рд╛ рд╣реЛ рдЧрдпрд╛ рд╣реИ? (List рд╕реЗ рд╣рдЯ рдЬрд╛рдПрдЧрд╛)")) return;
    
    try {
        const res = await fetchApi('/api/restaurant/complete-kot', { method: 'POST', body: { kotId } });
        if(res.success) {
            // рддреБрд░рдВрдд рд▓рд┐рд╕реНрдЯ рд░рд┐рдлреНрд░реЗрд╢ рдХрд░реЗрдВ
            await loadLiveKOTs();
            showMessage("рд╕рдлрд▓рддрд╛", "тЬЕ рдСрд░реНрдбрд░ рдкреВрд░рд╛ рд╣реБрдЖ!", "success");
        } else {
            showMessage("рддреНрд░реБрдЯрд┐", res.message, "danger");
        }
    } catch(e) { 
        alert("Error: " + e.message); 
    }
}



// рд╣реЗрд▓реНрдкрд░ рдлрдВрдХреНрд╢рди (рддрд╛рдХрд┐ рдХреЛрдб рд╕рд╛рдлрд╝ рд░рд╣реЗ)
function safeJsonParse(str) { try { return typeof str === 'string' ? JSON.parse(str) : str; } catch { return {}; } }
function createItemsHtml(items) { return (items||[]).map(i => `<div class="d-flex justify-content-between border-bottom py-1"><span>${i.item}</span><span class="badge bg-primary">${i.qty}</span></div>`).join(''); }
function formatTime(iso) { return new Date(iso).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); }



/// тЬЕ 2. KOT рдХреЛ 'Done' рдХрд░рдиреЗ рдХрд╛ рдлрдВрдХреНрд╢рди
async function completeKOT(kotId) {
    if(!confirm("рдХреНрдпрд╛ рдпрд╣ рдЦрд╛рдирд╛ рдЯреЗрдмрд▓ рдкрд░ рд╕рд░реНрд╡ рдХрд░ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ? (List se hat jayega)")) return;
    
    // рдмрдЯрди рдХреЛ рдбрд┐рд╕реЗрдмрд▓ рдХрд░рдиреЗ рдХрд╛ рд▓реЙрдЬрд┐рдХ (Optional Visual Feedback)
    // рд╣рдо рд╕реАрдзреЗ API рдХреЙрд▓ рдХрд░реЗрдВрдЧреЗ
    
    try {
        const res = await fetchApi('/api/restaurant/complete-kot', { method: 'POST', body: { kotId } });
        if(res.success) {
            // рддреБрд░рдВрдд рд▓рд┐рд╕реНрдЯ рд░рд┐рдлреНрд░реЗрд╢ рдХрд░реЗрдВ
            await loadLiveKOTs();
            showMessage("рд╕рдлрд▓рддрд╛", "тЬЕ рдСрд░реНрдбрд░ рд▓рд┐рд╕реНрдЯ рд╕реЗ рд╣рдЯрд╛ рджрд┐рдпрд╛ рдЧрдпрд╛!", "success");
        } else {
            showMessage("рддреНрд░реБрдЯрд┐", res.message, "danger");
        }
    } catch(e) { 
        alert("Error: " + e.message); 
    }
}

// [ рдЗрд╕реЗ Script рд╕реЗрдХреНрд╢рди рдореЗрдВ рдиреАрдЪреЗ рдкреЗрд╕реНрдЯ рдХрд░реЗрдВ ]

// ЁЯН╜я╕П KOT рдХреЛ POS рдмрд┐рд▓рд┐рдВрдЧ рдореЗрдВ рднреЗрдЬрдиреЗ рдХрд╛ рдлрдВрдХреНрд╢рди
// [ тЬЕ UPDATED: Transfer to POS (Uses new Dropdown ID) ]
async function transferTableToPOS() {
    // ЁЯЪА Note: ID рдмрджрд▓рд╛ рд╣реИ
    const tableId = document.getElementById('rest_table_select').value;
    
    if(!tableId) {
        return showMessage("рддреНрд░реБрдЯрд┐", "рдХреГрдкрдпрд╛ Table/Room рдЪреБрдиреЗрдВ рдЬрд┐рд╕рдХрд╛ рдмрд┐рд▓ рдмрдирд╛рдирд╛ рд╣реИред", "warning");
    }

    if(!confirm(`рдХреНрдпрд╛ рдЖрдк ${tableId} рдХрд╛ рдмрд┐рд▓ рдмрдирд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?`)) return;

    try {
        const res = await fetchApi('/api/restaurant/generate-bill', { 
            method: 'POST', 
            body: { tableId } 
        }, 'рдмрд┐рд▓ рдмрди рд░рд╣рд╛ рд╣реИ...');

        if (res.success && res.items.length > 0) {
            renderView('sales'); // POS рдЦреЛрд▓реЗрдВ
            
            // рдЖрдЗрдЯрдореНрд╕ рдХреЛ POS рдХрд╛рд░реНрдЯ рдореЗрдВ рдбрд╛рд▓реЗрдВ
            res.items.forEach(item => {
                posCart.push({
                    sku: item.sku,
                    name: item.name,
                    quantity: item.quantity,
                    sale_price: item.sale_price,
                    purchase_price: item.purchase_price || 0,
                    gst: item.gst || 0
                });
            });

            updatePOSCartView();
            showMessage("рд╕рдлрд▓рддрд╛", `тЬЕ ${tableId} рдХреЗ рдЖрдЗрдЯрдореНрд╕ рдмрд┐рд▓ рдореЗрдВ рдЬреБрдбрд╝ рдЧрдП!`, "success");

        } else {
            showMessage("Info", res.message || "рдХреЛрдИ рдЖрдЗрдЯрдо рдирд╣реАрдВ рдорд┐рд▓рд╛ред", "info");
        }
    } catch (e) {
        showMessage("рддреНрд░реБрдЯрд┐", e.message, "danger");
    }
}

// 1. рдПрдХ рдирдИ рдбрд┐рд╢ рдХреА рд▓рд╛рдЗрди рдЬреЛрдбрд╝рдиреЗ рдХрд╛ рдлрдВрдХреНрд╢рди
window.addDishRow = function() {
    const tbody = document.getElementById('dish-bulk-body');
    if (!tbody) return;

    const row = document.createElement('tr');
    row.className = 'dish-entry-row';
    row.innerHTML = `
        <td><input type="text" class="form-control form-control-sm dish-name" placeholder="Ex: Masala Dosa" required></td>
        <td><input type="number" class="form-control form-control-sm dish-price" placeholder="0" required></td>
        <td class="text-center"><button type="button" class="btn btn-sm btn-danger py-0 px-2" onclick="this.closest('tr').remove()">├Ч</button></td>
    `;
    tbody.appendChild(row);
    // рдирдП рдЗрдирдкреБрдЯ рдкрд░ рдлреЛрдХрд╕ рдХрд░реЗрдВ
    row.querySelector('.dish-name').focus();
};

// ==========================================
// ЁЯЪА SUPER FAST KOT MANAGER (Optimized)
// ==========================================

// ==========================================
// ЁЯЪА SUPER FAST KOT MANAGER (Optimized)
// ==========================================

// ==========================================
// ЁЯЪА SUPER FAST KOT MANAGER (Error Fixed Version)
// ==========================================

// 1. Safe Global Variable Declaration (рдпрд╣ рдПрд░рд░ рдХреЛ рд░реЛрдХреЗрдЧрд╛)
// рдЕрдЧрд░ рдкрд╣рд▓реЗ рд╕реЗ рдмрдиреЗ рд╣реИрдВ рддреЛ рдареАрдХ, рдирд╣реАрдВ рддреЛ рдирдП рдмрдирд╛рдУ
if (typeof window.kotCart === 'undefined') window.kotCart = [];
if (typeof window.cachedRooms === 'undefined') window.cachedRooms = null;
if (typeof window.lastRoomFetchTime === 'undefined') window.lastRoomFetchTime = 0;

// 2. KOT рд╢реБрд░реВ рдХрд░рддреЗ рд╕рдордп рд╕реНрдЯреЙрдХ рдФрд░ рд░реВрдореНрд╕ рдкрд╣рд▓реЗ рд╣реА рд▓реЛрдб рдХрд░ рд▓реЗрдВ
async function initKotSection() {
    // Global variable рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ
    if (!window.currentStock || window.currentStock.length === 0) {
        fetchApi('/api/stock', { method: 'GET' }, null).then(res => {
            if(res.success) window.currentStock = res.stock;
        });
    }
    
    await refreshRoomCache();
    toggleOrderSource();
}

// 3. рд░реВрдореНрд╕ рдХреЛ рд╕рд░реНрд╡рд░ рд╕реЗ рд▓рд╛рдиреЗ рдХрд╛ рд╕реНрдорд╛рд░реНрдЯ рдлрдВрдХреНрд╢рди
async function refreshRoomCache() {
    const now = Date.now();
    // 30 рд╕реЗрдХрдВрдб рдХрд╛ рдХреИрд╢ рдЪреЗрдХ
    if (window.cachedRooms && (now - window.lastRoomFetchTime < 30000)) {
        return; 
    }

    try {
        const res = await fetchApi('/api/hotel/rooms', { method: 'GET' }, null);
        if (res.success) {
            window.cachedRooms = res.rooms;
            window.lastRoomFetchTime = now;
        }
    } catch (e) { console.error(e); }
}

// 4. рдЯреЗрдмрд▓ рдФрд░ рд░реВрдо рдХреЗ рдмреАрдЪ рд╕реНрд╡рд┐рдЪ рдХрд░рдирд╛
async function toggleOrderSource() {
    const isRoom = document.getElementById('type_room').checked;
    const select = document.getElementById('rest_table_select');
    
    if(!select) return; // рд╕реБрд░рдХреНрд╖рд╛ рдЪреЗрдХ
    select.innerHTML = ''; 

    if (isRoom) {
        select.classList.remove('border-primary');
        select.classList.add('border-danger');

        if (!window.cachedRooms) await refreshRoomCache();

        const occupiedRooms = window.cachedRooms ? window.cachedRooms.filter(r => r.status === 'OCCUPIED') : [];

        if (occupiedRooms.length > 0) {
            select.innerHTML = occupiedRooms.map(r => 
                `<option value="${r.room_number}">Room ${r.room_number} (${r.current_guest_name || 'Guest'})</option>`
            ).join('');
        } else {
            select.innerHTML = '<option value="">No Guests Checked In</option>';
        }

    } else {
        select.classList.remove('border-danger');
        select.classList.add('border-primary');
        
        let options = '<option value="">-- Select Table --</option>';
        for(let i=1; i<=20; i++) {
            options += `<option value="T-${i}">Table ${i}</option>`;
        }
        options += '<option value="VIP">VIP Table</option>';
        options += '<option value="Staff">Staff Food</option>';
        options += '<option value="Parcel">Parcel / Takeaway</option>';
        
        select.innerHTML = options;
    }
}

// 5. рдЖрдЗрдЯрдо рд╕рд░реНрдЪ (Search)
function handleKotSearch(showAll = false) {
    const input = document.getElementById('kot-search-input');
    const list = document.getElementById('kot-search-results');
    const query = input.value.toLowerCase().trim();

    if (!window.currentStock || window.currentStock.length === 0) {
        fetchApi('/api/stock', { method: 'GET' }, null).then(res => {
            if(res.success) {
                window.currentStock = res.stock;
                handleKotSearch(showAll);
            }
        });
        if(!showAll) return; 
    }

    if (!showAll && query.length === 0) {
        list.style.display = 'none';
        return;
    }

    const matches = showAll 
        ? window.currentStock 
        : window.currentStock.filter(item => item.name.toLowerCase().includes(query));

    if (matches.length > 0) {
        list.innerHTML = matches.slice(0, 50).map(item => `
            <li class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" 
                onclick="addKotItem('${item.sku}')" style="cursor: pointer;">
                <div><strong>${item.name}</strong></div>
                <span class="badge bg-success rounded-pill">тВ╣${item.sale_price}</span>
            </li>
        `).join('');
        list.style.display = 'block';
    } else {
        list.innerHTML = `<li class="list-group-item text-muted text-center">рдХреЛрдИ рдЖрдЗрдЯрдо рдирд╣реАрдВ рдорд┐рд▓рд╛</li>`;
        list.style.display = 'block';
    }
}

// 6. рдЖрдЗрдЯрдо рдРрдб рдХрд░рдирд╛
function addKotItem(sku) {
    const cleanSku = String(sku).trim();
    const item = window.currentStock.find(i => String(i.sku).trim() === cleanSku);
    
    if (!item) {
        // рдЕрдЧрд░ рдЖрдЗрдЯрдо рдирд╣реАрдВ рдорд┐рд▓рд╛, рддреЛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рд╕реНрдЯреЙрдХ рдкреБрд░рд╛рдирд╛ рд╣реЛ
        console.error("Item not found in currentStock:", sku);
        return;
    }

    // window.kotCart рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ
    const existing = window.kotCart.find(i => i.sku === cleanSku);
    
    if (existing) {
        existing.qty++;
    } else {
        window.kotCart.push({ 
            sku: item.sku, 
            name: item.name, 
            qty: 1,
            price: item.sale_price 
        });
    }

    renderKotList(); 
    
    const searchInput = document.getElementById('kot-search-input');
    searchInput.value = '';
    document.getElementById('kot-search-results').style.display = 'none';
    searchInput.focus();
}

// 7. рд▓рд┐рд╕реНрдЯ рд░реЗрдВрдбрд░ рдХрд░рдирд╛
function renderKotList() {
    const container = document.getElementById('kot-added-list');
    
    if (window.kotCart.length === 0) {
        container.innerHTML = `<div class="text-center text-muted small mt-3 p-3 bg-light rounded">
            <i class="fas fa-basket-shopping fa-2x mb-2 text-secondary"></i><br>
            рдЕрднреА рдХреЛрдИ рдЖрдЗрдЯрдо рдирд╣реАрдВ рдЪреБрдирд╛
        </div>`;
        return;
    }

    container.innerHTML = window.kotCart.map((item, index) => `
        <div class="d-flex justify-content-between align-items-center border-bottom py-2 bg-white px-2 mb-1 rounded shadow-sm">
            <div>
                <span class="fw-bold text-dark">${item.name}</span>
                <br><small class="text-muted">тВ╣${item.price} x ${item.qty} = тВ╣${item.price * item.qty}</small>
            </div>
            <div class="d-flex align-items-center bg-light rounded p-1 border">
                <button class="btn btn-sm btn-danger py-0 px-2 fw-bold" onclick="updateKotQty(${index}, -1)">-</button>
                <span class="mx-2 fw-bold" style="min-width:20px; text-align:center;">${item.qty}</span>
                <button class="btn btn-sm btn-success py-0 px-2 fw-bold" onclick="updateKotQty(${index}, 1)">+</button>
                <button class="btn btn-sm text-danger ms-2 border-start ps-2" onclick="removeKotItem(${index})"><i class="fas fa-trash"></i></button>
            </div>
        </div>
    `).join('');
}

function updateKotQty(index, change) {
    if (window.kotCart[index].qty + change > 0) {
        window.kotCart[index].qty += change;
        renderKotList();
    } else {
        removeKotItem(index);
    }
}

function removeKotItem(index) {
    window.kotCart.splice(index, 1);
    renderKotList();
}

// рд╕реЗрдЯрдЕрдк
document.addEventListener('DOMContentLoaded', () => {
    initKotSection();
});


// 1. рдкреЗрдЬ рд▓реЛрдб рд╣реЛрддреЗ рд╣реА рдЯреЗрдмрд▓ рд▓рд┐рд╕реНрдЯ рдмрдирд╛рдирд╛
// [ тЬЕ FIXED: Initialize Tables (Same Logic, New System) ]
function initRestaurantTables() {
    // рдпрд╣ рдлрд╝рдВрдХреНрд╢рди рдкреЗрдЬ рд▓реЛрдб рд╣реЛрдиреЗ рдкрд░ рдЕрдкрдиреЗ рдЖрдк "Table Mode" рд╕реЗрдЯ рдХрд░ рджреЗрдЧрд╛
    // рдФрд░ 1 рд╕реЗ 20 рдЯреЗрдмрд▓ + рдПрдХреНрд╕реНрдЯреНрд░рд╛ рдСрдкреНрд╢рди рд▓рд┐рд╕реНрдЯ рдореЗрдВ рднрд░ рджреЗрдЧрд╛ред
    
    // рдкреБрд░рд╛рдирд╛ рд▓реЙрдЬрд┐рдХ рдЕрдм 'toggleOrderSource' рдХреЗ рдЕрдВрджрд░ рд╢рд┐рдлреНрдЯ рд╣реЛ рдЧрдпрд╛ рд╣реИ,
    // рдЗрд╕рд▓рд┐рдП рд╣рдореЗрдВ рдмрд╕ рдЙрд╕реЗ рдХреЙрд▓ рдХрд░рдирд╛ рд╣реИред
    if (typeof toggleOrderSource === 'function') {
        toggleOrderSource();
    }
}
// рдЗрд╕ рдлрдВрдХреНрд╢рди рдХреЛ рддреБрд░рдВрдд рдХреЙрд▓ рдХрд░реЗрдВ рдФрд░ RenderDashboard рдореЗрдВ рднреА рдбрд╛рд▓ рджреЗрдВ
document.addEventListener('DOMContentLoaded', initRestaurantTables);



// [ тЬЕ LOAD WAITERS DYNAMICALLY ]
async function loadWaiters() {
    const select = document.getElementById('waiter_select');
    if(!select) return;

    try {
        // рд╕рд░реНрд╡рд░ рд╕реЗ рд╕реНрдЯрд╛рдл рд▓рд┐рд╕реНрдЯ рдордВрдЧрд╛рдПрдВ
        const res = await fetchApi('/api/users', { method: 'GET' }, null);
        
        if (res.success && res.users) {
            // рдбреНрд░реЙрдкрдбрд╛рдЙрди рдХреЛ рдЦрд╛рд▓реА рдХрд░реЗрдВ рдФрд░ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдСрдкреНрд╢рди рдбрд╛рд▓реЗрдВ
            select.innerHTML = '<option value="Self">-- Select Waiter --</option>';
            
            // рд▓рд┐рд╕реНрдЯ рд╕реЗ рдирд╛рдо рднрд░рдХрд░ рдбреНрд░реЙрдкрдбрд╛рдЙрди рдореЗрдВ рдбрд╛рд▓реЗрдВ
            res.users.forEach(user => {
                // рд╕рд┐рд░реНрдл рдЙрдиреНрд╣реЗрдВ рджрд┐рдЦрд╛рдПрдВ рдЬреЛ рдПрдХреНрдЯрд┐рд╡ рд╣реИрдВ
                if(user.status === 'active') {
                    const opt = document.createElement('option');
                    opt.value = user.name;
                    opt.innerText = user.name;
                    select.appendChild(opt);
                }
            });
        }
    } catch (e) {
        console.error("Waiters load error:", e);
    }
}

// рдкреЗрдЬ рд▓реЛрдб рд╣реЛрддреЗ рд╣реА рд╡реЗрдЯрд░ рд▓рд┐рд╕реНрдЯ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ
document.addEventListener('DOMContentLoaded', loadWaiters);


// 5. рдорд╛рддреНрд░рд╛ рдЕрдкрдбреЗрдЯ
function updateKotQty(index, change) {
    if (kotCart[index].qty + change > 0) {
        kotCart[index].qty += change;
    }
    renderKotList();
}

function removeKotItem(index) {
    kotCart.splice(index, 1);
    renderKotList();
}
// [ тЬЕ FIXED: KOT SENDING (Update UI First, Then Print) ]
async function sendKotToKitchen() {
    const tableId = document.getElementById('rest_table_select').value;
    
    // 1. рдХрд╛рд░реНрдЯ рдЪреЗрдХ рдХрд░реЗрдВ
    if (typeof kotCart === 'undefined' || kotCart.length === 0) {
        return showMessage("рдЦрд╛рд▓реА рдСрд░реНрдбрд░", "тЭМ рдХреГрдкрдпрд╛ рдХрдо рд╕реЗ рдХрдо рдПрдХ рдЖрдЗрдЯрдо рдЪреБрдиреЗрдВред", "warning");
    }
    
    if(!tableId) {
        return showMessage("Table Missing", "тЭМ рдХреГрдкрдпрд╛ Table рдпрд╛ Room рдЪреБрдиреЗрдВред", "warning");
    }
    
    // 2. рд╡реЗрдЯрд░ рдХрд╛ рдирд╛рдо рд▓реЗрдВ (рдЕрдЧрд░ рдбреНрд░реЙрдкрдбрд╛рдЙрди рд╣реИ рддреЛ)
    const waiterSelect = document.getElementById('waiter_select');
    const waiterName = waiterSelect ? waiterSelect.value : 'Server';

    // 3. рдбреЗрдЯрд╛ рддреИрдпрд╛рд░ рдХрд░реЗрдВ
    const itemsToSend = kotCart.map(i => ({ item: i.name, qty: i.qty }));

    // 4. рдмрдЯрди рдХреЛ 'Loading' рдХрд░реЗрдВ
    const btn = document.querySelector('button[onclick="sendKotToKitchen()"]');
    if(btn) { btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...'; }

    try {
        // 5. рд╕рд░реНрд╡рд░ рдкрд░ рднреЗрдЬреЗрдВ
        const res = await fetchApi('/api/restaurant/create-kot', {
            method: 'POST',
            body: { tableId, items: itemsToSend, waiter: waiterName }
        });

        if (res.success) {
            // тЬЕ SUCCESS!
            showMessage("рд╕рдлрд▓рддрд╛", "тЬЕ рдСрд░реНрдбрд░ рдХрд┐рдЪрди рдореЗрдВ рдЪрд▓рд╛ рдЧрдпрд╛!", "success");

            // 6. ЁЯЪА CRITICAL FIX: рдкрд╣рд▓реЗ рд╕реНрдХреНрд░реАрди рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ (рддрд╛рдХрд┐ рдпреВрдЬрд░ рдХреЛ рджрд┐рдЦреЗ)
            if (typeof loadLiveKOTs === 'function') await loadLiveKOTs(); // рд▓рд┐рд╕реНрдЯ рд░рд┐рдлреНрд░реЗрд╢
            
            // 7. рдХрд╛рд░реНрдЯ рдЦрд╛рд▓реА рдХрд░реЗрдВ
            kotCart = []; 
            if(typeof renderKotList === 'function') renderKotList();

            // 8. ЁЯЦия╕П рдЖрдЦрд┐рд░ рдореЗрдВ рдкреНрд░рд┐рдВрдЯ рдирд┐рдХрд╛рд▓реЗрдВ (0.5 рд╕реЗрдХрдВрдб рд░реБрдХрдХрд░ рддрд╛рдХрд┐ рд╕реНрдХреНрд░реАрди рдЕрдкрдбреЗрдЯ рд╣реЛ рдЬрд╛рдП)
            // рдЕрдЧрд░ рдЖрдкрдХреЛ PDF/Print рдирд╣реАрдВ рдЪрд╛рд╣рд┐рдП, рддреЛ рдиреАрдЪреЗ рд╡рд╛рд▓реА рд▓рд╛рдЗрди рд╣рдЯрд╛ рджреЗрдВ
            setTimeout(() => {
                if(typeof printKOT === 'function') printKOT(tableId, itemsToSend, waiterName, res.kotId || 'New');
            }, 500);
            
        } else {
            showMessage("рддреНрд░реБрдЯрд┐", res.message, "danger");
        }
    } catch (e) {
        showMessage("Error", e.message, "danger");
    } finally {
        // рдмрдЯрди рдХреЛ рд╡рд╛рдкрд╕ рдиреЙрд░реНрдорд▓ рдХрд░реЗрдВ
        if(btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-paper-plane me-2"></i> Send to Kitchen'; }
    }
}

// рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ рдбреИрд╢рдмреЛрд░реНрдб рд▓реЛрдб рд╣реЛрдиреЗ рдкрд░ рдЯреЗрдмрд▓ рд▓рд┐рд╕реНрдЯ рдмрди рдЬрд╛рдП
// (рдЗрд╕реЗ рдЕрдкрдиреЗ renderDashboard рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ рднреА рдХреЙрд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ)
initRestaurantTables();

// ==========================================
// ЁЯЦия╕П KOT PRINT FUNCTION (Missing Function)
// ==========================================

// тЬЕ 3. KOT рдкреНрд░рд┐рдВрдЯ рдХрд░рдиреЗ рдХрд╛ рдлрдВрдХреНрд╢рди (Direct Print)
function printKOT(tableNo, items, waiter, kotId) {
    // рдЫреЛрдЯреА рдкрд░реНрдЪреА рдХрд╛ рдбрд┐рдЬрд╝рд╛рдЗрди (Thermal Printer Friendly)
    const printContent = `
        <div style="font-family: monospace; width: 280px; font-size: 12px; font-weight: bold;">
            <div style="text-align: center;">** KITCHEN ORDER **</div>
            <div style="text-align: center;">KOT #: ${kotId} | ${new Date().toLocaleTimeString()}</div>
            <hr style="border-top: 1px dashed #000;">
            <div style="font-size: 16px;">TABLE: ${tableNo}</div>
            <div>WAITER: ${waiter}</div>
            <hr style="border-top: 1px dashed #000;">
            <table style="width: 100%; text-align: left;">
                ${items.map(i => `
                    <tr>
                        <td style="width: 75%;">${i.item}</td>
                        <td style="width: 25%; text-align: right; font-size: 14px;">x${i.qty}</td>
                    </tr>
                `).join('')}
            </table>
            <hr style="border-top: 1px dashed #000;">
        </div>
    `;

    // рдирдИ рд╡рд┐рдВрдбреЛ рдЦреЛрд▓рдХрд░ рдкреНрд░рд┐рдВрдЯ рдХрдорд╛рдВрдб рджреЗрдВ
    const win = window.open('', '', 'height=500,width=400');
    win.document.write('<html><body>');
    win.document.write(printContent);
    win.document.write('</body></html>');
    win.document.close();
    win.print(); // рдпрд╣ рд╕реАрдзреЗ рдкреНрд░рд┐рдВрдЯ рдбрд╛рдпрд▓реЙрдЧ рдЦреЛрд▓реЗрдЧрд╛
    
    // рдореЛрдмрд╛рдЗрд▓ рдкрд░ рд╡рд┐рдВрдбреЛ рдЕрдкрдиреЗ рдЖрдк рдмрдВрдж рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП (рд╡реИрдХрд▓реНрдкрд┐рдХ)
    setTimeout(() => { win.close(); }, 1000);
}

// [ тЬЕ AUTO SETUP: Create 10 Rooms (101-110) ]
async function setupHotelRooms() {
    if(!confirm("рдХреНрдпрд╛ рдЖрдк рдСрдЯреЛрдореИрдЯрд┐рдХ 10 рд░реВрдо (101-110) рдмрдирд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?")) return;

    showLoader("рд░реВрдореНрд╕ рдмрди рд░рд╣реЗ рд╣реИрдВ...");

    try {
        // 101 рд╕реЗ 110 рддрдХ рд▓реВрдк рдЪрд▓рд╛рдПрдВ
        for (let i = 101; i <= 110; i++) {
            await fetchApi('/api/hotel/add-room', { 
                method: 'POST', 
                body: { roomNumber: i.toString() } 
            }, null); // null рдХрд╛ рдорддрд▓рдм рд╣рд░ рдмрд╛рд░ рд▓реЛрдбрд░ рди рджрд┐рдЦрд╛рдПрдВ
        }

        hideLoader();
        showMessage("рд╕рдлрд▓рддрд╛", "тЬЕ 10 рд░реВрдореНрд╕ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдмрди рдЧрдП!", "success");
        loadHotelRooms(); // рддреБрд░рдВрдд рд▓рд┐рд╕реНрдЯ рд░рд┐рдлреНрд░реЗрд╢ рдХрд░реЗрдВ

    } catch (e) {
        hideLoader();
        alert("Error: " + e.message);
    }
}


// [ тЬЕ MANUAL ADD: Add Single Room ]
async function addRoomManually() {
    // 1. рд░реВрдо рдирдВрдмрд░ рдкреВрдЫреЗрдВ
    const roomNo = prompt("рдирдпрд╛ рд░реВрдо рдирдВрдмрд░ рдбрд╛рд▓реЗрдВ (Example: 201, 305, VIP-1):");
    
    // рдЕрдЧрд░ рдЦрд╛рд▓реА рдЫреЛрдбрд╝ рджрд┐рдпрд╛ рдпрд╛ рдХреИрдВрд╕рд┐рд▓ рдХрд┐рдпрд╛ рддреЛ рд░реБрдХ рдЬрд╛рдПрдВ
    if (!roomNo || roomNo.trim() === "") return;

    // 2. рд╕рд░реНрд╡рд░ рдкрд░ рднреЗрдЬреЗрдВ
    try {
        const res = await fetchApi('/api/hotel/add-room', { 
            method: 'POST', 
            body: { roomNumber: roomNo.trim() } 
        }, 'рд░реВрдо рдмрди рд░рд╣рд╛ рд╣реИ...');

        if (res.success) {
            showMessage("рд╕рдлрд▓рддрд╛", `тЬЕ рд░реВрдо ${roomNo} рдмрди рдЧрдпрд╛!`, "success");
            loadHotelRooms(); // рд▓рд┐рд╕реНрдЯ рд░рд┐рдлреНрд░реЗрд╢ рдХрд░реЗрдВ рддрд╛рдХрд┐ рд░реВрдо рджрд┐рдЦреЗ
        } else {
            alert("тЭМ " + res.message);
        }
    } catch (e) {
        alert("Error: " + e.message);
    }
}

// [ тЬЕ KITCHEN MODE: Hides everything except Active Orders ]
function enableKitchenMode() {
    if(!confirm("рдХреНрдпрд╛ рдЖрдк рдХрд┐рдЪрди рдбрд┐рд╕реНрдкреНрд▓реЗ рдореЛрдб рдЪрд╛рд▓реВ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? (рдмрд╛рдХреА рд╕рдм рдЫреБрдк рдЬрд╛рдПрдЧрд╛)")) return;

    // 1. рд╕рд╛рдЗрдбрдмрд╛рд░ рдФрд░ рд╣реЗрдбрд░ рдЫреБрдкрд╛рдПрдВ
    document.getElementById('sidebar').style.display = 'none';
    document.querySelector('.navbar-toggler').style.display = 'none';
    
    // 2. рдореЗрди рдХрдВрдЯреЗрдВрдЯ рдХреЛ рдлреБрд▓ рд╕реНрдХреНрд░реАрди рдХрд░реЗрдВ
    const main = document.getElementById('main-content');
    main.style.marginLeft = '0';
    main.style.padding = '5px';

    // 3. рд╕рдм рдХреБрдЫ рдЫреБрдкрд╛рдПрдВ
    document.querySelectorAll('.section').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.biz-module').forEach(el => el.style.display = 'none');

    // 4. рд╕рд┐рд░реНрдл KOT рд╡рд╛рд▓рд╛ рд╣рд┐рд╕реНрд╕рд╛ рджрд┐рдЦрд╛рдПрдВ
    const kotSection = document.getElementById('module-restaurant-kot');
    kotSection.style.display = 'block';
    
    // 5. KOT рд╕реЗрдХреНрд╢рди рдХреЗ рдЕрдВрджрд░ рднреА рд╕рд┐рд░реНрдл 'Active Orders' рджрд┐рдЦрд╛рдПрдВ (рдКрдкрд░ рдХрд╛ рд╕рд░реНрдЪ рдмреЙрдХреНрд╕ рд╣рдЯрд╛ рджреЗрдВ)
    // (Optional: рдЕрдЧрд░ рдЖрдк рд╕рд░реНрдЪ рдмреЙрдХреНрд╕ рднреА рдЫреБрдкрд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рддреЛ рдиреАрдЪреЗ рд╡рд╛рд▓реА рд▓рд╛рдЗрди рдЕрди-рдХрдореЗрдВрдЯ рдХрд░реЗрдВ)
    // document.querySelector('#module-restaurant-kot .card-body').children[0].style.display = 'none'; 

    // 6. рдХрд┐рдЪрди рд╡реНрдпреВ рдХрдВрдЯреЗрдирд░ рджрд┐рдЦрд╛рдПрдВ
    const kitchenView = document.getElementById('standalone-kitchen-view');
    if(kitchenView) {
        kitchenView.style.display = 'block';
        // рдмрдбрд╝реЗ рдлреЛрдВрдЯ рдХрд░ рджреЗрдВ рддрд╛рдХрд┐ рджреВрд░ рд╕реЗ рджрд┐рдЦреЗ
        kitchenView.style.fontSize = '1.2rem'; 
    }
    
    alert("тЬЕ рдХрд┐рдЪрди рдореЛрдб рдЪрд╛рд▓реВ рд╣реИред рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдкреЗрдЬ рд░рд┐рдлреНрд░реЗрд╢ рдХрд░реЗрдВред");
    
    // рдСрдЯреЛ рд░рд┐рдлреНрд░реЗрд╢ рд╢реБрд░реВ рдХрд░реЗрдВ
    setInterval(loadLiveKOTs, 5000);
}

// [ тЬВя╕П SALON CLEANUP CODE ]
document.addEventListener('DOMContentLoaded', () => {
    const user = JSON.parse(localStorage.getItem('authUser'));
    
    // рдЕрдЧрд░ рдпреВрдЬрд░ рд╣реЛрдЯрд▓ рдирд╣реАрдВ рд╣реИ (рдпрд╛рдиреА Salon рдпрд╛ Retail рд╣реИ)
    if (user && user.business_type !== 'HOTEL') {
        const hotelOnlyPart = document.getElementById('hotel-bulk-dish-section');
        if (hotelOnlyPart) {
            hotelOnlyPart.style.display = 'none'; // рдЗрд╕реЗ рдЫреБрдкрд╛ рджреЛ
        }
    }
});


// [ ЁЯФе FORCE REMOVE: HOTEL SECTION IN SALON ]
// рдпрд╣ рдХреЛрдб рд╣рд░ рдЖрдзреЗ рд╕реЗрдХрдВрдб рдореЗрдВ рдЪреЗрдХ рдХрд░реЗрдЧрд╛ рдФрд░ рдЕрдЧрд░ рд╕реИрд▓реВрди рдореЗрдВ рд╣реЛрдЯрд▓ рд╡рд╛рд▓рд╛ рд╣рд┐рд╕реНрд╕рд╛ рджрд┐рдЦрд╛ рддреЛ рдЙрд╕реЗ рдорд┐рдЯрд╛ рджреЗрдЧрд╛
setInterval(() => {
    // 1. рдпреВрдЬрд░ рдЪреЗрдХ рдХрд░реЗрдВ
    let user = null;
    try { user = JSON.parse(localStorage.getItem('authUser')); } catch(e){}

    // 2. рдЕрдЧрд░ рдпреВрдЬрд░ SALON рдпрд╛ RETAIL рд╣реИ (HOTEL рдирд╣реАрдВ рд╣реИ)
    if (user && user.business_type !== 'HOTEL') {
        
        // рдЙрд╕ рдмреЙрдХреНрд╕ рдХреЛ рдвреВрдВрдвреЗрдВ рдЬрд┐рд╕рдореЗрдВ "рдПрдХ рд╕рд╛рде рдХрдИ рдбрд┐рд╢реЗрдЬ рдЬреЛрдбрд╝реЗрдВ" рд▓рд┐рдЦрд╛ рд╣реИ
        document.querySelectorAll('h6').forEach(heading => {
            if (heading.innerText.includes('рдПрдХ рд╕рд╛рде рдХрдИ рдбрд┐рд╢реЗрдЬ рдЬреЛрдбрд╝реЗрдВ') || heading.innerText.includes('Bulk Dishes')) {
                
                // рдЙрд╕рдХреЗ рдкреВрд░реЗ рдбрд┐рдмреНрдмреЗ (Container) рдХреЛ рдвреВрдВрдвреЗрдВ
                const container = heading.closest('.col-12') || heading.parentElement.parentElement;
                
                // рдФрд░ рдЙрд╕реЗ рд╣рдЯрд╛ рджреЗрдВ
                if (container) {
                    container.remove();
                    console.log("ЁЯЪл Salon Dashboard: Hotel Dish Section Removed Forcefully.");
                }
            }
        });
    }
}, 500); // 500ms (рд╣рд░ рдЖрдзреЗ рд╕реЗрдХрдВрдб рдореЗрдВ рдЪреЗрдХ)

// ================================================================
// 1. MEASUREMENT SAVE KARNE KA DIMAG (Hath-Pair) ЁЯзатЬЛ
// ================================================================
async function saveMeasurement() {
    const customerId = document.getElementById('measure-customer-id')?.value;
    const itemType = document.getElementById('measure-item')?.value;
    const details = document.getElementById('measure-details')?.value;
    const deliveryDate = document.getElementById('measure-date')?.value;

    if (!customerId || !details) {
        alert("тЭМ рдХреГрдкрдпрд╛ Customer ID рдФрд░ рдирд╛рдк (Details) рджреЛрдиреЛрдВ рднрд░реЗрдВ!");
        return;
    }

    // Button ko loading banayein
    const btn = document.querySelector('#add-measurement-modal .btn-info');
    const oldText = btn.innerText;
    btn.innerText = "Saving...";
    btn.disabled = true;

    try {
        // Server par bhejen
        const res = await fetchApi('/api/measurements', {
            method: 'POST',
            body: JSON.stringify({
                customer_id: customerId,
                item_type: itemType,
                measurements: details,
                delivery_date: deliveryDate
            })
        });

        if (res.success) {
            alert("тЬЕ рдирд╛рдк (Measurement) рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рд╕реЗрд╡ рд╣реЛ рдЧрдпрд╛!");
            // Modal band karein (Bootstrap 5 logic)
            const modalEl = document.getElementById('add-measurement-modal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();
            
            // Form clear karein
            document.getElementById('measurement-form').reset();
        } else {
            alert("тЭМ Error: " + (res.message || "Save nahi hua"));
        }
    } catch (e) {
        console.error(e);
        alert("тЭМ рд╕рд░реНрд╡рд░ рдПрд░рд░: рд╕реЗрд╡ рдирд╣реАрдВ рд╣реЛ рд╕рдХрд╛ред");
    } finally {
        btn.innerText = oldText;
        btn.disabled = false;
    }
}

// [ тЬЕ FIXED: WhatsApp Share Function (Mistri & Customer) ]
function shareInvoiceOnWhatsApp(mobileNumber, name, invoiceNo, amount, pdfUrl) {
    console.log("WhatsApp Attempt:", mobileNumber, name);

    // 1. рдирдВрдмрд░ рдЪреЗрдХ рдХрд░реЗрдВ (Validation)
    if (!mobileNumber) {
        alert("тЭМ рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░ рдЙрдкрд▓рдмреНрдз рдирд╣реАрдВ рд╣реИ!");
        return;
    }

    // 2. рдирдВрдмрд░ рд╕рд╛реЮ рдХрд░реЗрдВ (Space, -, + рд╣рдЯрд╛ рджреЗрдВ)
    let phone = mobileNumber.toString().replace(/\D/g, ''); 

    // 3. '91' рдЬреЛрдбрд╝реЗрдВ (рдЕрдЧрд░ 10 рдЕрдВрдХреЛрдВ рдХрд╛ рд╣реИ)
    if (phone.length === 10) {
        phone = '91' + phone;
    } 
    // рдЕрдЧрд░ рдирдВрдмрд░ рдмрд╣реБрдд рдЫреЛрдЯрд╛ рд╣реИ рддреЛ рдПрд░рд░ рджреЗрдВ
    else if (phone.length < 10) {
        alert("тЭМ рдЧрд▓рдд рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░: " + mobileNumber);
        return;
    }

    // 4. рдореИрд╕реЗрдЬ рддреИрдпрд╛рд░ рдХрд░реЗрдВ
    let msg = `рдирдорд╕реНрддреЗ ${name || 'Customer'},\n`;
    msg += `рдЖрдкрдХрд╛ рдмрд┐рд▓ (Invoice: ${invoiceNo}) рдмрди рдЧрдпрд╛ рд╣реИред\n`;
    msg += `рдХреБрд▓ рд░рд╛рд╢рд┐: тВ╣${amount}\n`;
    msg += `рдпрд╣рд╛рдБ рдХреНрд▓рд┐рдХ рдХрд░рдХреЗ рдмрд┐рд▓ рджреЗрдЦреЗрдВ: ${pdfUrl || ''}\n\n`;
    msg += `рдзрдиреНрдпрд╡рд╛рдж!`;

    // 5. WhatsApp рд▓рд┐рдВрдХ рдмрдирд╛рдПрдВ
    // (web.whatsapp.com рдХреА рдЬрдЧрд╣ wa.me рдЬреНрдпрд╛рджрд╛ рднрд░реЛрд╕реЗрдордВрдж рд╣реИ рдЬреЛ App рдФрд░ Web рджреЛрдиреЛрдВ рдЦреЛрд▓рддрд╛ рд╣реИ)
    const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;

    // 6. рд╡рд┐рдВрдбреЛ рдЦреЛрд▓реЗрдВ
    window.open(url, '_blank');
}


// ЁЯЪА 1. ULTRA FAST WHATSAPP OPENER (Desktop App + Mobile App)
function openSmartWhatsApp(phone, message) {
    if (!phone) return;
    
    // рдирдВрдмрд░ рд╕рд╛рдлрд╝ рдХрд░рдирд╛ (Format check)
    let cleanPhone = phone.replace(/[^0-9]/g, '');
    if (cleanPhone.length === 10) cleanPhone = '91' + cleanPhone;

    const encodedMsg = encodeURIComponent(message);
    const appUrl = `whatsapp://send?phone=${cleanPhone}&text=${encodedMsg}`;
    
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    if (isMobile) {
        // рдореЛрдмрд╛рдЗрд▓: рд╕реАрдзреЗ рд▓рд┐рдВрдХ (Direct Link)
        window.location.href = appUrl;
    } else {
        // рдХрдВрдкреНрдпреВрдЯрд░: рд╕реАрдзреЗ App рдЯреНрд░рд┐рдЧрд░ (Window Name 'DukanWA' рддрд╛рдХрд┐ рдПрдХ рд╣реА рдЯреИрдм рд░рд╣реЗ)
        // '_self' рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдпрд╣ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдХреЛ рдкреЙрдкрдЕрдк рджрд┐рдЦрд╛рдиреЗ рдХреЛ рдХрд╣реЗрдЧрд╛
        window.open(appUrl, '_self'); 
    }
}


</script>

<div class="modal fade" id="paintMixingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">ЁЯОи Color Mixing Billing</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                
                <div class="mb-3 position-relative p-2 border rounded bg-light">
                    <label class="form-label fw-bold text-danger">рд╕реНрдЯреЗрдк 1: рдмреЗрд╕ рд╕реНрдХреИрди рдХрд░реЗрдВ (SKU)</label>
                    
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-barcode"></i></span>
                        <input type="text" id="mix-base-sku" class="form-control" placeholder="Scan/Type Bucket Barcode" onchange="fetchBaseDetails(this.value)">
                        
                        <button class="btn btn-dark" type="button" onclick="openMobileScannerForMix()">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>

                    <div id="paint-otp-box" class="mt-2 p-2 border border-danger rounded bg-white text-center" style="display: none;">
                        <p class="mb-1 small text-muted fw-bold">рдореЛрдмрд╛рдЗрд▓ рд╕реНрдХреИрдирд░ рдореЗрдВ рдпрд╣ рдХреЛрдб рдбрд╛рд▓реЗрдВ:</p>
                        
                        <div class="d-flex justify-content-center align-items-center gap-2">
                            <span id="paint-otp-code" class="display-6 fw-bold text-danger">------</span>
                            <div id="paint-otp-spinner" class="spinner-border spinner-border-sm text-danger" role="status"></div>
                        </div>

                        <p id="paint-otp-status" class="mt-1 mb-0 small text-success fw-bold" style="display: none;">
                            <i class="fas fa-check-circle"></i> рдХрдиреЗрдХреНрдЯреЗрдб! рд╕реНрдХреИрди рдХрд░реЗрдВ...
                        </p>
                    </div>

                    <small class="d-block mt-1 fw-bold" id="mix-stock-status"></small> 
                </div>
                <hr>

                <div class="mb-3">
                    <label class="form-label">Base Product Name</label>
                    <input type="text" id="mix-base-name" class="form-control fw-bold" placeholder="Scan SKU or Type Name">
                </div>
                
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="form-label">Base Price (тВ╣)</label>
                        <input type="number" id="mix-base-price" class="form-control" placeholder="0">
                    </div>
                    
                    <div class="col-6">
                        <label class="form-label text-danger fw-bold">Colorant Cost (тВ╣)</label>
                        <input type="number" id="mix-color-cost" class="form-control" placeholder="Enter Amount">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Color Code / Shade Name</label>
                    <input type="text" id="mix-code" class="form-control" placeholder="e.g. Sunrise Orange 405">
                </div>

                <div class="alert alert-info py-2 text-center">
                    Final Bill Price: <strong id="mix-final-price" class="fs-5">тВ╣0</strong>
                </div>

                <button class="btn btn-danger w-100 btn-lg shadow" onclick="addMixedPaintToCart()">
                    <i class="fas fa-cart-plus me-2"></i> рдмрд┐рд▓ рдореЗрдВ рдЬреЛрдбрд╝реЗрдВ (Add to Bill)
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="painterLedgerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg"> <div class="modal-content border-primary">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-book-open me-2"></i>рдкреЗрдВрдЯрд░ рдмрд╣реА-рдЦрд╛рддрд╛ (Ledger)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h5 id="ledger-painter-name" class="fw-bold text-dark mb-3">Painter Name</h5>
                
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-striped table-bordered mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>рддрд╛рд░реАрдЦ</th>
                                <th>рдмрд┐рд▓ рдирдВ. (Invoice)</th>
                                <th>рдХреБрд▓ рдмрд┐рдХреНрд░реА</th>
                                <th class="text-end text-success">рдХрдореАрд╢рди</th>
                            </tr>
                        </thead>
                        <tbody id="painter-ledger-body">
                            </tbody>
                        <tfoot class="table-group-divider bg-light fw-bold">
                            <tr>
                                <td colspan="3" class="text-end">рдХреБрд▓ рдХрдорд╛рдИ (Total Earnings):</td>
                                <td class="text-end text-success fs-5" id="painter-total-earnings">тВ╣0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <div class="text-danger fw-bold" id="painter-current-balance-display">
                    рдмрдХрд╛рдпрд╛: тВ╣0.00
                </div>
                
                <div>
                    <button type="button" class="btn btn-success me-2" onclick="payPainterDue()">
                        <i class="fas fa-money-bill-wave"></i> рднреБрдЧрддрд╛рди рдХрд░реЗрдВ (Pay)
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">рдмрдВрдж рдХрд░реЗрдВ</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="hotelCheckoutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-file-invoice-dollar"></i> Hotel Checkout & Bill</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <h2 id="co_room_no" class="fw-bold text-danger">Room 101</h2>
                    <p id="co_guest_name" class="text-muted mb-0">Guest: Rahul Kumar</p>
                </div>
                
                <form id="checkout-form">
                    <div class="mb-3">
                        <label class="fw-bold small">Final Bill Amount (тВ╣)</label>
                        <input type="number" id="co_amount" class="form-control form-control-lg fw-bold text-success" placeholder="0.00">
                        <small class="text-muted">*Room Rent + Food - Advance</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="fw-bold small">Payment Mode</label>
                        <select id="co_mode" class="form-select">
                            <option value="Cash" selected>Cash</option>
                            <option value="UPI">UPI / PhonePe</option>
                            <option value="Card">Card</option>
                        </select>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-danger btn-lg">
                            <i class="fas fa-sign-out-alt"></i> Collect & Checkout
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="add-measurement-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">ЁЯУП New Measurement</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="measurement-form">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Customer ID / Name</label>
                        <input type="text" id="measure-customer-id" class="form-control" placeholder="Enter Customer ID">
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label">Type</label>
                            <select id="measure-item" class="form-select">
                                <option>Shirt</option><option>Pant</option><option>Suit</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Delivery</label>
                            <input type="date" id="measure-date" class="form-control">
                        </div>
                    </div>
                    <div class="mb-3 mt-2">
                        <label class="form-label">Details</label>
                        <textarea id="measure-details" class="form-control" rows="3" placeholder="Measurements..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-info text-white" onclick="saveMeasurement()">Save Data</button>
            </div>
        </div>
    </div>
</div>


<div id="invoice-content" style="display: none; width: 100%; max-width: 800px; background: #fff; padding: 20px; font-family: 'Poppins', sans-serif;">
    
    <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px;">
        <h2 style="margin: 0; color: #333;">Dukan Pro Invoice</h2> <p style="margin: 5px 0; color: #666;">рдЖрдкрдХрд╛ рдкрддрд╛ рдпрд╣рд╛рдБ рдЖрдПрдЧрд╛ | рдореЛ. 9999999999</p>
    </div>

    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
        <div style="width: 48%;">
            <h4 style="margin-bottom: 5px; color: #444;">рдмрд┐рд▓ рдХрд┐рд╕рдХреЗ рдирд╛рдо (Bill To):</h4>
            <p style="margin: 0; font-size: 16px; font-weight: bold;" id="inv-customer">рдЧреНрд░рд╛рд╣рдХ рдХрд╛ рдирд╛рдо</p>
        </div>
        <div style="width: 48%; text-align: right;">
            <p style="margin: 5px 0;"><strong>рдмрд┐рд▓ рдирдВ (No):</strong> <span id="inv-no">---</span></p>
            <p style="margin: 5px 0;"><strong>рддрд╛рд░реАрдЦ (Date):</strong> <span id="inv-date">---</span></p>
        </div>
    </div>

    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
        <thead>
            <tr style="background-color: #f2f2f2; border-bottom: 2px solid #ddd;">
                <th style="padding: 8px; text-align: left;">#</th>
                <th style="padding: 8px; text-align: left;">рд╕рд╛рдорд╛рди (Item)</th>
                <th style="padding: 8px; text-align: left;">Qty</th>
                <th style="padding: 8px; text-align: left;">Rate</th>
                <th style="padding: 8px; text-align: left;">Total</th>
            </tr>
        </thead>
        <tbody id="inv-items-body">
            </tbody>
    </table>

    <div style="text-align: right; border-top: 2px solid #000; padding-top: 10px;">
        <h3 style="margin: 0;">рдХреБрд▓ рд░рд╛рд╢рд┐ (Total): <span id="inv-total" style="color: #27ae60;">тВ╣0.00</span></h3>
    </div>

    <div style="margin-top: 40px; text-align: center; font-size: 12px; color: #888;">
        <p>рдзрдиреНрдпрд╡рд╛рдж! рдлрд┐рд░ рдЕрд╡рд╢реНрдп рдкрдзрд╛рд░реЗрдВред</p>
        <p>рдпрд╣ рдПрдХ рдХрдВрдкреНрдпреВрдЯрд░ рдЬрдирд┐рдд рд░рд╕реАрдж рд╣реИред</p>
    </div>
</div>



    </script>
   

    <script>
        // тЬЕ FINAL PDF FUNCTION (Mobile Safe - No White Screen)
        window.downloadBillFinal = function(invoiceId, customerName, items, totalAmount) {
            
            // 1. рдорд╢реАрди рдЪреЗрдХ рдХрд░реЗрдВ
            if (!window.jspdf) {
                alert("тЪая╕П PDF рд╕рд┐рд╕реНрдЯрдо рд▓реЛрдб рдирд╣реАрдВ рд╣реБрдЖред рдЗрдВрдЯрд░рдиреЗрдЯ рдЪреЗрдХ рдХрд░реЗрдВред");
                return;
            }
        
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
        
                // --- DESIGN START (Professional Blue) ---
                doc.setFillColor(41, 128, 185); 
                doc.rect(0, 0, pageWidth, 35, 'F');
        
                // Shop Name Logic
                const shopName = (typeof AppState !== 'undefined' && AppState.user?.shopName) ? AppState.user.shopName : "MY SHOP NAME";
                
                doc.setFont("helvetica", "bold");
                doc.setFontSize(22);
                doc.setTextColor(255, 255, 255);
                doc.text(shopName.toUpperCase(), 15, 15);
        
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text("Mobile: 9876543210 | Address: City, India", 15, 22);
        
                doc.setFontSize(16);
                doc.text("INVOICE", pageWidth - 15, 20, { align: 'right' });
        
                doc.setTextColor(0, 0, 0);
                let y = 45;
        
                // Customer Details
                doc.setFontSize(10);
                doc.setFont("helvetica", "bold");
                doc.text("BILL TO:", 15, y);
                doc.setFont("helvetica", "normal");
                doc.text((customerName || "Cash Customer").toUpperCase(), 15, y + 6);
        
                doc.setFont("helvetica", "bold");
                doc.text("Invoice No:", 140, y);
                doc.text("Date:", 140, y + 6);
                doc.setFont("helvetica", "normal");
                doc.text(`#${invoiceId || '--'}`, 170, y);
                doc.text(new Date().toLocaleDateString('en-IN'), 170, y + 6);
        
                // Table
                y += 20;
                doc.setFillColor(230, 230, 230);
                doc.rect(15, y, pageWidth - 30, 8, 'F');
                doc.setFont("helvetica", "bold");
                doc.setFontSize(9);
                doc.text("#", 18, y + 5);
                doc.text("ITEM", 30, y + 5);
                doc.text("QTY", 120, y + 5, { align: 'center' });
                doc.text("RATE", 150, y + 5, { align: 'center' });
                doc.text("TOTAL", 185, y + 5, { align: 'center' });
        
                y += 8;
                doc.setFont("helvetica", "normal");
        
                items.forEach((item, index) => {
                    let itemName = item.name || "Item";
                    if (itemName.length > 35) itemName = itemName.substring(0, 35) + "...";
        
                    doc.text(String(index + 1), 18, y + 5);
                    doc.text(itemName, 30, y + 5);
                    doc.text(String(item.quantity), 120, y + 5, { align: 'center' });
                    doc.text(String(item.sale_price), 150, y + 5, { align: 'center' });
                    
                    const lineTotal = (parseFloat(item.sale_price) * parseFloat(item.quantity)).toFixed(2);
                    doc.text(String(lineTotal), 185, y + 5, { align: 'center' });
        
                    doc.setDrawColor(220, 220, 220);
                    doc.line(15, y + 7, pageWidth - 15, y + 7);
                    y += 8;
                });
        
                y += 5;
                doc.setDrawColor(0, 0, 0);
                doc.line(15, y, pageWidth - 15, y);
                y += 7;
                doc.setFont("helvetica", "bold");
                doc.setFontSize(12);
                doc.text("GRAND TOTAL", 140, y);
                doc.text('тВ╣' + parseFloat(totalAmount).toFixed(2), 185, y, { align: 'center' });
        
                doc.setFontSize(10);
                doc.setTextColor(41, 128, 185);
                doc.text("Thank you for your business!", pageWidth / 2, pageHeight - 10, { align: 'center' });
        
                // ЁЯФе MAGIC FIX: doc.save() рдореЛрдмрд╛рдЗрд▓ рдкрд░ рдирдпрд╛ рдкреЗрдЬ рдирд╣реАрдВ рдЦреЛрд▓рддрд╛, рд╕реАрдзреЗ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рддрд╛ рд╣реИред
                // рдХреЛрдИ white screen рдирд╣реАрдВ рдЖрдПрдЧреАред
                doc.save(`Invoice_${invoiceId}.pdf`);
        
            } catch (e) {
                alert("Error: " + e.message);
            }
        };




        // ЁЯЫбя╕П STEP 3: ANTI-THEFT BROWSER GUARD
// рдпрд╣ рдХреЛрдб рдкреЗрдЬ рд░рд┐рдлреНрд░реЗрд╢ рдпрд╛ рдмрдВрдж рд╣реЛрдиреЗ рд╕реЗ рд░реЛрдХреЗрдЧрд╛ рдЕрдЧрд░ рдХрд╛рд░реНрдЯ рдореЗрдВ Lock Item рд╣реИ
// ЁЯЫбя╕П STEP 3 FINAL: STRICT BROWSER GUARD
window.addEventListener('beforeunload', function (e) {
    // 1. рдХрд╛рд░реНрдЯ рдЪреЗрдХ
    const hasSecuredItem = posCart && posCart.some(item => 
        item.is_secured === true || 
        (item.product_attributes && item.product_attributes.is_secured === true)
    );

    // 2. рдЕрдЧрд░ рд▓реЙрдХ рдЖрдЗрдЯрдо рд╣реИ
    if (hasSecuredItem) {
        // рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдХреЛ рдлреЛрд░реНрд╕ рдХрд░реЗрдВ рдХрд┐ рд╡рд╣ рд░реБрдХ рдЬрд╛рдП
        e.preventDefault(); 
        // Chrome рдФрд░ modern browsers рдХреЗ рд▓рд┐рдП рдпрд╣ рдЬрд░реВрд░реА рд╣реИ
        e.returnValue = 'тЪая╕П Security Alert: Anti-Theft Item in Cart!'; 
        return 'тЪая╕П Security Alert: Anti-Theft Item in Cart!';
    }
});



// ЁЯФМ FIX: рдкреЗрдЬ рд▓реЛрдб рд╣реЛрдиреЗ рдкрд░ WhatsApp рдЪреЗрдХрдмреЙрдХреНрд╕ рдХреЛ рдмрдВрдж рд░рдЦреЗрдВ
document.addEventListener('DOMContentLoaded', function() {
    const waBox = document.getElementById('pos_send_cust_wa');
    if (waBox) {
        waBox.checked = false; // рдЬрдмрд░рджрд╕реНрддреА рдЯрд┐рдХ рд╣рдЯрд╛рдПрдВ
    }
});




// ЁЯХ╡я╕ПтАНтЩВя╕П SECURITY LOG SYSTEM (Jasoos Code)
// рдпрд╣ рдЪреЛрд░реА-рдЫрд┐рдкреЗ рд╕рд╛рд░реА рдЬрд╛рдирдХрд╛рд░реА LocalStorage рдореЗрдВ рд╕реЗрд╡ рдХрд░реЗрдЧрд╛

// ЁЯХ╡я╕ПтАНтЩВя╕П SECURITY LOG SYSTEM (With Staff ID Tracking)
const SecurityLogger = {
    
    // 1. рд▓реЙрдЧ рд╕реЗрд╡ рдХрд░рдиреЗ рдХрд╛ рдлрдВрдХреНрд╢рди (рдЕрдм рд╕реНрдЯрд╛рдл рдХрд╛ рдирд╛рдо рднреА рдиреЛрдЯ рдХрд░реЗрдЧрд╛)
    log: function(action, details) {
        // рдпрд╣рд╛рдБ рд╣рдо рдкрддрд╛ рдХрд░реЗрдВрдЧреЗ рдХрд┐ рдЕрднреА рдХреМрди рд▓реЙрдЧрд┐рди рд╣реИ
        // рдЕрдЧрд░ рдЖрдкрдХреЗ рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рд▓реЙрдЧрд┐рди рдИрдореЗрд▓ 'user_email' рдпрд╛ 'currentUser' рдирд╛рдо рд╕реЗ рд╕реЗрд╡ рд╣реЛрддрд╛ рд╣реИ
        const staffName = localStorage.getItem('user_email') || localStorage.getItem('username') || 'Admin/Owner';
        
        const logs = JSON.parse(localStorage.getItem('security_logs') || '[]');
        const newLog = {
            time: new Date().toLocaleString(),
            user: staffName,  // ЁЯСИ рдпрд╣рд╛рдБ рд╕реНрдЯрд╛рдл рдХрд╛ рдИрдореЗрд▓/рдирд╛рдо рдЖрдПрдЧрд╛
            action: action,
            details: details
        };
        
        logs.unshift(newLog); 
        if (logs.length > 50) logs.pop(); 
        localStorage.setItem('security_logs', JSON.stringify(logs));
        console.log(`ЁЯУЭ Log Recorded: ${action} by ${staffName}`);
    },

    // 2. рд▓реЙрдЧ рджреЗрдЦрдиреЗ рдХрд╛ рдлрдВрдХреНрд╢рди (рдирдпрд╛ рдХреЙрд▓рдо: User)
    showLogs: function() {
        const logs = JSON.parse(localStorage.getItem('security_logs') || '[]');
        
        if (logs.length === 0) {
            Swal.fire('Security Log', 'рдЕрднреА рддрдХ рдХреЛрдИ рд╕рд┐рдХреНрдпреЛрд░рд┐рдЯреА рдЕрд▓рд░реНрдЯ рдирд╣реАрдВ рд╣реИред', 'info');
            return;
        }

        let htmlTable = `
            <div style="max-height: 300px; overflow-y: auto; text-align: left;">
            <table class="table table-bordered table-sm" style="font-size: 12px;">
                <thead class="table-dark">
                    <tr>
                        <th>Time</th>
                        <th>Staff/User</th> <th>Action</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        logs.forEach(log => {
            const color = log.action.includes('DELETE') ? 'text-danger fw-bold' : 'text-success';
            htmlTable += `
                <tr>
                    <td>${log.time}</td>
                    <td class="fw-bold text-primary">${log.user}</td> <td class="${color}">${log.action}</td>
                    <td>${log.details}</td>
                </tr>
            `;
        });

        htmlTable += `</tbody></table></div>`;

        Swal.fire({
            title: 'ЁЯХ╡я╕ПтАНтЩВя╕П Security Audit Logs',
            html: htmlTable,
            width: '700px', // рдЯреЗрдмрд▓ рдЪреМреЬреА рдХреА рддрд╛рдХрд┐ рдИрдореЗрд▓ рдЖ рд╕рдХреЗ
            confirmButtonText: 'Close'
        });
    },

    clearLogs: function() {
        if(confirm("Delete all logs?")) {
            localStorage.removeItem('security_logs');
            alert("Logs Cleared.");
        }
    }
};





// тЪЩя╕П SETTINGS LOGIC (Admin Password Protected)
let settingsModalInstance = null;

async function openSettingsModal() {
    
    // ЁЯФТ STEP 1: рдкрд╛рд╕рд╡рд░реНрдб рдорд╛рдВрдЧреЗрдВ (Security Check)
    const { value: password } = await Swal.fire({
        title: 'Admin Access Only',
        text: 'рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдмрджрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдбрдорд┐рди рдкрд╛рд╕рд╡рд░реНрдб рдбрд╛рд▓реЗрдВ:',
        input: 'password',
        inputPlaceholder: 'Enter Password',
        icon: 'lock',
        confirmButtonText: 'Unlock',
        showCancelButton: true
    });

    // ЁЯФТ STEP 2: рдкрд╛рд╕рд╡рд░реНрдб рдЪреЗрдХ рдХрд░реЗрдВ (рдпрд╣рд╛рдБ рдкрд╛рд╕рд╡рд░реНрдб 'admin123' рд╣реИ, рдЖрдк рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВ)
    if (password !== 'Sagar@#9529561113@abc') {
        if (password) {
            Swal.fire('Access Denied', 'рдЧрд▓рдд рдкрд╛рд╕рд╡рд░реНрдб! рдЖрдк рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдирд╣реАрдВ рдмрджрд▓ рд╕рдХрддреЗред', 'error');
        }
        return; // рдпрд╣реАрдВ рд░реБрдХ рдЬрд╛рдУ, рд╕реЗрдЯрд┐рдВрдЧ рдордд рдЦреЛрд▓реЛ
    }

    // --- рдЕрдЧрд░ рдкрд╛рд╕рд╡рд░реНрдб рд╕рд╣реА рд╣реИ, рддрднреА рдиреАрдЪреЗ рдХрд╛ рдХреЛрдб рдЪрд▓реЗрдЧрд╛ ---

    // 1. Modal рддреИрдпрд╛рд░ рдХрд░реЗрдВ
    const modalElement = document.getElementById('settingsModal');
    if (!modalElement) return;

    if (!settingsModalInstance) {
        settingsModalInstance = new bootstrap.Modal(modalElement);
    }

    // 2. рдкреБрд░рд╛рдиреА рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рд▓реЛрдб рдХрд░реЗрдВ
    const currentType = localStorage.getItem('business_type') || 'General';
    const currentEmail = localStorage.getItem('user_email') || '';

    const typeDropdown = document.getElementById('setting_business_type');
    const emailInput = document.getElementById('setting_staff_email');

    if(typeDropdown) typeDropdown.value = currentType;
    if(emailInput) emailInput.value = currentEmail;

    // 3. рдкреЙрдк-рдЕрдк рджрд┐рдЦрд╛рдПрдВ
    settingsModalInstance.show();
}

// 4. рд╕реЗрдЯрд┐рдВрдЧ рд╕реЗрд╡ рдХрд░рдиреЗ рдХрд╛ рдлрдВрдХреНрд╢рди (рд╡рд╣реА рдкреБрд░рд╛рдирд╛)
function saveBusinessSettings() {
    const type = document.getElementById('setting_business_type').value;
    const email = document.getElementById('setting_staff_email').value;

    localStorage.setItem('business_type', type);
    if(email) localStorage.setItem('user_email', email);

    if(typeof Swal !== 'undefined') {
        Swal.fire({
            icon: 'success', title: 'Saved!', 
            text: `Business Type: ${type}`, timer: 1500, showConfirmButton: false
        }).then(() => {
            if(settingsModalInstance) settingsModalInstance.hide();
            location.reload();
        });
    } else {
        location.reload();
    }
}



// ============================================================
// ЁЯФл UNIVERSAL BARCODE SCANNER (GUN MODE)
// ============================================================
// рдпрд╣ рдХреЛрдб рдЖрдкрдХреЗ рдкреБрд░рд╛рдиреЗ рдореЛрдмрд╛рдЗрд▓ рд╕реНрдХреИрдирд░ рдХреЛ рдбрд┐рд╕реНрдЯрд░реНрдм рдирд╣реАрдВ рдХрд░реЗрдЧрд╛ред
// рдпрд╣ рд╕рд┐рд░реНрдл рддрдм рдЪрд▓реЗрдЧрд╛ рдЬрдм рдХреЛрдИ "Gun Scanner" рд╕реЗ рддреЗрдЬреА рд╕реЗ рд╕реНрдХреИрди рдХрд░реЗрдЧрд╛ред

let barcodeBuffer = ""; // рд╕реНрдХреИрди рдХрд┐рдП рдЧрдП рдирдВрдмрд░ рдХреЛ рдпрд╣рд╛рдБ рдЬрдорд╛ рдХрд░реЗрдВрдЧреЗ
let barcodeTimer;       // рдЯрд╛рдЗрдорд░ рдпрд╣ рджреЗрдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рдЯрд╛рдЗрдкрд┐рдВрдЧ рдХрд┐рддрдиреА рддреЗрдЬ рд╣реИ

document.addEventListener('keydown', function(e) {
    
    // 1. рдЕрдЧрд░ рдХреЛрдИ рдЗрдирдкреБрдЯ рдмреЙрдХреНрд╕ (рдЬреИрд╕реЗ рдХрд╕реНрдЯрдорд░ рдХрд╛ рдирд╛рдо) рдЦреБрд▓рд╛ рд╣реИ, рддреЛ рджрдЦрд▓ рди рджреЗрдВ
    const activeTag = document.activeElement.tagName;
    const activeId = document.activeElement.id;
    
    // рдЕрдЧрд░ рд╕рд░реНрдЪ рдмреЙрдХреНрд╕ рдпрд╛ рдХреНрд╡рд╛рдВрдЯрд┐рдЯреА рдмреЙрдХреНрд╕ рдореЗрдВ рдЯрд╛рдЗрдк рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рддреЛ рд╕реНрдХреИрдирд░ рдХреЛрдб рдХреЛ рд░реЛрдХреЗрдВ
    // рд▓реЗрдХрд┐рди рдЕрдЧрд░ рдмреЙрдбреА рдкрд░ рдлреЛрдХрд╕ рд╣реИ, рддреЛ рд╕реНрдХреИрдирд┐рдВрдЧ рдЪрд╛рд▓реВ рд░рдЦреЗрдВ
    if ((activeTag === 'INPUT' || activeTag === 'TEXTAREA') && activeId !== 'pos-search-bar') {
        return; 
    }

    // 2. 'Enter' рдмрдЯрди рджрдмрд╛рдиреЗ рдкрд░ (рд╕реНрдХреИрди рдкреВрд░рд╛ рд╣реБрдЖ)
    if (e.key === 'Enter') {
        if (barcodeBuffer.length > 2) { // рдХрдо рд╕реЗ рдХрдо 3 рдирдВрдмрд░ рдХрд╛ рдмрд╛рд░рдХреЛрдб рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП
            e.preventDefault(); // рдкреЗрдЬ рд░рд┐рдлреНрд░реЗрд╢ рд╣реЛрдиреЗ рд╕реЗ рд░реЛрдХреЗрдВ
            handleScannedBarcode(barcodeBuffer); // рдЖрдЗрдЯрдо рдвреВрдВрдвреЗ
            barcodeBuffer = ""; // рдмрдлрд░ рдЦрд╛рд▓реА рдХрд░реЗрдВ
        }
        return;
    }

    // 3. рдЯрд╛рдЗрдорд░ рд╕реЗрдЯ рдХрд░реЗрдВ (рдЗрдВрд╕рд╛рди рдзреАрд░реЗ рдЯрд╛рдЗрдк рдХрд░рддрд╛ рд╣реИ, рд╕реНрдХреИрдирд░ рдмрд╣реБрдд рддреЗрдЬ)
    // рдЕрдЧрд░ 50ms рд╕реЗ рдЬреНрдпрд╛рджрд╛ рдЧреИрдк рд╣реИ, рддреЛ рдЗрд╕рдХрд╛ рдорддрд▓рдм рдпрд╣ рдкреБрд░рд╛рдирд╛ рд╕реНрдХреИрди рдирд╣реАрдВ, рдирдИ рдЯрд╛рдЗрдкрд┐рдВрдЧ рд╣реИ
    clearTimeout(barcodeTimer);
    barcodeTimer = setTimeout(() => {
        barcodeBuffer = ""; // рдЯрд╛рдЗрдо рдЖрдЙрдЯ рд╣реЛ рдЧрдпрд╛, рдмрдлрд░ рд╕рд╛рдл рдХрд░реЛ
    }, 100); // 100 рдорд┐рд▓реАрд╕реЗрдХрдВрдб рдХрд╛ рд╕рдордп (Gun Scanner рдЗрд╕рд╕реЗ рддреЗрдЬ рд╣реЛрддрд╛ рд╣реИ)

    // 4. рд╕рд┐рд░реНрдл рдирдВрдмрд░ рдФрд░ рдЕрдХреНрд╖рд░ рдЬреЛрдбрд╝реЗрдВ (Shift, Ctrl рд╡рдЧреИрд░рд╣ рдирд╣реАрдВ)
    if (e.key.length === 1) {
        barcodeBuffer += e.key;
    }
});

// ЁЯФН рдмрд╛рд░рдХреЛрдб рдкреНрд░реЛрд╕реЗрд╕ рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рдлрдВрдХреНрд╢рди
function handleScannedBarcode(code) {
    console.log("ЁЯФл Scanned Code:", code);

    // 1. рд╕реНрдЯреЙрдХ рдореЗрдВ рдЖрдЗрдЯрдо рдвреВрдВрдвреЗрдВ (SKU рдпрд╛ Barcode рд╕реЗ)
    // (рдпрд╣рд╛рдБ рд╣рдо рдорд╛рди рд░рд╣реЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХрд╛ SKU рд╣реА рдмрд╛рд░рдХреЛрдб рд╣реИ)
    const product = currentStock.find(item => 
        item.sku.toString().toLowerCase() === code.toLowerCase() || 
        item.name.toLowerCase() === code.toLowerCase()
    );

    if (product) {
        // 2. рдЕрдЧрд░ рдЖрдЗрдЯрдо рдорд┐рд▓ рдЧрдпрд╛
        addToCart(product); // рдХрд╛рд░реНрдЯ рдореЗрдВ рдбрд╛рд▓реЗрдВ
        
        // рдмреАрдк рдХреА рдЖрд╡рд╛рдЬ рдпрд╛ рдореИрд╕реЗрдЬ (Optional)
        const toast = Swal.mixin({
            toast: true, position: 'top-end', 
            showConfirmButton: false, timer: 1500,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });
        toast.fire({
            icon: 'success',
            title: `Added: ${product.name}`
        });

        // рд╕рд░реНрдЪ рдмрд╛рд░ рдЦрд╛рд▓реА рдХрд░реЗрдВ (рдЕрдЧрд░ рд╡рд╣рд╛рдВ рдЯрд╛рдЗрдк рд╣реЛ рдЧрдпрд╛ рд╣реЛ)
        const searchInput = document.getElementById('pos-search-bar');
        if(searchInput) searchInput.value = '';

    } else {
        // 3. рдЕрдЧрд░ рдЖрдЗрдЯрдо рдирд╣реАрдВ рдорд┐рд▓рд╛
        Swal.fire({
            icon: 'error',
            title: 'Not Found',
            text: `Barcode "${code}" рд╕реНрдЯреЙрдХ рдореЗрдВ рдирд╣реАрдВ рдорд┐рд▓рд╛!`,
            timer: 2000,
            showConfirmButton: false
        });
    }
}

// ЁЯЦия╕П SMART THERMAL PRINT FUNCTION (Final Version)
function generateThermalPrint(invoiceId, customerName, items, totalAmount) {
    
    // 1. рд░рд╕реАрдж рдПрд░рд┐рдпрд╛ рдХреЛ рдвреВрдВрдвреЗрдВ рдФрд░ рджрд┐рдЦрд╛рдПрдВ
    const receipt = document.getElementById('thermal-receipt-area');
    if (!receipt) return alert("Error: Receipt HTML Missing!");
    
    receipt.style.display = 'block'; // рдкреНрд░рд┐рдВрдЯрд░ рдХреЛ рджрд┐рдЦрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд┐рдЬрд┐рдмрд▓ рдХрд░реЗрдВ

    // 2. рдмреЗрд╕рд┐рдХ рдбреЗрдЯрд╛ рднрд░реЗрдВ
    document.getElementById('p-invoice-id').innerText = invoiceId;
    document.getElementById('p-date').innerText = new Date().toLocaleDateString('en-IN');
    document.getElementById('p-time').innerText = new Date().toLocaleTimeString('en-IN', {hour: '2-digit', minute:'2-digit'});
    document.getElementById('p-total').innerText = parseFloat(totalAmount).toFixed(2);

    // 3. рдЖрдЗрдЯрдо рдЯреЗрдмрд▓ рднрд░реЗрдВ
    const tbody = document.getElementById('p-items-body');
    tbody.innerHTML = ''; // рдкреБрд░рд╛рдиреА рд▓рд┐рд╕реНрдЯ рд╕рд╛рдлрд╝ рдХрд░реЗрдВ

    let totalQty = 0; // рдЖрдЗрдЯрдо рдЧрд┐рдирдиреЗ рдХреЗ рд▓рд┐рдП

    items.forEach(item => {
        const qty = Number(item.quantity || 1);
        totalQty += qty; // рдХреБрд▓ рдЧрд┐рдирддреА рдЬреЛрдбрд╝реЗрдВ

        const row = `
            <tr>
                <td style="padding-bottom: 2px;">${item.name.substring(0, 15)}</td>
                <td style="vertical-align: top; text-align: center;">${qty}</td>
                <td style="text-align: right; vertical-align: top;">
                    ${(item.sale_price * qty).toFixed(2)}
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });

    // 4. ЁЯЪА SMART GATE PASS SYSTEM ---------------------------
    const qrImg = document.getElementById('p-qrcode');
    const qtySpan = document.getElementById('p-total-qty');
    let isPrinted = false; // рдпрд╣ рдЭрдВрдбрд╛ (Flag) рд╣реИ рдЬреЛ рдбрдмрд▓ рдкреНрд░рд┐рдВрдЯ рд░реЛрдХреЗрдЧрд╛

    // рдкреНрд░рд┐рдВрдЯ рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рдлрдВрдХреНрд╢рди (рдЬреЛ рдПрдХ рд╣реА рдмрд╛рд░ рдЪрд▓реЗрдЧрд╛)
    function finalizePrint() {
        if (isPrinted) return; // рдЕрдЧрд░ рдкрд╣рд▓реЗ рд╣реА рдкреНрд░рд┐рдВрдЯ рд╣реЛ рдЧрдпрд╛ рддреЛ рд░реБрдХреЛ
        isPrinted = true;
        
        window.print(); 
        receipt.style.display = 'none'; // рдХрд╛рдо рд╣реЛрдиреЗ рдХреЗ рдмрд╛рдж рдЫрд┐рдкрд╛ рджреЗрдВ
    }

    if (qrImg && qtySpan) {
        // рдЖрдЗрдЯрдо рдХреА рдЧрд┐рдирддреА рд╕реЗрдЯ рдХрд░реЗрдВ
        qtySpan.innerText = totalQty;

        // QR рдХреЛрдб рдЗрдореЗрдЬ рдХрд╛ рд▓рд┐рдВрдХ рдбрд╛рд▓реЗрдВ
        qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${invoiceId}`;

        // тЬЕ Plan A: рдЬреИрд╕реЗ рд╣реА рдЗрдореЗрдЬ рд▓реЛрдб рд╣реЛ, рддреБрд░рдВрдд рдкреНрд░рд┐рдВрдЯ рдХрд░реЛ (Fastest)
        qrImg.onload = function() {
            finalizePrint();
        };

        // тЪая╕П Plan B: рдЕрдЧрд░ рдЗрдореЗрдЬ рд▓реЛрдб рди рд╣реЛ (Error), рддреЛ рднреА рдкреНрд░рд┐рдВрдЯ рдХрд░реЛ (рд░реБрдХрдирд╛ рдирд╣реАрдВ рд╣реИ)
        qrImg.onerror = function() {
            finalizePrint();
        };

        // тП░ Plan C: рдмреИрдХрдЕрдк рдЯрд╛рдЗрдорд░ (рдЕрдЧрд░ рдЗрдВрдЯрд░рдиреЗрдЯ рдмрд╣реБрдд рд╕реНрд▓реЛ рд╣реИ)
        // 2.5 рд╕реЗрдХрдВрдб рдмрд╛рдж рдпрд╣ рдЬрдмрд░рджрд╕реНрддреА рдкреНрд░рд┐рдВрдЯ рдХрд░ рджреЗрдЧрд╛
        setTimeout(() => {
            if (!isPrinted) {
                finalizePrint();
            }
        }, 3000);

    } else {
        // рдЕрдЧрд░ Gate Pass рд╕реЗрдХреНрд╢рди рдирд╣реАрдВ рд╣реИ, рддреЛ рдирд╛рд░реНрдорд▓ рдкреНрд░рд┐рдВрдЯ рдХрд░реЗрдВ
        finalizePrint();
    }
}


// 2. рдХреИрдорд░рд╛ рд╢реБрд░реВ рдХрд░реЗрдВ (Safe Mode)
async function startSecurityCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        const video = document.getElementById('security-video');
        if (video) video.srcObject = stream;
        console.log("ЁЯФТ Security Camera Active");
    } catch (err) {
        console.log("тЪая╕П No Camera Found (System will work sound-only)");
    }
}


// 3. ЁЯХ╡я╕ПтАНтЩВя╕П рдЪреЛрд░реА рдкрдХреЬрдиреЗ рдХрд╛ рдлрдВрдХреНрд╢рди (THEFT TRIGGER - NO CRASH)
function triggerTheftAlarm(itemName = "Unknown Item") {
    
    // A. рд╕рд╛рдпрд░рди рдмрдЬрд╛рдУ ЁЯФК (рдЕрдЧрд░ рдлрд╛рдЗрд▓ рд▓реЛрдб рд╣реЛ рдЧрдИ рд╣реИ)
    const siren = document.getElementById('theft-siren');
    if (siren) {
        siren.volume = 1.0;
        siren.currentTime = 0; // рд╢реБрд░реВ рд╕реЗ рдмрдЬрд╛рдУ
        siren.play().catch(e => console.log("Audio error:", e));
    }

    // B. рдлреЛрдЯреЛ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░реЛ ЁЯУ╕ (рдпрд╛ рдбрд┐рдлреЙрд▓реНрдЯ рдЗрдореЗрдЬ рд▓реЛ)
    let photoDataUrl = 'https://cdn-icons-png.flaticon.com/512/564/564619.png'; // тЪая╕П Default Alert Icon
    
    try {
        const video = document.getElementById('security-video');
        const canvas = document.getElementById('security-canvas');
        
        // рдЕрдЧрд░ рдХреИрдорд░рд╛ рдЪрд▓ рд░рд╣рд╛ рд╣реИ (ReadyState 4) рддрднреА рдлреЛрдЯреЛ рдЦреАрдВрдЪреЛ
        if (video && video.readyState === 4) {
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, 320, 240);
            photoDataUrl = canvas.toDataURL('image/png'); // рдЕрд╕рд▓реА рдлреЛрдЯреЛ
        }
    } catch (e) {
        console.log("Photo capture skipped (No Camera)");
    }

    // C. рд╕реНрдХреНрд░реАрди рдкрд░ рджрд┐рдЦрд╛рдУ (RED ALERT) ЁЯЪи
    Swal.fire({
        title: 'ЁЯЪи THEFT DETECTED! ЁЯЪи',
        html: `
            <h3 style="color:red;">рдЪреЛрд░реА рдкрдХреЬреА рдЧрдИ!</h3>
            <p><b>Item:</b> ${itemName}</p>
            <div style="display:flex; justify-content:center;">
                <img src="${photoDataUrl}" style="width:200px; border: 5px solid red; border-radius: 10px;">
            </div>
            <br>
            <p style="color:red; font-weight:bold;">Security Alert Active!</p>
        `,
        icon: 'error', // рд▓рд╛рд▓ рдХреНрд░реЙрд╕ рдЖрдЗрдХреЙрди
        background: '#fff0f0',
        confirmButtonText: 'ЁЯЫС STOP ALARM',
        confirmButtonColor: '#d33',
        allowOutsideClick: false,
        allowEscapeKey: false
    }).then(() => {
        // рдмрдЯрди рджрдмрд╛рдиреЗ рдкрд░ рд╕рд╛рдпрд░рди рдмрдВрдж рдХрд░реЗрдВ
        if (siren) {
            siren.pause();
            siren.currentTime = 0;
        }
    });
}


// ==========================================
// ЁЯУ╕ FORCE CAMERA START (Fix for Testing)
// ==========================================
async function forceStartCamera() {
    try {
        console.log("ЁЯУ╕ Requesting Camera Access...");
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        
        // рд╡реАрдбрд┐рдпреЛ рдПрд▓рд┐рдореЗрдВрдЯ рдвреВрдВрдвреЗрдВ
        let video = document.getElementById('security-video');
        
        // рдЕрдЧрд░ рд╡реАрдбрд┐рдпреЛ рдПрд▓рд┐рдореЗрдВрдЯ рдирд╣реАрдВ рд╣реИ, рддреЛ рдЕрднреА рдмрдирд╛рдУ (Auto-Fix HTML)
        if (!video) {
            console.log("тЪая╕П Video Element missing, creating now...");
            video = document.createElement('video');
            video.id = 'security-video';
            video.width = 320;
            video.height = 240;
            video.autoplay = true;
            video.style.display = 'none'; // рдЫрд┐рдкрд╛ рд╣реБрдЖ
            document.body.appendChild(video);
            
            const canvas = document.createElement('canvas');
            canvas.id = 'security-canvas';
            canvas.width = 320;
            canvas.height = 240;
            canvas.style.display = 'none';
            document.body.appendChild(canvas);
        }
        
        video.srcObject = stream;
        alert("тЬЕ рдХреИрдорд░рд╛ рдХрдиреЗрдХреНрдЯ рд╣реЛ рдЧрдпрд╛! (Camera Connected)\nрдЕрдм Ghost Bill рдЯреЗрд╕реНрдЯ рджреЛрдмрд╛рд░рд╛ рдХрд░реЗрдВред");
        
    } catch (err) {
        alert("тЭМ рдХреИрдорд░рд╛ рдПрд░рд░: " + err.message + "\n(Note: рдпрд╣ file:// рдкрд░ рдХрд╛рдо рдирд╣реАрдВ рдХрд░реЗрдЧрд╛, рдЗрд╕реЗ Live Server рдкрд░ рдЪрд▓рд╛рдПрдВ)");
        console.error(err);
    }
}

// рдЯреЗрд╕реНрдЯрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рд╕реНрдХреНрд░реАрди рдкрд░ рдПрдХ рдЫреЛрдЯрд╛ рдмрдЯрди рджрд┐рдЦрд╛рдПрдВ
const camBtn = document.createElement('button');
camBtn.innerText = "ЁЯУ╕ Start Camera";
camBtn.style.position = "fixed";
camBtn.style.bottom = "10px";
camBtn.style.left = "10px";
camBtn.style.zIndex = "999999";
camBtn.className = "btn btn-primary btn-sm";
camBtn.onclick = forceStartCamera;
document.body.appendChild(camBtn);




// ==========================================
// ЁЯЪА LICENSE REQUEST VIA WHATSAPP (New)
// ==========================================
function requestLicenseKey() {
    // 1. рд▓реЛрдХрд▓ рд╕реНрдЯреЛрд░реЗрдЬ рдпрд╛ AppState рд╕реЗ рдпреВрдЬрд░ рдбреЗрдЯрд╛ рдирд┐рдХрд╛рд▓реЗрдВ
    const user = AppState.user || JSON.parse(localStorage.getItem('authUser') || '{}');
    
    // 2. Shop ID рдФрд░ рдирд╛рдо рд╕реБрд░рдХреНрд╖рд┐рдд рддрд░реАрдХреЗ рд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
    const shopId = user.shopId || user.id || 'N/A';
    const shopName = user.shopName || 'My Shop';
    const mobile = user.mobile || 'N/A';

    // 3. рдореИрд╕реЗрдЬ рддреИрдпрд╛рд░ рдХрд░реЗрдВ
    const message = `рдирдорд╕реНрддреЗ Admin,\n\nЁЯЖШ рдореБрдЭреЗ рдирдпрд╛ рд▓рд╛рдЗрд╕реЗрдВрд╕ рдЪрд╛рд╣рд┐рдПред\n\nЁЯЖФ Shop ID: *${shopId}*\nЁЯПк Shop Name: ${shopName}\nЁЯУ▒ Mobile: ${mobile}\n\nрдХреГрдкрдпрд╛ рд░рд┐рдиреНрдпреВ рдХрд░реЗрдВред рдзрдиреНрдпрд╡рд╛рдж!`;

    // 4. WhatsApp рд▓рд┐рдВрдХ рдЦреЛрд▓реЗрдВ (рдЕрдкрдирд╛ рдирдВрдмрд░ 7303410987 рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд░реЗрдВ)
    // рдЕрдЧрд░ рдирдВрдмрд░ рдореЗрдВ 91 рдирд╣реАрдВ рд╣реИ рддреЛ рд▓рдЧрд╛ рджреЗрдВ
    const adminNumber = "917303410987"; 
    
    const url = `https://wa.me/${adminNumber}?text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
}




// --- ЁЯСо SECURITY GUARD LOGIC ---

// 1. Verify Bill (Gate Pass)
async function verifyGatePass() {
    const billNo = document.getElementById('sec-invoice-id').value;
    const resBox = document.getElementById('sec-result');
    
    if(!billNo) return alert("Enter Bill Number");
    
    resBox.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Checking...';

    try {
        const res = await fetchApi('/api/security/verify-gate-pass', {
            method: 'POST',
            body: { invoiceId: billNo }
        });

        if(res.success) {
            // Play Success Sound (Beep)
            new Audio('https://www.soundjay.com/buttons/sounds/button-3.mp3').play();
            
            let itemList = res.items.map(i => `<div class="small text-start border-bottom">${i.item_name} (x${i.quantity})</div>`).join('');
            
            resBox.innerHTML = `
                <div class="alert alert-success mt-2">
                    <div class="display-6"><i class="fas fa-check-circle"></i> VERIFIED</div>
                    <div class="small">Bill Date: ${new Date(res.invoice.created_at).toLocaleDateString()}</div>
                    <div class="mt-2 bg-white p-2 rounded text-dark" style="max-height:100px; overflow-y:auto;">
                        ${itemList}
                    </div>
                </div>`;
        } else {
            // Play Error Sound
            new Audio('https://www.soundjay.com/buttons/sounds/beep-03.mp3').play();
            resBox.innerHTML = `<div class="alert alert-danger mt-2 display-6"><i class="fas fa-times-circle"></i> FAKE BILL!</div>`;
        }
    } catch(e) {
        resBox.innerHTML = `<span class="text-danger">${e.message}</span>`;
    }
}

// 2. Trigger Alarm (Siren)
function triggerTheftAlarm() {
    const siren = document.getElementById('theft-siren');
    
    // рдЕрдЧрд░ рд╕рд╛рдпрд░рди рдмрдЬ рд░рд╣рд╛ рд╣реИ, рддреЛ рдмрдВрдж рдХрд░реЗрдВ
    if (!siren.paused) {
        siren.pause();
        siren.currentTime = 0;
        return;
    }

    // рд╕рд╛рдпрд░рди рдмрдЬрд╛рдПрдВ
    siren.play().catch(e => alert("Please interact with document first"));
    
    // Log to Server
    fetchApi('/api/security/log-theft', { 
        method: 'POST', 
        body: { reason: 'Guard Panic Button Pressed' } 
    });

    // Visual Flash Effect
    document.body.style.animation = "flashRed 0.5s infinite";
    setTimeout(() => { document.body.style.animation = ""; }, 5000);
}

// Add CSS for Flash Effect
const style = document.createElement('style');
style.innerHTML = `
@keyframes flashRed {
    0% { background-color: #fff; }
    50% { background-color: #ffcccc; }
    100% { background-color: #fff; }
}`;
document.head.appendChild(style);

</script>

        
<div style="position: fixed; bottom: 80px; right: 20px; z-index: 1000;">
    <button class="btn btn-primary rounded-circle shadow p-3" onclick="openSettingsModal()" title="Business Settings">
        <i class="fas fa-cog fa-lg fa-spin-hover"></i>
    </button>
</div>

<div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-sliders-h"></i> рджреБрдХрд╛рди рдХреА рд╕реЗрдЯрд┐рдВрдЧреНрд╕</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="businessSettingsForm">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">рдмрд┐реЫрдиреЗрд╕ рдХрд╛ рдкреНрд░рдХрд╛рд░ (Business Type):</label>
                        <select class="form-select" id="setting_business_type">
                            <option value="General">рд╕рд╛рдзрд╛рд░рдг рджреБрдХрд╛рди (General Store)</option>
                            <option value="Grocery">рдХрд┐рд░рд╛рдирд╛ (Grocery/Kirana)</option>
                            <option value="Garments">рдХрдкреЬреЗ рдХреА рджреБрдХрд╛рди (Garments/Fashion)</option> <option value="Medical">рдореЗрдбрд┐рдХрд▓ рд╕реНрдЯреЛрд░ (Pharmacy)</option>
                            <option value="Electronics">рдЗрд▓реЗрдХреНрдЯреНрд░реЙрдирд┐рдХреНрд╕ (Electronics)</option>
                        </select>
                        <small class="text-muted">рдиреЛрдЯ: 'Garments' рдЪреБрдирдиреЗ рдкрд░ рд╣реА Anti-Theft Security рдЪрд╛рд▓реВ рд╣реЛрдЧреАред</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">рд╕реНрдЯрд╛рдл рдХрд╛ рдИрдореЗрд▓ (Staff Login):</label>
                        <input type="email" class="form-control" id="setting_staff_email" placeholder="staff@example.com">
                        <small class="text-muted">рдпрд╣ рд╕рд┐рд░реНрдл рдЯреЗрд╕реНрдЯрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рд╣реИ (рдЕрд╕рд▓реА рдРрдк рдореЗрдВ рдпрд╣ рд▓реЙрдЧрд┐рди рд╕реЗ рдЖрдПрдЧрд╛)</small>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">рдмрдВрдж рдХрд░реЗрдВ</button>
                <button type="button" class="btn btn-success" onclick="saveBusinessSettings()">рд╕реЗрд╡ рдХрд░реЗрдВ (Save)</button>
            </div>
        </div>
    </div>
</div>


<div id="thermal-receipt-area" style="display:none; width: 58mm; font-family: 'Courier New', monospace; font-size: 12px; background: #fff; color: #000;">
    
    <div class="receipt-header" style="text-align: center; margin-bottom: 5px;">
        <h3 style="margin:0;">DUKAN PRO</h3> 
        <div style="font-size: 10px;">Mobile: 9876543210</div>
        <div style="font-size: 10px;">Date: <span id="p-date"></span> | Time: <span id="p-time"></span></div>
        <div class="receipt-bold" style="font-weight: bold; margin-top: 2px;">Bill No: #<span id="p-invoice-id"></span></div>
    </div>

    <table class="receipt-table" style="width: 100%; border-collapse: collapse; font-size: 11px;">
        <thead style="border-bottom: 1px dashed #000;">
            <tr>
                <th style="width: 50%; text-align: left;">Item</th>
                <th style="width: 15%; text-align: center;">Qty</th>
                <th style="width: 35%; text-align: right;">Amt</th>
            </tr>
        </thead>
        <tbody id="p-items-body">
            </tbody>
    </table>

    <div style="text-align: right; border-top: 1px dashed #000; padding-top: 5px; margin-top: 5px;">
        <div style="font-size: 14px; font-weight: bold;">Total: тВ╣<span id="p-total">0.00</span></div>
    </div>

    <div style="border-top: 2px dashed black; margin-top: 10px; padding-top: 5px; text-align: center;">
        <h4 style="margin:0;">ЁЯЪк GATE PASS</h4>
        <div style="font-size: 10px;">Security Check Required</div>
        
        <img id="p-qrcode" src="" style="width: 100px; height: 100px; margin: 5px;">
        
        <div style="font-size: 12px; font-weight: bold;">
            Items: <span id="p-total-qty">0</span> | Paid тЬЕ
        </div>
    </div>
    <div class="receipt-footer" style="text-align: center; margin-top: 10px; font-size: 10px;">
        <div>Thank You! Visit Again.</div>
        <div>No Refund / No Exchange</div>
    </div>
</div>

<audio id="theft-siren" src="https://www.soundjay.com/mechanical/sounds/smoke-detector-1.mp3" preload="auto"></audio>

<video id="security-video" width="320" height="240" autoplay style="display:none;"></video>
<canvas id="security-canvas" width="320" height="240" style="display:none;"></canvas>



<div class="modal fade" id="securityModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-user-shield"></i> Security Guard Panel</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                
                <div class="mb-4">
                    <h6><i class="fas fa-qrcode"></i> Scan Bill QR / Enter Bill No</h6>
                    <div class="input-group mb-2">
                        <input type="number" id="sec-invoice-id" class="form-control form-control-lg text-center fw-bold" placeholder="Bill #">
                        <button class="btn btn-dark" onclick="verifyGatePass()">Verify</button>
                    </div>
                    <div id="sec-result" class="fw-bold mt-2"></div>
                </div>

                <hr>

                <div class="d-grid">
                    <button class="btn btn-outline-danger btn-lg py-3 fw-bold" onclick="triggerTheftAlarm()">
                        <i class="fas fa-bell fa-shake"></i> рдЪреЛрд░ рдкрдХрдбрд╝реЛ (Panic Alarm)
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

</body>
</html>