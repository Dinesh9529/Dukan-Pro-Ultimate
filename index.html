<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dukan Pro - Ultimate Business Suite</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-color: #0d6efd;
            --sidebar-bg: #212529;
            --sidebar-text: #adb5bd;
            --sidebar-text-hover: #ffffff;
            --content-bg: #f8f9fa;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        body {
            background-color: var(--content-bg);
            font-family: 'Poppins', sans-serif;
            overflow-x: hidden;
        }
        #main-app { display: flex; }
        #sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            color: var(--sidebar-text);
            min-height: 100vh;
            position: fixed;
            z-index: 100;
        }
        .sidebar-header { padding: 20px; background: #343a40; text-align: center; }
        .sidebar-header h3 { color: #fff; margin: 0; font-weight: 600; }
        #sidebar ul.components { padding: 20px 0; }
        #sidebar ul li a.nav-link {
            padding: 15px 25px; font-size: 1rem; display: block;
            width: 100%; text-align: left; border: none; background: none;
            color: var(--sidebar-text); text-decoration: none; border-left: 3px solid transparent;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        #sidebar ul li a.nav-link:hover { color: var(--sidebar-text-hover); background: #343a40; border-left-color: var(--primary-color); }
        #sidebar ul li a.nav-link.active { color: #fff; background: var(--primary-color); }
        #main-content {
            width: 100%;
            min-height: 100vh;
            padding-left: 260px;
        }
        .header-bar {
            padding: 1rem 1.5rem; background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: sticky; top: 0; z-index: 50;
        }
        .stat-card { border: none; border-radius: 10px; transition: transform 0.2s; box-shadow: var(--card-shadow); }
        .stat-card:hover { transform: translateY(-5px); }
        .invoice-container { padding: 2.5rem; border: 1px solid #dee2e6; background: #fff; }
        .invoice-header { display: flex; justify-content: space-between; border-bottom: 2px solid var(--primary-color); padding-bottom: 15px; }
        #invoice-preview {
             background: white; padding: 25px; border: 1px solid #dee2e6; min-height: 80vh;
        }
        @media print {
            body, #main-app, #main-content { display: block; padding-left: 0; }
            .no-print, .no-print * { display: none !important; }
            #invoice-preview-container, #invoice-preview {
                position: absolute; left: 0; top: 0; width: 100%;
                border: none; padding: 0; margin: 0; box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <div class="modal fade" id="license-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§ï‡•Å‡§Ç‡§ú‡•Ä</h5>
                </div>
                <div class="modal-body">
                    <p class="text-danger" id="license-message">‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡•Ä ‡§µ‡•à‡§ß ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§</p>
                    <input type="text" id="license-key-input" class="form-control" placeholder="‡§Ö‡§™‡§®‡•Ä ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§Ø‡§π‡§æ‡§Ç ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="validate-license-btn">‡§µ‡•à‡§ß ‡§ï‡§∞‡•á‡§Ç</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="main-app">
        <nav id="sidebar" class="no-print">
            <div class="sidebar-header">
                <h3><i class="fas fa-rocket me-2"></i>Dukan Pro</h3>
            </div>
            <ul class="list-unstyled components" id="main-tabs">
                <li><a href="#" class="nav-link active" data-pane="dashboard"><i class="fas fa-tachometer-alt fa-fw me-2"></i>‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</a></li>
                <li><a href="#" class="nav-link" data-pane="invoice"><i class="fas fa-file-invoice fa-fw me-2"></i>‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§ú‡•á‡§®‡§∞‡•á‡§ü‡§∞</a></li>
                <li><a href="#" class="nav-link" data-pane="stock"><i class="fas fa-boxes-stacked fa-fw me-2"></i>‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•à‡§®‡•á‡§ú‡§Æ‡•á‡§Ç‡§ü</a></li>
                <li><a href="#" class="nav-link" data-pane="crm"><i class="fas fa-users fa-fw me-2"></i>‡§ó‡•ç‡§∞‡§æ‡§π‡§ï (CRM)</a></li>
                <li><a href="#" class="nav-link" data-pane="reports"><i class="fas fa-chart-line fa-fw me-2"></i>‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏</a></li>
                <li><a href="#" class="nav-link" data-pane="cash-flow"><i class="fas fa-money-bill-transfer fa-fw me-2"></i>‡§ï‡•à‡§∂/‡§¨‡•à‡§Ç‡§ï ‡§´‡•ç‡§≤‡•ã</a></li>
            </ul>
        </nav>

        <main id="main-content">
            <header class="header-bar no-print">
                <h1 class="mb-0 h4" id="header-title">üìä ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</h1>
            </header>
            <div class="container-fluid p-4">
                <div id="pane-container">
                    </div>
            </div>
        </main>
    </div>

    <div class="modal fade" id="stock-modal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="stock-modal-title">‡§®‡§Ø‡§æ ‡§™‡•ç‡§∞‡•ã‡§°‡§ï‡•ç‡§ü</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="stock-form"><input type="hidden" id="stock-id"><div class="row g-3"><div class="col-md-12"><label class="form-label">‡§™‡•ç‡§∞‡•ã‡§°‡§ï‡•ç‡§ü ‡§ï‡§æ ‡§®‡§æ‡§Æ*</label><input type="text" id="stock-item-name" class="form-control" required></div><div class="col-md-6"><label class="form-label">SKU (‡§¨‡§æ‡§∞‡§ï‡•ã‡§°)</label><input type="text" id="stock-sku" class="form-control"></div><div class="col-md-6"><label class="form-label">‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ*</label><input type="number" id="stock-quantity" class="form-control" required></div><div class="col-md-6"><label class="form-label">‡§ñ‡§∞‡•Ä‡§¶ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø*</label><input type="number" id="stock-purchase-price" class="form-control" required step="0.01"></div><div class="col-md-6"><label class="form-label">‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§Æ‡•Ç‡§≤‡•ç‡§Ø*</label><input type="number" id="stock-sale-price" class="form-control" required step="0.01"></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button><button type="button" class="btn btn-primary" id="save-stock-btn">‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button></div></div></div></div>
    <div class="modal fade" id="crm-modal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="crm-modal-title">‡§®‡§Ø‡§æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="crm-form"><input type="hidden" id="crm-id"><div class="mb-3"><label class="form-label">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ*</label><input type="text" id="crm-name" class="form-control" required></div><div class="mb-3"><label class="form-label">‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞</label><input type="tel" id="crm-phone" class="form-control"></div><div class="mb-3"><label class="form-label">‡§™‡§§‡§æ</label><textarea id="crm-address" class="form-control" rows="2"></textarea></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button><button type="button" class="btn btn-primary" id="save-crm-btn">‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button></div></div></div></div>
    
<script>
// ===================================================================================
// DUKAN PRO - ULTIMATE BUSINESS SUITE SCRIPT (PostgreSQL Integration)
// ===================================================================================

document.addEventListener('DOMContentLoaded', () => {
    // --- CONFIGURATION & STATE MANAGEMENT ---
    const API_URL = 'https://dukan-pro-ultimate.onrender.com/api'; // Change to your deployed server URL
    const GST_RATE = 0.18; // 18%

    const AppState = {
        stock: [],
        customers: JSON.parse(localStorage.getItem('dukan_customers')) || [], // CRM remains local for simplicity
        sales: [], // Sales from API
        stats: {}, // Dashboard stats from API
        settings: JSON.parse(localStorage.getItem('dukan_settings')) || { 
            shopName: '‡§Ü‡§™‡§ï‡•Ä ‡§¶‡•Å‡§ï‡§æ‡§®', shopAddress: '‡§Ü‡§™‡§ï‡§æ ‡§™‡§§‡§æ', shopContact: '', shopGstin: '', qrCodeImage: '' 
        },
        license: localStorage.getItem('dukan_license_key') || null,
        isLicensed: false
    };

    // --- DOM ELEMENTS ---
    const DOM = {
        sidebarLinks: document.querySelectorAll('#sidebar .nav-link'),
        paneContainer: document.getElementById('pane-container'),
        headerTitle: document.getElementById('header-title'),
        stockModal: new bootstrap.Modal(document.getElementById('stock-modal')),
        crmModal: new bootstrap.Modal(document.getElementById('crm-modal')),
        licenseModal: new bootstrap.Modal(document.getElementById('license-modal'), {})
    };

    // --- UTILITY FUNCTIONS ---
    const saveLocalData = (key, data) => {
        localStorage.setItem(`dukan_${key}`, JSON.stringify(data));
    };

    const formatCurrency = (amount) => {
        return `‚Çπ${parseFloat(amount).toFixed(2)}`;
    };

    const showToast = (message, type = 'success') => {
        // Simple alert for now
        alert(`${type.toUpperCase()}: ${message}`);
    };
    
    // --- API FUNCTIONS ---
    const fetchAPI = async (endpoint, options = {}) => {
        try {
            const response = await fetch(`${API_URL}${endpoint}`, options);
            const data = await response.json();
            if (!response.ok) {
                showToast(data.message || 'Server Error', 'error');
                return null;
            }
            return data;
        } catch (error) {
            console.error("API Error:", error);
            showToast('API ‡§∏‡•á ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§', 'error');
            return null;
        }
    };

    const loadStock = async () => {
        const data = await fetchAPI('/stock');
        if (data) {
            // Map keys to client-side friendly names
            AppState.stock = data.map(item => ({
                id: item.ID, // Unique ID for updating stock
                name: item['Item Name'],
                sku: item.SKU,
                purchasePrice: parseFloat(item['Purchase Price']),
                salePrice: parseFloat(item['Sale Price']),
                quantity: parseInt(item.Quantity)
            }));
            return true;
        }
        return false;
    };
    
    const loadDashboardStats = async () => {
        const data = await fetchAPI('/dashboard-stats');
        if (data) {
            AppState.stats = data;
            return true;
        }
        return false;
    };
    
    // --- LICENSE LOGIC ---
    const setupLicenseCheck = () => {
        const savedKey = localStorage.getItem('dukan_license_key');
        if (savedKey) {
            document.getElementById('license-key-input').value = savedKey;
            validateLicense(savedKey);
        } else {
            DOM.licenseModal.show();
        }

        document.getElementById('validate-license-btn').addEventListener('click', () => {
            const key = document.getElementById('license-key-input').value;
            validateLicense(key);
        });
    };

    const validateLicense = async (key) => {
        const data = await fetchAPI('/validate-key', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ key })
        });

        if (data && data.valid) {
            AppState.isLicensed = true;
            AppState.license = key;
            localStorage.setItem('dukan_license_key', key);
            showToast('‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!', 'success');
            DOM.licenseModal.hide();
            // Load initial data and navigation
            await loadStock();
            await loadDashboardStats();
            setupNavigation();
            DOM.sidebarLinks[0].click(); 
        } else {
            AppState.isLicensed = false;
            document.getElementById('license-message').innerText = data ? data.message : '‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§Ø‡§æ ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§';
            DOM.licenseModal.show();
        }
    };
    
    // --- NAVIGATION & PANE RENDERING ---
    const setupNavigation = () => {
        DOM.sidebarLinks.forEach(link => {
            link.addEventListener('click', async (e) => {
                e.preventDefault();
                if (!AppState.isLicensed) return DOM.licenseModal.show();

                DOM.sidebarLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                const paneName = link.getAttribute('data-pane');
                DOM.headerTitle.innerHTML = link.innerHTML;
                
                // Reload data if needed
                if (paneName === 'dashboard' || paneName === 'reports') {
                    await loadDashboardStats();
                }
                if (paneName === 'stock' || paneName === 'invoice') {
                    await loadStock();
                }
                
                renderPane(paneName);
            });
        });
    };

    const renderPane = (paneName) => {
        DOM.paneContainer.innerHTML = getPaneHTML(paneName);
        attachPaneEventListeners(paneName);
    };

    const attachPaneEventListeners = (paneName) => {
        switch (paneName) {
            case 'dashboard': renderDashboard(); break;
            case 'invoice': initializeInvoice(); break;
            case 'stock': renderStockTable(); document.getElementById('add-stock-btn').addEventListener('click', () => openStockModal(null)); break;
            case 'crm': renderCrmTable(); document.getElementById('add-crm-btn').addEventListener('click', openCrmModal); break;
            case 'reports': renderReports(); break;
            case 'cash-flow': renderCashFlow(); break; // New
        }
    };
    
    // --- HTML TEMPLATE FUNCTIONS ---
    const getPaneHTML = (paneName) => {
        switch (paneName) {
            case 'dashboard': return getDashboardHTML();
            case 'invoice': return getInvoiceHTML();
            case 'stock': return getStockHTML();
            case 'crm': return getCrmHTML();
            case 'reports': return getReportsHTML();
            case 'cash-flow': return getCashFlowHTML(); // New Pane
            default: return `<h2>‡§™‡•á‡§ú ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ</h2>`;
        }
    };

    const getDashboardHTML = () => `
        <div class="row g-4">
            <div class="col-md-4"><div class="card p-3 text-center stat-card bg-success text-white"><h5>‡§ï‡•Å‡§≤ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä (GST ‡§∏‡§π‡§ø‡§§)</h5><h3 id="dash-total-revenue">${formatCurrency(AppState.stats.totalRevenue || 0)}</h3></div></div>
            <div class="col-md-4"><div class="card p-3 text-center stat-card bg-primary text-white"><h5>‡§ï‡•Å‡§≤ ‡§™‡•ç‡§∞‡•ã‡§°‡§ï‡•ç‡§ü‡•ç‡§∏</h5><h3 id="dash-total-products">${AppState.stats.totalProducts || 0}</h3></div></div>
            <div class="col-md-4"><div class="card p-3 text-center stat-card bg-info text-dark"><h5>‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•Ç‡§≤‡•ç‡§Ø</h5><h3 id="dash-stock-value">${formatCurrency(AppState.stats.stockValue || 0)}</h3></div></div>
        </div>
        <div class="card mt-4"><div class="card-body"><canvas id="salesChart"></canvas></div></div>`;
    
    const getInvoiceHTML = () => `
        <div class="row g-4">
            <div class="col-lg-5 no-print">
                <div class="card">
                    <div class="card-header"><h2>üìù ‡§®‡§à ‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§¨‡§®‡§æ‡§è‡§Ç</h2></div>
                    <div class="card-body p-4">
                        <div class="row g-3 mb-4">
                            <h5>üè™ ‡§¶‡•Å‡§ï‡§æ‡§® ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£</h5>
                            <div class="col-md-6"><input type="text" id="shopName" class="form-control" placeholder="‡§¶‡•Å‡§ï‡§æ‡§® ‡§ï‡§æ ‡§®‡§æ‡§Æ"></div>
                            <div class="col-md-6"><input type="text" id="shopContact" class="form-control" placeholder="‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§®‡§Ç‡§¨‡§∞"></div>
                            <div class="col-12"><input type="text" id="shopAddress" class="form-control" placeholder="‡§¶‡•Å‡§ï‡§æ‡§® ‡§ï‡§æ ‡§™‡§§‡§æ"></div>
                            <div class="col-md-6"><input type="text" id="shopGstin" class="form-control" placeholder="GSTIN (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)"></div>
                            <div class="col-md-6"><label class="form-label small">‡§™‡•á‡§Æ‡•á‡§Ç‡§ü QR ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç</label><input type="file" id="qrUpload" class="form-control form-control-sm" accept="image/*"></div>
                        </div>
                        <div class="row g-3 mb-4">
                            <h5>üë§ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£</h5>
                            <div class="col-md-6"><input type="text" id="customerName" class="form-control" placeholder="‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ" list="crm-datalist"></div>
                            <div class="col-md-6"><input type="text" id="customerContact" class="form-control" placeholder="‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§®‡§Ç‡§¨‡§∞"></div>
                            <div class="col-12"><input type="text" id="customerAddress" class="form-control" placeholder="‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§™‡§§‡§æ"></div>
                            <datalist id="crm-datalist">${AppState.customers.map(c => `<option value="${c.name}"></option>`).join('')}</datalist>
                        </div>
                        <h5 class="mb-3">‚ûï ‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</h5>
                        <div id="items-container"></div>
                        <button class="btn btn-outline-primary w-100 mt-2" id="add-item-row-btn"><i class="fas fa-plus"></i> ‡§®‡§Ø‡§æ ‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
                        <hr>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button class="btn btn-success" id="record-sale-btn">‚úÖ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ï‡§∞‡•á‡§Ç</button>
                            <button class="btn btn-primary" id="download-pdf-btn">‚¨áÔ∏è PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</button>
                            <button class="btn btn-info text-white" id="print-invoice-btn">üñ®Ô∏è ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü</button>
                            <button class="btn btn-danger" id="clear-bill-btn">üóëÔ∏è ‡§¨‡§ø‡§≤ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-7"><div id="invoice-preview" class="card"></div></div>
        </div>`;

    const getStockHTML = () => `
        <div class="card"><div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•à‡§®‡•á‡§ú‡§Æ‡•á‡§Ç‡§ü</h5><button class="btn btn-primary" id="add-stock-btn"><i class="fas fa-plus me-2"></i>‡§®‡§Ø‡§æ ‡§™‡•ç‡§∞‡•ã‡§°‡§ï‡•ç‡§ü</button>
            </div>
            <div class="table-responsive"><table class="table table-hover">
                <thead><tr><th>ID</th><th>SKU</th><th>‡§®‡§æ‡§Æ</th><th>‡§ñ‡§∞‡•Ä‡§¶ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø</th><th>‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§Æ‡•Ç‡§≤‡•ç‡§Ø</th><th>‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ</th><th>‡§è‡§ï‡•ç‡§∂‡§®</th></tr></thead>
                <tbody id="stock-table-body"></tbody>
            </table></div>
        </div></div>`;

    const getCrmHTML = () => `
        <div class="card"><div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§Æ‡•à‡§®‡•á‡§ú‡§Æ‡•á‡§Ç‡§ü</h5><button class="btn btn-primary" id="add-crm-btn"><i class="fas fa-plus me-2"></i>‡§®‡§Ø‡§æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï</button>
            </div>
            <div class="table-responsive"><table class="table table-hover">
                <thead><tr><th>‡§®‡§æ‡§Æ</th><th>‡§´‡•ã‡§®</th><th>‡§™‡§§‡§æ</th><th>‡§è‡§ï‡•ç‡§∂‡§®</th></tr></thead>
                <tbody id="crm-table-body"></tbody>
            </table></div>
        </div></div>`;

    const getReportsHTML = () => `
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card"><div class="card-body">
                    <h5 class="card-title mb-4">üìà ‡§™‡•ç‡§∞‡•â‡§´‡§ø‡§ü & ‡§≤‡•â‡§∏ ‡§∏‡•ç‡§ü‡•á‡§ü‡§Æ‡•á‡§Ç‡§ü</h5>
                    <table class="table table-bordered">
                        <tr><td>‡§ï‡•Å‡§≤ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§∞‡§æ‡§ú‡§∏‡•ç‡§µ (Total Sales Revenue - Excl. GST)</td><td id="report-total-sales-rev" class="text-end">${formatCurrency(AppState.stats.totalSalesRevenue || 0)}</td></tr>
                        <tr><td>‡§ï‡•Å‡§≤ GST (Liability)</td><td id="report-total-gst" class="text-end">${formatCurrency(AppState.stats.totalTaxCollected || 0)}</td></tr>
                        <tr><td>‡§¨‡•á‡§ö‡•á ‡§ó‡§è ‡§Æ‡§æ‡§≤ ‡§ï‡•Ä ‡§≤‡§æ‡§ó‡§§ (COGS)</td><td id="report-total-cogs" class="text-end text-danger">- ${formatCurrency(AppState.stats.totalCOGS || 0)}</td></tr>
                        <tr class="table-info"><th>‡§∏‡§ï‡§≤ ‡§≤‡§æ‡§≠ (Gross Profit)</th><th id="report-gross-profit" class="text-end">${formatCurrency(AppState.stats.grossProfit || 0)}</th></tr>
                        <tr><td>‡§Ö‡§®‡•ç‡§Ø ‡§ñ‡§∞‡•ç‡§ö (Other Expenses)</td><td class="text-end text-danger">- ‚Çπ0.00</td></tr>
                        <tr class="table-success"><th>‡§∂‡•Å‡§¶‡•ç‡§ß ‡§≤‡§æ‡§≠ (Net Profit)</th><th id="report-net-profit" class="text-end">${formatCurrency(AppState.stats.grossProfit || 0)}</th></tr>
                    </table>
                </div></div>
            </div>
            <div class="col-lg-6">
                <div class="card"><div class="card-body">
                    <h5 class="card-title mb-4">üí∞ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§∂‡•Ä‡§ü (‡§∏‡§∞‡§≤)</h5>
                    <div class="row">
                        <div class="col-6">
                            <h6>Assets (‡§∏‡§Ç‡§™‡§§‡•ç‡§§‡§ø)</h6>
                            <table class="table table-sm table-borderless">
                                <tr><td>‡§∏‡•ç‡§ü‡•â‡§ï ‡§ï‡§æ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø (Inventory)</td><td id="report-stock-value" class="text-end">${formatCurrency(AppState.stats.stockValue || 0)}</td></tr>
                                <tr><td>‡§¨‡•à‡§Ç‡§ï/‡§ï‡•à‡§∂ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ (Net Cash)</td><td class="text-end">‚Çπ0.00</td></tr>
                                <tr class="table-light"><th>‡§ï‡•Å‡§≤ ‡§∏‡§Ç‡§™‡§§‡•ç‡§§‡§ø</th><th id="report-total-assets" class="text-end">${formatCurrency(AppState.stats.stockValue || 0)}</th></tr>
                            </table>
                        </div>
                        <div class="col-6">
                            <h6>Liabilities & Equity (‡§¶‡•á‡§®‡§¶‡§æ‡§∞‡§ø‡§Ø‡§æ‡§Ç ‡§î‡§∞ ‡§™‡•Ç‡§Ç‡§ú‡•Ä)</h6>
                            <table class="table table-sm table-borderless">
                                <tr><td>GST Payables</td><td id="report-gst-payable" class="text-end">${formatCurrency(AppState.stats.totalTaxCollected || 0)}</td></tr>
                                <tr><td>‡§™‡•ç‡§∞‡§æ‡§∞‡§Ç‡§≠‡§ø‡§ï ‡§™‡•Ç‡§Ç‡§ú‡•Ä (Owner's Equity)</td><td class="text-end">‚Çπ0.00</td></tr>
                                <tr><td>‡§∂‡•Å‡§¶‡•ç‡§ß ‡§≤‡§æ‡§≠ (Retained Earnings)</td><td class="text-end">${formatCurrency(AppState.stats.grossProfit || 0)}</td></tr>
                            </table>
                        </div>
                    </div>
                </div></div>
            </div>
        </div>`;

    const getCashFlowHTML = () => `
        <div class="card"><div class="card-body">
            <h5 class="card-title mb-4">üíµ ‡§ï‡•à‡§∂/‡§¨‡•à‡§Ç‡§ï ‡§´‡•ç‡§≤‡•ã (‡§™‡•à‡§∏‡•á ‡§ï‡§æ ‡§Ü‡§®‡§æ-‡§ú‡§æ‡§®‡§æ)</h5>
            <div class="alert alert-warning">‡§Ø‡§π ‡§´‡•Ä‡§ö‡§∞ ‡§á‡§∏ ‡§∏‡§Ç‡§∏‡•ç‡§ï‡§∞‡§£ ‡§Æ‡•á‡§Ç ‡§ï‡•á‡§µ‡§≤ ‡§´‡•ç‡§∞‡§Ç‡§ü-‡§è‡§Ç‡§° ‡§™‡§∞ ‡§π‡•à‡•§ ‡§™‡•à‡§∏‡•á ‡§ï‡•á ‡§Ü‡§®‡•á-‡§ú‡§æ‡§®‡•á ‡§ï‡§æ ‡§∏‡§ü‡•Ä‡§ï ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§∞‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§Ö‡§≤‡§ó 'Transactions' ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§ü‡•á‡§¨‡§≤ ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•ã‡§ó‡•Ä‡•§</div>
            <div class="row g-3">
                <div class="col-md-6">
                    <h6>‡§™‡•à‡§∏‡•á ‡§ï‡§æ ‡§Ü‡§®‡§æ (Inflow)</h6>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between"><span><i class="fas fa-arrow-down text-success me-2"></i>‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§∏‡•á ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§∞‡§æ‡§∂‡§ø</span><span class="text-success">${formatCurrency(AppState.stats.totalRevenue || 0)}</span></li>
                        <li class="list-group-item d-flex justify-content-between"><span><i class="fas fa-arrow-down text-success me-2"></i>‡§™‡•Ç‡§Ç‡§ú‡•Ä ‡§®‡§ø‡§µ‡•á‡§∂</span><span>‚Çπ0.00</span></li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>‡§™‡•à‡§∏‡•á ‡§ï‡§æ ‡§ú‡§æ‡§®‡§æ (Outflow)</h6>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between"><span><i class="fas fa-arrow-up text-danger me-2"></i>‡§Æ‡§æ‡§≤ ‡§ï‡•Ä ‡§ñ‡§∞‡•Ä‡§¶ ‡§™‡§∞ ‡§ñ‡§∞‡•ç‡§ö (COGS)</span><span class="text-danger">${formatCurrency(AppState.stats.totalCOGS || 0)}</span></li>
                        <li class="list-group-item d-flex justify-content-between"><span><i class="fas fa-arrow-up text-danger me-2"></i>‡§Ö‡§®‡•ç‡§Ø ‡§ñ‡§∞‡•ç‡§ö (‡§ï‡§ø‡§∞‡§æ‡§Ø‡§æ, ‡§µ‡•á‡§§‡§®)</span><span>‚Çπ0.00</span></li>
                    </ul>
                </div>
            </div>
        </div></div>`;

    // --- DASHBOARD LOGIC (No Chart Data for now) ---
    const renderDashboard = () => {
        // Stats are loaded via loadDashboardStats()
        document.getElementById('dash-total-revenue').innerText = formatCurrency(AppState.stats.totalRevenue || 0);
        document.getElementById('dash-stock-value').innerText = formatCurrency(AppState.stats.stockValue || 0);
        document.getElementById('dash-total-products').innerText = AppState.stats.totalProducts || 0;
        // renderSalesChart(); // Removed chart logic for simplicity as historical sales data is not available on demand
    };
    
    // --- INVOICE LOGIC (ENHANCED) ---
    let invoiceItems = [];
    const initializeInvoice = () => {
        // Load settings into fields
        ['shopName', 'shopContact', 'shopAddress', 'shopGstin'].forEach(id => {
            document.getElementById(id).value = AppState.settings[id];
        });

        // Attach listeners
        ['shopName', 'shopContact', 'shopAddress', 'shopGstin', 'customerName', 'customerContact', 'customerAddress'].forEach(id => {
            document.getElementById(id).addEventListener('keyup', updateInvoicePreview);
        });
        document.getElementById('qrUpload').addEventListener('change', handleQrUpload);
        document.getElementById('add-item-row-btn').addEventListener('click', addInvoiceItemRow);
        document.getElementById('download-pdf-btn').addEventListener('click', downloadInvoicePDF);
        document.getElementById('print-invoice-btn').addEventListener('click', () => window.print());
        document.getElementById('clear-bill-btn').addEventListener('click', clearBill);
        document.getElementById('record-sale-btn').addEventListener('click', recordSale); // New button

        // Customer auto-fill on name selection
        document.getElementById('customerName').addEventListener('input', (e) => {
             const selectedCustomer = AppState.customers.find(c => c.name === e.target.value);
             if (selectedCustomer) {
                 document.getElementById('customerContact').value = selectedCustomer.phone;
                 document.getElementById('customerAddress').value = selectedCustomer.address;
             }
             updateInvoicePreview();
        });
        
        // Initial render
        addInvoiceItemRow();
        updateInvoicePreview();
    };

    const handleQrUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => { 
                AppState.settings.qrCodeImage = e.target.result; 
                saveLocalData('settings', AppState.settings);
                updateInvoicePreview(); 
            };
            reader.readAsDataURL(file);
        }
    };
    
    const addInvoiceItemRow = () => {
        const container = document.getElementById('items-container');
        const row = document.createElement('div');
        row.className = 'row g-2 mb-2 item-row';
        row.innerHTML = `
            <div class="col-5"><input type="text" class="form-control item-name" placeholder="‡§Ü‡§á‡§ü‡§Æ ‡§ï‡§æ ‡§®‡§æ‡§Æ" list="stock-datalist"></div>
            <div class="col-2"><input type="number" class="form-control item-qty" placeholder="‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ" value="1" min="1"></div>
            <div class="col-3"><input type="number" class="form-control item-price" placeholder="‡§¶‡§∞" step="0.01"></div>
            <div class="col-2"><button class="btn btn-sm btn-danger remove-item-btn">X</button></div>
            <datalist id="stock-datalist">${AppState.stock.map(s => `<option value="${s.name}"></option>`).join('')}</datalist>
        `;
        container.appendChild(row);
        row.querySelector('.remove-item-btn').addEventListener('click', () => { row.remove(); updateInvoicePreview(); });
        row.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', (e) => {
                // Auto-fill price and track stock ID/purchase price
                if (e.target.classList.contains('item-name')) {
                    const selectedStock = AppState.stock.find(s => s.name === e.target.value);
                    if (selectedStock) {
                        row.querySelector('.item-price').value = selectedStock.salePrice;
                        // Attach data attributes for tracking
                        row.setAttribute('data-stock-id', selectedStock.id);
                        row.setAttribute('data-purchase-price', selectedStock.purchasePrice);
                    } else {
                        row.removeAttribute('data-stock-id');
                        row.removeAttribute('data-purchase-price');
                    }
                }
                updateInvoicePreview();
            });
        });
        updateInvoicePreview();
    };

    const updateInvoicePreview = () => {
        const preview = document.getElementById('invoice-preview');
        // Save settings from fields
        AppState.settings.shopName = document.getElementById('shopName').value;
        AppState.settings.shopContact = document.getElementById('shopContact').value;
        AppState.settings.shopAddress = document.getElementById('shopAddress').value;
        AppState.settings.shopGstin = document.getElementById('shopGstin').value;
        saveLocalData('settings', AppState.settings);

        const customerName = document.getElementById('customerName').value || '‡§ó‡•ç‡§∞‡§æ‡§π‡§ï';
        
        invoiceItems = [];
        let subTotal = 0, totalGst = 0, totalCOGS = 0;
        
        document.querySelectorAll('.item-row').forEach(row => {
            const name = row.querySelector('.item-name').value;
            const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
            const price = parseFloat(row.querySelector('.item-price').value) || 0;
            const stockId = row.getAttribute('data-stock-id');
            const purchasePrice = parseFloat(row.getAttribute('data-purchase-price')) || 0;

            if (name && qty > 0 && price > 0) {
                const itemTotal = qty * price;
                const gstAmount = itemTotal * GST_RATE;
                const totalWithGst = itemTotal + gstAmount;

                const itemData = { 
                    id: stockId, // Required for stock update
                    name, 
                    qty, 
                    price, 
                    total: itemTotal, 
                    gst: gstAmount,
                    totalWithGst: totalWithGst,
                    purchasePrice: purchasePrice // Required for COGS calculation
                };
                invoiceItems.push(itemData);
                subTotal += itemTotal;
                totalGst += gstAmount;
                totalCOGS += qty * purchasePrice;
            }
        });

        const grandTotal = subTotal + totalGst;
        const invoiceNumber = `INV-${Date.now().toString().slice(-6)}`;

        let itemsHtml = invoiceItems.map((item, index) => `
            <tr>
                <td>${index + 1}. ${item.name}</td>
                <td>${item.qty}</td>
                <td>${formatCurrency(item.price)}</td>
                <td>${formatCurrency(item.total)}</td>
                <td>${formatCurrency(item.gst)}</td>
                <td>${formatCurrency(item.totalWithGst)}</td>
            </tr>`).join('');
        
        preview.innerHTML = `
            <div class="invoice-header">
                <div class="shop-details">
                    <h3>${AppState.settings.shopName}</h3>
                    <p>${AppState.settings.shopAddress}<br>‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï: ${AppState.settings.shopContact}<br>GSTIN: ${AppState.settings.shopGstin}</p>
                </div>
                <div>${AppState.settings.qrCodeImage ? `<img src="${AppState.settings.qrCodeImage}" alt="QR Code" style="max-width:100px;">` : ''}</div>
            </div>
            <h4 class="text-center bg-light p-2 mb-3">TAX INVOICE</h4>
            <div class="row customer-details mb-3">
                <div class="col-6"><strong>Bill To:</strong><br>${customerName}<br>${document.getElementById('customerAddress').value}<br>‡§´‡•ã‡§®: ${document.getElementById('customerContact').value}</div>
                <div class="col-6 text-end"><strong>Invoice No:</strong> ${invoiceNumber}<br><strong>Date:</strong> ${new Date().toLocaleDateString('hi-IN')}</div>
            </div>
            <table class="table invoice-table table-bordered table-sm">
                <thead><tr><th>#</th><th style="width:25%;">‡§Ü‡§á‡§ü‡§Æ</th><th>‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ</th><th>‡§¶‡§∞ (Excl. GST)</th><th>‡§ï‡•Å‡§≤ (Excl. GST)</th><th>GST (${GST_RATE * 100}%)</th><th>Grand Total</th></tr></thead>
                <tbody>${itemsHtml || '<tr><td colspan="7" class="text-center">‡§ï‡•ã‡§à ‡§Ü‡§á‡§ü‡§Æ ‡§®‡§π‡•Ä‡§Ç</td></tr>'}</tbody>
            </table>
            <div class="invoice-footer d-flex justify-content-end mt-4">
                <table class="table totals-table w-50 table-sm table-borderless">
                    <tr><th>Sub Total (Excl. GST):</th><td class="text-end">${formatCurrency(subTotal)}</td></tr>
                    <tr><th>Total GST:</th><td class="text-end">${formatCurrency(totalGst)}</td></tr>
                    <tr class="table-primary"><th><strong>Grand Total:</strong></th><td class="text-end"><strong>${formatCurrency(grandTotal)}</strong></td></tr>
                </table>
            </div>
            <div class="mt-4 text-center border-top pt-2"><small>‡§Ø‡§π ‡§è‡§ï ‡§ï‡§Ç‡§™‡•ç‡§Ø‡•Ç‡§ü‡§∞ ‡§ú‡§®‡§ø‡§§ ‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§π‡•à‡•§</small></div>
            `;
            
        // Save current totals for sale recording
        preview.setAttribute('data-subtotal', subTotal.toFixed(2));
        preview.setAttribute('data-total-gst', totalGst.toFixed(2));
        preview.setAttribute('data-grand-total', grandTotal.toFixed(2));
        preview.setAttribute('data-total-cogs', totalCOGS.toFixed(2));
        preview.setAttribute('data-invoice-number', invoiceNumber);
    };

    const recordSale = async () => {
        if (!AppState.isLicensed) return DOM.licenseModal.show();
        if (invoiceItems.length === 0) {
            showToast("‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§Ü‡§á‡§ü‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", "error");
            return;
        }

        if (invoiceItems.some(item => !item.id)) {
            showToast("‡§ï‡•Å‡§õ ‡§Ü‡§á‡§ü‡§Æ ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡§Ç‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§â‡§®‡•ç‡§π‡•á‡§Ç ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç‡•§", "error");
            return;
        }
        
        const preview = document.getElementById('invoice-preview');
        const subTotal = parseFloat(preview.getAttribute('data-subtotal'));
        const totalGst = parseFloat(preview.getAttribute('data-total-gst'));
        const totalCOGS = parseFloat(preview.getAttribute('data-total-cogs'));
        const invoiceNumber = preview.getAttribute('data-invoice-number');

        const saleData = {
            invoice_number: invoiceNumber,
            total_amount: subTotal, // Revenue before tax
            total_tax: totalGst,
            total_cogs: totalCOGS,
            items: invoiceItems.map(item => ({
                id: item.id,
                quantity: item.qty,
                sale_price: item.price,
                purchase_price: item.purchasePrice
            }))
        };
        
        const data = await fetchAPI('/sales', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(saleData)
        });

        if (data && data.success) {
            showToast("‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ï‡•Ä ‡§ó‡§à! ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§", "success");
            clearBill(false); // Clear the form but no confirmation
            await loadDashboardStats(); // Refresh stats after sale
        } else {
            showToast(data.message || "‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§", "error");
        }
    };

    const downloadInvoicePDF = () => {
        const invoiceElement = document.getElementById('invoice-preview');
        html2canvas(invoiceElement, { scale: 2 }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const imgHeight = (canvas.height * pdfWidth) / canvas.width;
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, imgHeight);
            pdf.save(`invoice-${Date.now()}.pdf`);
        });
    };

    const clearBill = (confirm = true) => {
        if (!confirm || window.confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§¨‡§ø‡§≤ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")) {
            invoiceItems = [];
            document.getElementById('items-container').innerHTML = '';
            document.getElementById('customerName').value = '';
            document.getElementById('customerContact').value = '';
            document.getElementById('customerAddress').value = '';
            addInvoiceItemRow();
            updateInvoicePreview();
        }
    };

    // --- STOCK LOGIC (API INTEGRATION) ---
    const renderStockTable = () => {
        const tbody = document.getElementById('stock-table-body');
        tbody.innerHTML = AppState.stock.map(item => `
            <tr>
                <td>${item.id}</td><td>${item.sku}</td><td>${item.name}</td><td>${formatCurrency(item.purchasePrice)}</td><td>${formatCurrency(item.salePrice)}</td>
                <td class="fw-bold ${item.quantity <= 10 ? 'text-danger' : ''}">${item.quantity}</td>
                <td><button class="btn btn-sm btn-danger" onclick="deleteStockItem('${item.id}')"><i class="fas fa-trash"></i></button></td>
            </tr>`).join('');
    };

    const openStockModal = (id = null) => {
        const form = document.getElementById('stock-form');
        form.reset();
        document.getElementById('stock-id').value = '';
        if (id) {
            // Edit logic here (not implemented for simplicity)
        }
        document.getElementById('save-stock-btn').onclick = saveStockItem;
        DOM.stockModal.show();
    };

    const saveStockItem = async () => {
        const name = document.getElementById('stock-item-name').value;
        const sku = document.getElementById('stock-sku').value;
        const quantity = parseFloat(document.getElementById('stock-quantity').value);
        const purchase_price = parseFloat(document.getElementById('stock-purchase-price').value);
        const sale_price = parseFloat(document.getElementById('stock-sale-price').value);
        
        if(!name || !quantity || !purchase_price || !sale_price) {
            alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§≠‡•Ä * ‡§ö‡§ø‡§π‡•ç‡§®‡§ø‡§§ ‡§´‡§º‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç‡•§"); return;
        }

        const data = await fetchAPI('/stock', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, sku, purchase_price, sale_price, quantity })
        });

        if (data) {
            showToast("‡§∏‡•ç‡§ü‡•â‡§ï ‡§Ü‡§á‡§ü‡§Æ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ‡•§", "success");
            await loadStock();
            renderStockTable();
            DOM.stockModal.hide();
        }
    };

    window.deleteStockItem = (id) => { // Global function for inline onclick
        // Deletion logic would require a DELETE API endpoint (Not implemented in server.js)
        showToast("‡§°‡§ø‡§≤‡•Ä‡§ü ‡§´‡§º‡•Ä‡§ö‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§è‡§Ç‡§°‡§™‡•â‡§á‡§Ç‡§ü ‡§≤‡§æ‡§ó‡•Ç ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", "info");
    };

    // --- CRM LOGIC (Local Storage) ---
    const renderCrmTable = () => {
        const tbody = document.getElementById('crm-table-body');
        tbody.innerHTML = AppState.customers.map(c => `
            <tr><td>${c.name}</td><td>${c.phone}</td><td>${c.address}</td>
            <td><button class="btn btn-sm btn-danger" onclick="deleteCrmItem('${c.id}')"><i class="fas fa-trash"></i></button></td></tr>`).join('');
    };

    const openCrmModal = () => {
        document.getElementById('crm-form').reset();
        document.getElementById('save-crm-btn').onclick = saveCrmItem;
        DOM.crmModal.show();
    };

    const saveCrmItem = () => {
        const newItem = {
            id: 'C' + Date.now(),
            name: document.getElementById('crm-name').value,
            phone: document.getElementById('crm-phone').value,
            address: document.getElementById('crm-address').value,
        };
        if(!newItem.name) { alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§≠‡§∞‡•á‡§Ç‡•§"); return; }
        AppState.customers.push(newItem);
        saveLocalData('customers', AppState.customers);
        renderCrmTable();
        DOM.crmModal.hide();
    };
    
    window.deleteCrmItem = (id) => {
        if(confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")){
            AppState.customers = AppState.customers.filter(c => c.id !== id);
            saveLocalData('customers', AppState.customers);
            renderCrmTable();
        }
    };
    
    // --- REPORTS LOGIC (API Data) ---
    const renderReports = () => {
        // Data is fetched and stored in AppState.stats by setupNavigation
        const { totalSalesRevenue, totalTaxCollected, totalCOGS, grossProfit, stockValue } = AppState.stats;
        
        // P&L
        document.getElementById('report-total-sales-rev').innerText = formatCurrency(totalSalesRevenue || 0);
        document.getElementById('report-total-gst').innerText = formatCurrency(totalTaxCollected || 0);
        document.getElementById('report-total-cogs').innerText = `- ${formatCurrency(totalCOGS || 0)}`;
        document.getElementById('report-gross-profit').innerText = formatCurrency(grossProfit || 0);
        document.getElementById('report-net-profit').innerText = formatCurrency(grossProfit || 0); // Net Profit = Gross Profit for now

        // Balance Sheet
        document.getElementById('report-stock-value').innerText = formatCurrency(stockValue || 0);
        document.getElementById('report-total-assets').innerText = formatCurrency(stockValue || 0);
        document.getElementById('report-gst-payable').innerText = formatCurrency(totalTaxCollected || 0);
    };

    // --- CASH FLOW LOGIC ---
    const renderCashFlow = () => {
        // Rendered by template
    };

    // --- INITIAL APP LOAD ---
    setupLicenseCheck(); // Start with license check
});
</script>

</body>
</html>
