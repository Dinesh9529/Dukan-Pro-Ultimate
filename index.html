<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dukan Pro - Ultimate Business Suite</title>
    <link rel="icon" type="image/png" href="https://img.icons8.com/color/48/shop.png">
    <link rel="manifest" href="manifest.json">


   

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
   



    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ====================================================================
         === DUKAN PRO - MODERN AESTHETIC REDESIGN (INDIGO/CYAN) ===
         ====================================================================
        */
    
        /* --- 1. ‡§®‡§è ‡§î‡§∞ ‡§∏‡•Å‡§Ç‡§¶‡§∞ ‡§∞‡§Ç‡§ó‡•ã‡§Ç ‡§ï‡•ã ‡§°‡§ø‡§´‡§æ‡§á‡§® ‡§ï‡§∞‡§®‡§æ --- */
        :root {
            --dp-bg-light: #f4f7f6;        /* ‡§π‡§≤‡•ç‡§ï‡§æ ‡§ó‡•ç‡§∞‡•á ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° */
            --dp-bg-white: #ffffff;
            --dp-sidebar-bg: #111d4a;    /* ‡§°‡•Ä‡§™ ‡§á‡§Ç‡§°‡§ø‡§ó‡•ã (‡§ó‡§π‡§∞‡§æ ‡§®‡•Ä‡§≤‡§æ) */
            --dp-sidebar-text: #a0aed0;   /* ‡§π‡§≤‡•ç‡§ï‡§æ ‡§®‡•Ä‡§≤‡§æ/‡§ó‡•ç‡§∞‡•á ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü */
            --dp-sidebar-text-hover: #ffffff;
            --dp-sidebar-active-bg: #1a2b6d;  /* ‡§è‡§ï‡•ç‡§ü‡§ø‡§µ ‡§≤‡§ø‡§Ç‡§ï ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ó‡§π‡§∞‡§æ ‡§®‡•Ä‡§≤‡§æ */
            --dp-primary: #00b4d8;       /* ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§∏‡§æ‡§Ø‡§® (Cyan) ‡§∞‡§Ç‡§ó */
            --dp-secondary: #03045e;     /* ‡§ó‡§π‡§∞‡§æ ‡§®‡•Ä‡§≤‡§æ (Gradient ‡§ï‡•á ‡§≤‡§ø‡§è) */
            --dp-text-dark: #1A202C;
            --dp-text-light: #4A5568;
            --dp-border: #E2E8F0;
            --dp-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); /* ‡§∏‡•â‡§´‡•ç‡§ü ‡§∂‡•à‡§°‡•ã */
            
            /* ‡§π‡§Æ‡§æ‡§∞‡§æ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø '‡§∏‡•Å‡§Ç‡§¶‡§∞' ‡§ó‡•ç‡§∞‡•á‡§°‡§ø‡§è‡§Ç‡§ü */
            --dp-gradient: linear-gradient(135deg, var(--dp-primary) 0%, var(--dp-secondary) 100%);
        }
    
        /* --- 2. ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§¨‡•â‡§°‡•Ä ‡§î‡§∞ ‡§≤‡•á‡§Ü‡§â‡§ü --- */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--dp-bg-light); /* ‡§®‡§Ø‡§æ ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° */
            color: var(--dp-text-dark); /* ‡§®‡§Ø‡§æ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡§≤‡§∞ */
        }
    
        .main-content {
            margin-left: 280px;
            padding: 30px; /* ‡§•‡•ã‡§°‡§º‡•Ä ‡§î‡§∞ ‡§ú‡§ó‡§π */
            transition: margin-left 0.3s ease;
        }
    
        /* App is hidden until licensed */
        .main-content.locked, .sidebar.locked, .navbar-toggler.locked {
                display: none;
        }
    
        /* --- 3. ‡§∏‡§æ‡§á‡§°‡§¨‡§æ‡§∞ (‡§Ü‡§™‡§ï‡§æ ‡§´‡§ø‡§ï‡•ç‡§∏‡•ç‡§° ‡§∏‡•ç‡§ü‡•ç‡§∞‡§ï‡•ç‡§ö‡§∞) --- */
        .sidebar {
            width: 280px;
            background-color: var(--dp-sidebar-bg); /* ‡§®‡§Ø‡§æ ‡§á‡§Ç‡§°‡§ø‡§ó‡•ã ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° */
            color: var(--dp-sidebar-text-hover);
            height: 100vh;
            position: fixed; /* ‚≠êÔ∏è ‡§Ø‡§π ‡§Ü‡§™‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à, ‡§Ø‡§π ‡§µ‡•à‡§∏‡•Ä ‡§π‡•Ä ‡§π‡•à */
            top: 0;
            left: 0;
            padding-top: 20px;
            transition: transform 0.3s ease;
            z-index: 1050;
            border-right: 1px solid var(--dp-border);
            overflow-y: auto; /* ‡§∏‡•ç‡§ï‡•ç‡§∞‡•â‡§≤ ‡§ï‡•á ‡§≤‡§ø‡§è */
            overflow-x: hidden;
        }
        
        /* ‡§∏‡§æ‡§á‡§°‡§¨‡§æ‡§∞ ‡§Æ‡•á‡§Ç "Dukan Pro" ‡§π‡•á‡§°‡§ø‡§Ç‡§ó */
        .sidebar h3 {
            margin-bottom: 2rem;
            text-align: center;
            font-weight: 700;
            color: #fff;
            letter-spacing: 1px;
        }
    
        /* ‡§∏‡§æ‡§á‡§°‡§¨‡§æ‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§Ç‡§ï‡•ç‡§∏ (‡§®‡§Ø‡§æ ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤) */
        .sidebar .nav-link {
            color: var(--dp-sidebar-text);
            padding: 15px 25px;
            border-left: 5px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            /* ‡§®‡§Ø‡§æ: ‡§¶‡§æ‡§à‡§Ç ‡§ì‡§∞ ‡§∏‡•á ‡§ó‡•ã‡§≤ ‡§á‡§´‡§º‡•á‡§ï‡•ç‡§ü */
            border-radius: 0 30px 30px 0;
            margin-right: 15px; 
            margin-bottom: 5px; /* ‡§≤‡§ø‡§Ç‡§ï‡•ç‡§∏ ‡§ï‡•á ‡§¨‡•Ä‡§ö ‡§•‡•ã‡§°‡§º‡•Ä ‡§ú‡§ó‡§π */
        }
    
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: var(--dp-sidebar-text-hover); /* ‡§∏‡§´‡§º‡•á‡§¶ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü */
            background-color: var(--dp-sidebar-active-bg); /* ‡§•‡•ã‡§°‡§º‡§æ ‡§π‡§≤‡•ç‡§ï‡§æ ‡§®‡•Ä‡§≤‡§æ */
            border-left-color: var(--dp-primary); /* ‡§∏‡§æ‡§Ø‡§® ‡§è‡§ï‡•ç‡§∏‡•á‡§Ç‡§ü */
            /* ‡§ñ‡•Ç‡§¨‡§∏‡•Ç‡§∞‡§§ 'Glow' ‡§á‡§´‡§º‡•á‡§ï‡•ç‡§ü */
            box-shadow: 0 4px 10px rgba(0, 180, 216, 0.2); 
        }
    
        .sidebar .nav-link i {
            margin-right: 12px;
            width: 20px; /* ‡§Ü‡§á‡§ï‡§®‡•ç‡§∏ ‡§ï‡•ã ‡§è‡§ï ‡§≤‡§æ‡§á‡§® ‡§Æ‡•á‡§Ç ‡§∞‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è */
            text-align: center;
        }
        
        /* ‡§®‡•Ä‡§ö‡•á ‡§ï‡§æ ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§á‡§®‡•ç‡§´‡•ã ‡§¨‡•â‡§ï‡•ç‡§∏ */
        #user-info {
            background-color: var(--dp-sidebar-active-bg) !important;
        }
        
    
        /* --- 4. ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü (‡§ï‡§æ‡§∞‡•ç‡§°‡•ç‡§∏, ‡§¨‡§ü‡§®, ‡§ü‡•á‡§¨‡§≤‡•ç‡§∏) --- */
    
        /* ‡§∏‡•á‡§ï‡•ç‡§∂‡§® ‡§ï‡•Ä ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§π‡•á‡§°‡§ø‡§Ç‡§ó (‡§ú‡•à‡§∏‡•á "‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°") */
        .section > h2 {
            font-weight: 700;
            color: var(--dp-text-dark);
            margin-bottom: 2rem !important;
            /* ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§™‡§∞ ‡§ó‡•ç‡§∞‡•á‡§°‡§ø‡§è‡§Ç‡§ü */
            background-image: var(--dp-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            display: inline-block;
        }
    
        /* ‡§ï‡§æ‡§∞‡•ç‡§°‡•ç‡§∏ ‡§ï‡§æ ‡§®‡§Ø‡§æ ‡§°‡§ø‡§ú‡§º‡§æ‡§á‡§® */
        .card {
            border-radius: 16px; /* ‡§ú‡§º‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§ó‡•ã‡§≤ ‡§ï‡•ã‡§®‡•á */
            box-shadow: var(--dp-shadow); /* ‡§®‡§Ø‡§æ ‡§∏‡•â‡§´‡•ç‡§ü ‡§∂‡•à‡§°‡•ã */
            border: none;
            overflow: hidden; /* ‡§π‡•á‡§°‡§∞ ‡§ï‡•ã ‡§∏‡§π‡•Ä ‡§∏‡•á ‡§∞‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è */
            margin-bottom: 1.5rem; /* ‡§ï‡§æ‡§∞‡•ç‡§°‡•ç‡§∏ ‡§ï‡•á ‡§¨‡•Ä‡§ö ‡§ú‡§ó‡§π */
        }
    
        /* ‡§ï‡§æ‡§∞‡•ç‡§° ‡§ï‡§æ ‡§π‡•á‡§°‡§∞ (‡§Ø‡§π ‡§∏‡§¨‡§∏‡•á ‡§¨‡§°‡§º‡§æ ‡§¨‡§¶‡§≤‡§æ‡§µ ‡§π‡•à) */
        .card-header {
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            background: var(--dp-gradient); /* ‡§π‡§Æ‡§æ‡§∞‡§æ ‡§∏‡•Å‡§Ç‡§¶‡§∞ ‡§ó‡•ç‡§∞‡•á‡§°‡§ø‡§è‡§Ç‡§ü */
            color: white;
            padding: 20px 25px;
            font-weight: 600;
            font-size: 1.1rem;
            border-bottom: none;
        }
        
        /* ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§ï‡•á ‡§õ‡•ã‡§ü‡•á ‡§ï‡§æ‡§∞‡•ç‡§°‡•ç‡§∏ */
        .dashboard-card {
            transition: transform 0.2s, box-shadow 0.2s;
            background: var(--dp-bg-white);
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); /* ‡§π‡•â‡§µ‡§∞ ‡§™‡§∞ ‡§ú‡§º‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§∂‡•à‡§°‡•ã */
        }
        /* ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§ï‡•á ‡§Ü‡§á‡§ï‡§®‡•ç‡§∏ ‡§™‡§∞ ‡§ó‡•ç‡§∞‡•á‡§°‡§ø‡§è‡§Ç‡§ü */
        .dashboard-card i {
            background: var(--dp-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            font-size: 2.5rem; /* ‡§•‡•ã‡§°‡§º‡•á ‡§¨‡§°‡§º‡•á ‡§Ü‡§á‡§ï‡§®‡•ç‡§∏ */
        }
    
        /* ‡§´‡•â‡§∞‡•ç‡§Æ‡•ç‡§∏ ‡§î‡§∞ ‡§¨‡§ü‡§®‡•ç‡§∏ */
        .form-control, .form-select, .btn {
            border-radius: 8px;
            padding: 10px 15px;
            border: 1px solid var(--dp-border);
            transition: all 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--dp-primary);
            box-shadow: 0 0 0 3px rgba(0, 180, 216, 0.15);
        }
    
        .btn {
            font-weight: 600;
            padding: 10px 20px;
        }
        
        /* ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§¨‡§ü‡§® (‡§®‡§Ø‡§æ ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤) */
        .btn-primary {
            background-color: var(--dp-primary);
            border-color: var(--dp-primary);
            color: #fff;
        }
        .btn-primary:hover {
            background-color: var(--dp-secondary);
            border-color: var(--dp-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 180, 216, 0.3);
        }
        
        /* ‡§Ö‡§®‡•ç‡§Ø ‡§¨‡§ü‡§® (‡§ú‡•à‡§∏‡•á 'Add') */
        .btn-success { background-color: #1abc9c; border-color: #1abc9c; }
        .btn-success:hover { background-color: #16a085; border-color: #16a085; }
        .btn-info { background-color: #3498db; border-color: #3498db; }
        .btn-info:hover { background-color: #2980b9; border-color: #2980b9; }
        .btn-warning { background-color: #f39c12; border-color: #f39c12; }
        .btn-warning:hover { background-color: #e67e22; border-color: #e67e22; }
    
        /* ‡§ü‡•á‡§¨‡§≤‡•ç‡§∏ */
        .table th {
            background-color: var(--dp-bg-light); /* ‡§π‡§≤‡•ç‡§ï‡§æ ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° */
            color: var(--dp-text-light); /* ‡§π‡§≤‡•ç‡§ï‡§æ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü */
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            border: none;
            padding: 15px;
        }
        .table-striped > tbody > tr:nth-of-type(odd) > * {
            --bs-table-bg-type: var(--dp-bg-light);
        }
        .table td {
            border-top: 1px solid var(--dp-border); /* ‡§π‡§≤‡•ç‡§ï‡•Ä ‡§¨‡•â‡§∞‡•ç‡§°‡§∞ */
            vertical-align: middle;
            padding: 15px;
            color: var(--dp-text-dark);
        }
        .table-hover tbody tr:hover {
            background-color: #eaf6f9; /* ‡§π‡§≤‡•ç‡§ï‡§æ ‡§∏‡§æ‡§Ø‡§® ‡§π‡•â‡§µ‡§∞ */
        }
    
        /* --- 5. ‡§¨‡§æ‡§ï‡•Ä ‡§ï‡•á ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤‡•ç‡§∏ (‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§Æ‡•å‡§ú‡•Ç‡§¶) --- */
        
        /* ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§è‡§°‡§ú‡§∏‡•ç‡§ü‡§Æ‡•á‡§Ç‡§ü (‡§™‡§π‡§≤‡•á ‡§ú‡•à‡§∏‡§æ) */
        @media (max-width: 991.98px) {
            .sidebar { transform: translateX(-280px); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .main-content.sidebar-open { margin-left: 280px; overflow-x: hidden; }
            .navbar-toggler { display: block !important; }
        }
        
        .navbar-toggler {
            position: fixed; top: 10px; left: 10px; z-index: 1060;
            display: none; background-color: var(--dp-sidebar-bg);
            border: 1px solid var(--dp-primary);
        }
        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='white' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }
        
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); display: flex;
            justify-content: center; align-items: center; z-index: 2000;
        }
        .hidden { display: none !important; }
    
        /* --- ‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§ú‡§®‡§∞‡•á‡§ü‡§∞ ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤‡•ç‡§∏ --- */
        #invoice-generator h5 { font-weight: 600; }
        #invoice-preview {
            background: white; padding: 25px; border: 1px solid var(--dp-border);
            min-height: 80vh; font-size: 14px; color: #333;
            border-radius: 16px; box-shadow: var(--dp-shadow);
        }
        .invoice-header {
            border-bottom: 2px solid var(--dp-primary);
            margin-bottom: 20px; padding-bottom: 15px;
        }
        .shop-details h3 { color: var(--dp-secondary); font-weight: 700; }
        .customer-details {
            border: 1px solid #eee; padding: 15px;
            margin-bottom: 20px; border-radius: 8px;
        }
        .invoice-table th { background-color: var(--dp-bg-light); }
        
        /* --- GST ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ü‡•à‡§¨‡•ç‡§∏ --- */
        .gst-report-tabs .nav-link {
            background-color: #f0f0f0; border: 1px solid var(--dp-border);
            color: var(--dp-text-light); font-weight: 600;
        }
        .gst-report-tabs .nav-link.active {
            background-color: var(--dp-bg-white);
            border-bottom: 1px solid var(--dp-bg-white);
            color: var(--dp-secondary); /* ‡§°‡§æ‡§∞‡•ç‡§ï ‡§¨‡•ç‡§≤‡•Ç ‡§è‡§ï‡•ç‡§ü‡§ø‡§µ */
            position: relative; top: 1px;
        }
        .gst-report-tab-content {
            background-color: var(--dp-bg-white);
            border: 1px solid var(--dp-border);
            padding: 1.5rem;
            border-radius: 0 8px 8px 8px;
        }
        
        /* --- ‡§Ö‡§®‡•ç‡§Ø ‡§∏‡§≠‡•Ä ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤‡•ç‡§∏ (‡§¨‡§æ‡§∞‡§ï‡•ã‡§°, ‡§ü‡§æ‡§á‡§Æ‡§∞, ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü) --- */
        /* (‡§Ø‡§π ‡§¨‡§æ‡§ï‡•Ä ‡§ï‡§æ CSS ‡§π‡•à ‡§ú‡§ø‡§∏‡•á ‡§¨‡§¶‡§≤‡§®‡•á ‡§ï‡•Ä ‡§ú‡§º‡§∞‡•Ç‡§∞‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à) */
    
        .section { display: none; }
        .section.active { display: block; }
        .text-shadow { text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); }
        #qr-preview img { max-width: 100px; max-height: 100px; border: 1px solid #ccc; padding: 3px; }
        .invoice-table { width: 100%; margin-bottom: 20px; border-collapse: collapse; }
        .invoice-table th, .invoice-table td { padding: 10px; text-align: right; border-bottom: 1px solid #dee2e6; }
        .invoice-table th:first-child, .invoice-table td:first-child { text-align: left; }
        .invoice-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 20px; }
        .totals-table { width: 50%; }
        .totals-table td { padding: 5px 10px; }
        .terms { font-size: 12px; color: #777; }
        .report-table { font-size: 0.9rem; }
        .report-table th { background-color: #f8f9fa; }
        .report-table td { padding: 0.5rem; }
        .report-table .fw-bold { border-top: 2px solid #333; }
        .report-print-area { display: none; }
        #barcode-scanner-input { position: fixed; top: -100px; left: -100px; opacity: 0; }
        #license-timer { font-size: 0.8rem; font-weight: 500; padding: 5px 10px; border-radius: 6px; }
        #license-timer.expiring-soon { background-color: #ffc107; color: #333; cursor: pointer; }
        #license-timer.expired { background-color: #dc3545; color: #fff; cursor: pointer; }
        #license-timer i { margin-right: 5px; }
        .json-viewer { background-color: #282c34; color: #abb2bf; padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto; font-family: 'Courier New', Courier, monospace; font-size: 0.9rem; white-space: pre; }
        @media print {
            body * { visibility: hidden; }
            .printable, .printable * { visibility: visible; }
          .report-print-header, .report-print-header * { visibility: visible; }
            .printable { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 15px; border: none; box-shadow: none; }
            .no-print { display: none; }
        }
        .sidebar::-webkit-scrollbar { width: 8px; }
        .sidebar::-webkit-scrollbar-track { background: #555; }
        .sidebar::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .sidebar::-webkit-scrollbar-thumb:hover { background: #aaa; }
        .gst-report-table { font-size: 0.85rem; margin-top: 15px; border-collapse: collapse; width: 100%; }
        .gst-report-table th, .gst-report-table td { border: 1px solid #dee2e6; padding: 8px 12px; text-align: right; }
        .gst-report-table th { background-color: #f8f9fa; text-align: center; font-weight: 600; vertical-align: middle; }
        .gst-report-table td:first-child { text-align: left; }
        .gst-report-table tfoot tr { font-weight: bold; background-color: #e9ecef; }
        .gst-report-table .group-header td { background-color: #f3f4f6; font-weight: bold; text-align: left; }
    
    
        /* ======================================================== */
        /* === üöÄ SAHI LOGIN AUR LANDING PAGE CSS (YAHAN SE SHURU) === */
        /* ======================================================== */
    
             
/* 1. ‡§Æ‡•â‡§≤ ‡§ï‡§æ ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° (Cache Busting Fix) */
/* 1. ‡§Æ‡•â‡§≤ ‡§ï‡§æ ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° (imgbb Online URL Fix) */
.auth-overlay {
    /*
     * üöÄüöÄüöÄ YEH HAI PERMANENT FIX üöÄüöÄüöÄ
     * Neeche diye gaye URL ko apne imgbb ke "Direct Link" se badal dein.
     */
    background: url(https://i.postimg.cc/1R76fKdh/shopkeeper-dukanpro.png) no-repeat center center fixed;
    
    background-size: cover;
    background-color: rgba(0, 0, 0, 0.45); /* ‡§°‡§æ‡§∞‡•ç‡§ï ‡§≤‡•á‡§Ø‡§∞ */
    background-blend-mode: multiply;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 20px;
}

/* 2. ‡§∏‡•á‡§Ç‡§ü‡§∞‡•ç‡§° ‡§∞‡•à‡§™‡§∞ (Wrapper) */
        .login-wrapper {
            width: 100%;
            max-width: 950px;
            
            grid-template-columns: 40% 60%; 
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            
            /* üöÄ ‡§≤‡•â‡§ó‡§ø‡§® ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§ï‡•ã ‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§õ‡§ø‡§™‡§æ‡§è‡§Å */
            display: none; 
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
    
        /* 2b. ‡§ú‡§¨ 'active' ‡§ï‡•ç‡§≤‡§æ‡§∏ ‡§ú‡•ã‡§°‡§º‡•Ä ‡§ú‡§æ‡§è ‡§§‡§¨ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å */
        .login-wrapper.active {
            display: grid; /* üöÄ ‡§Ø‡§π ‡§á‡§∏‡•á ‡§µ‡§æ‡§™‡§∏ ‡§¶‡§ø‡§ñ‡§æ‡§§‡§æ ‡§π‡•à */
            opacity: 1;
            transform: scale(1);
        }
    
        /* 3. ‡§è‡§°‡§µ‡§∞‡§ü‡§æ‡§á‡§ú‡§ø‡§Ç‡§ó ‡§∏‡§æ‡§á‡§°‡§¨‡§æ‡§∞ (Left Column) */
        .login-ad-sidebar {
            background: var(--dp-sidebar-bg, #111d4a); 
            color: #fff;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .login-ad-sidebar h3 {
            font-weight: 700;
            letter-spacing: 1px;
        }
        .login-ad-sidebar p {
            font-size: 1.1rem;
            color: var(--dp-sidebar-text, #a0aed0);
            border-bottom: 1px solid var(--dp-sidebar-active-bg, #1a2b6d);
            padding-bottom: 15px;
        }
        .login-ad-sidebar .ad-footer {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid var(--dp-sidebar-active-bg, #1a2b6d);
            color: var(--dp-sidebar-text, #a0aed0);
        }
    
        /* 4. ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§æ‡§∞‡•ç‡§° (Glass Effect) */
        .login-card-glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            padding: 30px 40px;
        }
        .login-card-glass h3 {
            color: var(--dp-text-dark, #1A202C);
        }
        .login-card-glass .nav-tabs {
            border-bottom: 2px solid var(--dp-border, #E2E8F0);
        }
        .login-card-glass .nav-link {
            color: var(--dp-text-light, #4A5568);
            font-weight: 600;
            padding: 10px 15px;
        }
        .login-card-glass .nav-link.active {
            background-color: rgba(255, 255, 255, 0.8);
            color: var(--dp-primary, #00b4d8);
            border: 2px solid var(--dp-border, #E2E8F0);
            border-bottom-color: transparent;
            border-radius: 8px 8px 0 0;
        }
    
        /* 5. ‡§è‡§®‡§ø‡§Æ‡•á‡§ü‡•á‡§° ‡§´‡•Ä‡§ö‡§∞‡•ç‡§∏ (Advertising Quotes) */
        .features-list {
            list-style: none;
            padding: 0;
            margin: 25px 0;
            height: 250px; /* ‡§è‡§®‡•Ä‡§Æ‡•á‡§∂‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ä‡§Ç‡§ö‡§æ‡§à */
            overflow: hidden;
            position: relative;
            font-size: 1.1rem; /* ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡§æ ‡§∏‡§æ‡§á‡•õ */
        }
        .features-list li {
            font-weight: 500;
            padding: 8px 0;
            position: absolute;
            width: 100%;
            opacity: 0;
            transform: translateY(30px);
            animation: slide-up-fade 18s linear infinite; /* 9 items * 2s = 18s */
            animation-delay: var(--delay);
        }
        .features-list li span {
            display: block; 
            font-size: 0.9rem; 
            color: var(--dp-sidebar-text, #a0aed0); 
            margin-top: 3px;
            font-weight: 400;
        }
    
        /* 9 ‡§Ü‡§á‡§ü‡§Æ‡•ç‡§∏ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§®‡•Ä‡§Æ‡•á‡§∂‡§® ‡§ü‡§æ‡§á‡§Æ‡§ø‡§Ç‡§ó */
        .features-list li:nth-child(1) { --delay: 0s; }
        .features-list li:nth-child(2) { --delay: 2s; }
        .features-list li:nth-child(3) { --delay: 4s; }
        .features-list li:nth-child(4) { --delay: 6s; }
        .features-list li:nth-child(5) { --delay: 8s; }
        .features-list li:nth-child(6) { --delay: 10s; }
        .features-list li:nth-child(7) { --delay: 12s; }
        .features-list li:nth-child(8) { --delay: 14s; }
        .features-list li:nth-child(9) { --delay: 16s; }
    
        /* ‡§∏‡§π‡•Ä ‡§è‡§®‡•Ä‡§Æ‡•á‡§∂‡§® ‡§ï‡•Ä-‡§´‡•ç‡§∞‡•á‡§Æ‡•ç‡§∏ */
        @keyframes slide-up-fade {
            /* ‡§π‡§∞ ‡§Ü‡§á‡§ü‡§Æ 18 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§ï‡•á ‡§≤‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§∏‡§ø‡§∞‡•ç‡§´ 2 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¶‡§ø‡§ñ‡•á‡§ó‡§æ */
            0%    { opacity: 0; transform: translateY(30px); }
            1.1%  { opacity: 1; transform: translateY(0); } /* 0.2s in */
            10%   { opacity: 1; transform: translateY(0); } /* 1.6s hold */
            11.1% { opacity: 0; transform: translateY(-15px); } /* 0.2s out */
            100%  { opacity: 0; }
        }
    
        /* 6. ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§ï‡•á ‡§≤‡§ø‡§è (‡§¨‡§π‡•Å‡§§ ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£) */
        @media (max-width: 800px) {
            .login-wrapper {
                grid-template-columns: 1fr;
                width: 95%;
                max-width: 450px;
                max-height: 90vh;
                overflow-y: auto;
            }
            .login-ad-sidebar {
                display: none; 
            }
            .login-card-glass {
                background: rgba(255, 255, 255, 0.98);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
        }
    
        /* 7. ‡§≤‡•à‡§Ç‡§°‡§ø‡§Ç‡§ó ‡§™‡•á‡§ú ‡§ï‡•á ‡§¨‡§ü‡§®‡•ç‡§∏ ‡§ï‡•ã ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤ ‡§ï‡§∞‡•á‡§Ç */
        .landing-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            padding: 20px;
        }
    
        /* 8. ‡§≤‡•à‡§Ç‡§°‡§ø‡§Ç‡§ó ‡§ü‡§æ‡§á‡§ü‡§≤ ‡§î‡§∞ ‡§∏‡§¨‡§ü‡§æ‡§á‡§ü‡§≤ */
        .landing-title {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .landing-subtitle {
            font-size: 1.4rem;
            opacity: 0.9;
            margin-bottom: 2.5rem;
        }
    
        /* 9. ‡§≤‡•à‡§Ç‡§°‡§ø‡§Ç‡§ó ‡§¨‡§ü‡§®‡•ç‡§∏ */
        .landing-btn {
            padding: 12px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }
        .landing-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        .landing-btn.btn-primary {
            background: var(--dp-primary, #00b4d8);
            border-color: var(--dp-primary, #00b4d8);
        }
        .landing-btn.btn-success {
            background: #1abc9c;
            border-color: #1abc9c;
        }
    
        /* 10. ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ü‡§æ‡§á‡§ü‡§≤‡•ç‡§∏ ‡§ï‡•ã ‡§õ‡•ã‡§ü‡§æ ‡§ï‡§∞‡•á‡§Ç */
        @media (max-width: 767.98px) {
            .landing-title {
                font-size: 2.5rem;
            }
            .landing-subtitle {
                font-size: 1.1rem;
            }
        }
        /* ======================================================== */
        /* === üöÄ ‡§®‡§Ø‡§æ CSS ‡§Ø‡§π‡§æ‡§Å ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã‡§§‡§æ ‡§π‡•à === */
        /* ======================================================== */

/* --- üöÄ FIX: ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§î‡§∞ ‡§∏‡•ç‡§ï‡•à‡§®‡§∞ ‡§ï‡•ã ‡§∏‡§¨‡§∏‡•á ‡§ä‡§™‡§∞ ‡§¶‡§ø‡§ñ‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è --- */
#localScannerModal {
    z-index: 10000 !important; /* ‡§Ø‡§π ‡§≤‡§æ‡§≤ ‡§¨‡§ü‡§® ‡§µ‡§æ‡§≤‡•Ä ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® (1050) ‡§∏‡•á ‡§¨‡§π‡•Å‡§§ ‡§ä‡§™‡§∞ ‡§∞‡§π‡•á‡§ó‡§æ */
}

/* ‡§Ö‡§ó‡§∞ ‡§¨‡•à‡§ï‡§°‡•ç‡§∞‡•â‡§™ (‡§ï‡§æ‡§≤‡•Ä ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§®) ‡§≠‡•Ä ‡§ó‡§°‡§º‡§¨‡§°‡§º ‡§ï‡§∞‡•á ‡§§‡•ã ‡§â‡§∏‡•á ‡§≠‡•Ä ‡§†‡•Ä‡§ï ‡§ï‡§∞‡•á‡§Ç */
.modal-backdrop {
    z-index: 1040; /* ‡§°‡§ø‡§´‡•â‡§≤‡•ç‡§ü */
}
/* ‡§ú‡§¨ ‡§¶‡•Ç‡§∏‡§∞‡§æ ‡§Æ‡•ã‡§°‡§≤ (‡§∏‡•ç‡§ï‡•à‡§®‡§∞) ‡§ñ‡•Å‡§≤‡•á, ‡§§‡•ã ‡§â‡§∏‡§ï‡§æ ‡§¨‡•à‡§ï‡§°‡•ç‡§∞‡•â‡§™ ‡§ä‡§™‡§∞ ‡§Ü‡§è */
.modal-backdrop:nth-of-type(2) {
    z-index: 9999 !important;
}


/* ============================================================
   üî• IMPROVED TABLE UI (BOLDER BORDERS & CLEARER TEXT)
   ============================================================ */

/* 1. ‡§ü‡•á‡§¨‡§≤ ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§ï‡•ã ‡§∏‡•Å‡§Ç‡§¶‡§∞ ‡§¨‡§®‡§æ‡§è‡§Ç */
.table-responsive {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* ‡§™‡§∞‡§õ‡§æ‡§à (Shadow) */
    border-radius: 10px; /* ‡§ó‡•ã‡§≤ ‡§ï‡•ã‡§®‡•á */
    overflow: hidden; /* ‡§ï‡•ã‡§®‡•ã‡§Ç ‡§ï‡•ã ‡§∏‡§æ‡§´ ‡§∞‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è */
    border: 1px solid #cbd5e0; /* ‡§¨‡§æ‡§π‡§∞‡•Ä ‡§¨‡•â‡§∞‡•ç‡§°‡§∞ */
}

/* 2. ‡§ü‡•á‡§¨‡§≤ ‡§ï‡•á ‡§¨‡•â‡§∞‡•ç‡§°‡§∞ ‡§ï‡•ã ‡§ó‡§π‡§∞‡§æ ‡§î‡§∞ ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç */
.table th, .table td {
    border: 1px solid #a0aec0 !important; /* üî• ‡§ó‡§π‡§∞‡§æ ‡§ó‡•ç‡§∞‡•á ‡§¨‡•â‡§∞‡•ç‡§°‡§∞ (Deep Grey) */
    padding: 14px 16px !important; /* ‡§ñ‡•Å‡§≤‡§æ-‡§ñ‡•Å‡§≤‡§æ ‡§∏‡•ç‡§™‡•á‡§∏‡§ø‡§Ç‡§ó */
    vertical-align: middle; /* ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§¨‡•Ä‡§ö ‡§Æ‡•á‡§Ç ‡§∞‡§π‡•á‡§ó‡§æ */
}

/* 3. ‡§π‡•á‡§°‡§∞ (Header) ‡§ï‡•ã ‡§™‡•ç‡§∞‡•ã‡§´‡•á‡§∂‡§®‡§≤ ‡§¨‡§®‡§æ‡§è‡§Ç */
.table th {
    background-color: #2d3748 !important; /* ‡§ó‡§π‡§∞‡§æ ‡§®‡•Ä‡§≤‡§æ ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° */
    color: #ffffff !important; /* ‡§∏‡§´‡•á‡§¶ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü */
    font-weight: 700 !important; /* ‡§ú‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§Æ‡•ã‡§ü‡§æ (Bold) ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü */
    text-transform: uppercase; /* ‡§∏‡§æ‡§∞‡•á ‡§∂‡§¨‡•ç‡§¶ ‡§¨‡§°‡§º‡•á ‡§Ö‡§ï‡•ç‡§∑‡§∞‡•ã‡§Ç ‡§Æ‡•á‡§Ç */
    font-size: 0.85rem; /* ‡§∏‡§π‡•Ä ‡§∏‡§æ‡§á‡§ú */
    letter-spacing: 0.8px; /* ‡§Ö‡§ï‡•ç‡§∑‡§∞‡•ã‡§Ç ‡§ï‡•á ‡§¨‡•Ä‡§ö ‡§ú‡§ó‡§π */
    border-bottom: 2px solid #1a202c !important; /* ‡§®‡•Ä‡§ö‡•á ‡§ï‡•Ä ‡§≤‡§æ‡§á‡§® ‡§î‡§∞ ‡§ó‡§π‡§∞‡•Ä */
}

/* 4. ‡§∏‡•á‡§≤ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§ï‡•á ‡§∂‡§¨‡•ç‡§¶‡•ã‡§Ç ‡§ï‡•ã ‡§∏‡§æ‡§´ ‡§ï‡§∞‡•á‡§Ç */
.table td {
    color: #1a202c !important; /* ‡§ó‡§π‡§∞‡§æ ‡§ï‡§æ‡§≤‡§æ ‡§∞‡§Ç‡§ó (Dark Black/Blue) */
    font-weight: 600 !important; /* ‡§•‡•ã‡§°‡§º‡§æ ‡§Æ‡•ã‡§ü‡§æ ‡§´‡•â‡§®‡•ç‡§ü (Semi-Bold) */
    font-size: 0.95rem; /* ‡§™‡§¢‡§º‡§®‡•á ‡§Æ‡•á‡§Ç ‡§Ü‡§∏‡§æ‡§® */
}

/* 5. ‡§π‡•ã‡§µ‡§∞ ‡§á‡§´‡•á‡§ï‡•ç‡§ü (‡§Æ‡§æ‡§â‡§∏ ‡§≤‡•á ‡§ú‡§æ‡§®‡•á ‡§™‡§∞ ‡§ö‡§Æ‡§ï‡§®‡§æ) */
.table-hover tbody tr:hover {
    background-color: #e6fffa !important; /* ‡§π‡§≤‡•ç‡§ï‡§æ ‡§π‡§∞‡§æ/‡§®‡•Ä‡§≤‡§æ ‡§π‡§æ‡§à‡§≤‡§æ‡§á‡§ü */
    cursor: pointer;
    transition: background-color 0.2s ease;
}

/* 6. ‡§ú‡§º‡•á‡§¨‡§∞‡§æ ‡§∏‡•ç‡§ü‡•ç‡§∞‡§ø‡§™‡§ø‡§Ç‡§ó (‡§è‡§ï ‡§≤‡§æ‡§á‡§® ‡§°‡§æ‡§∞‡•ç‡§ï, ‡§è‡§ï ‡§≤‡§æ‡§á‡§ü) */
.table-striped tbody tr:nth-of-type(odd) {
    background-color: #f7fafc !important; /* ‡§¨‡§π‡•Å‡§§ ‡§π‡§≤‡•ç‡§ï‡§æ ‡§ó‡•ç‡§∞‡•á */
}


/* ============================================================
   üî• DATA ENTRY FIELDS (BOLD BORDERS & CLEAR TEXT)
   ============================================================ */

/* 1. ‡§∏‡§≠‡•Ä ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§¨‡•â‡§ï‡•ç‡§∏ (Inputs) ‡§î‡§∞ ‡§≤‡§ø‡§∏‡•ç‡§ü (Select) ‡§ï‡•á ‡§¨‡•â‡§∞‡•ç‡§°‡§∞ ‡§ó‡§π‡§∞‡•á ‡§ï‡§∞‡•á‡§Ç */
.form-control, .form-select, .input-group-text {
    border: 2px solid #718096 !important; /* ‡§ó‡§π‡§∞‡§æ ‡§ó‡•ç‡§∞‡•á ‡§¨‡•â‡§∞‡•ç‡§°‡§∞ */
    border-radius: 6px; /* ‡§•‡•ã‡§°‡§º‡•á ‡§ó‡•ã‡§≤ ‡§ï‡•ã‡§®‡•á */
    color: #1a202c !important; /* ‡§ó‡§π‡§∞‡§æ ‡§ï‡§æ‡§≤‡§æ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü */
    font-weight: 600 !important; /* ‡§∂‡§¨‡•ç‡§¶ ‡§Æ‡•ã‡§ü‡•á (Bold) ‡§¶‡§ø‡§ñ‡•á‡§Ç‡§ó‡•á */
    font-size: 1rem !important; /* ‡§∏‡§æ‡§á‡§ú‡§º ‡§™‡§¢‡§º‡§®‡•á ‡§Æ‡•á‡§Ç ‡§Ü‡§∏‡§æ‡§® */
    background-color: #ffffff !important;
}

/* 2. ‡§ú‡§¨ ‡§Ü‡§™ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç (Focus) */
.form-control:focus, .form-select:focus {
    border-color: #2b6cb0 !important; /* ‡§ó‡§π‡§∞‡§æ ‡§®‡•Ä‡§≤‡§æ ‡§¨‡•â‡§∞‡•ç‡§°‡§∞ */
    box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.25) !important; /* ‡§π‡§≤‡•ç‡§ï‡§æ ‡§®‡•Ä‡§≤‡§æ ‡§ó‡•ç‡§≤‡•ã */
    background-color: #f7fafc !important; /* ‡§¨‡§π‡•Å‡§§ ‡§π‡§≤‡•ç‡§ï‡§æ ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° */
}

/* 3. ‡§ü‡•á‡§¨‡§≤ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§µ‡§æ‡§≤‡•á ‡§á‡§®‡§™‡•Å‡§ü (‡§ú‡•à‡§∏‡•á POS ‡§Æ‡•á‡§Ç Qty) */
.table td input.form-control {
    border: 2px solid #a0aec0 !important;
    text-align: center; /* ‡§®‡§Ç‡§¨‡§∞ ‡§¨‡•Ä‡§ö ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ñ‡•á‡§ó‡§æ */
    font-weight: 700 !important; /* ‡§î‡§∞ ‡§ú‡§º‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§¨‡•ã‡§≤‡•ç‡§° */
    color: #2d3748 !important;
}

/* 4. ‡§´‡§º‡•Ä‡§≤‡•ç‡§° ‡§ï‡•á ‡§ä‡§™‡§∞ ‡§≤‡§ø‡§ñ‡•á ‡§®‡§æ‡§Æ (Labels) ‡§ï‡•ã ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç */
.form-label {
    font-weight: 700 !important; /* ‡§≤‡•á‡§¨‡§≤‡•ç‡§∏ ‡§ï‡•ã ‡§¨‡•ã‡§≤‡•ç‡§° ‡§ï‡§∞‡•á‡§Ç */
    color: #4a5568 !important; /* ‡§ó‡§π‡§∞‡§æ ‡§ó‡•ç‡§∞‡•á */
    margin-bottom: 6px;
    letter-spacing: 0.5px;
}

/* 5. ‡§á‡§®‡§™‡•Å‡§ü ‡§ó‡•ç‡§∞‡•Å‡§™ (‡§ú‡•à‡§∏‡•á ‚Çπ ‡§Ø‡§æ ‡§Ü‡§á‡§ï‡•â‡§® ‡§µ‡§æ‡§≤‡•á ‡§¨‡•â‡§ï‡•ç‡§∏) */
.input-group-text {
    background-color: #e2e8f0 !important;
    border: 2px solid #718096 !important;
    color: #2d3748 !important;
    font-weight: 700 !important;
}


/* ============================================================
   ü§ñ AI INSIGHTS - MODERN UI (FUTURISTIC LOOK)
   ============================================================ */

/* 1. ‡§π‡•á‡§°‡§∞ ‡§ï‡•ã ‡§∏‡•Å‡§Ç‡§¶‡§∞ ‡§î‡§∞ ‡§Æ‡•â‡§°‡§∞‡•ç‡§® ‡§¨‡§®‡§æ‡§è‡§Ç (Gradient & Shadow) */
.ai-header-box {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; /* ‡§¨‡•ç‡§≤‡•Ç-‡§∞‡•ç‡§™‡§≤ ‡§ó‡•ç‡§∞‡•á‡§°‡§ø‡§è‡§Ç‡§ü */
    color: white !important;
    padding: 30px !important;
    border-radius: 20px !important;
    box-shadow: 0 10px 30px rgba(118, 75, 162, 0.4) !important; /* ‡§ó‡•ç‡§≤‡•ã‡§á‡§Ç‡§ó ‡§∂‡•à‡§°‡•ã */
    margin-bottom: 35px !important;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.ai-title {
    font-size: 2.2rem !important;
    font-weight: 800 !important;
    letter-spacing: 1px;
    margin-bottom: 5px !important;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.ai-subtitle {
    font-size: 1rem !important;
    opacity: 0.9;
    font-weight: 400;
}

/* 2. ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§¨‡§ü‡§® ‡§ï‡•ã ‡§ó‡•ç‡§≤‡§æ‡§∏ ‡§á‡§´‡•á‡§ï‡•ç‡§ü ‡§¶‡•á‡§Ç */
.ai-refresh-btn {
    background: rgba(255, 255, 255, 0.2) !important;
    border: 1px solid rgba(255, 255, 255, 0.4) !important;
    color: white !important;
    padding: 12px 25px !important;
    border-radius: 50px !important;
    font-weight: 600 !important;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.ai-refresh-btn:hover {
    background: white !important;
    color: #764ba2 !important;
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
}

/* 3. ‡§∏‡§æ‡§∞‡•á AI ‡§¨‡•â‡§ï‡•ç‡§∏ (Cards) ‡§ï‡•ã ‡§∏‡§æ‡§´‡§º ‡§î‡§∞ ‡§™‡•ç‡§∞‡•ã‡§´‡•á‡§∂‡§®‡§≤ ‡§¨‡§®‡§æ‡§è‡§Ç */
.ai-box {
    background: #ffffff !important;
    border-radius: 16px !important;
    padding: 25px !important;
    margin-bottom: 25px !important;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.06) !important; /* ‡§∏‡•â‡§´‡•ç‡§ü ‡§∂‡•à‡§°‡•ã */
    border: 1px solid #e2e8f0 !important;
    transition: transform 0.3s ease;
    position: relative;
    overflow: hidden;
}

.ai-box:hover {
    transform: translateY(-5px); /* ‡§Æ‡§æ‡§â‡§∏ ‡§≤‡•á ‡§ú‡§æ‡§®‡•á ‡§™‡§∞ ‡§ä‡§™‡§∞ ‡§â‡§†‡•á‡§ó‡§æ */
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12) !important;
}

.ai-box h3 {
    color: #2d3748;
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid #edf2f7;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* 4. ‡§Ö‡§≤‡§∞‡•ç‡§ü/‡§Æ‡•à‡§∏‡•á‡§ú (Insights) ‡§ï‡•ã ‡§∞‡§Ç‡§ó‡•Ä‡§® ‡§î‡§∞ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç */
.ai-card-alert {
    border-radius: 12px !important;
    padding: 16px !important;
    margin-bottom: 16px !important;
    border-left: 5px solid !important; /* ‡§¨‡§æ‡§Ø‡•Ä‡§Ç ‡§§‡§∞‡§´ ‡§Æ‡•ã‡§ü‡•Ä ‡§≤‡§æ‡§á‡§® */
    background: #f8fafc;
    box-shadow: 0 2px 5px rgba(0,0,0,0.03);
}

/* ‡§Ö‡§≤‡§ó-‡§Ö‡§≤‡§ó ‡§∞‡§Ç‡§ó‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è (Success, Warning, Danger) */
.ai-alert-info {
    background-color: #ebf8ff !important;
    border-left-color: #4299e1 !important; /* ‡§®‡•Ä‡§≤‡§æ */
    color: #2b6cb0;
}

.ai-alert-warning {
    background-color: #fffff0 !important;
    border-left-color: #ecc94b !important; /* ‡§™‡•Ä‡§≤‡§æ */
    color: #975a16;
}

.ai-alert-danger {
    background-color: #fff5f5 !important;
    border-left-color: #f56565 !important; /* ‡§≤‡§æ‡§≤ */
    color: #c53030;
}

.ai-alert-success {
    background-color: #f0fff4 !important;
    border-left-color: #48bb78 !important; /* ‡§π‡§∞‡§æ */
    color: #2f855a;
}

/* 5. Health Score Circle (‡§ó‡•ã‡§≤ ‡§µ‡§æ‡§≤‡§æ ‡§∏‡•ç‡§ï‡•ã‡§∞) */
.ai-score-circle {
    width: 90px;
    height: 90px;
    background: conic-gradient(#48bb78 0%, #48bb78 var(--score, 100%), #e2e8f0 0%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #2f855a;
    font-size: 2.2rem;
    font-weight: 800;
    border: 5px solid #f0fff4;
    box-shadow: 0 0 15px rgba(72, 187, 120, 0.3);
}

/* 6. Chat Box (‡§®‡•Ä‡§ö‡•á ‡§µ‡§æ‡§≤‡§æ) - Dark Mode Style */
#ai-chat-box {
    background: #2d3748 !important; /* ‡§°‡§æ‡§∞‡•ç‡§ï ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° */
    color: white !important;
    border: none !important;
}

#ai-chat-box h3 {
    color: white !important;
    border-bottom-color: #4a5568 !important;
}

.ai-chat-input input {
    background: rgba(255, 255, 255, 0.1) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    color: white !important;
    border-radius: 50px !important;
    padding: 12px 25px !important;
    width: 75% !important;
}

.ai-chat-input input:focus {
    background: rgba(255, 255, 255, 0.2) !important;
    outline: none;
    box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
}

.ai-chat-input button {
    background: #48bb78 !important;
    color: white !important;
    border-radius: 50px !important;
    padding: 10px 25px !important;
    font-weight: bold;
    border: none;
    transition: transform 0.2s;
}

.ai-chat-input button:hover {
    transform: scale(1.05);
    background: #38a169 !important;
}


/* ============================================================
   üìñ AI TYPOGRAPHY - TEXT BEAUTIFICATION (READABILITY)
   ============================================================ */

/* 1. ‡§™‡•à‡§∞‡§æ‡§ó‡•ç‡§∞‡§æ‡§´ ‡§î‡§∞ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§ï‡•ã ‡§ñ‡•Å‡§≤‡§æ-‡§ñ‡•Å‡§≤‡§æ ‡§î‡§∞ ‡§∏‡§æ‡•û ‡§ï‡§∞‡•á‡§Ç */
.ai-box p, .ai-box li, .ai-chat-response {
    font-size: 1.05rem !important; /* ‡§Ö‡§ï‡•ç‡§∑‡§∞ ‡§•‡•ã‡•ú‡•á ‡§¨‡•ú‡•á */
    line-height: 1.8 !important;    /* ‡§≤‡§æ‡§á‡§®‡•ã‡§Ç ‡§ï‡•á ‡§¨‡•Ä‡§ö ‡§ó‡•à‡§™ (‡§§‡§æ‡§ï‡§ø ‡§™‡•ù‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡•Å‡§ï‡•Ç‡§® ‡§Æ‡§ø‡§≤‡•á) */
    color: #2d3748 !important;      /* ‡§ó‡§π‡§∞‡§æ ‡§∏‡•ç‡§≤‡•á‡§ü ‡§ï‡§≤‡§∞ (‡§Ü‡§Å‡§ñ‡•ã‡§Ç ‡§ï‡•ã ‡§®‡§π‡•Ä‡§Ç ‡§ö‡•Å‡§≠‡•á‡§ó‡§æ) */
    font-weight: 500 !important;    /* ‡§π‡§≤‡•ç‡§ï‡§æ ‡§Æ‡•ã‡§ü‡§æ (Readable) */
    letter-spacing: 0.3px;          /* ‡§Ö‡§ï‡•ç‡§∑‡§∞‡•ã‡§Ç ‡§ï‡•á ‡§¨‡•Ä‡§ö ‡§π‡§≤‡•ç‡§ï‡•Ä ‡§ú‡§ó‡§π */
}

/* 2. ‡§ú‡•ã ‡§∂‡§¨‡•ç‡§¶ Bold (‡§Æ‡•ã‡§ü‡•á) ‡§π‡•à‡§Ç, ‡§â‡§®‡•ç‡§π‡•á‡§Ç ‡§ï‡§≤‡§∞‡§´‡•Å‡§≤ ‡§¨‡§®‡§æ‡§è‡§Ç */
.ai-box b, .ai-box strong {
    color: #3182ce !important; /* ‡§∏‡•Å‡§Ç‡§¶‡§∞ ‡§®‡•Ä‡§≤‡§æ ‡§∞‡§Ç‡§ó (Highlight) */
    font-weight: 700 !important;
    background: rgba(49, 130, 206, 0.1); /* ‡§™‡•Ä‡§õ‡•á ‡§π‡§≤‡•ç‡§ï‡§æ ‡§®‡•Ä‡§≤‡§æ ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° */
    padding: 0 4px;
    border-radius: 4px;
}

/* 3. ‡§π‡•á‡§°‡§ø‡§Ç‡§ó‡•ç‡§∏ (Headings) ‡§ï‡•ã ‡§™‡•ç‡§∞‡•Ä‡§Æ‡§ø‡§Ø‡§Æ ‡§≤‡•Å‡§ï ‡§¶‡•á‡§Ç */
.ai-box h3, .ai-box h4, .ai-box h5 {
    color: #1a202c !important; /* ‡§ú‡•á‡§° ‡§¨‡•ç‡§≤‡•à‡§ï */
    font-weight: 800 !important; /* ‡§è‡§ï‡•ç‡§∏‡•ç‡§ü‡•ç‡§∞‡§æ ‡§¨‡•ã‡§≤‡•ç‡§° */
    margin-bottom: 15px !important;
    letter-spacing: -0.5px; /* ‡§Æ‡•â‡§°‡§∞‡•ç‡§® ‡§ü‡§æ‡§á‡§ü ‡§≤‡•Å‡§ï */
}

/* 4. AI Chat Response (‡§ú‡•ã ‡§ú‡§µ‡§æ‡§¨ ‡§Ü‡§§‡§æ ‡§π‡•à) */
.ai-chat-response {
    background: #f7fafc !important;
    border-radius: 12px;
    padding: 20px !important;
    border: 1px solid #e2e8f0;
    margin-bottom: 15px;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
}

/* 5. ‡§õ‡•ã‡§ü‡•á ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü (Muted Text) ‡§ï‡•ã ‡§≠‡•Ä ‡§∏‡§æ‡•û ‡§ï‡§∞‡•á‡§Ç */
.text-muted-small {
    font-size: 0.9rem !important;
    color: #718096 !important;
    font-style: italic;
}

/* 6. AI Badges (Pills) ‡§ï‡•ã ‡§∏‡•Å‡§Ç‡§¶‡§∞ ‡§¨‡§®‡§æ‡§è‡§Ç */
.ai-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 50px;
    font-size: 0.85rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* ‡§¨‡•à‡§ú ‡§ï‡•á ‡§∞‡§Ç‡§ó */
.ai-badge-blue { background: #ebf8ff; color: #2b6cb0; border: 1px solid #bee3f8; }
.ai-badge-green { background: #f0fff4; color: #2f855a; border: 1px solid #c6f6d5; }
.ai-badge-yellow { background: #fffff0; color: #975a16; border: 1px solid #fefcbf; }
.ai-badge-red { background: #fff5f5; color: #c53030; border: 1px solid #fed7d7; }

/* 7. ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§ï‡•á ‡§°‡•â‡§ü‡•ç‡§∏ ‡§ï‡•ã ‡§∏‡•Å‡§Ç‡§¶‡§∞ ‡§¨‡§®‡§æ‡§è‡§Ç */
.ai-box ul {
    padding-left: 20px;
    list-style-type: none; /* ‡§™‡•Å‡§∞‡§æ‡§®‡•á ‡§°‡•â‡§ü‡•ç‡§∏ ‡§π‡§ü‡§æ‡§è‡§Ç */
}

.ai-box ul li {
    position: relative;
    padding-left: 15px;
    margin-bottom: 8px;
}

.ai-box ul li::before {
    content: "‚Ä¢";
    color: #667eea; /* ‡§¨‡•Å‡§≤‡•á‡§ü ‡§™‡•â‡§á‡§Ç‡§ü‡•ç‡§∏ ‡§ï‡§æ ‡§∞‡§Ç‡§ó */
    font-weight: bold;
    font-size: 1.5em;
    position: absolute;
    left: -10px;
    top: -5px;
}

/* ============================================================
   ‚úÖ FIX: WHATSAPP BUTTON VISIBILITY (GREEN COLOR)
   ============================================================ */

/* ‡§∏‡§ø‡§∞‡•ç‡§´ AI ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§µ‡§æ‡§≤‡•á ‡§¨‡§ü‡§® ‡§ï‡•ã ‡§π‡§∞‡§æ (Green) ‡§ï‡§∞‡•á‡§Ç */
.ai-box .ai-refresh-btn {
    background: #25D366 !important; /* WhatsApp Official Green */
    color: white !important; /* ‡§∏‡§´‡§º‡•á‡§¶ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü */
    border: none !important;
    font-size: 0.85rem !important;
    padding: 8px 16px !important;
    box-shadow: 0 4px 10px rgba(37, 211, 102, 0.3) !important; /* ‡§π‡§∞‡•Ä ‡§™‡§∞‡§õ‡§æ‡§à */
    text-shadow: none !important;
    margin-top: 5px;
}

/* ‡§Æ‡§æ‡§â‡§∏ ‡§≤‡•á ‡§ú‡§æ‡§®‡•á ‡§™‡§∞ (Hover) */
.ai-box .ai-refresh-btn:hover {
    background: #128C7E !important; /* ‡§ó‡§π‡§∞‡§æ ‡§π‡§∞‡§æ */
    color: white !important;
    transform: translateY(-2px); /* ‡§•‡•ã‡§°‡§º‡§æ ‡§ä‡§™‡§∞ ‡§â‡§†‡•á‡§ó‡§æ */
    box-shadow: 0 6px 15px rgba(37, 211, 102, 0.4) !important;
}


/* ============================================================
   ‚úÖ FIX: CUSTOMER TARGETING WHATSAPP BUTTON
   ============================================================ */

/* Targeting ‡§∏‡•á‡§ï‡•ç‡§∂‡§® ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§ï‡•á ‡§∏‡§≠‡•Ä ‡§≤‡§ø‡§Ç‡§ï/‡§¨‡§ü‡§® ‡§ï‡•ã ‡§π‡§∞‡§æ ‡§ï‡§∞‡•á‡§Ç */
#ai-customer-targeting-content a, 
#ai-customer-targeting-content button,
#ai-customer-targeting-content .btn {
    background-color: #25D366 !important; /* WhatsApp ‡§π‡§∞‡§æ */
    color: #ffffff !important; /* ‡§∏‡§´‡§º‡•á‡§¶ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü/‡§Ü‡§á‡§ï‡•â‡§® */
    border: none !important;
    box-shadow: 0 3px 6px rgba(37, 211, 102, 0.3) !important;
    border-radius: 5px !important;
    padding: 6px 12px !important;
    font-weight: bold !important;
    text-decoration: none !important;
    display: inline-block !important;
    margin-left: 5px !important;
}

/* ‡§Æ‡§æ‡§â‡§∏ ‡§≤‡•á ‡§ú‡§æ‡§®‡•á ‡§™‡§∞ */
#ai-customer-targeting-content a:hover, 
#ai-customer-targeting-content button:hover {
    background-color: #128C7E !important; /* ‡§ó‡§π‡§∞‡§æ ‡§π‡§∞‡§æ */
    transform: scale(1.05);
    box-shadow: 0 5px 12px rgba(37, 211, 102, 0.4) !important;
}

/* ‡§Ö‡§ó‡§∞ ‡§Ü‡§á‡§ï‡•â‡§® (i tag) ‡§ï‡§æ ‡§∞‡§Ç‡§ó ‡§Ö‡§≤‡§ó ‡§π‡•à ‡§§‡•ã ‡§â‡§∏‡•á ‡§≠‡•Ä ‡§∏‡§´‡§º‡•á‡§¶ ‡§ï‡§∞‡•á‡§Ç */
#ai-customer-targeting-content i {
    color: #ffffff !important;
}

/* üöÄ FIX: AI Insights Layout Correction */
#ai-insights {
    width: 100%;
    /* ‡§Ö‡§ó‡§∞ ‡§Ø‡§π main-content ‡§ï‡•á ‡§¨‡§æ‡§π‡§∞ ‡§π‡•à, ‡§§‡•ã ‡§á‡§∏‡•á ‡§∏‡§π‡•Ä ‡§Æ‡§æ‡§∞‡•ç‡§ú‡§ø‡§® ‡§¶‡•á‡§Ç */
    padding-left: 0; 
}

/* ‡§Ö‡§ó‡§∞ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§¨‡§°‡§º‡•Ä ‡§π‡•à (Laptop/PC) ‡§î‡§∞ ‡§Ø‡§π ‡§ó‡§≤‡§§‡•Ä ‡§∏‡•á ‡§¨‡§æ‡§π‡§∞ ‡§π‡•à */
@media (min-width: 992px) {
    body > #ai-insights {
        margin-left: 280px; /* ‡§∏‡§æ‡§á‡§°‡§¨‡§æ‡§∞ ‡§ï‡•Ä ‡§ú‡§ó‡§π ‡§õ‡•ã‡•ú‡•á‡§Ç */
        width: calc(100% - 280px); /* ‡§¨‡§æ‡§ï‡•Ä ‡§¨‡§ö‡•Ä ‡§ú‡§ó‡§π ‡§≤‡•á‡§Ç */
        padding: 30px;
    }
}

/* ‡§π‡•á‡§°‡§∞ ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§ï‡•ã ‡§î‡§∞ ‡§∏‡•Å‡§Ç‡§¶‡§∞ ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è */
.ai-header-box {
    margin-top: 10px;
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37) !important;
    border: 1px solid rgba(255, 255, 255, 0.18) !important;
    width: 100%; /* ‡§´‡•Å‡§≤ ‡§µ‡§ø‡§°‡•ç‡§• */
    box-sizing: border-box; /* ‡§™‡•à‡§°‡§ø‡§Ç‡§ó ‡§ï‡•ã ‡§µ‡§ø‡§°‡•ç‡§• ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§∞‡§ñ‡•á‡§Ç */
}


/* ==============================================
   üì± MOBILE TABLE FIX (STICKY ACTIONS)
   ============================================== */
   @media (max-width: 991px) {
    /* 1. ‡§ü‡•á‡§¨‡§≤ ‡§ï‡•ã ‡§∏‡§æ‡§á‡§° ‡§Æ‡•á‡§Ç ‡§∏‡•ç‡§ï‡•ç‡§∞‡•â‡§≤ ‡§ï‡§∞‡§®‡•á ‡§≤‡§æ‡§Ø‡§ï ‡§¨‡§®‡§æ‡§è‡§Ç */
    .table-responsive {
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch;
        display: block;
        width: 100%;
    }

    /* 2. ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•ã ‡§è‡§ï ‡§≤‡§æ‡§á‡§® ‡§Æ‡•á‡§Ç ‡§∞‡§ñ‡•á‡§Ç */
    .table th, .table td {
        white-space: nowrap;
        font-size: 0.85rem;
        padding: 8px 6px !important;
        vertical-align: middle;
    }

    /* 3. ‡§¨‡§ü‡§® ‡§ï‡•ã ‡§ö‡§ø‡§™‡§ï‡§æ‡§è‡§Ç (Sticky) */
    .table th:last-child,
    .table td:last-child {
        position: sticky !important;
        right: 0;
        background-color: #ffffff !important;
        box-shadow: -2px 0 5px rgba(0,0,0,0.1);
        z-index: 5;
        width: 120px;
        text-align: center;
    }

    /* ‡§π‡•á‡§°‡§∞ ‡§ï‡§æ ‡§∞‡§Ç‡§ó */
    .table th:last-child {
        background-color: #2d3748 !important;
        color: white !important;
    }

    /* 4. ‡§´‡•ç‡§≤‡•á‡§ï‡•ç‡§∏ ‡§¨‡§ü‡§® */
    .table td:last-child div, 
    .table td:last-child {
        display: flex;
        justify-content: center;
        gap: 5px;
    }
}

/* =======================================================
   üî• FORCE HIDE: ‡§´‡§æ‡§≤‡§§‡•Ç ‡§´‡•â‡§∞‡•ç‡§Æ ‡§î‡§∞ ‡§ï‡§ö‡§∞‡§æ ‡§π‡§ü‡§æ‡§®‡•á ‡§ï‡§æ ‡§¨‡•ç‡§∞‡§π‡•ç‡§Æ‡§æ‡§∏‡•ç‡§§‡•ç‡§∞
   ======================================================= */

/* 1. ‡§ö‡§∂‡•ç‡§Æ‡•á ‡§î‡§∞ ‡§ú‡•Ç‡§§‡•ã‡§Ç ‡§µ‡§æ‡§≤‡•á ‡§™‡•Å‡§∞‡§æ‡§®‡•á ‡§∏‡•á‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã ‡§ó‡§æ‡§Ø‡§¨ ‡§ï‡§∞‡•á‡§Ç */
#prescription-fields-container, 
#add-custom-field-btn,
.custom-field-wrapper {
    display: none !important;
}

/* 2. ‡§Ö‡§ó‡§∞ ‡§ï‡•ã‡§à ‡§™‡•Å‡§∞‡§æ‡§®‡•Ä 'Bulk Table' HTML ‡§Æ‡•á‡§Ç ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§≤‡§ø‡§ñ‡•Ä ‡§π‡•à, ‡§§‡•ã ‡§â‡§∏‡•á ‡§õ‡§ø‡§™‡§æ‡§è‡§Ç */
/* ‡§®‡•ã‡§ü: JS ‡§ú‡§¨ ‡§®‡§Ø‡§æ ‡§ü‡•á‡§¨‡§≤ ‡§¨‡§®‡§æ‡§è‡§ó‡§æ, ‡§§‡•ã ‡§µ‡•ã ‡§á‡§∏‡•á ‡§ì‡§µ‡§∞‡§∞‡§æ‡§á‡§° ‡§ï‡§∞ ‡§≤‡•á‡§ó‡§æ */
#dish-bulk-container {
    display: none; 
}

/* 3. 'Chasme ke liye' ‡§Ø‡§æ 'Jooton ke liye' ‡§µ‡§æ‡§≤‡•á ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•ã ‡§õ‡§ø‡§™‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è */
/* ‡§Ø‡§π ‡§â‡§® h6 ‡§Ø‡§æ p ‡§ü‡•à‡§ó‡•ç‡§∏ ‡§ï‡•ã ‡§ü‡§æ‡§∞‡§ó‡•á‡§ü ‡§ï‡§∞‡•á‡§ó‡§æ ‡§ú‡§ø‡§®‡§Æ‡•á‡§Ç ‡§Ø‡§π ‡§Ü‡§à‡§°‡•Ä ‡§π‡•ã ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à (‡§Ö‡§ó‡§∞ ‡§Ü‡§™‡§®‡•á ‡§¶‡•Ä ‡§π‡•à) */
[id*="prescription"], [class*="prescription"] {
    display: none !important;
}

/* 4. JS ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§¨‡§®‡§æ‡§è ‡§ó‡§è ‡§™‡•Å‡§∞‡§æ‡§®‡•á ‡§ï‡§ö‡§∞‡•á ‡§ï‡•ã ‡§≠‡•Ä ‡§õ‡§ø‡§™‡§æ ‡§ï‡§∞ ‡§∞‡§ñ‡•á‡§Ç */
#dynamic-business-fields {
    display: none;
}

/* ‚úÖ Garments ke liye Anti-Theft Security panel */
#garments-security-fields {
    display: block !important;
}

    </style>

</head>

<body>

    <input type="text" id="barcode-scanner-input" autocomplete="off">


    <div class="auth-overlay" id="auth-container-new">
        <div class="landing-buttons" id="landing-buttons-container">
            <h1 class="landing-title">Dukan Pro Ultimate</h1>
            <p class="landing-subtitle">‡§á‡§Ç‡§°‡§ø‡§Ø‡§æ ‡§ï‡§æ ‡§∏‡§¨‡§∏‡•á ‡§è‡§°‡§µ‡§æ‡§Ç‡§∏ ‡§¨‡§ø‡•õ‡§®‡•á‡§∏ ‡§∏‡•Ç‡§ü</p>
            <div class="d-flex flex-wrap justify-content-center gap-3">
                <button class="btn btn-primary btn-lg landing-btn" id="show-login-btn">
                    <i class="fas fa-sign-in-alt me-2"></i>‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç
                </button>
                <button class="btn btn-success btn-lg landing-btn" id="show-register-btn">
                    <i class="fas fa-user-plus me-2"></i>‡§®‡§Ø‡§æ ‡§Ö‡§ï‡§æ‡§â‡§Ç‡§ü ‡§¨‡§®‡§æ‡§è‡§Ç
                </button>
            </div>
        </div>
    
        <div class="login-wrapper" id="login-wrapper-main">
        
        <div class="login-ad-sidebar">
            <h3 class="mb-3"><i class="fas fa-store me-2"></i>Dukan Pro Ultimate</h3>
            <p>‡§á‡§Ç‡§°‡§ø‡§Ø‡§æ ‡§ï‡§æ ‡§∏‡§¨‡§∏‡•á ‡§è‡§°‡§µ‡§æ‡§Ç‡§∏ ‡§¨‡§ø‡•õ‡§®‡•á‡§∏ ‡§∏‡•Ç‡§ü</p>
            
            <ul class="features-list">
                <li><i class="fas fa-file-alt me-2"></i> GSTR-1, 2, & 3B Reports<br><span>(GSTR-1, 2, ‡§î‡§∞ 3B ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏)</span></li>
                <li><i class="fas fa-university me-2"></i> Automated Bank Reconciliation<br><span>(‡§∏‡•ç‡§µ‡§ö‡§æ‡§≤‡§ø‡§§ ‡§¨‡•à‡§Ç‡§ï ‡§∏‡§Æ‡§æ‡§ß‡§æ‡§®)</span></li>
                <li><i class="fas fa-qrcode me-2"></i> Barcode Scanning via Mobile<br><span>(‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§∏‡•á ‡§¨‡§æ‡§∞‡§ï‡•ã‡§° ‡§∏‡•ç‡§ï‡•à‡§®‡§ø‡§Ç‡§ó)</span></li>
                <li><i class="fas fa-users me-2"></i> Advanced Customer (CRM)<br><span>(‡§â‡§®‡•ç‡§®‡§§ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§∏‡§Ç‡§¨‡§Ç‡§ß ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®)</span></li>
                <li><i class="fas fa-boxes me-2"></i> Smart Stock & Inventory Control<br><span>(‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§∏‡•ç‡§ü‡•â‡§ï ‡§î‡§∞ ‡§á‡§®‡•ç‡§µ‡•á‡§Ç‡§ü‡§∞‡•Ä ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§£)</span></li>
                <li><i class="fas fa-chart-line me-2"></i> Real-time P&L & Analytics<br><span>(‡§∞‡§ø‡§Ø‡§≤-‡§ü‡§æ‡§á‡§Æ P&L ‡§î‡§∞ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£)</span></li>
                <li><i class="fas fa-cash-register me-2"></i> Lightning-Fast POS Billing<br><span>(‡§¨‡§ø‡§ú‡§≤‡•Ä ‡§ï‡•Ä ‡§§‡•á‡§ú‡§º‡•Ä ‡§∏‡•á POS ‡§¨‡§ø‡§≤‡§ø‡§Ç‡§ó)</span></li>
                <li><i class="fas fa-receipt me-2"></i> Customizable Invoice Generator<br><span>(‡§ï‡§∏‡•ç‡§ü‡§Æ‡§æ‡§á‡§ú‡•á‡§¨‡§≤ ‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§ú‡§®‡§∞‡•á‡§ü‡§∞)</span></li>
                <li><i class="fas fa-cloud me-2"></i> Secure Cloud Data Backup<br><span>(‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§ï‡•ç‡§≤‡§æ‡§â‡§° ‡§°‡•á‡§ü‡§æ ‡§¨‡•à‡§ï‡§Ö‡§™)</span></li>
            </ul>

            <div class="ad-footer">
                <p>‡§Ü‡§™‡§ï‡•á ‡§¨‡§ø‡•õ‡§®‡•á‡§∏ ‡§ï‡•Ä ‡§π‡§∞ ‡•õ‡§∞‡•Ç‡§∞‡§§, ‡§è‡§ï ‡§∏‡•â‡§´‡•ç‡§ü‡§µ‡•á‡§Ø‡§∞ ‡§Æ‡•á‡§Ç‡•§</p>
            </div>
        </div>
        
        <div class="login-card-glass">
            <nav>
                <div class="nav nav-tabs" id="nav-tab" role="tablist">
                    <button class="nav-link active w-50" id="nav-login-tab" data-bs-toggle="tab" data-bs-target="#nav-login" type="button" role="tab" aria-controls="nav-login" aria-selected="true">
                        <i class="fas fa-sign-in-alt me-2"></i>‡§≤‡•â‡§ó‡§ø‡§®
                    </button>
                    <button class="nav-link w-50" id="nav-register-tab" data-bs-toggle="tab" data-bs-target="#nav-register" type="button" role="tab" aria-controls="nav-register" aria-selected="false">
                        <i class="fas fa-user-plus me-2"></i>‡§®‡§Ø‡§æ ‡§Ö‡§ï‡§æ‡§â‡§Ç‡§ü
                    </button>
                </div>
            </nav>
            <div class="tab-content mt-4" id="nav-tabContent">
                <div class="tab-pane fade show active" id="nav-login" role="tabpanel" aria-labelledby="nav-login-tab">
                    <h3 class="text-center mb-4">Dukan Pro ‡§Æ‡•á‡§Ç ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç</h3>
                    <form id="login-form">
                        <div class="mb-3">
                            <label for="login-email" class="form-label">‡§à‡§Æ‡•á‡§≤</label>
                            <input type="email" class="form-control" id="login-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="login-password" class="form-label">‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°</label>
                            <input type="password" class="form-control" id="login-password" required>
                        </div>
                        <div id="login-message" class="text-danger small mb-3">&nbsp;</div>
                        <button type="submit" class="btn btn-primary w-100" id="login-submit-btn">‡§≤‡•â‡§ó‡§ø‡§®</button>
                    </form>
                </div>
                <div class="tab-pane fade" id="nav-register" role="tabpanel" aria-labelledby="nav-register-tab">
                    <h3 class="text-center mb-4">‡§®‡§Ø‡§æ ‡§∂‡•â‡§™ ‡§Ö‡§ï‡§æ‡§â‡§Ç‡§ü ‡§¨‡§®‡§æ‡§è‡§Ç</h3>
                    <form id="register-form">
                        <div class="mb-3">
                            <label for="register-shop-name" class="form-label">‡§Ü‡§™‡§ï‡•Ä ‡§∂‡•â‡§™ ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
                            <input type="text" class="form-control" id="register-shop-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="register-name" class="form-label">‡§Ü‡§™‡§ï‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ (‡§è‡§°‡§Æ‡§ø‡§®)</label>
                            <input type="text" class="form-control" id="register-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="register-email" class="form-label">‡§Ü‡§™‡§ï‡§æ ‡§à‡§Æ‡•á‡§≤</label>
                            <input type="email" class="form-control" id="register-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="register-mobile" class="form-label">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞</label>
                            <input type="tel" class="form-control" id="register-mobile" required pattern="[0-9]{10}">
                        </div>
                        <div class="mb-3">
                            <label for="register-password" class="form-label">‡§®‡§Ø‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°</label>
                            <input type="password" class="form-control" id="register-password" required>
                        </div>

                        <!-- Add this in your shop settings / registration form -->
                        <div class="mb-3">
                            <label for="unique-biz-type" class="form-label">‡§¨‡§ø‡§ú‡§®‡•á‡§∏ ‡§ï‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ (Business Type)</label>
                            <select id="unique-biz-type" class="form-select" required>
                                <option value="" selected disabled>-- ‡§Ö‡§™‡§®‡•Ä ‡§¶‡•Å‡§ï‡§æ‡§® ‡§ï‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç --</option>
                                
                                <optgroup label="üõçÔ∏è Retail & Shops">
                                    <option value="RETAIL">General Store / Kirana</option>
                                    <option value="MOBILE_SHOP">Mobile & Accessories</option>
                                    <option value="CLOTHING">Garments / Boutique</option>
                                    <option value="FURNITURE">Furniture Showroom</option>
                                    <option value="JEWELLERY">Jewellery / Imitation</option>
                                    <optgroup label="üõ†Ô∏è Hardware & Construction">
                                    <option value="HARDWARE_GENERAL">Hardware / Tools / Iron Store</option>
                                        
                                    <option value="PAINT_SHOP">Paint Shop / Color World</option>
                                    <option value="SWEET_SHOP">Sweet Shop / Bakery</option>
                                    <option value="ELECTRONICS">Electronics Showroom</option>
                                    <option value="SIM_STORE">SIM Card & Recharge</option>
                                </optgroup>
                        
                                <optgroup label="‚öïÔ∏è Medical & Health">
                                    <option value="PHARMACY">Medical Store / Pharmacy</option>
                                    <option value="DOCTOR_CLINIC">General Physician (Clinic)</option>
                                    <option value="ORTHOPEDIC">Orthopedic Clinic</option>
                                    <option value="DENTIST">Dental Clinic</option>
                                    <option value="SONOGRAPHY">Sonography / X-Ray Centre</option>
                                    <option value="PHYSIOTHERAPY">Physiotherapy Centre</option>
                                    <option value="PATHOLOGY">Pathology Lab</option>
                                </optgroup>
                        
                                <optgroup label="‚úÇÔ∏è Services & Personal Care">
                                    <option value="SALON">Salon / Spa</option>
                                    <option value="GYM">Gym / Fitness Center</option>
                                    <option value="TAILOR">Tailor / Boutique</option>
                                    <option value="SERVICE_CENTER">Repairing Center (Electronics)</option>
                                </optgroup>
                        
                                <optgroup label="üè® Hospitality & Food">
                                    <option value="RESTAURANT">Restaurant / Cafe</option>
                                    <option value="HOTEL">Hotel / Lodging</option>
                                    <option value="TENT_HOUSE">Tent House / Rentals</option>
                                </optgroup>
                        
                                <optgroup label="üöö Construction & Transport">
                                    <option value="TILES_CERAMIC">Tiles & Sanitaryware</option>
                                    <option value="TRANSPORT">Transport / Logistics</option>
                                </optgroup>
                        
                                <optgroup label="üí∞ Finance & Agents">
                                    <option value="LOAN_DSA">Loan / Credit Card DSA</option>
                                    <option value="RECOVERY_AGENT">Recovery / Collection Agent</option>
                                    <option value="INSURANCE_AGENCY">Insurance Agent</option>
                                </optgroup>
                        
                                <optgroup label="üéì Education & Office">
                                    <option value="SCHOOL">School / Coaching</option>
                                    <option value="ARCHITECT_FIRM">Architect / Interior</option>
                                    <option value="SOFTWARE_COMPANY">Software / IT Firm</option>
                                </optgroup>
                            </select>
                            <div class="form-text text-muted">
                                ‡§∏‡§π‡•Ä ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç, ‡§á‡§∏‡§∏‡•á ‡§Ü‡§™‡§ï‡§æ ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§î‡§∞ ‡§´‡•Ä‡§ö‡§∞‡•ç‡§∏ (‡§ú‡•à‡§∏‡•á Expiry, Tables, EMI) ‡§Ö‡§™‡§®‡•á ‡§Ü‡§™ ‡§∏‡•á‡§ü ‡§π‡•ã ‡§ú‡§æ‡§è‡§Ç‡§ó‡•á‡•§
                            </div>
                        </div>
  
                        <div id="register-message" class="text-danger small mb-3">&nbsp;</div>
                        <button type="submit" class="btn btn-success w-100" id="register-submit-btn">‡§Ö‡§ï‡§æ‡§â‡§Ç‡§ü ‡§¨‡§®‡§æ‡§è‡§Ç</button>
                    </form>
                </div>
            </div>
            </div>

    </div>

</div>



    <div class="modal fade" id="licenseModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="licenseModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="licenseModalLabel">Dukan Pro - License Verification</h5>
                </div>
                <form id="license-form">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="license-key-input" class="form-label fw-bold">‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§ï‡•Ä (License Key)</label>
                            <input type="text" class="form-control" id="license-key-input" required autocomplete="off" placeholder="XXXX-XXXX-XXXX-XXXX">
                        </div>
                        <div id="license-message" class="text-danger small mt-2 mb-3">&nbsp;</div>
                    
                        <div class="alert alert-success text-center">
                            <h5 class="alert-heading mb-0">‡§®‡§Ø‡§æ ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§≤‡•á‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç</h5>
                            <p class="mb-0 fs-4 fw-bold"><i class="fab fa-whatsapp"></i> 7303410987</p>
                        </div>
                    
                        <hr>
                        
                        <div class="accordion" id="plansAccordion">
                            
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBasic">
                                        <strong>‡§¨‡•á‡§∏‡§ø‡§ï ‡§™‡•ç‡§≤‡§æ‡§® - ‚Çπ1000/‡§Æ‡§æ‡§π</strong> (AMC: ‚Çπ3000/‡§∏‡§æ‡§≤)
                                    </button>
                                </h2>
                                <div id="collapseBasic" class="accordion-collapse collapse" data-bs-parent="#plansAccordion">
                                    <div class="accordion-body">
                                        ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•à‡§®‡•á‡§ú‡§Æ‡•á‡§Ç‡§ü, ‡§¨‡•á‡§∏‡§ø‡§ï POS, ‡§á‡§®‡§µ‡•â‡§á‡§∏‡§ø‡§Ç‡§ó, ‡§ñ‡§∞‡•Ä‡§¶, ‡§ñ‡§∞‡•ç‡§ö, ‡§¨‡•á‡§∏‡§ø‡§ï ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏, ‡§î‡§∞ GST ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏‡•§
                                    </div>
                                </div>
                            </div>
                    
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMedium">
                                        <strong>‡§Æ‡•Ä‡§°‡§ø‡§Ø‡§Æ ‡§™‡•ç‡§≤‡§æ‡§® - ‚Çπ3000/‡§Æ‡§æ‡§π</strong> (AMC: ‚Çπ5000/‡§∏‡§æ‡§≤)
                                    </button>
                                </h2>
                                <div id="collapseMedium" class="accordion-collapse collapse" data-bs-parent="#plansAccordion">
                                    <div class="accordion-body">
                                        <strong>‡§¨‡•á‡§∏‡§ø‡§ï ‡§™‡•ç‡§≤‡§æ‡§® ‡§ï‡•á ‡§∏‡§≠‡•Ä ‡§´‡•Ä‡§ö‡§∞‡•ç‡§∏ +</strong><br>
                                        CRM (‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®), ‡§¨‡•à‡§Ç‡§ï ‡§∞‡§ø‡§ï‡•â‡§®‡•ç‡§∏‡§ø‡§≤‡§ø‡§è‡§∂‡§®, ‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§ P&L ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡§ø‡§Ç‡§ó, ‡§î‡§∞ ‡§∏‡•ç‡§ü‡§æ‡§´ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®‡•§
                                    </div>
                                </div>
                            </div>
                    
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePremium">
                                        <strong>‡§™‡•ç‡§∞‡•Ä‡§Æ‡§ø‡§Ø‡§Æ ‡§™‡•ç‡§≤‡§æ‡§® - ‚Çπ7500/‡§Æ‡§æah</strong> (AMC: ‚Çπ8000/‡§∏‡§æ‡§≤)
                                    </button>
                                </h2>
                                <div id="collapsePremium" class="accordion-collapse collapse" data-bs-parent="#plansAccordion">
                                    <div class="accordion-body">
                                        <strong>‡§Æ‡•Ä‡§°‡§ø‡§Ø‡§Æ ‡§™‡•ç‡§≤‡§æ‡§® ‡§ï‡•á ‡§∏‡§≠‡•Ä ‡§´‡•Ä‡§ö‡§∞‡•ç‡§∏ +</strong><br>
                                        ‡§è‡§°‡§µ‡§æ‡§Ç‡§∏‡•ç‡§° ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡§ø‡§Ç‡§ó, ‡§Æ‡§≤‡•ç‡§ü‡•Ä-‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü, ‡§î‡§∞ ‡§∞‡§ø‡§Ø‡§≤-‡§ü‡§æ‡§á‡§Æ ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°‡•§
                                    </div>
                                </div>
                            </div>
                    
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOneTime">
                                        <strong>‡§µ‡§®-‡§ü‡§æ‡§á‡§Æ ‡§™‡•ç‡§≤‡§æ‡§® - ‚Çπ40,000</strong> (AMC: ‚Çπ15,000/‡§∏‡§æ‡§≤)
                                    </button>
                                </h2>
                                <div id="collapseOneTime" class="accordion-collapse collapse" data-bs-parent="#plansAccordion">
                                    <div class="accordion-body">
                                        ‡§™‡•ç‡§∞‡•Ä‡§Æ‡§ø‡§Ø‡§Æ ‡§™‡•ç‡§≤‡§æ‡§® ‡§ï‡•á ‡§∏‡§≠‡•Ä ‡§´‡•Ä‡§ö‡§∞‡•ç‡§∏, ‡§è‡§ï ‡§¨‡§æ‡§∞ ‡§ï‡•Ä ‡§ï‡•Ä‡§Æ‡§§ ‡§™‡§∞‡•§ (AMC ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø ‡§π‡•à)‡•§
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p class="text-muted small mt-3">*5 ‡§¶‡§ø‡§® ‡§ï‡•á ‡§ü‡•ç‡§∞‡§æ‡§Ø‡§≤ ‡§Æ‡•á‡§Ç ‡§∏‡§≠‡•Ä ‡§´‡•Ä‡§ö‡§∞‡•ç‡§∏ ‡§ï‡§æ ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§Æ‡§ø‡§≤‡§§‡§æ ‡§π‡•à‡•§</p>
                    </div>                   <div class="modal-footer">
                         <button type="button" class="btn btn-outline-secondary d-none" id="open-admin-login-from-license-btn">‡§è‡§°‡§Æ‡§ø‡§® ‡§≤‡•â‡§ó‡§ø‡§®</button>
                         <button type="submit" class="btn btn-primary" id="license-submit-btn">‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="renewalModal" tabindex="-1" aria-labelledby="renewalModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-warning border-3">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="renewalModalLabel"><i class="fas fa-exclamation-triangle"></i> ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§∞‡§ø‡§®‡•ç‡§Ø‡•Ç‡§Ö‡§≤ ‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="fs-5">‡§Ü‡§™‡§ï‡•Ä Dukan Pro ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§ï‡•Ä ‡§ú‡§≤‡•ç‡§¶ ‡§π‡•Ä ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã‡§®‡•á ‡§µ‡§æ‡§≤‡•Ä ‡§π‡•à!</p>
                    <p>‡§Ö‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ ‡§∏‡•á ‡§¨‡§ö‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§Æ‡§Ø ‡§™‡§∞ ‡§∞‡§ø‡§®‡•ç‡§Ø‡•Ç‡§Ö‡§≤ ‡§ï‡§∞‡§æ‡§è‡§Å‡•§</p>
                    <p class="fw-bold">‡§∞‡§ø‡§®‡•ç‡§Ø‡•Ç‡§Ö‡§≤ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è 7303410987 ‡§™‡§∞ WhatsApp ‡§ï‡§∞‡•á‡§Ç‡•§</p>
                    <hr>
                    <p class="mb-2 fw-bold">‡§Ü‡§™ ‡§ï‡§ø‡§§‡§®‡•á ‡§∏‡§Æ‡§Ø ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∞‡§ø‡§®‡•ç‡§Ø‡•Ç‡§Ö‡§≤ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?</p>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success" onclick="sendWhatsAppRenewal(1)">
                            <i class="fab fa-whatsapp"></i> 1 ‡§Æ‡§π‡•Ä‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•Ç‡§õ‡•á‡§Ç
                        </button>
                        <button type="button" class="btn btn-success" onclick="sendWhatsAppRenewal(6)">
                            <i class="fab fa-whatsapp"></i> 6 ‡§Æ‡§π‡•Ä‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•Ç‡§õ‡•á‡§Ç
                        </button>
                        <button type="button" class="btn btn-success" onclick="sendWhatsAppRenewal(12)">
                            <i class="fab fa-whatsapp"></i> 12 ‡§Æ‡§π‡•Ä‡§®‡•á (1 ‡§∏‡§æ‡§≤) ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•Ç‡§õ‡•á‡§Ç
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="planLockModal" tabindex="-1" aria-labelledby="planLockModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-primary border-3">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="planLockModalLabel"><i class="fas fa-lock"></i> ‡§Ø‡§π ‡§´‡•Ä‡§ö‡§∞ ‡§Ü‡§™‡§ï‡•á ‡§™‡•ç‡§≤‡§æ‡§® ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="fs-5">‡§Ø‡§π ‡§è‡§ï <strong id="plan-lock-feature-name">‡§è‡§°‡§µ‡§æ‡§Ç‡§∏‡•ç‡§°</strong> ‡§´‡•Ä‡§ö‡§∞ ‡§π‡•à ‡§ú‡•ã <strong id="plan-lock-plan-name">‡§¨‡•á‡§∏‡§ø‡§ï</strong> ‡§™‡•ç‡§≤‡§æ‡§® ‡§Æ‡•á‡§Ç ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</p>
                    <p>‡§á‡§∏ ‡§´‡•Ä‡§ö‡§∞ ‡§ï‡•ã ‡§Ö‡§®‡§≤‡•â‡§ï ‡§ï‡§∞‡§®‡•á ‡§î‡§∞ ‡§Ö‡§™‡§®‡•á ‡§¨‡§ø‡•õ‡§®‡•á‡§∏ ‡§ï‡•ã ‡§§‡•á‡§ú‡•Ä ‡§∏‡•á ‡§¨‡•ù‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§™‡•ç‡§≤‡§æ‡§® ‡§Ö‡§™‡§ó‡•ç‡§∞‡•á‡§° ‡§ï‡§∞‡•á‡§Ç‡•§</p>
                    
                    <div class="alert alert-success text-center mt-4">
                        <h5 class="alert-heading mb-0">‡§Ö‡§™‡§ó‡•ç‡§∞‡•á‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç</h5>
                        <p class="mb-0 fs-4 fw-bold"><i class="fab fa-whatsapp"></i> 7303410987</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç</button>
                    <a href="https://wa.me/7303410987?text=Hi%2C%20I%20want%20to%20upgrade%20my%20Dukan%20Pro%20plan." target="_blank" class="btn btn-success">
                        <i class="fab fa-whatsapp"></i> ‡§Ö‡§≠‡•Ä ‡§Ö‡§™‡§ó‡•ç‡§∞‡•á‡§° ‡§ï‡§∞‡•á‡§Ç
                    </a>
                </div>
            </div>
        </div>
    </div>




    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="ms-3 text-primary" id="loading-message">‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>
    </div>

    <button class="navbar-toggler locked" type="button" id="menu-toggle">
        <span class="navbar-toggler-icon"></span>
    </button>
    <nav id="sidebar" class="sidebar locked">
        <div class="p-4 d-flex flex-column h-100">
            <div class="text-center mb-3" id="shop-logo-container">
                </div>
            <h3 class="mb-4 text-white text-shadow text-center"><i class="fas fa-store me-2"></i>Dukan Pro</h3>
            
            <ul class="nav flex-column mb-auto" id="sidebar-nav">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-view="dashboard" data-role="ANY"> <i class="fas fa-home"></i> ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="stock" data-role="MANAGER"> <i class="fas fa-boxes"></i> ‡§∏‡•ç‡§ü‡•â‡§ï ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="sales" data-role="ANY"> <i class="fas fa-cash-register"></i> ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä (POS)
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="invoice-generator" data-role="ANY"> <i class="fas fa-file-invoice"></i> ‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§ú‡§®‡§∞‡•á‡§ü‡§∞ Pro
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="purchases" data-role="MANAGER"> <i class="fas fa-shopping-basket"></i> ‡§ñ‡§∞‡•Ä‡§¶
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="crm" data-role="MANAGER"> <i class="fas fa-users"></i> ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï (CRM)
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="expenses" data-role="MANAGER"> <i class="fas fa-money-bill-wave"></i> ‡§ñ‡§∞‡•ç‡§ö
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="reports" data-role="MANAGER"> <i class="fas fa-chart-line"></i> ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="gst-reports" data-role="MANAGER"> <i class="fas fa-file-alt"></i> GST ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏
                    </a>
                </li>
                <a href="#" class="list-group-item list-group-item-action bg-transparent text-danger fw-bold" onclick="renderView('daily_reports')"> <i class="fas fa-calendar-check me-2"></i> Daily Reports
                </a>

                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="bank-reconciliation" data-role="MANAGER"> <i class="fas fa-university"></i> ‡§¨‡•à‡§Ç‡§ï ‡§∞‡§ø‡§ï‡•â‡§®‡•ç‡§∏‡§ø‡§≤‡•á‡§∂‡§®
                    </a>
                </li>


                <ul class="nav nav-tabs" id="main-nav-tabs">
                    <li class="nav-item" data-role="MANAGER">
                        <a class="nav-link" href="#" data-view="ai-insights">
                            <i class="fas fa-brain me-1"></i> AI ‡§∏‡§≤‡§æ‡§π
                        </a>
                    </li>
                              
               <li class="nav-item">
                    <a href="#" class="nav-link" data-view="daily-closing" data-role="MANAGER"> <i class="fas fa-calendar-check"></i> ‡§°‡•á‡§≤‡•Ä ‡§ï‡•ç‡§≤‡•ã‡§ú‡§ø‡§Ç‡§ó
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-view="data-backup" data-role="ADMIN"> <i class="fas fa-download"></i> ‡§°‡•á‡§ü‡§æ ‡§¨‡•à‡§ï‡§Ö‡§™
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link d-none" data-view="staff" data-role="ADMIN"> <i class="fas fa-user-cog"></i> ‡§∏‡•ç‡§ü‡§æ‡§´ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®
                    </a>
                </li>
                 <li class="nav-item">
                    <a href="#" class="nav-link" data-view="shop-settings" data-role="ADMIN"> <i class="fas fa-cogs"></i> ‡§∂‡•â‡§™ ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏
                    </a>
                </li>
            </ul>
            
            <hr class="text-white-50">
            
            <div id="user-info" class="text-white-50 p-2 text-center mb-2" style="background-color: #495057; border-radius: 8px;">
                <h5 id="user-shop-name" class="text-white mb-0">Shop Name</h5>
                <small id="user-name-email">User Name (Role)</small>
            </div>

            <div id="license-timer" class="text-center text-white-50 mb-2">
                <i class="fas fa-check-circle text-success"></i> ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...
            </div>
            
            <button id="logout-btn" class="btn btn-sm btn-danger w-100"><i class="fas fa-sign-out-alt me-2"></i>‡§≤‡•â‡§ó‡§Ü‡§â‡§ü</button>
            
            <p class="text-muted mt-2 mb-0 text-center small">v1.0.3 Corrected</p>
        </div>
    </nav>

    

    <div id="main-content" class="main-content locked">
        <section id="dashboard" class="section">
            <h2 class="mb-4 text-primary">‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</h2>
            <div class="row g-4">
                <div class="col-md-6 col-lg-3">
                    <div class="card p-3 dashboard-card bg-white">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-rupee-sign fa-2x text-primary me-3"></i>
                            <div>
                                <p class="text-muted mb-0">‡§ï‡•Å‡§≤ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä (‡§∞‡•á‡§µ‡•á‡§®‡•ç‡§Ø‡•Ç)</p>
                                <h4 class="mb-0" id="total-sales-revenue">‚Çπ0.00</h4>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="card p-3 dashboard-card bg-white">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-boxes fa-2x text-warning me-3"></i>
                            <div>
                                <p class="text-muted mb-0">‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•Ç‡§≤‡•ç‡§Ø (‡§ñ‡§∞‡•Ä‡§¶)</p>
                                <h4 class="mb-0" id="total-stock-value">‚Çπ0.00</h4>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="card p-3 dashboard-card bg-white">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-users fa-2x text-success me-3"></i>
                            <div>
                                <p class="text-muted mb-0">‡§ï‡•Å‡§≤ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï</p>
                                <h4 class="mb-0" id="total-customers">0</h4>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="card p-3 dashboard-card bg-white">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle fa-2x text-danger me-3"></i>
                            <div>
                                <p class="text-muted mb-0">‡§ï‡§Æ ‡§∏‡•ç‡§ü‡•â‡§ï ‡§µ‡§æ‡§≤‡•á ‡§Ü‡§á‡§ü‡§Æ</p>
                                <h4 class="mb-0" id="low-stock-count">0</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4 g-4">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header bg-gradient-primary">‡§™‡§ø‡§õ‡§≤‡•á 30 ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§ï‡•Ä ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä</div>
                        <div class="card-body">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header bg-warning text-dark">‡§ï‡§Æ ‡§∏‡•ç‡§ü‡•â‡§ï ‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä</div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm table-striped mb-0">
                                    <thead>
                                        <tr>
                                            <th>SKU</th>
                                            <th>‡§Ü‡§á‡§ü‡§Æ</th>
                                            <th>Qty</th>
                                        </tr>
                                    </thead>
                                    <tbody id="low-stock-table-body">
                                        <tr><td colspan="3" class="text-center text-muted">‡§ï‡•ã‡§à ‡§ï‡§Æ ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Ü‡§á‡§ü‡§Æ ‡§®‡§π‡•Ä‡§Ç</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4 g-4">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header bg-success">‡§π‡§æ‡§≤ ‡§ï‡•Ä ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä</div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-striped mb-0">
                                    <thead>
                                        <tr>
                                            <th>‡§ö‡§æ‡§≤‡§æ‡§® ‡§®‡§Ç.</th>
                                            <th>‡§ó‡•ç‡§∞‡§æ‡§π‡§ï</th>
                                            <th>‡§∞‡§æ‡§∂‡§ø</th>
                                            <th>‡§§‡§ø‡§•‡§ø</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-sales-table-body">
                                        <tr><td colspan="4" class="text-center text-muted">‡§ï‡•ã‡§à ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header bg-info">‡§π‡§æ‡§≤ ‡§ï‡•á ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï</div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-striped mb-0">
                                    <thead>
                                        <tr>
                                            <th>‡§®‡§æ‡§Æ</th>
                                            <th>‡§´‡§º‡•ã‡§®</th>
                                            <th>‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-customers-table-body">
                                        <tr><td colspan="3" class="text-center text-muted">‡§ï‡•ã‡§à ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§®‡§π‡•Ä‡§Ç</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


           <!-- SALON DASHBOARD ‚Äî paste inside the main content (maybe near ai-insights or dashboard) -->
           <div id="salon-dashboard" class="salon-only biz-only" style="display:none;">
    
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="text-primary mb-0"><i class="fas fa-scissors me-2"></i>Salon Dashboard (Pro)</h2>
                
                <button class="btn btn-primary shadow" onclick="openAppointmentModal()">
                    <i class="fas fa-plus-circle me-2"></i> ‡§®‡§à ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó (New Appointment)
                </button>
            </div>
        
            <div class="row g-4 mb-4">
                <div class="col-md-6 col-lg-3">
                    <div class="card p-3 dashboard-card bg-white h-100 border-0 shadow-sm">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle p-3 bg-light me-3">
                                <i class="fas fa-rupee-sign fa-2x text-success"></i>
                            </div>
                            <div>
                                <p class="text-muted mb-0 small text-uppercase fw-bold">‡§Ü‡§ú ‡§ï‡•Ä ‡§ï‡§Æ‡§æ‡§à</p>
                                <h4 class="mb-0 fw-bold text-dark" id="salon-today-sales">‚Çπ0</h4>
                            </div>
                        </div>
                    </div>
                </div>
        
                <div class="col-md-6 col-lg-3">
                    <div class="card p-3 dashboard-card bg-white h-100 border-0 shadow-sm">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle p-3 bg-light me-3">
                                <i class="fas fa-calendar-check fa-2x text-primary"></i>
                            </div>
                            <div>
                                <p class="text-muted mb-0 small text-uppercase fw-bold">‡§Ü‡§ú ‡§ï‡•á ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï</p>
                                <h4 class="mb-0 fw-bold text-dark" id="salon-today-appts">0</h4>
                            </div>
                        </div>
                    </div>
                </div>
        
                <div class="col-md-6 col-lg-3">
                    <div class="card p-3 dashboard-card bg-white h-100 border-0 shadow-sm">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle p-3 bg-light me-3">
                                <i class="fas fa-birthday-cake fa-2x text-warning"></i>
                            </div>
                            <div>
                                <p class="text-muted mb-0 small text-uppercase fw-bold">‡§¨‡§∞‡•ç‡§•‡§°‡•á (7 ‡§¶‡§ø‡§®)</p>
                                <h4 class="mb-0 fw-bold text-dark" id="salon-birthdays-count">0</h4>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-link text-decoration-none mt-2 ps-0" onclick="openBirthdayList()">
                            ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§¶‡•á‡§ñ‡•á‡§Ç <i class="fas fa-arrow-right ms-1"></i>
                        </button>
                    </div>
                </div>
        
                <div class="col-md-6 col-lg-3">
                    <div class="card p-3 dashboard-card bg-white h-100 border-0 shadow-sm">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle p-3 bg-light me-3">
                                <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                            </div>
                            <div>
                                <p class="text-muted mb-0 small text-uppercase fw-bold">Low Stock</p>
                                <h4 class="mb-0 fw-bold text-dark" id="salon-low-stock">0</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        
            <div class="row g-4">
                
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-gradient-primary text-white border-bottom py-3">
                            <h5 class="mb-0 fw-bold"><i class="fas fa-chart-line me-2"></i>‡§™‡§ø‡§õ‡§≤‡•á 30 ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§ï‡•Ä ‡§ï‡§Æ‡§æ‡§à</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="salonSalesChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>
                </div>
        
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-white border-bottom py-3">
                            <h5 class="mb-0 fw-bold"><i class="fas fa-users me-2"></i>‡§π‡§æ‡§≤ ‡§ï‡•á ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 340px; overflow-y: auto;">
                                <table class="table table-hover mb-0 align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>‡§®‡§æ‡§Æ</th>
                                            <th>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</th>
                                            <th>‡§è‡§ï‡•ç‡§∂‡§®</th>
                                        </tr>
                                    </thead>
                                    <tbody id="salon-recent-customers-body">
                                        <tr><td colspan="3" class="text-center text-muted p-3">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div id="universal-modules-container" class="mb-4">

            <div id="module-optical-eye-test" class="biz-module card shadow-sm border-dark mb-4" style="display:none;">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-glasses me-2"></i>Eye Prescription (‡§®‡§Ç‡§¨‡§∞)</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered text-center align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Eye</th>
                                    <th>SPH (Spherical)</th>
                                    <th>CYL (Cylindrical)</th>
                                    <th>AXIS</th>
                                    <th>ADD (Near)</th>
                                    <th>VA (Vision)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="fw-bold text-primary">Right (OD)</td>
                                    <td><input type="text" class="form-control form-control-sm text-center" placeholder="+/-"></td>
                                    <td><input type="text" class="form-control form-control-sm text-center" placeholder="+/-"></td>
                                    <td><input type="number" class="form-control form-control-sm text-center" placeholder="Deg"></td>
                                    <td><input type="text" class="form-control form-control-sm text-center" placeholder="Near"></td>
                                    <td><input type="text" class="form-control form-control-sm text-center" placeholder="6/6"></td>
                                </tr>
                                <tr>
                                    <td class="fw-bold text-primary">Left (OS)</td>
                                    <td><input type="text" class="form-control form-control-sm text-center" placeholder="+/-"></td>
                                    <td><input type="text" class="form-control form-control-sm text-center" placeholder="+/-"></td>
                                    <td><input type="number" class="form-control form-control-sm text-center" placeholder="Deg"></td>
                                    <td><input type="text" class="form-control form-control-sm text-center" placeholder="Near"></td>
                                    <td><input type="text" class="form-control form-control-sm text-center" placeholder="6/6"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="row g-2 mt-2">
                        <div class="col-md-6">
                            <label class="small fw-bold">Lens Type</label>
                            <select class="form-select form-select-sm">
                                <option>Single Vision</option>
                                <option>Bifocal (Kryptok/D)</option>
                                <option>Progressive</option>
                                <option>Blue Cut / Anti-Glare</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="small fw-bold">PD (Pupillary Distance)</label>
                            <input type="text" class="form-control form-control-sm" placeholder="e.g. 62mm">
                        </div>
                    </div>
                </div>
            </div>
        
            <div id="module-prescription-pad" class="biz-module card shadow-sm border-primary mb-4" style="display:none;">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-user-md me-2"></i><span id="medical-title-text">Medical Report</span></h5>
                    <div id="pregnancy-badge" style="display:none;">
                        <span class="badge bg-warning text-dark">EDD: <span id="disp_edd">--</span></span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-2 mb-3">
                        <div class="col-md-4">
                            <label class="small fw-bold">Patient ID/Name</label>
                            <div class="input-group input-group-sm">
                                <input type="text" id="medical_patient_search" class="form-control" placeholder="Search...">
                                <button class="btn btn-outline-secondary"><i class="fas fa-search"></i></button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="small fw-bold">Ref. Doctor</label>
                            <input type="text" id="med_ref_doc" class="form-control form-control-sm" placeholder="Dr. Name">
                        </div>
                        <div class="col-md-4" id="box-lmp-calc" style="display:none;">
                            <label class="small fw-bold text-danger">LMP Date</label>
                            <div class="input-group input-group-sm">
                                <input type="date" id="med_lmp_date" class="form-control">
                                <button class="btn btn-danger" onclick="calculateEDD()">Calc</button>
                            </div>
                        </div>
                    </div>
        
                    <div class="mb-2">
                        <label class="small fw-bold">Templates:</label>
                        <div id="medical-template-buttons" class="d-flex flex-wrap gap-2"></div>
                    </div>
        
                    <textarea id="medical_report_editor" class="form-control p-3" rows="8" 
                        style="font-family: monospace; font-size: 14px; border: 2px solid #ccc; background:#f9f9f9;"
                        placeholder="Report content goes here..."></textarea>
                    
                    <div id="box-dentist-chart" class="mt-3 border p-2 bg-light rounded" style="display:none;">
                        <small class="fw-bold d-block mb-1">Select Teeth for Procedure:</small>
                        <div id="teeth-container" class="d-flex flex-wrap justify-content-center gap-1"></div>
                    </div>
        
                    <div class="text-end mt-2">
                        <button class="btn btn-success btn-sm" onclick="saveMedicalReport()"><i class="fas fa-print"></i> Save & Print</button>
                    </div>
                </div>
            </div>
        
            <div id="module-imei-scan" class="biz-module card shadow-sm border-secondary mb-4" style="display:none;">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-mobile-alt me-2"></i>Mobile Operations</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="small fw-bold">New Sale (Scan IMEI)</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-barcode"></i></span>
                                <input type="text" id="item_imei" class="form-control" placeholder="Scan Box IMEI...">
                                <button class="btn btn-dark">Add to Bill</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="small fw-bold">Service Center</label>
                            <button class="btn btn-outline-dark w-100"><i class="fas fa-tools"></i> Create Job Card</button>
                        </div>
                    </div>
                </div>
            </div>
        
            <div id="module-furniture-showroom" class="biz-module card shadow-sm border-warning mb-4" style="display:none;">
                <div class="card-header bg-warning text-dark">
                    <h5><i class="fas fa-truck"></i> Delivery Tracker (‡§∂‡•á‡§°‡•ç‡§Ø‡•Ç‡§≤ ‡§ï‡§∞‡•á‡§Ç)</h5>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-6">
                            <input type="text" id="furn_invoice_id" class="form-control form-control-sm" placeholder="Invoice ID (e.g. 64)">
                        </div>
                        <div class="col-6">
                            <input type="date" id="furn_delivery_date" class="form-control form-control-sm">
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="furn_assembly">
                                <label class="form-check-label small">Assembly Required (‡§Æ‡§ø‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä ‡§ö‡§æ‡§π‡§ø‡§è?)</label>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-warning w-100 mt-2" onclick="scheduleFurnitureDelivery()">
                        <i class="fas fa-save"></i> Schedule Delivery
                    </button>
                </div>
            </div>

            <div id="hardware-delivery-box" class="biz-module mt-3 border-top pt-2" style="display:none;">
                <h6 class="text-dark small fw-bold">
                    <i class="fas fa-truck-loading"></i> Pending Deliveries (‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä ‡§≤‡§ø‡§∏‡•ç‡§ü)
                    <button class="btn btn-sm btn-link float-end p-0" onclick="loadDeliveryList()">Refresh</button>
                </h6>
                
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd;">
                    <table class="table table-sm table-bordered small mb-0 bg-white">
                        <thead class="table-secondary sticky-top">
                            <tr>
                                <th>Invoice / Item</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th style="width: 50px;">Action</th> </tr>
                            </tr>
                        </thead>
                        <tbody id="delivery-list-final">
                            <tr><td colspan="3" class="text-center text-muted">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="module-hotel-management" class="biz-module card shadow-sm border-danger mb-4" style="display:none;">
                <div class="card-header bg-danger text-white"><h5><i class="fas fa-hotel"></i> Hotel Front Desk</h5></div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label class="small fw-bold">Room No</label>
                            <input type="text" id="hotel_room_select" class="form-control form-control-sm" placeholder="e.g. 101">
                        </div>
                        <div class="col-md-4">
                            <label class="small fw-bold">Guest Name</label>
                            <input type="text" id="hotel_guest_name" class="form-control form-control-sm">
                        </div>
                        <div class="col-md-4">
                            <label class="small fw-bold">Mobile</label>
                            <input type="number" id="hotel_guest_mobile" class="form-control form-control-sm">
                        </div>
                        <div class="col-md-6">
                            <label class="small fw-bold">Check-In Date</label>
                            <input type="date" id="hotel_checkin_date" class="form-control form-control-sm">
                        </div>
                        <div class="col-md-6">
                            <label class="small fw-bold">Advance Payment (‚Çπ)</label>
                            <input type="number" id="hotel_advance" class="form-control form-control-sm">
                        </div>
                    </div>
                    <button class="btn btn-danger w-100 mt-3" onclick="processHotelCheckIn()">
                        <i class="fas fa-key"></i> Check-In Guest
                    </button>
                </div>
            </div>

            <div id="hotel-room-status-section" class="biz-module mt-4" style="display:none;">
    
                <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
                    <h6 class="fw-bold text-secondary mb-0">
                        <i class="fas fa-bed"></i> Room Status (Live)
                    </h6>
                    <div>
                        <button class="btn btn-sm btn-outline-dark me-2" onclick="setupHotelRooms()" title="Create 10 dummy rooms">
                            <i class="fas fa-magic"></i> Auto Setup
                        </button>
                        
                        <button class="btn btn-sm btn-primary shadow-sm" onclick="addRoomManually()" title="Add a specific room">
                            <i class="fas fa-plus-circle"></i> Add Room
                        </button>
                    </div>
                </div>
            
                <div id="hotel-room-list" class="row g-3" style="max-height: 450px; overflow-y: auto; padding: 4px;">
                    
                    <div class="col-12 text-center text-muted mt-5">
                        <div class="spinner-border text-secondary" role="status"></div>
                        <p class="mt-2 small">Loading Room Status...</p>
                    </div>
            
                </div>
            </div>

           
            <div id="module-paint-mixer" class="biz-module card shadow-sm border-primary mb-4" style="display:none;">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-fill-drip me-2"></i> Paint Color Mixer (Diary)</h5>
                    <span class="badge bg-white text-primary">Live</span>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-12">
                            <input type="text" id="paint_cust_name" class="form-control form-control-sm" placeholder="Customer Name (‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ)">
                        </div>
            
                        <div class="col-6">
                            <input type="text" id="paint_code" class="form-control form-control-sm" placeholder="Color Code (e.g. 9012)">
                        </div>
            
                        <div class="col-6">
                            <input type="text" id="paint_base" class="form-control form-control-sm" placeholder="Base Product (e.g. Apex)">
                        </div>
            
                        <div class="col-12">
                            <label class="small fw-bold text-muted">Formula / Notes:</label>
                            <textarea id="paint_formula" class="form-control form-control-sm" rows="2" placeholder='Example: Red-20ml, Yellow-5ml (Machine 2)'></textarea>
                        </div>
                    </div>
            
                    <button class="btn btn-primary w-100 mt-3" onclick="savePaintFormula()">
                        <i class="fas fa-save me-1"></i> Save Formula
                    </button>
                    
                    <div class="mt-4">
                        <h6 class="text-secondary border-bottom pb-2 mb-2" style="font-size: 0.9rem; font-weight: 600;">
                            <i class="fas fa-history me-1"></i> ‡§π‡§æ‡§≤ ‡§π‡•Ä ‡§Æ‡•á‡§Ç ‡§Æ‡§ø‡§ï‡•ç‡§∏ ‡§ï‡§ø‡§è ‡§ó‡§è (Recent Mixes)
                        </h6>
                        
                        <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                            <table class="table table-sm table-bordered table-striped mb-0" style="font-size: 0.8rem;">
                                <thead class="table-light">
                                    <tr>
                                        <th>‡§§‡§æ‡§∞‡•Ä‡§ñ</th>
                                        <th>‡§ó‡•ç‡§∞‡§æ‡§π‡§ï</th>
                                        <th>‡§∂‡•á‡§° / ‡§¨‡•á‡§∏</th>
                                        <th>‡§´‡§æ‡§∞‡•ç‡§Æ‡•Ç‡§≤‡§æ</th>
                                    </tr>
                                </thead>
                                <tbody id="paint-history-body">
                                    <tr><td colspan="4" class="text-center text-muted">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    </div>
            </div>
            
            <div id="module-repair-job" class="biz-module card shadow-sm border-dark mb-4" style="display:none;">
                <div class="card-header bg-dark text-white"><h5><i class="fas fa-tools"></i> Repair Job Card</h5></div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-6"><input type="text" id="repair_customer" class="form-control form-control-sm" placeholder="Customer Name"></div>
                        <div class="col-6"><input type="text" id="repair_mobile" class="form-control form-control-sm" placeholder="Mobile"></div>
                        <div class="col-6">
                            <input type="text" id="repair_invoice_id" class="form-control form-control-sm" placeholder="Original Bill No (Optional)">
                        </div>
                        <div class="col-6"><input type="text" id="repair_device" class="form-control form-control-sm" placeholder="Device Model"></div>
                        <div class="col-6"><input type="text" id="repair_imei" class="form-control form-control-sm" placeholder="IMEI / Serial"></div>
                        <div class="col-12"><textarea id="repair_issue" class="form-control form-control-sm" placeholder="Problem Description"></textarea></div>
                        <div class="col-6"><input type="number" id="repair_cost" class="form-control form-control-sm" placeholder="Est. Cost"></div>
                        <div class="col-6"><input type="number" id="repair_advance" class="form-control form-control-sm" placeholder="Advance"></div>
                    </div>
                    <button class="btn btn-warning w-100 mt-2" onclick="createRepairJob()">Generate Job Card</button>
                </div>
            </div>
        
            <div id="module-restaurant-kot" class="biz-module card shadow-sm border-warning mb-4" style="display:none;">

                <button class="btn btn-dark btn-sm w-100 mb-3" onclick="enableKitchenMode()">
                    <i class="fas fa-tv"></i> Switch to Kitchen Display Screen
                </button>
    
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold"><i class="fas fa-utensils me-2"></i> KOT Manager</h5>
                </div>
                
                <div class="card-body">
                    
                    <div class="mb-4 p-3 bg-light border rounded shadow-sm">
                        <label class="fw-bold text-dark mb-2 d-block">
                            <i class="fas fa-bullseye text-primary"></i> Order For (‡§ë‡§∞‡•ç‡§°‡§∞ ‡§ï‡§ø‡§∏‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡•à?):
                        </label>
                        
                        <div class="d-flex gap-4 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="orderType" id="type_table" value="table" checked onchange="toggleOrderSource()" style="cursor: pointer; transform: scale(1.3);">
                                <label class="form-check-label fw-bold text-dark ms-2" for="type_table" style="cursor: pointer; font-size: 1.1rem;">
                                    üçΩÔ∏è Table (Restaurant)
                                </label>
                            </div>
                            
                            <div class="form-check ms-2 border-start border-secondary ps-4">
                                <input class="form-check-input" type="radio" name="orderType" id="type_room" value="room" onchange="toggleOrderSource()" style="cursor: pointer; transform: scale(1.3);">
                                <label class="form-check-label fw-bold text-danger ms-2" for="type_room" style="cursor: pointer; font-size: 1.1rem;">
                                    üõéÔ∏è Room Service
                                </label>
                            </div>
                        </div>

                        <div class="mb-2">
                            <label class="small fw-bold text-muted">Order Taken By (‡§µ‡•á‡§ü‡§∞):</label>
                            <select id="waiter_select" class="form-select form-select-sm fw-bold">
                                <option value="Self">-- Select Name --</option>
                                <option value="Ramesh">Ramesh</option>
                                <option value="Suresh">Suresh</option>
                                <option value="Mahesh">Mahesh</option>
                                <option value="Raju">Raju</option>
                                <option value="Deepak">Deepak</option>
                                </select>
                        </div>
            
                        <label class="small text-muted fw-bold mb-1" id="order_hint">Select Location:</label>
                        <select id="rest_table_select" class="form-select form-select-lg border-primary fw-bold shadow-sm" style="height: 50px; font-size: 1.1rem;">
                            <option value="">-- Loading List... --</option>
                        </select>
                    </div>
                    <div class="position-relative mb-3">
                        <label class="small fw-bold text-muted">‡§Ü‡§á‡§ü‡§Æ ‡§ñ‡•ã‡§ú‡•á‡§Ç (Search Item)</label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-white"><i class="fas fa-search text-primary"></i></span>
                            <input type="text" id="kot-search-input" class="form-control fw-bold" 
                                   placeholder="‡§°‡§ø‡§∂ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡•á‡§Ç..." 
                                   autocomplete="off" 
                                   onclick="handleKotSearch(true)" 
                                   oninput="handleKotSearch(false)">
                        </div>
                        <ul id="kot-search-results" class="list-group position-absolute w-100 shadow start-0" 
                            style="z-index: 1050; max-height: 250px; overflow-y: auto; display:none; top: 100%;">
                        </ul>
                    </div>
                    
                    <div class="bg-white p-2 border rounded mb-3 shadow-sm" style="min-height: 100px;">
                        <h6 class="small fw-bold text-secondary border-bottom pb-1 mb-2">Selected Items (‡§ë‡§∞‡•ç‡§°‡§∞ ‡§≤‡§ø‡§∏‡•ç‡§ü):</h6>
                        <div id="kot-added-list">
                            <div class="text-center text-muted small mt-3 p-3 bg-light rounded">
                                <i class="fas fa-basket-shopping fa-2x mb-2 text-secondary"></i><br>
                                ‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§Ü‡§á‡§ü‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§ö‡•Å‡§®‡§æ
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-success btn-lg w-100 fw-bold shadow" onclick="sendKotToKitchen()">
                        <i class="fas fa-paper-plane me-2"></i> Send to Kitchen
                    </button>
            
                    <div class="mt-4 pt-3 border-top border-2">
                        <h5 class="fw-bold text-dark mb-3">
                            <i class="fas fa-fire text-danger"></i> Active Orders (Running)
                        </h5>
                        <div id="active-kot-list" class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
                            <div class="text-center text-muted p-4 fs-5 bg-light rounded border">
                                No active orders
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary w-100 mt-3 fw-bold shadow-sm" onclick="transferTableToPOS()">
                        <i class="fas fa-file-invoice-dollar me-2"></i> Create Final Bill (POS)
                    </button>
                </div>
            </div>


            <div id="standalone-kitchen-view" class="mt-3 border-top pt-3" style="display:none;">
                <h5 class="fw-bold text-dark mb-3">
                    <i class="fas fa-fire text-danger"></i> Active Orders (Kitchen)
                </h5>
                
                <div id="active-kot-list-kitchen" class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center text-muted p-4 fs-5">No active orders</div>
                </div>
            </div>

            <div id="module-school-fees" class="biz-module card shadow-sm border-info mb-4" style="display:none;">
                <div class="card-header bg-info text-white"><h5><i class="fas fa-graduation-cap"></i> School Fee Counter</h5></div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-8">
                            <label class="small fw-bold">Student ID / Roll No</label>
                            <input type="text" id="school_student_id" class="form-control form-control-sm" placeholder="Enter ID">
                        </div>
                        <div class="col-4">
                            <label class="small fw-bold">Amount (‚Çπ)</label>
                            <input type="number" id="school_fee_amount" class="form-control form-control-sm">
                        </div>
                        <div class="col-12">
                            <label class="small fw-bold">For Month</label>
                            <select id="school_fee_month" class="form-select form-select-sm">
                                <option value="JAN">January</option><option value="FEB">February</option>
                                <option value="MAR">March</option><option value="APR">April</option>
                                <option value="MAY">May</option><option value="JUN">June</option>
                                </select>
                        </div>
                    </div>
                    <button class="btn btn-info text-white w-100 mt-2" onclick="processSchoolFee()">
                        <i class="fas fa-receipt"></i> Collect Fee
                    </button>
                </div>
            </div>
        
            <div id="module-tailor-measurements" class="biz-module card shadow-sm border-secondary mb-4" style="display:none;">
                <div class="card-header bg-secondary text-white"><h5><i class="fas fa-cut"></i> Measurements</h5></div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-12"><input type="text" id="tailor_cust_id" class="form-control form-control-sm" placeholder="Customer ID"></div>
                        <div class="col-6"><select id="tailor_item_type" class="form-select form-select-sm"><option>Shirt</option><option>Pant</option><option>Suit</option></select></div>
                        <div class="col-6"><input type="date" id="tailor_delivery" class="form-control form-control-sm"></div>
                        
                        <div class="col-3"><input type="text" id="tm_length" class="form-control form-control-sm" placeholder="Len"></div>
                        <div class="col-3"><input type="text" id="tm_waist" class="form-control form-control-sm" placeholder="Waist"></div>
                        <div class="col-3"><input type="text" id="tm_chest" class="form-control form-control-sm" placeholder="Chest"></div>
                        <div class="col-3"><input type="text" id="tm_shoulder" class="form-control form-control-sm" placeholder="Shldr"></div>
                        
                        <div class="col-12"><input type="text" id="tm_notes" class="form-control form-control-sm" placeholder="Special Notes"></div>
                    </div>
                    <button class="btn btn-secondary w-100 mt-2" onclick="saveTailorMeasurements()">Save Measurements</button>
                </div>
            </div>

            <div id="module-gym-access" class="biz-module card shadow-sm border-dark mb-4" style="display:none;">
                <div class="card-header bg-dark text-white"><h5><i class="fas fa-dumbbell"></i> Gym Access</h5></div>
                <div class="card-body">
                    <div class="input-group mb-3">
                        <input type="text" id="gym_member_id" class="form-control" placeholder="Member ID / Phone">
                        <button class="btn btn-success" onclick="markGymAttendance()">Mark Attendance</button>
                    </div>
                    <small class="text-muted">Diet Plan feature coming soon.</small>
                </div>
            </div>
        
            <div id="module-transport-trip" class="biz-module card shadow-sm border-secondary mb-4" style="display:none;">
                <div class="card-header bg-secondary text-white"><h5><i class="fas fa-truck-moving"></i> Trip Manager</h5></div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-6"><input type="text" id="trans_vehicle" class="form-control form-control-sm" placeholder="Vehicle No"></div>
                        <div class="col-6"><input type="text" id="trans_driver" class="form-control form-control-sm" placeholder="Driver Name"></div>
                        <div class="col-6"><input type="text" id="trans_start" class="form-control form-control-sm" placeholder="Start Location"></div>
                        <div class="col-6"><input type="text" id="trans_end" class="form-control form-control-sm" placeholder="End Location"></div>
                        <div class="col-6"><input type="number" id="trans_freight" class="form-control form-control-sm" placeholder="Freight Rate (‚Çπ)"></div>
                        <div class="col-6"><input type="number" id="trans_advance" class="form-control form-control-sm" placeholder="Advance Given"></div>
                        <div class="col-12"><button class="btn btn-dark w-100 btn-sm" onclick="createTransportTrip()">Create New Trip</button></div>
                    </div>
                </div>
            </div>

        <div id="module-security-panel" class="biz-module card shadow-sm border-danger mb-4" style="display:none;">
            <div class="card-header bg-danger text-white d-flex justify-content-between">
                <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Store Security & Anti-Theft</h5>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="security-arm-switch" onchange="toggleSecurityMode()">
                    <label class="form-check-label text-white" for="security-arm-switch">System ARMED</label>
                </div>
            </div>
            <div class="card-body text-center">
                
                <div class="row">
                    <div class="col-md-6">
                        <p class="small fw-bold">Live Gate Camera</p>
                        <video id="security-video" width="100%" autoplay style="border: 2px solid red; border-radius: 5px;"></video>
                    </div>
                    <div class="col-md-6">
                        <p class="small fw-bold">Last Security Alert</p>
                        <canvas id="security-canvas" style="display:none;"></canvas>
                        <img id="thief-photo-display" src="" class="img-fluid border border-dark" style="min-height: 150px; background: #eee;">
                        <p id="alert-timestamp" class="text-danger fw-bold mt-2"></p>
                    </div>
                </div>
        
                <div id="security-status-box" class="alert alert-secondary mt-3">
                    System is Idle. Waiting for RFID Signal...
                </div>
        
                <button class="btn btn-outline-dark btn-sm mt-2" onclick="testAlarm()">üîî Test Alarm (Demo)</button>
            </div>
        </div>

        <div id="module-paint-estimator" class="biz-module card shadow-sm border-warning mb-4" style="display:none;">
            <div class="card-header bg-warning text-dark d-flex justify-content-between">
                <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Paint Budget Estimator</h5>
                <small>Area Input</small>
            </div>
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label class="fw-bold">Area (Square Feet)</label>
                        <input type="number" id="est-area" class="form-control" placeholder="e.g. 500 (10x50 wall)">
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-dark w-100" onclick="calculatePaintEstimate()">
                            <i class="fas fa-magic"></i> Calculate
                        </button>
                    </div>
                </div>
                
                <div id="est-result" class="mt-3 p-3 bg-light border rounded d-none">
                    <table class="table table-sm table-bordered mb-0 bg-white">
                        <thead class="table-dark"><tr><th>Item</th><th>Quantity (Approx)</th></tr></thead>
                        <tbody>
                            <tr><td>Putty (2 Coats)</td><td id="res-putty" class="fw-bold">-</td></tr>
                            <tr><td>Primer (1 Coat)</td><td id="res-primer" class="fw-bold">-</td></tr>
                            <tr><td>Paint (2 Coats)</td><td id="res-paint" class="fw-bold">-</td></tr>
                        </tbody>
                    </table>
                    <button class="btn btn-sm btn-outline-success w-100 mt-2" onclick="printEstimate()"><i class="fas fa-print"></i> Print Quote for Customer</button>
                </div>
            </div>
        </div>



        </section>





        <section id="stock" class="section">
            <h2 class="mb-4 text-primary">‡§∏‡•ç‡§ü‡•â‡§ï ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®</h2>
            <div class="card mb-4">
                <div class="card-header">‡§®‡§Ø‡§æ ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</div>
                <div class="card-body">
                    <form id="add-stock-form" class="row g-3">


                        <input type="hidden" id="stock-action-type" value="add">
                        <div class="col-md-3">
                            <label for="stock-sku" class="form-label">SKU / ‡§ï‡•ã‡§°</label>
                            <input type="text" class="form-control" id="stock-sku" required>
                        </div>
                        <div class="col-md-5">
                            <label for="stock-name" class="form-label">‡§Ü‡§á‡§ü‡§Æ ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
                            <input type="text" class="form-control" id="stock-name" required>
                        </div>
                        <div class="col-md-2">
                            <label for="stock-quantity" class="form-label">‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (Qty)</label>
                            <input type="number" class="form-control" id="stock-quantity" required min="0">
                        </div>
                        <div class="col-md-2">
                            <label for="stock-unit" class="form-label">‡§á‡§ï‡§æ‡§à (Unit)</label>
                            <input type="text" class="form-control" id="stock-unit" placeholder="‡§ú‡•à‡§∏‡•á: Bottle, Pcs, ml" required>
                        </div>
                      <div class="col-md-3">
                            <label for="stock-purchase-price" class="form-label">‡§ñ‡§∞‡•Ä‡§¶ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø (‚Çπ)</label>
                            <input type="number" step="0.01" class="form-control" id="stock-purchase-price" required min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="stock-sale-price" class="form-label">‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§Æ‡•Ç‡§≤‡•ç‡§Ø (‚Çπ)</label>
                            <input type="number" step="0.01" class="form-control" id="stock-sale-price" required min="0">
                        </div>
                        <div class="col-md-2" id="stock-duration-div" style="display:none;"> 
                            <label for="stock-duration" class="form-label">‡§∏‡§Æ‡§Ø (Min)</label>
                            <input type="number" class="form-control" id="stock-duration" placeholder="e.g. 30">
                        </div>
                        <div class="col-md-3">
                            <label for="stock-gst" class="form-label">GST (%)</label>
                            <input type="number" step="0.01" class="form-control" id="stock-gst" value="0" min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="stock-hsn-code" class="form-label">HSN ‡§ï‡•ã‡§° (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)</label>
                            <input type="text" class="form-control" id="stock-hsn-code">
                        </div>
                        <hr class="my-3 col-12">
                        <h6 class="col-12 text-info small">**‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§µ‡§ø‡§µ‡§∞‡§£ (Optional)**</h6>
                        <p class="col-12 text-muted small">Chasme ke liye (SPH, CYL) ya Jooton ke liye (Color, Size) jaise extra field yahaan jodein.</p>
                        
                        <div id="prescription-fields-container" class="col-12" style="display: none;">
                            
                            <div class="row g-3">
                                
                                <div class="col-md-6">
                                    <h6 class="text-center text-primary" style="font-size: 0.9rem;">Right Eye (RE) - ‡§¶‡§æ‡§à‡§Ç ‡§Ü‡§Å‡§ñ</h6>
                                    <table class="table table-bordered table-sm text-center">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="font-size: 0.8rem;"></th>
                                                <th style="font-size: 0.8rem;">SPH</th>
                                                <th style="font-size: 0.8rem;">CYL</th>
                                                <th style="font-size: 0.8rem;">AXLS</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="fw-bold" style="font-size: 0.8rem;">Distance (‡§¶‡•Ç‡§∞)</td>
                                                
                                                <td><input type="text" inputmode="text" class="form-control form-control-sm" id="stock_sph_od_dist"></td>
                                                <td><input type="text" inputmode="text" class="form-control form-control-sm" id="stock_cyl_od_dist"></td>
                                                <td><input type="text" inputmode="text" class="form-control form-control-sm" id="stock_axs_od_dist"></td>
                                            </tr>
                                            <tr>
                                                <td class="fw-bold" style="font-size: 0.8rem;">Near (‡§®‡•õ‡§¶‡•Ä‡§ï)</td>
                                                
                                                <td><input type="text" inputmode="text" class="form-control form-control-sm" id="stock_sph_od_near"></td>
                                                <td><input type="text" inputmode="text" class="form-control form-control-sm" id="stock_cyl_od_near"></td>
                                                <td><input type="text" inputmode="text" class="form-control form-control-sm" id="stock_axs_od_near"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                        
                                <div class="col-md-6">
                                    <h6 class="text-center text-primary" style="font-size: 0.9rem;">Left Eye (LE) - ‡§¨‡§æ‡§à‡§Ç ‡§Ü‡§Å‡§ñ</h6>
                                    <table class="table table-bordered table-sm text-center">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="font-size: 0.8rem;"></th>
                                                <th style="font-size: 0.8rem;">SPH</th>
                                                <th style="font-size: 0.8rem;">CYL</th>
                                                <th style="font-size: 0.8rem;">AXLS</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="fw-bold" style="font-size: 0.8rem;">Distance (‡§¶‡•Ç‡§∞)</td>
                                                
                                                <td><input type="text" inputmode="text" class="form-control form-control-sm" id="stock_sph_os_dist"></td>
                                                <td><input type="text" inputmode="text" class="form-control form-control-sm" id="stock_cyl_os_dist"></td>
                                                <td><input type="text" inputmode="text" class="form-control form-control-sm" id="stock_axs_os_dist"></td>
                                            </tr>
                                            <tr>
                                                <td class="fw-bold" style="font-size: 0.8rem;">Near (‡§®‡•õ‡§¶‡•Ä‡§ï)</td>
                                                
                                                <td><input type="text" inputmode="text" class="form-control form-control-sm" id="stock_sph_os_near"></td>
                                                <td><input type="text" inputmode="text" class="form-control form-control-sm" id="stock_cyl_os_near"></td>
                                                <td><input type="text" inputmode="text" class="form-control form-control-sm" id="stock_axs_os_near"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div> <div class="text-center mt-3">
                                <h4 style="font-weight: bold; color: #444; letter-spacing: 2px;">ADD</h4>
                            </div>
                            </div> <div class="col-12">
                            <button type="button" class="btn btn-sm btn-outline-info" id="add-custom-field-btn">
                                <i class="fas fa-plus me-1"></i> Naya Field Jodein (Optical)
                            </button>
                        </div>

                        <div id="module-tiles-calc" class="biz-module col-12 border p-3 bg-light rounded mt-2" style="display:none;">
                            <h6 class="text-secondary small fw-bold"><i class="fas fa-th me-2"></i> Tiles/Ceramic Coverage Details</h6>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="small fw-bold">Coverage (Sq.Ft per Box)</label>
                                    <input type="number" id="stock-sqft-per-box" class="form-control form-control-sm" placeholder="e.g. 16">
                                </div>
                                <div class="col-md-4">
                                    <label class="small fw-bold">Pieces per Box</label>
                                    <input type="number" id="stock-pcs-per-box" class="form-control form-control-sm" placeholder="e.g. 4">
                                </div>
                                <div class="col-md-4">
                                    <label class="small fw-bold">Breakage Rate (%)</label>
                                    <input type="number" id="stock-breakage" class="form-control form-control-sm" value="0">
                                </div>
                            </div>
                        </div>
                        
                        <div id="module-rental-stock" class="biz-module col-12 border p-3 bg-warning bg-opacity-10 rounded mt-2 border-warning" style="display:none;">
                            <h6 class="text-dark small fw-bold"><i class="fas fa-campground me-2"></i> Rental / Tent Settings</h6>
                            <div class="row g-2 align-items-end">
                                <div class="col-md-4">
                                    <label class="small fw-bold">Security Deposit (‚Çπ)</label>
                                    <input type="number" id="rental-security" class="form-control form-control-sm" placeholder="Per Item">
                                </div>
                                <div class="col-md-4">
                                    <label class="small fw-bold">Rent Per Day (‚Çπ)</label>
                                    <input type="number" id="rental-daily-price" class="form-control form-control-sm" placeholder="Daily Charge">
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="rental-is-active" checked>
                                        <label class="form-check-label small fw-bold">Available for Rent</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    
<hr class="my-3 col-12">


                        <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-primary w-100">‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•á‡§Ç ‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§∏‡•ç‡§ü‡•â‡§ï ‡§∏‡•Ç‡§ö‡•Ä</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>SKU</th>
                                    <th>‡§Ü‡§á‡§ü‡§Æ</th>
                                    <th>Qty</th>
                                    <th>‡§ñ‡§∞‡•Ä‡§¶ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø</th>
                                    <th>‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§Æ‡•Ç‡§≤‡•ç‡§Ø</th>
                                    <th>GST %</th>
                                    <th>Last Updated</th>
                                    <th>‡§è‡§ï‡•ç‡§∂‡§®</th> 
                                </tr>
                            </thead>
                            <tbody id="stock-table-body">
                                <tr><td colspan="8" class="text-center text-muted">‡§ï‡•ã‡§à ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Ü‡§á‡§ü‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ</td></tr>
                            </tbody>
                            <tfoot id="stock-table-foot"></tfoot> 
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="sales" class="section">
            <h2 class="mb-4 text-primary">‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä (‡§™‡•â‡§á‡§Ç‡§ü ‡§ë‡§´ ‡§∏‡•á‡§≤)</h2>
            <div class="row g-4">
                <div class="col-lg-5"> <div class="card">
                        <div class="card-header">‡§®‡§Ø‡§æ ‡§ö‡§æ‡§≤‡§æ‡§® ‡§¨‡§®‡§æ‡§è‡§Ç</div>
                        <div class="card-body">
                            <form id="pos-form">
                                <div class="mb-3">
                                    <label for="pos-customer" class="form-label">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
                                    <input type="text" class="form-control" id="pos-customer" list="customer-datalist" placeholder="‡§Ö‡§®‡§æ‡§Æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§Ø‡§æ ‡§®‡§æ‡§Æ ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç">
                                    <datalist id="customer-datalist"></datalist>
                                </div>
                                <div class="row g-2 mb-3 p-2 bg-light border rounded paint-only biz-only">
                                    <div class="col-md-6">
                                        <label class="small fw-bold text-primary"><i class="fas fa-brush"></i> ‡§™‡•á‡§Ç‡§ü‡§∞ (‡§ï‡§Æ‡•Ä‡§∂‡§® ‡§ï‡•á ‡§≤‡§ø‡§è)</label>
                                        
                                        <div class="input-group input-group-sm mb-2">
                                            <select id="pos-painter-select" class="form-select">
                                                <option value="" selected>-- Select Painter --</option>
                                            </select>
                                            <button class="btn btn-outline-primary" type="button" onclick="addNewPainterPrompt()" title="‡§®‡§Ø‡§æ ‡§™‡•á‡§Ç‡§ü‡§∞ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            <button class="btn btn-outline-dark" type="button" onclick="viewSelectedPainterLedger()" title="‡§π‡§ø‡§∏‡§æ‡§¨ (Ledger) ‡§¶‡•á‡§ñ‡•á‡§Ç">
                                                <i class="fas fa-file-invoice-dollar"></i> ‡§π‡§ø‡§∏‡§æ‡§¨
                                            </button>
                                        </div>
                                
                                        <input type="tel" id="pos-painter-mobile" class="form-control form-control-sm mb-2" placeholder="‡§™‡•á‡§Ç‡§ü‡§∞ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ (Optional)">
                                        
                                        <div class="d-flex align-items-center gap-1 p-1 border border-success rounded bg-white">
                                            <label class="small fw-bold text-success mb-0 me-1">‡§ï‡§Æ‡•Ä‡§∂‡§®:</label>
                                            <select class="form-select form-select-sm border-success" id="pos-commission-mode" style="width: 70px;">
                                                <option value="PERCENT" selected>%</option> 
                                                <option value="FLAT">‚Çπ</option>       
                                            </select>
                                            <input type="number" class="form-control form-control-sm border-success" id="pos-commission-value" placeholder="Ex: 2 or 100">
                                        </div>
                                    </div>
                                
                                    <div class="col-md-6">
                                        <label class="small fw-bold text-danger"><i class="fas fa-fill-drip"></i> ‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§Æ‡§ø‡§ï‡•ç‡§∏‡§ø‡§Ç‡§ó (Rate Fixer)</label>
                                        <button type="button" class="btn btn-sm btn-danger w-100" style="height: 100px;" data-bs-toggle="modal" data-bs-target="#paintMixingModal">
                                            <i class="fas fa-vial fa-2x mb-2"></i><br> Base + Colorant <br>‡§ú‡•ã‡§°‡§º‡•á‡§Ç
                                        </button>
                                    </div>
                                </div>       
                                <div class="mb-3">
                                    <label for="pos-customer-mobile" class="form-label">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞</label>
                                    <input type="tel" class="form-control" id="pos-customer-mobile" placeholder="‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)">
                                </div>
                                
                                <div id="module-finance-collection" class="mb-3" style="display:none;">
                                    <label for="pos-loan-account" class="form-label fw-bold text-danger">Account / Loan Number</label>
                                    <input type="text" class="form-control border-danger" id="pos-loan-account" placeholder="e.g. LN-889900">
                                </div>
                                
                                <div class="mb-3 position-relative">
                                    <label for="pos-item-search" class="form-label">‡§Ü‡§á‡§ü‡§Æ ‡§ñ‡•ã‡§ú‡•á‡§Ç / SKU</label>
                                    <div class="input-group"> 
                                        <input 
                                            type="text" 
                                            class="form-control" 
                                            id="pos-item-search" 
                                            placeholder="‡§Ü‡§á‡§ü‡§Æ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§Ø‡§æ SKU ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç (‡§Ø‡§æ ‡§∏‡§≠‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç)" 
                                            autocomplete="off"
                                        >
                                        <button class="btn btn-warning" type="button" onclick="openMobileScanner()">
                                            <i class="fas fa-qrcode"></i> ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§∏‡•ç‡§ï‡•à‡§®‡§∞
                                        </button>
                                    </div>
                                    <button class="btn btn-info" type="button" id="manual-add-item-btn" title="Naya Item Manually Jodein">
                                        <i class="fas fa-plus"></i> ‡§®‡§Ø‡§æ ‡§Ü‡§á‡§ü‡§Æ
                                    </button>

                                    <div id="inline-pairing-box" class="mt-2 p-2 border border-warning rounded bg-light text-center" style="display: none;">
                                        <p class="mb-1 small text-muted">‡§∏‡•ç‡§ï‡•à‡§®‡§∞ ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§π ‡§ï‡•ã‡§° ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§≤‡•á‡§Ç:</p>
                                        <span id="inline-pairing-code" style="font-size: 1.8rem; font-weight: bold; letter-spacing: 3px; color: #dc3545;"></span> <div id="inline-pairing-spinner" class="spinner-border spinner-border-sm text-warning ms-2" role="status"> <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p id="inline-pairing-status" class="mt-1 mb-0 small text-success" style="display: none;">
                                            <i class="fas fa-check-circle"></i> ‡§∏‡•ç‡§ï‡•à‡§®‡§∞ ‡§ï‡§®‡•á‡§ï‡•ç‡§ü‡•á‡§°‡•§
                                        </p>
                                    </div>
                                    <ul 
                                        id="pos-search-results" 
                                        class="list-group position-absolute w-100" 
                                        style="z-index: 100; max-height: 300px; overflow-y: auto;"
                                        onclick="handleSearchResultClick(event)"
                                    ></ul>
                                </div>
                                <hr>
        
                                <h5>‡§¨‡§ø‡§≤‡§ø‡§Ç‡§ó ‡§ï‡§æ‡§∞‡•ç‡§ü</h5>
                                <div class="table-responsive mb-3" style="min-height: 150px;">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>‡§Ü‡§á‡§ü‡§Æ</th>
                                                <th style="width: 15%;">Qty</th>
                                                <th>‡§¶‡§∞</th>
                                                <th>‡§ï‡•Å‡§≤</th>
                                                <th style="width: 1%;"></th>
                                            </tr>
                                        </thead>
                                        <tbody id="pos-cart-body">
                                            <tr><td colspan="5" class="text-center text-muted">‡§ï‡§æ‡§∞‡•ç‡§ü ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•à‡•§</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="d-flex justify-content-between fw-bold mb-2">
                                    <span>‡§ï‡•Å‡§≤ ‡§ü‡•à‡§ï‡•ç‡§∏‡•á‡§¨‡§≤ ‡§∞‡§æ‡§∂‡§ø:</span>
                                    <span id="pos-subtotal">‚Çπ0.00</span>
                                </div>
                                <div class="d-flex justify-content-between fw-bold mb-2 text-danger">
                                    <span>‡§ï‡•Å‡§≤ GST ‡§∞‡§æ‡§∂‡§ø:</span>
                                    <span id="pos-gst-amount">‚Çπ0.00</span>
                                </div>
                                <div class="d-flex justify-content-between fw-bold fs-5 border-top pt-2">
                                    <span>‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡•Ä ‡§ú‡§æ‡§®‡•á ‡§µ‡§æ‡§≤‡•Ä ‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø:</span>
                                    <span id="pos-total-amount">‚Çπ0.00</span>
                                </div>

                                <div id="module-geo-tagging" class="biz-module alert alert-warning p-2 mt-2" style="display:none;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <small class="fw-bold text-dark"><i class="fas fa-map-marker-alt"></i> ‡§µ‡§ø‡§ú‡§ø‡§ü ‡§≤‡•ã‡§ï‡•á‡§∂‡§® (Visit Location)</small>
                                            <div id="gps-status" class="text-danger small" style="font-size: 0.75rem;">Not Captured</div>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-dark" onclick="captureGPS()">
                                            <i class="fas fa-crosshairs"></i> ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§≤‡•á‡§Ç
                                        </button>
                                    </div>
                                    <input type="hidden" id="pos-lat">
                                    <input type="hidden" id="pos-long">
                                </div>

                                <div id="pos-god-mode-delivery" class="mb-3 p-2 border border-primary rounded bg-light" style="display:none;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="text-primary m-0 fw-bold"><i class="fas fa-truck-fast"></i> Instant Delivery & Alert</h6>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="pos_auto_deliver_check" onchange="togglePosDeliveryDate()">
                                            <label class="form-check-label fw-bold small" for="pos_auto_deliver_check">Enable</label>
                                        </div>
                                    </div>
                                    
                                    <div id="pos_delivery_inputs" style="display:none;" class="mt-2">
                                        <label class="small text-muted">Delivery Date:</label>
                                        <input type="date" id="pos_auto_date" class="form-control form-control-sm mb-2">
                                        
                                        <input type="tel" id="pos_auto_mistri_mobile" class="form-control form-control-sm mb-2" placeholder="Mistri Mobile (Optional)">
                                
                                        <div class="d-flex gap-3 border-top pt-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="pos_send_cust_wa" checked>
                                                <label class="form-check-label small fw-bold text-success" for="pos_send_cust_wa">
                                                    Customer Msg?
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="pos_send_mistri_wa">
                                                <label class="form-check-label small fw-bold text-primary" for="pos_send_mistri_wa">
                                                    Mistri Msg?
                                                </label>
                                            </div>
                                        </div>
                                
                                        <div class="mt-2 border-top pt-2">
                                            <label class="small fw-bold text-dark d-flex justify-content-between">
                                                <span>üí¨ Auto-Message Template</span>
                                                <span class="text-primary cursor-pointer" onclick="resetTemplate()">Reset</span>
                                            </label>
                                            <textarea id="pos_wa_template" class="form-control form-control-sm" rows="4" style="font-size: 0.85rem; background: #f0f8ff;">
                                ‡§®‡§Æ‡§∏‡•ç‡§§‡•á *{name}*,
                                ‡§Ü‡§™‡§ï‡§æ ‡§ë‡§°‡§∞ ‡§ï‡§Ç‡§´‡§∞‡•ç‡§Æ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à! üéâ
                                üßæ ‡§¨‡§ø‡§≤ ‡§®‡§Ç‡§¨‡§∞: *#{bill_no}*
                                üí∞ ‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø: *{amount}*
                                üì¶ ‡§∏‡§æ‡§Æ‡§æ‡§®: {items}
                                üöö ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä: {date}
                                
                                ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§æ‡§• ‡§Æ‡•á‡§Ç ‡§≠‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ PDF ‡§¨‡§ø‡§≤ ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§
                                ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! üôè
                                </textarea>
                                            <div class="text-muted mt-1" style="font-size: 10px;">
                                                <strong>Variables:</strong> {name}, {bill_no}, {amount}, {items}, {date} (‡§Ø‡•á ‡§Ö‡§™‡§®‡•á ‡§Ü‡§™ ‡§≠‡§∞ ‡§ú‡§æ‡§è‡§Ç‡§ó‡•á)
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3 p-2 border border-success rounded bg-light">
                                    <label class="fw-bold small text-success">Payment Mode (‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§æ ‡§§‡§∞‡•Ä‡§ï‡§æ)</label>
                                    <select id="pos-payment-mode" class="form-select form-select-sm fw-bold">
                                        <option value="Cash" selected>üíµ Cash (‡§®‡§ï‡§¶)</option>
                                        <option value="UPI">üì± UPI / PhonePe / GPay</option>
                                        <option value="Card">üí≥ Card</option>
                                        <option value="Credit">üìï Udhaar (Credit)</option>
                                    </select>
                                </div>

                                <div class="mt-4">
                                    <button 
                                        type="button" 
                                        class="btn btn-success btn-lg w-100" 
                                        id="complete-sale-btn"
                                        onclick="handleCompleteSale()"
                                    >‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§™‡•Ç‡§∞‡•Ä ‡§ï‡§∞‡•á‡§Ç</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-7"> <div class="card">
                        <div class="card-header">‡§π‡§æ‡§≤ ‡§ï‡•á ‡§ö‡§æ‡§≤‡§æ‡§®</div>
                        <div class="card-body">
                            <div class="mb-3 d-flex justify-content-end">
                                <button class="btn btn-sm btn-outline-secondary" id="refresh-sales-btn" onclick="fetchAndRenderSales()"><i class="fas fa-sync-alt"></i> ‡§§‡§æ‡§ú‡§º‡§æ ‡§ï‡§∞‡•á‡§Ç</button>
                            </div>
                            <div class="table-responsive" style="max-height: 700px; overflow-y: auto;">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>‡§ö‡§æ‡§≤‡§æ‡§® ‡§®‡§Ç.</th>
                                            <th>‡§ó‡•ç‡§∞‡§æ‡§π‡§ï</th>
                                            <th>GST</th>
                                            <th>‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø</th>
                                            <th>‡§§‡§ø‡§•‡§ø</th>
                                            <th>‡§è‡§ï‡•ç‡§∂‡§®</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sales-table-body">
                                        <tr><td colspan="5" class="text-center text-muted">‡§ï‡•ã‡§à ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç‡•§</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="invoice-generator" class="section">
            <h2 class="mb-4 text-primary">üáÆüá≥ India's Best Invoice Generator Pro</h2>
            <div class="row g-4">
                <div class="col-lg-5 no-print">
                    <div class="card">
                        <div class="card-header">
                            <h2>üìù Create New Invoice</h2>
                        </div>
                        <div class="card-body p-4">
                            <div class="row g-3 mb-4">
                                <h5>üè™ Shop Details</h5>
                                <div class="col-md-6">
                                    <input type="text" id="shopName" class="form-control" placeholder="Shop Name" onkeyup="updateInvoicePreview()">
                                </div>
                                <div class="col-md-6">
                                    <input type="text" id="shopContact" class="form-control" placeholder="Contact No." onkeyup="updateInvoicePreview()">
                                </div>
                                <div class="col-12">
                                    <input type="text" id="shopAddress" class="form-control" placeholder="Shop Address" onkeyup="updateInvoicePreview()">
                                </div>
                                 <div class="col-md-6">
                                     <input type="text" id="shopGstin" class="form-control" placeholder="GSTIN (Optional)" onkeyup="updateInvoicePreview()">
                                 </div>
                                 <div class="col-md-6">
                                     <label for="qrUpload" class="form-label small">Upload UPI QR (Optional)</label>
                                     <input type="file" class="form-control form-control-sm" id="qrUpload" accept="image/*">
                                 </div>
                            </div>
        
                            <div class="row g-3 mb-4">
                                <h5>üë§ Customer Details</h5>
                                 <div class="col-md-6">
                                     <input type="text" id="customerName" class="form-control" placeholder="Customer Name" onkeyup="updateInvoicePreview()">
                                 </div>
                                 <div class="col-md-6">
                                     <input type="text" id="customerContact" class="form-control" placeholder="Contact No." onkeyup="updateInvoicePreview()">
                                 </div>
                                <div class="col-12">
                                    <input type="text" id="customerAddress" class="form-control" placeholder="Customer Address" onkeyup="updateInvoicePreview()">
                                </div>
                            </div>
        
                            <h5 class="mb-3">‚ûï Add Items</h5>
                            <form id="item-form" class="row g-2 align-items-center">
                                <div class="col-sm-12 mb-2">
                                    <input type="text" id="itemName" class="form-control" placeholder="Item Name">
                                </div>
                                <div class="col-sm-3">
                                    <input type="number" id="quantity" class="form-control" placeholder="Qty">
                                </div>
                                 <div class="col-sm-4">
                                     <input type="number" id="price" class="form-control" placeholder="Rate">
                                 </div>
                                 <div class="col-sm-3">
                                     <input type="number" id="gst" class="form-control" placeholder="GST %">
                                 </div>
                                <div class="col-sm-2">
                                    <button type="button" class="btn btn-success w-100" onclick="addItem()">Add</button>
                                </div>
                            </form>
                            <hr>
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button class="btn btn-info text-white" onclick="printInvoice()">üñ®Ô∏è Print Invoice</button>
                                <button class="btn btn-danger" onclick="clearBill()">üóëÔ∏è Clear Bill</button>
                            </div>
                        </div>
                    </div>
                </div>
        
                <div class="col-lg-7">
                    <div id="invoice-preview">
                        <div class="text-center text-muted p-5">Please fill details and add items to see the invoice preview.</div>
                    </div>
                </div>
            </div>
        </section>

        <section id="purchases" class="section">
            <h2 class="mb-4 text-primary">‡§ñ‡§∞‡•Ä‡§¶ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°</h2>
            <div class="card mb-4">
                <div class="card-header">‡§®‡§à ‡§ñ‡§∞‡•Ä‡§¶ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç</div>
                <div class="card-body">
                    <form id="add-purchase-form" class="row g-3">
                        <div class="col-md-3">
                            <label for="purchase-bill-number" class="form-label">‡§¨‡§ø‡§≤ / ‡§ö‡§æ‡§≤‡§æ‡§® ‡§®‡§Ç.</label>
                            <input type="text" class="form-control" id="purchase-bill-number" required>
                        </div>
                        <div class="col-md-3">
                            <label for="purchase-supplier" class="form-label">‡§Ü‡§™‡•Ç‡§∞‡•ç‡§§‡§ø‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
                            <input type="text" class="form-control" id="purchase-supplier" required>
                        </div>
                        <div class="col-md-3">
                            <label for="purchase-date" class="form-label">‡§ñ‡§∞‡•Ä‡§¶ ‡§ï‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ</label>
                            <input type="date" class="form-control" id="purchase-date" required>
                        </div>
                        <div class="col-md-3">
                            <label for="purchase-total-cost" class="form-label">‡§ï‡•Å‡§≤ ‡§¨‡§ø‡§≤ ‡§∞‡§æ‡§∂‡§ø (‚Çπ)</label>
                            <input type="number" step="0.01" class="form-control" id="purchase-total-cost" required min="0">
                        </div>
                        <div class="col-12">
                            <label for="purchase-item-details" class="form-label">‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ (Item Details)</label>
                            <textarea class="form-control" id="purchase-item-details" rows="2" placeholder="‡§â‡§¶‡§æ‡§π‡§∞‡§£: 50kg ‡§Ü‡§≤‡•Ç, 10kg ‡§™‡§®‡•Ä‡§∞, 5L ‡§§‡•á‡§≤..."></textarea>
                        </div>
                    
                        <hr class="my-3 col-12">
                        <h6 class="col-12 text-primary">GST ‡§µ‡§ø‡§µ‡§∞‡§£ (GSTR-2 ‡§ï‡•á ‡§≤‡§ø‡§è)</h6>
                        
                        <div class="col-md-3">
                            <label for="purchase-taxable-value" class="form-label">‡§ü‡•à‡§ï‡•ç‡§∏‡•á‡§¨‡§≤ ‡§µ‡•à‡§≤‡•ç‡§Ø‡•Ç (‚Çπ)</label>
                            <input type="number" step="0.01" class="form-control" id="purchase-taxable-value" min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="purchase-cgst" class="form-label">CGST (‚Çπ)</label>
                            <input type="number" step="0.01" class="form-control" id="purchase-cgst" value="0" min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="purchase-sgst" class="form-label">SGST (‚Çπ)</label>
                            <input type="number" step="0.01" class="form-control" id="purchase-sgst" value="0" min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="purchase-igst" class="form-label">IGST (‚Çπ)</label>
                            <input type="number" step="0.01" class="form-control" id="purchase-igst" value="0" min="0">
                        </div>
                    
                        <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-success w-100">‡§ñ‡§∞‡•Ä‡§¶ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ï‡§∞‡•á‡§Ç</button>
                        </div>
                    </form>                </div>
            </div>

            <div class="card">
                <div class="card-header">‡§π‡§æ‡§≤ ‡§ï‡•Ä ‡§ñ‡§∞‡•Ä‡§¶ ‡§ï‡§æ ‡§á‡§§‡§ø‡§π‡§æ‡§∏</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>‡§¨‡§ø‡§≤ ‡§®‡§Ç.</th>
                                    <th>‡§Ü‡§™‡•Ç‡§∞‡•ç‡§§‡§ø‡§ï‡§∞‡•ç‡§§‡§æ</th>
                                    <th>‡§Ü‡§á‡§ü‡§Æ</th>
                                    <th>‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø</th>
                                    <th>‡§§‡§ø‡§•‡§ø</th>
                                    <th>‡§è‡§ï‡•ç‡§∂‡§®</th>
                                </tr>
                            </thead>
                            <tbody id="purchases-table-body">
                                <tr><td colspan="6" class="text-center text-muted">‡§ï‡•ã‡§à ‡§ñ‡§∞‡•Ä‡§¶ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ</td></tr>
                            </tbody>
                            <tfoot id="purchases-table-foot"></tfoot> 
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="crm" class="section">
            <h2 class="mb-4 text-primary">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§∏‡§Ç‡§¨‡§Ç‡§ß ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® (CRM)</h2>
            <div class="card mb-4">
                <div class="card-header">‡§®‡§Ø‡§æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</div>
                <div class="card-body">
                    <form id="add-customer-form" class="row g-3">
                        <div class="col-md-4">
                            <label for="customer-name" class="form-label">‡§®‡§æ‡§Æ</label>
                            <input type="text" class="form-control" id="customer-name" required>
                        </div>
                        <div class="col-md-4">
                            <label for="customer-phone" class="form-label">‡§´‡§º‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞</label>
                            <input type="tel" class="form-control" id="customer-phone">
                        </div>
                        <div class="form-group">
                            <label for="cust-dob">DOB (optional)</label>
                            <input id="cust-dob" type="date" class="form-control" placeholder="YYYY-MM-DD">
                          </div>
                          
                        <div class="col-md-4">
                            <label for="customer-email" class="form-label">‡§à‡§Æ‡•á‡§≤ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)</label>
                            <input type="email" class="form-control" id="customer-email">
                        </div>
                        <div class="col-12">
                            <label for="customer-address" class="form-label">‡§™‡§§‡§æ (Address)</label>
                            <textarea class="form-control" id="customer-address" rows="1"></textarea>
                        </div>
                         <div class="col-md-6">
                            <label for="customer-gstin" class="form-label">GSTIN (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)</label>
                            <input type="text" class="form-control" id="customer-gstin" maxlength="15">
                        </div>
                        <div class="col-md-6">
                            <label for="customer-balance" class="form-label">‡§™‡§ø‡§õ‡§≤‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ (‚Çπ)</label>
                            <input type="number" step="0.01" class="form-control" id="customer-balance" value="0" min="0">
                        </div>
                       <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-primary w-100">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡•ã ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="card">
                <div class="card-header">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§∏‡•Ç‡§ö‡•Ä</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>‡§®‡§æ‡§Æ</th>
                                    <th>‡§´‡§º‡•ã‡§®</th>
                                    <th>‡§™‡§§‡§æ</th>
                                    <th>‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ</th>
                                    <th>‡§è‡§ï‡•ç‡§∂‡§®</th>
                                </tr>
                            </thead>
                            <tbody id="crm-table-body">
                                <tr><td colspan="6" class="text-center text-muted">‡§ï‡•ã‡§à ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="expenses" class="section">
            <h2 class="mb-4 text-primary">‡§ñ‡§∞‡•ç‡§ö ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®</h2>
            <div class="card mb-4">
                <div class="card-header">‡§®‡§Ø‡§æ ‡§ñ‡§∞‡•ç‡§ö ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç</div>
                <div class="card-body">
                    <form id="add-expense-form" class="row g-3">
                        <div class="col-md-4">
                            <label for="expense-date" class="form-label">‡§§‡§ø‡§•‡§ø</label>
                            <input type="date" class="form-control" id="expense-date" value="" required>
                        </div>
                        <div class="col-md-4">
                            <label for="expense-category" class="form-label">‡§∂‡•ç‡§∞‡•á‡§£‡•Ä</label>
                            <select class="form-select" id="expense-category" required>
                                <option value="" disabled selected>‡§∂‡•ç‡§∞‡•á‡§£‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç</option>
                                <option value="Salary">‡§µ‡•á‡§§‡§® (Salary)</option>
                                <option value="Rent">‡§ï‡§ø‡§∞‡§æ‡§Ø‡§æ (Rent)</option>
                                <option value="Utilities">‡§Ø‡•Ç‡§ü‡§ø‡§≤‡§ø‡§ü‡•Ä‡§ú (‡§¨‡§ø‡§ú‡§≤‡•Ä/‡§™‡§æ‡§®‡•Ä)</option>
                                <option value="Marketing">‡§Æ‡§æ‡§∞‡•ç‡§ï‡•á‡§ü‡§ø‡§Ç‡§ó</option>
                                <option value="Miscellaneous">‡§µ‡§ø‡§µ‡§ø‡§ß</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="expense-amount" class="form-label">‡§∞‡§æ‡§∂‡§ø (‚Çπ)</label>
                            <input type="number" step="0.01" class="form-control" id="expense-amount" required min="0">
                        </div>
                        <div class="col-12">
                            <label for="expense-description" class="form-label">‡§µ‡§ø‡§µ‡§∞‡§£</label>
                            <input type="text" class="form-control" id="expense-description" required>
                        </div>
                        <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-warning w-100">‡§ñ‡§∞‡•ç‡§ö ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="card">
                <div class="card-header">‡§ñ‡§∞‡•ç‡§ö ‡§ï‡§æ ‡§á‡§§‡§ø‡§π‡§æ‡§∏</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>‡§§‡§ø‡§•‡§ø</th>
                                    <th>‡§∂‡•ç‡§∞‡•á‡§£‡•Ä</th>
                                    <th>‡§µ‡§ø‡§µ‡§∞‡§£</th>
                                    <th>‡§∞‡§æ‡§∂‡§ø</th>
                                    <th>‡§è‡§ï‡•ç‡§∂‡§®</th>
                                </tr>
                            </thead>
                            <tbody id="expenses-table-body">
                                <tr><td colspan="5" class="text-center text-muted">‡§ï‡•ã‡§à ‡§ñ‡§∞‡•ç‡§ö ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ</td></tr>
                            </tbody>
                            <tfoot id="expenses-table-foot"></tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="reports" class="section">
            <h2 class="mb-4 text-primary">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏ ‡§î‡§∞ ‡§è‡§®‡§æ‡§≤‡§ø‡§ü‡§ø‡§ï‡•ç‡§∏</h2>
            <div class="row g-4">
                <div class="col-lg-12 mb-4">
                    <div class="card" id="pl-card">
                        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                            <span>‡§≤‡§æ‡§≠ ‡§î‡§∞ ‡§π‡§æ‡§®‡§ø (Profit & Loss)</span>
                            <div class="no-print">
                                <button class="btn btn-sm btn-light me-2" onclick="handleReportAction('profit_loss', 'download')"><i class="fas fa-file-download"></i> ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</button>
                                <button class="btn btn-sm btn-light" onclick="handleReportAction('profit_loss', 'print')"><i class="fas fa-print"></i> ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-sm report-table">
                                        <thead><tr><th colspan="2" class="text-center">‡§ñ‡§∞‡•ç‡§ö (Debit)</th></tr></thead>
                                        <tbody>
                                            <tr><td>‡§ï‡•Å‡§≤ ‡§ñ‡§∞‡•Ä‡§¶ (Purchases)</td><td class="text-end" id="report-pl-purchases">‚Çπ0.00</td></tr>
                                            <tr><td>‡§ï‡•Å‡§≤ ‡§ñ‡§∞‡•ç‡§ö (Expenses)</td><td class="text-end" id="report-pl-expenses">‚Çπ0.00</td></tr>
                                            <tr id="report-pl-profit-row" class="d-none"><td><b>‡§∂‡•Å‡§¶‡•ç‡§ß ‡§≤‡§æ‡§≠ (Net Profit)</b></td><td class="text-end fw-bold text-success" id="report-pl-profit">‚Çπ0.00</td></tr>
                                        </tbody>
                                        <tfoot>
                                            <tr class="fw-bold bg-light"><td >‡§ï‡•Å‡§≤ ‡§°‡•á‡§¨‡§ø‡§ü</td><td class="text-end" id="report-pl-total-debit">‚Çπ0.00</td></tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <table class="table table-sm report-table">
                                        <thead><tr><th colspan="2" class="text-center">‡§Ü‡§Ø (Credit)</th></tr></thead>
                                        <tbody>
                                            <tr><td>‡§ï‡•Å‡§≤ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä (Revenue)</td><td class="text-end" id="report-pl-revenue">‚Çπ0.00</td></tr>
                                            <tr id="report-pl-loss-row" class="d-none"><td><b>‡§∂‡•Å‡§¶‡•ç‡§ß ‡§π‡§æ‡§®‡§ø (Net Loss)</b></td><td class="text-end fw-bold text-danger" id="report-pl-loss">‚Çπ0.00</td></tr>
                                        </tbody>
                                        <tfoot>
                                            <tr class="fw-bold bg-light"><td>‡§ï‡•Å‡§≤ ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü</td><td class="text-end" id="report-pl-total-credit">‚Çπ0.00</td></tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-12">
                    <div class="card" id="bs-card">
                        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                            <span>‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§∂‡•Ä‡§ü (Balance Sheet)</span>
                             <div class="no-print">
                                <button class="btn btn-sm btn-light me-2" onclick="handleReportAction('balance_sheet', 'download')"><i class="fas fa-file-download"></i> ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</button>
                                <button class="btn btn-sm btn-light" onclick="handleReportAction('balance_sheet', 'print')"><i class="fas fa-print"></i> ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-sm report-table">
                                        <thead><tr><th colspan="2" class="text-center">‡§¶‡•á‡§®‡§¶‡§æ‡§∞‡§ø‡§Ø‡§æ‡§Ç ‡§î‡§∞ ‡§á‡§ï‡•ç‡§µ‡§ø‡§ü‡•Ä (Liabilities & Equity)</th></tr></thead>
                                        <tbody>
                                            <tr><td>GST ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§®‡•á ‡§Ø‡•ã‡§ó‡•ç‡§Ø (Payable)</td><td class="text-end" id="report-bs-gst-payable">‚Çπ0.00</td></tr>
                                            <tr><td>‡§µ‡•á‡§Ç‡§°‡§∞ ‡§ï‡•ã ‡§¶‡•á‡§Ø (Payable)</td><td class="text-end" id="report-bs-vendors-payable">‚Çπ0.00</td></tr>
                                            <tr><td>‡§Æ‡§æ‡§≤‡§ø‡§ï ‡§ï‡•Ä ‡§á‡§ï‡•ç‡§µ‡§ø‡§ü‡•Ä (Owner's Equity)</td><td class="text-end" id="report-bs-owner-equity">‚Çπ0.00</td></tr>
                                        </tbody>
                                        <tfoot>
                                            <tr class="fw-bold bg-light"><td>‡§ï‡•Å‡§≤ ‡§¶‡•á‡§®‡§¶‡§æ‡§∞‡§ø‡§Ø‡§æ‡§Ç ‡§î‡§∞ ‡§á‡§ï‡•ç‡§µ‡§ø‡§ü‡•Ä</td><td class="text-end" id="report-bs-total-liabilities">‚Çπ0.00</td></tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                     <table class="table table-sm report-table">
                                        <thead><tr><th colspan="2" class="text-center">‡§™‡§∞‡§ø‡§∏‡§Ç‡§™‡§§‡•ç‡§§‡§ø‡§Ø‡§æ‡§Ç (Assets)</th></tr></thead>
                                        <tbody>
                                            <tr><td>‡§∏‡•ç‡§ü‡•â‡§ï ‡§ï‡§æ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø (Stock Value)</td><td class="text-end" id="report-bs-stock-value">‚Çπ0.00</td></tr>
                                            <tr><td>‡§¨‡•à‡§Ç‡§ï/‡§ï‡•à‡§∂ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ (Profit)</td><td class="text-end" id="report-bs-cash-balance">‚Çπ0.00</td></tr>
                                        </tbody>
                                        <tfoot>
                                            <tr class="fw-bold bg-light"><td>‡§ï‡•Å‡§≤ ‡§™‡§∞‡§ø‡§∏‡§Ç‡§™‡§§‡•ç‡§§‡§ø‡§Ø‡§æ‡§Ç</td><td class="text-end" id="report-bs-total-assets">‚Çπ0.00</td></tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-12">
                    <div class="card" id="product-sales-card">
                        <div class="card-header bg-dark text-white">
                            <span>‡§â‡§§‡•ç‡§™‡§æ‡§¶-‡§µ‡§æ‡§∞ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§î‡§∞ ‡§≤‡§æ‡§≠ (Product-wise Sales & Profit)</span>
                        </div>
                        <div class="card-body">
                            <div class="row g-3 mb-3">
                                <div class="col-md-5">
                                    <label for="product-report-start-date" class="form-label">‡§∂‡•Å‡§∞‡•Ç‡§Ü‡§§‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ</label>
                                    <input type="date" id="product-report-start-date" class="form-control">
                                </div>
                                <div class="col-md-5">
                                    <label for="product-report-end-date" class="form-label">‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§§‡§æ‡§∞‡•Ä‡§ñ</label>
                                    <input type="date" id="product-report-end-date" class="form-control">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" id="fetch-product-sales-report-btn">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§¶‡•á‡§ñ‡•á‡§Ç</button>
                                </div>
                            </div>
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>SKU</th>
                                            <th>‡§Ü‡§á‡§ü‡§Æ</th>
                                            <th>‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ ‡§¨‡§ø‡§ï‡•Ä</th>
                                            <th>‡§ï‡•Å‡§≤ ‡§∞‡•á‡§µ‡•á‡§®‡•ç‡§Ø‡•Ç</th>
                                            <th>‡§ï‡•Å‡§≤ ‡§≤‡§æ‡§ó‡§§</th>
                                            <th>‡§ï‡•Å‡§≤ ‡§≤‡§æ‡§≠</th>
                                        </tr>
                                    </thead>
                                    <tbody id="product-sales-report-body">
                                        <tr><td colspan="6" class="text-center text-muted">‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ö‡•Å‡§®‡•á‡§Ç ‡§î‡§∞ '‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§¶‡•á‡§ñ‡•á‡§Ç' ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="staff" class="section">
            <h2 class="mb-4 text-primary">‡§∏‡•ç‡§ü‡§æ‡§´ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® (‡§è‡§°‡§Æ‡§ø‡§®)</h2>
            
            <div class="card mb-4">
                <div class="card-header bg-success text-white">‡§®‡§Ø‡§æ ‡§∏‡•ç‡§ü‡§æ‡§´ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</div>
                <div class="card-body">
                    <form id="add-staff-form" class="row g-3">
                        <div class="col-md-4">
                            <label for="staff-name" class="form-label">‡§®‡§æ‡§Æ</label>
                            <input type="text" class="form-control" id="staff-name" required placeholder="‡§ú‡•à‡§∏‡•á: ‡§∞‡§æ‡§π‡•Å‡§≤ ‡§ï‡•Å‡§Æ‡§æ‡§∞">
                        </div>
                        <div class="col-md-4">
                            <label for="staff-email" class="form-label">‡§à‡§Æ‡•á‡§≤</label>
                            <input type="email" class="form-control" id="staff-email" required placeholder="‡§ú‡•à‡§∏‡•á: rahul@example.com">
                        </div>
                        <div class="col-md-4">
                            <label for="staff-password" class="form-label">‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°</label>
                            <input type="password" class="form-control" id="staff-password" required placeholder="‡§è‡§ï ‡§Æ‡§ú‡§¨‡•Ç‡§§ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§ö‡•Å‡§®‡•á‡§Ç">
                        </div>
                        <div class="col-md-6">
                            <label for="staff-role" class="form-label">‡§∞‡•ã‡§≤ (‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ)</label>
                            <select id="staff-role" class="form-select">
                                <option value="CASHIER" selected>‡§ï‡•à‡§∂‡§ø‡§Ø‡§∞ (Cashier)</option>
                                <option value="MANAGER">‡§Æ‡•à‡§®‡•á‡§ú‡§∞ (Manager)</option>
                                <option value="ACCOUNTANT">Accountant (CA Access)</option>
                                <option value="ADMIN">‡§è‡§°‡§Æ‡§ø‡§® (Admin)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="staff-status" class="form-label">‡§∏‡•ç‡§•‡§ø‡§§‡§ø (Status)</label>
                            <select id="staff-status" class="form-select">
                                <option value="pending" selected>‡§™‡•á‡§Ç‡§°‡§ø‡§Ç‡§ó (Pending)</option>
                                <option value="active">‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø (Active)</option>
                                <option value="disabled">‡§Ö‡§ï‡•ç‡§∑‡§Æ (Disabled)</option>
                            </select>
                        </div>
                        <div class="col-12 mt-3">
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-user-plus me-2"></i>‡§∏‡•ç‡§ü‡§æ‡§´ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        
            <div class="card">
                <div class="card-header">‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§∏‡•ç‡§ü‡§æ‡§´ ‡§∏‡§¶‡§∏‡•ç‡§Ø</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>‡§®‡§æ‡§Æ</th>
                                    <th>‡§à‡§Æ‡•á‡§≤</th>
                                    <th>‡§∞‡•ã‡§≤</th>
                                    <th>‡§∏‡•ç‡§•‡§ø‡§§‡§ø</th>
                                    <th>‡§¨‡§®‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ</th>
                                    <th>‡§è‡§ï‡•ç‡§∂‡§®</th>
                                </tr>
                            </thead>
                            <tbody id="staff-table-body">
                                <tr><td colspan="7" class="text-center text-muted py-4">‡§∏‡•ç‡§ü‡§æ‡§´ ‡§∏‡•Ç‡§ö‡•Ä ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        
            <div class="modal fade" id="editStaffModal" tabindex="-1" aria-labelledby="editStaffModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="editStaffModalLabel">
                        <i class="fas fa-user-edit me-2"></i>‡§∏‡•ç‡§ü‡§æ‡§´ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <form id="edit-staff-form">
                      <div class="modal-body">
                          <input type="hidden" id="edit-staff-id">
                          <div class="mb-3">
                              <label for="edit-staff-name" class="form-label">‡§®‡§æ‡§Æ</label>
                              <input type="text" class="form-control" id="edit-staff-name" required>
                          </div>
                          <div class="mb-3">
                              <label for="edit-staff-email" class="form-label">‡§à‡§Æ‡•á‡§≤ (‡§¨‡§¶‡§≤‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ)</label>
                              <input type="email" class="form-control" id="edit-staff-email" disabled readonly>
                          </div>
                          <div class="mb-3">
                            <label for="edit-staff-role" class="form-label">‡§∞‡•ã‡§≤ (‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ)</label>
                            <select id="edit-staff-role" class="form-select">
                                <option value="CASHIER">‡§ï‡•à‡§∂‡§ø‡§Ø‡§∞ (Cashier)</option>
                                <option value="MANAGER">‡§Æ‡•à‡§®‡•á‡§ú‡§∞ (Manager)</option>
                                <option value="ACCOUNTANT">Accountant (CA Access)</option>
                                <option value="ADMIN">‡§è‡§°‡§Æ‡§ø‡§® (Admin)</option>
                            </select>
                          </div>
                          <div class="mb-3">
                            <label for="edit-staff-status" class="form-label">‡§∏‡•ç‡§•‡§ø‡§§‡§ø (Status)</label>
                            <select id="edit-staff-status" class="form-select">
                                <option value="pending">‡§™‡•á‡§Ç‡§°‡§ø‡§Ç‡§ó (Pending)</option>
                                <option value="active">‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø (Active)</option>
                                <option value="disabled">‡§Ö‡§ï‡•ç‡§∑‡§Æ (Disabled)</option>
                            </select>
                          </div>
                           <div class="mb-3">
                              <label for="edit-staff-password" class="form-label">‡§®‡§Ø‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° (‡§Ö‡§ó‡§∞ ‡§¨‡§¶‡§≤‡§®‡§æ ‡§π‡•à)</label>
                              <input type="password" class="form-control" id="edit-staff-password" placeholder="‡§ñ‡§æ‡§≤‡•Ä ‡§õ‡•ã‡§°‡§º ‡§¶‡•á‡§Ç ‡§Ö‡§ó‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§¨‡§¶‡§≤‡§®‡§æ ‡§π‡•à">
                              <div class="form-text">‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¨‡§¶‡§≤‡§®‡•á ‡§ï‡•Ä ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§™‡§∞ ‡§≤‡§æ‡§ó‡•Ç ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡•á‡§ó‡•Ä‡•§</div>
                          </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>‡§¨‡§¶‡§≤‡§æ‡§µ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç
                        </button>
                      </div>
                  </form>
                </div>
              </div>
            </div>
        </section>

        <section id="gst-reports" class="section">
            <h2 class="mb-4 text-primary">GST ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏ (Simplified)</h2>
            <p class="text-muted">‡§Ø‡•á ‡§Ü‡§™‡§ï‡•á ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡•Ä ‡§ó‡§à ‡§∏‡§∞‡§≤‡•Ä‡§ï‡•É‡§§ (simplified) GST ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§π‡•à‡§Ç‡•§ </p>
            
            <div class="card">
                <div class="card-header">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏ ‡§ú‡•á‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç</div>
                <div class="card-body">
                    <div class="row g-3 mb-4">
                        <div class="col-md-5">
                            <label for="gst-report-start-date" class="form-label">‡§∂‡•Å‡§∞‡•Ç‡§Ü‡§§‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ</label>
                            <input type="date" id="gst-report-start-date" class="form-control" value="">
                        </div>
                        <div class="col-md-5">
                            <label for="gst-report-end-date" class="form-label">‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§§‡§æ‡§∞‡•Ä‡§ñ</label>
                            <input type="date" id="gst-report-end-date" class="form-control" value="">
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <button class="btn btn-info w-100" id="fetch-gstr1-report-btn">GSTR-1 (‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä) ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§¶‡•á‡§ñ‡•á‡§Ç</button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-warning w-100" id="fetch-gstr2-report-btn">GSTR-2 (‡§ñ‡§∞‡•Ä‡§¶) ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§¶‡•á‡§ñ‡•á‡§Ç</button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-secondary w-100" id="fetch-gstr3b-report-btn">GSTR-3B (‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂) ‡§¶‡•á‡§ñ‡•á‡§Ç</button>
                        </div>
                    </div>
                    <p class="text-muted small mt-3">‡§®‡•ã‡§ü: ‡§Ø‡§π GSTR ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§Ü‡§™‡§ï‡•á ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ '‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä (POS)' ‡§î‡§∞ '‡§ó‡•ç‡§∞‡§æ‡§π‡§ï (CRM)' ‡§Æ‡•á‡§Ç ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§ø‡§è ‡§ó‡§è ‡§°‡•á‡§ü‡§æ ‡§™‡§∞ ‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§π‡•à‡•§ </p>

                    <hr class="my-4">
                    
                    <h5 id="gst-report-title">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∞‡§ø‡§ú‡§≤‡•ç‡§ü</h5>
                    <div id="gst-report-result">
                        <div class="text-muted text-center py-4">‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ö‡•Å‡§®‡•á‡§Ç ‡§î‡§∞ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§¨‡§ü‡§® ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§</div>
                        
                        <div id="gstr1-report-template" style="display: none;">


                            
                           <!-- ============ TALLY-STYLE GST REPORT HTML START ============ -->
<!-- ‡§Ø‡§π Tally-Style ‡§ü‡•à‡§¨ ‡§≤‡•á‡§Ü‡§â‡§ü ‡§π‡•à -->

<!-- Tab Navigation (GSTR-1, 2, 3B) -->
<nav class="gst-report-tabs mt-4">
    <div class="nav nav-tabs" id="gstReportTab" role="tablist">
        <button class="nav-link active" id="gst-gstr1-tab" data-bs-toggle="tab" data-bs-target="#gst-gstr1" type="button" role="tab" aria-controls="gst-gstr1" aria-selected="true">
            GSTR-1 (‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä)
        </button>
        <button class="nav-link" id="gst-gstr2-tab" data-bs-toggle="tab" data-bs-target="#gst-gstr2" type="button" role="tab" aria-controls="gst-gstr2" aria-selected="false">
            GSTR-2 (‡§ñ‡§∞‡•Ä‡§¶ ITC)
        </button>
        <button class="nav-link" id="gst-gstr3b-tab" data-bs-toggle="tab" data-bs-target="#gst-gstr3b" type="button" role="tab" aria-controls="gst-gstr3b" aria-selected="false">
            GSTR-3B (‡§∏‡§Æ‡§∞‡•Ä)
        </button>
    </div>
</nav>

<!-- Tab Content (Main Body) -->
<div class="tab-content gst-report-tab-content" id="gstReportTabContent">
    
    <!-- GSTR-1 Pane (‡§Ø‡§π GSTR-1 ‡§¨‡§ü‡§® ‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡§æ ‡§π‡•à) -->
    <div class="tab-pane fade show active" id="gst-gstr1" role="tabpanel" aria-labelledby="gst-gstr1-tab">
        <div id="gstr1-report-content" class="report-content-area">
            <p class="text-muted text-center py-4">‡§ï‡•É‡§™‡§Ø‡§æ ‡§ä‡§™‡§∞ ‡§¶‡§ø‡§è ‡§ó‡§è 'GSTR-1 (‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä) ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§¶‡•á‡§ñ‡•á‡§Ç' ‡§¨‡§ü‡§® ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§</p>
            <!-- GSTR-1 ‡§°‡•á‡§ü‡§æ JavaScript ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§Ø‡§π‡§æ‡§Å ‡§≠‡§∞‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ -->
        </div>
        
        <!-- GSTR-1 ‡§ï‡•á ‡§≤‡§ø‡§è ‡§õ‡§ø‡§™‡§æ ‡§π‡•Å‡§Ü ‡§ü‡•á‡§Æ‡•ç‡§™‡§≤‡•á‡§ü (JavaScript ‡§á‡§∏‡§ï‡§æ ‡§á‡§∏‡•ç‡§§‡•á‡§Æ‡§æ‡§≤ ‡§ï‡§∞‡•á‡§ó‡§æ) -->
        <div id="gstr1-report-template" style="display: none;">
            <nav class="gst-report-tabs">
                <div class="nav nav-tabs" id="gstr1-inner-tab" role="tablist">
                    <button class="nav-link active" id="gstr1-b2b-tab" data-bs-toggle="tab" data-bs-target="#gstr1-b2b" type="button" role="tab">B2B (GSTIN ‡§µ‡§æ‡§≤‡•Ä ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä)</button>
                    <button class="nav-link" id="gstr1-b2c-tab" data-bs-toggle="tab" data-bs-target="#gstr1-b2c" type="button" role="tab">B2C (‡§õ‡•ã‡§ü‡•Ä ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä)</button>
                    <button class="nav-link" id="gstr1-hsn-tab" data-bs-toggle="tab" data-bs-target="#gstr1-hsn" type="button" role="tab">HSN/SAC ‡§∏‡§Æ‡§∞‡•Ä</button>
                </div>
            </nav>
            <div class="tab-content gst-report-tab-content" id="gstr1-inner-tabContent">
                <div class="tab-pane fade show active" id="gstr1-b2b" role="tabpanel">
                    <h6>GSTR-1: B2B (‡§™‡§Ç‡§ú‡•Ä‡§ï‡•É‡§§ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï‡•ã‡§Ç ‡§ï‡•ã ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä)</h6>
                    <p class="small text-muted">‡§µ‡§π ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§ú‡§π‡§æ‡§Å ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ GSTIN ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§•‡§æ‡•§</p>
                    <div class="table-responsive">
                        <table class="table gst-report-table" id="gstr1-b2b-table">
                            <thead><tr><th>‡§ó‡•ç‡§∞‡§æ‡§π‡§ï GSTIN</th><th class="text-left">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ</th><th>‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§®‡§Ç.</th><th>‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§§‡§æ‡§∞‡•Ä‡§ñ</th><th>‡§ü‡•à‡§ï‡•ç‡§∏‡•á‡§¨‡§≤ ‡§µ‡•à‡§≤‡•ç‡§Ø‡•Ç (‚Çπ)</th><th>IGST (‚Çπ)</th><th>CGST (‚Çπ)</th><th>SGST (‚Çπ)</th></tr></thead>
                            <tbody></tbody>
                            <tfoot></tfoot>
                        </table>
                    </div>
                </div>
                <div class="tab-pane fade" id="gstr1-b2c" role="tabpanel">
                    <h6>GSTR-1: B2C(S) (‡§õ‡•ã‡§ü‡•Ä ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§∏‡§Æ‡§∞‡•Ä)</h6>
                    <p class="small text-muted">‡§µ‡§π ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§ú‡§π‡§æ‡§Å ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ GSTIN ‡§¶‡§∞‡•ç‡§ú ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§•‡§æ (‡§∞‡§æ‡§ú‡•ç‡§Ø ‡§î‡§∞ GST ‡§¶‡§∞ ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞)‡•§</p>
                    <div class="table-responsive">
                        <table class="table gst-report-table" id="gstr1-b2c-table">
                            <thead><tr><th class="text-left">‡§∏‡§™‡•ç‡§≤‡§æ‡§à ‡§ï‡§æ ‡§∞‡§æ‡§ú‡•ç‡§Ø</th><th>GST ‡§¶‡§∞ (%)</th><th>‡§ü‡•à‡§ï‡•ç‡§∏‡•á‡§¨‡§≤ ‡§µ‡•à‡§≤‡•ç‡§Ø‡•Ç (‚Çπ)</th><th>IGST (‚Çπ)</th><th>CGST (‚Çπ)</th><th>SGST (‚Çπ)</th><th>‡§ï‡•Å‡§≤ ‡§ü‡•à‡§ï‡•ç‡§∏ (‚Çπ)</th></tr></thead>
                            <tbody></tbody>
                            <tfoot></tfoot>
                        </table>
                    </div>
                </div>
                <div class="tab-pane fade" id="gstr1-hsn" role="tabpanel">
                    <h6>GSTR-1: HSN/SAC ‡§∏‡§Æ‡§∞‡•Ä (‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä)</h6>
                    <p class="small text-muted">‡§¨‡•á‡§ö‡•á ‡§ó‡§è ‡§Ü‡§á‡§ü‡§Æ ‡§ï‡•Ä HSN ‡§ï‡•ã‡§° ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§∏‡§Æ‡§∞‡•Ä‡•§</p>
                    <div class="table-responsive">
                        <table class="table gst-report-table" id="gstr1-hsn-table">
                            <thead><tr><th>HSN ‡§ï‡•ã‡§°</th><th class="text-left">‡§Ü‡§á‡§ü‡§Æ ‡§ï‡§æ ‡§®‡§æ‡§Æ</th><th>‡§Ø‡•Ç‡§®‡§ø‡§ü</th><th>‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (Qty)</th><th>‡§ü‡•à‡§ï‡•ç‡§∏‡•á‡§¨‡§≤ ‡§µ‡•à‡§≤‡•ç‡§Ø‡•Ç (‚Çπ)</th><th>IGST (‚Çπ)</th><th>CGST (‚Çπ)</th><th>SGST (‚Çπ)</th><th>‡§ï‡•Å‡§≤ ‡§ü‡•à‡§ï‡•ç‡§∏ (‚Çπ)</th></tr></thead>
                            <tbody></tbody>
                            <tfoot></tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GSTR-2 Pane (‡§Ø‡§π GSTR-2 ‡§¨‡§ü‡§® ‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡§æ ‡§π‡•à) -->
    <div class="tab-pane fade" id="gst-gstr2" role="tabpanel" aria-labelledby="gst-gstr2-tab">
        <div id="gstr2-report-content" class="report-content-area">
            <p class="text-muted text-center py-4">‡§ï‡•É‡§™‡§Ø‡§æ ‡§ä‡§™‡§∞ ‡§¶‡§ø‡§è ‡§ó‡§è 'GSTR-2 (‡§ñ‡§∞‡•Ä‡§¶) ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§¶‡•á‡§ñ‡•á‡§Ç' ‡§¨‡§ü‡§® ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§</p>
            <!-- GSTR-2 ‡§°‡•á‡§ü‡§æ JavaScript ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§Ø‡§π‡§æ‡§Å ‡§≠‡§∞‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ -->
        </div>
    </div>

    <!-- GSTR-3B Pane (‡§Ø‡§π GSTR-3B ‡§¨‡§ü‡§® ‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡§æ ‡§π‡•à) -->
    <div class="tab-pane fade" id="gst-gstr3b" role="tabpanel" aria-labelledby="gst-gstr3b-tab">
        <div id="gstr3b-report-content" class="report-content-area">
            <p class="text-muted text-center py-4">‡§ï‡•É‡§™‡§Ø‡§æ ‡§ä‡§™‡§∞ ‡§¶‡§ø‡§è ‡§ó‡§è 'GSTR-3B (‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂) ‡§¶‡•á‡§ñ‡•á‡§Ç' ‡§¨‡§ü‡§® ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§</p>
            <!-- GSTR-3B ‡§°‡•á‡§ü‡§æ JavaScript ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§Ø‡§π‡§æ‡§Å ‡§≠‡§∞‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ -->
        </div>
    </div>
</div>
</section>
<!-- ============ TALLY-STYLE GST REPORT HTML END ============ -->


<section id="bank-reconciliation" class="section">
    <h2 class="mb-4 text-primary">‡§¨‡•à‡§Ç‡§ï ‡§∞‡§ø‡§ï‡•â‡§®‡•ç‡§∏‡§ø‡§≤‡•á‡§∂‡§®</h2>
    
    <div class="card mb-4" id="reconciliation-setup">
        <div class="card-header">
            ‡§®‡§Ø‡§æ ‡§∞‡§ø‡§ï‡•â‡§®‡•ç‡§∏‡§ø‡§≤‡•á‡§∂‡§® ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç
        </div>
        <div class="card-body">
            <form id="reconciliation-start-form">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="recon-statement-date" class="form-label">‡§¨‡•à‡§Ç‡§ï ‡§∏‡•ç‡§ü‡•á‡§ü‡§Æ‡•á‡§Ç‡§ü ‡§ï‡•Ä ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§§‡§ø‡§•‡§ø</label>
                        <input type="date" class="form-control" id="recon-statement-date" required>
                    </div>
                    <div class="col-md-4">
                        <label for="recon-statement-balance" class="form-label">‡§∏‡•ç‡§ü‡•á‡§ü‡§Æ‡•á‡§Ç‡§ü ‡§ï‡§æ ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ (‚Çπ)</label>
                        <input type="number" step="0.01" class="form-control" id="recon-statement-balance" required>
                    </div>
                    <div class="col-md-4">
                        <label for="recon-statement-csv" class="form-label">‡§¨‡•à‡§Ç‡§ï ‡§∏‡•ç‡§ü‡•á‡§ü‡§Æ‡•á‡§Ç‡§ü ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç (.csv)</label>
                        <input type="file" class="form-control" id="recon-statement-csv" accept=".csv" required>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <p class="text-muted small">‡§Ø‡§π ‡§´‡§º‡§æ‡§á‡§≤ ‡§Ü‡§™ ‡§Ö‡§™‡§®‡•á ‡§¨‡•à‡§Ç‡§ï ‡§ï‡•Ä ‡§®‡•á‡§ü ‡§¨‡•à‡§Ç‡§ï‡§ø‡§Ç‡§ó ‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü ‡§™‡§∞ 'Account Statement' > 'Download Statement' ‡§∏‡•á‡§ï‡•ç‡§∂‡§® ‡§∏‡•á CSV ‡§´‡•â‡§∞‡•ç‡§Æ‡•á‡§ü ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§â‡§∏‡§Æ‡•á‡§Ç 'Date', 'Description', 'Debit'/'Withdrawal', ‡§î‡§∞ 'Credit'/'Deposit' ‡§ï‡•â‡§≤‡§Æ ‡§π‡•ã‡§Ç‡•§
                    </div>
                </div>
                <hr>
                <div class="text-end">
                    <button type="submit" class="btn btn-primary btn-lg" id="start-reconciliation-btn">
                        <i class="fas fa-play me-2"></i> ‡§∞‡§ø‡§ï‡•â‡§®‡•ç‡§∏‡§ø‡§≤‡•á‡§∂‡§® ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="reconciliation-matching-area" class="hidden">
        <h3 class="mb-3">‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä‡§ú‡§º ‡§ï‡§æ ‡§Æ‡§ø‡§≤‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç</h3>
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        Dukan Pro (‡§¨‡•Å‡§ï) ‡§ü‡•ç‡§∞‡§æ‡§Ç‡§ú‡•à‡§ï‡•ç‡§∂‡§®
                        <span id="book-total" class="badge bg-light text-dark float-end">‚Çπ0.00</span>
                    </div>
                    <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="check-all-book"></th>
                                    <th>‡§µ‡§ø‡§µ‡§∞‡§£</th>
                                    <th>‡§∞‡§æ‡§∂‡§ø (‚Çπ)</th>
                                </tr>
                            </thead>
                            <tbody id="book-transactions-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        ‡§¨‡•à‡§Ç‡§ï ‡§∏‡•ç‡§ü‡•á‡§ü‡§Æ‡•á‡§Ç‡§ü ‡§ü‡•ç‡§∞‡§æ‡§Ç‡§ú‡•à‡§ï‡•ç‡§∂‡§®
                        <span id="bank-total" class="badge bg-light text-dark float-end">‚Çπ0.00</span>
                    </div>
                    <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="check-all-bank"></th>
                                    <th>‡§µ‡§ø‡§µ‡§∞‡§£</th>
                                    <th>‡§∞‡§æ‡§∂‡§ø (‚Çπ)</th>
                                </tr>
                            </thead>
                            <tbody id="bank-transactions-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header bg-dark text-white">
                ‡§∞‡§ø‡§ï‡•â‡§®‡•ç‡§∏‡§ø‡§≤‡•á‡§∂‡§® ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂)
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <table class="table" id="reconciliation-report-table">
                            <tbody>
                                <tr>
                                    <td>‡§¨‡•à‡§Ç‡§ï ‡§∏‡•ç‡§ü‡•á‡§ü‡§Æ‡•á‡§Ç‡§ü ‡§ï‡§æ ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏</td>
                                    <td class="text-end" id="report-statement-balance">‚Çπ0.00</td>
                                </tr>
                                <tr>
                                    <td>‡§µ‡•á ‡§™‡•á‡§Æ‡•á‡§Ç‡§ü‡•ç‡§∏ ‡§ú‡•ã ‡§Ö‡§≠‡•Ä ‡§ï‡•ç‡§≤‡§ø‡§Ø‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§è (Uncleared Payments)</td>
                                    <td class="text-end" id="report-uncleared-payments">‚Çπ0.00</td>
                                </tr>
                                <tr>
                                    <td>‡§µ‡•á ‡§°‡§ø‡§™‡•â‡§ú‡§ø‡§ü ‡§ú‡•ã ‡§Ö‡§≠‡•Ä ‡§ï‡•ç‡§≤‡§ø‡§Ø‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§è (Uncleared Deposits)</td>
                                    <td class="text-end" id="report-uncleared-deposits">‚Çπ0.00</td>
                                </tr>
                                <tr class="fw-bold">
                                    <td>Dukan Pro (‡§¨‡•Å‡§ï) ‡§Æ‡•á‡§Ç ‡§è‡§°‡§ú‡§∏‡•ç‡§ü‡•á‡§° ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏</td>
                                    <td class="text-end" id="report-adjusted-balance">‚Çπ0.00</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-4 d-flex align-items-center justify-content-center">
                        <div id="reconciliation-status-box" class="p-3 text-center">
                            <h4 id="difference-amount" class="text-danger fw-bold">‚Çπ0.00 ‡§ï‡§æ ‡§Ö‡§Ç‡§§‡§∞</h4>
                            <p id="difference-status" class="text-muted">‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§Æ‡•à‡§ö ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü</p>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="text-end">
                    <button class="btn btn-secondary" id="cancel-reconciliation-btn">‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
                    <button class="btn btn-success" id="save-reconciliation-btn" disabled>
                        <i class="fas fa-save me-2"></i> ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç
                    </button>
                </div>
            </div>
        </div>
    </div> 
    <div class="card mt-4" id="previous-reports-area">
        <div class="card-header bg-secondary text-white">
            ‡§™‡§ø‡§õ‡§≤‡•Ä ‡§∞‡§ø‡§ï‡•â‡§®‡•ç‡§∏‡§ø‡§≤‡•á‡§∂‡§® ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏
        </div>
        <div class="card-body">
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ID</th>
                            <th>‡§∏‡•ç‡§ü‡•á‡§ü‡§Æ‡•á‡§Ç‡§ü ‡§ï‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ</th>
                            <th>‡§¨‡•à‡§Ç‡§ï ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ (‚Çπ)</th>
                            <th>‡§Ö‡§®‡§ï‡•ç‡§≤‡§ø‡§Ø‡§∞‡§∞‡•ç‡§° ‡§Ö‡§Æ‡§æ‡§â‡§Ç‡§ü (‚Çπ)</th>
                            <th>‡§∏‡•á‡§µ ‡§ï‡•Ä ‡§ó‡§à ‡§§‡§æ‡§∞‡•Ä‡§ñ</th>
                        </tr>
                    </thead>
                    <tbody id="previous-reports-body">
                        <tr><td colspan="5" class="text-center text-muted">‡§ï‡•ã‡§à ‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    </section>

        <section id="daily-closing" class="section">
            <h2 class="mb-4 text-primary">‡§°‡•á‡§≤‡•Ä ‡§ï‡•ç‡§≤‡•ã‡§ú‡§ø‡§Ç‡§ó</h2>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header bg-success text-white">‡§Ü‡§ú ‡§ï‡•Ä ‡§ï‡•ç‡§≤‡•ã‡§ú‡§ø‡§Ç‡§ó ‡§∞‡§® ‡§ï‡§∞‡•á‡§Ç</div>
                        <div class="card-body text-center">
                            <p>‡§Ü‡§ú ‡§ï‡•Ä ‡§∏‡§≠‡•Ä ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä, ‡§ñ‡§∞‡•ç‡§ö ‡§î‡§∞ ‡§≤‡§æ‡§≠ ‡§ï‡•ã ‡§´‡§æ‡§á‡§®‡§≤ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ç‡§≤‡•ã‡§ú‡§ø‡§Ç‡§ó ‡§∞‡§® ‡§ï‡§∞‡•á‡§Ç‡•§</p>
                            <button class="btn btn-success btn-lg" id="run-daily-closing-btn">
                                <i class="fas fa-play-circle me-2"></i> ‡§Ü‡§ú ‡§ï‡•Ä ‡§ï‡•ç‡§≤‡•ã‡§ú‡§ø‡§Ç‡§ó ‡§∞‡§® ‡§ï‡§∞‡•á‡§Ç
                            </button>
                            <div id="closing-message" class="mt-3"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">‡§™‡§ø‡§õ‡§≤‡•Ä ‡§ï‡•ç‡§≤‡•ã‡§ú‡§ø‡§Ç‡§ó ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏</div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>‡§§‡§æ‡§∞‡•Ä‡§ñ</th>
                                            <th>‡§ï‡•Å‡§≤ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä</th>
                                            <th>‡§ï‡•Å‡§≤ ‡§≤‡§æ‡§ó‡§§ (COGS)</th>
                                            <th>‡§ï‡•Å‡§≤ ‡§ñ‡§∞‡•ç‡§ö</th>
                                            <th>‡§∂‡•Å‡§¶‡•ç‡§ß ‡§≤‡§æ‡§≠</th>
                                        </tr>
                                    </thead>
                                    <tbody id="daily-closing-table-body">
                                        <tr><td colspan="5" class="text-center text-muted">‡§ï‡•ã‡§à ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="data-backup" class="section">
            <h2 class="mb-4 text-primary">‡§°‡•á‡§ü‡§æ ‡§¨‡•à‡§ï‡§Ö‡§™ (‡§è‡§°‡§Æ‡§ø‡§®)</h2>
            <div class="card">
                <div class="card-header">‡§Ö‡§™‡§®‡§æ ‡§°‡•á‡§ü‡§æ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç</div>
                <div class="card-body">
                    <p>‡§Ø‡§π‡§æ‡§Å ‡§Ü‡§™ ‡§Ö‡§™‡§®‡•Ä ‡§∂‡•â‡§™ ‡§ï‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§°‡•á‡§ü‡§æ ‡§¨‡•à‡§ï‡§Ö‡§™ ‡§Ø‡§æ ‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§</p>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="card p-3 text-center">
                                <h5>‡§´‡•Å‡§≤ ‡§∂‡•â‡§™ ‡§¨‡•à‡§ï‡§Ö‡§™ (JSON)</h5>
                                <p class="small text-muted">‡§∏‡•ç‡§ü‡•â‡§ï, ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï, ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä, ‡§ñ‡§∞‡•ç‡§ö ‡§Ü‡§¶‡§ø ‡§∏‡§¨ ‡§ï‡•Å‡§õ‡•§ (‡§§‡§ï‡§®‡•Ä‡§ï‡•Ä ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡•á ‡§≤‡§ø‡§è)</p>
                                <button class="btn btn-primary" id="download-json-backup-btn">
                                    <i class="fas fa-file-code"></i> JSON ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card p-3 text-center">
                                <h5>‡§´‡•Å‡§≤ ‡§∂‡•â‡§™ ‡§¨‡•à‡§ï‡§Ö‡§™ (Excel)</h5>
                                <p class="small text-muted">‡§∏‡§≠‡•Ä ‡§°‡•á‡§ü‡§æ ‡§è‡§ï Excel ‡§´‡§º‡§æ‡§á‡§≤ ‡§Æ‡•á‡§Ç (‡§Ö‡§≤‡§ó-‡§Ö‡§≤‡§ó ‡§∂‡•Ä‡§ü‡•ç‡§∏ ‡§Æ‡•á‡§Ç)‡•§</p>
                                <button class="btn btn-success" id="download-excel-backup-btn">
                                    <i class="fas fa-file-excel"></i> Excel (.xlsx) ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card p-3 text-center">
                                <h5>‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (CSV)</h5>
                                <p class="small text-muted">‡§§‡§æ‡§∞‡•Ä‡§ñ-‡§µ‡§æ‡§∞ ‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (CSV ‡§´‡•â‡§∞‡•ç‡§Æ‡•á‡§ü)‡•§</p>
                                <button class="btn btn-info" id="download-product-sales-csv-btn">
                                    <i class="fas fa-file-csv"></i> CSV ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="shop-settings" class="section">
            <h2 class="mb-4 text-primary">‡§∂‡•â‡§™ ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ (‡§è‡§°‡§Æ‡§ø‡§®)</h2>
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-info">‡§ï‡§Ç‡§™‡§®‡•Ä ‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ (GST ‡§î‡§∞ ‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§ï‡•á ‡§≤‡§ø‡§è)</div>
                        <div class="card-body">
                            <form id="company-profile-form">
                                <div class="mb-3">
                                    <label for="company-legal-name" class="form-label">‡§∂‡•â‡§™ ‡§ï‡§æ ‡§ï‡§æ‡§®‡•Ç‡§®‡•Ä ‡§®‡§æ‡§Æ</label>
                                    <input type="text" class="form-control" id="company-legal-name">
                                </div>
                                <div class="mb-3">
                                    <label for="company-gstin" class="form-label">‡§∂‡•â‡§™ ‡§ï‡§æ GSTIN</label>
                                    <input type="text" class="form-control" id="company-gstin" maxlength="15">
                                </div>
                                <div class="mb-3">
                                    <label for="company-address" class="form-label">‡§∂‡•â‡§™ ‡§ï‡§æ ‡§™‡§§‡§æ</label>
                                    <textarea class="form-control" id="company-address" rows="2"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="company-opening-capital" class="form-label">‡§ì‡§™‡§®‡§ø‡§Ç‡§ó ‡§ï‡•à‡§™‡§ø‡§ü‡§≤ (‡§∂‡•Å‡§∞‡•Å‡§Ü‡§§‡•Ä ‡§™‡•Ç‡§Ç‡§ú‡•Ä)</label>
                                    <input type="number" step="0.01" class="form-control" id="company-opening-capital" value="0" min="0">
                                </div>
                                <button type="submit" class="btn btn-primary w-100">‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">‡§∂‡•â‡§™ ‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏</div>
                        <div class="card-body">
                            <form id="shop-display-form">
                                <div class="mb-3">
                                    <label for="shop-display-name" class="form-label">‡§∂‡•â‡§™ ‡§ï‡§æ ‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á ‡§®‡§æ‡§Æ</label>
                                    <input type="text" class="form-control" id="shop-display-name">
                                    <div class="form-text">‡§Ø‡§π ‡§®‡§æ‡§Æ ‡§∏‡§æ‡§á‡§°‡§¨‡§æ‡§∞ ‡§Æ‡•á‡§Ç ‡§∏‡§¨‡§∏‡•á ‡§ä‡§™‡§∞ ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á‡§ó‡§æ‡•§</div>
                                </div>
                                <div class="mb-3">
                                    <label for="shop-logo-upload" class="form-label">‡§∂‡•â‡§™ ‡§≤‡•ã‡§ó‡•ã (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)</label>
                                    <input type="file" class="form-control" id="shop-logo-upload" accept="image/png, image/jpeg">
                                    <div class="form-text">‡§∏‡§¨‡§∏‡•á ‡§Ö‡§ö‡•ç‡§õ‡•á ‡§∞‡§ø‡§ú‡§≤‡•ç‡§ü ‡§ï‡•á ‡§≤‡§ø‡§è 1:1 (‡§∏‡•ç‡§ï‡•ç‡§µ‡§æ‡§Ø‡§∞) ‡§á‡§Æ‡•á‡§ú ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç‡•§</div>
                                    <img id="shop-logo-preview" src="" alt="Logo Preview" class="img-thumbnail mt-2" style="max-height: 100px; display: none;">
                                </div>
                                    <button type="button" id="remove-shop-logo-btn" class="btn btn-sm btn-outline-danger mt-2 d-none" onclick="removeShopLogo()">
                                    <i class="fas fa-trash"></i> ‡§≤‡•ã‡§ó‡•ã ‡§π‡§ü‡§æ‡§è‡§Å
                                </button>
                                <button type="submit" class="btn btn-primary w-100">‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>
                            </form>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="daily_reports" class="section">
            <div class="container-fluid p-4">
                
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="fw-bold text-primary"><i class="fas fa-calendar-alt"></i> Daily & Operational Reports</h3>
                    <button class="btn btn-outline-secondary btn-sm" onclick="renderDashboard()">Back</button>
                </div>
        
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-body bg-light rounded">
                        <div class="row g-3 align-items-end">
                            
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Select Report:</label>
                                <select id="daily-report-type" class="form-select border-primary fw-bold">
                                    <option value="DAILY_SALES_LIST">üìÖ Daily Sales List</option>
                                    <option value="ITEM_WISE_SALES">üì¶ Item Sales Analysis</option>
                                    <option value="TOP_CUSTOMERS">üèÜ Top Customers</option>
                                    <option value="CUSTOMER_OUTSTANDING">‚ö†Ô∏è Customer Udhari</option>
                                    <option value="LOW_STOCK">üìâ Low Stock Alert</option>
                                    <option value="EXPIRY_REPORT">üíä Expiry Report</option>
                                    <option value="DEAD_STOCK">üíÄ Dead Stock</option>
                                    <option value="PAINTER_COMMISSION">üé® Painter Commission</option>
                                    <option value="PAINT_MIXING_HISTORY">üñåÔ∏è Mixing History</option>
                                    <option value="STAFF_PERFORMANCE">üíá Staff Performance</option>
                                    <option value="REPAIR_JOB_HISTORY">üõ†Ô∏è Repair Job History (‡§ú‡•â‡§¨ ‡§ï‡§æ‡§∞‡•ç‡§°‡•ç‡§∏)</option>
                                    <option value="DELIVERY_REPORT">üöö Delivery Schedule (‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä ‡§≤‡§ø‡§∏‡•ç‡§ü)</option>
                                </select>
                            </div>
        
                            <div class="col-md-3">
                                <label class="form-label fw-bold">From:</label>
                                <input type="date" id="daily-start-date" class="form-control">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">To:</label>
                                <input type="date" id="daily-end-date" class="form-control">
                            </div>
        
                            <div class="col-md-2">
                                <button class="btn btn-primary w-100 fw-bold" onclick="generateDailyReport()">
                                    Show Data
                                </button>

                                <button class="btn btn-success w-100 fw-bold" onclick="downloadDailyReportExcel()">
                                    <i class="fas fa-file-excel"></i> Excel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
        
                <div class="card shadow border-0">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0 fw-bold text-dark" id="daily-report-title">Results</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-dark sticky-top">
                                    <tr id="daily-report-head"><th>Select a report...</th></tr>
                                </thead>
                                <tbody id="daily-report-body"> <tr><td class="text-center p-5 text-muted">No data yet.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="appToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto" id="toast-title"></strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body" id="toast-body">
                    Hello, world! This is a toast message.
                </div>
            </div>
        </div>
		
		
				<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
                <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    

<script>

    // [ ‚úÖ ‡§á‡§®‡•ç‡§π‡•á‡§Ç <script> ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã‡§§‡•á ‡§π‡•Ä ‡§∏‡§¨‡§∏‡•á ‡§ä‡§™‡§∞ ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç ]

    
// ‡§ó‡•ç‡§≤‡•ã‡§¨‡§≤ ‡§µ‡•á‡§∞‡§ø‡§è‡§¨‡§≤ (‡§á‡§∏‡•á ‡§∏‡§¨‡§∏‡•á ‡§ä‡§™‡§∞ ‡§∞‡§ñ‡•á‡§Ç)
// ‚úÖ GLOBAL BUSINESS TYPE


    let isMixingModeActive = false;
    let posWebSocket = null;
	let mySalesChart = null;
    let qrCodeDataUrl = null; // üöÄ ‡§®‡§Ø‡§æ: QR ‡§ï‡•ã‡§° ‡§á‡§Æ‡•á‡§ú ‡§°‡•á‡§ü‡§æ ‡§∞‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è
    let isWaitingForQr = false; // üöÄ ‡§®‡§Ø‡§æ: ‡§¨‡§§‡§æ‡§è‡§ó‡§æ ‡§ï‡§ø QR ‡§ï‡§æ ‡§á‡§Ç‡§§‡§ú‡§º‡§æ‡§∞ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à
    
    function isMobile() {
    // ‡§Ö‡§ó‡§∞ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§ñ‡•Å‡§¶ ‡§¨‡§§‡§æ‡§§‡§æ ‡§π‡•à ‡§ï‡§ø ‡§Ø‡§π ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§π‡•à
    try {
        if (navigator.userAgentData && navigator.userAgentData.mobile) {
            return true;
        }
    } catch (e) {}

    // ‡§Ø‡§æ ‡§´‡§ø‡§∞ UserAgent ‡§∏‡•ç‡§ü‡•ç‡§∞‡§ø‡§Ç‡§ó ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç (Android, iPhone, etc.)
    return /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}
    
   
// [ initPosWebSocket ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã ‡§á‡§∏ ‡§ï‡•ã‡§° ‡§∏‡•á ‡§¨‡§¶‡§≤ ‡§¶‡•á‡§Ç ]

// [ ‡§Ø‡§π initPosWebSocket ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡§æ ‡§®‡§Ø‡§æ ‡§ï‡•ã‡§° ‡§π‡•à ]

function initPosWebSocket() {
    // ‡§Ö‡§ó‡§∞ ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§ñ‡•Å‡§≤‡§æ ‡§π‡•à, ‡§§‡•ã ‡§®‡§Ø‡§æ ‡§ï‡•ã‡§° ‡§Æ‡§æ‡§Ç‡§ó‡•á‡§Ç ‡§î‡§∞ ‡§¨‡§æ‡§π‡§∞ ‡§Ü ‡§ú‡§æ‡§è‡§Ç
    if (posWebSocket && posWebSocket.readyState === WebSocket.OPEN) {
        posWebSocket.send(JSON.stringify({ type: 'REGISTER_POS', token: AppState.token }));
        return;
    }

    const wsUrl = __backend_url.replace('https', 'wss').replace('http', 'ws');
    posWebSocket = new WebSocket(wsUrl);

    posWebSocket.onopen = () => {
        console.log("POS WebSocket Connected");
        posWebSocket.send(JSON.stringify({ type: 'REGISTER_POS', token: AppState.token }));
    };

    posWebSocket.onmessage = (event) => {
        const data = JSON.parse(event.data);

        // =========================================================
        // üöÄ NEW LOGIC: ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§ï‡•ç‡§Ø‡§æ "‡§™‡•á‡§Ç‡§ü ‡§Æ‡§ø‡§ï‡•ç‡§∏‡§ø‡§Ç‡§ó" ‡§µ‡§ø‡§Ç‡§°‡•ã ‡§ñ‡•Å‡§≤‡•Ä ‡§π‡•à?
        // =========================================================
        const paintModal = document.getElementById('paintMixingModal');
        const isPaintMode = paintModal && paintModal.classList.contains('show');

        // --- 1. ‡§™‡•Å‡§∞‡§æ‡§®‡•á (POS Inline) ‡§∏‡•ç‡§ï‡•à‡§®‡§∞ ‡§ï‡•á ‡§è‡§≤‡§ø‡§Æ‡•á‡§Ç‡§ü‡•ç‡§∏ ---
        const inlineCode = document.getElementById('inline-pairing-code');
        const inlineSpinner = document.getElementById('inline-pairing-spinner');
        const inlineStatus = document.getElementById('inline-pairing-status');
        const inlineBox = document.getElementById('inline-pairing-box');

        // --- 2. ‡§®‡§è (Paint OTP Box) ‡§ï‡•á ‡§è‡§≤‡§ø‡§Æ‡•á‡§Ç‡§ü‡•ç‡§∏ ---
        // (‡§®‡•ã‡§ü: ‡§π‡§Æ‡§®‡•á HTML ‡§Æ‡•á‡§Ç ‡§á‡§®‡§ï‡•á ID 'paint-otp-...' ‡§∞‡§ñ‡•á ‡§•‡•á)
        const paintBox = document.getElementById('paint-otp-box');
        const paintCode = document.getElementById('paint-otp-code');
        const paintSpinner = document.getElementById('paint-otp-spinner');
        const paintStatus = document.getElementById('paint-otp-status');

        switch (data.type) {
            case 'PAIR_CODE_GENERATED':
                console.log("PAIR_CODE:", data.pairCode);
                
                if (isPaintMode) {
                    // üëâ ‡§Ö‡§ó‡§∞ ‡§™‡•á‡§Ç‡§ü ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§ñ‡•Å‡§≤‡•Ä ‡§π‡•à -> ‡§ï‡•ã‡§° ‡§≤‡§æ‡§≤ ‡§¨‡§ü‡§® ‡§µ‡§æ‡§≤‡•á ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
                    if (paintBox) paintBox.style.display = 'block';
                    if (paintCode) paintCode.innerText = data.pairCode;
                    if (paintSpinner) paintSpinner.style.display = 'none';
                    if (paintStatus) paintStatus.style.display = 'none';

                    // ‡§™‡•Å‡§∞‡§æ‡§®‡•á ‡§µ‡§æ‡§≤‡•á ‡§ï‡•ã ‡§õ‡§ø‡§™‡§æ ‡§¶‡•á‡§Ç ‡§§‡§æ‡§ï‡§ø ‡§ï‡§®‡•ç‡§´‡•ç‡§Ø‡•Ç‡§ú‡§® ‡§® ‡§π‡•ã
                    if (inlineBox) inlineBox.style.display = 'none';
                } else {
                    // üëâ ‡§Ö‡§ó‡§∞ ‡§®‡•â‡§∞‡•ç‡§Æ‡§≤ POS ‡§π‡•à -> ‡§ï‡•ã‡§° ‡§™‡•Å‡§∞‡§æ‡§®‡•á ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
                    if (inlineBox) inlineBox.style.display = 'block';
                    if (inlineCode) { inlineCode.textContent = data.pairCode; inlineCode.style.display = 'inline-block'; }
                    if (inlineSpinner) inlineSpinner.style.display = 'none';
                    if (inlineStatus) inlineStatus.style.display = 'none';

                    // ‡§™‡•á‡§Ç‡§ü ‡§µ‡§æ‡§≤‡•á ‡§ï‡•ã ‡§õ‡§ø‡§™‡§æ ‡§¶‡•á‡§Ç
                    if (paintBox) paintBox.style.display = 'none';
                }
                break;

            case 'SCANNER_PAIRED':
                console.log("‡§∏‡•ç‡§ï‡•à‡§®‡§∞ ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ!");
                
                // ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§ú‡§ó‡§π‡•ã‡§Ç ‡§™‡§∞ "Success" ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç (‡§§‡§æ‡§ï‡§ø ‡§Ø‡•Ç‡§ú‡§∞ ‡§ï‡§π‡•Ä‡§Ç ‡§≠‡•Ä ‡§π‡•ã ‡§â‡§∏‡•á ‡§™‡§§‡§æ ‡§ö‡§≤‡•á)
                if (inlineSpinner) inlineSpinner.style.display = 'none';
                if (inlineCode) inlineCode.style.display = 'none';
                if (inlineStatus) { 
                    inlineStatus.style.display = 'block'; 
                    inlineStatus.innerHTML = '<i class="fas fa-check-circle"></i> ‡§∏‡•ç‡§ï‡•à‡§®‡§∞ ‡§ï‡§®‡•á‡§ï‡•ç‡§ü‡•á‡§°!';
                }

                if (paintSpinner) paintSpinner.style.display = 'none';
                if (paintStatus) {
                    paintStatus.style.display = 'block';
                    paintStatus.innerHTML = '<i class="fas fa-check-circle"></i> ‡§ï‡§®‡•á‡§ï‡•ç‡§ü‡•á‡§°!';
                }
                break;

            case 'SKU_SCANNED':
                console.log("SKU ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§π‡•Å‡§Ü:", data.sku);
                // handleBarcodeScan ‡§Ö‡§™‡§®‡•á ‡§Ü‡§™ ‡§§‡§Ø ‡§ï‡§∞‡•á‡§ó‡§æ ‡§ï‡§ø ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§≤‡§æ‡§≤ ‡§¨‡§ü‡§® ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§®‡•Ä ‡§π‡•à ‡§Ø‡§æ ‡§ï‡§æ‡§∞‡•ç‡§ü ‡§Æ‡•á‡§Ç
                handleBarcodeScan(data.sku); 
                break;

            case 'SCANNER_DISCONNECTED':
                // ‡§Ö‡§ó‡§∞ ‡§°‡§ø‡§∏‡•ç‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§π‡•ã ‡§ú‡§æ‡§è, ‡§§‡•ã ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§ú‡§ó‡§π‡•ã‡§Ç ‡§™‡§∞ ‡§∞‡§ø‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
                if (inlineSpinner) inlineSpinner.style.display = 'inline-block';
                if (inlineCode) { inlineCode.textContent = '------'; inlineCode.style.display = 'inline-block'; }
                
                if (paintSpinner) paintSpinner.style.display = 'inline-block';
                if (paintCode) paintCode.innerText = '------';
                
                // ‡§®‡§Ø‡§æ ‡§ï‡•ã‡§° ‡§Æ‡§æ‡§Ç‡§ó‡•á‡§Ç
                if (posWebSocket.readyState === WebSocket.OPEN) {
                    posWebSocket.send(JSON.stringify({ type: 'REGISTER_POS', token: AppState.token }));
                }
                break;
        }
    };

    posWebSocket.onclose = () => {
        console.log("WebSocket Disconnected");
        posWebSocket = null;
    };
}

// [ closePosWebSocket ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§¨‡§¶‡§≤‡•á‡§Ç ]
function closePosWebSocket() {
    if (posWebSocket) {
        posWebSocket.close();
        posWebSocket = null;
        console.log("WebSocket connection closed.");
    }
    // ‡§∏‡§ø‡§∞‡•ç‡§´ ‡§á‡§®‡§≤‡§æ‡§á‡§® ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§õ‡§ø‡§™‡§æ‡§è‡§Å
    const inlineBox = document.getElementById('inline-pairing-box');
    if(inlineBox) inlineBox.style.display = 'none';
}


// [ ‡§á‡§∏‡•á ‡§á‡§∏‡§∏‡•á ‡§¨‡§¶‡§≤‡•á‡§Ç ]
    function closePosWebSocket() {
        // WebSocket ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç (‡§Ö‡§ó‡§∞ ‡§ñ‡•Å‡§≤‡§æ ‡§π‡•à)
        if (posWebSocket) {
            posWebSocket.close();
            posWebSocket = null;
            console.log("WebSocket connection closed by user.");
        }
        
        // üöÄ ‡§®‡§Ø‡§æ: Modal ‡§ï‡•ã ‡§≠‡•Ä ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç (‡§Ö‡§ó‡§∞ ‡§ñ‡•Å‡§≤‡§æ ‡§π‡•à)
        if (pairingModalInstance) {
            pairingModalInstance.hide();
            console.log("Pairing modal hidden.");
        }
    }



   const __backend_url = 'https://dukan-pro-ultimate.onrender.com';
    const SERVER_TIMEOUT = 20000; // 20 seconds for slow connections

// ==========================================
// üöÄ MISSING CONFIGURATION (‡§á‡§∏‡•á ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç)
// ==========================================
// ==========================================================
// üöÄ MASTER BUSINESS CONFIGURATION (ALL 31 TYPES)
// ==========================================================
const MASTER_BUSINESS_CONFIG = {
    // --- 1. RETAIL & SHOPS ---
    'RETAIL': {
        name: 'General Store / Kirana',
        labels: { customer: 'Customer', stock: 'Qty' },
        features: ['expiry_date'],
        dashboard_view: 'retail_grid'
    },
    'MOBILE_SHOP': {
        name: 'Mobile & Accessories',
        labels: { customer: 'Customer', stock: 'Qty' },
        features: ['imei_scan', 'repair_status'],
        dashboard_view: 'retail_grid'
    },
    'CLOTHING': {
        name: 'Garments / Boutique',
        labels: { customer: 'Customer', stock: 'Qty' },
        features: ['size_color', 'tailoring_measurements'],
        dashboard_view: 'retail_grid'
    },
    'FURNITURE': {
        name: 'Furniture Showroom',
        labels: { customer: 'Customer', stock: 'Qty' },
        features: ['delivery_tracking', 'assembly'],
        dashboard_view: 'retail_grid'
    },
    'JEWELLERY': {
        name: 'Jewellery / Imitation',
        labels: { customer: 'Customer', stock: 'Pcs/Grams' },
        features: ['weight_calc'],
        dashboard_view: 'retail_grid'
    },
    // MASTER_BUSINESS_CONFIG ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§á‡§∏‡•á ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç:

    // --- 1. HARDWARE (Updated for Locks & Safes) ---
   // --- 1. HARDWARE (Updated for Locks & Safes) ---
   'HARDWARE_GENERAL': {
        name: 'Hardware, Locks & Safes',
        labels: { customer: 'Customer', stock: 'Qty/Pcs' },
        
        // üöÄ ‡§á‡§® ‡§¶‡•ã ‡§´‡•Ä‡§ö‡§∞‡•ç‡§∏ ‡§∏‡•á ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä ‡§î‡§∞ ‡§∞‡§ø‡§™‡•á‡§Ø‡§∞‡§ø‡§Ç‡§ó ‡§ö‡§æ‡§≤‡•Ç ‡§π‡•ã ‡§ú‡§æ‡§è‡§ó‡•Ä
        features: ['delivery_tracking', 'job_card'], 
        
        dashboard_view: 'retail_grid'
    },

    // --- 2. PAINT SHOP (Full Features) ---
    'PAINT_SHOP': {
        name: 'Paint Shop (Color Studio)',
        labels: { customer: 'Painter/Customer', stock: 'Ltr/Drum' },
        features: ['paint_mixing', 'estimate'], // ‡§Ø‡§π‡§æ‡§Å ‡§Æ‡§ø‡§ï‡•ç‡§∏‡§∞ ‡§î‡§∞ ‡§è‡§∏‡•ç‡§ü‡•Ä‡§Æ‡•á‡§ü‡§∞ ‡§ö‡§æ‡§≤‡•Ç ‡§∞‡§π‡•á‡§ó‡§æ
        dashboard_view: 'retail_grid'
    },
    'SWEET_SHOP': {
        name: 'Sweet Shop / Bakery',
        labels: { customer: 'Customer', stock: 'Kg/Pcs' },
        features: ['expiry_date', 'manufacturing_date'],
        dashboard_view: 'retail_grid'
    },
    'ELECTRONICS': {
        name: 'Electronics Showroom',
        labels: { customer: 'Customer', stock: 'Qty' },
        features: ['imei_scan', 'serial_no'],
        dashboard_view: 'retail_grid'
    },
    'SIM_STORE': {
        name: 'SIM Card & Recharge',
        labels: { customer: 'Customer', stock: 'Qty' },
        features: ['mobile_no_entry'],
        dashboard_view: 'retail_grid'
    },

    // --- 2. MEDICAL & HEALTH (Features: Prescriptions, Expiry) ---
    'PHARMACY': {
        name: 'Medical Store / Pharmacy',
        labels: { customer: 'Patient', stock: 'Strip/Box' },
        features: ['expiry_date', 'batch_no', 'doctor_ref'],
        dashboard_view: 'retail_grid'
    },
    'DOCTOR_CLINIC': {
        name: 'Doctor Clinic',
        labels: { customer: 'Patient', stock: 'Medicine' },
        features: ['prescription_pad', 'report_templates'],
        dashboard_view: 'retail_grid'
    },
    'ORTHOPEDIC': {
        name: 'Orthopedic Clinic',
        labels: { customer: 'Patient', stock: 'Equipment' },
        features: ['prescription_pad', 'xray_attach'],
        dashboard_view: 'retail_grid'
    },
    'DENTIST': {
        name: 'Dental Clinic',
        labels: { customer: 'Patient', stock: 'Kit' },
        features: ['tooth_chart', 'prescription_pad'],
        dashboard_view: 'retail_grid'
    },
    'SONOGRAPHY': {
        name: 'Sonography Centre',
        labels: { customer: 'Patient', stock: 'Consumables' },
        features: ['lmp_calc', 'report_templates'],
        dashboard_view: 'retail_grid'
    },
    'PHYSIOTHERAPY': {
        name: 'Physiotherapy Centre',
        labels: { customer: 'Patient', stock: 'Sessions' },
        features: ['appointment_booking', 'prescription_pad'],
        dashboard_view: 'retail_grid'
    },
    'PATHOLOGY': {
        name: 'Pathology Lab',
        labels: { customer: 'Patient', stock: 'Reagents' },
        features: ['report_templates', 'sample_tracking'],
        dashboard_view: 'retail_grid'
    },

    // --- 3. SERVICES & PERSONAL CARE (Special Dashboard for Salon) ---
    'SALON': {
        name: 'Luxury Salon / Spa',
        labels: { customer: 'Client', stock: 'Unit/Usage' },
        features: ['appointment_booking', 'staff_commission'],
        dashboard_view: 'salon_dashboard' // ‡§Ø‡§π Salon Dashboard ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§ó‡§æ
    },
    'GYM': {
        name: 'Gym / Fitness Center',
        labels: { customer: 'Member', stock: 'Supplements' },
        features: ['attendance', 'subscription_expiry'],
        dashboard_view: 'retail_grid'
    },
    'TAILOR': {
        name: 'Tailor / Boutique',
        labels: { customer: 'Customer', stock: 'Fabric' },
        features: ['tailoring_measurements', 'delivery_date'],
        dashboard_view: 'retail_grid'
    },
    'SERVICE_CENTER': {
        name: 'Repairing Center',
        labels: { customer: 'Customer', stock: 'Spare Parts' },
        features: ['job_card', 'repair_status'],
        dashboard_view: 'retail_grid'
    },

    // --- 4. HOSPITALITY & FOOD ---
    'RESTAURANT': {
        name: 'Restaurant / Cafe',
        labels: { customer: 'Guest', stock: 'Ingredients' },
        features: ['table_kot', 'kitchen_display'],
        dashboard_view: 'retail_grid'
    },
    'HOTEL': {
        name: 'Hotel / Lodging',
        labels: { customer: 'Guest', stock: 'Amenities' },
        features: ['room_checkin', 'table_kot'],
        dashboard_view: 'retail_grid'
    },
    'TENT_HOUSE': {
        name: 'Tent House / Rentals',
        labels: { customer: 'Customer', stock: 'Item' },
        features: ['rental_dates', 'security_deposit'],
        dashboard_view: 'retail_grid'
    },

    // --- 5. CONSTRUCTION & TRANSPORT ---
    'TILES_CERAMIC': {
        name: 'Tiles & Sanitaryware',
        labels: { customer: 'Customer', stock: 'Box/Sq.Ft' },
        features: ['sqft_calc', 'breakage_entry'],
        dashboard_view: 'retail_grid'
    },
    'TRANSPORT': {
        name: 'Transport / Logistics',
        labels: { customer: 'Party/Client', stock: 'Vehicle' },
        features: ['trip_management', 'fuel_expense'],
        dashboard_view: 'retail_grid'
    },

    // --- 6. FINANCE & AGENTS ---
    'LOAN_DSA': {
        name: 'Loan / Credit Card DSA',
        labels: { customer: 'Applicant', stock: 'File' },
        features: ['geo_tagging', 'commission_calc', 'loan_status'],
        dashboard_view: 'retail_grid'
    },
    'RECOVERY_AGENT': {
        name: 'Recovery / Collection',
        labels: { customer: 'Borrower', stock: 'Case' },
        features: ['geo_tagging', 'recovery_collection', 'visit_log'],
        dashboard_view: 'retail_grid'
    },
    'INSURANCE_AGENCY': {
        name: 'Insurance Agent',
        labels: { customer: 'Policy Holder', stock: 'Policy' },
        features: ['renewal_date', 'commission_calc'],
        dashboard_view: 'retail_grid'
    },

    // --- 7. EDUCATION & OFFICE ---
    'SCHOOL': {
        name: 'School / Coaching',
        labels: { customer: 'Student', stock: 'Books/Uniform' },
        features: ['fees_management', 'attendance'],
        dashboard_view: 'retail_grid'
    },
    'ARCHITECT_FIRM': {
        name: 'Architect / Interior',
        labels: { customer: 'Client', stock: 'Material' },
        features: ['project_billing', 'site_visit'],
        dashboard_view: 'retail_grid'
    },
    'SOFTWARE_COMPANY': {
        name: 'Software / IT Firm',
        labels: { customer: 'Client', stock: 'License' },
        features: ['project_billing', 'amc_renewal'],
        dashboard_view: 'retail_grid'
    }
};

    const AppState = {
        token: null,     // Will store the JWT
        user: null,      // Will store user info (id, email, role, shopId)
        currentView: 'dashboard',
        licenseTimerId: null, // NEW: To store the license timer
    };
    
    // --- INVOICE GENERATOR PRO VARIABLES ---
    let items = [];
    let qrCodeImage = '';

    // --- POS (SALES) SECTION STATE ---
    let posCart = [];
    let currentStock = [];
    
    // --- CORE UTILITY FUNCTIONS ---
    const showLoader = (message = '‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...') => {
        document.getElementById('loading-message').innerText = message;
        document.getElementById('loading-overlay').classList.remove('hidden');
    };

    const hideLoader = () => {
        document.getElementById('loading-overlay').classList.add('hidden');
    };
    

/* ==============================================
   üì± MOBILE TABLE FIX (STICKY ACTIONS)
   ============================================== */
   /* ==============================================
   üì± MOBILE TABLE FIX (STICKY ACTIONS)
   ============================================== */


// [ ‡§Ø‡§π ‡§ï‡•ã‡§° ‡§Ö‡§™‡§®‡•á HTML ‡§ï‡•Ä <script> ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§≤‡•á‡§Ç ]

    let dashboardSocket = null; // Dashboard WebSocket ‡§ï‡•á ‡§≤‡§ø‡§è ‡§®‡§Ø‡§æ ‡§µ‡•á‡§∞‡§ø‡§è‡§¨‡§≤

/**
 * üöÄ NAYA: Live Dashboard WebSocket ‡§ï‡•ã ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
 */
function initDashboardSocket() {
    // ‡§Ö‡§ó‡§∞ ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§π‡•à, ‡§§‡•ã ‡§ï‡•Å‡§õ ‡§® ‡§ï‡§∞‡•á‡§Ç
    if (dashboardSocket && dashboardSocket.readyState === WebSocket.OPEN) {
        return;
    }

    // ‡§∏‡§∞‡•ç‡§µ‡§∞ URL ‡§ï‡•ã http ‡§∏‡•á ws/wss ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤‡•á‡§Ç
    const wsUrl = __backend_url.replace('https', 'wss').replace('http', 'ws');
    dashboardSocket = new WebSocket(wsUrl);

    // 1. ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§ñ‡•Å‡§≤‡§®‡•á ‡§™‡§∞
    dashboardSocket.onopen = () => {
        console.log("‚úÖ Live Dashboard WebSocket ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ‡•§");
        // ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§ï‡•ã ‡§Ö‡§™‡§®‡§æ ‡§ü‡•ã‡§ï‡§® ‡§≠‡•á‡§ú‡§ï‡§∞ ‡§ñ‡•Å‡§¶ ‡§ï‡•ã ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡§∞‡•á‡§Ç
        dashboardSocket.send(JSON.stringify({
            type: 'REGISTER_DASHBOARD',
            token: AppState.token // ‡§Ü‡§™‡§ï‡§æ ‡§≤‡•â‡§ó‡§ø‡§® ‡§ü‡•ã‡§ï‡§®
        }));
    };

    // 2. ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§Æ‡•à‡§∏‡•á‡§ú ‡§Æ‡§ø‡§≤‡§®‡•á ‡§™‡§∞
    dashboardSocket.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === 'DASHBOARD_REGISTERED') {
            console.log("‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§®‡•á ‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡•Ä:", data.message);
        }

        // 3. üöÄ ‡§Ø‡§π ‡§∏‡§¨‡§∏‡•á ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§π‡•à!
        if (data.type === 'DASHBOARD_UPDATE') {
            console.log('üî• Live Update ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§π‡•Å‡§Ü! ‡§°‡•á‡§ü‡§æ ‡§∞‡•Ä‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...', data.view);
            
            // (‡§è‡§ï ‡§õ‡•ã‡§ü‡§æ ‡§∏‡§æ ‡§Æ‡•à‡§∏‡•á‡§ú ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å)
            showMessage('‡§≤‡§æ‡§á‡§µ ‡§Ö‡§™‡§°‡•á‡§ü', `‡§è‡§ï ‡§®‡§à '${data.view}' ‡§¶‡§∞‡•ç‡§ú ‡§π‡•Å‡§à ‡§π‡•à, ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...`, 'info');

            // 4. ‡§Ö‡§™‡§®‡•á ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§ï‡•ã ‡§∞‡•Ä‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ö‡§≤‡§æ‡§è‡§Å
            // (‡§Ø‡§π ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ‡§Ü‡§™‡§ï‡•á HTML ‡§Æ‡•á‡§Ç ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§π‡•à)
            if (typeof renderDashboard === 'function') {
                renderDashboard();
            }
            
            // (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï: ‡§Ø‡§¶‡§ø ‡§Ü‡§™ ‡§ï‡•á‡§µ‡§≤ ‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§π‡§ø‡§∏‡•ç‡§∏‡•ã‡§Ç ‡§ï‡•ã ‡§∞‡•Ä‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç)
            // if (data.view === 'sales' && typeof fetchAndRenderSales === 'function') {
            //     fetchAndRenderSales();
            // }
        }
    };

    // 3. ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§¨‡§Ç‡§¶ ‡§π‡•ã‡§®‡•á ‡§™‡§∞
    dashboardSocket.onclose = () => {
        console.log("‚ùå Live Dashboard WebSocket ‡§°‡§ø‡§∏‡•ç‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ‡•§ 5 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§Æ‡•á‡§Ç ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ...");
        dashboardSocket = null;
        // 5 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§¨‡§æ‡§¶ ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç
        setTimeout(initDashboardSocket, 5000);
    };

    // 4. ‡§è‡§∞‡§∞ ‡§π‡•ã‡§®‡•á ‡§™‡§∞
    dashboardSocket.onerror = (error) => {
        console.error("WebSocket Error:", error);
        dashboardSocket.close(); // ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç (onclose ‡§á‡§∏‡•á ‡§∞‡•Ä‡§∏‡•ç‡§ü‡§æ‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§ó‡§æ)
    };
}
/**
 * ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§ø‡§è ‡§ó‡§è ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§π‡•à‡§Ç‡§°‡§≤ ‡§ï‡§∞‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§®‡•§
 */
// ‡§¨‡§¶‡§≤‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§ï‡•ã‡§°: handleBarcodeScan (‡§™‡•Ç‡§∞‡§æ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ‡§¨‡§¶‡§≤‡•á‡§Ç)
// ‡§Ø‡§π ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§ï‡§ø ‡§Ø‡§π ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§á‡§®‡§™‡•Å‡§ü ‡§∏‡•á ‡§Ø‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§∏‡•ç‡§ï‡•à‡§®‡§∞ ‡§∏‡•á SKU ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§
// [ ‚úÖ Is Poore Naye "Smart Scan" Code ko Line 2307 par Paste Karein ]

/**
 * NAYA "SMART SCAN" HANDLER (Point 1, 2, 4)
 * Yeh function sab kuchh handle karta hai:
 * 1. Physical scanner (null SKU)
 * 2. WebSocket scanner (scanned SKU)
 * 3. Smart QR (JSON data)
 * 4. Naya item (404 Error)
 */
 // [ ‚úÖ ULTRA-SMART SCANNER FUNCTION - ‡§á‡§∏‡•á ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç ]

 async function handleBarcodeScan(skuFromScanner = null) {
    let scannedData;

    // 1. ‡§á‡§®‡§™‡•Å‡§ü ‡§∏‡•ã‡§∞‡•ç‡§∏ ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç
    if (skuFromScanner) {
        scannedData = skuFromScanner;
    } else {
        const barcodeInput = document.getElementById('barcode-scanner-input');
        if (barcodeInput) {
            scannedData = barcodeInput.value.trim();
            barcodeInput.value = ''; 
        }
    }

    if (!scannedData) return; 

    // =========================================================
    // üöÄ NEW: ‡§™‡•á‡§Ç‡§ü ‡§Æ‡§ø‡§ï‡•ç‡§∏‡§ø‡§Ç‡§ó ‡§≤‡•â‡§ú‡§ø‡§ï (Safe Mode)
    // =========================================================
    const paintModal = document.getElementById('paintMixingModal');
    
    // ‡§ö‡•á‡§ï: ‡§ï‡•ç‡§Ø‡§æ ‡§Æ‡•ã‡§°‡§≤ ‡§ñ‡•Å‡§≤‡§æ ‡§π‡•à ‡§Ø‡§æ ‡§´‡•ç‡§≤‡•à‡§ó ‡§è‡§ï‡•ç‡§ü‡§ø‡§µ ‡§π‡•à?
    const isPaintOpen = paintModal && (paintModal.classList.contains('show') || (typeof isMixingModeActive !== 'undefined' && isMixingModeActive));

    if (isPaintOpen) {
        // ‡§Ö‡§ó‡§∞ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§ó‡§≤‡§§‡•Ä ‡§∏‡•á ‡§¨‡§Ç‡§¶ ‡§π‡•à, ‡§§‡•ã ‡§µ‡§æ‡§™‡§∏ ‡§ñ‡•ã‡§≤‡•á‡§Ç
        if (paintModal && !paintModal.classList.contains('show')) {
            const modalInstance = new bootstrap.Modal(paintModal);
            modalInstance.show();
        }

        // ‡§∏‡•ç‡§ü‡•â‡§ï ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç
        const existingItem = (typeof currentStock !== 'undefined') ? currentStock.find(s => s.sku === scannedData) : null;

        if (existingItem) {
            // ‚úÖ ‡§Ü‡§á‡§ü‡§Æ ‡§Æ‡§ø‡§≤ ‡§ó‡§Ø‡§æ -> ‡§≤‡§æ‡§≤ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§Æ‡•á‡§Ç ‡§≠‡§∞‡•á‡§Ç
            const baseSkuInput = document.getElementById('mix-base-sku');
            if(baseSkuInput) baseSkuInput.value = scannedData;
            
            if (typeof fetchBaseDetails === 'function') {
                fetchBaseDetails(scannedData);
            }
            
            if (typeof showMessage === 'function') {
                showMessage('‡§∏‡•ç‡§ï‡•à‡§® ‡§∏‡§´‡§≤', '‡§¨‡•á‡§∏: ' + existingItem.name + ' ‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§Ø‡§æ', 'success');
            }

        } else {
            // ‚ùå ‡§Ü‡§á‡§ü‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ
            if (typeof stopLocalScanner === 'function') stopLocalScanner();

            if(confirm('‡§Ü‡§á‡§ü‡§Æ (SKU: ' + scannedData + ') ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§\n‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§á‡§∏‡•á ‡§Ö‡§≠‡•Ä ‡§®‡§Ø‡§æ ‡§ú‡•ã‡§°‡§º‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?')) {
                const quickModalEl = document.getElementById('quickAddItemModal');
                if (quickModalEl) {
                    const quickAddModal = new bootstrap.Modal(quickModalEl);
                    document.getElementById('quick-add-item-form').reset();
                    document.getElementById('quick-add-sku').value = scannedData;
                    quickAddModal.show();
                    
                    quickModalEl.addEventListener('shown.bs.modal', function() {
                        document.getElementById('quick-add-name').focus();
                    }, { once: true });
                }
            }
        }
        
        // ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§´‡•ç‡§≤‡•à‡§ó ‡§π‡§ü‡§æ‡§è‡§Ç
        if (typeof stopLocalScanner === 'function') stopLocalScanner();
        if (typeof isMixingModeActive !== 'undefined') isMixingModeActive = false;
        
        return; // ‡§™‡•á‡§Ç‡§ü ‡§ï‡§æ ‡§ï‡§æ‡§Æ ‡§ñ‡§§‡•ç‡§Æ, ‡§Ø‡§π‡•Ä‡§Ç ‡§∞‡•Å‡§ï‡•á‡§Ç
    }

    // =========================================================
    // üöÄ Normal Billing / Smart QR Logic (Old Code)
    // =========================================================
    if (scannedData.startsWith('{') && scannedData.endsWith('}')) {
        try {
            const itemData = JSON.parse(scannedData);
            if (itemData.sku && itemData.name && itemData.sale_price) {
                if(typeof showLoader === 'function') showLoader('Smart QR Processing...');
                
                try {
                    const res = await fetchApi('/api/stock', {
                        method: 'POST',
                        body: {
                            sku: itemData.sku,
                            name: itemData.name,
                            sale_price: itemData.sale_price,
                            purchase_price: itemData.purchase_price || 0,
                            quantity: 1,
                            unit: 'Pcs',
                            product_attributes: {
                                "Size": itemData.size || "N/A",
                                "Color": itemData.color || "N/A"
                            }
                        }
                    }, null);

                    const finalItem = (res.success && res.stock) ? res.stock : itemData;
                    if(typeof currentStock !== 'undefined') {
                        const existingIdx = currentStock.findIndex(s => s.sku === finalItem.sku);
                        if (existingIdx > -1) currentStock[existingIdx] = { ...currentStock[existingIdx], ...finalItem };
                        else currentStock.push(finalItem);
                    }
                } catch (err) {
                    console.log("Server save skipped, adding to local cart.");
                    if(typeof currentStock !== 'undefined') {
                        currentStock.push({...itemData, quantity: 100});
                    }
                }

                if(typeof addSKUToCart === 'function') addSKUToCart(itemData.sku);
                if(typeof hideLoader === 'function') hideLoader();
                if(typeof showMessage === 'function') showMessage('‡§∏‡§´‡§≤‡§§‡§æ', 'Smart QR Added!', 'success');
                return;
            }
        } catch (e) {
            console.warn("QR JSON Parse Error", e);
        }
    }

    // Standard Barcode Check
    try {
        const stockItem = await fetchApi('/api/get-stock-item/' + scannedData, { method: 'GET' }, null);

        if (stockItem.success) {
            if(typeof addSKUToCart === 'function') addSKUToCart(scannedData);
        } else {
            throw new Error(stockItem.message);
        }

    } catch (error) {
        if (error.message.includes('404') || error.message.includes('‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ')) {
            const modalElement = document.getElementById('quickAddItemModal');
            if (modalElement) {
                const quickAddModal = new bootstrap.Modal(modalElement);
                document.getElementById('quick-add-item-form').reset();
                document.getElementById('quick-add-sku').value = scannedData;
                quickAddModal.show();
                modalElement.addEventListener('shown.bs.modal', function() {
                    document.getElementById('quick-add-name').focus();
                }, { once: true });
            }
        } else {
            if(typeof showMessage === 'function') showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', 'Scan Error: ' + error.message, 'danger');
        }
    }
}


   // [ ‚úÖ Is Poore Naye Code ko Line 2290 par Paste Karein ]

// Global variable naye (Kadam 7) local scanner ke liye
let localScanControls = null;
let localScannerModalInstance = null;

/**
 * KADAM 7: Naya "Smart Scan" Button Logic
 * Yeh check karta hai ki user computer par hai ya mobile par
 */
function openMobileScanner() {
    if (isMobile()) {
        // SCENARIO 1: User mobile par hai
        // -> Direct isi mobile ka camera kholein
        console.log("Mobile device detected. Opening local camera scanner...");
        startLocalScanner();
    } else {
        // SCENARIO 2: User computer par hai
        // -> Purana WebSocket pairing system chalu karein
        console.log("Desktop device detected. Opening WebSocket pairing modal...");

        // (Yeh aapka purana 'openMobileScanner' function ka code hai)
        const inlineBox = document.getElementById('inline-pairing-box');
        if (!inlineBox) {
            console.error("Inline pairing box not found!");
            return;
        }
        inlineBox.style.display = 'block';
        const spinner = document.getElementById('inline-pairing-spinner');
        const codeDisplay = document.getElementById('inline-pairing-code');
        const statusDisplay = document.getElementById('inline-pairing-status');
        if(spinner) spinner.style.display = 'inline-block';
        if(codeDisplay) codeDisplay.textContent = '------';
        if(statusDisplay) statusDisplay.style.display = 'none';
        initPosWebSocket(); //
    }
}

/**
 * KADAM 7: Local Mobile Camera ko Chalu Karta Hai
 */
// [ ‚úÖ YEH NAYA 'startLocalScanner' FUNCTION HAI (html5-qrcode ke liye) ]

// [ ‚úÖ ‡§á‡§∏ ‡§Ö‡§™‡§°‡•á‡§ü‡•á‡§° ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã ‡§™‡•Å‡§∞‡§æ‡§®‡•á startLocalScanner ‡§ï‡•Ä ‡§ú‡§ó‡§π ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç ]

async function startLocalScanner() {
    if (!localScannerModalInstance) {
        localScannerModalInstance = new bootstrap.Modal(document.getElementById('localScannerModal'));
    }
    localScannerModalInstance.show();

    const messageEl = document.getElementById('local-scanner-message');

    try {
        localScanControls = new Html5Qrcode("local-scanner-video");

        const onScanSuccess = (decodedText, decodedResult) => {
            console.log("Local Scan Result:", decodedText);
            stopLocalScanner(); 
            handleBarcodeScan(decodedText); 
        };

        const onScanFailure = (error) => {
            // ‡§Æ‡§æ‡§á‡§®‡§∞ ‡§è‡§∞‡§∞ ‡§ï‡•ã ‡§á‡§ó‡•ç‡§®‡•ã‡§∞ ‡§ï‡§∞‡•á‡§Ç
        };

        messageEl.innerText = "‡§ï‡•à‡§Æ‡§∞‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...";
        messageEl.style.display = 'block';

        // üöÄ ‡§¨‡§¶‡§≤‡§æ‡§µ ‡§Ø‡§π‡§æ‡§Å ‡§π‡•à: ‡§¨‡§æ‡§∞‡§ï‡•ã‡§° ‡§ï‡•á ‡§≤‡§ø‡§è 'config' ‡§ï‡•ã ‡§¨‡•á‡§π‡§§‡§∞ ‡§¨‡§®‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à
        const config = { 
            fps: 10, 
            // 1. qrbox ‡§ï‡•ã '‡§ö‡•å‡§°‡§º‡§æ' (Rectangular) ‡§¨‡§®‡§æ‡§è‡§Ç ‡§§‡§æ‡§ï‡§ø ‡§≤‡§Ç‡§¨‡§æ ‡§¨‡§æ‡§∞‡§ï‡•ã‡§° ‡§´‡§ø‡§ü ‡§π‡•ã ‡§∏‡§ï‡•á
            qrbox: { width: 300, height: 150 }, 
            // 2. ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§™‡§∞ ‡§¨‡•á‡§π‡§§‡§∞ ‡§´‡•ã‡§ï‡§∏ ‡§ï‡•á ‡§≤‡§ø‡§è
            aspectRatio: 1.0 
        };

        await localScanControls.start(
            { facingMode: "environment" }, 
            config,
            onScanSuccess,
            onScanFailure
        );

        messageEl.style.display = 'none';

        document.getElementById('local-scanner-close-btn').onclick = stopLocalScanner;
        document.getElementById('local-scanner-cancel-btn').onclick = stopLocalScanner;

    } catch (e) {
        console.error("Scanner Error:", e);
        showMessage('‡§ï‡•à‡§Æ‡§∞‡§æ ‡§è‡§∞‡§∞', `‡§ï‡•à‡§Æ‡§∞‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§æ: ${e.message}`, 'danger');
        stopLocalScanner();
    }
}



/**
 * KADAM 7: Local Mobile Camera ko Band Karta Hai
 */
// [ ‚úÖ YEH NAYA 'stopLocalScanner' FUNCTION HAI (html5-qrcode ke liye) ]

function stopLocalScanner() {
    if (localScanControls && localScanControls.isScanning) {
        localScanControls.stop().then(() => {
            console.log("html5-qrcode scanner stopped.");
            localScanControls.clear();
            localScanControls = null;
        }).catch(err => {
            console.error("Failed to stop html5-qrcode scanner: ", err);
            // Force clear
            localScanControls.clear();
            localScanControls = null;
        });
    }
    if (localScannerModalInstance) {
        localScannerModalInstance.hide(); // Modal band karein
    }
    document.getElementById('local-scanner-message').style.display = 'none';
}

    function formatCurrency(amount) {
        if (amount === null || amount === undefined) return '‚Çπ0.00';
        return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 2 }).format(amount);
    }
    
// [ ‚úÖ 1. ‡§á‡§∏ ‡§®‡§è ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã formatCurrency ‡§ï‡•á ‡§¨‡§æ‡§¶ (‡§≤‡§æ‡§á‡§® 2203 ‡§ï‡•á ‡§Ü‡§∏‡§™‡§æ‡§∏) ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç ]

function sendWhatsAppMessage(phone, name) {
        if (!phone || phone === 'N/A') {
            return showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', '‡§á‡§∏ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§´‡§º‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§∏‡•á‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§', 'danger');
        }

        // ‡§´‡§º‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§ï‡•ã ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ '91' (India code) ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
        let cleanPhone = phone.replace(/[^0-9]/g, ''); // ‡§∏‡§ø‡§∞‡•ç‡§´ ‡§®‡§Ç‡§¨‡§∞ ‡§∞‡§ñ‡•á‡§Ç
        
        if (cleanPhone.length === 10) {
            cleanPhone = '91' + cleanPhone; // 10 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§µ‡§æ‡§≤‡•á ‡§®‡§Ç‡§¨‡§∞ ‡§™‡§∞ 91 ‡§≤‡§ó‡§æ‡§è‡§Å
        } else if (cleanPhone.length === 12 && cleanPhone.startsWith('91')) {
            // ‡§®‡§Ç‡§¨‡§∞ ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§π‡•Ä ‡§∏‡§π‡•Ä ‡§π‡•à (91XXXXXXXXXX)
        } else {
            // ‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§®‡§Ç‡§¨‡§∞
            return showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§Ø‡§π ‡§è‡§ï ‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§´‡§º‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ (${phone}) ‡§π‡•à‡•§`, 'warning');
        }

        const message = `‡§®‡§Æ‡§∏‡•ç‡§§‡•á ${name},`; // ‡§Ü‡§™ ‡§Æ‡•à‡§∏‡•á‡§ú ‡§ï‡•ã ‡§¨‡§¶‡§≤ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç
        const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
        
        // WhatsApp ‡§ï‡•ã ‡§®‡§è ‡§ü‡•à‡§¨ ‡§Æ‡•á‡§Ç ‡§ñ‡•ã‡§≤‡•á‡§Ç
        window.open(whatsappUrl, '_blank');
    }

    // NEW: Function to format dates as YYYY-MM-DD
    function getISODate(date = new Date()) {
        return date.toISOString().split('T')[0];
    }

    const showMessage = (title, body, type = 'primary') => {
        const toastElement = document.getElementById('appToast');
        const toastTitle = document.getElementById('toast-title');
        const toastBody = document.getElementById('toast-body');
        
        toastTitle.innerText = title;
        toastBody.innerText = body;
        toastElement.querySelector('.toast-header').className = `toast-header bg-${type} text-white`;
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
    };

    // [REPLACE THIS FUNCTION IN HTML <script>]


      

        async function fetchApi(path, options = {}, loadingMessage = '‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...') {
        showLoader(loadingMessage);
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), SERVER_TIMEOUT);

        // get token
        const token = AppState.token || localStorage.getItem('authToken');

        // start with default headers, keep any provided headers
        const headers = {
            'Content-Type': 'application/json',
            ...options.headers,
        };

        if (token) headers['Authorization'] = `Bearer ${token}`;

        // Prepare body:
        let body = options.body === undefined ? null : options.body;

        // If body is FormData -> let fetch set Content-Type (remove header)
        if (body instanceof FormData) {
            delete headers['Content-Type'];
        } else if (body !== null) {
            // If user already passed a string (JSON string), use it as-is
            if (typeof body === 'string') {
                // assume valid JSON string
            } else {
                // otherwise stringify a plain object / number / array safely
                try {
                    body = JSON.stringify(body);
                } catch (err) {
                    // fallback: keep as-is (so we don't break existing behaviour)
                    console.warn('fetchApi: body stringify failed, sending raw body', err);
                }
            }
        }

        try {
            const response = await fetch(__backend_url + path, {
                ...options,
                headers,
                body,
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            // try parse JSON even if body empty
            const text = await response.text().catch(() => '');
            let responseData = {};
            try { responseData = text ? JSON.parse(text) : {}; } catch (e) { responseData = {}; }

            if (!response.ok) {
                // üöÄ FIX: ‡§∏‡§ø‡§∞‡•ç‡§´ 401 (Invalid Token) ‡§™‡§∞ ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü ‡§ï‡§∞‡•á‡§Ç
                if (response.status === 401) {
                    showMessage('‡§∏‡§§‡•ç‡§∞ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§', '‡§Ü‡§™‡§ï‡§æ ‡§∏‡§§‡•ç‡§∞ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç‡•§', 'danger');
                    logout();
                }
                
                // 403 (Plan Locked) ‡§Ø‡§æ ‡§Ö‡§®‡•ç‡§Ø ‡§è‡§∞‡§∞ ‡§™‡§∞ ‡§∏‡§ø‡§∞‡•ç‡§´ ‡§è‡§∞‡§∞ ‡§´‡•á‡§Ç‡§ï‡•á‡§Ç (‡§§‡§æ‡§ï‡§ø ‡§ï‡•à‡§ö ‡§¨‡•ç‡§≤‡•â‡§ï ‡§â‡§∏‡•á ‡§∏‡§Ç‡§≠‡§æ‡§≤ ‡§≤‡•á)
                // ‡§á‡§∏‡§∏‡•á ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§ó‡§æ
                throw new Error(responseData.message || `‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§è‡§∞‡§∞: ${response.status}`);
            }

            return responseData;

        } catch (error) {
            // ============================================================
            // üöÄ NEW UPDATION: OFFLINE LOGIC ADDED HERE
            // ============================================================
            if (!navigator.onLine && options.method && options.method !== 'GET') {
                // ‡§Ö‡§ó‡§∞ ‡§®‡•á‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‡§î‡§∞ ‡§π‡§Æ ‡§ï‡•Å‡§õ ‡§∏‡•á‡§µ (POST/PUT/DELETE) ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç
                // ‡§§‡•ã ‡§â‡§∏‡•á ‡§≤‡•ã‡§ï‡§≤ ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ ‡§ï‡§∞ ‡§≤‡•ã
                saveOfflineRequest(path, options.method, options.body);
                
                // ‡§Ø‡•Ç‡§ú‡§∞ ‡§ï‡•ã ‡§è‡§∞‡§∞ ‡§® ‡§¶‡§ø‡§ñ‡§æ‡§ï‡§∞ success return ‡§ï‡§∞‡•ã ‡§§‡§æ‡§ï‡§ø ‡§ê‡§™ ‡§® ‡§∞‡•Å‡§ï‡•á
                return { success: true, message: "‚ö†Ô∏è ‡§ë‡§´‡§≤‡§æ‡§á‡§®: ‡§°‡•á‡§ü‡§æ ‡§ï‡§§‡§æ‡§∞ ‡§Æ‡•á‡§Ç ‡§π‡•à (Queued)" };
            }
            // ============================================================

            if (error.name === 'AbortError') throw new Error('‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§π‡•ã‡§®‡•á ‡§Æ‡•á‡§Ç ‡§¨‡§π‡•Å‡§§ ‡§∏‡§Æ‡§Ø ‡§≤‡§ó‡§æ‡•§');
            throw error;
        } finally {
            hideLoader();
        }
    }
// ==========================================================
// ========== üöÄüöÄüöÄ NAYA PLAN LOCK LOGIC (YAHAN PASTE KAREIN) üöÄüöÄüöÄ ==========
// ==========================================================

/**
 * Client-side checkPlan: 
 * ‡§Ø‡§π ‡§∏‡§∞‡•ç‡§µ‡§∞ ('checkPlan') ‡§≤‡•â‡§ú‡§ø‡§ï ‡§ï‡•Ä ‡§®‡§ï‡§≤ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à, ‡§Ø‡§π AppState.user ‡§∏‡•á ‡§™‡§¢‡§º‡§§‡§æ ‡§π‡•à‡•§
 */
 function checkUserPlan(requiredPlans, requiredAddOn = null) {
    const plans = { 'PREMIUM': 4, 'ONE_TIME': 4, 'MEDIUM': 3, 'BASIC': 2, 'TRIAL': 1 };

    if (!AppState.user) return false; // ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü

    const userPlan = AppState.user.plan_type || 'TRIAL';
    const userPlanLevel = plans[userPlan.toUpperCase()] || 0;
    const userAddOns = AppState.user.add_ons || {};
    const expiryDate = AppState.user.licenseExpiryDate ? new Date(AppState.user.licenseExpiryDate) : null;
    const now = new Date();

    // 1. ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç
    if (!expiryDate || expiryDate < now) {
        return false; // ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§è‡§ï‡•ç‡§∏‡§™‡§æ‡§Ø‡§∞ ‡§π‡•à
    }

    // 2. ‡§ü‡•ç‡§∞‡§æ‡§Ø‡§≤ ‡§™‡•ç‡§≤‡§æ‡§® ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç (‡§∏‡§¨ ‡§ï‡•Å‡§õ ‡§Ö‡§≤‡§æ‡§ä ‡§ï‡§∞‡•á‡§Ç)
    if (userPlan === 'TRIAL') {
        return true;
    }

    // 3. ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§™‡•ç‡§≤‡§æ‡§® ‡§≤‡•á‡§µ‡§≤ ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç (Medium/Premium)
    const isPlanAuthorized = requiredPlans.some(plan => {
        const requiredLevel = plans[plan.toUpperCase()] || 0;
        return userPlanLevel >= requiredLevel;
    });

    if (isPlanAuthorized) {
        return true; // ‡§™‡•ç‡§≤‡§æ‡§® ‡§∏‡§π‡•Ä ‡§π‡•à
    }

    // 4. ‡§ê‡§°-‡§ë‡§® ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç (Basic + AddOn)
    if (requiredAddOn && userPlan === 'BASIC' && userAddOns[requiredAddOn] === true) {
        return true; // ‡§¨‡•á‡§∏‡§ø‡§ï ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§ï‡•á ‡§™‡§æ‡§∏ ‡§ê‡§°-‡§ë‡§® ‡§π‡•à
    }

    // 5. ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à
    return false;
}

/**
 * "‡§Ö‡§™‡§ó‡•ç‡§∞‡•á‡§°" ‡§™‡•â‡§™‡§Ö‡§™ ‡§¶‡§ø‡§ñ‡§æ‡§§‡§æ ‡§π‡•à
 */
function showPlanLockModal(featureName, requiredPlanOrAddOn) {
    if (!planLockModalInstance) {
        planLockModalInstance = new bootstrap.Modal(document.getElementById('planLockModal'));
    }

    // Modal ‡§ï‡§æ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§¨‡§¶‡§≤‡•á‡§Ç
    document.getElementById('plan-lock-feature-name').innerText = featureName;
    document.getElementById('plan-lock-plan-name').innerText = `'${AppState.user.plan_type}'`;

    // WhatsApp ‡§≤‡§ø‡§Ç‡§ï ‡§ï‡•ã ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)
    const waLink = document.querySelector('#planLockModal .btn-success');
    const message = `‡§®‡§Æ‡§∏‡•ç‡§§‡•á, ‡§Æ‡•à‡§Ç ‡§Ö‡§™‡§®‡§æ Dukan Pro ‡§™‡•ç‡§≤‡§æ‡§® '${AppState.user.plan_type}' ‡§∏‡•á ‡§Ö‡§™‡§ó‡•ç‡§∞‡•á‡§° ‡§ï‡§∞‡§ï‡•á '${requiredPlanOrAddOn}' ‡§≤‡•á‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡§æ ‡§π‡•Ç‡§Å‡•§ (Shop ID: ${AppState.user.shopId})`;
    waLink.href = `https://wa.me/7303410987?text=${encodeURIComponent(message)}`;

    planLockModalInstance.show();
}

// ==========================================================
// ========== üöÄ NAYA LOGIC YAHAN SAMAPT HOTA HAI üöÄ ==========
// ==========================================================

/**
 * ‡§è‡§ï ‡§∏‡§æ‡§ß‡§æ‡§∞‡§£ CSV ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•ã JSON ‡§ë‡§¨‡•ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§ê‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§™‡§æ‡§∞‡•ç‡§∏ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
 */
 function parseCSV(csvText) {
    const lines = csvText.split('\n');
    if (lines.length === 0) return [];
    
    // ‡§π‡•á‡§°‡§∞ (Date, Description, Debit, Credit) ‡§ï‡§æ ‡§™‡§§‡§æ ‡§≤‡§ó‡§æ‡§è‡§Å
    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
    
    // ‡§ï‡•â‡§≤‡§Æ ‡§á‡§Ç‡§°‡•á‡§ï‡•ç‡§∏ ‡§¢‡•Ç‡§Å‡§¢‡•á‡§Ç
    const dateIdx = headers.findIndex(h => h.includes('date'));
    const descIdx = headers.findIndex(h => h.includes('description') || h.includes('narration'));
    const debitIdx = headers.findIndex(h => h.includes('debit') || h.includes('withdrawal'));
    const creditIdx = headers.findIndex(h => h.includes('credit') || h.includes('deposit'));

    if (dateIdx === -1 || descIdx === -1 || debitIdx === -1 || creditIdx === -1) {
        showMessage('CSV ‡§è‡§∞‡§∞', 'CSV ‡§Æ‡•á‡§Ç Date, Description, Debit/Withdrawal, ‡§Ø‡§æ Credit/Deposit ‡§ï‡•â‡§≤‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•á‡•§', 'danger');
        throw new Error('Invalid CSV headers');
    }

    const items = [];
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line) continue;
        
        const values = line.split(',');
        
        const dateStr = values[dateIdx];
        // ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ï‡•ã YYYY-MM-DD ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤‡•á‡§Ç (‡§Æ‡§æ‡§® ‡§≤‡•á‡§Ç ‡§ï‡§ø ‡§Ø‡§π DD/MM/YYYY ‡§Ø‡§æ MM/DD/YYYY ‡§π‡•à)
        let dateObj;
        if (dateStr.includes('/')) {
            const parts = dateStr.split('/');
            // ‡§Æ‡§æ‡§® ‡§≤‡•á‡§Ç ‡§ï‡§ø ‡§Ø‡§π MM/DD/YYYY ‡§π‡•à (‡§á‡§∏‡•á ‡§Ö‡§™‡§®‡•á ‡§¨‡•à‡§Ç‡§ï ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§¨‡§¶‡§≤‡•á‡§Ç)
            // ‡§Ö‡§ó‡§∞ DD/MM/YYYY ‡§π‡•à, ‡§§‡•ã new Date(parts[2], parts[1] - 1, parts[0]) ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç
            dateObj = new Date(parts[2], parts[0] - 1, parts[1]); 
        } else {
            dateObj = new Date(dateStr); // ISO 8601 (YYYY-MM-DD)
        }
        
        const debitAmount = parseFloat(values[debitIdx].replace(/[^0-9.]/g, '')) || 0;
        const creditAmount = parseFloat(values[creditIdx].replace(/[^0-9.]/g, '')) || 0;

        items.push({
            date: dateObj.toISOString().split('T')[0],
            description: values[descIdx],
            debit: debitAmount,
            credit: creditAmount
        });
    }
    return items;
}



    function updateBalanceSheet(data) {
    // ‡§Ö‡§ó‡§∞ ‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Ü‡§§‡§æ ‡§π‡•à, ‡§§‡•ã ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§Ø‡§π‡•Ä‡§Ç ‡§∞‡•Å‡§ï ‡§ú‡§æ‡§è‡§ó‡§æ
    if (!data) return; 

    // --- ‡§¶‡•á‡§®‡§¶‡§æ‡§∞‡§ø‡§Ø‡§æ‡§Ç ‡§î‡§∞ ‡§á‡§ï‡•ç‡§µ‡§ø‡§ü‡•Ä (Liabilities & Equity) ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç ---
    
    // GST ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§®‡•á ‡§Ø‡•ã‡§ó‡•ç‡§Ø (Payable)
    document.getElementById('report-bs-gst-payable').innerText = formatCurrency(data.gstPayable || 0);
    
    // ‡§µ‡•á‡§Ç‡§°‡§∞ ‡§ï‡•ã ‡§¶‡•á‡§Ø (Payable)
    document.getElementById('report-bs-vendors-payable').innerText = formatCurrency(data.vendorsPayable || 0);
    
    // ‡§Æ‡§æ‡§≤‡§ø‡§ï ‡§ï‡•Ä ‡§á‡§ï‡•ç‡§µ‡§ø‡§ü‡•Ä (Owner's Equity) = Net Profit
    document.getElementById('report-bs-owner-equity').innerText = formatCurrency(data.ownerEquity || 0);
    
    // ‡§ï‡•Å‡§≤ ‡§¶‡•á‡§®‡§¶‡§æ‡§∞‡§ø‡§Ø‡§æ‡§Ç ‡§î‡§∞ ‡§á‡§ï‡•ç‡§µ‡§ø‡§ü‡•Ä
    document.getElementById('report-bs-total-liabilities').innerText = formatCurrency(data.totalLiabilitiesAndEquity || 0);

    // --- ‡§™‡§∞‡§ø‡§∏‡§Ç‡§™‡§§‡•ç‡§§‡§ø‡§Ø‡§æ‡§Ç (Assets) ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç ---
    
    // ‡§∏‡•ç‡§ü‡•â‡§ï ‡§ï‡§æ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø (Stock Value)
    document.getElementById('report-bs-stock-value').innerText = formatCurrency(data.stockValue || 0);
    
    // ‡§ï‡•à‡§∂/‡§¨‡•à‡§Ç‡§ï ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ (‡§Ü‡§™‡§ï‡•á ‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§¨‡•à‡§ï‡§è‡§Ç‡§° ‡§Æ‡•á‡§Ç ‡§á‡§∏‡•á ‡§ü‡•ç‡§∞‡•à‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à, ‡§á‡§∏‡§≤‡§ø‡§è 0.00 ‡§∞‡§ñ‡•á‡§Ç)
    document.getElementById('report-bs-cash-balance').innerText = formatCurrency(data.cashBalance || 0);
    
    // ‡§ï‡•Å‡§≤ ‡§™‡§∞‡§ø‡§∏‡§Ç‡§™‡§§‡•ç‡§§‡§ø‡§Ø‡§æ‡§Ç
    document.getElementById('report-bs-total-assets').innerText = formatCurrency(data.totalAssets || 0);
    
    console.log('Balance Sheet data successfully updated in HTML with correct IDs.');
}



// NEW: Function to fetch and populate Company Profile into Invoice Generator
function fetchAndPopulateShopData() {
        console.log("Populating Shop Data for Invoice...");
        try {
            // 1. ‡§∂‡•â‡§™ ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§∏‡•á ‡§°‡•á‡§ü‡§æ ‡§â‡§†‡§æ‡§è‡§Å
            const legalName = document.getElementById('company-legal-name').value;
            const gstin = document.getElementById('company-gstin').value;
            const address = document.getElementById('company-address').value;
            
            // 2. AppState (‡§≤‡•â‡§ó-‡§á‡§® ‡§Ø‡•Ç‡§ú‡§º‡§∞) ‡§∏‡•á ‡§°‡•á‡§ü‡§æ ‡§â‡§†‡§æ‡§è‡§Å
            const displayName = AppState.user?.shopName || '';
            const mobile = AppState.user?.mobile || ''; // (‡§Ø‡§π ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§Ü‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è)

            // 3. ‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§ú‡§®‡§∞‡•á‡§ü‡§∞ ‡§ï‡•á ‡§´‡•â‡§∞‡•ç‡§Æ ‡§Æ‡•á‡§Ç ‡§Ø‡§π ‡§°‡•á‡§ü‡§æ ‡§≠‡§∞‡•á‡§Ç
            document.getElementById('shopName').value = legalName || displayName; //
            document.getElementById('shopContact').value = mobile; //
            document.getElementById('shopAddress').value = address; //
            document.getElementById('shopGstin').value = gstin; //
            
            // 4. ‡§™‡•ç‡§∞‡•Ä‡§µ‡•ç‡§Ø‡•Ç ‡§ï‡•ã ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
            updateInvoicePreview();

        } catch (e) {
            console.warn("Could not pre-populate shop data:", e.message);
        }
    }// ‡§Ø‡§π ‡§≠‡•Ä ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø 'renderReports' ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ API ‡§ï‡•â‡§≤ ‡§ï‡•á ‡§¨‡§æ‡§¶ 
// ‡§Ø‡§π ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•â‡§≤ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à, ‡§ú‡•à‡§∏‡§æ ‡§ï‡§ø ‡§®‡•Ä‡§ö‡•á ‡§π‡•à:

// (Multiuser.html ‡§Æ‡•á‡§Ç ‡§≤‡§æ‡§á‡§® 2049 ‡§ï‡•á ‡§Ü‡§∏‡§™‡§æ‡§∏, renderView ‡§∏‡•á ‡§†‡•Ä‡§ï ‡§™‡§π‡§≤‡•á)

    /**
     * üöÄ NAYA FUNCTION: Plan-Aadhaar par Navigation ko Handle karta hai
     * Yeh function sidebar clicks ko rokta hai aur plan check karta hai.
     * Yahi aapki "Problem 1" ka solution hai.
     */
     // [REPLACE THIS FUNCTION IN HTML <script>]

function handleNavClick(viewId) {
    // 1. Un views ko define karein jinke liye plan ki aavashyakta hai
    // (Yeh aapke server-side 'checkPlan' logic se mel khana chahiye)
    const planRequirements = {
        'crm': { plans: ['MEDIUM', 'PREMIUM'], featureName: 'CRM (‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®)' },
        'reports': { plans: ['MEDIUM', 'PREMIUM'], featureName: 'Advanced Reports' },
        'gst-reports': { plans: ['MEDIUM', 'PREMIUM'], featureName: 'GST Reports' },
        'bank-reconciliation': { plans: ['MEDIUM', 'PREMIUM'], featureName: 'Bank Reconciliation' },
        
        // üöÄ UPDATED: AI Insights Logic
        // (Ab Basic plan wale bhi ise 'Add-on' khareed kar chala sakte hain)
        'ai-insights': { plans: ['MEDIUM', 'PREMIUM'], addOn: 'has_ai_insights', featureName: 'AI Business Insights' },

        'daily-closing': { plans: ['MEDIUM', 'PREMIUM'], addOn: 'has_closing', featureName: 'Daily Closing' },
        'data-backup': { plans: ['MEDIUM', 'PREMIUM'], addOn: 'has_backup', featureName: 'Data Backup' },
        'staff': { plans: ['MEDIUM', 'PREMIUM'], featureName: 'Staff Management' }
        
        // Views not listed: dashboard, stock, sales, invoice-generator,
        // purchases, expenses, shop-settings sabke liye available hain.
    };

    const req = planRequirements[viewId];

    if (req) {
        // 2. Is view ke liye plan ya add-on check karein
        // 'checkUserPlan' ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® (line ~1968) ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§ó‡§æ ‡§ï‡§ø ‡§ï‡•ç‡§Ø‡§æ ‡§™‡•ç‡§≤‡§æ‡§® ‡§Ø‡§æ ‡§ê‡§°-‡§ë‡§® ‡§π‡•à
        if (checkUserPlan(req.plans, req.addOn)) {
            renderView(viewId); // ‚úÖ Anumati hai (Access Granted)
        } else {
            // ‚ùå Anumati nahi hai - Lock modal dikhayein
            // Agar add-on available hai to message mein dikhayen
            const requiredName = req.addOn ? req.featureName + " (Add-on)" : req.plans.join('/');
            
            // 'showPlanLockModal' ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® (line ~2000) ‡§™‡•â‡§™‡§Ö‡§™ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§ó‡§æ
            showPlanLockModal(req.featureName, requiredName);
        }
    } else {
        // 4. Is view ke liye koi plan requirement nahi hai (Sabke liye khula hai)
        renderView(viewId);
    }
}
    // --- Yahaan naya function samapt hota hai ---


   
    // --- RENDER FUNCTIONS FOR EACH SECTION ---
    const renderView = (viewId) => {
        AppState.currentView = viewId;
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        
        // ‡§Ø‡§π ‡§≤‡§æ‡§á‡§® ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡§§‡•Ä ‡§π‡•à ‡§ï‡§ø ‡§∏‡•á‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã active ‡§ï‡•ç‡§≤‡§æ‡§∏ ‡§Æ‡§ø‡§≤‡•á
        const sectionElement = document.getElementById(viewId);
        if (sectionElement) {
             sectionElement.classList.add('active');
             console.log(`‚úÖ Activated section: #${viewId}`); // ‡§ï‡§®‡•ç‡§´‡§∞‡•ç‡§Æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§≤‡•â‡§ó
        } else {
             console.error(`‚ùå Section not found for ID: ${viewId}`); // ‡§Ö‡§ó‡§∞ ID ‡§ó‡§≤‡§§ ‡§π‡•à
        }

        document.querySelectorAll('#sidebar-nav .nav-link').forEach(l => {
            l.classList.remove('active');
            if (l.getAttribute('data-view') === viewId) l.classList.add('active');
        });
        
        // --- üöÄ ‡§Ö‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§ï‡§Æ‡•á‡§Ç‡§ü ‡§Ü‡§â‡§ü ---
        switch (viewId) {
            case 'dashboard': renderDashboard(); break;
            case 'stock':
    document.getElementById('stock').classList.add('active');
    fetchAndRenderStockList();

    // ‚úÖ SALON ONLY STOCK FORM
   // const salonStockForm = document.getElementById('add-stock-form');
    //if (salonStockForm) {
      //  salonStockForm.style.display =
        //    currentBusinessType === 'SALON' ? 'flex' : 'none';
    //}

    // ‚úÖ SALON ONLY DURATION FIELD
    const durationDiv = document.getElementById('stock-duration-div');
if (durationDiv) {
    durationDiv.style.display =
        (AppState.user?.businessType || '') === 'SALON' ? 'block' : 'none';
}


    break;

            case 'crm': fetchAndRenderCustomers(); break;
            case 'purchases': fetchAndRenderPurchases(); break;
            case 'expenses': fetchAndRenderExpenses(); break;
            case 'reports': renderReports(); break;
            case 'sales': 
                fetchAndRenderSales(); 
                fetchApi('/api/stock', { method: 'GET' }).then(res => {
                    if (res.success) currentStock = res.stock;
                });
                focusBarcodeScanner(); 
                break;
                case 'invoice-generator':
            fetchAndPopulateShopData();
            initializeQRUpload();
            break;
             // Note: Duplicate 'sales' case removed below
            
            case 'gst-reports': 
                // Ensure getISODate function exists or handle potential error
                try {
                    document.getElementById('gst-report-start-date').value = getISODate(new Date(new Date().setDate(1))); 
                    document.getElementById('gst-report-end-date').value = getISODate(); 
                } catch (e) { console.error("Error setting GST dates:", e); }
                break;
            case 'bank-reconciliation':
            // ‡§ú‡§¨ ‡§π‡§Æ ‡§ü‡•à‡§¨ ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç ‡§§‡•ã ‡§á‡§Ç‡§ü‡§∞‡§´‡§º‡•á‡§∏ ‡§ï‡•ã ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
                document.getElementById('reconciliation-setup').classList.remove('hidden');
                document.getElementById('reconciliation-matching-area').classList.add('hidden');
                document.getElementById('reconciliation-start-form').reset();
                fetchAndRenderSavedReports();
                break;    
            case 'daily-closing': fetchAndRenderClosingReports(); break; 
            case 'data-backup': break; 
            case 'shop-settings': fetchAndRenderShopSettings(); break; 
            case 'staff': renderStaff(); break; 
            case 'ai-insights':
            loadUltimateAI();
            break;
            case 'daily_reports': 
        // üöÄ ‡§Ø‡§π‡§æ‡§Å ‡§®‡§Ø‡§æ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç
        filterReportOptions(); 
        break;

        }
        
        // --- üöÄ ‡§ï‡§Æ‡•á‡§Ç‡§ü ‡§ñ‡§§‡•ç‡§Æ ---
    };


    /**
     * üöÄ NAYA: AI Insights ‡§µ‡•ç‡§Ø‡•Ç ‡§ï‡•ã ‡§∞‡•á‡§Ç‡§°‡§∞ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
     */
     const renderAiInsights = async () => {
        const contentDiv = document.getElementById('ai-insights-content');
        contentDiv.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">AI ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à...</p></div>`;

        try {
            const response = await fetchApi('/api/ai/stock-insights', { method: 'GET' });
            
            if (!response.success) {
                throw new Error(response.message);
            }

            const { fast_moving, dead_stock } = response.insights;
            let html = '<div class="row g-4">';

            // 1. ‡§°‡•á‡§° ‡§∏‡•ç‡§ü‡•â‡§ï (Dead Stock) ‡§ï‡§æ‡§∞‡•ç‡§°‡•ç‡§∏
            if (dead_stock.length > 0) {
                html += '<h4><i class="fas fa-exclamation-triangle text-danger me-2"></i>‡§™‡•à‡§∏‡•á ‡§¨‡§ö‡§æ‡§®‡•á ‡§ï‡•Ä ‡§∏‡§≤‡§æ‡§π (‡§°‡•á‡§° ‡§∏‡•ç‡§ü‡•â‡§ï)</h4>';
                dead_stock.forEach(item => {
                    html += `
                        <div class="col-md-6">
                            <div class="card border-danger shadow-sm h-100">
                                <div class="card-body">
                                    <h5 class="card-title text-danger">${item.title}</h5>
                                    <p class="card-text">${item.text}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<p>‡§¨‡§ß‡§æ‡§à ‡§π‡•ã! ‡§Ü‡§™‡§ï‡§æ ‡§ï‡•ã‡§à ‡§≠‡•Ä ‡§™‡•à‡§∏‡§æ ‡§°‡•á‡§° ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§´‡§Å‡§∏‡§æ ‡§π‡•à‡•§</p>';
            }

            // 2. ‡§´‡§æ‡§∏‡•ç‡§ü ‡§Æ‡•Ç‡§µ‡§ø‡§Ç‡§ó (Fast Moving) ‡§ï‡§æ‡§∞‡•ç‡§°‡•ç‡§∏
            if (fast_moving.length > 0) {
                html += '<h4 class="mt-5"><i class="fas fa-shipping-fast text-success me-2"></i>‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§¨‡§¢‡§º‡§æ‡§®‡•á ‡§ï‡•Ä ‡§∏‡§≤‡§æ‡§π (‡§´‡§æ‡§∏‡•ç‡§ü ‡§Æ‡•Ç‡§µ‡§ø‡§Ç‡§ó)</h4>';
                fast_moving.forEach(item => {
                    html += `
                        <div class="col-md-6">
                            <div class="card border-success shadow-sm h-100">
                                <div class="card-body">
                                    <h5 class="card-title text-success">${item.title}</h5>
                                    <p class="card-text">${item.text}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<p>‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§ü‡•â‡§ï ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§£ ‡§Æ‡•á‡§Ç ‡§π‡•à‡•§ ‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§Ü‡§á‡§ü‡§Æ ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§ñ‡§§‡•ç‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à‡•§</p>';
            }

            html += '</div>'; // row
            contentDiv.innerHTML = html;

        } catch (error) {
            contentDiv.innerHTML = `<div class="alert alert-danger">AI ‡§∏‡§≤‡§æ‡§π ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${error.message}</div>`;
        }
    };




  // [ ‚úÖ FIXED: SALES TABLE WITH ROBUST DATE ]
async function fetchAndRenderSales() {
    const salesTableBody = document.getElementById('sales-table-body');  
    if (!salesTableBody) return;

    salesTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-3"><div class="spinner-border text-primary spinner-border-sm"></div> ‡§≤‡•ã‡§°‡§ø‡§Ç‡§ó...</td></tr>`;
    
    try {
        const salesRes = await fetchApi('/api/invoices', { method: 'GET' }, null); 
        salesTableBody.innerHTML = ''; 

        if (salesRes.success && salesRes.sales && salesRes.sales.length > 0) {
            salesRes.sales.forEach(sale => {
                
                // üöÄ DATE FIX: ‡§ú‡§¨‡§∞‡§¶‡§∏‡•ç‡§§‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡§Ç
                let dateStr = "---";
                if (sale.created_at) {
                    const d = new Date(sale.created_at);
                    if (!isNaN(d.getTime())) {
                        // ‡§∏‡§π‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§Æ‡§ø‡§≤‡•Ä
                        dateStr = d.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: '2-digit' });
                    } else {
                        // ‡§Ö‡§ó‡§∞ ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ï‡§æ ‡§´‡•â‡§∞‡•ç‡§Æ‡•á‡§ü ‡§ó‡§≤‡§§ ‡§π‡•à
                        dateStr = String(sale.created_at).split('T')[0]; 
                    }
                }

                let custName = sale.customer_name || '‡§Ö‡§®‡§æ‡§Æ';
                if(custName.length > 15) custName = custName.substring(0, 15) + '..';

                salesTableBody.innerHTML += `
                    <tr>
                        <td class="fw-bold">#${sale.id}</td>
                        <td>
                            <span class="text-dark fw-bold">${custName}</span>
                            ${sale.customer_phone ? `<br><small class="text-muted">${sale.customer_phone}</small>` : ''}
                        </td>
                        <td>${formatCurrency(sale.total_gst || 0).replace('‚Çπ','')}</td>
                        <td class="fw-bold text-success">${formatCurrency(sale.total_amount || 0)}</td>
                        
                        <td class="fw-bold text-dark">${dateStr}</td> 
                        
                        <td>
                            <div class="d-flex">
                                <button class="btn btn-sm btn-secondary py-1 px-2 shadow-sm" onclick="printPOSInvoice(${sale.id})" title="Print">
                                    <i class="fas fa-print"></i>
                                </button>
                                <button class="btn btn-sm btn-success py-1 px-2 ms-1 shadow-sm" 
                                    onclick="sendWhatsAppMessage('${sale.customer_phone || ''}', '${sale.customer_name}')" 
                                    ${!(sale.customer_phone) ? 'disabled' : ''}>
                                    <i class="fab fa-whatsapp"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        } else {
             salesTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">‡§ï‡•ã‡§à ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç‡•§</td></tr>`; 
        }
    } catch (error) {
        console.error(error);
        salesTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}</td></tr>`; 
    }
}

// NEW: Show Invoice Detail Modal (Placeholder, needs a modal)
    async function showInvoiceDetail(invoiceId) {
        try {
            const res = await fetchApi(`/api/invoices/${invoiceId}`, { method: 'GET' });
            if (res.success) {
                // TODO: Create a modal to show this data
                console.log(res.invoice);
                alert(`‡§ö‡§æ‡§≤‡§æ‡§® #${res.invoice.id}\n‡§ó‡•ç‡§∞‡§æ‡§π‡§ï: ${res.invoice.customer_name}\n‡§ï‡•Å‡§≤: ${formatCurrency(res.invoice.total_amount)}\n‡§Ü‡§á‡§ü‡§Æ:\n` + 
                    res.invoice.items.map(item => `${item.item_name} (Qty: ${item.quantity})`).join('\n')
                );
            } else {
                showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', res.message, 'danger');
            }
        } catch (e) {
            showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', e.message, 'danger');
        }
    }

/**
    
  /**
     * (‡§®‡§Ø‡§æ ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® - ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡•ç‡§≤‡•Ä‡§®‡§Ö‡§™ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§´‡§ø‡§ï‡•ç‡§∏‡•ç‡§°)
     * POS ‡§∏‡•á ‡§∏‡•á‡§µ ‡§ï‡§ø‡§Ø‡•á ‡§ó‡§è ‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§ï‡•ã ‡§´‡§º‡•á‡§ö ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§î‡§∞ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§
     */
     async function printPOSInvoice(invoiceId) {
        showLoader('‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...');
        
        // üöÄ ‡§π‡§Æ ‡§á‡§∏ 'printArea' ‡§ï‡•ã ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§π‡§ü‡§æ‡§è‡§Ç‡§ó‡•á
        let printArea = document.getElementById('report-print-area');

        try {
            // 1. ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§ï‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§°‡•á‡§ü‡§æ ‡§≤‡§æ‡§è‡§Å
            const res = await fetchApi(`/api/invoices/${invoiceId}`, { method: 'GET' }, null);
            if (!res.success || !res.invoice) {
                throw new Error(res.message || '‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§');
            }
            
            const invoice = res.invoice;
            
            // 2. ‡§∂‡•â‡§™ ‡§ï‡•Ä ‡§°‡§ø‡§ü‡•á‡§≤‡•ç‡§∏ AppState ‡§∏‡•á ‡§≤‡•á‡§Ç
            const profileRes = await fetchApi('/api/shop/company-profile', { method: 'GET' }, null);
            const shopProfile = profileRes.success ? profileRes.profile : {};
            const shopDisplayName = AppState.user?.shopName || 'Shop Name';

            // 3. ‡§á‡§®‡§µ‡•â‡§á‡§∏ HTML ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç
            let itemRows = '';
            let totalTax = 0;
            let subTotal = 0;

            invoice.items.forEach((item, index) => {
                const itemSubTotal = (item.sale_price || 0) * (item.quantity || 0);
                const itemGst = itemSubTotal * ((item.gst_rate || 0) / 100); 
                
                subTotal += itemSubTotal;
                totalTax += itemGst;
                
                itemRows += `
                    <tr>
                        <td>${index + 1}</td>
                        <td style="text-align: left;">
    ${item.item_name}
    <small class="d-block" style="color: #555;">${formatAttributes(item.product_attributes)}</small>
</td>
                        <td>${item.quantity}</td>
                        <td>${formatCurrency(item.sale_price)}</td>
                        <td>${item.gst_rate || 0}%</td> 
                        <td>${formatCurrency(itemSubTotal)}</td>
                        <td class="no-print"></td>
                    </tr>
                `;
            });

            const cgst = totalTax / 2;
            const sgst = totalTax / 2;

            // 4. ‡§è‡§ï ‡§Ö‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§Ø‡•ã‡§ó‡•ç‡§Ø (printable) div ‡§¨‡§®‡§æ‡§è‡§Å
            if (!printArea) {
                printArea = document.createElement('div');
                printArea.id = 'report-print-area';
                printArea.className = 'printable'; // [cite: 1-267]
                document.body.appendChild(printArea);
            }

            // 5. ‡§á‡§®‡§µ‡•â‡§á‡§∏ HTML ‡§ï‡•ã ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§è‡§∞‡§ø‡§Ø‡§æ ‡§Æ‡•á‡§Ç ‡§á‡§Ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç
            printArea.innerHTML = `
                <div id="invoice-preview-printable" class="printable"> 
                    <div class="invoice-header">
                        <div class="shop-details">
                            <h3>${shopProfile.legal_name || shopDisplayName}</h3>
                            <p class="mb-0">${shopProfile.address || 'Shop Address'}</p>
                            <p class="mb-0">Ph: ${shopProfile.contact || 'Contact No.'}</p>
                            ${shopProfile.gstin ? `<p class="mb-0"><strong>GSTIN: ${shopProfile.gstin}</strong></p>` : ''}
                        </div>
                        <h2 style="color: #333; align-self: center;">INVOICE</h2>
                    </div>
                    
                    <div class="customer-details row">
                        <div class="col-8">
                            <strong>Bill To:</strong>
                            <p class="mb-0">${invoice.customer_name || 'N/A'}</p>
                            <p class="mb-0">Ph: ${invoice.customer_mobile || 'N/A'}</p>
                        </div>
                        <div class="col-4 text-end">
                            <p class="mb-0"><strong>Invoice No:</strong> INV-${invoice.id}</p>
                            <p class="mb-0"><strong>Date:</strong> ${new Date(invoice.created_at).toLocaleDateString()}</p>
                        </div>
                    </div>

                    <table class="invoice-table">
                        <thead>
                            <tr>
                                <th style="width: 5%;">#</th>
                                <th style="text-align: left;">Item</th>
                                <th style="width: 10%;">Qty</th>
                                <th style="width: 15%;">Rate</th>
                                <th style="width: 10%;">GST%</th>
                                <th style="width: 15%;">Amount</th>
                                <th style="width: 5%;" class="no-print"></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemRows}
                        </tbody>
                    </table>
                    
                    <div class="invoice-footer">
                        <div>
                            </div>
                        <table class="totals-table">
                            <tbody>
                                <tr><td>Subtotal:</td><td style="text-align: right;">${formatCurrency(subTotal)}</td></tr>
                                <tr><td>CGST:</td><td style="text-align: right;">${formatCurrency(cgst)}</td></tr>
                                <tr><td>SGST:</td><td style="text-align: right;">${formatCurrency(sgst)}</td></tr>
                                <tr style="font-weight: bold; font-size: 1.2em; border-top: 2px solid #333;">
                                    <td>Grand Total:</td>
                                    <td style="text-align: right;">${formatCurrency(invoice.total_amount)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // üöÄüöÄüöÄ ‡§Ø‡§π ‡§∞‡§π‡§æ ‡§´‡§ø‡§ï‡•ç‡§∏ üöÄüöÄüöÄ
            // 6. ‡§è‡§ï ‡§ï‡•ç‡§≤‡•Ä‡§®‡§Ö‡§™ ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§¨‡§®‡§æ‡§è‡§Å
            function cleanupPrint() {
                if (printArea) {
                    printArea.remove(); // ‡§Ö‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä div ‡§ï‡•ã ‡§π‡§ü‡§æ ‡§¶‡•á‡§Ç
                }
                window.onafterprint = null; // ‡§á‡§µ‡•á‡§Ç‡§ü ‡§≤‡§ø‡§∏‡•ç‡§®‡§∞ ‡§ï‡•ã ‡§π‡§ü‡§æ ‡§¶‡•á‡§Ç
            }
            
            // 7. 'afterprint' (‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶) ‡§á‡§µ‡•á‡§Ç‡§ü ‡§™‡§∞ ‡§ï‡•ç‡§≤‡•Ä‡§®‡§Ö‡§™ ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
            window.onafterprint = cleanupPrint;
            
            // 8. ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡•á‡§Ç
            window.print();
            // üöÄüöÄüöÄ ‡§´‡§ø‡§ï‡•ç‡§∏ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ üöÄüöÄüöÄ

        } catch (e) {
            showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§á‡§®‡§µ‡•â‡§á‡§∏ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${e.message}`, 'danger');
            // üöÄ ‡§Ö‡§ó‡§∞ ‡§è‡§∞‡§∞ ‡§Ü‡§è ‡§§‡•ã ‡§≠‡•Ä ‡§ï‡•ç‡§≤‡•Ä‡§®‡§Ö‡§™ ‡§ï‡§∞‡•á‡§Ç
            if (printArea) {
                printArea.remove();
            }
        } finally {
            hideLoader();
        }
    }


	// [ ‚úÖ Is Poore Naye Function ko Line 2611 se pehle Paste Karein ]

async function renderSalesChart() {
    try {
        // 1. Chart data API se laayein
        const res = await fetchApi('/api/dashboard/sales-by-day?days=30', { method: 'GET' }, null); 

        if (!res.success || !res.data) {
            throw new Error(res.message || 'Sales chart data not found');
        }

        const chartData = res.data;

        // 2. Data ko Chart.js ke liye process karein
        const labels = chartData.map(d => new Date(d.date).toLocaleDateString('hi-IN', { day: 'numeric', month: 'short' }));
        const salesValues = chartData.map(d => d.sales);
        const profitValues = chartData.map(d => d.profit);

        // 3. Canvas element ko pakdein
        const ctx = document.getElementById('salesChart').getContext('2d');

        // 4. Purana chart (agar hai) toh destroy karein
        if (mySalesChart) {
            mySalesChart.destroy();
        }

        // 5. Naya chart banayein
        mySalesChart = new Chart(ctx, {
            type: 'line', 
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä (Sales)',
                        data: salesValues,
                        borderColor: 'rgba(0, 180, 216, 1)',
                        backgroundColor: 'rgba(0, 180, 216, 0.1)',
                        fill: true,
                        tension: 0.3
                    },
                    {
                        label: '‡§≤‡§æ‡§≠ (Profit)',
                        data: profitValues,
                        borderColor: 'rgba(26, 188, 156, 1)',
                        backgroundColor: 'rgba(26, 188, 156, 0.1)',
                        fill: true,
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) { return '‚Çπ' + value; }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatCurrency(context.raw);
                            }
                        }
                    }
                }
            }
        });

    } catch (error) {
        console.error("Error rendering sales chart:", error.message);
        const ctx = document.getElementById('salesChart').getContext('2d');
        if (ctx) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.font = '16px Poppins';
            ctx.fillStyle = '#dc3545';
            ctx.textAlign = 'center';
            ctx.fillText('‡§ö‡§æ‡§∞‡•ç‡§ü ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ' + error.message, ctx.canvas.width / 2, ctx.canvas.height / 2);
        }
    }
}

    // [ ‡§™‡•Å‡§∞‡§æ‡§®‡•á renderDashboard() ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã ‡§á‡§∏ ‡§®‡§è ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§∏‡•á ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‡§¨‡§¶‡§≤ ‡§¶‡•á‡§Ç ]
    // [ multiuser.html ‡§Æ‡•á‡§Ç ‡§≤‡§æ‡§á‡§® 2174 ‡§™‡§∞ ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç ]


    // [ ‡§™‡•Å‡§∞‡§æ‡§®‡•á renderDashboard() ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã ‡§á‡§∏ ‡§®‡§è ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§∏‡•á ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‡§¨‡§¶‡§≤ ‡§¶‡•á‡§Ç ]

   // [ ‚úÖ FIXED: ULTIMATE DASHBOARD RENDERER - ALL 31 BUSINESS TYPES EXPLICITLY HANDLED ]
// [ ‚úÖ FIXED: ULTIMATE DASHBOARD RENDERER - ALL 31 BUSINESS TYPES EXPLICITLY HANDLED ]
// [ ‚úÖ FIXED: ULTIMATE DASHBOARD - DATA LOADING FIXED ]
// [ ‚úÖ FIXED: DASHBOARD WITH DATE UPDATES ]
async function renderDashboard() {
    const user = AppState.user;
    if (!user) return;

    const btype = user.businessType;
    const config = (typeof MASTER_BUSINESS_CONFIG !== 'undefined') ? MASTER_BUSINESS_CONFIG[btype] : null;
    const viewMode = config ? config.dashboard_view : 'retail_grid';

    console.log(`üöÄ Loading Dashboard for: ${btype} (View: ${viewMode})`);

    // ============================================================
    // 1. SALON DASHBOARD (Custom UI)
    // ============================================================
    if (viewMode === 'salon_dashboard') {
        document.querySelectorAll('#dashboard > .row').forEach(el => el.style.display = 'none');
        const salonDash = document.getElementById('salon-dashboard');
        if (salonDash) {
            salonDash.style.display = 'block';
            if (typeof loadSalonDashboard === 'function') await loadSalonDashboard();
        }
        return; 
    }

    // ============================================================
    // 2. STANDARD DASHBOARD (For remaining 30 Types)
    // ============================================================
    else {
        // UI Reset
        document.querySelectorAll('#dashboard > .row').forEach(el => el.style.display = 'flex');
        const salonDash = document.getElementById('salon-dashboard');
        if (salonDash) salonDash.style.display = 'none';
        
        // Modules Visibility Logic (Business Type Switch)
        const uniContainer = document.getElementById('universal-modules-container');
        if (uniContainer) uniContainer.style.display = 'block';

        switch (btype) {
            case 'RETAIL': break;
            case 'MOBILE_SHOP': case 'ELECTRONICS': 
                if(document.getElementById('module-imei-scan')) document.getElementById('module-imei-scan').style.display = 'block';
                break;
            case 'HARDWARE_PAINT':
                if (typeof loadPainters === 'function') loadPainters();
                if(document.getElementById('module-paint-estimator')) document.getElementById('module-paint-estimator').style.display = 'block';
                break;
            case 'FURNITURE':
                if(document.getElementById('module-furniture-showroom')) document.getElementById('module-furniture-showroom').style.display = 'block';
                break;
            case 'DOCTOR_CLINIC': case 'ORTHOPEDIC': case 'PHYSIOTHERAPY': case 'DENTIST': case 'SONOGRAPHY': case 'PATHOLOGY':
                if(document.getElementById('module-prescription-pad')) document.getElementById('module-prescription-pad').style.display = 'block';
                if(btype === 'DENTIST' && document.getElementById('box-dentist-chart')) document.getElementById('box-dentist-chart').style.display = 'block';
                if(btype === 'SONOGRAPHY' && document.getElementById('box-lmp-calc')) document.getElementById('box-lmp-calc').style.display = 'block';
                break;
            case 'GYM':
                if(document.getElementById('module-gym-access')) document.getElementById('module-gym-access').style.display = 'block';
                break;
            case 'TAILOR':
                if(document.getElementById('module-tailor-measurements')) document.getElementById('module-tailor-measurements').style.display = 'block';
                break;
            case 'SERVICE_CENTER':
                if(document.getElementById('module-repair-job')) document.getElementById('module-repair-job').style.display = 'block';
                break;
            case 'RESTAURANT': case 'HOTEL':
                if(document.getElementById('module-restaurant-kot')) document.getElementById('module-restaurant-kot').style.display = 'block';
                if(btype === 'HOTEL' && document.getElementById('module-hotel-management')) document.getElementById('module-hotel-management').style.display = 'block';
                break;
            case 'TILES_CERAMIC':
                if(document.getElementById('module-tiles-calc')) document.getElementById('module-tiles-calc').style.display = 'block';
                break;
            case 'TRANSPORT':
                if(document.getElementById('module-transport-trip')) document.getElementById('module-transport-trip').style.display = 'block';
                break;
            case 'SCHOOL':
                if(document.getElementById('module-school-fees')) document.getElementById('module-school-fees').style.display = 'block';
                break;
            case 'LOAN_DSA': case 'RECOVERY_AGENT': case 'INSURANCE_AGENCY':
                if(document.getElementById('module-finance-collection')) document.getElementById('module-finance-collection').style.display = 'block';
                if(document.getElementById('module-geo-tagging')) document.getElementById('module-geo-tagging').style.display = 'block';
                break;
            case 'TENT_HOUSE':
                if(document.getElementById('module-rental-stock')) document.getElementById('module-rental-stock').style.display = 'block';
                break;
            default: break;
        }

        // ============================================================
        // 3. DASHBOARD DATA LOADING
        // ============================================================
        try {
            // A. Financial Summary (Top Cards)
            const sumRes = await fetchApi('/api/dashboard/summary', { method: 'GET' }, null);
            if (sumRes.success) {
                document.getElementById('total-sales-revenue').innerText = formatCurrency(sumRes.summary.totalSales);
                document.getElementById('total-stock-value').innerText = formatCurrency(sumRes.summary.currentStockValue);
            }

            // B. Fetch Data for Dashboard Tables
            const [stockRes, salesRes] = await Promise.all([
                fetchApi('/api/stock', { method: 'GET' }, null),
                fetchApi('/api/invoices', { method: 'GET' }, null)
            ]);

            // --- 1. Low Stock Logic ---
            const lowStockItems = stockRes.success ? stockRes.stock.filter(item => item.quantity < 10) : [];
            const lowStockCountEl = document.getElementById('low-stock-count');
            const lowStockBody = document.getElementById('low-stock-table-body');

            if (lowStockCountEl) lowStockCountEl.innerText = lowStockItems.length;
            
            if (lowStockBody) {
                lowStockBody.innerHTML = '';
                if (lowStockItems.length > 0) {
                    lowStockItems.slice(0, 5).forEach(item => {
                        lowStockBody.innerHTML += `
                            <tr>
                                <td>${item.sku}</td>
                                <td>${item.name}</td>
                                <td class="text-danger fw-bold">${item.quantity}</td>
                            </tr>`;
                    });
                } else {
                    lowStockBody.innerHTML = `<tr><td colspan="3" class="text-center text-muted small">‡§∏‡§¨ ‡§†‡•Ä‡§ï ‡§π‡•à!</td></tr>`;
                }
            }

            // --- 2. Recent Sales Logic (UPDATED WITH DATE) ---
            const recentSalesBody = document.getElementById('recent-sales-table-body');
            if (recentSalesBody) {
                recentSalesBody.innerHTML = '';
                if (salesRes.success && salesRes.sales.length > 0) {
                    salesRes.sales.slice(0, 5).forEach(sale => {
                        
                        // üöÄ NEW CODE ADDED HERE (Date Formatting)
                        let dateStr = "---";
                        if(sale.created_at) {
                            dateStr = new Date(sale.created_at).toLocaleDateString('en-IN', {
                                day: 'numeric', month: 'short'
                            });
                        }
                        // üöÄ END NEW CODE

                        recentSalesBody.innerHTML += `
                            <tr>
                                <td>INV-${sale.id}</td>
                                <td>${sale.customer_name || 'Cash'}</td>
                                <td class="fw-bold">${formatCurrency(sale.total_amount)}</td>
                                <td class="small text-muted fw-bold">${dateStr}</td>
                            </tr>`;
                    });
                } else {
                    recentSalesBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted small">‡§ï‡•ã‡§à ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç</td></tr>`;
                }
            }

            // --- 3. Total Customers Logic (UPDATED WITH DATE) ---
            const canAccessCRM = (typeof checkUserPlan === 'function') ? checkUserPlan(['MEDIUM', 'PREMIUM']) : true;
            const totalCustEl = document.getElementById('total-customers');
            
            if (canAccessCRM && totalCustEl) {
                const custRes = await fetchApi('/api/customers', { method: 'GET' }, null);
                if (custRes.success) {
                    totalCustEl.innerText = custRes.customers.length;
                    
                    const recentCustBody = document.getElementById('recent-customers-table-body');
                    if(recentCustBody) {
                        recentCustBody.innerHTML = '';
                        const sorted = custRes.customers.sort((a,b) => new Date(b.created_at) - new Date(a.created_at)).slice(0, 5);
                        
                        if(sorted.length > 0) {
                            sorted.forEach(c => {
                                
                                // üöÄ NEW CODE ADDED HERE (Date Formatting)
                                let joinDate = "---";
                                if(c.created_at) {
                                    joinDate = new Date(c.created_at).toLocaleDateString('en-IN', {
                                        day: 'numeric', month: 'short'
                                    });
                                }
                                // üöÄ END NEW CODE

                                recentCustBody.innerHTML += `
                                    <tr>
                                        <td>${c.name}</td>
                                        <td>${c.phone || '-'}</td>
                                        <td class="small text-muted">${joinDate}</td>
                                    </tr>`;
                            });
                        } else {
                            recentCustBody.innerHTML = `<tr><td colspan="3" class="text-center text-muted small">‡§ï‡•ã‡§à ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§®‡§π‡•Ä‡§Ç</td></tr>`;
                        }
                    }
                }
            } else if (totalCustEl) {
                totalCustEl.innerText = 'N/A';
            }

            // C. Refresh Charts
            if (typeof renderSalesChart === 'function') {
                renderSalesChart();
            }

        } catch (error) {
            console.error("Dashboard Data Loading Error:", error);
        }
    }
}
    // [ ‡§®‡§Ø‡§æ renderDashboard() ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§Ø‡§π‡§æ‡§Å ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã‡§§‡§æ ‡§π‡•à ]
    // ==========================================================
// ========== UPDATED: renderReports (Bank-Style Detail) ==========
// ==========================================================
async function renderReports() {
    // 1. Get date range (assuming server defaults if not provided, but server code requires it)
    const endDate = getISODate();
    const startDate = getISODate(new Date(new Date().setDate(new Date().getDate() - 90))); // 90-day default

    try {
        // 2. Fetch P&L Report first
     
// [ ‡§≤‡§æ‡§á‡§® 2274 ‡§∏‡•á ‡§†‡•Ä‡§ï ‡§™‡§π‡§≤‡•á ‡§Ø‡§π 4 ‡§≤‡§æ‡§á‡§®‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç ]
if (!checkUserPlan(['MEDIUM', 'PREMIUM'])) {
    document.getElementById('pl-card').querySelectorAll('tbody')[0].innerHTML = '<tr><td colspan="2" class="text-center text-muted">P&L ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§á‡§∏ ‡§™‡•ç‡§≤‡§æ‡§® ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</td></tr>';
    document.getElementById('bs-card').querySelectorAll('tbody')[0].innerHTML = '<tr><td colspan="2" class="text-center text-muted">‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§∂‡•Ä‡§ü ‡§ï‡•á ‡§≤‡§ø‡§è P&L ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à‡•§</td></tr>';
    return; // 'BASIC' ‡§Ø‡•Ç‡•õ‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã ‡§Ø‡§π‡•Ä‡§Ç ‡§∞‡•ã‡§ï ‡§¶‡•á‡§Ç
}
      
      
        const plRes = await fetchApi(`/api/reports/profit-loss?startDate=${startDate}&endDate=${endDate}`, { method: 'GET' }, 'P&L ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...');
        
        if (!plRes.success) {
            throw new Error(plRes.message || 'P&L ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§');
        }
        
        const pl = plRes.report;
        const netProfit = pl.netProfit; // Save this for the Balance Sheet

        // 3. Populate P&L Table (Debit Side)
        // [‡§Ø‡§π 'pl-card' ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§™‡§π‡§≤‡•á <tbody> ‡§ï‡•ã ‡§ö‡•Å‡§®‡§§‡§æ ‡§π‡•à]
        const plDebitBody = document.getElementById('pl-card').querySelectorAll('tbody')[0];
        plDebitBody.innerHTML = ''; // Clear existing static rows
        pl.debit.forEach(item => {
            plDebitBody.innerHTML += `<tr>
                                        <td>${item.description}</td>
                                        <td class="text-end">${formatCurrency(item.amount)}</td>
                                      </tr>`;
        });
        // Total Debit
        document.getElementById('report-pl-total-debit').innerText = formatCurrency(pl.totalDebit);

        // 4. Populate P&L Table (Credit Side)
        // [‡§Ø‡§π 'pl-card' ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§¶‡•Ç‡§∏‡§∞‡•á <tbody> ‡§ï‡•ã ‡§ö‡•Å‡§®‡§§‡§æ ‡§π‡•à]
        const plCreditBody = document.getElementById('pl-card').querySelectorAll('tbody')[1];
        plCreditBody.innerHTML = ''; // Clear existing static rows
        pl.credit.forEach(item => {
            plCreditBody.innerHTML += `<tr>
                                        <td>${item.description}</td>
                                        <td class="text-end">${formatCurrency(item.amount)}</td>
                                      </tr>`;
        });
        // Total Credit
        document.getElementById('report-pl-total-credit').innerText = formatCurrency(pl.totalCredit);

        // 5. Fetch Balance Sheet Report (passing the calculated netProfit)
        // [‡§Ø‡§π P&L ‡§∏‡•á ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§∂‡•Å‡§¶‡•ç‡§ß ‡§≤‡§æ‡§≠ ‡§ï‡•ã ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§∂‡•Ä‡§ü API ‡§ï‡•ã ‡§≠‡•á‡§ú‡§§‡§æ ‡§π‡•à]
        const bsRes = await fetchApi(`/api/reports/balance-sheet?netProfit=${netProfit}`, { method: 'GET' }, '‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§∂‡•Ä‡§ü ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...');

        if (!bsRes.success) {
            throw new Error(bsRes.message || '‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§∂‡•Ä‡§ü ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§');
        }
        
        const bs = bsRes.report;

        // 6. Populate Balance Sheet (Liabilities & Equity Side)
        // [‡§Ø‡§π 'bs-card' ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§™‡§π‡§≤‡•á <tbody> ‡§ï‡•ã ‡§ö‡•Å‡§®‡§§‡§æ ‡§π‡•à]
        const bsLiabilitiesBody = document.getElementById('bs-card').querySelectorAll('tbody')[0];
        bsLiabilitiesBody.innerHTML = ''; // Clear existing static rows
        
        // Liabilities (‡§¶‡•á‡§®‡§¶‡§æ‡§∞‡§ø‡§Ø‡§æ‡§Ç)
        bs.liabilities.forEach(item => {
            bsLiabilitiesBody.innerHTML += `<tr>
                                                <td>${item.description}</td>
                                                <td class="text-end">${formatCurrency(item.amount)}</td>
                                            </tr>`;
        });
        // Equity (‡§á‡§ï‡•ç‡§µ‡§ø‡§ü‡•Ä)
        bs.equity.forEach(item => {
            bsLiabilitiesBody.innerHTML += `<tr>
                                                <td>${item.description}</td>
                                                <td class="text-end">${formatCurrency(item.amount)}</td>
                                            </tr>`;
        });
        // Total Liabilities & Equity
        document.getElementById('report-bs-total-liabilities').innerText = formatCurrency(bs.totalLiabilitiesAndEquity);

        // 7. Populate Balance Sheet (Assets Side)
        // [‡§Ø‡§π 'bs-card' ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§¶‡•Ç‡§∏‡§∞‡•á <tbody> ‡§ï‡•ã ‡§ö‡•Å‡§®‡§§‡§æ ‡§π‡•à]
        const bsAssetsBody = document.getElementById('bs-card').querySelectorAll('tbody')[1];
        bsAssetsBody.innerHTML = ''; // Clear existing static rows
        
        // Assets (‡§™‡§∞‡§ø‡§∏‡§Ç‡§™‡§§‡•ç‡§§‡§ø‡§Ø‡§æ‡§Ç)
        bs.assets.forEach(item => {
            let note = item.note ? `<small class="text-muted d-block">${item.note}</small>` : '';
            bsAssetsBody.innerHTML += `<tr>
                                        <td>${item.description} ${note}</td>
                                        <td class="text-end">${formatCurrency(item.amount)}</td>
                                      </tr>`;
        });
        // Total Assets
        document.getElementById('report-bs-total-assets').innerText = formatCurrency(bs.totalAssets);
        
        console.log("‚úÖ Reports updated successfully with details.");

    } catch (error) {
        console.error("renderReports ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error);
        showMessage('‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏ ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡•Ä: ${error.message}`, 'danger');
        
        // Clear tables on error to avoid showing old data
        document.getElementById('pl-card').querySelectorAll('tbody')[0].innerHTML = '<tr><td colspan="2" class="text-danger text-center">P&L ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§</td></tr>';
        document.getElementById('pl-card').querySelectorAll('tbody')[1].innerHTML = '<tr><td colspan="2" class="text-danger text-center"></td></tr>';
        document.getElementById('bs-card').querySelectorAll('tbody')[0].innerHTML = '<tr><td colspan="2" class="text-danger text-center">BS ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§</td></tr>';
        document.getElementById('bs-card').querySelectorAll('tbody')[1].innerHTML = '<tr><td colspan="2" class="text-danger text-center"></td></tr>';
    }
}
// ==========================================================
// ========== END OF UPDATED FUNCTION ==========
// ==========================================================



async function fetchAndRenderStockList() {
    console.log('Fetching Stock List & Configuring View...');

    // 1. Business Type Detection
    const btype = AppState.user && AppState.user.businessType ? AppState.user.businessType.trim().toUpperCase() : 'RETAIL';
    
    // Group Classifications for logic
    const isSalon = (btype === 'SALON');
    const isGarments = [ 'CLOTHING', 'GARMENTS', 'BOUTIQUE', 'FASHION' ].includes(btype);
    const isEating = [ 'RESTAURANT', 'HOTEL', 'CAFE', 'BAKERY' ].includes(btype);

    // --- PART A: FORM CLEANUP & RESET ---
    // Remove all dynamic fields to prevent duplication
    document.querySelectorAll('#dynamic-business-fields').forEach(el => el.remove()); 
    const existingGarmentForm = document.getElementById('garments-security-fields');
    if (existingGarmentForm) existingGarmentForm.remove();

    const cDiv = document.getElementById('consumption-ui-area');
    if(cDiv) cDiv.remove();
    const typeDiv = document.getElementById('stock-type-selector-area');
    if(typeDiv) typeDiv.remove();
    
    // Remove Bulk Container if exists
    const bulkDiv = document.getElementById('dish-bulk-container');
    if(bulkDiv) bulkDiv.remove();

    // 2. FORM ELEMENTS SELECTORS
    const form = document.getElementById('add-stock-form');
    const submitBtnDiv = form.querySelector('button[type="submit"]').parentElement;
    
    // Field Wrappers
    const skuDiv = document.querySelector('label[for="stock-sku"]').parentElement;
    const qtyDiv = document.querySelector('label[for="stock-quantity"]').parentElement;
    const unitDiv = document.querySelector('label[for="stock-unit"]').parentElement;
    const gstDiv = document.querySelector('label[for="stock-gst"]').parentElement;
    const hsnDiv = document.querySelector('label[for="stock-hsn-code"]').parentElement;
    const durationDiv = document.getElementById('stock-duration-div'); 

    // Labels
    const nameLabel = document.querySelector('label[for="stock-name"]');
    const pPriceLabel = document.querySelector('label[for="stock-purchase-price"]');
    const sPriceLabel = document.querySelector('label[for="stock-sale-price"]');
    const qtyLabel = document.querySelector('label[for="stock-quantity"]');
    const unitInput = document.getElementById('stock-unit');

    // =========================================================
    // üî• FIX: OPTICAL / EXTRA DETAILS KO DEFAULT MEIN CHUPANA
    // =========================================================
    const opticalBtn = document.getElementById('add-custom-field-btn');
    const opticalContainer = document.getElementById('prescription-fields-container');
    let extraHeader = null, extraDesc = null, extraHr = null;

    document.querySelectorAll('#add-stock-form > *').forEach(el => {
        if (el.tagName === 'H6' && el.innerText.includes('‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§µ‡§ø‡§µ‡§∞‡§£')) {
            extraHeader = el; el.style.display = 'none';
        }
        if (el.tagName === 'P' && el.innerText.includes('Chasme ke liye')) {
            extraDesc = el; el.style.display = 'none';
        }
        if (el.tagName === 'HR' && el.nextElementSibling && el.nextElementSibling.innerText.includes('‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§µ‡§ø‡§µ‡§∞‡§£')) {
             extraHr = el; el.style.display = 'none';
        }
    });

    if (opticalBtn) {
        const wrapper = opticalBtn.closest('.col-12') || opticalBtn.parentElement;
        if(wrapper) wrapper.style.display = 'none';
    }
    if (opticalContainer) opticalContainer.style.display = 'none';

    // Reset Standard Visibility
    skuDiv.style.display = 'block';
    qtyDiv.style.display = 'block';
    unitDiv.style.display = 'block';
    hsnDiv.style.display = 'block';
    gstDiv.style.display = 'block';
    if(durationDiv) durationDiv.style.display = 'none';

    // Reset Labels
    nameLabel.innerText = '‡§Ü‡§á‡§ü‡§Æ ‡§ï‡§æ ‡§®‡§æ‡§Æ';
    pPriceLabel.innerText = '‡§ñ‡§∞‡•Ä‡§¶ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø (‚Çπ)';
    sPriceLabel.innerText = '‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§Æ‡•Ç‡§≤‡•ç‡§Ø (‚Çπ)';
    qtyLabel.innerText = '‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (Qty)';
    unitInput.placeholder = "Pcs / Kg / Box";

    // =========================================================
    // üî• GARMENTS SPECIAL: ANTI-THEFT FORM
    // =========================================================
    if (isGarments) {
        nameLabel.innerText = 'Design Name / Article No.';
        unitInput.placeholder = "Pcs";

        const securityDiv = document.createElement('div');
        securityDiv.id = 'garments-security-fields';
        securityDiv.className = 'col-12 p-3 mb-3 border rounded border-danger bg-danger bg-opacity-10';
        securityDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="text-danger fw-bold m-0"><i class="fas fa-shield-alt"></i> Anti-Theft Security</h6>
                <span class="badge bg-danger">SECURE MODE</span>
            </div>
            <div class="row g-3">
                <div class="col-12">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="sec-tag-attached" checked>
                        <label class="form-check-label fw-bold text-dark" for="sec-tag-attached">Hard Tag Attached (‡§π‡§æ‡§∞‡•ç‡§° ‡§ü‡•à‡§ó)</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold">Scan RFID / Barcode</label>
                    <input type="text" id="sec-rfid-code" class="form-control form-control-sm" placeholder="Scan Tag Here">
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold">Section</label>
                    <select id="sec-floor-loc" class="form-select form-select-sm">
                        <option>Men's Section</option>
                        <option>Women's Section</option>
                        <option>Kids Section</option>
                    </select>
                </div>
            </div>`;
        form.insertBefore(securityDiv, submitBtnDiv);
    }

    // =========================================================
    // üèóÔ∏è BUSINESS SPECIFIC LOGIC (FULL 31 TYPES LISTED)
    // =========================================================

    switch (btype) {
        // --- 1. SALON & FOOD (Menu / Service Mode) ---
        case 'SALON':
        case 'RESTAURANT':
        case 'HOTEL':
        case 'CAFE':
        case 'BAKERY':
            const typeALabel = (btype === 'SALON') ? '‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ (Service)' : '‡§°‡§ø‡§∂ (Dish / Food)';
            const typeBLabel = '‡§™‡•ç‡§∞‡•ã‡§°‡§ï‡•ç‡§ü (Inventory)';

            const typeSelectDiv = document.createElement('div');
            typeSelectDiv.id = 'stock-type-selector-area';
            typeSelectDiv.className = 'col-12 mb-3 p-2 bg-warning bg-opacity-10 border border-warning rounded';
            typeSelectDiv.innerHTML = `
                <label class="fw-bold small text-dark mb-1">‡§Ü‡§™ ‡§ï‡•ç‡§Ø‡§æ ‡§ú‡•ã‡§°‡§º ‡§∞‡§π‡•á ‡§π‡•à‡§Ç?</label>
                <div class="d-flex gap-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="itemType" id="typeService" value="SERVICE" checked onchange="toggleSmartFields()">
                        <label class="form-check-label fw-bold text-primary" for="typeService"><i class="fas fa-utensils"></i> ${typeALabel}</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="itemType" id="typeProduct" value="PRODUCT" onchange="toggleSmartFields()">
                        <label class="form-check-label fw-bold text-success" for="typeProduct"><i class="fas fa-box-open"></i> ${typeBLabel}</label>
                    </div>
                </div>`;
            form.insertBefore(typeSelectDiv, form.firstChild);

            window.toggleSmartFields = function() {
                const isService = document.getElementById('typeService').checked;
                hsnDiv.style.display = 'none';
                gstDiv.style.display = 'none';
                
                if (isService) {
                    qtyDiv.style.display = 'none';
                    unitDiv.style.display = 'none';
                    skuDiv.style.display = 'none';
                    pPriceLabel.parentElement.style.display = 'none';
                    sPriceLabel.parentElement.style.display = 'none'; 
                    nameLabel.parentElement.style.display = 'none';
                    if(durationDiv) durationDiv.style.display = 'none';

                    let multiRowContainer = document.getElementById('dish-bulk-container');
                    if (!multiRowContainer) {
                        multiRowContainer = document.createElement('div');
                        multiRowContainer.id = 'dish-bulk-container';
                        multiRowContainer.className = 'col-12 mt-2 p-3 border rounded bg-light';
                        multiRowContainer.innerHTML = `
                            <div id="hotel-bulk-dish-section">
                                <h6 class="text-primary mb-3"></h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered mb-0 bg-white">
                                        <thead class="table-warning">
                                            <tr><th style="width: 60%;">Name</th><th style="width: 30%;">Price (‚Çπ)</th><th style="width: 10%;"></th></tr>
                                        </thead>
                                        <tbody id="dish-bulk-body"></tbody>
                                    </table>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-secondary w-100 mt-2" id="bulk-add-btn" onclick="addDishRow()">
                                    <i class="fas fa-plus"></i> Add More
                                </button>
                            </div>`;
                        form.insertBefore(multiRowContainer, submitBtnDiv);
                        if(typeof window.addDishRow === 'function') window.addDishRow();
                    }
                    multiRowContainer.style.display = 'block';
                    const titleEl = multiRowContainer.querySelector('h6');
                    const btnEl = document.getElementById('bulk-add-btn');
                    if (isSalon) {
                        if(titleEl) titleEl.innerHTML = '<i class="fas fa-cut"></i> Bulk Services Entry';
                        if(btnEl) btnEl.innerHTML = '<i class="fas fa-plus"></i> Add Service';
                    } else {
                        if(titleEl) titleEl.innerHTML = '<i class="fas fa-utensils"></i> Bulk Menu Entry';
                        if(btnEl) btnEl.innerHTML = '<i class="fas fa-plus"></i> Add Dish';
                    }
                    document.getElementById('stock-quantity').value = '10000';
                    document.getElementById('stock-unit').value = isSalon ? 'Session' : 'Plate';
                    document.getElementById('stock-purchase-price').value = '0';
                    document.getElementById('stock-sku').value = 'BULK-' + Date.now();
                    document.getElementById('stock-name').value = 'BULK_ENTRY'; 
                    document.getElementById('stock-sale-price').value = '0';
                } else {
                    const multiRowContainer = document.getElementById('dish-bulk-container');
                    if (multiRowContainer) multiRowContainer.style.display = 'none';
                    qtyDiv.style.display = 'block';
                    unitDiv.style.display = 'block';
                    skuDiv.style.display = 'block';
                    pPriceLabel.parentElement.style.display = 'block';
                    sPriceLabel.parentElement.style.display = 'block';
                    nameLabel.parentElement.style.display = 'block';
                    document.getElementById('stock-quantity').value = '';
                    document.getElementById('stock-unit').value = 'Pcs';
                    document.getElementById('stock-sku').value = '';
                    document.getElementById('stock-purchase-price').value = '';
                    document.getElementById('stock-name').value = '';
                    document.getElementById('stock-sale-price').value = '';
                }
            };
            window.toggleSmartFields();
            break;
            
        // --- 2. RETAIL & FOOD (Expiry/Batch) ---
        case 'PHARMACY':
        case 'SWEET_SHOP':
        case 'GYM': 
        case 'RETAIL': 
        case 'GROCERY':
            const expiryDiv = document.createElement('div');
            expiryDiv.id = 'dynamic-business-fields';
            expiryDiv.className = 'col-12 border rounded p-3 mt-2 bg-light mb-3';
            expiryDiv.innerHTML = `
                <h6 class="text-primary small fw-bold"><i class="fas fa-clock"></i> Expiry & Batch Details</h6>
                <div class="row g-2">
                    <div class="col-md-6"><label class="form-label small">Expiry Date</label><input type="date" id="stock-expiry" class="form-control form-control-sm"></div>
                    <div class="col-md-6"><label class="form-label small">Batch Number</label><input type="text" id="stock-batch" class="form-control form-control-sm" placeholder="Batch No."></div>
                </div>`;
            form.insertBefore(expiryDiv, submitBtnDiv);
            break;

        // --- 3. ELECTRONICS (IMEI) ---
        case 'MOBILE_SHOP':
        case 'ELECTRONICS':
        case 'SIM_STORE':
            const imeiDiv = document.createElement('div');
            imeiDiv.id = 'dynamic-business-fields';
            imeiDiv.className = 'col-12 mb-3';
            imeiDiv.innerHTML = `
                <label class="form-label small text-info fw-bold">Device Details</label>
                <div class="row g-2">
                    <div class="col-md-6"><input type="text" id="item_imei" class="form-control form-control-sm" placeholder="IMEI / Serial No"></div>
                    <div class="col-md-6"><input type="text" id="item_model" class="form-control form-control-sm" placeholder="Model / Color"></div>
                </div>`;
            form.insertBefore(imeiDiv, submitBtnDiv);
            break;

        // --- 4. HARDWARE ---
        case 'HARDWARE_PAINT':
            unitInput.placeholder = "Liters / Kg / Drum";
            break;

        // --- 5. TILES ---
        case 'TILES_CERAMIC':
            qtyLabel.innerText = "Quantity (Boxes)";
            if(document.getElementById('module-tiles-calc')) 
               document.getElementById('module-tiles-calc').style.display = 'block';
            break;

        // --- 6. TENT HOUSE ---
        case 'TENT_HOUSE':
            if(document.getElementById('module-rental-stock')) 
               document.getElementById('module-rental-stock').style.display = 'block';
            sPriceLabel.innerText = "Replacement Cost (If Lost)";
            break;

        // --- 7. MEDICAL (No Optical Fields) ---
        case 'DENTIST': 
        case 'DOCTOR_CLINIC':
        case 'ORTHOPEDIC':
        case 'SONOGRAPHY':
        case 'PHYSIOTHERAPY':
        case 'PATHOLOGY':
             break; // Standard behavior, don't show optical fields

        // --- 8. OPTICAL (SHOW HIDDEN FIELDS) ---
        case 'OPTICAL':
            if (extraHeader) extraHeader.style.display = 'block';
            if (extraDesc) extraDesc.style.display = 'block';
            if (extraHr) extraHr.style.display = 'block';
            if (opticalBtn) {
                const wrapper = opticalBtn.closest('.col-12') || opticalBtn.parentElement;
                if(wrapper) wrapper.style.display = 'block';
            }
            break;

        // --- 9. SERVICES / OFFICE / MISC ---
        case 'LOAN_DSA':
        case 'RECOVERY_AGENT':
        case 'INSURANCE_AGENCY':
        case 'ARCHITECT_FIRM':
        case 'SOFTWARE_COMPANY':
        case 'SCHOOL':
        case 'TRANSPORT':
        case 'SERVICE_CENTER':
            break; // Standard entry

        // --- 10. CLOTHING / LIFESTYLE (Garments Logic handled globally) ---
        case 'TAILOR':
        case 'CLOTHING':
        case 'FURNITURE':
        case 'JEWELLERY':
        case 'GARMENTS':
        case 'BOUTIQUE':
        case 'FASHION':
            break;

        default:
            break;
    }

    // --- PART B: TABLE RENDER ---
    const tableHead = document.querySelector('#stock table thead');
    const tableBody = document.getElementById('stock-table-body');
    const tableFoot = document.getElementById('stock-table-foot');

    // 1. SET TABLE HEADERS
    if (isSalon) {
        tableHead.innerHTML = `<tr><th style="width:10%">Type</th><th style="width:25%">Name</th><th style="width:15%">Stock/Unit</th><th style="width:15%">Cost (‚Çπ)</th><th style="width:15%">Price (‚Çπ)</th><th style="width:20%">Action</th></tr>`;
    } else if (isGarments) {
        // ‚úÖ Corrected Headers for Garments (7 Cols)
        tableHead.innerHTML = `<tr>
            <th style="width:15%">Article/SKU</th>
            <th style="width:20%">Design Name</th>
            <th style="width:10%">Stock</th>
            <th style="width:10%">Cost (‚Çπ)</th>
            <th style="width:10%">Price (‚Çπ)</th>
            <th style="width:15%">Last Updated</th>
            <th style="width:20%">Action</th>
        </tr>`;
    } else {
        tableHead.innerHTML = `<tr><th>SKU</th><th>Item Name</th><th>Qty</th><th>Purchase</th><th>Sale</th><th>GST %</th><th>Updated</th><th>Attributes/Expiry</th><th>Action</th></tr>`;
    }

    const initialColSpan = isSalon ? 6 : (isGarments ? 7 : 9); 
    tableBody.innerHTML = `<tr><td colspan="${initialColSpan}" class="text-center py-3"><div class="spinner-border text-primary"></div></td></tr>`;
    if(tableFoot) tableFoot.innerHTML = '';

    try {
        const res = await fetchApi('/api/stock', { method: 'GET' });
        tableBody.innerHTML = '';
        const items = res.stock || [];

        if (res.success && items.length > 0) {
            let totalPurchaseValue = 0;
            let totalSaleValue = 0;

            items.forEach(item => {
                const row = tableBody.insertRow();
                const attrs = item.product_attributes || {};
                
                const safeSku = item.sku.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const itemDataSafe = JSON.stringify({ sku: item.sku, name: item.name, sale_price: item.sale_price, purchase_price: item.purchase_price }).replace(/"/g, '&quot;');

                // 1. SALON ROW
                if (isSalon) {
                    const isSvc = (item.sku && String(item.sku).startsWith('SVC-')) || item.unit === 'Session';
                    const typeBadge = isSvc ? `<span class="badge bg-primary">Service</span>` : `<span class="badge bg-success">Product</span>`;
                    const stockDisplay = isSvc ? `<span class="text-muted small">N/A</span>` : `<span class="fw-bold text-dark">${item.quantity} <small class="text-muted">${item.unit}</small></span>`;

                    row.innerHTML = `
                        <td>${typeBadge}</td>
                        <td class="fw-bold text-dark">${item.name} <br><small class="text-muted" style="font-size:0.75rem">${item.code || item.sku}</small></td>
                        <td>${stockDisplay}</td>
                        <td>${formatCurrency(item.purchase_price || 0)}</td> 
                        <td>${formatCurrency(item.price || item.sale_price)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editStockItem('${safeSku}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-outline-danger" data-role="ADMIN" onclick="deleteEntry('stock', '${safeSku}')"><i class="fas fa-trash"></i></button>
                        </td>`;
                } 
                // 2. GARMENTS ROW
                else if (isGarments) {
                    totalPurchaseValue += (item.purchase_price || 0) * (item.quantity || 0);
                    totalSaleValue += (item.sale_price || 0) * (item.quantity || 0);

                    const anti = item.product_attributes || {};
                    const lockIcon = anti.is_secured
                    ? `<i class="fas fa-lock text-danger ms-1" title="Anti-Theft Enabled"></i>`
                    : '';


                    row.innerHTML = `
                        <td><span class="badge bg-secondary">${item.sku}</span></td>
                        <td class="fw-bold text-dark">
                            ${item.name} ${lockIcon}
                        </td>
                        <td><span class="fw-bold">${item.quantity}</span> Pcs</td>
                        <td>${formatCurrency(item.purchase_price || 0)}</td>
                        <td>${formatCurrency(item.sale_price)}</td>
                        <td>${new Date(item.updated_at).toLocaleDateString()}</td> 
                        <td>
                            <button class="btn btn-sm btn-primary me-1" onclick="editStockItem('${safeSku}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-info text-white me-1" onclick="printItemSticker(${itemDataSafe})"><i class="fas fa-qrcode"></i></button>
                            <button class="btn btn-sm btn-danger" data-role="ADMIN" onclick="deleteEntry('stock', '${safeSku}')"><i class="fas fa-trash"></i></button>
                        </td>`;
                } 
                // 3. STANDARD ROW
                else {
                    totalPurchaseValue += (item.purchase_price || 0) * (item.quantity || 0);
                    totalSaleValue += (item.sale_price || 0) * (item.quantity || 0);

                    let attrDisplay = formatAttributes(attrs); 
                    if (attrs.expiry) attrDisplay += `<br><span class="badge bg-danger">Exp: ${attrs.expiry}</span>`;
                    if (attrs.batch) attrDisplay += ` <small class="text-muted">Batch: ${attrs.batch}</small>`;

                    row.innerHTML = `
                        <td>${item.sku}</td>
                        <td>${item.name}</td>
                        <td>${item.quantity} ${item.unit || ''}</td>
                        <td>${formatCurrency(item.purchase_price)}</td>
                        <td>${formatCurrency(item.sale_price)}</td>
                        <td>${item.gst || 0}%</td>
                        <td>${new Date(item.updated_at).toLocaleDateString()}</td>
                        <td>${attrDisplay}</td>
                        <td>
                            <button class="btn btn-sm btn-primary me-1 mb-1" onclick="editStockItem('${safeSku}')" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-info text-white mb-1" onclick="printItemSticker(${itemDataSafe})" title="Print QR"><i class="fas fa-qrcode"></i></button>
                            <button class="btn btn-sm btn-danger mb-1" data-role="ADMIN" onclick="deleteEntry('stock', '${safeSku}')" title="Delete"><i class="fas fa-trash"></i></button>
                        </td>`;
                }
            });

            if (!isSalon) {
                // Gap Calculation: Garments = 2 (7 cols - 5 used). Standard = 4 (9 cols - 5 used).
                const footerGap = isGarments ? 2 : 4;
                tableFoot.innerHTML = `<tr class="fw-bold bg-light"><td colspan="3">‡§ï‡•Å‡§≤ (Total)</td><td>${formatCurrency(totalPurchaseValue)}</td><td>${formatCurrency(totalSaleValue)}</td><td colspan="${footerGap}"></td></tr>`;
            }
        } else {
            const emptyColSpan = isSalon ? 6 : (isGarments ? 7 : 9);
            tableBody.innerHTML = `<tr><td colspan="${emptyColSpan}" class="text-center text-muted py-4">‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§</td></tr>`;
        }
    } catch (e) {
        console.error(e);
        const errorColSpan = isSalon ? 6 : (isGarments ? 7 : 9);
        tableBody.innerHTML = `<tr><td colspan="${errorColSpan}" class="text-center text-danger">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}</td></tr>`;
    }
}

function editStockItem(sku) {
    // 1. Fetch Fresh Data
    fetchApi(`/api/get-stock-item/${sku}`, { method: 'GET' }, '‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...').then(res => {
        if(res.success && res.data) {
            const item = res.data;
            const form = document.getElementById('add-stock-form');
            
            // 2. Scroll to Form
            form.scrollIntoView({ behavior: 'smooth' });

            // 3. Handle Salon Type (Service/Product)
            const isService = (String(sku).startsWith('SVC-') || item.unit === 'Session');
            if (document.getElementById('typeService')) {
                document.getElementById(isService ? 'typeService' : 'typeProduct').checked = true;
                if (window.toggleSalonFields) window.toggleSalonFields();
            }

            // 4. Fill Fields
            document.getElementById('stock-name').value = item.name;
            document.getElementById('stock-purchase-price').value = item.purchase_price;
            document.getElementById('stock-sale-price').value = item.sale_price;
            document.getElementById('stock-gst').value = item.gst_rate || 0;
            
            if (!isService) {
                document.getElementById('stock-quantity').value = item.quantity;
                document.getElementById('stock-unit').value = item.unit || 'Pcs';
            }

            // 5. SKU Handling (CRITICAL: Lock SKU so it updates instead of adding new)
            const skuInput = document.getElementById('stock-sku');
            skuInput.value = sku; 
            skuInput.disabled = true; // Disable to prevent change
            skuInput.style.backgroundColor = '#e9ecef'; // Visual cue

            // 6. Change Button to "Update"
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<i class="fas fa-save"></i> ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç (Update)';
            submitBtn.classList.remove('btn-primary');
            submitBtn.classList.add('btn-warning');

            // 7. Set Mode to 'set' (Edit Mode)
            const actionInput = document.getElementById('stock-action-type');
            if(actionInput) actionInput.value = 'set';

            // 8. Add Cancel Button
            if (!document.getElementById('cancel-edit-btn')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.id = 'cancel-edit-btn';
                cancelBtn.type = 'button';
                cancelBtn.className = 'btn btn-secondary ms-2';
                cancelBtn.innerHTML = '‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç';
                cancelBtn.onclick = resetStockForm;
                submitBtn.parentElement.appendChild(cancelBtn);
            }
        } else {
            alert('‡§Ü‡§á‡§ü‡§Æ ‡§ï‡§æ ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§');
        }
    });
}

// [ ‚úÖ MISSING FUNCTION: Form ‡§ï‡•ã ‡§∞‡§ø‡§∏‡•á‡§ü ‡§î‡§∞ ‡§Ö‡§®‡§≤‡•â‡§ï ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ]

function resetStockForm() {
    const form = document.getElementById('add-stock-form');
    if (!form) return;

    form.reset(); // Clear inputs
    
    // Unlock SKU
    const skuInput = document.getElementById('stock-sku');
    skuInput.disabled = false;
    skuInput.style.backgroundColor = '';
    
    // Reset Button
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.innerHTML = '‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•á‡§Ç ‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç';
    submitBtn.classList.remove('btn-warning');
    submitBtn.classList.add('btn-primary');
    
    // Remove Cancel Button
    const cancelBtn = document.getElementById('cancel-edit-btn');
    if (cancelBtn) cancelBtn.remove();
    
    // Reset Mode to 'add'
    const actionInput = document.getElementById('stock-action-type');
    if(actionInput) actionInput.value = 'add';
}

    // [ ‚úÖ 2. ‡§á‡§∏ ‡§™‡•Ç‡§∞‡•á ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã ‡§Ö‡§™‡§®‡•á ‡§™‡•Å‡§∞‡§æ‡§®‡•á fetchAndRenderCustomers (‡§≤‡§æ‡§á‡§® 2404) ‡§∏‡•á ‡§¨‡§¶‡§≤‡•á‡§Ç ]

   // [ ‚úÖ NEW: Unified Customer/WhatsApp Ledger for All Business Types ]

// [ ‚úÖ FIXED: CUSTOMER TABLE WITH DATE FIX ]
// [ ‚úÖ FIXED: CUSTOMER TABLE WITH ROBUST DATE ]
async function fetchAndRenderCustomers() {
    const tableBody = document.getElementById('crm-table-body');
    if (!tableBody) return;

    const isSalon = (AppState.user && AppState.user.businessType === 'SALON');
    
    // ‡§π‡•á‡§°‡§∞‡•ç‡§∏ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
    const tableHead = document.querySelector('#crm table thead tr');
    if (tableHead) {
        tableHead.innerHTML = `
            <th>‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ</th>
            <th>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</th>
            <th>‡§¨‡§ï‡§æ‡§Ø‡§æ</th>
            <th>‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ (Date)</th> <th>‡§è‡§ï‡•ç‡§∂‡§®</th>
        `;
    }

    tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary"></div></td></tr>`;

    try {
        const res = await fetchApi('/api/customers', { method: 'GET' });
        tableBody.innerHTML = '';
        
        if (res.success && res.customers && res.customers.length > 0) {
            const sortedCustomers = res.customers.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            sortedCustomers.forEach(c => {
                // üöÄ DATE FIX
                let joinDate = "---";
                if (c.created_at) {
                    const d = new Date(c.created_at);
                    if (!isNaN(d.getTime())) {
                        joinDate = d.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: '2-digit' });
                    }
                }

                const displayPhone = (c.phone && c.phone.length > 5) 
                    ? `<span class="fw-bold text-dark">${c.phone}</span>` 
                    : '<span class="text-muted small">--</span>';
                
                const waButton = (c.phone && c.phone.length > 5)
                    ? `<button class="btn btn-sm btn-success py-0 px-2" onclick="sendWhatsAppMessage('${c.phone}', '${c.name}')"><i class="fab fa-whatsapp"></i></button>`
                    : ``;

                const balanceClass = c.balance > 0 ? 'text-danger fw-bold' : 'text-success';

                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="fw-bold">${c.name}</td>
                    <td>${displayPhone}</td>
                    <td class="${balanceClass}">‚Çπ${formatCurrency(c.balance || 0).replace('‚Çπ', '')}</td>
                    
                    <td class="text-muted fw-bold small">${joinDate}</td>
                    
                    <td>
                        ${waButton}
                        <a class="btn btn-sm btn-primary ms-1" onclick="showEditCustomerModal(${c.id})"><i class="fas fa-edit"></i></a>
                    </td>
                `;
            });
        } else {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4">‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç‡•§</td></tr>`;
        }
    } catch (e) {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}</td></tr>`;
    }
}

// --- (... ‡§™‡§ø‡§õ‡§≤‡§æ ‡§ú‡§æ‡§µ‡§æ‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§ï‡•ã‡§° ‡§™‡§æ‡§∞‡•ç‡§ü 2 ‡§∏‡•á ‡§ú‡§æ‡§∞‡•Ä ...) ---

    async function fetchAndRenderPurchases() {
        const tableBody = document.getElementById('purchases-table-body');
        const tableFoot = document.getElementById('purchases-table-foot');
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</td></tr>`;
        tableFoot.innerHTML = '';
        try {
            const res = await fetchApi('/api/purchases', { method: 'GET' });
            tableBody.innerHTML = '';
            let totalCost = 0;
            if (res.success && res.purchases.length > 0) {
                res.purchases.forEach(p => {
                    totalCost += parseFloat(p.total_cost || 0);
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${p.id}</td>
                        <td>${p.supplier_name || 'N/A'}</td>
                        <td>${p.item_details}</td>
                        <td>${formatCurrency(p.total_cost)}</td>
                        <td>${new Date(p.created_at).toLocaleDateString()}</td>
                        <td><button class="btn btn-sm btn-danger" data-role="ADMIN" onclick="deleteEntry('purchase', ${p.id})">‡§π‡§ü‡§æ‡§è‡§Ç</button></td>
                    `;
                });
                tableFoot.innerHTML = `<tr class="fw-bold bg-light"><td colspan="3">‡§ï‡•Å‡§≤ ‡§ñ‡§∞‡•Ä‡§¶ ‡§∞‡§æ‡§∂‡§ø</td><td>${formatCurrency(totalCost)}</td><td colspan="2"></td></tr>`;
            } else {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">‡§ï‡•ã‡§à ‡§ñ‡§∞‡•Ä‡§¶ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§</td></tr>`;
            }
        } catch (e) {
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}</td></tr>`;
        }
    }

    async function fetchAndRenderExpenses() {
        const tableBody = document.getElementById('expenses-table-body');
        const tableFoot = document.getElementById('expenses-table-foot');
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</td></tr>`;
        tableFoot.innerHTML = '';
        try {
            const res = await fetchApi('/api/expenses', { method: 'GET' });
            tableBody.innerHTML = '';
            let totalExpenses = 0;
            if (res.success && res.expenses.length > 0) {
                res.expenses.forEach(ex => {
                    totalExpenses += parseFloat(ex.amount || 0);
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${new Date(ex.created_at).toLocaleDateString()}</td>
                        <td>${ex.category}</td>
                        <td>${ex.description}</td>
                        <td>${formatCurrency(ex.amount)}</td>
                        <td><button class="btn btn-sm btn-danger" data-role="ADMIN" onclick="deleteEntry('expense', ${ex.id})">‡§π‡§ü‡§æ‡§è‡§Ç</button></td>
                    `;
                });
                tableFoot.innerHTML = `<tr class="fw-bold bg-light"><td colspan="3">‡§ï‡•Å‡§≤ ‡§ñ‡§∞‡•ç‡§ö ‡§∞‡§æ‡§∂‡§ø</td><td>${formatCurrency(totalExpenses)}</td><td></td></tr>`;
            } else {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">‡§ï‡•ã‡§à ‡§ñ‡§∞‡•ç‡§ö ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§</td></tr>`;
            }
        } catch (e) {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}</td></tr>`;
        }
    }    
    // --- POS (SALES) SECTION LOGIC ---

    // NEW: Modified to show all items on click (showAll = true)
    // [ ‚úÖ SKU ‡§∏‡§∞‡•ç‡§ö ‡§ï‡•ã ‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§á‡§∏‡•á ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç ]

function handleItemSearch(showAll = false) {
    // ‡§ú‡•ã ‡§ü‡§æ‡§á‡§™ ‡§ï‡§ø‡§Ø‡§æ ‡§π‡•à ‡§â‡§∏‡•á ‡§õ‡•ã‡§ü‡§æ (lowercase) ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§∏‡•ç‡§™‡•á‡§∏ ‡§π‡§ü‡§æ‡§è‡§Å
    const query = document.getElementById('pos-item-search').value.toLowerCase().trim();
    const resultsUl = document.getElementById('pos-search-results');
    
    // ‡§Ö‡§ó‡§∞ ‡§ï‡•Å‡§õ ‡§®‡§π‡•Ä‡§Ç ‡§≤‡§ø‡§ñ‡§æ ‡§§‡•ã ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§ñ‡§æ‡§≤‡•Ä ‡§ï‡§∞‡•á‡§Ç (‡§Ö‡§ó‡§∞ showAll false ‡§π‡•à)
    if (!showAll && query.length < 1) {
        resultsUl.innerHTML = '';
        return;
    }

    // ‡§∏‡•ç‡§ü‡•â‡§ï ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§¢‡•Ç‡§Å‡§¢‡•á‡§Ç (Name ‡§Ø‡§æ SKU ‡§Æ‡•à‡§ö ‡§ï‡§∞‡•á‡§Ç)
    const results = (showAll && query.length === 0)
        ? currentStock // ‡§∏‡§¨ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
        : currentStock.filter(item => 
            (item.name && item.name.toLowerCase().includes(query)) || 
            (item.sku && item.sku.toLowerCase().includes(query)) // üöÄ SKU ‡§Æ‡•à‡§ö‡§ø‡§Ç‡§ó
        );

    // ‡§∞‡§ø‡§ú‡§≤‡•ç‡§ü ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç (‡§∏‡§ø‡§∞‡•ç‡§´ ‡§™‡§π‡§≤‡•á 50 ‡§§‡§æ‡§ï‡§ø ‡§π‡•à‡§Ç‡§ó ‡§® ‡§π‡•ã)
    if (results.length > 0) {
        resultsUl.innerHTML = results.slice(0, 50).map(item => `
            <li class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" 
                data-sku="${item.sku}" style="cursor: pointer;">
                
                <div>
                    <strong>${item.name}</strong>
                    <br>
                    <small class="text-muted">
                        Stock: ${item.quantity} ${item.unit || ''} 
                        ${item.product_attributes && item.product_attributes.Size ? `| Size: ${item.product_attributes.Size}` : ''}
                    </small>
                </div>

                <div class="text-end">
                    <span class="badge bg-warning text-dark mb-1">${item.sku}</span>
                    <br>
                    <span class="fw-bold text-success">${formatCurrency(item.sale_price)}</span>
                </div>

            </li>
        `).join('');
    } else {
        resultsUl.innerHTML = '<li class="list-group-item text-muted">‡§ï‡•ã‡§à ‡§Ü‡§á‡§ü‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ (SKU ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç)</li>';
    }
}
    // [ ‚úÖ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§´‡§ø‡§ï‡•ç‡§∏: ‡§§‡§æ‡§ï‡§ø ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§ï‡§π‡•Ä‡§Ç ‡§≠‡•Ä ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ ‡§Ü‡§á‡§ü‡§Æ ‡§ê‡§° ‡§π‡•ã ‡§ú‡§æ‡§è ]

function handleSearchResultClick(e) {
    // ‡§ú‡§ø‡§∏ ‡§è‡§≤‡§ø‡§Æ‡•á‡§Ç‡§ü ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§π‡•Å‡§Ü, ‡§â‡§∏‡§ï‡•á ‡§∏‡§¨‡§∏‡•á ‡§ï‡§∞‡•Ä‡§¨‡•Ä 'li' ‡§ï‡•ã ‡§¢‡•Ç‡§Ç‡§¢‡•á‡§Ç
    const li = e.target.closest('li');
    
    if (li && li.dataset.sku) {
        const sku = li.dataset.sku;
        addSKUToCart(sku); // ‡§ï‡§æ‡§∞‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
        
        // ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§∏‡§∞‡•ç‡§ö ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§ñ‡§æ‡§≤‡•Ä ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§π‡§ü‡§æ‡§è‡§Ç
        document.getElementById('pos-item-search').value = '';
        document.getElementById('pos-search-results').innerHTML = '';
        document.getElementById('pos-item-search').focus(); // ‡§µ‡§æ‡§™‡§∏ ‡§ü‡§æ‡§á‡§™‡§ø‡§Ç‡§ó ‡§ï‡•á ‡§≤‡§ø‡§è ‡§´‡•ã‡§ï‡§∏ ‡§ï‡§∞‡•á‡§Ç
    }
}    
    // NEW: Centralized function to add SKU to cart (used by barcode and search)
    function addSKUToCart(sku) {
        const selectedItem = currentStock.find(item => item.sku === sku);
            
        if (selectedItem) {
            // Check stock quantity
            if(selectedItem.quantity <= 0) {
                return showMessage('‡§∏‡•ç‡§ü‡•â‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à', `${selectedItem.name} ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§`, 'danger');
            }
            
            const existingCartItem = posCart.find(item => item.sku === sku);
            if (existingCartItem) {
                // Check stock against cart
                if(existingCartItem.quantity >= selectedItem.quantity) {
                    return showMessage('‡§∏‡•ç‡§ü‡•â‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à', `‡§Ü‡§™‡§ï‡•á ‡§™‡§æ‡§∏ ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•á‡§Ç ‡§ï‡•á‡§µ‡§≤ ${selectedItem.quantity} ${selectedItem.name} ‡§π‡•à‡§Ç‡•§`, 'warning');
                }
                existingCartItem.quantity++;
            } else {
                posCart.push({ 
    ...selectedItem, 
    quantity: 1,
    purchase_price: parseFloat(selectedItem.purchase_price || 0),
    product_attributes: selectedItem.product_attributes // <-- YEH NAYI LINE HAI
});
            }
            updatePOSCartView();
        } else {
             showMessage('‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ', `SKU ${sku} ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§`, 'warning');
        }
        
        document.getElementById('pos-item-search').value = '';
        document.getElementById('pos-search-results').innerHTML = '';
        document.getElementById('pos-item-search').focus();
    }

    function updatePOSCartView() {
        const cartBody = document.getElementById('pos-cart-body');
        if(!cartBody) return; // Prevent errors if view is not active

        if (posCart.length === 0) {
            cartBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">‡§ï‡§æ‡§∞‡•ç‡§ü ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•à‡•§</td></tr>`;
        } else {
            cartBody.innerHTML = posCart.map((item, index) => {
                const saleTotal = item.sale_price * item.quantity;
                const stockItem = currentStock.find(s => s.sku === item.sku);
                const maxStock = stockItem ? stockItem.quantity : item.quantity; // Get current stock level
                
                return `
    <tr>
        <td>
            ${item.name}
            <small class="d-block text-info">${formatAttributes(item.product_attributes)}</small>
        </td>
        <td>
                            <input 
                                type="number" 
                                class="form-control form-control-sm" 
                                style="width: 100px;"
                                value="${item.quantity}" 
                                min="1" 
                                max="${maxStock}"
                                onchange="updateCartQuantity(${index}, this.value)"
                                onblur="validateCartQuantity(${index}, this.value, ${maxStock})"
                            >
                        </td>
                        <td>${formatCurrency(item.sale_price)}</td>
                        <td>${formatCurrency(saleTotal)}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="removeFromCart(${index})">&times;</button></td>
                    </tr>
                `;
            }).join('');
        }
        calculatePOSTotals();
    }
    
    // NEW: Validate quantity on blur (after changing)
    function validateCartQuantity(index, newQuantity, maxStock) {
        const quantity = parseInt(newQuantity);
        if (quantity > maxStock) {
             showMessage('‡§∏‡•ç‡§ü‡•â‡§ï ‡§∏‡•Ä‡§Æ‡§ø‡§§ ‡§π‡•à', `‡§Ü‡§™‡§ï‡•á ‡§™‡§æ‡§∏ ‡§ï‡•á‡§µ‡§≤ ${maxStock} ‡§Ü‡§á‡§ü‡§Æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§π‡•à‡§Ç‡•§`, 'warning');
             posCart[index].quantity = maxStock;
             updatePOSCartView();
        }
    }


    function updateCartQuantity(index, newQuantity) {
        const quantity = parseInt(newQuantity);
        
        if (isNaN(quantity) || quantity < 1) {
            showMessage('‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä', '‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ 1 ‡§Ø‡§æ ‡§â‡§∏‡§∏‡•á ‡§Ö‡§ß‡§ø‡§ï ‡§π‡•ã‡§®‡•Ä ‡§ö‡§æ‡§π‡§ø‡§è‡•§', 'warning');
            updatePOSCartView(); 
            return;
        }
        
        posCart[index].quantity = quantity;
        updatePOSCartView(); 
    }

    function removeFromCart(index) {
        posCart.splice(index, 1);
        updatePOSCartView();
    }

    function calculatePOSTotals() {
        let subtotal = 0;
        let gstAmount = 0;
        let totalAmount = 0;
        
        posCart.forEach(item => {
            const itemTotalWithGST = item.sale_price * item.quantity;
            const gstValue = parseFloat(item.gst) || 0;
            // This calculation assumes sale_price INCLUDES GST.
            // const subtotalWithoutGST = itemTotalWithGST / (1 + (gstValue / 100)); 
            
            // This calculation assumes sale_price EXCLUDES GST.
            const subtotalWithoutGST = itemTotalWithGST;
            const itemGstAmount = subtotalWithoutGST * (gstValue / 100);
            
            subtotal += subtotalWithoutGST;
            gstAmount += itemGstAmount;
        });
        
        totalAmount = subtotal + gstAmount;
        
        document.getElementById('pos-subtotal').innerText = formatCurrency(subtotal);
        document.getElementById('pos-gst-amount').innerText = formatCurrency(gstAmount);
        document.getElementById('pos-total-amount').innerText = formatCurrency(totalAmount);

        return totalAmount;
    }



    // üöÄ 4. MAIN SALE FUNCTION (Correct Sequence)
async function handleCompleteSale() {
    // --- 1. ‡§ï‡§æ‡§∞‡•ç‡§ü ‡§ö‡•á‡§ï ---
    if (posCart.length === 0) {
        return showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', '‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§™‡•Ç‡§∞‡•Ä ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§æ‡§∞‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç‡•§', 'warning');
    }

    const finalTotalAmount = parseFloat(document.getElementById('pos-total-amount').innerText.replace(/[^0-9.]/g, ''));

    // --- 2. ‡§°‡•á‡§ü‡§æ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§®‡§æ ---
    const itemsForApi = posCart.map(item => ({
        sku: item.sku, name: item.name, quantity: item.quantity,
        sale_price: item.sale_price, purchase_price: parseFloat(item.purchase_price || 0),
        gst: item.gst, product_attributes: item.product_attributes
    }));

    const custMobile = document.getElementById('pos-customer-mobile').value || null;
    const saleData = {
        customerName: document.getElementById('pos-customer').value || '‡§Ö‡§®‡§æ‡§Æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï',
        customerMobile: custMobile,
        total_amount: finalTotalAmount,
        sale_items: itemsForApi,
        latitude: document.getElementById('pos-lat')?.value,
        longitude: document.getElementById('pos-long')?.value,
        loanAccountNo: document.getElementById('pos-loan-account')?.value,
        painterId: document.getElementById('pos-painter-select')?.value,
        painterMobile: document.getElementById('pos-painter-mobile')?.value,
        commissionMode: document.getElementById('pos-commission-mode')?.value || 'PERCENT',
        commissionValue: document.getElementById('pos-commission-value')?.value || '0'
    };

    const deliveryDateRaw = document.getElementById('pos_auto_date')?.value;
    const deliveryDate = deliveryDateRaw ? new Date(deliveryDateRaw).toLocaleDateString('en-IN') : new Date().toLocaleDateString('en-IN');
    
    const sendToCust = document.getElementById('pos_send_cust_wa')?.checked;
    const sendToMistri = document.getElementById('pos_send_mistri_wa')?.checked;
    const isGodMode = document.getElementById('pos_auto_deliver_check')?.checked;

    // --- 3. ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§ï‡•â‡§≤ (API) ---
    try {
        console.log('üöÄ Sending Sale Data...');
        const res = await fetchApi('/api/invoices', { method: 'POST', body: saleData }, '‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§∏‡•á‡§µ ‡§ï‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à...');

        if (res.success) {
            
            // --- 4. ‡§∏‡§´‡§≤‡§§‡§æ ‡§Æ‡•à‡§∏‡•á‡§ú + ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§¨‡§ü‡§® (Mobile Fix) ---
            Swal.fire({
                title: '‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§∏‡§´‡§≤! üéâ',
                html: `<p>${res.message}</p><p>‡§¨‡§ø‡§≤ ID: <b>#${res.invoiceId}</b></p>`,
                icon: 'success',
                showCancelButton: true,
                confirmButtonText: 'üì• ‡§¨‡§ø‡§≤ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç',
                cancelButtonText: '‡§†‡•Ä‡§ï ‡§π‡•à',
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#aaa'
            }).then((result) => {
                if (result.isConfirmed) {
                    // ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§®‡•á ‡§™‡§∞ PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
                    generateAndDownloadPDF(res.invoiceId, saleData.customerName, itemsForApi, saleData.total_amount);
                }
            });

            // --- 5. WhatsApp ‡§≠‡•á‡§ú‡§®‡§æ (Customer) ---
            if (sendToCust && saleData.customerMobile) {
                const itemNames = itemsForApi.map(i => `${i.name} (x${i.quantity})`).join(', ');
                const msg = `‡§®‡§Æ‡§∏‡•ç‡§§‡•á *${saleData.customerName}*,\n` +
                            `‡§Ü‡§™‡§ï‡§æ ‡§ë‡§°‡§∞ ‡§ï‡§Ç‡§´‡§∞‡•ç‡§Æ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à! üéâ\n` +
                            `üßæ ‡§¨‡§ø‡§≤ ‡§®‡§Ç‡§¨‡§∞: *#${res.invoiceId}*\n` +
                            `üí∞ ‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø: *‚Çπ${saleData.total_amount.toFixed(2)}*\n` +
                            `üì¶ ‡§∏‡§æ‡§Æ‡§æ‡§®: ${itemNames}\n` +
                            `üöö ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä: ${deliveryDate}\n\n` +
                            `‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§æ‡§• ‡§Æ‡•á‡§Ç ‡§≠‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ PDF ‡§¨‡§ø‡§≤ ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§\n` +
                            `‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! üôè`;
                
                // 500ms ‡§ï‡§æ ‡§ó‡•à‡§™ (‡§§‡§æ‡§ï‡§ø UI ‡§∞‡•á‡§Ç‡§°‡§∞ ‡§π‡•ã ‡§ú‡§æ‡§è)
                setTimeout(() => { openSmartWhatsApp(saleData.customerMobile, msg); }, 500);
            }

            // --- 6. WhatsApp ‡§≠‡•á‡§ú‡§®‡§æ (Mistri) ---
            if (sendToMistri && saleData.painterMobile) {
                 const mistriMsg = `üõ†Ô∏è *Job Alert*\nüìç ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï: ${saleData.customerName}\nüìû: ${saleData.customerMobile}\nüöö ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä: ${deliveryDate}`;
                 // 2 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§ï‡§æ ‡§ó‡•à‡§™ (‡§§‡§æ‡§ï‡§ø ‡§™‡§π‡§≤‡•á ‡§µ‡§æ‡§≤‡§æ WhatsApp ‡§ñ‡•Å‡§≤ ‡§ú‡§æ‡§è)
                 setTimeout(() => { openSmartWhatsApp(saleData.painterMobile, mistriMsg); }, 2000);
            }

            // --- 7. God Mode (PDF & DB Update) ---
            await executeGodModeDelivery(res.invoiceId, saleData.customerName, saleData.customerMobile, itemsForApi, null);

            // ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂
            fetchAndRenderSales();
            if (typeof renderDashboard === 'function') renderDashboard();

        } else {
            throw new Error(res.message);
        }

    } catch (error) {
        showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§µ‡§ø‡§´‡§≤: ${error.message}`, 'danger');
    }
}





// --- FORM SUBMISSION HANDLERS ---
    
    // --- FORM SUBMISSION HANDLERS (Fixed & Updated) ---
    
    function setupForm(formId, apiPath, successCallback) {
        const form = document.getElementById(formId);
        
        // Check if form exists to avoid null errors
        if (form && !form.dataset.initialized) {
            form.dataset.initialized = 'true';
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = form.querySelector('button[type="submit"]');
                const originalBtnText = btn.innerHTML;
                
                // Disable button to prevent double submit
                btn.disabled = true;
                btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ‡§∏‡•á‡§µ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...`;
                
                const data = {};

                // ============================================================
                // 1. STOCK FORM LOGIC (Updated for Bulk & Retail & Salon)
                // ============================================================
                if (formId === 'add-stock-form') {
                    
                    // --- üöÄ NEW: BULK ENTRY CHECK ---
                    const bulkContainer = document.getElementById('dish-bulk-container');
                    const isBulkMode = bulkContainer && bulkContainer.style.display !== 'none';

                    if (isBulkMode) {
                        // --- BULK DISH SAVING LOGIC ---
                        const rows = document.querySelectorAll('.dish-entry-row');
                        const promises = [];
                        const btype = AppState.user.businessType;
                        const isSalon = (btype === 'SALON');

                        rows.forEach(row => {
                            const dName = row.querySelector('.dish-name').value;
                            const dPrice = row.querySelector('.dish-price').value;

                            if (dName && dPrice) {
                                const singleDishData = {
                                    sku: (isSalon ? 'SVC-' : 'DISH-') + Date.now() + Math.floor(Math.random() * 1000),
                                    name: dName,
                                    sale_price: dPrice,
                                    purchase_price: 0,
                                    quantity: 10000,
                                    unit: isSalon ? 'Session' : 'Plate',
                                    product_attributes: { type: 'SERVICE' }
                                };
                                promises.push(fetchApi('/api/stock', { method: 'POST', body: singleDishData }));
                            }
                        });

                        try {
                            await Promise.all(promises);
                            showMessage('‡§∏‡§´‡§≤‡§§‡§æ', `‚úÖ ${promises.length} ‡§°‡§ø‡§∂‡•á‡§ú ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ú‡•Å‡§°‡§º ‡§ó‡§à‡§Ç!`, 'success');
                            
                            // Reset Form & Table
                            form.reset();
                            document.getElementById('dish-bulk-body').innerHTML = '';
                            if(typeof addDishRow === 'function') addDishRow(); 
                            
                            if (successCallback) successCallback();
                            
                        } catch (err) {
                            showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', '‡§ï‡•Å‡§õ ‡§°‡§ø‡§∂‡•á‡§ú ‡§∏‡•á‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§™‡§æ‡§à‡§Ç: ' + err.message, 'danger');
                        } finally {
                            btn.disabled = false;
                            btn.innerHTML = originalBtnText;
                        }
                        return; // Stop here for Bulk Mode
                    }

                    // --- NORMAL STOCK ENTRY LOGIC ---
                    data.sku = document.getElementById('stock-sku').value;
                    data.name = document.getElementById('stock-name').value;
                    data.quantity = document.getElementById('stock-quantity').value;
                    data.unit = document.getElementById('stock-unit').value;
                    data.purchase_price = document.getElementById('stock-purchase-price').value;
                    data.sale_price = document.getElementById('stock-sale-price').value;
                    data.gst = document.getElementById('stock-gst').value;
                    data.hsn_code = document.getElementById('stock-hsn-code').value;
                    data.action_type = document.getElementById('stock-action-type').value;

                    // Recipe Data
                    const recipeElement = document.getElementById('stock-recipe-data');
                    if (recipeElement && recipeElement.value) {
                        try { data.recipe = JSON.parse(recipeElement.value); } catch (e) { console.error("Recipe parse error", e); }
                    }

                    // Attributes
                    data.product_attributes = {};

                    if (document.getElementById('stock-expiry')) {
                        data.product_attributes.expiry = document.getElementById('stock-expiry').value;
                        data.product_attributes.batch = document.getElementById('stock-batch').value;
                    }
                    
                    if (document.getElementById('stock-size')) {
                        data.product_attributes.Size = document.getElementById('stock-size').value;
                        data.product_attributes.Color = document.getElementById('stock-color').value;
                    }

                    if (document.getElementById('typeService') && document.getElementById('typeService').checked) {
                        data.product_attributes.type = 'SERVICE';
                    }

                    // Optical Fields
                    const addAttr = (obj, key, id) => {
                        const el = document.getElementById(id);
                        if (el && el.value && el.value.trim() !== '') { obj[key] = el.value.trim(); }
                    };

                    const presContainer = document.getElementById('prescription-fields-container');
                    if (presContainer && presContainer.style.display === 'block') {
                        addAttr(data.product_attributes, 'sph_od_dist', 'stock_sph_od_dist');
                        addAttr(data.product_attributes, 'cyl_od_dist', 'stock_cyl_od_dist');
                        addAttr(data.product_attributes, 'axs_od_dist', 'stock_axs_od_dist');
                        addAttr(data.product_attributes, 'sph_od_near', 'stock_sph_od_near');
                        addAttr(data.product_attributes, 'cyl_od_near', 'stock_cyl_od_near');
                        addAttr(data.product_attributes, 'axs_od_near', 'stock_axs_od_near');

                        addAttr(data.product_attributes, 'sph_os_dist', 'stock_sph_os_dist');
                        addAttr(data.product_attributes, 'cyl_os_dist', 'stock_cyl_os_dist');
                        addAttr(data.product_attributes, 'axs_os_dist', 'stock_axs_os_dist');
                        addAttr(data.product_attributes, 'sph_os_near', 'stock_sph_os_near');
                        addAttr(data.product_attributes, 'cyl_os_near', 'stock_cyl_os_near');
                        addAttr(data.product_attributes, 'axs_os_near', 'stock_axs_os_near');
                    }

// üëáüëáüëá ‡§Ø‡§π ‡§ï‡•ã‡§° 'setupForm' ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ 'add-stock-form' ‡§µ‡§æ‡§≤‡•á ‡§π‡§ø‡§∏‡•ç‡§∏‡•á ‡§Æ‡•á‡§Ç ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç üëáüëáüëá

// ===============================================
// üî• GARMENTS ANTI-THEFT DATA (‡§Ø‡§π‡§æ‡§Å ‡§ú‡•ã‡§°‡§º‡•á‡§Ç)
// ===============================================
const tagCheck = document.getElementById('sec-tag-attached');
if (tagCheck) { 
    // ‡§Ö‡§ó‡§∞ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§™‡§∞ ‡§≤‡§æ‡§≤ ‡§°‡§¨‡•ç‡§¨‡§æ (Anti-Theft) ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§π‡•à
    data.product_attributes.is_secured = true;
    data.product_attributes.has_hard_tag = tagCheck.checked;
    data.product_attributes.rfid_code = document.getElementById('sec-rfid-code')?.value || '';
    data.product_attributes.floor_section = document.getElementById('sec-floor-loc')?.value || '';
}
// ===============================================


                // ============================================================
                // 2. CUSTOMER FORM LOGIC
                // ============================================================
                } else if (formId === 'add-customer-form') {
                    data.name = document.getElementById('customer-name').value;
                    data.phone = document.getElementById('customer-phone').value;
                    data.email = document.getElementById('customer-email').value;
                    data.address = document.getElementById('customer-address').value;
                    data.gstin = document.getElementById('customer-gstin').value;
                    const balEl = document.getElementById('customer-balance');
                    data.balance = balEl ? (balEl.value || 0) : 0;

                // ============================================================
                // 3. PURCHASE FORM LOGIC (Corrected)
                // ============================================================
                } else if (formId === 'add-purchase-form') {
                    data.supplier_name = document.getElementById('purchase-supplier').value;
                    data.total_cost = parseFloat(document.getElementById('purchase-total-cost').value) || 0;
                    data.date = document.getElementById('purchase-date').value;

                    // User Details / Bill No Logic
                    const userDetails = document.getElementById('purchase-item-details') ? document.getElementById('purchase-item-details').value : '';
                    const billNo = document.getElementById('purchase-bill-number').value;
                    
                    data.item_details = userDetails ? userDetails : `Bill No: ${billNo}`;

                    data.gst_details = {
                        invoice_number: billNo,
                        taxable_value: parseFloat(document.getElementById('purchase-taxable-value').value) || 0,
                        cgst: parseFloat(document.getElementById('purchase-cgst').value) || 0,
                        sgst: parseFloat(document.getElementById('purchase-sgst').value) || 0,
                        igst: parseFloat(document.getElementById('purchase-igst').value) || 0
                    };

                    // Validation
                    const calculatedTotal = data.gst_details.taxable_value + data.gst_details.cgst + data.gst_details.sgst + data.gst_details.igst;
                    
                    if (calculatedTotal > 0 && Math.abs(calculatedTotal - data.total_cost) > 1.0) {
                        const confirmMsg = "‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä: ‡§ï‡•Å‡§≤ ‡§¨‡§ø‡§≤ ‡§∞‡§æ‡§∂‡§ø (" + data.total_cost + ") ‡§î‡§∞ GST ‡§ü‡•ã‡§ü‡§≤ (" + calculatedTotal + ") ‡§Æ‡•à‡§ö ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∞‡§π‡•á‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§Ü‡§ó‡•á ‡§¨‡•ù‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?";
                        if (!confirm(confirmMsg)) {
                            btn.disabled = false;
                            btn.innerHTML = originalBtnText;
                            return; 
                        }
                    }

                // ============================================================
                // 4. EXPENSE FORM LOGIC (Corrected)
                // ============================================================
                } else if (formId === 'add-expense-form') {
                    data.description = document.getElementById('expense-description').value;
                    data.category = document.getElementById('expense-category').value;
                    data.amount = document.getElementById('expense-amount').value;
                    data.created_at = document.getElementById('expense-date').value;
                }

                // ============================================================
                // API CALL (Universal)
                // ============================================================
                try {
                    let correctApiPath = apiPath;
                    if (apiPath === '/api/customer') correctApiPath = '/api/customers';
                    if (apiPath === '/api/purchase') correctApiPath = '/api/purchases';
                    if (apiPath === '/api/expense') correctApiPath = '/api/expenses';

                    const res = await fetchApi(correctApiPath, { method: 'POST', body: data });
                    
                    if (res.success) {
                        showMessage('‡§∏‡§´‡§≤‡§§‡§æ', res.message, 'success');
                        form.reset();
                        if (successCallback) successCallback();
                    } else {
                        throw new Error(res.message);
                    }
                } catch (error) {
                    console.error(error);
                    showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§∏‡•á‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§æ: ${error.message}`, 'danger');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalBtnText;
                }
            });
        }
    }

// üöÄ ‡§®‡§Ø‡§æ ‡§π‡•á‡§≤‡•ç‡§™‡§∞ ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§®: QR ‡§á‡§Æ‡•á‡§ú ‡§∏‡•á‡§ü ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§î‡§∞ Modal ‡§¶‡§ø‡§ñ‡§æ‡§§‡§æ ‡§π‡•à
function displayQrModal() {
         const modalBody = document.querySelector('#pairingModal .modal-body'); 
         if (!modalBody || !qrCodeDataUrl) {
             console.error("‚ùå displayQrModal: Modal ‡§¨‡•â‡§°‡•Ä ‡§Ø‡§æ QR ‡§ï‡•ã‡§° URL ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ!");
             showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', 'QR ‡§ï‡•ã‡§° ‡§¶‡§ø‡§ñ‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§', 'danger');
             return;
         }
         
         // Modal ‡§¨‡•â‡§°‡•Ä ‡§ï‡•ã ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§á‡§Æ‡•á‡§ú ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
         modalBody.innerHTML = `
            <p>‡§Ö‡§™‡§®‡•á Dukan Pro ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§∏‡•ç‡§ï‡•à‡§®‡§∞ ‡§ê‡§™ ‡§∏‡•á ‡§Ø‡§π QR ‡§ï‡•ã‡§° ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡•á‡§Ç‡•§</p>
            <div style="min-height: 260px; display: flex; align-items: center; justify-content: center;">
                <img src="${qrCodeDataUrl}" alt="QR Code" style="width: 256px; height: 256px; border: 1px solid #ccc;">
            </div>
             <p class="text-muted small mt-3">‡§Ø‡§π QR ‡§ï‡•ã‡§° ‡§Ü‡§™‡§ï‡•á POS ‡§ï‡•ã ‡§Ü‡§™‡§ï‡•á ‡§´‡§º‡•ã‡§® ‡§∏‡•á ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§ú‡•ã‡§°‡§º‡§§‡§æ ‡§π‡•à‡•§</p>
         `;
         
         // Modal ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
         if (pairingModalInstance) {
             pairingModalInstance.show();
         }
         isWaitingForQr = false; // ‡§á‡§Ç‡§§‡§ú‡§º‡§æ‡§∞ ‡§ñ‡§§‡•ç‡§Æ
    }


    // ===================================
// STAFF MANAGEMENT FUNCTIONS (NEW)
// ===================================
let staffEditModal = null; // To hold the modal instance
let planLockModalInstance = null; // üöÄ NAYA: Plan Lock Modal

async function renderStaff() {
    // Only admin can see and manage staff
    if (!AppState.user || AppState.user.role !== 'ADMIN') {
        // Optionally hide the staff section link if not admin, though RBAC should handle it
        const staffLink = document.querySelector('a[data-view="staff"]');
        if(staffLink) staffLink.classList.add('d-none');
        // Clear the table if somehow accessed by non-admin
        document.getElementById('staff-table-body').innerHTML = `<tr><td colspan="7" class="text-center text-danger">‡§á‡§∏ ‡§∏‡•á‡§ï‡•ç‡§∂‡§® ‡§§‡§ï ‡§™‡§π‡•Å‡§Å‡§ö‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§°‡§Æ‡§ø‡§® ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à‡•§</td></tr>`;
        return;
    }

    const tableBody = document.getElementById('staff-table-body');
    tableBody.innerHTML = `<tr><td colspan="7" class="text-center">‡§∏‡•ç‡§ü‡§æ‡§´ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</td></tr>`;

    try {
        // Fetch users for the current shop using the correct endpoint
        const res = await fetchApi('/api/users', { method: 'GET' });
        if (res.success && res.users) {
            if (res.users.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">‡§á‡§∏ ‡§∂‡•â‡§™ ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§∏‡•ç‡§ü‡§æ‡§´ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§®‡§π‡•Ä‡§Ç ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§</td></tr>`;
                 return;
            }
            // Populate table rows
            tableBody.innerHTML = res.users.map(staff => `
                <tr>
                    <td>${staff.id}</td>
                    <td>${staff.name}</td>
                    <td>${staff.email}</td>
                    <td><span class="badge bg-${staff.role === 'ADMIN' ? 'danger' : staff.role === 'MANAGER' ? 'warning' : 'info'}">${staff.role}</span></td>
                    <td><span class="badge bg-${staff.status === 'active' ? 'success' : staff.status === 'pending' ? 'secondary' : 'dark'}">${staff.status}</span></td>
                    <td>${new Date(staff.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-primary ${staff.id === AppState.user.id ? 'disabled' : ''}" onclick='openEditStaffModal(${JSON.stringify(staff)})' title="‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger ${staff.id === AppState.user.id ? 'disabled' : ''}" onclick="handleDeleteStaff(${staff.id})" title="‡§π‡§ü‡§æ‡§è‡§Ç">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } else {
            throw new Error(res.message || '‡§∏‡•ç‡§ü‡§æ‡§´ ‡§∏‡•Ç‡§ö‡•Ä ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§');
        }
    } catch (e) {
        tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}</td></tr>`;
    }
}

// Opens the Edit Staff modal with pre-filled data
function openEditStaffModal(staff) {
    if (!staffEditModal) {
        staffEditModal = new bootstrap.Modal(document.getElementById('editStaffModal'));
    }
    // Populate the modal form fields
    document.getElementById('edit-staff-id').value = staff.id;
    document.getElementById('edit-staff-name').value = staff.name;
    document.getElementById('edit-staff-email').value = staff.email; // Email is disabled, just for display
    document.getElementById('edit-staff-role').value = staff.role;
    document.getElementById('edit-staff-status').value = staff.status;
    document.getElementById('edit-staff-password').value = ''; // Clear password field for security
    staffEditModal.show(); // Show the modal
}

// Handles the submission of the "Add Staff" form
async function handleAddStaff(event) {
    event.preventDefault(); // Prevent default form submission
    const btn = event.target.querySelector('button[type="submit"]');
    const originalBtnText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ‡§ú‡•ã‡§°‡§º‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...`;

    // Collect data from the add form
    const data = {
        name: document.getElementById('staff-name').value,
        email: document.getElementById('staff-email').value,
        password: document.getElementById('staff-password').value,
        role: document.getElementById('staff-role').value,
        status: document.getElementById('staff-status').value,
    };

    try {
        // Send POST request to add user endpoint
        const res = await fetchApi('/api/users', { method: 'POST', body: data });
        if (res.success) {
            showMessage('‡§∏‡§´‡§≤‡§§‡§æ', '‡§∏‡•ç‡§ü‡§æ‡§´ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ‡•§', 'success');
            document.getElementById('add-staff-form').reset(); // Reset form fields
            renderStaff(); // Refresh the staff list
        } else {
            throw new Error(res.message);
        }
    } catch (e) {
        showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§∏‡•ç‡§ü‡§æ‡§´ ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${e.message}`, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalBtnText;
    }
}







 // Handles the submission of the "Edit Staff" modal form
 async function handleUpdateStaff(event) {
    event.preventDefault(); // Prevent default form submission
    const staffId = document.getElementById('edit-staff-id').value;
    const btn = event.target.querySelector('button[type="submit"]');
    const originalBtnText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ‡§∏‡•á‡§µ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...`;

    // Collect data from the edit form
    const data = {
        name: document.getElementById('edit-staff-name').value,
        role: document.getElementById('edit-staff-role').value,
        status: document.getElementById('edit-staff-status').value,
    };
    // Note: Password update logic is currently commented out as per previous code
    const newPassword = document.getElementById('edit-staff-password').value;
    if (newPassword) {
         showMessage('‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä', '‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¨‡§¶‡§≤‡§®‡•á ‡§ï‡•Ä ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ ‡§Ö‡§≠‡•Ä ‡§≤‡§æ‡§ó‡•Ç ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§°‡§Æ‡§ø‡§® ‡§™‡•à‡§®‡§≤ ‡§∏‡•á ‡§¨‡§¶‡§≤‡•á‡§Ç ‡§Ø‡§æ ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§', 'warning');
         // If you implement password change on the server via PUT /api/users/:userId, uncomment below
         // data.password = newPassword;
    }

    try {
        // Send PUT request to update user endpoint
        const res = await fetchApi(`/api/users/${staffId}`, { method: 'PUT', body: data });
        if (res.success) {
            showMessage('‡§∏‡§´‡§≤‡§§‡§æ', '‡§∏‡•ç‡§ü‡§æ‡§´ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§', 'success');
            if (staffEditModal) staffEditModal.hide(); // Hide the modal
            renderStaff(); // Refresh the staff list
        } else {
            throw new Error(res.message);
        }
    } catch (e) {
        showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§∏‡•ç‡§ü‡§æ‡§´ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${e.message}`, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalBtnText;
    }
}

// Handles the deletion of a staff member
async function handleDeleteStaff(staffId) {
    // Prevent admin from deleting themselves
    if (staffId === AppState.user.id) {
        showMessage('‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§®‡§π‡•Ä‡§Ç', '‡§Ü‡§™ ‡§ñ‡•Å‡§¶ ‡§ï‡•ã ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á‡•§', 'warning');
        return;
    }

    if (!confirm(`‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§∏‡•ç‡§ü‡§æ‡§´ ‡§∏‡§¶‡§∏‡•ç‡§Ø ID ${staffId} ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§Ø‡§π ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§µ‡§æ‡§™‡§∏ ‡§®‡§π‡•Ä‡§Ç ‡§≤‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä‡•§`)) return;

    try {
        // Send DELETE request to delete user endpoint
        const res = await fetchApi(`/api/users/${staffId}`, { method: 'DELETE' });
         if (res.success) {
            showMessage('‡§∏‡§´‡§≤‡§§‡§æ', '‡§∏‡•ç‡§ü‡§æ‡§´ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§π‡§ü‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§', 'success');
            renderStaff(); // Refresh the staff list
        } else {
            throw new Error(res.message);
        }
    } catch (e) {
         showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§∏‡•ç‡§ü‡§æ‡§´ ‡§π‡§ü‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${e.message}`, 'danger');
    }
}

    // --- APPLICATION UNLOCK & INITIALIZATION ---
   // ... (unlockApplication ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§®)
   const unlockApplication = () => {
        // üöÄ ‡§®‡§Ø‡§æ: ‡§®‡§è ‡§≤‡•â‡§ó‡§ø‡§® ‡§™‡•á‡§ú ‡§ï‡•ã ‡§õ‡§ø‡§™‡§æ‡§è‡§Å
        const authContainerNew = document.getElementById('auth-container-new');
        if (authContainerNew) authContainerNew.classList.add('hidden');
        
        // ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§ï‡•ã‡§° (auth-container ‡§ï‡•ã ‡§õ‡§ø‡§™‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è)
        //document.getElementById('auth-container').classList.add('hidden');//
        
        // ‡§¨‡§æ‡§ï‡•Ä ‡§ï‡§æ ‡§Ü‡§™‡§ï‡§æ ‡§ï‡•ã‡§°...
        document.getElementById('sidebar').classList.remove('locked');
        document.getElementById('main-content').classList.remove('locked');
        // ... (‡§Ü‡§¶‡§ø) ...
        
        applyRBAC(AppState.user.role);
        applyBusinessTypeUI(AppState.user.businessType || 'RETAIL');
     setupForm('add-stock-form', '/api/stock', fetchAndRenderStockList);
  setupForm('add-customer-form', '/api/customers', fetchAndRenderCustomers); 
setupForm('add-purchase-form', '/api/purchases', fetchAndRenderPurchases);
setupForm('add-expense-form', '/api/expenses', fetchAndRenderExpenses);
        // ... (‡§Ü‡§™‡§ï‡•á ‡§∏‡§≠‡•Ä setupForm ‡§î‡§∞ setupNewFormHandlers ‡§ï‡•â‡§≤‡•ç‡§∏) ...
        setupNewFormHandlers();
      // ... (setupNewFormHandlers(); ‡§ï‡•á ‡§†‡•Ä‡§ï ‡§¨‡§æ‡§¶)

        // üöÄ NAYA FIX: Role ‡§ï‡•á ‡§π‡§ø‡§∏‡§æ‡§¨ ‡§∏‡•á ‡§™‡§π‡§≤‡§æ ‡§™‡•á‡§ú ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
        if (AppState.user.role === 'ACCOUNTANT') {
            renderView('reports'); // CA ‡§ï‡•ã ‡§∏‡•Ä‡§ß‡•á ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
        } else {
            renderView('dashboard'); // ‡§¨‡§æ‡§ï‡•Ä ‡§∏‡§¨‡§ï‡•ã ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° (POS) ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
        }
        
        initDashboardSocket();
        fetchAndRenderPaintHistory();
    };

    /**
     * Hides/Shows UI elements based on user role
     * Roles: ADMIN (3) > MANAGER (2) > CASHIER (1)
     */
     function applyRBAC(role) {
    
    // 1. Role levels ko define karein
    // (Accountant, Manager ke barabar hai, yaani Level 2)
    const roles = { 'ADMIN': 3, 'MANAGER': 2, 'ACCOUNTANT': 2, 'CASHIER': 1, 'ANY': 0 };
    
    const userRole = role.toUpperCase();
    const userLevel = roles[userRole] || 0;

    // 2. Sabhi [data-role] wale elements ko check karein
    document.querySelectorAll('[data-role]').forEach(el => {
        const requiredRole = el.dataset.role.toUpperCase();
        
        // Agar data-role define nahi hai, to use 'ANY' maanein
        const requiredLevel = roles[requiredRole] || 0; 

        let show = false; // Default: Sab chhupa do

        // 3. Logic: Kise kya dikhana hai?
        if (userRole === 'ACCOUNTANT') {
            
            // --- üöÄ ACCOUNTANT KA LOGIC ---
            // CA sirf 'ANY', 'ACCOUNTANT', ya 'MANAGER' (reports ke liye)
            // wali cheezein dekh sakta hai.
            if (requiredRole === 'ANY' || requiredRole === 'ACCOUNTANT' || requiredRole === 'MANAGER') {
                show = true;
            }
            // --- Yeh Line Sabse Zaroori Hai ---
            // Agar element 'CASHIER' ka hai, to CA ko *mat* dikhao
            if (requiredRole === 'CASHIER') {
                show = false;
            }

        } else {
            // --- üöÄ ADMIN/MANAGER/CASHIER KA PURANA LOGIC ---
            // (Level-based: Admin > Manager > Cashier)
            if (requiredRole === 'ANY' || userLevel >= requiredLevel) {
                show = true;
            }
        }

        // 4. Faisla laagu (apply) karein
        if (show) {
            el.classList.remove('d-none'); // Dikhao
        } else {
            el.classList.add('d-none'); // Chhupao
        }
    });

// [ YEH NAYA CODE YAHAN PASTE KAREIN ]

    // --- üöÄ NAYA FIX (v4): CA KE LIYE ACTION FORMS/BUTTONS ALAG SE CHHUPAO ---
    // (Yeh code [data-role] loop ke *baad* chalta hai)

       // Sabhi "Add" forms ke ID
    //¬†Sabhi¬†"Add"¬†forms¬†ke¬†ID
    ¬†¬†¬†¬†const¬†allActionForms¬†=¬†[
¬†¬†¬†¬†¬†¬†¬†¬†'#add-stock-form',¬†'#add-expense-form',¬†'#add-purchase-form',¬†
¬†¬†¬†¬†¬†¬†¬†¬†'#add-staff-form',¬†'#company-profile-form', 
¬†¬†¬† ¬†¬†¬†¬†'#daily-closing'
¬†¬†¬†¬†];
    
    // Sabhi "Edit/Delete/Submit" buttons ke Class/Selectors
    // (List ko file [SAgar SAGArLatest 2 (2)(1).html] ke hisaab se update kiya gaya hai)
    const allActionButtons = document.querySelectorAll(
        '.edit-stock-btn, button[onclick^="deleteStock"], .delete-stock-btn,' +
        '.edit-customer-btn, .delete-customer-btn,' +
        '.edit-expense-btn, .delete-expense-btn,' +
        '.edit-purchase-btn, .delete-purchase-btn,' +
        '.edit-staff-btn, .delete-staff-btn, button[onclick^="deleteStaff"],' +
        'button[onclick^="editStaff"], button[type="submit"],' +
        '#editStaffModal .modal-footer .btn-primary,' +
        'a[onclick^="showEditCustomerModal"], #editCustomerModal .modal-footer .btn-primary,' +
        'a[onclick^="showEditStockModal"], #editStockModal .modal-footer .btn-primary'
    );

    if (userRole === 'ACCOUNTANT') {
        // Agar CA hai, to sabhi forms aur action buttons ko chhupao
        allActionForms.forEach(selector => {
            const el = document.querySelector(selector);
            if (el) el.classList.add('d-none');
        });
        allActionButtons.forEach(btn => btn.classList.add('d-none'));

    } else {
        // Agar CA nahi hai, to sabhi ko (wapas) dikhao
        // (Yeh zaroori hai agar user logout karke Admin jaisa login kare)
        allActionForms.forEach(selector => {
            const el = document.querySelector(selector);
            if (el) el.classList.remove('d-none');
        });
        allActionButtons.forEach(btn => btn.classList.remove('d-none'));
    }
    // --- NAYA FIX YAHAN KHATM HOTA HAI ---
}


    // --- INVOICE GENERATOR FUNCTIONS ---
    function initializeQRUpload() {
        console.log("Initializing QR Upload...");
        const qrUploadInput = document.getElementById('qrUpload'); //
        if (qrUploadInput) {
            qrUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) {
                    qrCodeImage = '';
                    updateInvoicePreview();
                    return;
                }
                
                // ‡§´‡§º‡§æ‡§á‡§≤ ‡§ï‡•ã Base64 ‡§∏‡•ç‡§ü‡•ç‡§∞‡§ø‡§Ç‡§ó ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤‡•á‡§Ç
                const reader = new FileReader();
                reader.onload = (event) => {
                    qrCodeImage = event.target.result; // Base64 ‡§°‡•á‡§ü‡§æ
                    updateInvoicePreview(); // ‡§™‡•ç‡§∞‡•Ä‡§µ‡•ç‡§Ø‡•Ç ‡§ï‡•ã QR ‡§ï‡•ã‡§° ‡§ï‡•á ‡§∏‡§æ‡§• ‡§∞‡•Ä‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç
                };
                reader.readAsDataURL(file);
            });
        }
    }
    // --- REPORT ACTION HANDLER ---

    
    function handleReportAction(reportType, action) {
        // ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§≤‡•â‡§ú‡§ø‡§ï ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§æ‡§∞‡•ç‡§° ‡§ï‡§æ ID
        const reportCardId = reportType === 'profit_loss' ? 'pl-card' : 'bs-card';
        const reportElement = document.getElementById(reportCardId);

        if (action === 'print') {
            // --- PRINT LOGIC (‡§á‡§∏‡•á ‡§®‡§π‡•Ä‡§Ç ‡§¨‡§¶‡§≤‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à) ---
            document.querySelectorAll('.printable').forEach(el => el.classList.remove('printable'));
            reportElement.classList.add('printable');

            const headerHtml = `
                <div class="printable text-center mb-3">
                    <h3>${AppState.user.shopName}</h3>
                    <p class="mb-0">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü: ${reportType.replace('_', ' ')}</p>
                    <p class="mb-0">‡§§‡§æ‡§∞‡•Ä‡§ñ: ${new Date().toLocaleDateString()}</p>
                </div>
            `;

            let headerDiv = reportElement.querySelector('.report-print-header');
            if (headerDiv) {
                headerDiv.innerHTML = headerHtml;
            } else {
                headerDiv = document.createElement('div');
                headerDiv.className = 'report-print-header';
                headerDiv.innerHTML = headerHtml;
                reportElement.prepend(headerDiv);
            }

            window.print();

        } else if (action === 'download') {

            // --- üöÄ ‡§Ø‡§π ‡§∞‡§π‡§æ ‡§Ü‡§™‡§ï‡§æ ‡§´‡§ø‡§ï‡•ç‡§∏ EXCEL DOWNLOAD LOGIC ---
            
            showMessage('Info', 'Excel (.xlsx) ‡§´‡§º‡§æ‡§á‡§≤ ‡§¨‡§®‡§æ‡§à ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç...', 'info');

            try {
                // 1. ‡§®‡§Ø‡§æ Excel Workbook (‡§ñ‡§æ‡§≤‡•Ä ‡§´‡§º‡§æ‡§á‡§≤) ‡§¨‡§®‡§æ‡§è‡§Å
                const wb = XLSX.utils.book_new();
                
                // üöÄ NAYA HELPER: ‡§¶‡•ã ‡§ü‡•á‡§¨‡§≤‡•ã‡§Ç ‡§ï‡•ã ‡§Ö‡§ó‡§≤-‡§¨‡§ó‡§≤ ‡§Æ‡§∞‡•ç‡§ú ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è
                const mergeTablesSideBySide = (table1, table2) => {
                    const t1Rows = table1.querySelectorAll('tr');
                    const t2Rows = table2.querySelectorAll('tr');
                    const maxRows = Math.max(t1Rows.length, t2Rows.length);
                    const mergedData = [];

                    for (let i = 0; i < maxRows; i++) {
                        const newRow = [];
                        
                        // 1. Get Left Table Data (Cols A, B)
                        if (t1Rows[i]) {
                            const cells = t1Rows[i].querySelectorAll('th, td');
                            newRow.push(cells[0] ? cells[0].innerText.trim() : ''); // Col A
                            newRow.push(cells[1] ? cells[1].innerText.trim() : ''); // Col B
                        } else {
                            newRow.push('', ''); // Empty placeholders
                        }

                        // 2. Get Spacer (Col C)
                        newRow.push(''); // Blank column

                        // 3. Get Right Table Data (Cols D, E)
                        if (t2Rows[i]) {
                            const cells = t2Rows[i].querySelectorAll('th, td');
                            newRow.push(cells[0] ? cells[0].innerText.trim() : ''); // Col D
                            newRow.push(cells[1] ? cells[1].innerText.trim() : ''); // Col E
                        } else {
                            newRow.push('', ''); // Empty placeholders
                        }
                        
                        mergedData.push(newRow);
                    }
                    return mergedData;
                };
                // üöÄ NAYA HELPER YAHAN KHATM HOTA HAI

                if (reportType === 'profit_loss') {
                    // --- P&L ‡§ü‡•á‡§¨‡§≤‡•ç‡§∏ ‡§ï‡•ã ‡§â‡§®‡§ï‡•á ‡§ï‡§æ‡§∞‡•ç‡§° ‡§∏‡•á ‡§¢‡•Ç‡§Å‡§¢‡•á‡§Ç ---
                    const plCard = document.getElementById('pl-card');
                    const plTables = plCard.querySelectorAll('table.report-table'); // ‡§¶‡•ã‡§®‡•ã‡§Ç P&L ‡§ü‡•á‡§¨‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç
                    if (plTables.length < 2) throw new Error('P&L ‡§ü‡•á‡§¨‡§≤‡•ç‡§∏ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡§Ç‡•§');
                    
                    const mergedPLData = mergeTablesSideBySide(plTables[0], plTables[1]);
                    const ws_pl = XLSX.utils.aoa_to_sheet(mergedPLData);
                    ws_pl['!cols'] = [ { wch: 30 }, { wch: 20 }, { wch: 5 }, { wch: 30 }, { wch: 20 } ];
                    
                    XLSX.utils.book_append_sheet(wb, ws_pl, 'Profit & Loss (Side-by-Side)');
                    XLSX.writeFile(wb, `P&L_report_${getISODate()}.xlsx`);


                } else if (reportType === 'balance_sheet') {
                    // --- Balance Sheet ‡§ü‡•á‡§¨‡§≤‡•ç‡§∏ ‡§ï‡•ã ‡§â‡§®‡§ï‡•á ‡§ï‡§æ‡§∞‡•ç‡§° ‡§∏‡•á ‡§¢‡•Ç‡§Å‡§¢‡•á‡§Ç ---
                    const bsCard = document.getElementById('bs-card');
                    const bsTables = bsCard.querySelectorAll('table.report-table'); // ‡§¶‡•ã‡§®‡•ã‡§Ç BS ‡§ü‡•á‡§¨‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç
                    if (bsTables.length < 2) throw new Error('‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§∂‡•Ä‡§ü ‡§ü‡•á‡§¨‡§≤‡•ç‡§∏ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡§Ç‡•§');

                    // üöÄ NAYA LOGIC: ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§ï‡•ã ‡§Æ‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç
                    const mergedBSData = mergeTablesSideBySide(bsTables[0], bsTables[1]);
                    
                    // 4. Create worksheet from the merged data
                    const ws_bs = XLSX.utils.aoa_to_sheet(mergedBSData);
                    
                    // (Optional but good) Adjust column widths
                    ws_bs['!cols'] = [ { wch: 30 }, { wch: 20 }, { wch: 5 }, { wch: 30 }, { wch: 20 } ];

                    // 5. Create workbook and download
                    XLSX.utils.book_append_sheet(wb, ws_bs, 'Balance Sheet (Side-by-Side)');
                    XLSX.writeFile(wb, `balance_sheet_side_by_side_${getISODate()}.xlsx`);
                }

            } catch (err) {
                showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', 'Excel ‡§´‡§º‡§æ‡§á‡§≤ ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ' + err.message, 'danger');
                console.error("Excel download error:", err);
            }
            
            // --- üöÄ ‡§®‡§Ø‡§æ ‡§î‡§∞ ‡§∏‡§π‡•Ä EXCEL DOWNLOAD LOGIC ‡§Ø‡§π‡§æ‡§Å ‡§ñ‡§§‡•ç‡§Æ ‡§π‡•ã‡§§‡§æ ‡§π‡•à ---
        }
    }



	
    // --- UNIVERSAL DELETE FUNCTION ---
   async function deleteEntry(type, id) {
        // 'id' is now the primary key or SKU
        const messages = {
            sale: `(‡§Ö‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§) ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä (ID: ${id}) ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?`,
            stock: `‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Ü‡§á‡§ü‡§Æ (SKU: ${id}) ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?`, // Changed to SKU
            customer: `(‡§Ö‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§) ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï (ID: ${id}) ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?`,
            purchase: `‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ ‡§ñ‡§∞‡•Ä‡§¶ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° (ID: ${id}) ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?`,
            expense: `‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ ‡§ñ‡§∞‡•ç‡§ö ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° (ID: ${id}) ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?`
        };

        if (!confirm(messages[type])) return;

        let apiPath = '';
        let successCallback;

        switch (type) {
            case 'stock': apiPath = `/api/stock/${id}`; successCallback = fetchAndRenderStockList; break;
            case 'purchase': apiPath = `/api/purchases/${id}`; successCallback = fetchAndRenderPurchases; break; 
            case 'expense': apiPath = `/api/expenses/${id}`; successCallback = fetchAndRenderExpenses; break; 
            
            case 'sale': 
            case 'customer':
            default: 
                showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', '‡§Ø‡§π ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ (delete) ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§', 'danger'); 
                return;
        }

        try {
            const res = await fetchApi(apiPath, { method: 'DELETE' }, '‡§π‡§ü‡§æ‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...');
            if (res.success) {
                showMessage('‡§∏‡§´‡§≤‡§§‡§æ', res.message, 'success');
                if (successCallback) successCallback();
                renderDashboard();
                renderReports();
            } else {
                throw new Error(res.message);
            }
        } catch (error) {
            showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§π‡§ü‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${error.message}`, 'danger');
        }
    }


    function addItem() {
    const itemName = document.getElementById('itemName').value;
    const quantity = parseFloat(document.getElementById('quantity').value);
    const price = parseFloat(document.getElementById('price').value);
    const gst = parseFloat(document.getElementById('gst').value) || 0;

    // üîé Current selected stock item (assume POS dropdown / search se aata hai)
    const selectedStockItem = currentStock.find(i => i.name === itemName);

    // üîê ANTI-THEFT CHECK (‚≠ê ‡§Ø‡§π‡•Ä MAIN ‡§ö‡•Ä‡§ú ‡§π‡•à)
    if (selectedStockItem?.product_attributes?.is_secured) {
        alert('‚ö†Ô∏è Anti-Theft Item Detected!\nBilling ke bina exit allowed nahi.');
    }

    if (!itemName || !quantity || !price) {
        showMessage('Error', 'Please fill Item Name, Quantity, and Rate.', 'danger');
        return;
    }

    items.push({
        name: itemName,
        quantity: quantity,
        price: price,
        gst: gst,
        is_secured: selectedStockItem?.product_attributes?.is_secured || false
    });

    updateInvoicePreview();
    document.getElementById('item-form').reset();
    document.getElementById('itemName').focus();
}


    function deleteItem(index) {
        if (confirm('Are you sure you want to delete this item?')) {
            items.splice(index, 1);
            updateInvoicePreview();
        }
    }

    function updateInvoicePreview() {
        const shopName = document.getElementById('shopName').value || 'Shop Name';
        const shopContact = document.getElementById('shopContact').value || 'Contact No.';
        const shopAddress = document.getElementById('shopAddress').value || 'Shop Address';
        const shopGstin = document.getElementById('shopGstin').value || '';
        
        const customerName = document.getElementById('customerName').value || 'Customer Name';
        const customerContact = document.getElementById('customerContact').value || 'Contact No.';
        const customerAddress = document.getElementById('customerAddress').value || 'Customer Address';
        
        const preview = document.getElementById('invoice-preview'); //
        
        let itemRows = '';
        let totalAmount = 0;
        let totalTax = 0;
        let subTotal = 0;
        
        items.forEach((item, index) => {
            const itemSubTotal = (item.price || 0) * (item.quantity || 0);
            const itemGst = itemSubTotal * ((item.gst || 0) / 100);
            const itemTotal = itemSubTotal + itemGst;
            
            subTotal += itemSubTotal;
            totalTax += itemGst;
            totalAmount += itemTotal;
            
            itemRows += `
                <tr>
                    <td>${index + 1}</td>
                    <td style="text-align: left;">${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${formatCurrency(item.price)}</td>
                    <td>${item.gst}%</td>
                    <td>${formatCurrency(itemSubTotal)}</td>
                    <td>
                        <button class="btn btn-danger btn-sm py-0 px-1 no-print" onclick="deleteItem(${index})">&times;</button>
                    </td>
                </tr>
            `;
        });

        const cgst = totalTax / 2;
        const sgst = totalTax / 2;
        
        // üöÄ (‡§´‡§ø‡§ï‡•ç‡§∏) QR ‡§ï‡•ã‡§° ‡§ï‡•á ‡§≤‡§ø‡§è HTML
        const qrHtml = qrCodeImage ? `
            <div id="qr-preview" class="text-center">
                <p class="small mb-1">Scan to Pay:</p>
                <img src="${qrCodeImage}" alt="UPI QR Code" style="max-width: 100px; max-height: 100px; border: 1px solid #ccc; padding: 3px;">
            </div>` : '';

        // ‡§™‡•Ç‡§∞‡§æ ‡§á‡§®‡§µ‡•â‡§á‡§∏ HTML
        preview.innerHTML = `
            <div class="printable">
                <div class="invoice-header">
                    <div class="shop-details">
                        <h3>${shopName}</h3>
                        <p class="mb-0">${shopAddress}</p>
                        <p class="mb-0">Ph: ${shopContact}</p>
                        ${shopGstin ? `<p class="mb-0"><strong>GSTIN: ${shopGstin}</strong></p>` : ''}
                    </div>
                    <h2 style="color: #333; align-self: center;">INVOICE</h2>
                </div>
                
                <div class="customer-details row">
                    <div class="col-8">
                        <strong>Bill To:</strong>
                        <p class="mb-0">${customerName}</p>
                        <p class="mb-0">${customerAddress}</p>
                        <p class="mb-0">Ph: ${customerContact}</p>
                    </div>
                    <div class="col-4 text-end">
                        <p class="mb-0"><strong>Invoice No:</strong> INV-${Date.now().toString().slice(-6)}</p>
                        <p class="mb-0"><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                    </div>
                </div>

                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">#</th>
                            <th style="text-align: left;">Item</th>
                            <th style="width: 10%;">Qty</th>
                            <th style="width: 15%;">Rate</th>
                            <th style="width: 10%;">GST%</th>
                            <th style="width: 15%;">Amount</th>
                            <th style="width: 5%;" class="no-print"></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemRows || `<tr><td colspan="7" class="text-center text-muted p-4">No items added.</td></tr>`}
                    </tbody>
                </table>
                
                <div class="invoice-footer">
                    <div>
                        ${qrHtml} <div class="terms mt-3">
                            <strong>Terms & Conditions:</strong>
                            <p class="mb-0">1. Goods once sold will not be taken back.</p>
                            <p class="mb-0">2. All disputes are subject to jurisdiction.</p>
                        </div>
                    </div>
                    
                    <table class="totals-table">
                        <tbody>
                            <tr>
                                <td>Subtotal:</td>
                                <td style="text-align: right;">${formatCurrency(subTotal)}</td>
                            </tr>
                            <tr>
                                <td>CGST:</td>
                                <td style="text-align: right;">${formatCurrency(cgst)}</td>
                            </tr>
                            <tr>
                                <td>SGST:</td>
                                <td style="text-align: right;">${formatCurrency(sgst)}</td>
                            </tr>
                            <tr style="font-weight: bold; font-size: 1.2em; border-top: 2px solid #333;">
                                <td>Grand Total:</td>
                                <td style="text-align: right;">${formatCurrency(totalAmount)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }


   function downloadInvoicePDF() {
        if (items.length === 0) {
            return showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', 'PDF ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç‡•§', 'warning');
        }
        handleReportAction('invoice', 'download');
    }

    function printInvoice() {
        window.print();
    }

    function clearBill() {
        if (confirm('Are you sure you want to clear the entire bill?')) {
            items = [];
            qrCodeImage = '';
            document.getElementById('qrUpload').value = null;
            document.getElementById('customerName').value = '';
            document.getElementById('customerContact').value = '';
            document.getElementById('customerAddress').value = '';
            document.getElementById('item-form').reset();
            
            // ‡§∂‡•â‡§™ ‡§ï‡•Ä ‡§°‡§ø‡§ü‡•á‡§≤‡•ç‡§∏ ‡§ï‡•ã ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§≠‡§∞‡•á‡§Ç (‡§â‡§®‡•ç‡§π‡•á‡§Ç ‡§ï‡•ç‡§≤‡§ø‡§Ø‡§∞ ‡§® ‡§ï‡§∞‡•á‡§Ç)
            fetchAndPopulateShopData(); 
            
            showMessage('Success', 'Bill cleared.', 'success');
        }
    }
   // ===================================
    // STEP 6: NEW AUTHENTICATION FLOW & NEW FEATURES
    // ===================================

    /**
     * Saves auth data to AppState and localStorage
     */
     function saveAuthData(token, user) {
        AppState.token = token;
        AppState.user = user;
        localStorage.setItem('authToken', token);
        localStorage.setItem('authUser', JSON.stringify(user));
        
        // Update UI with user info
        updateShopDisplay(user);
    }
    
    // NEW: Update Shop Name/Logo in UI
   // NEW: Update Shop Name/Logo in UI
  // NEW: Update Shop Name/Logo in UI
 // [REPLACE THIS FUNCTION IN HTML <script>]

function updateShopDisplay(user) {
    if (!user) return;
    const shopName = user.shopName || 'Dukan Pro';
    
    // 1. ‡§≤‡•ã‡§ó‡•ã ‡§≤‡•â‡§ú‡§ø‡§ï (Logo Logic)
    const storedLogo = localStorage.getItem('shopLogoData');
    const shopLogo = user.shopLogo || storedLogo; 

    // 2. ‡§Ø‡•Ç‡§ú‡§∞ ‡§á‡§®‡•ç‡§´‡•ã ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç (‡§®‡•Ä‡§ö‡•á ‡§µ‡§æ‡§≤‡§æ ‡§¨‡•â‡§ï‡•ç‡§∏)
    document.getElementById('user-shop-name').innerText = shopName;
    
    // üöÄ NEW: Shop ID ‡§ï‡•ã ‡§Ø‡§π‡§æ‡§Å ‡§¨‡•ã‡§≤‡•ç‡§° ‡§î‡§∞ ‡§π‡§æ‡§à‡§≤‡§æ‡§á‡§ü ‡§ï‡§∞‡§ï‡•á ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
    document.getElementById('user-name-email').innerHTML = `
        ${user.name} (${user.role}) <br>
        <span class="badge bg-warning text-dark mt-2 w-100 shadow-sm" style="font-size: 0.9rem;">
            <i class="fas fa-id-badge me-1"></i> Shop ID: ${user.shopId}
        </span>
    `;
    
    // 3. ‡§∏‡§æ‡§á‡§°‡§¨‡§æ‡§∞ ‡§π‡•á‡§°‡§∞ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç (‡§∏‡§¨‡§∏‡•á ‡§ä‡§™‡§∞ ‡§µ‡§æ‡§≤‡§æ ‡§ü‡§æ‡§á‡§ü‡§≤)
    // üöÄ NEW: Shop ID ‡§ï‡•ã "Dukan Pro" ‡§ï‡•á ‡§¨‡§ó‡§≤ ‡§Æ‡•á‡§Ç ‡§≠‡•Ä ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
    const sidebarHeader = document.querySelector('.sidebar h3');
    if (sidebarHeader) {
        sidebarHeader.innerHTML = `
            <i class="fas fa-store me-2"></i>Dukan Pro 
            <sup class="badge bg-danger rounded-pill ms-1" style="font-size: 0.5em; top: -10px;">ID: ${user.shopId}</sup>
        `;
    }

    // 4. ‡§≤‡•ã‡§ó‡•ã ‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á (Logo Display)
    const logoContainer = document.getElementById('shop-logo-container');
    if (shopLogo) {
        logoContainer.innerHTML = `<img src="${shopLogo}" alt="Shop Logo" class="img-fluid rounded-circle" style="max-height: 100px; border: 3px solid #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">`;
        
        // Settings ‡§™‡•á‡§ú ‡§™‡§∞ ‡§≠‡•Ä ‡§≤‡•ã‡§ó‡•ã ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
        const removeBtn = document.getElementById('remove-shop-logo-btn');
        const preview = document.getElementById('shop-logo-preview');
        if (removeBtn) removeBtn.classList.remove('d-none');
        if (preview) {
            preview.src = shopLogo; 
            preview.style.display = 'block';
        }
    } else {
        if (logoContainer) logoContainer.innerHTML = '';
        const removeBtn = document.getElementById('remove-shop-logo-btn');
        const preview = document.getElementById('shop-logo-preview');
        if (removeBtn) removeBtn.classList.add('d-none');
        if (preview) preview.style.display = 'none';
    }
}


    /**
     * Clears auth data and reloads the page to show login screen
     */
     function logout() {
    AppState.token = null;
    AppState.user = null;
    localStorage.removeItem('authToken');
    localStorage.removeItem('authUser');
    if(AppState.licenseTimerId) clearInterval(AppState.licenseTimerId);
    
    // window.location.reload(); // ‚úÖ ‡§á‡§∏‡•á ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ (‡§ï‡§Æ‡•á‡§Ç‡§ü ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ)
    
    // ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡•Ä ‡§ú‡§ó‡§π ‡§≤‡•â‡§ó‡§ø‡§® ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
    document.getElementById('login-wrapper-main').classList.add('active');
    document.getElementById('auth-container-new').classList.remove('hidden');
    document.getElementById('sidebar').classList.add('locked');
    document.getElementById('main-content').classList.add('locked');
}
    
    // NEW: License Timer and Renewal Warning
    function startLicenseTimer(expiryDateStr) {
        const timerEl = document.getElementById('license-timer');
        const renewalModal = new bootstrap.Modal(document.getElementById('renewalModal'));
        if (AppState.licenseTimerId) clearInterval(AppState.licenseTimerId);
        
        if (!expiryDateStr) {
            timerEl.innerHTML = `<i class="fas fa-times-circle text-danger"></i> ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à`;
            timerEl.className = 'text-center mb-2 expired';
            timerEl.onclick = () => renewalModal.show();
            return;
        }

        const expiryDate = new Date(expiryDateStr);
        
        function updateTimer() {
            const now = new Date();
            const timeLeft = expiryDate.getTime() - now.getTime();
            
            const daysLeft = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hoursLeft = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutesLeft = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const secondsLeft = Math.floor((timeLeft % (1000 * 60)) / 1000);

            if (timeLeft <= 0) {
                timerEl.innerHTML = `<i class="fas fa-times-circle"></i> ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à`;
                timerEl.className = 'text-center mb-2 expired';
                timerEl.onclick = () => renewalModal.show();
                clearInterval(AppState.licenseTimerId);
            } else if (daysLeft < 7) {
                // Requirement 9: Expiring soon warning
                timerEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${daysLeft}d ${hoursLeft}h ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã‡§ó‡§æ!`;
                timerEl.className = 'text-center mb-2 expiring-soon';
                timerEl.onclick = () => renewalModal.show();
            } else {
                timerEl.innerHTML = `<i class="fas fa-check-circle text-success"></i> ${daysLeft} ‡§¶‡§ø‡§® ${hoursLeft} ‡§ò‡§Ç‡§ü‡•á ‡§∂‡•á‡§∑`;
                timerEl.className = 'text-center text-white-50 mb-2';
                timerEl.onclick = null;
            }
        }
        
        updateTimer();
        AppState.licenseTimerId = setInterval(updateTimer, 1000); // Update every second
    }
    
    // NEW: Send WhatsApp Renewal Request
    function sendWhatsAppRenewal(months) {
        const adminPhone = "7303410987";
        let message = `‡§®‡§Æ‡§∏‡•ç‡§§‡•á Dukan Pro ‡§è‡§°‡§Æ‡§ø‡§®,\n\n`;
        message += `‡§Æ‡•á‡§∞‡§æ ‡§®‡§æ‡§Æ ${AppState.user.name} ‡§π‡•à ‡§î‡§∞ ‡§Æ‡•á‡§∞‡•Ä ‡§∂‡•â‡§™ ‡§ï‡§æ ‡§®‡§æ‡§Æ ${AppState.user.shopName} (Shop ID: ${AppState.user.shopId}) ‡§π‡•à‡•§\n`;
        message += `‡§Æ‡•á‡§∞‡§æ ‡§à‡§Æ‡•á‡§≤: ${AppState.user.email}\n\n`;
        message += `‡§Æ‡•à‡§Ç ‡§Ö‡§™‡§®‡§æ Dukan Pro ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ${months} ‡§Æ‡§π‡•Ä‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∞‡§ø‡§®‡•ç‡§Ø‡•Ç ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡§æ ‡§π‡•Ç‡§Å‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç‡•§\n\n‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶‡•§`;
        
        const whatsappUrl = `https://wa.me/${adminPhone}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
    }
    
    // NEW: Barcode Scanning Functions
    function focusBarcodeScanner() {
        const scannerInput = document.getElementById('barcode-scanner-input');
        // Only focus if we are on the sales page
        if(AppState.currentView === 'sales') {
            scannerInput.focus();
        }
    }
    
       
    // NEW: Functions for New Sections
    async function fetchAndRenderClosingReports() {
    console.log("üöÄ fetchAndRenderClosingReports() ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•Å‡§Ü..."); // Log Start
    const tableBody = document.getElementById('daily-closing-table-body');
    if (!tableBody) {
         console.error("‚ùå ‡§è‡§∞‡§∞: daily-closing-table-body ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ!");
         return;
    }
    tableBody.innerHTML = `<tr><td colspan="5" class="text-center">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</td></tr>`;
    try {
        console.log("üì° API ‡§ï‡•â‡§≤ /api/closing/reports ‡§≠‡•á‡§ú‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...");
        const res = await fetchApi('/api/closing/reports', { method: 'GET' });
        console.log("üìÑ API ‡§∞‡§ø‡§∏‡•ç‡§™‡§æ‡§Ç‡§∏ ‡§Æ‡§ø‡§≤‡§æ:", res); // Log Response

        if (res.success && res.reports && res.reports.length > 0) {
             console.log(`üìä ${res.reports.length} ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏ ‡§Æ‡§ø‡§≤‡•Ä‡§Ç‡•§ HTML ‡§¨‡§®‡§æ ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å...`);
            tableBody.innerHTML = res.reports.map(r => `
                <tr>
                    <td>${new Date(r.closing_date).toLocaleDateString()}</td>
                    <td>${formatCurrency(r.total_sales)}</td>
                    <td>${formatCurrency(r.total_cogs)}</td>
                    <td>${formatCurrency(r.total_expenses)}</td>
                    <td class="fw-bold ${r.net_profit >= 0 ? 'text-success' : 'text-danger'}">
                        ${formatCurrency(r.net_profit)}
                    </td>
                </tr>
            `).join('');
             console.log("‚úÖ ‡§ü‡•á‡§¨‡§≤ HTML ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ‡•§");
        } else {
             console.log("‚ÑπÔ∏è ‡§ï‡•ã‡§à ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä ‡§Ø‡§æ API ‡§µ‡§ø‡§´‡§≤‡•§");
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">‡§ï‡•ã‡§à ‡§ï‡•ç‡§≤‡•ã‡§ú‡§ø‡§Ç‡§ó ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§</td></tr>`;
        }
    } catch (e) {
        console.error("‚ùå fetchAndRenderClosingReports ‡§è‡§∞‡§∞:", e); // Log Error
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}</td></tr>`;
    }
     console.log("üèÅ fetchAndRenderClosingReports() ‡§ñ‡§§‡•ç‡§Æ ‡§π‡•Å‡§Ü‡•§"); // Log End
}
    
    async function fetchAndRenderShopSettings() {
        try {
            // Fetch company profile (GST info) [cite: 349]
            const profileRes = await fetchApi('/api/shop/company-profile', { method: 'GET' });
            if (profileRes.success && profileRes.profile) {
                document.getElementById('company-legal-name').value = profileRes.profile.legal_name || '';
                document.getElementById('company-gstin').value = profileRes.profile.gstin || '';
                document.getElementById('company-address').value = profileRes.profile.address || '';
                // üöÄ FIX: ‡§™‡•Ç‡§Ç‡§ú‡•Ä ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§π ‡§≤‡§æ‡§á‡§® ‡§ú‡•ã‡§°‡§º‡•Ä
                document.getElementById('company-opening-capital').value = profileRes.profile.opening_capital || '0'; 
            }
            
            // Fetch display settings (from user object)
            document.getElementById('shop-display-name').value = AppState.user.shopName || '';
            const logoPreview = document.getElementById('shop-logo-preview');
            if (AppState.user.shopLogo) {
                logoPreview.src = AppState.user.shopLogo;
                logoPreview.style.display = 'block';
            } else {
                logoPreview.style.display = 'none';
            }
        } catch (e) {
            showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${e.message}`, 'danger');
        }
    }
    
    // NEW: Handle complex backup downloads
    async function handleBackupDownloads(type) {
        if (type === 'json') {
            try {
                const res = await fetchApi('/api/backup', { method: 'GET' }, 'JSON ‡§¨‡•à‡§ï‡§Ö‡§™ ‡§¨‡§®‡§æ‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...');
                if (res.success) {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(res.backupData, null, 2));
                    const dlAnchorElem = document.createElement('a');
                    dlAnchorElem.setAttribute("href", dataStr);
                    dlAnchorElem.setAttribute("download", `dukan_pro_backup_${AppState.user.shopId}_${getISODate()}.json`);
                    dlAnchorElem.click();
                } else {
                    showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', res.message, 'danger');
                }
            } catch (e) { showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', e.message, 'danger'); }
        
        } else if (type === 'excel') {
            try {
                const res = await fetchApi('/api/backup', { method: 'GET' }, 'Excel ‡§¨‡•à‡§ï‡§Ö‡§™ ‡§¨‡§®‡§æ‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...');
                if (res.success) {
                    const wb = XLSX.utils.book_new();
                    for (const tableName in res.backupData) {
                        const ws = XLSX.utils.json_to_sheet(res.backupData[tableName]);
                        XLSX.utils.book_append_sheet(wb, ws, tableName.slice(0, 31)); // Sheet name limit 31 chars
                    }
                    XLSX.writeFile(wb, `dukan_pro_backup_${AppState.user.shopId}_${getISODate()}.xlsx`);
                } else {
                    showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', res.message, 'danger');
                }
            } catch (e) { showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', e.message, 'danger'); }
            
        } else if (type === 'csv') {
            const startDate = document.getElementById('product-report-start-date').value;
            const endDate = document.getElementById('product-report-end-date').value;
            if (!startDate || !endDate) {
                return showMessage('‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ö‡•Å‡§®‡•á‡§Ç', "‡§ï‡•É‡§™‡§Ø‡§æ ‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä CSV ‡§ï‡•á ‡§≤‡§ø‡§è 'Reports' ‡§ü‡•à‡§¨ ‡§Æ‡•á‡§Ç ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§", 'warning');
            }
            // Use the dedicated server endpoint [cite: 331]
            const url = `${__backend_url}/api/reports/product-sales/download?startDate=${startDate}&endDate=${endDate}&token=${AppState.token}`;
            // Hacky way to download with token (GET request)
            window.open(url, '_blank');
        }
    }

// [ ‚úÖ Naya Helper Function yahaan (Line 2505) add karein ]

// [ ‚úÖ ‡§á‡§∏ ‡§™‡•Ç‡§∞‡•á ‡§™‡•Å‡§∞‡§æ‡§®‡•á ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã ‡§®‡§è ‡§µ‡§æ‡§≤‡•á ‡§∏‡•á ‡§¨‡§¶‡§≤‡•á‡§Ç ]

function formatAttributes(attrs) {
    if (!attrs || Object.keys(attrs).length === 0) return '';

    // üöÄ NAYA, ZYADA SMART "CHASHME WALA" CHECK
    // Ab hum _dist ya _near keys ko check karenge
    const hasDist = attrs.sph_od_dist || attrs.cyl_od_dist || attrs.sph_os_dist || attrs.cyl_os_dist;
    const hasNear = attrs.sph_od_near || attrs.cyl_od_near || attrs.sph_os_near || attrs.cyl_os_near;

    if (hasDist || hasNear) {
        let parts = [];
        
        // 1. Right Eye (OD) - DISTANCE
        if (attrs.sph_od_dist || attrs.cyl_od_dist || attrs.axs_od_dist) {
            parts.push(
                // "Right" (OD) ‡§ï‡§æ ‡§Æ‡§§‡§≤‡§¨ ‡§π‡•à "‡§¶‡§æ‡§à‡§Ç ‡§Ü‡§Å‡§ñ"
                `<strong>Right (Dist):</strong> ${attrs.sph_od_dist || '-'} / ${attrs.cyl_od_dist || '-'} / ${attrs.axs_od_dist || '-'}`
            );
        }
        
        // 2. Left Eye (OS) - DISTANCE
        if (attrs.sph_os_dist || attrs.cyl_os_dist || attrs.axs_os_dist) {
            parts.push(
                // "Left" (OS) ‡§ï‡§æ ‡§Æ‡§§‡§≤‡§¨ ‡§π‡•à "‡§¨‡§æ‡§à‡§Ç ‡§Ü‡§Å‡§ñ"
                `<strong>Left (Dist):</strong> ${attrs.sph_os_dist || '-'} / ${attrs.cyl_os_dist || '-'} / ${attrs.axs_os_dist || '-'}`
            );
        }

        // 3. Right Eye (OD) - NEAR
        if (attrs.sph_od_near || attrs.cyl_od_near || attrs.axs_od_near) {
            parts.push(
                `<strong>Right (Near):</strong> ${attrs.sph_od_near || '-'} / ${attrs.cyl_od_near || '-'} / ${attrs.axs_od_near || '-'}`
            );
        }

        // 4. Left Eye (OS) - NEAR
        if (attrs.sph_os_near || attrs.cyl_os_near || attrs.axs_os_near) {
            parts.push(
                `<strong>Left (Near):</strong> ${attrs.sph_os_near || '-'} / ${attrs.cyl_os_near || '-'} / ${attrs.axs_os_near || '-'}`
            );
        }

        return parts.join('<br>'); // Har entry ko nayi line par dikhao
    }

    // Purana fallback logic (Color/Size ke liye)
    let parts = [];
    for (const key in attrs) {
        if (attrs[key]) {
            parts.push(`<strong>${key}:</strong> ${attrs[key]}`);
        }
    }
    return parts.join('<br>');
}

    // ‡§Ö‡§™‡§®‡•á ‡§Ö‡§®‡•ç‡§Ø JavaScript ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®‡•ç‡§∏ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§á‡§∏‡•á ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
function removeShopLogo() {
    // 1. ‡§ó‡•ç‡§≤‡•ã‡§¨‡§≤ ‡§µ‡•á‡§∞‡§ø‡§è‡§¨‡§≤ ‡§ï‡•ã ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
    shopLogoBase64 = null; 
    // 2. HTML ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç
    document.getElementById('shop-logo-preview').src = '';
    document.getElementById('shop-logo-preview').style.display = 'none';
    document.getElementById('shop-logo-upload').value = null; // ‡§´‡§º‡§æ‡§á‡§≤ ‡§á‡§®‡§™‡•Å‡§ü ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç
    document.getElementById('remove-shop-logo-btn').classList.add('d-none');
    
    showMessage('‡§∏‡§æ‡§µ‡§ß‡§æ‡§®', '‡§≤‡•ã‡§ó‡•ã ‡§π‡§ü‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è "‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç" ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§', 'warning');
}
    
    // NEW: Setup listeners for all new forms and buttons
    function setupNewFormHandlers() {
    
    // ============================================================
    // 1. PRODUCT SALES REPORT BUTTON (REPORT LOGIC)
    // ============================================================
    const reportBtn = document.getElementById('fetch-product-sales-report-btn');
    if (reportBtn) {
        reportBtn.addEventListener('click', async () => {
            const startDate = document.getElementById('product-report-start-date').value;
            const endDate = document.getElementById('product-report-end-date').value;
            
            if (!startDate || !endDate) {
                return showMessage('‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ö‡•Å‡§®‡•á‡§Ç', '‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§', 'warning');
            }
            
            const tableBody = document.getElementById('product-sales-report-body');
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...</td></tr>`;
            
            try {
                const res = await fetchApi(`/api/reports/product-sales?startDate=${startDate}&endDate=${endDate}`, { method: 'GET' });
                if (res.success && res.report.length > 0) {
                    tableBody.innerHTML = res.report.map(r => `
                        <tr>
                            <td>${r.item_sku}</td>
                            <td>${r.item_name}</td>
                            <td>${r.total_quantity_sold}</td>
                            <td>${formatCurrency(r.total_revenue)}</td>
                            <td>${formatCurrency(r.total_cost)}</td>
                            <td class="fw-bold ${r.total_profit >= 0 ? 'text-success' : 'text-danger'}">
                                ${formatCurrency(r.total_profit)}
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">‡§á‡§∏ ‡§Ö‡§µ‡§ß‡§ø ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§</td></tr>`;
                }
            } catch (e) { 
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}</td></tr>`; 
            }
        });
    }

   

        // GST Report Buttons
        const gstResultEl = document.getElementById('gst-report-result');
        const gstTitleEl = document.getElementById('gst-report-title');
        
        // --- TALLY UPDATE START: GSTR-1 Button Logic ---
        document.getElementById('fetch-gstr1-report-btn').addEventListener('click', async () => {
            const startDate = document.getElementById('gst-report-start-date').value;
            const endDate = document.getElementById('gst-report-end-date').value;
            if (!startDate || !endDate) return showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', '‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§', 'warning');
            
            // ‡§®‡§è HTML ‡§ü‡•à‡§¨ ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü ‡§è‡§∞‡§ø‡§Ø‡§æ ‡§ï‡•ã ‡§ü‡§æ‡§∞‡§ó‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
            const gstr1ContentEl = document.getElementById('gstr1-report-content');
            const mainGstTitleEl = document.getElementById('gst-report-title'); // ‡§Ø‡§π ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§ü‡§æ‡§á‡§ü‡§≤ ‡§π‡•à, ‡§á‡§∏‡•á ‡§õ‡§ø‡§™‡§æ ‡§≠‡•Ä ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç
            
            if(mainGstTitleEl) mainGstTitleEl.innerText = "GSTR-1 (‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä) ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...)";
            gstr1ContentEl.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

            // GSTR-1 ‡§ü‡•à‡§¨ ‡§ï‡•ã ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§∞‡•á‡§Ç
            new bootstrap.Tab(document.getElementById('gst-gstr1-tab')).show();

            try {
                const res = await fetchApi(`/api/reports/gstr1?startDate=${startDate}&endDate=${endDate}`, { method: 'GET' });
                if (!res.success) throw new Error(res.message || 'GSTR-1 ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§≤‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§');
                
                if(mainGstTitleEl) mainGstTitleEl.innerText = `GSTR-1 (‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä) ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (${startDate} ‡§∏‡•á ${endDate})`;
                const report = res.report;
                
                // 1. Tally-Style HTML Template ‡§ï‡•ã ‡§ï‡•ç‡§≤‡•ã‡§® ‡§ï‡§∞‡•á‡§Ç
                const template = document.getElementById('gstr1-report-template');
                gstr1ContentEl.innerHTML = template.innerHTML; // ‡§ü‡•á‡§Æ‡•ç‡§™‡§≤‡•á‡§ü ‡§ï‡•ã ‡§∞‡§ø‡§ú‡§≤‡•ç‡§ü ‡§è‡§∞‡§ø‡§Ø‡§æ ‡§Æ‡•á‡§Ç ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç

                // 2. B2B ‡§ü‡•á‡§¨‡§≤ ‡§≠‡§∞‡•á‡§Ç
                const b2bTableBody = document.getElementById('gstr1-b2b-table').querySelector('tbody');
                const b2bTableFoot = document.getElementById('gstr1-b2b-table').querySelector('tfoot');
                let b2bTotalTaxable = 0, b2bTotalIgst = 0, b2bTotalCgst = 0, b2bTotalSgst = 0;
                b2bTableBody.innerHTML = ''; // ‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§™‡§Ç‡§ï‡•ç‡§§‡§ø‡§Ø‡§æ‡§Å ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç
                
                if (report.b2b && report.b2b.length > 0) {
                    report.b2b.forEach(item => {
                        const taxable = parseFloat(item.total_taxable_value) || 0;
                        const igst = parseFloat(item.total_igst) || 0;
                        const cgst = parseFloat(item.total_cgst) || 0;
                        const sgst = parseFloat(item.total_sgst) || 0;
                        b2bTotalTaxable += taxable;
                        b2bTotalIgst += igst;
                        b2bTotalCgst += cgst;
                        b2bTotalSgst += sgst;
                        
                        b2bTableBody.innerHTML += `
                            <tr>
                                <td class="text-left">${item.customer_gstin}</td>
                                <td class="text-left">${item.customer_name || 'N/A'}</td>
                                <td class="text-center">${item.invoice_number}</td>
                                <td class="text-center">${new Date(item.invoice_date).toLocaleDateString()}</td>
                                <td>${formatCurrency(taxable)}</td>
                                <td>${formatCurrency(igst)}</td>
                                <td>${formatCurrency(cgst)}</td>
                                <td>${formatCurrency(sgst)}</td>
                            </tr>
                        `;
                    });
                } else {
                    b2bTableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">‡§á‡§∏ ‡§Ö‡§µ‡§ß‡§ø ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à B2B (GSTIN ‡§µ‡§æ‡§≤‡•Ä) ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§</td></tr>';
                }
                b2bTableFoot.innerHTML = `<tr><td colspan="4" class="text-left">B2B ‡§ï‡•Å‡§≤</td><td>${formatCurrency(b2bTotalTaxable)}</td><td>${formatCurrency(b2bTotalIgst)}</td><td>${formatCurrency(b2bTotalCgst)}</td><td>${formatCurrency(b2bTotalSgst)}</td></tr>`;

                // 3. B2C ‡§ü‡•á‡§¨‡§≤ ‡§≠‡§∞‡•á‡§Ç
                const b2cTableBody = document.getElementById('gstr1-b2c-table').querySelector('tbody');
                const b2cTableFoot = document.getElementById('gstr1-b2c-table').querySelector('tfoot');
                let b2cTotalTaxable = 0, b2cTotalIgst = 0, b2cTotalCgst = 0, b2cTotalSgst = 0, b2cTotalTax = 0;
                b2cTableBody.innerHTML = ''; // ‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§™‡§Ç‡§ï‡•ç‡§§‡§ø‡§Ø‡§æ‡§Å ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç
                
                if (report.b2c && report.b2c.length > 0) {
                    report.b2c.forEach(item => {
                        const taxable = parseFloat(item.taxable_value) || 0;
                        const igst = parseFloat(item.total_igst) || 0;
                        const cgst = parseFloat(item.total_cgst) || 0;
                        const sgst = parseFloat(item.total_sgst) || 0;
                        const tax = parseFloat(item.total_tax) || 0;
                        b2cTotalTaxable += taxable;
                        b2cTotalIgst += igst;
                        b2cTotalCgst += cgst;
                        b2cTotalSgst += sgst;
                        b2cTotalTax += tax;

                        b2cTableBody.innerHTML += `
                            <tr>
                                <td class="text-left">${item.place_of_supply || 'N/A'}</td>
                                <td class="text-center">${item.gst_rate}%</td>
                                <td>${formatCurrency(taxable)}</td>
                                <td>${formatCurrency(igst)}</td>
                                <td>${formatCurrency(cgst)}</td>
                                <td>${formatCurrency(sgst)}</td>
                                <td>${formatCurrency(tax)}</td>
                            </tr>
                        `;
                    });
                } else {
                    b2cTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">‡§á‡§∏ ‡§Ö‡§µ‡§ß‡§ø ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à B2C (‡§õ‡•ã‡§ü‡•Ä) ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§</td></tr>';
                }
                b2cTableFoot.innerHTML = `<tr><td colspan="2" class="text-left">B2C ‡§ï‡•Å‡§≤</td><td>${formatCurrency(b2cTotalTaxable)}</td><td>${formatCurrency(b2cTotalIgst)}</td><td>${formatCurrency(b2cTotalCgst)}</td><td>${formatCurrency(b2cTotalSgst)}</td><td>${formatCurrency(b2cTotalTax)}</td></tr>`;

                // 4. HSN ‡§ü‡•á‡§¨‡§≤ ‡§≠‡§∞‡•á‡§Ç
                const hsnTableBody = document.getElementById('gstr1-hsn-table').querySelector('tbody');
                const hsnTableFoot = document.getElementById('gstr1-hsn-table').querySelector('tfoot'); // tfoot ‡§≠‡•Ä ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
                let hsnTotalQty = 0, hsnTotalTaxable = 0, hsnTotalIgst = 0, hsnTotalCgst = 0, hsnTotalSgst = 0, hsnTotalTax = 0;
                hsnTableBody.innerHTML = ''; // ‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§™‡§Ç‡§ï‡•ç‡§§‡§ø‡§Ø‡§æ‡§Å ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç
                
                if (report.hsn_summary && report.hsn_summary.length > 0) {
                    report.hsn_summary.forEach(item => {
                        const qty = parseFloat(item.total_quantity) || 0;
                        const taxable = parseFloat(item.total_taxable_value) || 0;
                        const igst = parseFloat(item.total_igst) || 0;
                        const cgst = parseFloat(item.total_cgst) || 0;
                        const sgst = parseFloat(item.total_sgst) || 0;
                        const tax = parseFloat(item.total_tax) || 0;
                        
                        hsnTotalQty += qty;
                        hsnTotalTaxable += taxable;
                        hsnTotalIgst += igst;
                        hsnTotalCgst += cgst;
                        hsnTotalSgst += sgst;
                        hsnTotalTax += tax;
                        
                        hsnTableBody.innerHTML += `
                            <tr>
                                <td class="text-center">${item.hsn_code || 'N/A'}</td>
                                <td class="text-left">${item.item_name}</td>
                                <td class="text-center">${item.unit || 'Pcs'}</td>
                                <td class="text-center">${qty}</td>
                                <td>${formatCurrency(taxable)}</td>
                                <td>${formatCurrency(igst)}</td>
                                <td>${formatCurrency(cgst)}</td>
                                <td>${formatCurrency(sgst)}</td>
                                <td>${formatCurrency(tax)}</td>
                            </tr>
                        `;
                    });
                } else {
                    hsnTableBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">‡§á‡§∏ ‡§Ö‡§µ‡§ß‡§ø ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à HSN ‡§∏‡§Æ‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§</td></tr>';
                }
                // HSN Total Foot
                if (hsnTableFoot) {
                    hsnTableFoot.innerHTML = `<tr><td colspan="3" class="text-left">HSN ‡§ï‡•Å‡§≤</td><td class="text-center">${hsnTotalQty}</td><td>${formatCurrency(hsnTotalTaxable)}</td><td>${formatCurrency(hsnTotalIgst)}</td><td>${formatCurrency(hsnTotalCgst)}</td><td>${formatCurrency(hsnTotalSgst)}</td><td>${formatCurrency(hsnTotalTax)}</td></tr>`;
                }


                // 5. Tabs ‡§ï‡•ã ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§∞‡•á‡§Ç (‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø ‡§π‡§Æ‡§®‡•á HTML ‡§ï‡•ã ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§≤‡§ø‡§ñ‡§æ ‡§π‡•à)
                var triggerTabList = [].slice.call(document.querySelectorAll('#gstr1-inner-tab button'));
                triggerTabList.forEach(function (triggerEl) {
                    var tabTrigger = new bootstrap.Tab(triggerEl);
                    triggerEl.addEventListener('click', function (event) {
                        event.preventDefault();
                        tabTrigger.show();
                    });
                });
                // ‡§™‡§π‡§≤‡•á ‡§ü‡•à‡§¨ (B2B) ‡§ï‡•ã ‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
                new bootstrap.Tab(document.getElementById('gstr1-b2b-tab')).show();


            } catch (e) { 
                if(mainGstTitleEl) mainGstTitleEl.innerText = "GSTR-1 ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü";
                gstr1ContentEl.innerHTML = `<div class="text-danger p-4">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}</div>`;
            }
        });
        // --- TALLY UPDATE END: GSTR-1 Button Logic ---
        
        
        // --- TALLY UPDATE START: GSTR-2 Button Logic ---
        document.getElementById('fetch-gstr2-report-btn').addEventListener('click', async () => {
            const startDate = document.getElementById('gst-report-start-date').value;
            const endDate = document.getElementById('gst-report-end-date').value;
            if (!startDate || !endDate) return showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', '‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§', 'warning');
            
            const gstr2ContentEl = document.getElementById('gstr2-report-content');
            const mainGstTitleEl = document.getElementById('gst-report-title'); // ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§ü‡§æ‡§á‡§ü‡§≤
            
            if(mainGstTitleEl) mainGstTitleEl.innerText = "GSTR-2 (‡§ñ‡§∞‡•Ä‡§¶) ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...)";
            gstr2ContentEl.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-warning" role="status"><span class="visually-hidden">Loading...</span></div></div>';

            // GSTR-2 ‡§ü‡•à‡§¨ ‡§ï‡•ã ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§∞‡•á‡§Ç
            new bootstrap.Tab(document.getElementById('gst-gstr2-tab')).show();

            try {
                const res = await fetchApi(`/api/reports/gstr2?startDate=${startDate}&endDate=${endDate}`, { method: 'GET' });
                if (!res.success) throw new Error(res.message || 'GSTR-2 ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§≤‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§');
                
                if(mainGstTitleEl) mainGstTitleEl.innerText = `GSTR-2 (‡§ñ‡§∞‡•Ä‡§¶) ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (${startDate} ‡§∏‡•á ${endDate})`;
                const report = res.report;
                let tableHtml = '';

                // B2B Purchases Table
                tableHtml += '<h6>B2B (‡§™‡§Ç‡§ú‡•Ä‡§ï‡•É‡§§ ‡§∏‡§™‡•ç‡§≤‡§æ‡§Ø‡§∞ ‡§∏‡•á ‡§ñ‡§∞‡•Ä‡§¶)</h6>';
                if (report.b2b_purchases && report.b2b_purchases.length > 0) {
                    tableHtml += '<table class="table gst-report-table"><thead><tr><th class="text-left">‡§∏‡§™‡•ç‡§≤‡§æ‡§Ø‡§∞</th><th>‡§¨‡§ø‡§≤ ‡§®‡§Ç.</th><th>‡§§‡§æ‡§∞‡•Ä‡§ñ</th><th>‡§ü‡•à‡§ï‡•ç‡§∏‡•á‡§¨‡§≤ ‡§µ‡•à‡§≤‡•ç‡§Ø‡•Ç (‚Çπ)</th><th>IGST (‚Çπ)</th><th>CGST (‚Çπ)</th><th>SGST (‚Çπ)</th></tr></thead><tbody>';
                    report.b2b_purchases.forEach(item => {
                        const details = item.gst_details || {}; // Get the JSONB data
                        tableHtml += `
                            <tr>
                                <td class="text-left">${item.supplier_name}</td>
                                <td class="text-center">${details.invoice_number || item.id}</td>
                                <td class="text-center">${new Date(item.created_at).toLocaleDateString()}</td>
                                <td>${formatCurrency(details.taxable_value)}</td>
                                <td>${formatCurrency(details.igst)}</td>
                                <td>${formatCurrency(details.cgst)}</td>
                                <td>${formatCurrency(details.sgst)}</td>
                            </tr>
                        `;
                    });
                    tableHtml += '</tbody></table>';
                } else {
                    tableHtml += '<p class="text-muted">‡§á‡§∏ ‡§Ö‡§µ‡§ß‡§ø ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à GST ‡§µ‡§æ‡§≤‡•Ä ‡§ñ‡§∞‡•Ä‡§¶ ‡§¶‡§∞‡•ç‡§ú ‡§®‡§π‡•Ä‡§Ç ‡§ï‡•Ä ‡§ó‡§à‡•§ (‡§ï‡•É‡§™‡§Ø‡§æ \'‡§ñ‡§∞‡•Ä‡§¶\' ‡§∏‡•á‡§ï‡•ç‡§∂‡§® ‡§Æ‡•á‡§Ç GST Details ‡§ú‡•ã‡§°‡§º‡•á‡§Ç)</p>';
                }

                // ITC Summary Table
                tableHtml += '<h6 class="mt-4">‡§á‡§®‡§™‡•Å‡§ü ‡§ü‡•à‡§ï‡•ç‡§∏ ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü (ITC) ‡§∏‡§Æ‡§∞‡•Ä</h6>';
                const itc = report.itc_summary || {};
                const totalTaxable = parseFloat(itc.total_taxable_value) || 0;
                const totalIgst = parseFloat(itc.total_igst) || 0;
                const totalCgst = parseFloat(itc.total_cgst) || 0;
                const totalSgst = parseFloat(itc.total_sgst) || 0;
                
                tableHtml += '<table class="table gst-report-table"><thead><tr><th class="text-left">‡§µ‡§ø‡§µ‡§∞‡§£</th><th>‡§ü‡•à‡§ï‡•ç‡§∏‡•á‡§¨‡§≤ ‡§µ‡•à‡§≤‡•ç‡§Ø‡•Ç (‚Çπ)</th><th>IGST (‚Çπ)</th><th>CGST (‚Çπ)</th><th>SGST (‚Çπ)</th></tr></thead><tbody>';
                tableHtml += `
                    <tr class="subtotal-row">
                        <td class="text-left">‡§ï‡•Å‡§≤ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ITC</td>
                        <td>${formatCurrency(totalTaxable)}</td>
                        <td>${formatCurrency(totalIgst)}</td>
                        <td>${formatCurrency(totalCgst)}</td>
                        <td>${formatCurrency(totalSgst)}</td>
                    </tr>
                `;
                tableHtml += '</tbody></table>';
                
                gstr2ContentEl.innerHTML = tableHtml;

            } catch (e) {
                if(mainGstTitleEl) mainGstTitleEl.innerText = "GSTR-2 ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü";
                gstr2ContentEl.innerHTML = `<div class="text-danger p-4">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}</div>`;
            }
        });
        // --- TALLY UPDATE END: GSTR-2 Button Logic ---


        // --- TALLY UPDATE START: GSTR-3B Button Logic ---
        document.getElementById('fetch-gstr3b-report-btn').addEventListener('click', async () => {
            const startDate = document.getElementById('gst-report-start-date').value;
            const endDate = document.getElementById('gst-report-end-date').value;
            if (!startDate || !endDate) return showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', '‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§', 'warning');

            const gstr3bContentEl = document.getElementById('gstr3b-report-content');
            const mainGstTitleEl = document.getElementById('gst-report-title'); // ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§ü‡§æ‡§á‡§ü‡§≤
            
            if(mainGstTitleEl) mainGstTitleEl.innerText = "GSTR-3B (‡§∏‡§Æ‡§∞‡•Ä) ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...)";
            gstr3bContentEl.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

            // GSTR-3B ‡§ü‡•à‡§¨ ‡§ï‡•ã ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§∞‡•á‡§Ç
            new bootstrap.Tab(document.getElementById('gst-gstr3b-tab')).show();

            try {
                const res = await fetchApi(`/api/reports/gstr3b?startDate=${startDate}&endDate=${endDate}`, { method: 'GET' });
                if (!res.success) throw new Error(res.message || 'GSTR-3B ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§≤‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§');
                
                if(mainGstTitleEl) mainGstTitleEl.innerText = `GSTR-3B (‡§∏‡§Æ‡§∞‡•Ä) ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (${startDate} ‡§∏‡•á ${endDate})`;
                const report = res.report;
                let tableHtml = '';

                // Table 3.1: Outward Supplies (Sales)
                tableHtml += '<h6>3.1: ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§î‡§∞ ‡§ü‡•à‡§ï‡•ç‡§∏ (Outward Supplies)</h6>';
                tableHtml += '<table class="table gst-report-table"><thead><tr><th class="text-left">‡§µ‡§ø‡§µ‡§∞‡§£</th><th>‡§ü‡•à‡§ï‡•ç‡§∏‡•á‡§¨‡§≤ ‡§µ‡•à‡§≤‡•ç‡§Ø‡•Ç (‚Çπ)</th><th>IGST (‚Çπ)</th><th>CGST (‚Çπ)</th><th>SGST (‚Çπ)</th></tr></thead><tbody>';
                tableHtml += `
                    <tr class="subtotal-row">
                        <td class="text-left">(a) ‡§ü‡•à‡§ï‡•ç‡§∏‡•á‡§¨‡§≤ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä</td>
                        <td>${formatCurrency(report.outward_supplies.taxable_value)}</td>
                        <td>${formatCurrency(report.outward_supplies.igst)}</td>
                        <td>${formatCurrency(report.outward_supplies.cgst)}</td>
                        <td>${formatCurrency(report.outward_supplies.sgst)}</td>
                    </tr>
                `;
                tableHtml += '</tbody></table>';

                // Table 4: Eligible ITC (Purchases)
                tableHtml += '<h6 class="mt-4">4: ‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§á‡§®‡§™‡•Å‡§ü ‡§ü‡•à‡§ï‡•ç‡§∏ ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü (ITC)</h6>';
                tableHtml += '<table class="table gst-report-table"><thead><tr><th class="text-left">‡§µ‡§ø‡§µ‡§∞‡§£</th><th>IGST (‚Çπ)</th><th>CGST (‚Çπ)</th><th>SGST (‚Çπ)</th></tr></thead><tbody>';
                tableHtml += `
                    <tr>
                        <td class="text-left">(A) (5) ‡§∏‡§≠‡•Ä ‡§Ö‡§®‡•ç‡§Ø ITC (B2B ‡§ñ‡§∞‡•Ä‡§¶)</td>
                        <td>${formatCurrency(report.inward_supplies_itc.igst)}</td>
                        <td>${formatCurrency(report.inward_supplies_itc.cgst)}</td>
                        <td>${formatCurrency(report.inward_supplies_itc.sgst)}</td>
                    </tr>
                    <tr class="subtotal-row">
                        <td class="text-left">(D) ‡§ï‡•Å‡§≤ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ITC (A)</td>
                        <td>${formatCurrency(report.inward_supplies_itc.igst)}</td>
                        <td>${formatCurrency(report.inward_supplies_itc.cgst)}</td>
                        <td>${formatCurrency(report.inward_supplies_itc.sgst)}</td>
                    </tr>
                `;
                tableHtml += '</tbody></table>';

                // Table 6.1: Payment of Tax (Net Tax)
                tableHtml += '<h6 class="mt-4">6.1: ‡§ü‡•à‡§ï‡•ç‡§∏ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® (Net Tax Payable)</h6>';
                tableHtml += '<table class="table gst-report-table"><thead><tr><th class="text-left">‡§µ‡§ø‡§µ‡§∞‡§£</th><th>IGST (‚Çπ)</th><th>CGST (‚Çπ)</th><th>SGST (‚Çπ)</th><th>‡§ï‡•Å‡§≤ ‡§¶‡•á‡§Ø ‡§ü‡•à‡§ï‡•ç‡§∏ (‚Çπ)</th></tr></thead><tbody>';
                tableHtml += `
                    <tr class="subtotal-row">
                        <td class="text-left">‡§ï‡•Å‡§≤ ‡§¶‡•á‡§Ø ‡§ü‡•à‡§ï‡•ç‡§∏ (‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä - ‡§ñ‡§∞‡•Ä‡§¶)</td>
                        <td>${formatCurrency(report.net_tax_payable.igst)}</td>
                        <td>${formatCurrency(report.net_tax_payable.cgst)}</td>
                        <td>${formatCurrency(report.net_tax_payable.sgst)}</td>
                        <td>${formatCurrency(report.net_tax_payable.total)}</td>
                    </tr>
                `;
                tableHtml += '</tbody></table>';

                gstr3bContentEl.innerHTML = tableHtml;

            } catch (e) {
                if(mainGstTitleEl) mainGstTitleEl.innerText = "GSTR-3B ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü";
                gstr3bContentEl.innerHTML = `<div class="text-danger p-4">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}</div>`;
            }
        });
        // --- TALLY UPDATE END: GSTR-3B Button Logic ---

        
        // Daily Closing Button
        document.getElementById('run-daily-closing-btn').addEventListener('click', async () => {
            if (!confirm('‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§Ü‡§ú ‡§ï‡•Ä ‡§ï‡•ç‡§≤‡•ã‡§ú‡§ø‡§Ç‡§ó ‡§∞‡§® ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§Ø‡§π ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§è‡§ï ‡§¨‡§æ‡§∞ ‡§π‡•Ä ‡§ï‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡•§')) return;
            const msgEl = document.getElementById('closing-message');
            msgEl.className = 'mt-3 alert alert-info';
            msgEl.innerText = '‡§ï‡•ç‡§≤‡•ã‡§ú‡§ø‡§Ç‡§ó ‡§∞‡§® ‡§ï‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à...';
            try {
                const res = await fetchApi('/api/closing/run', { method: 'POST' });
                if (res.success) {
                    msgEl.className = 'mt-3 alert alert-success';
                    msgEl.innerText = res.message;
                    fetchAndRenderClosingReports(); // Refresh the list
                } else {
                    throw new Error(res.message);
                }
            } catch (e) {
                msgEl.className = 'mt-3 alert alert-danger';
                msgEl.innerText = `‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}`;
            }
        });
        
        // Backup Buttons
        document.getElementById('download-json-backup-btn').addEventListener('click', () => handleBackupDownloads('json'));
        document.getElementById('download-excel-backup-btn').addEventListener('click', () => handleBackupDownloads('excel'));
        document.getElementById('download-product-sales-csv-btn').addEventListener('click', () => handleBackupDownloads('csv'));
        // [ ‚úÖ Is Naye Code ko Line 2915 par Paste Karein ]



// Naya "Manual Entry" Button Listener (Point 3 & 5)
document.getElementById('manual-add-item-btn').addEventListener('click', async () => {
    try {
        // 1. Server se agla available SKU laayein (Kadam 1 ka API)
        showLoader('‡§Ö‡§ó‡§≤‡§æ SKU ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...');
        const res = await fetchApi('/api/stock/next-sku', { method: 'GET' }, null);
        hideLoader();

        if (!res.success) {
            throw new Error(res.message || 'Server se SKU nahi mila');
        }

        // 2. Naya Modal (Kadam 2 waala) kholein
        const modalElement = document.getElementById('quickAddItemModal');
        const quickAddModal = new bootstrap.Modal(modalElement);

        // 3. Modal ke form ko reset karein
        document.getElementById('quick-add-item-form').reset();

        // 4. SKU ko automatic bhar dein
        document.getElementById('quick-add-sku').value = res.nextSku;

        // 5. Modal dikhayein
        quickAddModal.show();

        // 6. Focus "Item Name" par karein
        modalElement.addEventListener('shown.bs.modal', () => {
            document.getElementById('quick-add-name').focus();
        }, { once: true });

    } catch (e) {
        hideLoader();
        showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§Ö‡§ó‡§≤‡§æ SKU ‡§≤‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${e.message}`, 'danger');
    }
});
        
// [ ‚úÖ Is Naye Code ko pichhle code ke baad (Line ~2945) Paste Karein ]

// Naya "Quick Add Modal" Save Button Listener (Point 4)
document.getElementById('quick-add-save-btn').addEventListener('click', async () => {
    const btn = document.getElementById('quick-add-save-btn');
    const originalBtnText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ‡§∏‡•á‡§µ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...`;

    // 1. Modal se data nikalein
    const itemData = {
        sku: document.getElementById('quick-add-sku').value,
        name: document.getElementById('quick-add-name').value,
        sale_price: document.getElementById('quick-add-sale-price').value,
        purchase_price: document.getElementById('quick-add-purchase-price').value,
        quantity: 1, // Quick Add hamesha 1 quantity add karta hai
        unit: 'Pcs'  // Default unit
    };


    // 2. Jaanch karein ki data bhara hai ya nahi
    if (!itemData.sku || !itemData.name || !itemData.sale_price || !itemData.purchase_price) {
        showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', '‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§≠‡•Ä ‡§´‡§º‡•Ä‡§≤‡•ç‡§° (SKU, ‡§®‡§æ‡§Æ, ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§Æ‡•Ç‡§≤‡•ç‡§Ø, ‡§ñ‡§∞‡•Ä‡§¶ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø) ‡§≠‡§∞‡•á‡§Ç‡•§', 'danger');
        btn.disabled = false;
        btn.innerHTML = originalBtnText;
        return;
    }

    try {
        // 3. "Stock Prabandhan" mein item save karein (Server API Call)
        // Yeh wahi API hai jo aapka 'Stock Management' page istemaal karta hai
        console.log('FINAL ITEM DATA SENT TO SERVER:', itemData);
        console.log('SENDING TO SERVER ‚Üí', JSON.stringify(itemData, null, 2));
        console.log('üöÄ FINAL PAYLOAD TO SERVER üëâ', JSON.stringify(itemData, null, 2));
        const res = await fetchApi('/api/stock', {
            method: 'POST',
            body: itemData
        }, '‡§®‡§Ø‡§æ ‡§Ü‡§á‡§ü‡§Æ ‡§∏‡•á‡§µ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...');

        if (!res.success) {
            // Agar server ne error diya (jaise SKU pehle se hai)
            throw new Error(res.message);
        }

        // 4. "Bikri (POS) Cart" mein item add karein
        // Hum server se mile data ka istemaal karenge
        const newItemForCart = {
    sku: res.stock.sku,
    name: res.stock.name,
    sale_price: parseFloat(res.stock.sale_price),
    purchase_price: parseFloat(res.stock.purchase_price || 0),
    gst: parseFloat(res.stock.gst || 0),
    quantity: 1,

    // üîê VERY IMPORTANT: Anti-Theft data POS ‡§§‡§ï ‡§™‡§π‡•Å‡§Ç‡§ö‡•á
    product_attributes: res.stock.product_attributes || {}
};


        // 'currentStock' list ko bhi update karein (taaki quantity check kaam kare)
        currentStock.push(res.stock);

        // 'posCart' array mein add karein
        posCart.push(newItemForCart);
        updatePOSCartView(); // POS Cart table ko refresh karein

        // 5. Modal band karein
        const quickAddModal = bootstrap.Modal.getInstance(document.getElementById('quickAddItemModal'));
        quickAddModal.hide();

        showMessage('‡§∏‡§´‡§≤‡§§‡§æ', `${itemData.name} ‡§ï‡•ã ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ ‡§î‡§∞ ‡§ï‡§æ‡§∞‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§`, 'success');

    } catch (e) {
        showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§Ü‡§á‡§ü‡§Æ ‡§∏‡•á‡§µ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${e.message}`, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalBtnText;
    }
});


        // Shop Settings Forms
        document.getElementById('company-profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                legal_name: document.getElementById('company-legal-name').value,
                gstin: document.getElementById('company-gstin').value,
                address: document.getElementById('company-address').value,
                // üöÄ FIX: ‡§™‡•Ç‡§Ç‡§ú‡•Ä ‡§°‡•á‡§ü‡§æ ‡§Ø‡§π‡§æ‡§Å ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ
                opening_capital: document.getElementById('company-opening-capital').value 
            };
            try {
                const res = await fetchApi('/api/shop/company-profile', { method: 'POST', body: data });
                showMessage('‡§∏‡§´‡§≤‡§§‡§æ', res.message, 'success');
            } catch (err) { showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', err.message, 'danger'); }
        });
        
        let shopLogoBase64 = null; // Store logo data
        document.getElementById('shop-logo-upload').addEventListener('change', (e) => {
             const file = e.target.files[0];
             if (!file) return;
             const reader = new FileReader();
             reader.onload = (event) => {
                 shopLogoBase64 = event.target.result;
                 document.getElementById('shop-logo-preview').src = shopLogoBase64;
                 document.getElementById('shop-logo-preview').style.display = 'block';
                 document.getElementById('remove-shop-logo-btn').classList.remove('d-none');
             };
             reader.readAsDataURL(file);
        });
        
       // ... (‡§¨‡§æ‡§ï‡•Ä ‡§ï‡•ã‡§°)
  // ... (‡§≤‡§æ‡§á‡§® 2244 ‡§ï‡•á ‡§Ü‡§∏‡§™‡§æ‡§∏)

  document.getElementById('shop-display-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            shop_name: document.getElementById('shop-display-name').value,
            shop_logo: shopLogoBase64 || AppState.user.shopLogo // Send new logo or old one
        };
        try {
            const res = await fetchApi('/api/shop/settings', { method: 'POST', body: data });
            if (res.success) {
                // CRITICAL: Update token and user data with new shop name/logo
                saveAuthData(res.token, res.user);
                
                // üöÄ FIX: ‡§á‡§Æ‡•á‡§ú ‡§ï‡•ã Local Storage ‡§Æ‡•á‡§Ç ‡§≠‡•Ä ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç (‡§∏‡§´‡§≤‡§§‡§æ ‡§™‡§∞)
                if (res.user.shopLogo) {
                    localStorage.setItem('shopLogoData', res.user.shopLogo);
                } else {
                    localStorage.removeItem('shopLogoData');
                }
                
                showMessage('‡§∏‡§´‡§≤‡§§‡§æ', res.message, 'success');
            } else {
                // üöÄ FIX: ‡§Ø‡§¶‡§ø ‡§∏‡§∞‡•ç‡§µ‡§∞ 500 ‡§è‡§∞‡§∞ ‡§¶‡•á, ‡§§‡•ã ‡§≠‡•Ä ‡§≤‡•ã‡§ï‡§≤ ‡§∏‡•ç‡§ü‡•ã‡§∞‡•á‡§ú ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç (FallBack)
                if (shopLogoBase64) {
                     localStorage.setItem('shopLogoData', shopLogoBase64);
                     // Note: We don't call saveAuthData because the server update failed
                     showMessage('‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä', '‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§ü‡§æ‡§á‡§Æ‡§Ü‡§â‡§ü ‡§π‡•Å‡§Ü‡•§ ‡§≤‡•ã‡§ó‡•ã ‡§≤‡•ã‡§ï‡§≤ (Local) ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à, ‡§≤‡•á‡§ï‡§ø‡§® ‡§Ö‡§®‡•ç‡§Ø ‡§Ø‡•Ç‡§ú‡§º‡§∞‡•ç‡§∏ ‡§ï‡•ã ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§π ‡§Ö‡§≠‡•Ä ‡§≠‡•Ä ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à‡•§', 'warning');
                } else {
                    throw new Error(res.message);
                }
            }
        } catch (err) { 
             // ‡§Ø‡§¶‡§ø Fetch API ‡§π‡•Ä ‡§µ‡§ø‡§´‡§≤ ‡§π‡•ã ‡§ú‡§æ‡§§‡§æ ‡§π‡•à
             showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', err.message, 'danger');
        }
    });

// ... (‡§¨‡§æ‡§ï‡•Ä ‡§ï‡•ã‡§°)

// Staff Form Listeners
const addStaffForm = document.getElementById('add-staff-form');
        if (addStaffForm && !addStaffForm.dataset.initialized) {
            addStaffForm.dataset.initialized = 'true';
            addStaffForm.addEventListener('submit', handleAddStaff);
        }
        const editStaffForm = document.getElementById('edit-staff-form');
         if (editStaffForm && !editStaffForm.dataset.initialized) {
            editStaffForm.dataset.initialized = 'true';
            editStaffForm.addEventListener('submit', handleUpdateStaff);
        }

    }

// [ ‚úÖ Is Naye Listener ko Line 2912 par (function ke andar) Paste Karein ]

// [ ‚úÖ NAYA "Naya Field Jodein" ‡§¨‡§ü‡§® ‡§ï‡§æ ‡§≤‡•â‡§ú‡§ø‡§ï (Optical ‡§´‡•â‡§∞‡•ç‡§Æ ‡§¶‡§ø‡§ñ‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è) ]

document.getElementById('add-custom-field-btn').addEventListener('click', () => {
    // 1. ‡§õ‡§ø‡§™‡•á ‡§π‡•Å‡§è ‡§ö‡§∂‡•ç‡§Æ‡•á ‡§µ‡§æ‡§≤‡•á ‡§´‡•â‡§∞‡•ç‡§Æ ‡§ï‡•ã ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
    const container = document.getElementById('prescription-fields-container');
    container.style.display = 'block';
    
    // 2. "+ Naya Field Jodein" ‡§¨‡§ü‡§® ‡§ï‡•ã ‡§õ‡§ø‡§™‡§æ ‡§¶‡•á‡§Ç (‡§§‡§æ‡§ï‡§ø ‡§¶‡•ã‡§¨‡§æ‡§∞‡§æ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§® ‡§π‡•ã)
    document.getElementById('add-custom-field-btn').style.display = 'none';
});

// removeCustomField ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•Ä ‡§Ö‡§¨ ‡§ú‡§º‡§∞‡•Ç‡§∞‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§á‡§∏‡§≤‡§ø‡§è ‡§â‡§∏‡•á ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§


 // ============================================================
    // üöÄ 2. FIX: ‡§≤‡§æ‡§≤ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® (Paint Modal) ‡§µ‡§æ‡§≤‡§æ ‡§ï‡•ã‡§° - ‡§Ö‡§¨ ‡§Ø‡§π ‡§¨‡§æ‡§π‡§∞ ‡§π‡•à
    // ============================================================
    const paintModalElement = document.getElementById('paintMixingModal');
    if (paintModalElement) {
        // ‡§Ø‡§π ‡§≤‡§ø‡§∏‡•ç‡§®‡§∞ ‡§Ö‡§¨ ‡§™‡•á‡§ú ‡§≤‡•ã‡§° ‡§π‡•ã‡§§‡•á ‡§π‡•Ä ‡§∏‡•á‡§ü ‡§π‡•ã ‡§ú‡§æ‡§è‡§ó‡§æ
        paintModalElement.addEventListener('hidden.bs.modal', function () {
            console.log("Paint Modal Closed. Resetting Mixing Mode.");
            
            // ‚úÖ ‡§´‡•ç‡§≤‡•à‡§ó ‡§∞‡§ø‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
            if (typeof isMixingModeActive !== 'undefined') {
                isMixingModeActive = false; 
            }
            
            // ‚úÖ ‡§´‡•â‡§∞‡•ç‡§Æ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç
            if(document.getElementById('mix-base-sku')) document.getElementById('mix-base-sku').value = '';
            if(document.getElementById('mix-base-name')) document.getElementById('mix-base-name').value = '';
            if(document.getElementById('mix-base-price')) document.getElementById('mix-base-price').value = '';
            if(document.getElementById('mix-code')) document.getElementById('mix-code').value = '';
            if(document.getElementById('mix-color-cost')) document.getElementById('mix-color-cost').value = '';
            if(document.getElementById('mix-final-price')) document.getElementById('mix-final-price').innerText = '‚Çπ0';
            if(document.getElementById('mix-stock-status')) document.getElementById('mix-stock-status').innerText = '';
        });
    }




// ==============================================
// üöÄ ‡§¨‡•à‡§Ç‡§ï ‡§∞‡§ø‡§ï‡•â‡§®‡•ç‡§∏‡§ø‡§≤‡•á‡§∂‡§® ‡§≤‡•â‡§ú‡§ø‡§ï ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§Ç‡§∏
// ==============================================

/**
 * ‡§ö‡§∞‡§£ 1: ‡§¨‡•à‡§Ç‡§ï ‡§∏‡•ç‡§ü‡•á‡§ü‡§Æ‡•á‡§Ç‡§ü CSV ‡§ï‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§î‡§∞ ‡§™‡§æ‡§∞‡•ç‡§∏ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
 */
/**
 * ‡§ö‡§∞‡§£ 1: ‡§¨‡•à‡§Ç‡§ï ‡§∏‡•ç‡§ü‡•á‡§ü‡§Æ‡•á‡§Ç‡§ü CSV ‡§ï‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§î‡§∞ ‡§™‡§æ‡§∞‡•ç‡§∏ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
 */
 async function handleStatementUpload(event) {
    event.preventDefault();
    const btn = document.getElementById('start-reconciliation-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ‡§Ö‡§™‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...';

    // 1. ‡§´‡•â‡§∞‡•ç‡§Æ ‡§°‡•á‡§ü‡§æ ‡§á‡§ï‡§ü‡•ç‡§†‡§æ ‡§ï‡§∞‡•á‡§Ç
    const statementFile = document.getElementById('recon-statement-csv').files[0];
    const statementDate = document.getElementById('recon-statement-date').value;
    const statementBalance = parseFloat(document.getElementById('recon-statement-balance').value);

    if (!statementFile) {
        showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', '‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï CSV ‡§´‡§º‡§æ‡§á‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§', 'danger');
        btn.disabled = false; btn.innerHTML = '<i class="fas fa-play me-2"></i> ‡§∞‡§ø‡§ï‡•â‡§®‡•ç‡§∏‡§ø‡§≤‡•á‡§∂‡§® ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç';
        return;
    }

    try {
        // 2. CSV ‡§´‡§º‡§æ‡§á‡§≤ ‡§ï‡•ã ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§™‡§¢‡§º‡•á‡§Ç
        const csvText = await statementFile.text();
        
        // 3. ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•ã JSON ‡§Æ‡•á‡§Ç ‡§™‡§æ‡§∞‡•ç‡§∏ ‡§ï‡§∞‡•á‡§Ç
        const statementItems = parseCSV(csvText);

        if (!statementItems || statementItems.length === 0) {
            throw new Error('CSV ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•à ‡§Ø‡§æ ‡§™‡§æ‡§∞‡•ç‡§∏ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§æ‡•§');
        }

        // 4. ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§®‡§è API ‡§è‡§Ç‡§°‡§™‡•â‡§á‡§Ç‡§ü ‡§™‡§∞ ‡§≠‡•á‡§ú‡•á‡§Ç
        const res = await fetchApi('/api/reconciliation/upload-statement', {
            method: 'POST',
            body: {
                statementDate,
                statementBalance,
                statementItems
            }
        }, '‡§ü‡•ç‡§∞‡§æ‡§Ç‡§ú‡•à‡§ï‡•ç‡§∂‡§® ‡§ï‡§æ ‡§Æ‡§ø‡§≤‡§æ‡§® ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...');

        if (res.success) {
            // 5. UI ‡§ï‡•ã "‡§Æ‡•à‡§ö‡§ø‡§Ç‡§ó" ‡§Æ‡•ã‡§° ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤‡•á‡§Ç
            document.getElementById('reconciliation-setup').classList.add('hidden');
            document.getElementById('reconciliation-matching-area').classList.remove('hidden');
            
            // 6. ‡§Æ‡•à‡§ö‡§ø‡§Ç‡§ó ‡§ü‡•á‡§¨‡§≤ ‡§∞‡•á‡§Ç‡§°‡§∞ ‡§ï‡§∞‡•á‡§Ç
            renderReconciliationTables(res.bookItems, res.bankItems, statementBalance);
            showMessage('‡§∏‡§´‡§≤‡§§‡§æ', '‡§∏‡•ç‡§ü‡•á‡§ü‡§Æ‡•á‡§Ç‡§ü ‡§Ö‡§™‡§≤‡•ã‡§° ‡§π‡•Å‡§Ü‡•§ ‡§Ö‡§¨ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä‡§ú‡§º ‡§ï‡§æ ‡§Æ‡§ø‡§≤‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç‡•§', 'success');
        } else {
            throw new Error(res.message);
        }

    } catch (e) {
        showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§Ö‡§™‡§≤‡•ã‡§° ‡§µ‡§ø‡§´‡§≤: ${e.message}`, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-play me-2"></i> ‡§∞‡§ø‡§ï‡•â‡§®‡•ç‡§∏‡§ø‡§≤‡•á‡§∂‡§® ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç';
    }
}


 /**
 * ‡§ö‡§∞‡§£ 2: ‡§¨‡•Å‡§ï ‡§î‡§∞ ‡§¨‡•à‡§Ç‡§ï ‡§ü‡•ç‡§∞‡§æ‡§Ç‡§ú‡•à‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã ‡§≤‡§æ‡§§‡§æ ‡§π‡•à ‡§î‡§∞ ‡§ü‡•á‡§¨‡§≤ ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ñ‡§æ‡§§‡§æ ‡§π‡•à
 * (‡§á‡§µ‡•á‡§Ç‡§ü ‡§≤‡§ø‡§∏‡•ç‡§®‡§∞ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§´‡§ø‡§ï‡•ç‡§∏‡•ç‡§°)
 */
function renderReconciliationTables(bookItems, bankItems, statementBalance) {
    const bookBody = document.getElementById('book-transactions-body');  
    const bankBody = document.getElementById('bank-transactions-body'); 
    bookBody.innerHTML = '';
    bankBody.innerHTML = '';

    let bookTotal = 0;
    let bankTotal = 0;

    // Dukan Pro (‡§¨‡•Å‡§ï) ‡§Ü‡§á‡§ü‡§Æ‡•ç‡§∏ ‡§ï‡•ã ‡§≠‡§∞‡•á‡§Ç
    bookItems.forEach(item => {
        bookTotal += parseFloat(item.amount);
        bookBody.innerHTML += `
            <tr data-id="${item.type}-${item.id}" data-amount="${item.amount}">
                <td><input type="checkbox" class="recon-check-book"></td>
                <td>
                    ${item.description}
                    <small class="d-block text-muted">${new Date(item.date).toLocaleDateString()}</small>
                </td>
                <td>${formatCurrency(item.amount)}</td>
            </tr>
        `;
    });

    // ‡§¨‡•à‡§Ç‡§ï ‡§∏‡•ç‡§ü‡•á‡§ü‡§Æ‡•á‡§Ç‡§ü ‡§Ü‡§á‡§ü‡§Æ‡•ç‡§∏ ‡§ï‡•ã ‡§≠‡§∞‡•á‡§Ç
    bankItems.forEach(item => {
        bankTotal += parseFloat(item.amount);
        bankBody.innerHTML += `
            <tr data-id="${item.id}" data-amount="${item.amount}">
                <td><input type="checkbox" class="recon-check-bank"></td>
                <td>
                    ${item.description}
                    <small class="d-block text-muted">${new Date(item.date).toLocaleDateString()}</small>
                </td>
                <td>${formatCurrency(item.amount)}</td>
            </tr>
        `;
    });

    // ‡§ü‡•ã‡§ü‡§≤‡•ç‡§∏ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
    document.getElementById('book-total').innerText = formatCurrency(bookTotal);  
    document.getElementById('bank-total').innerText = formatCurrency(bankTotal);  
    
    // ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§∏‡•ç‡§ü‡•á‡§ü‡§Æ‡•á‡§Ç‡§ü ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
    document.getElementById('report-statement-balance').innerText = formatCurrency(statementBalance);  
    
    // üöÄüöÄüöÄ ‡§Ø‡§π ‡§®‡§Ø‡§æ ‡§ï‡•ã‡§° ‡§π‡•à (‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞) üöÄüöÄüöÄ
    // ‡§∏‡§≠‡•Ä ‡§ö‡•á‡§ï‡§¨‡•â‡§ï‡•ç‡§∏ ‡§Æ‡•á‡§Ç 'change' ‡§á‡§µ‡•á‡§Ç‡§ü ‡§≤‡§ø‡§∏‡•ç‡§®‡§∞ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
    const allCheckboxes = document.querySelectorAll('.recon-check-book, .recon-check-bank, #check-all-book, #check-all-bank'); 
    allCheckboxes.forEach(cb => {
        cb.addEventListener('change', () => {
            // 'Select All' ‡§≤‡•â‡§ú‡§ø‡§ï
            if (cb.id === 'check-all-book') {  
                document.querySelectorAll('.recon-check-book').forEach(bookCb => bookCb.checked = cb.checked);  
            }
            if (cb.id === 'check-all-bank') {  
                document.querySelectorAll('.recon-check-bank').forEach(bankCb => bankCb.checked = cb.checked);  
            }
            
            // ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ó‡§£‡§®‡§æ ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã ‡§ï‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç
            calculateReconciliation();
        });
    });
    
    // ‡§™‡§π‡§≤‡•Ä ‡§¨‡§æ‡§∞ ‡§ó‡§£‡§®‡§æ (Calculate) ‡§ö‡§≤‡§æ‡§è‡§Å
    calculateReconciliation();
    // üöÄüöÄüöÄ ‡§®‡§Ø‡§æ ‡§ï‡•ã‡§° ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ üöÄüöÄüöÄ
}
/**
 * ‡§ö‡§∞‡§£ 3: ‡§Æ‡§ø‡§≤‡§æ‡§® ‡§ï‡•Ä ‡§ó‡§à ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä‡§ú‡§º ‡§î‡§∞ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡•ã ‡§∏‡•á‡§µ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
 */
/**
 * ‡§ö‡§∞‡§£ 3: ‡§Æ‡§ø‡§≤‡§æ‡§® ‡§ï‡•Ä ‡§ó‡§à ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä‡§ú‡§º ‡§î‡§∞ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡•ã ‡§∏‡•á‡§µ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
 */
 async function saveReconciliationReport() {
    const btn = document.getElementById('save-reconciliation-btn');  
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ‡§∏‡•á‡§µ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...';

    try {
        // 1. ‡§ö‡•á‡§ï‡•ç‡§° (matched) ‡§¨‡•à‡§Ç‡§ï IDs ‡§á‡§ï‡§ü‡•ç‡§†‡§æ ‡§ï‡§∞‡•á‡§Ç
        const reconciledBankIds = [];
        document.querySelectorAll('.recon-check-bank:checked').forEach(cb => {  
            reconciledBankIds.push(cb.closest('tr').dataset.id);
        });

        // 2. ‡§ö‡•á‡§ï‡•ç‡§° (matched) ‡§¨‡•Å‡§ï Items ‡§á‡§ï‡§ü‡•ç‡§†‡§æ ‡§ï‡§∞‡•á‡§Ç
        const reconciledBookItems = [];
        document.querySelectorAll('.recon-check-book:checked').forEach(cb => {  
            const idParts = cb.closest('tr').dataset.id.split('-'); // ‡§ú‡•à‡§∏‡•á "invoice-123"
            reconciledBookItems.push({
                type: idParts[0],
                id: parseInt(idParts[1])
            });
        });
        
        // 3. ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§æ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ (Summary) ‡§á‡§ï‡§ü‡•ç‡§†‡§æ ‡§ï‡§∞‡•á‡§Ç 
        const unclearedPaymentsAmount = parseFloat(document.getElementById('report-uncleared-payments').innerText.replace(/[^0-9.-]/g, '')); 
        const unclearedDepositsAmount = parseFloat(document.getElementById('report-uncleared-deposits').innerText.replace(/[^0-9.-]/g, '')); 
        
        const reportData = {
             clearedPayments: 0, // (‡§Ø‡§π ‡§Ö‡§≠‡•Ä ‡§ü‡•ç‡§∞‡•à‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à, 0 ‡§≠‡•á‡§ú‡•á‡§Ç)
             clearedDeposits: 0, // (‡§Ø‡§π ‡§Ö‡§≠‡•Ä ‡§ü‡•ç‡§∞‡•à‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à, 0 ‡§≠‡•á‡§ú‡•á‡§Ç)
             unclearedCount: document.querySelectorAll('.recon-check-book:not(:checked)').length,  
             unclearedTotal: unclearedPaymentsAmount + unclearedDepositsAmount
        };

        // 4. ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§°‡•á‡§ü‡§æ ‡§á‡§ï‡§ü‡•ç‡§†‡§æ ‡§ï‡§∞‡•á‡§Ç
        const dataToSend = {
            statementEndDate: document.getElementById('recon-statement-date').value,  
            statementEndBalance: parseFloat(document.getElementById('report-statement-balance').innerText.replace(/[^0-9.-]/g, '')),  
            reportSummary: reportData,
            reconciledBankIds: reconciledBankIds,
            reconciledBookItems: reconciledBookItems
        };

        // 5. ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§™‡§∞ ‡§≠‡•á‡§ú‡•á‡§Ç
        const res = await fetchApi('/api/reconciliation/save', {
            method: 'POST',
            body: dataToSend
        }, '‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡•á‡§µ ‡§ï‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à...');

        if (res.success) {
            showMessage('‡§∏‡§´‡§≤‡§§‡§æ', '‡§∞‡§ø‡§ï‡•â‡§®‡•ç‡§∏‡§ø‡§≤‡•á‡§∂‡§® ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡•á‡§µ ‡§ï‡•Ä ‡§ó‡§à!', 'success');
            renderView('bank-reconciliation'); // ‡§∏‡§¨ ‡§ï‡•Å‡§õ ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
        } else {
            throw new Error(res.message);
        }

    } catch (e) {
        showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡•á‡§µ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${e.message}`, 'danger');
        btn.disabled = false; // ‡§¨‡§ü‡§® ‡§ï‡•ã ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§á‡§®‡•á‡§¨‡§≤ ‡§ï‡§∞‡•á‡§Ç
        btn.innerHTML = '<i class="fas fa-save me-2"></i> ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç';
    }
}


    /**
 * ‡§ö‡§∞‡§£ 4: ‡§™‡§ø‡§õ‡§≤‡•Ä ‡§∏‡•á‡§µ ‡§ï‡•Ä ‡§ó‡§à ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏ ‡§ï‡•ã ‡§≤‡§æ‡§§‡§æ ‡§π‡•à ‡§î‡§∞ ‡§ü‡•á‡§¨‡§≤ ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ñ‡§æ‡§§‡§æ ‡§π‡•à
 */
async function fetchAndRenderSavedReports() {
    const tableBody = document.getElementById('previous-reports-body');
    tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à‡§Ç...</td></tr>`;

    try {
        const res = await fetchApi('/api/reconciliation/reports', { method: 'GET' }, null); // ‡§≤‡•ã‡§°‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å

        if (res.success && res.reports.length > 0) {
            tableBody.innerHTML = res.reports.map(report => `
                <tr>
                    <td>REP-${report.id}</td>
                    <td>${new Date(report.statement_end_date).toLocaleDateString()}</td>
                    <td>${formatCurrency(report.statement_end_balance)}</td>
                    <td class="${parseFloat(report.uncleared_items_total) !== 0 ? 'text-danger' : ''}">
                        ${formatCurrency(report.uncleared_items_total)}
                    </td>
                    <td>${new Date(report.reconciled_at).toLocaleString()}</td>
                </tr>
            `).join('');
        } else {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">‡§ï‡•ã‡§à ‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§</td></tr>`;
        }
    } catch (e) {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}</td></tr>`;
    }
}
    /**
     * Main startup logic
     */
    // ==========================================================
// ========== 1. LICENSE CHECK & APP LOCK LOGIC ==========
// ==========================================================

/**
 * Main startup logic - MODIFIED
 */
// [ ‡§Ø‡§π ‡§∞‡§π‡§æ ‡§®‡§Ø‡§æ ‡§î‡§∞ ‡§∏‡§π‡•Ä DOMContentLoaded - ‡§™‡•Å‡§∞‡§æ‡§®‡•á ‡§µ‡§æ‡§≤‡•á ‡§ï‡•ã ‡§π‡§ü‡§æ‡§ï‡§∞ ‡§á‡§∏‡•á ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç ]

document.addEventListener('DOMContentLoaded', () => {
    const licenseModalEl = document.getElementById('licenseModal');  
    const licenseModal = new bootstrap.Modal(licenseModalEl);
    
    // üöÄ ‡§´‡§ø‡§ï‡•ç‡§∏: ‡§∏‡§ø‡§∞‡•ç‡§´ ‡§®‡§è ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§ï‡•ã ‡§™‡§ï‡§°‡§º‡•á‡§Ç
    const newLoginContainer = document.getElementById('auth-container-new'); 
    
    // üöÄ ‡§´‡§ø‡§ï‡•ç‡§∏: ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§Ö‡§¨ ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§â‡§∏‡•á ‡§π‡§ü‡§æ ‡§¶‡•á‡§Ç
    // const oldLoginContainer = document.getElementById('auth-container'); 

    const token = localStorage.getItem('authToken');
    const user = JSON.parse(localStorage.getItem('authUser'));

    if (token && user) {
        console.log("‡§ü‡•ã‡§ï‡§® ‡§Æ‡§ø‡§≤‡§æ, ‡§≤‡•â‡§ó‡§ø‡§® ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§ï‡•Ä ‡§ú‡§æ‡§Å‡§ö ‡§ï‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à...");
        saveAuthData(token, user);
        startLicenseTimer(user.licenseExpiryDate);

        const expiryDate = user.licenseExpiryDate ? new Date(user.licenseExpiryDate) : null;
        const now = new Date();

        if (!expiryDate || expiryDate < now) {
            // --- üöÄ ‡§ï‡•á‡§∏ 1: ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§è‡§ï‡•ç‡§∏‡§™‡§æ‡§Ø‡§∞ ‡§π‡•à ---
            console.log("‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§Ø‡§æ ‡§ó‡•Å‡§Æ ‡§π‡•à‡•§ ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø‡§£ ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à‡•§");
            showMessage('‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï', '‡§Ü‡§™‡§ï‡§æ ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§∞‡•á‡§Ç‡•§', 'warning');

            // üöÄ ‡§´‡§ø‡§ï‡•ç‡§∏: ‡§≤‡•à‡§Ç‡§°‡§ø‡§Ç‡§ó ‡§¨‡§ü‡§® ‡§ï‡•ã ‡§õ‡§ø‡§™‡§æ‡§è‡§Å
            document.getElementById('landing-buttons-container').classList.add('hidden');
            
            // üöÄ ‡§´‡§ø‡§ï‡•ç‡§∏: ‡§≤‡•â‡§ó‡§ø‡§® ‡§∞‡•à‡§™‡§∞ (Wrapper) ‡§ï‡•ã ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
            document.getElementById('login-wrapper-main').classList.add('active'); 

            // üöÄ ‡§´‡§ø‡§ï‡•ç‡§∏: ‡§®‡§Ø‡§æ ‡§≤‡•â‡§ó‡§ø‡§® ‡§™‡•á‡§ú (‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° ‡§ï‡•á ‡§≤‡§ø‡§è) ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
            if (newLoginContainer) newLoginContainer.classList.remove('hidden');

            // ‡§ê‡§™ ‡§ï‡•á ‡§π‡§ø‡§∏‡•ç‡§∏‡•á (‡§ú‡•à‡§∏‡•á ‡§∏‡§æ‡§á‡§°‡§¨‡§æ‡§∞) ‡§Ö‡§®‡§≤‡•â‡§ï ‡§ï‡§∞‡•á‡§Ç
            document.getElementById('sidebar').classList.remove('locked');
            document.getElementById('menu-toggle').classList.remove('locked');
            document.getElementById('main-content').classList.add('locked'); // ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü ‡§≤‡•â‡§ï ‡§∞‡§ñ‡•á‡§Ç
            applyRBAC(user.role);
            licenseModal.show(); // ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ Modal ‡§ï‡•ã ‡§´‡•â‡§∞‡•ç‡§Æ ‡§ï‡•á ‡§ä‡§™‡§∞ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å

        } else {
            // --- üöÄ ‡§ï‡•á‡§∏ 2: ‡§∏‡§¨ ‡§ï‡•Å‡§õ ‡§∏‡§π‡•Ä ‡§π‡•à (‡§ü‡•ã‡§ï‡§® ‡§î‡§∞ ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏) ---
            console.log("‡§ü‡•ã‡§ï‡§® ‡§î‡§∞ ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§π‡•à‡§Ç‡•§ ‡§ê‡§™ ‡§Ö‡§®‡§≤‡•â‡§ï ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à‡•§");
            
            // üöÄ ‡§´‡§ø‡§ï‡•ç‡§∏: ‡§®‡§Ø‡§æ ‡§≤‡•â‡§ó‡§ø‡§® ‡§™‡•á‡§ú ‡§õ‡§ø‡§™‡§æ‡§è‡§Å
            if (newLoginContainer) newLoginContainer.classList.add('hidden');
            
            unlockApplication(); // ‡§ê‡§™ ‡§ï‡•ã ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‡§Ö‡§®‡§≤‡•â‡§ï ‡§ï‡§∞‡•á‡§Ç
        }

    } else {
        // --- üöÄ ‡§ï‡•á‡§∏ 3: ‡§ï‡•ã‡§à ‡§ü‡•ã‡§ï‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ (‡§≤‡•â‡§ó‡§Ü‡§â‡§ü ‡§π‡•à) ---
        console.log("‡§ï‡•ã‡§à ‡§ü‡•ã‡§ï‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§ ‡§≤‡•â‡§ó‡§ø‡§® ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§¶‡§ø‡§ñ‡§æ ‡§∞‡§π‡§æ ‡§π‡•à‡•§");
        
        // üöÄ ‡§´‡§ø‡§ï‡•ç‡§∏: ‡§∏‡§ø‡§∞‡•ç‡§´ ‡§®‡§Ø‡§æ ‡§≤‡•â‡§ó‡§ø‡§® ‡§™‡•á‡§ú ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
        if (newLoginContainer) newLoginContainer.classList.remove('hidden');

        // ‡§ê‡§™ ‡§ï‡•á ‡§¨‡§æ‡§ï‡•Ä ‡§π‡§ø‡§∏‡•ç‡§∏‡•ã‡§Ç ‡§ï‡•ã ‡§≤‡•â‡§ï ‡§∞‡§ñ‡•á‡§Ç
        document.getElementById('sidebar').classList.add('locked');
        document.getElementById('main-content').classList.add('locked');
        document.getElementById('menu-toggle').classList.add('locked');
    }

    // --- ‡§¨‡§æ‡§ï‡•Ä ‡§ï‡•á ‡§∏‡§≠‡•Ä ‡§≤‡§ø‡§∏‡•ç‡§®‡§∞ (Event Listeners) ---
// --- üöÄ (‡§®‡§Ø‡§æ) ‡§≤‡•à‡§Ç‡§°‡§ø‡§Ç‡§ó ‡§™‡•á‡§ú ‡§¨‡§ü‡§® ‡§≤‡§ø‡§∏‡•ç‡§®‡§∞ ---

const landingButtons = document.getElementById('landing-buttons-container');
    const loginWrapper = document.getElementById('login-wrapper-main');
    const showLoginBtn = document.getElementById('show-login-btn');
    const showRegisterBtn = document.getElementById('show-register-btn');

    // (‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§Ø‡•á ‡§ü‡•à‡§¨ ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§π‡•à‡§Ç)
    const loginTabBtn = document.getElementById('nav-login-tab');
    const registerTabBtn = document.getElementById('nav-register-tab');
    
    // ‡§è‡§ï '‡§∂‡•ã' ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§¨‡§®‡§æ‡§è‡§Å
    function showLoginWrapper(tabToShow) {
        if (!loginWrapper || !landingButtons) return;

        // 1. ‡§≤‡•â‡§ó‡§ø‡§® ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§ï‡•ã 'active' ‡§ï‡•ç‡§≤‡§æ‡§∏ ‡§¶‡•á‡§Ç
        loginWrapper.classList.add('active');
        
        // 2. ‡§≤‡•à‡§Ç‡§°‡§ø‡§Ç‡§ó ‡§¨‡§ü‡§®‡•ç‡§∏ ‡§ï‡•ã ‡§õ‡§ø‡§™‡§æ‡§è‡§Å (‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ 'hidden' ‡§ï‡•ç‡§≤‡§æ‡§∏ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á)
        landingButtons.classList.add('hidden');
        
        // 3. ‡§∏‡§π‡•Ä ‡§ü‡•à‡§¨ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
        if (tabToShow === 'login' && loginTabBtn) {
            new bootstrap.Tab(loginTabBtn).show();
        } else if (tabToShow === 'register' && registerTabBtn) {
            new bootstrap.Tab(registerTabBtn).show();
        }
    }

    // '‡§≤‡•â‡§ó‡§ø‡§®' ‡§¨‡§ü‡§® ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï
    if(showLoginBtn) {
        showLoginBtn.addEventListener('click', () => {
            showLoginWrapper('login');
        });
    }

    // '‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞' ‡§¨‡§ü‡§® ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï
    if(showRegisterBtn) {
        showRegisterBtn.addEventListener('click', () => {
            showLoginWrapper('register');
        });
    }

    // --- (‡§Ø‡§π‡§æ‡§Å ‡§∏‡•á '‡§¨‡§æ‡§ï‡•Ä ‡§ï‡•á ‡§∏‡§≠‡•Ä ‡§≤‡§ø‡§∏‡•ç‡§®‡§∞' ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã‡§§‡•á ‡§π‡•à‡§Ç) ---



    
    // Login Form
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const msgEl = document.getElementById('login-message');
        const btn = document.getElementById('login-submit-btn');
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ‡§≤‡•â‡§ó ‡§á‡§® ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...`;

        try {
            const res = await fetch(__backend_url + '/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await res.json();
            if (!res.ok || !data.success) { throw new Error(data.message || '‡§≤‡•â‡§ó‡§ø‡§® ‡§µ‡§ø‡§´‡§≤'); }

            msgEl.innerText = '‡§∏‡§´‡§≤‡§§‡§æ! ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...';
            saveAuthData(data.token, data.user);
            startLicenseTimer(data.user.licenseExpiryDate);

            if (data.requiresLicense) {
                // üöÄ ‡§´‡§ø‡§ï‡•ç‡§∏: ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§è‡§ï‡•ç‡§∏‡§™‡§æ‡§Ø‡§∞ ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§∏‡§ø‡§∞‡•ç‡§´ Modal ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å (‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§π‡•Ä ‡§¶‡§ø‡§ñ ‡§∞‡§π‡§æ ‡§π‡•à)
                showMessage('‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï', data.message, 'warning');
                if (newLoginContainer) newLoginContainer.classList.remove('hidden'); // ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° ‡§¶‡§ø‡§ñ‡•á
                document.getElementById('sidebar').classList.remove('locked');
                document.getElementById('menu-toggle').classList.remove('locked');
                document.getElementById('main-content').classList.add('locked');
                applyRBAC(data.user.role);
                licenseModal.show();
            } else {
                unlockApplication(); // ‡§∏‡§¨ ‡§∏‡§π‡•Ä ‡§π‡•à, ‡§ê‡§™ ‡§Ö‡§®‡§≤‡•â‡§ï ‡§ï‡§∞‡•á‡§Ç
            }
        } catch (error) {
            msgEl.innerText = error.message;
        } finally {
            btn.disabled = false;
            btn.innerHTML = '‡§≤‡•â‡§ó‡§ø‡§®';
        }
    });

    // Registration Form
// [ ‚úÖ FIXED: Registration Form Handler - Correct ID Used ]

// [ ‚úÖ FIXED: Registration Logic with Unique ID ]

document.getElementById('register-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const shopName = document.getElementById('register-shop-name').value;
    const name = document.getElementById('register-name').value;
    const email = document.getElementById('register-email').value;
    const mobile = document.getElementById('register-mobile').value;
    const password = document.getElementById('register-password').value;
    
    // üöÄ FIX: ‡§®‡§à ‡§Ø‡•Ç‡§®‡§ø‡§ï ID ‡§∏‡•á ‡§µ‡•à‡§≤‡•ç‡§Ø‡•Ç ‡§â‡§†‡§æ‡§è‡§Ç
    const typeElement = document.getElementById('unique-biz-type');
    const businessType = typeElement ? typeElement.value : ''; 

    // üõë ‡§ö‡•á‡§ï: ‡§Ö‡§ó‡§∞ ‡§ï‡•Å‡§õ ‡§®‡§π‡•Ä‡§Ç ‡§ö‡•Å‡§®‡§æ, ‡§§‡•ã ‡§∞‡•ã‡§ï ‡§¶‡•á‡§Ç
    if (!businessType) {
        alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡§ø‡§ú‡§®‡•á‡§∏ ‡§ï‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç!");
        return;
    }

    // üì¢ ‡§°‡§ø‡§¨‡§ó: ‡§Ø‡§π ‡§Ö‡§≤‡§∞‡•ç‡§ü ‡§Ü‡§™‡§ï‡•ã ‡§¨‡§§‡§æ‡§è‡§ó‡§æ ‡§ï‡§ø ‡§ï‡•ç‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à
    // alert("‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à: " + businessType); 

    const msgEl = document.getElementById('register-message');
    const btn = document.getElementById('register-submit-btn');
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...`;

    try {
        const res = await fetch(__backend_url + '/api/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                shopName, 
                name, 
                email, 
                mobile, 
                password, 
                business_type: businessType // ‡§Ø‡§π 'SALON' ‡§≠‡•á‡§ú‡•á‡§ó‡§æ
            })
        });
        const data = await res.json();
        if (!res.ok || !data.success) { throw new Error(data.message || '‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•á‡§∂‡§® ‡§µ‡§ø‡§´‡§≤'); }

        msgEl.innerText = '‡§∏‡§´‡§≤‡§§‡§æ! ‡§ê‡§™ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...';
        
        saveAuthData(data.token, data.user);
        
        // üöÄ UI ‡§ï‡•ã ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
        applyBusinessTypeUI(data.user.businessType);
        
        startLicenseTimer(data.user.licenseExpiryDate);
        showMessage('‡§∏‡§´‡§≤‡§§‡§æ!', `‡§Ü‡§™‡§ï‡§æ ${data.user.businessType} ‡§Ö‡§ï‡§æ‡§â‡§Ç‡§ü ‡§¨‡§® ‡§ó‡§Ø‡§æ ‡§π‡•à!`, 'success');
        
        if (typeof newLoginContainer !== 'undefined') newLoginContainer.classList.remove('hidden');
        document.getElementById('sidebar').classList.remove('locked');
        document.getElementById('menu-toggle').classList.remove('locked');
        document.getElementById('main-content').classList.add('locked');
        
        if (typeof applyRBAC === 'function') applyRBAC(data.user.role);
        
        const licenseModal = new bootstrap.Modal(document.getElementById('licenseModal'));
        licenseModal.show();

    } catch (error) {
        msgEl.innerText = error.message;
    } finally {
        btn.disabled = false;
        btn.innerHTML = '‡§Ö‡§ï‡§æ‡§â‡§Ç‡§ü ‡§¨‡§®‡§æ‡§è‡§Ç';
    }
});

    // License Activation Form
    document.getElementById('license-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const key = document.getElementById("license-key-input").value.trim();
        const messageEl = document.getElementById("license-message");
        messageEl.innerText = '‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...';

        try {
           const res = await fetchApi('/api/activate-license', {
                method: 'POST',
                body: { licenseKey: key }
           }, '‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏ ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...');
            
            if (res.success) {
                saveAuthData(res.token, res.user);
                startLicenseTimer(res.user.licenseExpiryDate);
                licenseModal.hide();
                showMessage('‡§∏‡§´‡§≤‡§§‡§æ', res.message, 'success');
                unlockApplication(); // <<< ‡§Ö‡§¨ ‡§ê‡§™ ‡§ï‡•ã ‡§Ö‡§®‡§≤‡•â‡§ï ‡§ï‡§∞‡•á‡§Ç
            } else {
                throw new Error(res.message || '‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§Ø‡§æ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏‡•§');
            }
        } catch (err) {
            messageEl.innerText = '‚ùå ' + err.message;
        }
    });
    
    // --- ‡§¨‡§æ‡§ï‡•Ä ‡§ï‡•á ‡§∏‡§≠‡•Ä ‡§≤‡§ø‡§∏‡•ç‡§®‡§∞ ---
    document.getElementById('logout-btn').addEventListener('click', logout);
    document.querySelectorAll('#sidebar-nav .nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            handleNavClick(link.getAttribute('data-view'));
            if (window.innerWidth < 992) document.getElementById('sidebar').classList.remove('active');
        });
    });
    document.getElementById('menu-toggle').addEventListener('click', () => {
         document.getElementById('sidebar').classList.toggle('active');
    });
    const posSearchInput = document.getElementById('pos-item-search');
    if (posSearchInput) {
        posSearchInput.addEventListener('input', () => handleItemSearch(false)); 
        posSearchInput.addEventListener('click', () => handleItemSearch(true)); 
        document.addEventListener('click', (e) => {
            if (e.target.id !== 'pos-item-search') {
                document.getElementById('pos-search-results').innerHTML = '';
            }
        });
    }
    updatePOSCartView(); 
    const expenseDateInput = document.getElementById('expense-date');
    if (expenseDateInput) {
        try {
            expenseDateInput.value = new Date().toISOString().split('T')[0];
        } catch(e) { console.error("Expense date set error", e); }
    }
    const barcodeInput = document.getElementById('barcode-scanner-input');
    barcodeInput.addEventListener('change', () => handleBarcodeScan(null));
    // [ ‡§Ø‡§π ‡§Ü‡§™‡§ï‡§æ ‡§´‡§ø‡§ï‡•ç‡§∏ ‡§π‡•à - ‡§â‡§∏ ‡§è‡§ï ‡§≤‡§æ‡§á‡§® ‡§ï‡•Ä ‡§ú‡§ó‡§π ‡§á‡§∏‡•á ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç ]
// [ ‚úÖ FIXED: Global Scanner Focus Logic ]
    // ‡§Ø‡§π ‡§ï‡•ã‡§° ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§ï‡§ø ‡§ú‡§¨ ‡§Ü‡§™ ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•ã‡§Ç ‡§Ø‡§æ ‡§≤‡§æ‡§≤ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§ñ‡•Å‡§≤‡•Ä ‡§π‡•ã,
    // ‡§§‡•ã ‡§∏‡•ç‡§ï‡•à‡§®‡§∞ ‡§´‡•ã‡§ï‡§∏ ‡§® ‡§õ‡•Ä‡§®‡•á‡•§

    document.body.addEventListener('click', (e) => {
        // 1. ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§ï‡•ç‡§Ø‡§æ ‡§≤‡§æ‡§≤ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® (‡§Ø‡§æ ‡§ï‡•ã‡§à ‡§≠‡•Ä ‡§Æ‡•â‡§°‡§≤) ‡§ñ‡•Å‡§≤‡•Ä ‡§π‡•à?
        const isModalOpen = document.querySelector('.modal.show');
        
        // ‡§Ö‡§ó‡§∞ ‡§ï‡•ã‡§à ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§ñ‡•Å‡§≤‡•Ä ‡§π‡•à, ‡§§‡•ã ‡§Ø‡§π 'Auto Focus' ‡§µ‡§æ‡§≤‡§æ ‡§≤‡•â‡§ú‡§ø‡§ï ‡§® ‡§ö‡§≤‡§æ‡§è‡§Ç‡•§
        // ‡§á‡§∏‡§∏‡•á ‡§Ü‡§™ ‡§Ü‡§∞‡§æ‡§Æ ‡§∏‡•á ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞ ‡§™‡§æ‡§è‡§Ç‡§ó‡•á‡•§
        if (isModalOpen) {
            return; 
        }

        // --- ‡§®‡•Ä‡§ö‡•á ‡§ï‡§æ ‡§ï‡•ã‡§° ‡§§‡§≠‡•Ä ‡§ö‡§≤‡•á‡§ó‡§æ ‡§ú‡§¨ ‡§ï‡•ã‡§à ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§®‡§π‡•Ä‡§Ç ‡§ñ‡•Å‡§≤‡•Ä ‡§π‡•ã ---

        const targetElement = e.target;
        const targetTagName = targetElement.tagName.toUpperCase();

        // ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™‡§®‡•á ‡§ï‡§ø‡§∏‡•Ä ‡§ï‡§æ‡§Æ ‡§ï‡•Ä ‡§ö‡•Ä‡§ú‡§º ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§ø‡§Ø‡§æ ‡§π‡•à
        const isClickable = (
            targetTagName === 'INPUT' ||
            targetTagName === 'TEXTAREA' ||
            targetTagName === 'SELECT' ||
            targetTagName === 'BUTTON' ||
            targetElement.closest('a') || 
            targetElement.closest('.nav-link') || 
            targetElement.closest('.list-group-item-action') ||
            targetElement.closest('.modal-content') // üöÄ Extra Safety: ‡§Ö‡§ó‡§∞ ‡§Æ‡•â‡§°‡§≤ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§π‡•Å‡§Ü
        );

        // ‡§Ö‡§ó‡§∞ ‡§ñ‡§æ‡§≤‡•Ä ‡§ú‡§ó‡§π ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§ø‡§Ø‡§æ ‡§π‡•à, ‡§§‡§≠‡•Ä ‡§∏‡•ç‡§ï‡•à‡§®‡§∞ ‡§ö‡§æ‡§≤‡•Ç ‡§ï‡§∞‡•á‡§Ç
        if (!isClickable) {
            focusBarcodeScanner();
        }
    });

    // postMessage Listener
    window.addEventListener('message', function(event) {
        if (event.origin !== window.location.origin) return; 
        if (event.data) {
            const token = localStorage.getItem('authToken');
            const user = AppState.user || JSON.parse(localStorage.getItem('authUser'));
            const shopId = user ? user.shopId : null;
            const backendUrl = __backend_url;

            if (event.data.type === 'REQUEST_AUTH' && token) {
                if (window.scannerWindow && !window.scannerWindow.closed) {
                    window.scannerWindow.postMessage({
                        type: 'AUTH_TOKEN',
                        token: token,
                        shopId: shopId,
                        backendUrl: backendUrl
                    }, window.location.origin);
                }
            }
            if (event.data.type === 'SCANNED_SKU' && event.data.sku) {
                 addSKUToCart(event.data.sku);
            }
        }
    });


// üöÄüöÄüöÄ ‡§¨‡•à‡§Ç‡§ï ‡§∞‡§ø‡§ï‡•â‡§®‡•ç‡§∏‡§ø‡§≤‡•á‡§∂‡§® ‡§≤‡§ø‡§∏‡•ç‡§®‡§∞ ‡§Ø‡§π‡§æ‡§Å ‡§ú‡•ã‡§°‡§º‡•á‡§Ç üöÄüöÄüöÄ
document.getElementById('reconciliation-start-form').addEventListener('submit', handleStatementUpload);
        document.getElementById('save-reconciliation-btn').addEventListener('click', saveReconciliationReport);
        document.getElementById('cancel-reconciliation-btn').addEventListener('click', () => {
            if(confirm('‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§∞‡§ø‡§ï‡•â‡§®‡•ç‡§∏‡§ø‡§≤‡•á‡§∂‡§® ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?')) {
                renderView('bank-reconciliation'); // ‡§™‡•á‡§ú ‡§ï‡•ã ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
            }
        });
        // üöÄüöÄüöÄ ‡§ï‡•ã‡§° ‡§Ø‡§π‡§æ‡§Å ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã‡§§‡§æ ‡§π‡•à üöÄüöÄüöÄ

});


// [ ‡§®‡§Ø‡§æ DOMContentLoaded ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§Ø‡§π‡§æ‡§Å ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã‡§§‡§æ ‡§π‡•à ]

// [ ‡§®‡§Ø‡§æ DOMContentLoaded ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§Ø‡§π‡§æ‡§Å ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã‡§§‡§æ ‡§π‡•à ]// [ ‡§®‡§Ø‡§æ DOMContentLoaded ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§Ø‡§π‡§æ‡§Å ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã‡§§‡§æ ‡§π‡•à ]    // --- Registration Form Handler - MODIFIED ---
   // Registration Form Handler - MODIFIED to include mobile
 

</script>

<div class="modal fade" id="pairingModal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="pairingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pairingModalLabel">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§∏‡•ç‡§ï‡•à‡§®‡§∞ ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closePosWebSocket()"></button>
            </div>
            <div class="modal-body text-center">
                <p>‡§Ö‡§™‡§®‡•á Dukan Pro ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§∏‡•ç‡§ï‡•à‡§®‡§∞ ‡§Æ‡•á‡§Ç ‡§Ø‡§π ‡§ï‡•ã‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç:</p>
                
                <div id="pairing-code-container" style="min-height: 100px; display: flex; align-items: center; justify-content: center; background: #eee; border-radius: 8px; margin: 20px 0;">
                    
                    <span id="pairing-code-display" style="font-size: 2.5rem; font-weight: bold; letter-spacing: 5px; color: #0d6efd;"></span> 
                    
                    <div id="code-spinner" class="spinner-border text-primary" role="status"> 
                        <span class="visually-hidden">‡§ï‡•ã‡§° ‡§ú‡§®‡§∞‡•á‡§ü ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</span>
                    </div>
                </div>
                
                <h4 id="pairing-status" class="text-success"> 
                    <i class="fas fa-check-circle"></i> ‡§∏‡•ç‡§ï‡•à‡§®‡§∞ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ!
                </h4>
                
                <p class="text-muted small mt-3">‡§Ø‡§π ‡§ï‡•ã‡§° ‡§Ü‡§™‡§ï‡•á POS ‡§ï‡•ã ‡§Ü‡§™‡§ï‡•á ‡§´‡§º‡•ã‡§® ‡§∏‡•á ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§ú‡•ã‡§°‡§º‡§§‡§æ ‡§π‡•à‡•§</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closePosWebSocket()">‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="quickAddItemModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="quickAddItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="quickAddItemModalLabel"><i class="fas fa-plus-circle me-2"></i>‡§®‡§Ø‡§æ ‡§Ü‡§á‡§ü‡§Æ ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="quick-add-item-form">
                    <div class="mb-3">
                        <label for="quick-add-sku" class="form-label">SKU / Barcode Number</label>
                        <input type="text" class="form-control" id="quick-add-sku" required>
                    </div>

                    <div class="mb-3">
                        <label for="quick-add-name" class="form-label">‡§Ü‡§á‡§ü‡§Æ ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
                        <input type="text" class="form-control" id="quick-add-name" required>
                    </div>

                    <div class="row g-2">
                        <div class="col-md-6">
                            <label for="quick-add-sale-price" class="form-label">‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§Æ‡•Ç‡§≤‡•ç‡§Ø (Sale Price) (‚Çπ)</label>
                            <input type="number" step="0.01" class="form-control" id="quick-add-sale-price" required min="0">
                        </div>
                        <div class="col-md-6">
                            <label for="quick-add-purchase-price" class="form-label">‡§ñ‡§∞‡•Ä‡§¶ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø (Purchase Price) (‚Çπ)</label>
                            <input type="number" step="0.01" class="form-control" id="quick-add-purchase-price" required min="0">
                        </div>
                    </div>

                    <div class="modal-footer pb-0">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
                        <button type="button" class="btn btn-success" id="quick-add-save-btn">
                            <i class="fas fa-save me-2"></i>‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§ï‡§æ‡§∞‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="localScannerModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="localScannerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="localScannerModalLabel"><i class="fas fa-camera me-2"></i>Live Barcode Scanner</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" id="local-scanner-close-btn"></button>
            </div>
            <div class="modal-body" style="padding: 0; min-height: 250px;">
                <div id="local-scanner-video" style="width: 100%;"></div>
                <div id="local-scanner-message" class="alert alert-info m-2" style="display: none;">
                    ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="local-scanner-cancel-btn">‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="appointmentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-calendar-check me-2"></i>‡§®‡§à ‡§Ö‡§™‡•â‡§á‡§Ç‡§ü‡§Æ‡•á‡§Ç‡§ü ‡§¨‡•Å‡§ï ‡§ï‡§∞‡•á‡§Ç</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="appointment-form">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
                        <input type="text" id="appt-name" class="form-control" required placeholder="e.g. Rahul">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞</label>
                        <input type="tel" id="appt-mobile" class="form-control" placeholder="e.g. 9876543210">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ (Service)</label>
                        <input type="text" id="appt-service" class="form-control" required placeholder="e.g. Hair Cut">
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label small fw-bold">‡§§‡§æ‡§∞‡•Ä‡§ñ (Date)</label>
                            <input type="date" id="appt-date" class="form-control" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label small fw-bold">‡§∏‡§Æ‡§Ø (Time)</label>
                            <input type="time" id="appt-time" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="mt-4 d-grid">
                        <button type="submit" class="btn btn-success">‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§™‡§ï‡•ç‡§ï‡•Ä ‡§ï‡§∞‡•á‡§Ç (Book Now)</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ========================== -->
<!--   ULTIMATE AI INSIGHTS     -->
<!-- ========================== -->

<section id="ai-insights" class="section">

    <!-- TOP HEADER -->
    <div class="ai-header-box">
        <div>
            <h2 class="ai-title"><i class="fas fa-brain me-2"></i> Ultimate AI Insights</h2>
            <p class="ai-subtitle">Your Business ‚Äî Deep AI Analysis, Predictions & Strategies</p>
        </div>
        <button class="ai-refresh-btn" onclick="loadUltimateAI()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>

    <!-- MAIN CONTENT -->
    <div id="ai-insights-container">

        <!-- BUSINESS HEALTH -->
        <div id="ai-business-health" class="ai-box">
            <h3><i class="fas fa-heartbeat"></i> Business Health Overview</h3>
            <div id="ai-health-content">
                <div class="ai-loading">
                    <div class="spinner-border text-primary"></div>
                    <p>Analyzing business performance...</p>
                </div>
            </div>
        </div>

        <!-- CUSTOMER INTELLIGENCE -->
        <div id="ai-customer-intel" class="ai-box">
            <h3><i class="fas fa-users"></i> Customer Intelligence</h3>
            <div id="ai-customer-content">
                <div class="ai-loading">
                    <div class="spinner-border text-primary"></div>
                    <p>Analyzing customer patterns...</p>
                </div>
            </div>
        </div>

        <!-- PRODUCT INTELLIGENCE -->
        <div id="ai-product-intel" class="ai-box">
            <h3><i class="fas fa-box-open"></i> Product Intelligence</h3>
            <div id="ai-product-content">
                <div class="ai-loading">
                    <div class="spinner-border text-primary"></div>
                    <p>Checking product performance...</p>
                </div>
            </div>
        </div>


<!-- LOSS FINDER BOX -->
<div id="ai-loss-finder" class="ai-box">
    <h3><i class="fas fa-exclamation-triangle"></i> Loss Finder (‡§®‡•Å‡§ï‡§∏‡§æ‡§® ‡§™‡§ï‡§°‡§º‡§®‡•á ‡§µ‡§æ‡§≤‡§æ AI)</h3>
    <div id="ai-loss-content">
        <div class="ai-loading">
            <div class="spinner-border text-danger"></div>
            <p>‡§®‡•Å‡§ï‡§∏‡§æ‡§® ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</p>
        </div>
    </div>
</div>


        <!-- FESTIVAL STRATEGY -->
        <div id="ai-festival-strategy" class="ai-box">
            <h3><i class="fas fa-fireworks"></i> Festival Strategy</h3>
            <div id="ai-festival-content">
                <div class="ai-loading">
                    <div class="spinner-border text-primary"></div>
                    <p>Preparing festival recommendations...</p>
                </div>
            </div>
        </div>

        <!-- MARKETING / ADS AI -->
        <div id="ai-marketing-intel" class="ai-box">
            <h3><i class="fas fa-bullhorn"></i> Marketing & Advertisement AI</h3>
            <div id="ai-marketing-content">
                <div class="ai-loading">
                    <div class="spinner-border text-primary"></div>
                    <p>Generating ad ideas...</p>
                </div>
            </div>
        </div>

        <!-- SALES PREDICTION -->
        <div id="ai-prediction" class="ai-box">
            <h3><i class="fas fa-chart-line"></i> Sales & Stock Prediction</h3>
            <div id="ai-prediction-content">
                <div class="ai-loading">
                    <div class="spinner-border text-primary"></div>
                    <p>Generating predictions...</p>
                </div>
            </div>
        </div>

    </div>

    
<div class="ai-box" id="ai-chat-box">
    <h3><i class="fas fa-comments"></i> AI ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø ‡§∏‡§≤‡§æ‡§π</h3>
  
    <div id="ai-chat-response" class="ai-chat-response">
       <p class="text-muted-small">AI ‡§Ü‡§™‡§ï‡•á ‡§∏‡§µ‡§æ‡§≤‡•ã‡§Ç ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡•á‡§ó‡§æ...</p>
    </div>
  
    <div class="ai-chat-input">
      <input id="ai-chat-question" type="text" placeholder="‡§Ö‡§™‡§®‡§æ ‡§∏‡§µ‡§æ‡§≤ ‡§≤‡§ø‡§ñ‡•á‡§Ç... (‡§ú‡•à‡§∏‡•á - ‡§Æ‡•á‡§∞‡§æ profit ‡§ï‡•à‡§∏‡•á ‡§¨‡§¢‡§º‡•á?)">
      <button type="button" onclick="askBusinessAI()" class="ai-refresh-btn">‡§™‡•Ç‡§õ‡•á‡§Ç</button>
    </div>
  </div>


  
<!-- (A) small HTML container ‚Äî add inside your ai-insights section (where you want it to appear) -->
<div id="ai-customer-targeting" class="ai-box">
    <h3><i class="fas fa-bullseye"></i> Personalised Customer Targeting</h3>
    <div id="ai-customer-targeting-content">
      <div class="ai-loading"><div class="spinner-border text-primary"></div><p>‡§≤‡•ã‡§ó‡•ã‡§Ç ‡§ï‡§æ ‡§ö‡§Ø‡§® ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...</p></div>
    </div>
  </div>

  <!-- ========================= -->
<!-- SALOON AI INSIGHTS (UI)  -->
<!-- ========================= -->
<div id="ai-saloon" class="ai-box" style="display:none;">
    <h3><i class="fas fa-scissors"></i> Saloon Dashboard</h3>
  
    <div id="ai-saloon-dashboard">
      <div class="ai-loading">
        <div class="spinner-border text-primary"></div>
        <p>Saloon ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</p>
      </div>
    </div>
  
    <hr>
  
    <div id="ai-saloon-services" style="margin-top:12px;">
      <h5><i class="fas fa-concierge-bell"></i> Services / Items</h5>
      <div class="ai-loading">
        <div class="spinner-border text-primary"></div>
        <p>Services ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...</p>
      </div>
    </div>
  
    <hr>
  
    <div id="ai-saloon-birthdays" style="margin-top:12px;">
      <h5><i class="fas fa-birthday-cake"></i> Upcoming Birthdays (7 days)</h5>
      <div class="ai-loading">
        <div class="spinner-border text-primary"></div>
        <p>Birthday list ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...</p>
      </div>
    </div>
  </div>
  
<div id="ai-saloon-box" class="ai-box" style="display:none;">
    <h3><i class="fas fa-scissors"></i> Salon Insights</h3>
    <div id="ai-saloon-content">
      <div class="ai-loading">
        <div class="spinner-border text-primary"></div>
        <p>Saloon data ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</p>
      </div>
    </div>
</div>
  
</section>





<script>


async function askBusinessAI(){
  const q = document.getElementById("ai-chat-question").value.trim();
  if(!q) return;

  document.getElementById("ai-chat-response").innerHTML = `<p class="text-muted-small">‡§∏‡•ã‡§ö ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å...</p>`;

  try {
    const res = await fetchApi("/api/ai/business-chat", {
      method: "POST",
      body: { question: q }   // pass as object ‚Äî fetchApi will stringify safely
    });

    if(res && res.success){
      document.getElementById("ai-chat-response").innerHTML = `<p>${res.answer.replace(/\n/g,"<br>")}</p>`;
    } else {
      document.getElementById("ai-chat-response").innerHTML = `<p class="text-danger">${res.message || '‡§ï‡•ã‡§à ‡§â‡§§‡•ç‡§§‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ'}</p>`;
    }
  } catch (err) {
    document.getElementById("ai-chat-response").innerHTML = `<p class="text-danger">Error: ${err.message}</p>`;
  }
}


    async function renderAiInsightsFinal(){
        const box = document.getElementById("ai-insights-content");
    
        box.innerHTML = `
            <div class="ai-loading">
                <div class="spinner-border text-primary"></div>
                <p>AI Analysis ‡§ö‡§≤ ‡§∞‡§π‡§æ ‡§π‡•à...</p>
            </div>
        `;
    
        try{
    
            const response = await fetchApi('/api/ai/stock-insights',{method:'GET'});
            if(!response.success){
                box.innerHTML = `<div class='alert alert-danger'>${response.message}</div>`;
                return;
            }
    
            const i = response.insights;
    
            box.innerHTML = `
                <div class="ai-health-box">
                    <h3>Business Health Score: <b>${i.business_health_score}/100</b></h3>
                    <div class="ai-progress"><div class="ai-progress-inner" style="width:${i.business_health_score}%"></div></div>
                </div>
    
                <div class="ai-card">
                    <h4>üì¶ Fast Moving Items 
                        <span class="ai-badge ai-badge-yellow">${i.fast_moving.length}</span>
                    </h4>
                    ${i.fast_moving.length ? 
                        i.fast_moving.map(item => `
                            <div class="alert alert-warning">
                                <b>${item.name}</b> (SKU: ${item.sku})  
                                <br>‚è≥ ‡§ñ‡§§‡•ç‡§Æ ‡§π‡•ã‡§®‡•á ‡§ï‡§æ ‡§∏‡§Æ‡§Ø: <b>${item.days_left} ‡§¶‡§ø‡§®</b>  
                                <br>üìå ‡§∏‡•ç‡§ü‡•â‡§ï: ${item.current_qty} pcs  
                            </div>
                        `).join('')
                    : `<p class='text-muted'>‡§ï‡•ã‡§à fast moving item ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à</p>`}
                </div>
    
                <div class="ai-card">
                    <h4>üõë Dead Stock 
                        <span class="ai-badge ai-badge-red">${i.dead_stock.length}</span>
                    </h4>
                    ${i.dead_stock.length ?
                        i.dead_stock.map(item => `
                            <div class="alert alert-danger">
                                <b>${item.name}</b> (SKU: ${item.sku})  
                                <br>üö´ ‡§™‡§ø‡§õ‡§≤‡•á 30 ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§¨‡§ø‡§ï‡§æ  
                                <br>üí∞ ‡§´‡§Å‡§∏‡§æ ‡§π‡•Å‡§Ü ‡§™‡•à‡§∏‡§æ: ‚Çπ${item.stock_value}  
                            </div>
                        `).join('')
                    : `<p class='text-muted'>Dead stock ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à</p>`}
                </div>
    
                <div class="ai-card">
                    <h4>üîÑ Restock Suggestions 
                        <span class="ai-badge ai-badge-blue">${i.restock.length}</span>
                    </h4>
                    ${i.restock.length ?
                        i.restock.map(item => `
                            <div class="alert alert-info">
                                <b>${item.name}</b> (SKU: ${item.sku})  
                                <br>üìå Current: ${item.current_qty} pcs  
                                <br>‚≠ï Suggested Reorder: <b>${item.suggested_reorder}</b> pcs  
                            </div>
                        `).join('')
                    : `<p class='text-muted'>‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä item ‡§ï‡•Ä ‡§Ö‡§≠‡•Ä restock ‡§ú‡§∞‡•Ç‡§∞‡§§ ‡§®‡§π‡•Ä‡§Ç</p>`}
                </div>
            `;
        }
        catch(err){
            box.innerHTML = `<div class='alert alert-danger'>Error: ${err.message}</div>`;
        }
    }
    
  

    </script>
        
        <script>
            /* ================================
               ULTIMATE AI INSIGHTS ‚Äì MAIN LOGIC
               ================================ */
            
        
               async function loadUltimateAI() {
  try {
    // show loading
    const ids = [
      "ai-health-content",
      "ai-customer-content",
      "ai-product-content",
      "ai-festival-content",
      "ai-marketing-content",
      "ai-prediction-content",
      "ai-saloon-content",
      // üöÄ NEW: ‡§á‡§® ‡§§‡•Ä‡§®‡•ã‡§Ç ‡§ï‡•ã ‡§≠‡•Ä ‡§≤‡•ã‡§°‡§ø‡§Ç‡§ó ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à
      "ai-saloon-dashboard",
      "ai-saloon-services",
      "ai-saloon-birthdays"
    ];

    ids.forEach(id => {
      const box = document.getElementById(id);
      if (box) {
        box.innerHTML = `
          <div class="ai-loading">
            <div class="spinner-border text-primary"></div>
            <p>‡§°‡§æ‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</p>
          </div>`;
      }
    });

    // API CALLS
    const stockData      = await fetchApi("/api/ai/stock-insights", { method:"GET" });
    const customerData   = await fetchApi("/api/ai/customers-intel", { method:"GET" });
    const productData    = await fetchApi("/api/ai/products-intel", { method:"GET" });
    const predictionData = await fetchApi("/api/ai/prediction", { method:"GET" });
    const whatsappData   = await fetchApi("/api/ai/clients-whatsapp", { method:"GET" });
    const probData       = await fetchApi("/api/ai/customer-probability", { method:"GET" });
    const monthlyData    = await fetchApi("/api/ai/monthly-strategy", { method:"GET" });
    const lossData       = await fetchApi("/api/ai/loss-finder", { method:"GET" });
    const targetingData  = await fetchApi("/api/ai/customer-targeting", { method:"GET" });
    const saloonData     = await fetchApi("/api/ai/saloon-insights", { method:"GET" });

    // Render sections
    renderBusinessHealth(stockData);
    renderCustomerIntel(customerData);
    renderProductIntel(productData, stockData);
    renderFestivalStrategy(productData);
    renderMarketingIdeas(productData);
    renderPrediction(predictionData);
    renderCustomerProbability(probData);
    renderMonthlyStrategy(monthlyData);
    renderLossFinder(lossData);
    renderCustomerTargeting(targetingData.customers || targetingData);

    // NEW ‚Üí Saloon Insights Rendering (Bottom Part)
    renderSaloonInsights(saloonData);

    // WhatsApp Advisor
    renderWhatsappAdvisor(whatsappData);
    
    // üöÄüöÄüöÄ NEW LOGIC ADDED HERE üöÄüöÄüöÄ
    // (‡§Ø‡§π ‡§≤‡§æ‡§á‡§® ‡§∏‡•à‡§≤‡•Ç‡§® ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°, ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏‡•á‡§∏ ‡§î‡§∞ ‡§¨‡§∞‡•ç‡§•‡§°‡•á ‡§ï‡•ã ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§ó‡•Ä)
    if (typeof loadSaloonAI === 'function') {
        await loadSaloonAI(); 
    }

    // ============================================================
    // üöÄüî• SPECIAL CHECK: SALON ONLY (NEW UPDATION)
    // ============================================================
    const userType = AppState.user?.businessType; 
    
    // Salon ‡§ï‡•á ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞‡•ç‡§∏ IDs (HTML ‡§Æ‡•á‡§Ç ‡§Ø‡•á ‡§π‡•ã‡§®‡•á ‡§ö‡§æ‡§π‡§ø‡§è)
    const salonBox = document.getElementById('ai-saloon-box');
    const salonDash = document.getElementById('ai-saloon');

    if (userType === 'SALON') {
        // ‡§Ö‡§ó‡§∞ ‡§∏‡•à‡§≤‡•Ç‡§® ‡§π‡•à, ‡§§‡•ã ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
        if (salonBox) salonBox.style.display = 'block';
        if (salonDash) salonDash.style.display = 'block';
    } else {
        // ‡§Ö‡§ó‡§∞ ‡§∏‡•à‡§≤‡•Ç‡§® ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à (‡§ú‡•à‡§∏‡•á Paint, Mobile), ‡§§‡•ã ‡§õ‡•Å‡§™‡§æ ‡§¶‡•á‡§Ç
        if (salonBox) salonBox.style.display = 'none';
        if (salonDash) salonDash.style.display = 'none';
    }
    // ============================================================

  } catch (err) {
    alert("AI Error: " + err.message);
    console.error(err);
  }
}            
            /* =============== SECTION 1 =============== */
            function renderBusinessHealth(stock) {
  const el = document.getElementById("ai-health-content");

  const fast = stock.insights.fast_moving.length;
  const dead = stock.insights.dead_stock.length;

  // Business score logic
  let score = 100;
  score -= dead * 5;
  score += fast * 3;
  if(score<20) score=20;

  el.innerHTML = `
    <div class="ai-health-card">
      <div class="ai-score-circle">${score}</div>
      <div class="ai-health-meta">
        <p><b>‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞ ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø:</b> ${score >=80 ? "‡§¨‡§π‡•Å‡§§ ‡§Ö‡§ö‡•ç‡§õ‡§æ" : "‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø"}</p>
        <p>‡§§‡•á‡§ú‡•Ä ‡§∏‡•á ‡§¨‡§ø‡§ï‡§®‡•á ‡§µ‡§æ‡§≤‡•á ‡§∏‡§æ‡§Æ‡§æ‡§®: <b>${fast}</b></p>
        <p>‡§´‡§Å‡§∏‡§æ ‡§π‡•Å‡§Ü ‡§∏‡•ç‡§ü‡•â‡§ï: <b>${dead}</b></p>
      </div>
    </div>
  `;
}
            
            /* =============== SECTION 2 =============== */
            function renderCustomerIntel(data){
  const el=document.getElementById("ai-customer-content");

  let html="";

  data.customers.forEach(c=>{

    // ‡§∏‡§¨‡§∏‡•á ‡§ú‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§ñ‡§∞‡•Ä‡§¶‡•Ä ‡§ó‡§à ‡§µ‡§∏‡•ç‡§§‡•Å ‡§¢‡•Ç‡§Ç‡§¢‡•á‡§Ç
    let topItem = "-";
    let topCount = 0;
    c.items.forEach(it=>{
      if(it.buy_count > topCount){
        topItem = it.name;
        topCount = it.buy_count;
      }
    });

    html+=`
      <div class="ai-card-alert ai-alert-info">
        <div>
          <b>${c.name}</b><br>
          ‡§Ü‡§ñ‡§∞‡•Ä ‡§ñ‡§∞‡•Ä‡§¶: ${c.last_buy ? c.last_buy.split("T")[0] : "‚Äî"}<br>
          ‡§∏‡§¨‡§∏‡•á ‡§ú‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§ñ‡§∞‡•Ä‡§¶‡§æ: <b>${topItem}</b>
        </div>
        <span class="ai-badge ai-badge-blue">${c.items.length} ‡§™‡•ç‡§∞‡•ã‡§°‡§ï‡•ç‡§ü‡•ç‡§∏</span>
      </div>
    `;
  });

  html += `<p class='text-muted-small'>‡§∏‡§≤‡§æ‡§π: ‡§ü‡•â‡§™ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï‡•ã‡§Ç ‡§ï‡•ã 2% ‡§°‡§ø‡§∏‡•ç‡§ï‡§æ‡§â‡§Ç‡§ü ‡§ë‡§´‡§º‡§∞ ‡§≠‡•á‡§ú‡•á‡§Ç‡•§</p>`;
  el.innerHTML=html;
}

            
            /* =============== SECTION 3 =============== */
            function renderProductIntel(pData, stockData){
  const el=document.getElementById("ai-product-content");
  let html="";

  const fast = stockData.insights.fast_moving;
  const dead = stockData.insights.dead_stock;

  if(fast.length){
    html+=`<h4>üöÄ ‡§§‡•á‡§ú‡§º‡•Ä ‡§∏‡•á ‡§¨‡§ø‡§ï‡§®‡•á ‡§µ‡§æ‡§≤‡•á ‡§™‡•ç‡§∞‡•ã‡§°‡§ï‡•ç‡§ü</h4>`;
    fast.forEach(f=>{
      html+=`
        <div class="ai-card-alert ai-alert-warning">
          <div><b>${f.title}</b><br>${f.text}</div>
        </div>`;
    });
  }

  if(dead.length){
    html+=`<h4>üõë ‡§® ‡§¨‡§ø‡§ï‡§®‡•á ‡§µ‡§æ‡§≤‡§æ (Dead) ‡§∏‡•ç‡§ü‡•â‡§ï</h4>`;
    dead.forEach(d=>{
      html+=`
        <div class="ai-card-alert ai-alert-danger">
          <div><b>${d.title}</b><br>${d.text}</div>
        </div>`;
    });
  }

  if(!fast.length && !dead.length){
    html+="<p>‡§∏‡§≠‡•Ä ‡§™‡•ç‡§∞‡•ã‡§°‡§ï‡•ç‡§ü ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§® ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‡•§</p>";
  }

  el.innerHTML=html;
}
            
            /* =============== SECTION 4 =============== */
            function renderFestivalStrategy(pData){
  const el=document.getElementById("ai-festival-content");

  const month = new Date().getMonth()+1;
  let festival = "‡§Ü‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§§‡•ç‡§Ø‡•å‡§π‡§æ‡§∞";

  if(month===10) festival="‡§¶‡•Ä‡§µ‡§æ‡§≤‡•Ä";
  if(month===3) festival="‡§π‡•ã‡§≤‡•Ä";
  if(month===12) festival="‡§®‡§Ø‡§æ ‡§∏‡§æ‡§≤";

  el.innerHTML=`
    <div class="ai-card-alert ai-alert-info">
      <div>
        <b>${festival} ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§∞‡§£‡§®‡•Ä‡§§‡§ø</b><br>
        ‚Ä¢ ‡§§‡•á‡§ú‡§º‡•Ä ‡§∏‡•á ‡§¨‡§ø‡§ï‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§∏‡•ç‡§ü‡•â‡§ï ‡§¨‡§¢‡§º‡§æ‡§è‡§Å<br>
        ‚Ä¢ WhatsApp ‡§™‡§∞ 10% OFF ‡§ï‡•Ç‡§™‡§® ‡§≠‡•á‡§ú‡•á‡§Ç<br>
        ‚Ä¢ Dead stock ‡§™‡§∞ Buy 1 Get 1 ‡§ë‡§´‡§∞ ‡§∞‡§ñ‡•á‡§Ç
      </div>
    </div>`;
}
            
            /* =============== SECTION 5 =============== */
            function renderMarketingIdeas(pData){
  const el=document.getElementById("ai-marketing-content");

  el.innerHTML = `
    <div class="ai-card-alert ai-alert-info">
      <div>
        <b>‡§á‡§∏ ‡§∏‡§™‡•ç‡§§‡§æ‡§π ‡§ï‡•Ä ‡§Æ‡§æ‡§∞‡•ç‡§ï‡•á‡§ü‡§ø‡§Ç‡§ó ‡§∞‡§£‡§®‡•Ä‡§§‡§ø</b><br>
        ‚Ä¢ Fast Moving items ‡§ï‡§æ Reel ‡§¨‡§®‡§æ‡§è‡§Ç<br>
        ‚Ä¢ Dead Stock ‡§™‡§∞ ‚Äú‡§ß‡•Ä‡§Æ‡•Ä ‡§ï‡•Ä‡§Æ‡§§‡•á‡§Ç‚Äù ‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç<br>
        ‚Ä¢ ‡§π‡§∞ ‡§¶‡•Ç‡§∏‡§∞‡•á ‡§¶‡§ø‡§® ‡§è‡§ï ‡§õ‡•ã‡§ü‡§æ ‡§ê‡§° ‡§ö‡§≤‡§æ‡§è‡§Å<br>
      </div>
    </div>
    <p class="text-muted-small">AI ‡§∏‡•Å‡§ù‡§æ‡§µ: ‡§∂‡§æ‡§Æ 6‚Äì9 ‡§¨‡§ú‡•á ‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§</p>
  `;
}
            
            /* =============== SECTION 6 =============== */
            function renderPrediction(data){
  const el=document.getElementById("ai-prediction-content");

  const labels = data.sales.map(r=>r.day);
  const values = data.sales.map(r=>Number(r.total_sales));

  el.innerHTML=`<canvas id="salesPredictionChart" class="ai-chart"></canvas>`;
  const ctx=document.getElementById("salesPredictionChart").getContext("2d");

  new Chart(ctx,{
    type:"line",
    data:{
      labels:labels,
      datasets:[{
        label:"‡§™‡§ø‡§õ‡§≤‡•á 30 ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§ï‡•Ä ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä",
        data:values,
        borderColor:"#007bff",
        backgroundColor:"rgba(0,123,255,0.1)",
        fill:true,
        tension:0.3
      }]
    },
    options:{ plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });
}

function renderWhatsappAdvisor(data){
  const el = document.getElementById("ai-marketing-content");

  let html = `<h4>üì≤ WhatsApp ‡§ë‡§ü‡•ã ‡§Æ‡•à‡§∏‡•á‡§ú‡§ø‡§Ç‡§ó</h4>`;

  data.clients.forEach(c => {
    const last = c.last_purchase ? c.last_purchase.split("T")[0] : "‚Äî";
    const inactiveDays = c.last_purchase ? 
        Math.floor((Date.now() - new Date(c.last_purchase)) / (1000*60*60*24)) : 999;

    // Personalized Message
    let msg = `‡§®‡§Æ‡§∏‡•ç‡§§‡•á ${c.name}, 
‡§Ü‡§™‡§ï‡•Ä ‡§™‡§ø‡§õ‡§≤‡•Ä ‡§ñ‡§∞‡•Ä‡§¶‡•Ä (${c.last_item || "‚Äî"}) ‡§ï‡•ã ‡§ï‡§æ‡§´‡§º‡•Ä ‡§∏‡§Æ‡§Ø ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§ 
‡§Ü‡§ú ‡§Ü‡§™‡§ï‡•á ‡§≤‡§ø‡§è 5% ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§õ‡•Ç‡§ü ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§π‡•à‡•§ 
‡§Ö‡§ó‡§∞ ‡§Ü‡§™‡§ï‡•ã ‡§ï‡•Å‡§õ ‡§ö‡§æ‡§π‡§ø‡§è ‡§§‡•ã ‡§∞‡§ø‡§™‡•ç‡§≤‡§æ‡§à ‡§ï‡§∞‡•á‡§Ç‡•§`;

    html += `
      <div class="ai-card-alert ai-alert-info">
        <div>
            <b>${c.name}</b> (${c.phone || "‡§®‡§Ç‡§¨‡§∞ ‡§®‡§π‡•Ä‡§Ç"})
            <br>‡§Ü‡§ñ‡§º‡§∞‡•Ä ‡§ñ‡§∞‡•Ä‡§¶‡•Ä: ${last}
            <br>Inactive: <b>${inactiveDays} ‡§¶‡§ø‡§®</b>
        </div>
        <button 
            onclick="sendWhatsapp('${c.phone}','${encodeURIComponent(msg)}')"
            class="ai-refresh-btn"
            style="padding:6px 12px;font-size:0.8rem;">
            WhatsApp ‡§≠‡•á‡§ú‡•á‡§Ç
        </button>
      </div>
    `;
  });

  el.innerHTML = html + `
    <p class='text-muted-small'>
    AI ‡§∏‡•Å‡§ù‡§æ‡§µ: Inactive ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï‡•ã‡§Ç ‡§ï‡•ã ‡§π‡§≤‡•ç‡§ï‡§æ ‡§ë‡§´‡§º‡§∞ ‡§¶‡•á‡§®‡§æ ‡§∏‡§¨‡§∏‡•á ‡§Ö‡§ö‡•ç‡§õ‡•á results ‡§¶‡•á‡§§‡§æ ‡§π‡•à‡•§
    </p>
  `;
}


function renderCustomerProbability(data){
  const el = document.getElementById("ai-customer-content");

  let html = `<h4>üî• ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ñ‡§∞‡•Ä‡§¶‡§®‡•á ‡§ï‡•Ä ‡§∏‡§Ç‡§≠‡§æ‡§µ‡§®‡§æ (AI Prediction)</h4>`;

  data.customers.forEach(c => {

    const color = c.probability >= 70 ? "ai-badge-green" :
                  c.probability >= 40 ? "ai-badge-yellow" :
                  "ai-badge-red";

    const msg = `‡§®‡§Æ‡§∏‡•ç‡§§‡•á ${c.name}, ‡§Ü‡§™‡§ï‡•ã ${c.frequent_item} ‡§™‡§∞ ${
        c.offer.includes("%") ? "‡§µ‡§ø‡§∂‡•á‡§∑ "+c.offer : ""
    } ‡§ë‡§´‡§º‡§∞ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§π‡•à‡•§`;

    html += `
      <div class="ai-card-alert ai-alert-info">
        <div>
           <b>${c.name}</b><br>
           ‡§Ü‡§ñ‡§∞‡•Ä ‡§ñ‡§∞‡•Ä‡§¶‡•Ä: ${c.last_purchase ? c.last_purchase.split("T")[0] : "‚Äî"}<br>
           ‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§∏‡§æ‡§Æ‡§æ‡§®: <b>${c.frequent_item || "‚Äî"}</b><br>
           ‡§∏‡§≤‡§æ‡§π: ${c.offer}
        </div>

        <div style="text-align:right;">
          <span class="ai-badge ${color}" style="margin-bottom:5px;">
            ${c.probability}% ‡§∏‡§Ç‡§≠‡§æ‡§µ‡§®‡§æ
          </span>
          <br>
          <button 
            onclick="sendWhatsapp('${c.phone}', '${encodeURIComponent(msg)}')"
            class="ai-refresh-btn"
            style="padding:6px 10px;font-size:0.8rem;">
            WP ‡§≠‡•á‡§ú‡•á‡§Ç
          </button>
        </div>
      </div>
    `;
  });

  el.innerHTML = html + `
    <p class="text-muted-small">
      AI ‡§∏‡•Å‡§ù‡§æ‡§µ: High-probability ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï‡•ã‡§Ç ‡§ï‡•ã ‡§π‡§≤‡•ç‡§ï‡§æ ‡§ë‡§´‡§º‡§∞ ‡§¶‡•á‡§Ç‡•§
    </p>`;
}


function sendWhatsapp(phone, msg){
  if(!phone || phone=="null"){
    return alert("‡§á‡§∏ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§∏‡•á‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§");
  }
  window.open(`https://wa.me/91${phone}?text=${msg}`, "_blank");
}


function renderMonthlyStrategy(data){
  const el = document.getElementById("ai-festival-content");
  if(!data || !data.success){
    el.innerHTML = `<div class="ai-card-alert ai-alert-danger">‡§Æ‡§π‡•Ä‡§®‡•á ‡§ï‡•Ä ‡§∞‡§£‡§®‡•Ä‡§§‡§ø ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡•Ä‡•§</div>`;
    return;
  }

  const d = data;
  const topCats = (d.top_categories || []).map(t=>`${t.category} (‚Çπ${t.revenue})`).join(', ') || '‚Äî';
  const fastList = (d.fast_movers || []).slice(0,6).map(f=>`${f.name} (${f.current_qty} stk)`).join(', ') || '‚Äî';
  const deadList = (d.dead_stock || []).slice(0,6).map(x=>`${x.name} (${x.current_qty})`).join(', ') || '‚Äî';

  let html = `
    <div class="ai-card">
      <h4>üìÖ ${d.month} / ${d.year} ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§Ç‡§ï‡•ç‡§∑‡•á‡§™ ‡§∞‡§£‡§®‡•Ä‡§§‡§ø</h4>
      <p><b>‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®‡§ø‡§§ ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä:</b> ‚Çπ${d.forecast_month_amount}</p>
      <p><b>‡§¶‡§ø‡§® ‡§ï‡§æ ‡§î‡§∏‡§§ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä (‡§™‡§ø‡§õ‡§≤‡•á 30d):</b> ‚Çπ${d.avg_daily_sales}</p>
      <p><b>‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä (Top):</b> ${topCats}</p>
      <p><b>‡§§‡•á‡§ú‡§º‡•Ä ‡§∏‡•á ‡§¨‡§ø‡§ï‡§®‡•á ‡§µ‡§æ‡§≤‡•á (Top):</b> ${fastList}</p>
      <p><b>Dead stock (‡§®‡§ø‡§ï‡§≤‡§µ‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è):</b> ${deadList}</p>
      <hr>
      <h5>üì£ Campaign Calendar (Weekly)</h5>
      <ul>
        ${ (d.campaign_calendar || []).map(c => `<li><b>Week ${c.week}:</b> ${c.action}</li>`).join('') }
      </ul>
      <hr>
      <h5>üéâ ‡§§‡•ç‡§Ø‡•ã‡§π‡§æ‡§∞</h5>
      <p>${ (d.festivals && d.festivals.length) ? d.festivals.join(', ') : '‡§ï‡•ã‡§à ‡§™‡•ç‡§∞‡§Æ‡•Å‡§ñ ‡§§‡•ç‡§Ø‡•å‡§π‡§æ‡§∞ ‡§®‡§π‡•Ä‡§Ç' }</p>

      <h5>üîß Reorder ‡§∏‡•Å‡§ù‡§æ‡§µ (Top 6)</h5>
      <table class="ai-mini-table">
        <thead><tr><th>Item</th><th>Current</th><th>Suggest</th></tr></thead>
        <tbody>
          ${ (d.reorder || []).slice(0,6).map(r => `<tr><td>${r.name}</td><td>${r.current_qty}</td><td>${r.suggested_reorder}</td></tr>`).join('') }
        </tbody>
      </table>

      <hr>
      <p><b>AI ‡§∏‡•Å‡§ù‡§æ‡§µ ‚Äî ‡§∏‡§Ç‡§ï‡•ç‡§∑‡•á‡§™:</b><br> ${ (d.strategy_text || '').replace(/\n/g,'<br>') }</p>
    </div>
  `;

  el.innerHTML = html;
}


    



          
async function renderFestivalStrategy() {
  const box = document.getElementById('ai-festival-content');
  if (!box) return;
  box.innerHTML = `
    <div style="padding:30px; text-align:center;">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2">‡§§‡•ç‡§Ø‡•ã‡§π‡§æ‡§∞ ‡§∞‡§£‡§®‡•Ä‡§§‡§ø ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à...</p>
    </div>
  `;

  try {
    const res = await fetchApi('/api/ai/festival-strategy', { method: 'GET' });
    if (!res || !res.success) {
      box.innerHTML = `<div class="alert alert-warning">${(res && res.message) ? res.message : '‡§§‡•Ä‡§∞‡•ç‡§• ‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§'}</div>`;
      return;
    }

    const festivals = res.festivals || [];
    if (!festivals.length) {
      box.innerHTML = `<div class="p-3">‡§ï‡•ã‡§à festival data ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</div>`;
      return;
    }

    // Build HTML
    let html = `<div class="festival-grid" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:16px;">`;

    festivals.forEach(f => {
      html += `
        <div class="card" style="padding:15px; border-radius:8px; box-shadow:var(--card-shadow); background:#fff;">
          <h5 style="margin:0 0 6px 0;">${f.name} ‚Äî Next: ${f.nextDate}</h5>
          <p style="margin:0 0 8px 0; color:#666; font-size:0.9rem;">Top products (by festival lift)</p>
          <div style="font-size:0.9rem; color:#333; line-height:1.4;">
            ${ (f.topProducts && f.topProducts.length) ? f.topProducts.slice(0,6).map(p => `
              <div style="padding:6px 0; border-bottom:1px dashed #eee;">
                <b>${shortText(p.name || p.sku, 33)}</b><br>
                lift: ${p.liftPercent}% ‚Ä¢ estRevenue: ‚Çπ${p.revenue} ‚Ä¢ samples:${p.samples}
              </div>
            `).join('') : `<div style="color:#888">No clear winners</div>` }
          </div>

          <div style="margin-top:10px; font-size:0.9rem; color:#444;">
            <b>Suggestions:</b>
            <pre style="white-space:pre-wrap; font-family:inherit; font-size:0.9rem; background:#f8f9fa; padding:8px; border-radius:6px;">${f.recommendationText || 'No suggestions'}</pre>
          </div>

          <div style="display:flex; gap:8px; margin-top:10px;">
            <button class="btn btn-sm btn-primary" onclick='createWhatsAppCampaign(${JSON.stringify(f.suggestions || []).replace(/'/g,"\\'")})'>WhatsApp Campaign</button>
            <button class="btn btn-sm btn-outline-secondary" onclick='showPurchasePlan(${JSON.stringify(f.suggestions || []).replace(/'/g,"\\'")})'>Purchase Plan</button>
          </div>
        </div>
      `;
    });

    html += `</div>`;
    box.innerHTML = html;

  } catch (err) {
    box.innerHTML = `<div class="alert alert-danger">‡§è‡§∞‡§∞: ${err.message}</div>`;
  }
}

// small helper for UI
function shortText(s, n=40){ if(!s) return ''; return (s.length>n)? s.slice(0,n-1)+'‚Ä¶':s; }

// Action handlers (example - frontend helpers)
function createWhatsAppCampaign(suggestions) {
  // suggestions = [{sku, suggestedQty, liftPercent, revenue}, ...]
  // Build a simple message and open wa share (demo)
  if(!suggestions || !suggestions.length) {
    alert('‡§ï‡•ã‡§à ‡§∏‡•Å‡§ù‡§æ‡§µ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç‡•§');
    return;
  }
  const top = suggestions[0];
  const msg = `Special Offer: ‡§á‡§∏ ${top.sku} ‡§™‡§∞ ‡§∏‡•Ä‡§Æ‡§ø‡§§ ‡§∏‡§Æ‡§Ø ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ë‡§´‡§º‡§∞ ‡§∞‡§ñ‡•á‡§Ç ‚Äî ‡§∏‡§ø‡§∞‡•ç‡§´ ${top.suggestedQty} ‡§Ø‡•Ç‡§®‡§ø‡§ü ‡§∞‡•á‡§ï‡•ã‡§Æ‡•á‡§Ç‡§° ‡§ï‡§ø‡§è ‡§ó‡§è‡•§ ‡§ú‡§≤‡•ç‡§¶‡•Ä ‡§Ü‡§á‡§è!`;
  // For demo: open WhatsApp (phone number optional) - user will edit before send
  const waUrl = `https://web.whatsapp.com/send?text=${encodeURIComponent(msg)}`;
  window.open(waUrl, '_blank');
}

function showPurchasePlan(suggestions) {
  if(!suggestions || !suggestions.length) {
    alert('‡§ï‡•ã‡§à ‡§∏‡•Å‡§ù‡§æ‡§µ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç‡•§');
    return;
  }
  let txt = 'Suggested purchase plan (1-week buffer):\n\n';
  suggestions.forEach(s =>{
    txt += `SKU:${s.sku} ‚Üí Qty: ${s.suggestedQty} (lift:${s.liftPercent}%)\n`;
  });
  alert(txt);
}

// Optionally call this on load of AI insights (if you have a global loader)
document.querySelector('[data-view="ai-insights"]')?.addEventListener('click', () => {
  // When AI Insights tab clicked, also render festival strategy
  // (you might already call renderAiInsightsV2; ensure this is included)
  renderFestivalStrategy();
});




async function renderMarketingAI() {
  const box = document.getElementById('ai-marketing-content');
  if (!box) return;
  box.innerHTML = `
    <div style="padding:30px; text-align:center;">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2">Marketing & Ads ideas ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§ø‡§è ‡§ú‡§æ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...</p>
    </div>
  `;

  try {
    const res = await fetchApi('/api/ai/marketing-ads', { method: 'GET' });
    if (!res || !res.success) {
      box.innerHTML = `<div class="alert alert-warning">${res && res.message ? res.message : 'No marketing data'}</div>`;
      return;
    }

    const { topProducts, segments, adIdeas, timeframeDays } = res;
    let html = `<div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:12px;">`;

    // Left: Top Products
    html += `<div class="card" style="padding:12px;">
      <h5>Top Products (last ${timeframeDays} days)</h5>
      <ul style="padding-left:16px;">${
        (topProducts && topProducts.length) ? topProducts.slice(0,8).map(p=>`<li><b>${shortText(p.name,40)}</b> ‚Äî sold: ${p.qty} ‚Ä¢ rev: ‚Çπ${p.revenue} ‚Ä¢ avg/day: ${p.avgPerDay}</li>`).join('') : '<li>No data</li>'
      }</ul>
    </div>`;

    // Middle: Segments
    html += `<div class="card" style="padding:12px;">
      <h5>Customer Segments</h5>
      <p><b>Top customers:</b> ${segments.topCustomers.map(c=>shortText(c.name||'‚Äî',20)).join(', ') || '‚Äî'}</p>
      <p><b>At-risk (inactive):</b> ${segments.atRisk.map(c=>shortText(c.name||'‚Äî',20)).join(', ') || '‚Äî'}</p>
      <button class="btn btn-sm btn-primary" onclick="openSegmentDialog()">View segments</button>
    </div>`;

    // Right: Ad Ideas
    html += `<div class="card" style="padding:12px;">
      <h5>Ad Ideas & Campaigns</h5>
      ${adIdeas.map((a,idx)=>`
        <div style="margin-bottom:8px; padding:8px; border-radius:6px; background:#f8f9fa;">
          <b>${a.title}</b>
          <p style="margin:6px 0;">${shortText(a.script || '', 140)}</p>
          <small>Budget ‚âà ‚Çπ${a.budgetSuggestion} ‚Ä¢ expected uplift ‚âà ${a.expectedUpliftPercent}%</small>
          <div style="margin-top:8px; display:flex; gap:8px;">
            <button class="btn btn-sm btn-outline-secondary" onclick='copyText(${JSON.stringify(a.script).replace(/'/g,"\\'")})'>Copy Script</button>
            <button class="btn btn-sm btn-primary" onclick='openWhatsAppForAd(${JSON.stringify(a.script).replace(/'/g,"\\'")})'>Open WhatsApp</button>
            <button class="btn btn-sm btn-success" onclick='createAdCampaign(${JSON.stringify(a).replace(/'/g,"\\'")})'>Create Campaign</button>
          </div>
        </div>
      `).join('')}
    </div>`;

    html += `</div>`;
    box.innerHTML = html;

    // helper small UI functions (ensure these declared globally once)
    window.shortText = (s,n=60) => { if(!s) return ''; return s.length>n? s.slice(0,n-1)+'‚Ä¶': s; };
    window.copyText = txt => {
      navigator.clipboard?.writeText(txt).then(()=> alert('Script copied to clipboard'));
    };
    window.openWhatsAppForAd = (txt) => {
      const url = `https://web.whatsapp.com/send?text=${encodeURIComponent(txt)}`;
      window.open(url,'_blank');
    };
    window.createAdCampaign = (idea) => {
      // Simple demo: store campaign in localStorage or call backend (optional)
      const campaigns = JSON.parse(localStorage.getItem('dp_campaigns' || '[]') || '[]');
      campaigns.push({ idea, created_at: new Date().toISOString() });
      localStorage.setItem('dp_campaigns', JSON.stringify(campaigns));
      alert('Campaign created (demo). Use Campaigns page to review.');
    };

  } catch (err) {
    box.innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
  }
}






async function renderLossFinder() {
  const box = document.getElementById('ai-loss-content');
  if (!box) return;

  box.innerHTML = `
    <div style="padding:24px; text-align:center;">
      <div class="spinner-border text-danger" role="status"></div>
      <p class="mt-2">‡§®‡•Å‡§ï‡§∏‡§æ‡§® ‡§ï‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à...</p>
    </div>
  `;

  try {
    const res = await fetchApi('/api/ai/loss-finder', { method: 'GET' });
    if (!res || !res.success) {
      box.innerHTML = `<div class="alert alert-warning">${res && res.message ? res.message : 'Loss Finder ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§'}</div>`;
      return;
    }

    const s = res.summary || {};
    const rateMistakes = res.rate_mistakes_24h || [];
    const deadStock = res.dead_stock || [];
    const lowMargin = res.low_margin_items || [];
    const excess = res.excess_stock || [];
    const riskyCust = res.risky_customers || [];

    // SUMMARY TOP
    let html = `
      <div class="row g-3">
        <div class="col-md-4">
          <div class="card p-3 border-danger">
            <h6 class="text-danger mb-1">‡§™‡§ø‡§õ‡§≤‡•á 24 ‡§ò‡§Ç‡§ü‡•á ‡§ï‡§æ ‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®‡§ø‡§§ ‡§®‡•Å‡§ï‡§∏‡§æ‡§®</h6>
            <h3 class="mb-0">‚Çπ${s.rate_mistake_loss_24h || 0}</h3>
            <small>‡§ó‡§≤‡§§ rate / ‡§ó‡§≤‡§§ billing ‡§∏‡•á</small>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3 border-warning">
            <h6 class="text-warning mb-1">Dead Stock ‡§Æ‡•á‡§Ç ‡§´‡§Å‡§∏‡§æ ‡§™‡•à‡§∏‡§æ</h6>
            <h3 class="mb-0">‚Çπ${s.dead_stock_locked_value || 0}</h3>
            <small>30+ ‡§¶‡§ø‡§® ‡§∏‡•á ‡§® ‡§¨‡§ø‡§ï‡§®‡•á ‡§µ‡§æ‡§≤‡§æ stock</small>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3 border-info">
            <h6 class="text-info mb-1">‡§â‡§ß‡§æ‡§∞ ‡§™‡§∞ ‡§Ö‡§ü‡§ï‡§æ ‡§π‡•Å‡§Ü ‡§™‡•à‡§∏‡§æ</h6>
            <h3 class="mb-0">‚Çπ${s.risky_customers_outstanding || 0}</h3>
            <small>${s.risky_customers_count || 0} risky ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï</small>
          </div>
        </div>
      </div>

      <hr class="my-3">

      <div class="row g-3">
        <div class="col-md-6">
          <h5>Rate Mistake (‡§™‡§ø‡§õ‡§≤‡•á 24 ‡§ò‡§Ç‡§ü‡•á)</h5>
          <div style="max-height:220px; overflow:auto; font-size:0.9rem;">
            ${
              rateMistakes.length
              ? rateMistakes.map(r => `
                <div style="padding:6px 0; border-bottom:1px dashed #eee;">
                  <b>${r.item_name}</b> (SKU: ${r.sku || '-'})<br>
                  Qty: ${r.qty} ‚Ä¢ P: ‚Çπ${r.purchase_price} ‚Ä¢ S: ‚Çπ${r.sale_price}<br>
                  <span class="text-danger">Loss ‚âà ‚Çπ${r.loss}</span>
                </div>
              `).join('')
              : `<div class="text-muted">‡§™‡§ø‡§õ‡§≤‡•á 24 ‡§ò‡§Ç‡§ü‡•á ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à rate mistake detect ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§à‡•§</div>`
            }
          </div>
        </div>

        <div class="col-md-6">
          <h5>Dead Stock (30+ ‡§¶‡§ø‡§® ‡§∏‡•á ‡§®‡§π‡•Ä‡§Ç ‡§¨‡§ø‡§ï‡§æ)</h5>
          <div style="max-height:220px; overflow:auto; font-size:0.9rem;">
            ${
              deadStock.length
              ? deadStock.map(d => `
                <div style="padding:6px 0; border-bottom:1px dashed #eee;">
                  <b>${d.name}</b> (SKU: ${d.sku || '-'})<br>
                  Qty: ${d.qty} ‚Ä¢ Value: ‚Çπ${d.stock_value}<br>
                  Last Sold: ${d.last_sold_date || '‡§ï‡§≠‡•Ä ‡§®‡§π‡•Ä‡§Ç'}
                </div>
              `).join('')
              : `<div class="text-muted">‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§¨‡§°‡§º‡§æ dead stock ‡§®‡§π‡•Ä‡§Ç ‡§¶‡§ø‡§ñ ‡§∞‡§π‡§æ‡•§</div>`
            }
          </div>
        </div>
      </div>

      <hr class="my-3">

      <div class="row g-3">
        <div class="col-md-6">
          <h5>Low / Zero Profit Items</h5>
          <div style="max-height:220px; overflow:auto; font-size:0.9rem;">
            ${
              lowMargin.length
              ? lowMargin.map(i => `
                <div style="padding:6px 0; border-bottom:1px dashed #eee;">
                  <b>${i.name}</b> (SKU: ${i.sku || '-'})<br>
                  Avg P: ‚Çπ${i.avg_purchase} ‚Ä¢ Avg S: ‚Çπ${i.avg_sale}<br>
                  Margin ‚âà ${i.margin_percent}% ‚Ä¢ Sold Qty: ${i.total_qty}
                </div>
              `).join('')
              : `<div class="text-muted">‡§ï‡•ã‡§à clear low-margin item detect ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü‡•§</div>`
            }
          </div>
        </div>

        <div class="col-md-6">
          <h5>Risky Customers (High Outstanding)</h5>
          <div style="max-height:220px; overflow:auto; font-size:0.9rem;">
            ${
              riskyCust.length
              ? riskyCust.map(c => `
                <div style="padding:6px 0; border-bottom:1px dashed #eee;">
                  <b>${c.name}</b> ‚Ä¢ ‚Çπ${c.balance}<br>
                  ${c.mobile ? `üìû ${c.mobile}` : ''}
                  <button class="btn btn-sm btn-outline-primary ms-2" onclick="openWhatsAppForDue('${(c.mobile||'').replace(/'/g,'')}', '${c.name.replace(/'/g,'')}', ${c.balance})">
                    WhatsApp Reminder
                  </button>
                </div>
              `).join('')
              : `<div class="text-muted">‡§ï‡•ã‡§à high-risk ‡§â‡§ß‡§æ‡§∞ customer ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§</div>`
            }
          </div>
        </div>
      </div>
    `;

    box.innerHTML = html;

  } catch (err) {
    box.innerHTML = `<div class="alert alert-danger">Loss Finder Error: ${err.message}</div>`;
  }
}




// (B) Fetch + render functions
async function fetchCustomerTargeting() {
  try {
    const res = await fetchApi('/api/ai/customer-targeting', { method: 'GET' });
    if (!res.success) throw new Error(res.message || 'No data');
    return res.customers || [];
  } catch (e) {
    console.error('fetchCustomerTargeting error', e);
    return [];
  }
}

function renderCustomerTargeting(customers) {
  const el = document.getElementById('ai-customer-targeting-content');
  if (!customers || !customers.length) {
    el.innerHTML = `<div class="ai-card-alert ai-alert-danger">‡§ï‡•ã‡§à ‡§ü‡§æ‡§∞‡•ç‡§ó‡•á‡§ü ‡§∏‡•Å‡§ù‡§æ‡§µ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç‡•§</div>`;
    return;
  }

  let html = '';
  // top 10 customers by probability
  customers.slice(0, 10).forEach(c => {
    html += `
      <div class="ai-card-alert ${c.will_return_soon ? 'ai-alert-success' : 'ai-alert-info'}">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <b>${c.name}</b> ${c.phone ? `<small>(${c.phone})</small>` : ''}
            <div class="text-muted-small">Last: ${c.last_purchase || '‚Äî'} (${c.days_since_last === null ? '‚Äî' : c.days_since_last + 'd'})</div>
            <div class="text-muted-small">Top: ${c.top_items.map(t=>t.name).join(', ') || '‚Äî'}</div>
          </div>
          <div style="text-align:right;">
            <div class="ai-badge ai-badge-blue">Score: ${c.probability_score}</div>
            <div style="margin-top:6px;">
              <a class="btn btn-sm btn-outline-primary" href="https://wa.me/${c.phone.replace(/[^0-9]/g,'') || ''}?text=${encodeURIComponent(c.suggested_message)}" target="_blank">WhatsApp ‡§≠‡•á‡§ú‡•á‡§Ç</a>
            </div>
          </div>
        </div>
      </div>
    `;
  });

  el.innerHTML = html;
}










// WhatsApp reminder helper (global)
function openWhatsAppForDue(mobile, name, amount){
  if(!mobile){
    alert('‡§á‡§∏ customer ‡§ï‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§∏‡•á‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§');
    return;
  }
  const msg = `Namaste ${name},\\n\\nAapka approximate baki rakam: ‚Çπ${amount}. Kripya apne suvidha anusar jama kar dijiye. Dhanyavaad.`;
  const url = `https://wa.me/91${mobile}?text=${encodeURIComponent(msg)}`;
  window.open(url, '_blank');
}





async function saveShopSettings() {
  // existing settings code...
  const bt = document.getElementById('shop-business-type').value;
  await fetchApi('/api/shop/set-business-type', { method:'POST', body: { business_type: bt }});
  // show success
}


async function saveCustomer() {
  const name = document.getElementById('cust-name').value;
  const phone = document.getElementById('cust-phone').value;
  const address = document.getElementById('cust-address').value;
  const dob = document.getElementById('cust-dob').value || null;

  const res = await fetchApi('/api/customers', {
    method:'POST',
    body: { name, phone, address, dob }
  });

  if(res.success) {
    showMessage('‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ú‡•Å‡§°‡§º ‡§ó‡§Ø‡§æ');
    // refresh customers
    fetchAndRenderCustomers();
  } else {
    showMessage('Error: '+res.message,'danger');
  }
}


// [ ‚úÖ FIXED: ULTRA-PRO Universal Business UI Applicator - ALL 31 TYPES ]
// ‡§Ø‡§π ‡§ï‡•ã‡§° ‡§Ü‡§™‡§ï‡•á ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§®‡§∂‡•â‡§ü ‡§µ‡§æ‡§≤‡•á ‡§∏‡§≠‡•Ä 31 ‡§¨‡§ø‡§ú‡§®‡•á‡§∏ ‡§ü‡§æ‡§á‡§™‡•ç‡§∏ ‡§ï‡•ã ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§
function applyBusinessTypeUI(btype) {
    console.log("Applying UI for Business Type:", btype);

    // 1. ‡§∏‡§¨‡§∏‡•á ‡§™‡§π‡§≤‡•á, ‡§∏‡§≠‡•Ä ‡§∏‡•ç‡§™‡•á‡§∂‡§≤ ‡§¨‡§ø‡§ú‡§®‡•á‡§∏ ‡§µ‡§æ‡§≤‡•á ‡§∏‡•á‡§ï‡•ç‡§∂‡§®/‡§¨‡§ü‡§® ‡§î‡§∞ ‡§Æ‡•â‡§°‡•ç‡§Ø‡•Ç‡§≤ ‡§õ‡•Å‡§™‡§æ ‡§¶‡•á‡§Ç (Global Reset)
    // ‡§Ø‡§π ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§ï‡§ø ‡§™‡§ø‡§õ‡§≤‡•Ä ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§ï‡§æ ‡§ï‡§ö‡§∞‡§æ ‡§∏‡§æ‡§´ ‡§π‡•ã ‡§ú‡§æ‡§è
    document.querySelectorAll('.biz-module').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.paint-only, .salon-only, .mobile-only, .medical-only, .restaurant-only').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.input-group-special').forEach(el => el.style.display = 'none');

    // 2. MASTER CONFIG ‡§∏‡•á ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§≤‡§æ‡§è‡§Ç (main.js ‡§∏‡•á)
    const config = (typeof MASTER_BUSINESS_CONFIG !== 'undefined') ? MASTER_BUSINESS_CONFIG[btype] : null;

    if (!config) {
        console.warn(`Unknown Business Type: ${btype}. Defaulting to Retail view.`);
        return; // ‡§Ö‡§ó‡§∞ ‡§ü‡§æ‡§á‡§™ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ ‡§§‡•ã Retail (Default) ‡§∞‡§ñ‡•á‡§Ç
    }

    // 3. ‡§≤‡•á‡§¨‡§≤‡•ç‡§∏ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç (‡§ú‡•à‡§∏‡•á Customer ‡§ï‡•ã Patient ‡§Ø‡§æ Student ‡§ï‡§π‡§®‡§æ)
    const custLabel = document.querySelector('label[for="pos-customer"]');
    if (custLabel) custLabel.innerText = config.labels.customer || "‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ";
    
    // ‡§∏‡•ç‡§ü‡•â‡§ï ‡§≤‡•á‡§¨‡§≤ ‡§Ö‡§™‡§°‡•á‡§ü (Qty vs Liters vs Boxes)
    const stockQtyLabel = document.querySelector('label[for="stock-quantity"]');
    if(stockQtyLabel) stockQtyLabel.innerText = `‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (${config.labels.stock || 'Qty'})`;

    // 4. ‡§´‡•Ä‡§ö‡§∞‡•ç‡§∏ ‡§ï‡•Ä ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡§Ç
    const features = config.features || [];

    // ============================================================
    // üèóÔ∏è MODULE ACTIVATION LOGIC (For ALL 31 Business Types)
    // ============================================================

    // --- GROUP 1: RETAIL SPECIALS ---
    
 // applyBusinessTypeUI ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§á‡§∏ ‡§π‡§ø‡§∏‡•ç‡§∏‡•á ‡§ï‡•ã ‡§¨‡§¶‡§≤‡•á‡§Ç:

    // --- GROUP 3: HARDWARE & PAINT LOGIC ---
    
    // 1. ‡§Ö‡§ó‡§∞ ‡§™‡•á‡§Ç‡§ü ‡§∂‡•â‡§™ ‡§π‡•à (PAINT_SHOP)
    if (btype === 'PAINT_SHOP') {
        // ‡§™‡•á‡§Ç‡§ü ‡§µ‡§æ‡§≤‡•á ‡§∏‡§æ‡§∞‡•á ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
        document.querySelectorAll('.paint-only').forEach(el => el.style.display = 'block'); // POS ‡§Æ‡•á‡§Ç ‡§™‡•á‡§Ç‡§ü‡§∞ ‡§∏‡•á‡§≤‡•á‡§ï‡•ç‡§ü
        
        if(document.getElementById('module-paint-mixer')) 
            document.getElementById('module-paint-mixer').style.display = 'block'; // ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§™‡§∞ ‡§Æ‡§ø‡§ï‡•ç‡§∏‡§∞
            
        if(document.getElementById('module-paint-estimator')) 
            document.getElementById('module-paint-estimator').style.display = 'block'; // ‡§è‡§∏‡•ç‡§ü‡•Ä‡§Æ‡•á‡§ü‡§∞
            
        if (typeof loadPainters === 'function') loadPainters(); // ‡§™‡•á‡§Ç‡§ü‡§∞ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
        if (typeof fetchAndRenderPaintHistory === 'function') fetchAndRenderPaintHistory();
    } 
    
    // 2. ‡§Ö‡§ó‡§∞ ‡§∏‡§æ‡§¶‡§æ ‡§π‡§æ‡§∞‡•ç‡§°‡§µ‡•á‡§Ø‡§∞ ‡§π‡•à (HARDWARE_GENERAL)
    else if (btype === 'HARDWARE_GENERAL') {
        // --- ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§ï‡•ã‡§° (‡§¨‡§ø‡§®‡§æ ‡§¨‡§¶‡§≤‡§æ‡§µ ‡§ï‡•á) ---
        // ‡§™‡•á‡§Ç‡§ü ‡§µ‡§æ‡§≤‡•Ä ‡§∏‡§æ‡§∞‡•Ä ‡§ö‡•Ä‡§ú‡§º‡•á‡§Ç ‡§ú‡§¨‡§∞‡§¶‡§∏‡•ç‡§§‡•Ä ‡§õ‡•Å‡§™‡§æ ‡§¶‡•á‡§Ç (Force Hide)
        document.querySelectorAll('.paint-only').forEach(el => el.style.display = 'none');
        
        if(document.getElementById('module-paint-mixer')) 
            document.getElementById('module-paint-mixer').style.display = 'none';
            
        if(document.getElementById('module-paint-estimator')) 
            document.getElementById('module-paint-estimator').style.display = 'none';

        // --- ‡§™‡•Å‡§∞‡§æ‡§®‡§æ Delivery Tracker ‡§Ö‡§™‡§°‡•á‡§ü ---
        // ‡§Ø‡§π ‡§´‡§∞‡•ç‡§®‡•Ä‡§ö‡§∞ ‡§µ‡§æ‡§≤‡§æ ‡§π‡•Ä ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§á‡§∏‡•ç‡§§‡•á‡§Æ‡§æ‡§≤ ‡§ï‡§∞‡•á‡§ó‡§æ ‡§≤‡•á‡§ï‡§ø‡§® ‡§π‡§æ‡§∞‡•ç‡§°‡§µ‡•á‡§Ø‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è (Input Box)
        if(document.getElementById('module-furniture-showroom')) {
            document.getElementById('module-furniture-showroom').style.display = 'block';
            
            // ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ö‡§≤‡§æ‡§è‡§Ç (‡§Ö‡§ó‡§∞ ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§π‡•à)
            // üöÄ FIX: ‡§Ø‡§π‡§æ‡§Å setTimeout ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à ‡§§‡§æ‡§ï‡§ø ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§¶‡§ø‡§ñ‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§π‡•Ä ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã
            if(typeof loadDeliveryList === 'function') {
                setTimeout(loadDeliveryList, 1000); 
            }
        }

        // --- üöÄ NEW FIX: "Pending Deliveries" ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§ï‡•ã ‡§Ø‡§π‡§æ‡§Å ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç ---
        // (‡§¨‡§æ‡§ï‡•Ä ‡§ú‡§ó‡§π ‡§Ø‡§π 'biz-module' ‡§ï‡•ç‡§≤‡§æ‡§∏ ‡§ï‡•Ä ‡§µ‡§ú‡§π ‡§∏‡•á ‡§õ‡§ø‡§™‡§æ ‡§∞‡§π‡•á‡§ó‡§æ)
        if(document.getElementById('hardware-delivery-box')) {
            document.getElementById('hardware-delivery-box').style.display = 'block';
        }

        // --- üöÄüî• ‡§®‡§Ø‡§æ ‡§Ö‡§™‡§°‡•á‡§ü (GOD MODE ADDED) ---
        // POS ‡§Æ‡•á‡§Ç Auto-Delivery ‡§î‡§∞ WhatsApp ‡§µ‡§æ‡§≤‡§æ ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
        const godBox = document.getElementById('pos-god-mode-delivery');
        if (godBox) {
            godBox.style.display = 'block';
        }
    }

    // 2. Mobile, Electronics, SIM Store (MOBILE_SHOP, ELECTRONICS, SIM_STORE)
    if (features.includes('imei_scan')) {
        if(document.getElementById('module-imei-scan')) document.getElementById('module-imei-scan').style.display = 'block';
        // ‡§∏‡§∞‡•ç‡§ö ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§Æ‡•á‡§Ç ‡§π‡§ø‡§Ç‡§ü ‡§¶‡•á‡§Ç
        const searchInput = document.getElementById('pos-item-search');
        if(searchInput) searchInput.placeholder = "‡§Ü‡§á‡§ü‡§Æ ‡§ï‡§æ ‡§®‡§æ‡§Æ, SKU ‡§Ø‡§æ IMEI ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡•á‡§Ç...";
    }

    // 3. Furniture Showroom (FURNITURE)
    if (features.includes('delivery_tracking')) {
        if(document.getElementById('module-furniture-showroom')) document.getElementById('module-furniture-showroom').style.display = 'block';
    }

    // 4. Sweet Shop / Bakery (SWEET_SHOP)
    // (‡§á‡§®‡§ï‡§æ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ï‡§æ‡§Æ Expiry ‡§î‡§∞ Manufacturing Date ‡§π‡•à ‡§ú‡•ã ‡§∏‡•ç‡§ü‡•â‡§ï ‡§´‡•â‡§∞‡•ç‡§Æ ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ñ‡•á‡§ó‡§æ)
    if (btype === 'SWEET_SHOP') {
        // ‡§Ö‡§ó‡§∞ ‡§ï‡•ã‡§à ‡§∏‡•ç‡§™‡•á‡§∂‡§≤ ‡§Æ‡•â‡§°‡•ç‡§Ø‡•Ç‡§≤ ‡§π‡•à ‡§§‡•ã ‡§Ø‡§π‡§æ‡§Å ‡§ñ‡•ã‡§≤‡•á‡§Ç
    }

    // --- GROUP 2: MEDICAL & HEALTH ---
    
    // 5-11. Doctors & Labs (DOCTOR_CLINIC, ORTHOPEDIC, DENTIST, SONOGRAPHY, PHYSIOTHERAPY, PATHOLOGY, PHARMACY)
    if (features.includes('prescription_pad') || features.includes('report_templates')) {
        const medMod = document.getElementById('module-prescription-pad');
        if(medMod) {
            medMod.style.display = 'block';
            // ‡§Ø‡§π ‡§ü‡§æ‡§á‡§ü‡§≤ ‡§ï‡•ã ‡§∏‡§π‡•Ä ‡§ï‡§∞‡§§‡§æ ‡§π‡•à (e.g., "Dental Clinic Report")
            const titleEl = document.getElementById('medical-title-text');
            if(titleEl) titleEl.innerText = config.name + " Report";
        }
        if(typeof setupDoctorDashboard === 'function') setupDoctorDashboard(btype);
    }

    // 7. Dentist Special (DENTIST)
    if (features.includes('tooth_chart')) {
        const teethBox = document.getElementById('box-dentist-chart');
        if(teethBox) teethBox.style.display = 'block';
    }

    // 9. Sonography Special (SONOGRAPHY)
    if (btype === 'SONOGRAPHY') {
        const lmpBox = document.getElementById('box-lmp-calc');
        if(lmpBox) lmpBox.style.display = 'block';
    }

    // --- GROUP 3: SERVICES & PERSONAL CARE ---

    // 12. Salon / Spa (SALON)
    if (btype === 'SALON') {
        document.querySelectorAll('.salon-only').forEach(el => el.style.display = '');
        // ‡§®‡•ã‡§ü: Salon ‡§ï‡§æ ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° 'renderDashboard' ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ‡§Æ‡•á‡§Ç ‡§≤‡•ã‡§° ‡§π‡•ã‡§§‡§æ ‡§π‡•à
    }

    // 13. Gym / Fitness (GYM)
    if (features.includes('attendance')) {
        if(document.getElementById('module-gym-access')) document.getElementById('module-gym-access').style.display = 'block';
    }

    // 14. Tailor / Boutique (TAILOR, CLOTHING)
    if (features.includes('tailoring_measurements')) {
        if(document.getElementById('module-tailor-measurements')) document.getElementById('module-tailor-measurements').style.display = 'block';
    }

    // 15. Repairing Center (SERVICE_CENTER)
    if (features.includes('job_card')) {
        if(document.getElementById('module-repair-job')) document.getElementById('module-repair-job').style.display = 'block';
    }

    // --- GROUP 4: HOSPITALITY & FOOD ---

    // 16. Restaurant / Cafe (RESTAURANT)
   // 16. Restaurant / Cafe (RESTAURANT)
    if (features.includes('table_kot')) {
        if(document.getElementById('module-restaurant-kot')) document.getElementById('module-restaurant-kot').style.display = 'block';
        
        // üöÄ FIX: ‡§ï‡§ø‡§ö‡§® ‡§µ‡•ç‡§Ø‡•Ç ‡§∏‡§ø‡§∞‡•ç‡§´ ‡§∞‡•á‡§∏‡•ç‡§ü‡•ã‡§∞‡•á‡§Ç‡§ü ‡§ï‡•ã ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
        if(document.getElementById('standalone-kitchen-view')) document.getElementById('standalone-kitchen-view').style.display = 'block';
        
        loadLiveKOTs();
    }

   // 17. Hotel / Lodging (HOTEL)
   if (features.includes('room_checkin')) {
        if(document.getElementById('module-hotel-management')) 
            document.getElementById('module-hotel-management').style.display = 'block';
        
        // üöÄ FIX: ‡§∞‡•Ç‡§Æ ‡§∏‡•ç‡§ü‡•á‡§ü‡§∏ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§≠‡•Ä ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
        if(document.getElementById('hotel-room-status-section')) 
            document.getElementById('hotel-room-status-section').style.display = 'block';

        if (typeof loadHotelRooms === 'function') loadHotelRooms();
    }
    // 18. Tent House / Rentals (TENT_HOUSE)
    if (features.includes('rental_dates')) {
        // ‡§Ø‡§π ‡§Æ‡•â‡§°‡•ç‡§Ø‡•Ç‡§≤ ‡§∏‡•ç‡§ü‡•â‡§ï ‡§´‡•â‡§∞‡•ç‡§Æ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§¶‡§ø‡§ñ‡§§‡§æ ‡§π‡•à, ‡§≤‡•á‡§ï‡§ø‡§® ‡§Ö‡§ó‡§∞ ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§™‡§∞ ‡§≠‡•Ä ‡§ï‡•Å‡§õ ‡§π‡•à ‡§§‡•ã ‡§Ø‡§π‡§æ‡§Å ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
        // (‡§´‡§ø‡§≤‡§π‡§æ‡§≤ ‡§∏‡•ç‡§ü‡•â‡§ï ‡§´‡•â‡§∞‡•ç‡§Æ ‡§Æ‡•á‡§Ç handled ‡§π‡•à)
    }

    // --- GROUP 5: CONSTRUCTION & TRANSPORT ---

    // 19. Tiles & Ceramic (TILES_CERAMIC)
    if (features.includes('sqft_calc')) {
        // ‡§∏‡•ç‡§ü‡•â‡§ï ‡§´‡•â‡§∞‡•ç‡§Æ ‡§Æ‡•á‡§Ç SqFt ‡§ï‡•à‡§≤‡§ï‡•Å‡§≤‡•á‡§ü‡§∞ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
        if(document.getElementById('module-tiles-calc')) document.getElementById('module-tiles-calc').style.display = 'block';
    }

    // 20. Transport / Logistics (TRANSPORT)
    if (features.includes('trip_management')) {
        if(document.getElementById('module-transport-trip')) document.getElementById('module-transport-trip').style.display = 'block';
    }

    // --- GROUP 6: EDUCATION ---

    // 21. School / Coaching (SCHOOL)
    if (features.includes('fees_management')) {
        if(document.getElementById('module-school-fees')) document.getElementById('module-school-fees').style.display = 'block';
    }

    // --- GROUP 7: FINANCE & OTHERS ---

    // 22-24. Finance Agents (LOAN_DSA, RECOVERY_AGENT, INSURANCE_AGENCY)
    if (features.includes('geo_tagging') || features.includes('commission_calc') || btype === 'RECOVERY_AGENT') {
        if(document.getElementById('module-geo-tagging')) document.getElementById('module-geo-tagging').style.display = 'block';
        if(document.getElementById('module-finance-collection')) document.getElementById('module-finance-collection').style.display = 'block';
        
        const searchInput = document.getElementById('pos-item-search');
        if(searchInput) searchInput.placeholder = "EMI Account, Loan No ‡§Ø‡§æ Policy ‡§ñ‡•ã‡§ú‡•á‡§Ç...";
    }


    // ... (applyBusinessTypeUI ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞, ‡§∏‡§¨‡§∏‡•á ‡§®‡•Ä‡§ö‡•á) ...

    // üöÄ HARDWARE SPECIAL FIX: ‡§®‡§æ‡§Æ ‡§¨‡§¶‡§≤‡•á‡§Ç (Mobile -> Lock)
    if (btype === 'HARDWARE_GENERAL') {
        
        // 1. "Device Model" ‡§ï‡•ã "Item Name" ‡§ï‡§∞‡•á‡§Ç
        const deviceInput = document.getElementById('repair_device');
        if (deviceInput) {
            deviceInput.placeholder = "Item Name (Lock/Safe)";
        }

        // 2. "IMEI / Serial" ‡§ï‡•ã "Key Code / Serial No" ‡§ï‡§∞‡•á‡§Ç
        const imeiInput = document.getElementById('repair_imei');
        if (imeiInput) {
            imeiInput.placeholder = "Key Code / Serial No";
        }

        // 3. "Problem Description" ‡§ï‡•ã "Issue" ‡§ï‡§∞‡•á‡§Ç
        const issueInput = document.getElementById('repair_issue');
        if (issueInput) {
            issueInput.placeholder = "Problem (e.g. Key Stuck, Handle Broken)";
        }
    }


// ============================================================
    // üöÄ GOD MODE VISIBILITY CONTROLLER (FIXED for Retail)
    // ============================================================
    
    // 1. ‡§ú‡§ø‡§® ‡§¨‡§ø‡§ú‡§®‡•á‡§∏ ‡§ï‡•ã ‡§Æ‡§ø‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä/‡§≤‡•á‡§¨‡§∞ ‡§ï‡•Ä ‡§ú‡§∞‡•Ç‡§∞‡§§ ‡§π‡•à ‡§â‡§®‡§ï‡•Ä ‡§≤‡§ø‡§∏‡•ç‡§ü
    const MISTRI_BUSINESS_TYPES = [
        'HARDWARE_GENERAL', 
        'FURNITURE', 
        'TILES_CERAMIC', 
        'ELECTRONICS', 
        'PAINT_SHOP', 
        'TENT_HOUSE', 
        'SERVICE_CENTER',
        'TRANSPORT'
    ];

    // 2. ‡§è‡§≤‡§ø‡§Æ‡•á‡§Ç‡§ü‡•ç‡§∏ ‡§¢‡•Ç‡§Ç‡§¢‡•á‡§Ç (Direct ID ‡§∏‡•á)
    const godModeBox = document.getElementById('pos-god-mode-delivery');
    const mistriInput = document.getElementById('pos_auto_mistri_mobile'); // ‡§Æ‡§ø‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§á‡§®‡§™‡•Å‡§ü
    const mistriCheckbox = document.getElementById('pos_send_mistri_wa'); // ‡§Æ‡§ø‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä ‡§ö‡•á‡§ï‡§¨‡•â‡§ï‡•ç‡§∏

    if (godModeBox) {
        // ‡§∏‡§¨‡§∏‡•á ‡§™‡§π‡§≤‡•á: God Mode ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§ï‡•ã ‡§π‡§Æ‡•á‡§∂‡§æ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç (Customer ‡§ï‡•á ‡§≤‡§ø‡§è)
        godModeBox.style.display = 'block';

        // ‡§Ö‡§¨ ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç: ‡§ï‡•ç‡§Ø‡§æ ‡§Ø‡§π ‡§¨‡§ø‡§ú‡§®‡•á‡§∏ ‡§Æ‡§ø‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä ‡§µ‡§æ‡§≤‡§æ ‡§π‡•à?
        if (MISTRI_BUSINESS_TYPES.includes(btype)) {
            // ‚úÖ ‡§π‡§æ‡§Å: ‡§Æ‡§ø‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä ‡§µ‡§æ‡§≤‡•á ‡§ë‡§™‡•ç‡§∂‡§® ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
            if(mistriInput) {
                mistriInput.style.display = 'block';
                
                // ‡§≤‡•á‡§¨‡§≤ ‡§ï‡•ã ‡§¨‡§ø‡§ú‡§®‡•á‡§∏ ‡§ï‡•á ‡§π‡§ø‡§∏‡§æ‡§¨ ‡§∏‡•á ‡§¨‡§¶‡§≤‡•á‡§Ç (Smart Touch)
                if(btype === 'PAINT_SHOP') mistriInput.placeholder = "Painter Mobile (Optional)";
                else if(btype === 'TRANSPORT') mistriInput.placeholder = "Driver Mobile (Optional)";
                else if(btype === 'ELECTRONICS') mistriInput.placeholder = "Technician Mobile (Optional)";
                else mistriInput.placeholder = "Mistri Mobile (Optional)";
            }
            // ‡§ö‡•á‡§ï‡§¨‡•â‡§ï‡•ç‡§∏ ‡§ï‡•á ‡§™‡•à‡§∞‡•á‡§Ç‡§ü (div) ‡§ï‡•ã ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
            if(mistriCheckbox && mistriCheckbox.closest('.form-check')) {
                mistriCheckbox.closest('.form-check').style.display = 'block';
            }

        } else {
            // ‚ùå ‡§®‡§π‡•Ä‡§Ç (Retail, Medical etc): ‡§Æ‡§ø‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä ‡§µ‡§æ‡§≤‡•á ‡§ë‡§™‡•ç‡§∂‡§® ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‡§õ‡•Å‡§™‡§æ ‡§¶‡•á‡§Ç
            if(mistriInput) mistriInput.style.display = 'none'; // ‡§á‡§®‡§™‡•Å‡§ü ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§ó‡§æ‡§Ø‡§¨
            
            // ‡§ö‡•á‡§ï‡§¨‡•â‡§ï‡•ç‡§∏ ‡§ï‡•á ‡§™‡•à‡§∞‡•á‡§Ç‡§ü (div) ‡§ï‡•ã ‡§õ‡•Å‡§™‡§æ‡§è‡§Ç
            if(mistriCheckbox && mistriCheckbox.closest('.form-check')) {
                mistriCheckbox.closest('.form-check').style.display = 'none';
            }
        }
    }


    // 25-26. Professional Services (ARCHITECT_FIRM, SOFTWARE_COMPANY)
    // ‡§á‡§®‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡•ç‡§ü‡•à‡§Ç‡§°‡§∞‡•ç‡§° ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ ‡§á‡§®‡§µ‡•â‡§á‡§∏‡§ø‡§Ç‡§ó (Service Grid) ‡§Ö‡§™‡§®‡•á ‡§Ü‡§™ ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§Æ‡•á‡§Ç ‡§≤‡•ã‡§° ‡§π‡•ã ‡§ú‡§æ‡§è‡§ó‡•Ä

    console.log(`‚úÖ UI Configured Successfully for: ${config.name}`);
}



// Call this when you need (after applyBusinessTypeUI detects SALON) or on click
// [ ‚úÖ ADVANCED: Salon Dashboard Loader with Graph & Customer List ]

// [ ‚úÖ FIXED: Salon Dashboard Loader (With Date/Time Sorting) ]

async function loadSalonDashboard() {
    let res = null;   // ‚úÖ res ko function scope me lao

    try {
        res = await fetchApi('/api/salon/dashboard');
    } catch (e) {
        console.warn('Salon dashboard failed, continuing UI', e);
        return; // ‚ùó dashboard data nahi aaya, aage ka code mat chalao
    }

    // 2. ‡§ï‡§æ‡§∞‡•ç‡§°‡•ç‡§∏ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
    document.getElementById('salon-today-sales').innerText =
        formatCurrency(res.today_sales || 0);

    document.getElementById('salon-today-appts').innerText =
        (res.appointments || []).length;

    document.getElementById('salon-birthdays-count').innerText =
        res.upcoming_birthdays || 0;

    document.getElementById('salon-low-stock').innerText =
        res.low_stock_count || 0;

    // 3. "Recent Customers / Booking List"
    const custBody = document.getElementById('salon-recent-customers-body');
    const appts = res.appointments || [];

    if (appts.length > 0) {
        custBody.innerHTML = appts.map(a => {
            const dateObj = new Date(a.event_time);
            const today = new Date();
            const isToday = dateObj.toDateString() === today.toDateString();

            const dateStr = dateObj.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
            const timeStr = dateObj.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });

            const dayDisplay = isToday
                ? `<span class="badge bg-success">Today</span>`
                : `<span class="badge bg-warning text-dark">${dateStr}</span>`;

            const typeIcon = a.type === 'SALE'
                ? `<i class="fas fa-check-circle text-success"></i>`
                : `<i class="fas fa-clock text-primary"></i>`;

            const wpMsg = isToday
                ? `‡§®‡§Æ‡§∏‡•ç‡§§‡•á ${a.customer_name}, ‡§Ü‡§™‡§ï‡•Ä ‡§Ü‡§ú ‡§ï‡•Ä ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ${timeStr} ‡§™‡§∞ ‡§π‡•à‡•§`
                : `‡§®‡§Æ‡§∏‡•ç‡§§‡•á ${a.customer_name}, ‡§Ü‡§™‡§ï‡•Ä ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ${dateStr} ‡§ï‡•ã ${timeStr} ‡§™‡§∞ ‡§™‡§ï‡•ç‡§ï‡•Ä ‡§π‡•à‡•§`;

            return `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="me-2">${typeIcon}</div>
                        <div>
                            <div class="fw-bold text-dark">${a.customer_name}</div>
                            <small class="text-muted">${a.service_name || 'Service'}</small>
                        </div>
                    </div>
                </td>
                <td>
                    ${dayDisplay}<br>
                    <small class="fw-bold text-dark">${timeStr}</small>
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <span class="me-2 small">${a.customer_mobile || '--'}</span>
                        <button class="btn btn-sm btn-success py-0 px-2"
                            onclick="sendWhatsAppMessage('${a.customer_mobile}', '${wpMsg}')">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                    </div>
                </td>
            </tr>`;
        }).join('');
    } else {
        custBody.innerHTML =
            `<tr><td colspan="3" class="text-center text-muted p-3">
                ‡§ï‡•ã‡§à ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§Ø‡§æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§®‡§π‡•Ä‡§Ç‡•§
            </td></tr>`;
    }

    // 4. ‡§ó‡•ç‡§∞‡§æ‡§´ ‡§Ö‡§™‡§°‡•á‡§ü
    renderSalonChart();
}

// --- Salon Chart Function ---
// [ ‚úÖ SOLUTION: Salon Chart Rendering Function ]
// ‡§á‡§∏‡•á renderSalesChart ‡§ï‡•á ‡§†‡•Ä‡§ï ‡§®‡•Ä‡§ö‡•á ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç

let salonChartInstance = null; // ‡§ö‡§æ‡§∞‡•ç‡§ü ‡§ï‡•ã ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§µ‡•á‡§∞‡§ø‡§è‡§¨‡§≤

// [ ‚úÖ FINAL: Premium TradingView Style Chart & Empty State ]

// [ ‚úÖ FINAL: Ultimate TradingView Style Chart ]

// [ ‚úÖ FINAL: Same Design as Retail Dashboard ]

async function renderSalonChart() {
    try {
        // 1. ‡§™‡•Å‡§∞‡§æ‡§®‡•á "Share Market" ‡§µ‡§æ‡§≤‡•á ‡§è‡§≤‡•Ä‡§Æ‡•á‡§Ç‡§ü‡•ç‡§∏ (‡§Ö‡§ó‡§∞ ‡§π‡•à‡§Ç) ‡§§‡•ã ‡§π‡§ü‡§æ ‡§¶‡•á‡§Ç
        const oldHeader = document.getElementById('pro-market-header');
        if (oldHeader) oldHeader.remove();
        const oldEmpty = document.getElementById('pro-empty-state');
        if (oldEmpty) oldEmpty.remove();
        
        // ‡§ï‡•à‡§®‡§µ‡§æ‡§∏ ‡§ï‡•ã ‡§µ‡§æ‡§™‡§∏ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
        const chartCanvas = document.getElementById('salonSalesChart');
        if (!chartCanvas) return;
        chartCanvas.style.display = 'block';

        // 2. ‡§°‡•á‡§ü‡§æ ‡§Æ‡§Ç‡§ó‡§æ‡§è‡§Ç
        const res = await fetchApi('/api/dashboard/sales-by-day?days=30', { method: 'GET' }, null); 

        if (res.success && res.data) {
            const chartData = res.data;
            
            // ‡§°‡•á‡§ü‡§æ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç
            const labels = chartData.map(d => new Date(d.date).toLocaleDateString('hi-IN', { day: 'numeric', month: 'short' }));
            const salesValues = chartData.map(d => d.sales);
            const profitValues = chartData.map(d => d.profit); // ‡§™‡•ç‡§∞‡•â‡§´‡§ø‡§ü ‡§≠‡•Ä ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç‡§ó‡•á

            // ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§ö‡§æ‡§∞‡•ç‡§ü ‡§π‡§ü‡§æ‡§è‡§Ç
            if (window.salonChartInstance) {
                window.salonChartInstance.destroy();
            }

            // 3. ‡§®‡§Ø‡§æ ‡§ö‡§æ‡§∞‡•ç‡§ü ‡§¨‡§®‡§æ‡§è‡§Ç (‡§¨‡§ø‡§≤‡•ç‡§ï‡•Å‡§≤ Retail ‡§ú‡•à‡§∏‡§æ)
            const ctx = chartCanvas.getContext('2d');
            window.salonChartInstance = new Chart(ctx, {
                type: 'line', // ‡§≤‡§æ‡§á‡§® ‡§ö‡§æ‡§∞‡•ç‡§ü
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä (Sales)',
                            data: salesValues,
                            borderColor: 'rgba(0, 180, 216, 1)', // ‡§µ‡§π‡•Ä ‡§®‡•Ä‡§≤‡§æ ‡§∞‡§Ç‡§ó
                            backgroundColor: 'rgba(0, 180, 216, 0.1)',
                            fill: true,
                            tension: 0.3 // ‡§∏‡•ç‡§Æ‡•Ç‡§• ‡§ï‡§∞‡•ç‡§µ
                        },
                        {
                            label: '‡§≤‡§æ‡§≠ (Profit)',
                            data: profitValues,
                            borderColor: 'rgba(26, 188, 156, 1)', // ‡§µ‡§π‡•Ä ‡§π‡§∞‡§æ ‡§∞‡§Ç‡§ó
                            backgroundColor: 'rgba(26, 188, 156, 0.1)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) { return '‚Çπ' + value; }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    }
                }
            });
        }
    } catch (e) {
        console.error("Salon Chart Error:", e);
    }
}

async function openBirthdayList() {
  try {
    const res = await fetchApi('/api/saloon/upcoming-birthdays?days=7', { method:'GET' });
    if(!res.success) throw new Error(res.message || 'No data');

    const area = document.getElementById('salon-birthday-list-area');
    if(!res.customers || !res.customers.length) {
      area.innerHTML = `<div class="p-3">‡§Ö‡§ó‡§≤‡•á 7 ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§ú‡§®‡•ç‡§Æ‡§¶‡§ø‡§® ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</div>`;
      return;
    }

    let html = `<div class="card p-3"><h5>Upcoming Birthdays</h5>`;
    html += res.customers.map(c => `
      <div style="padding:8px 0;border-bottom:1px dashed #eee; display:flex; justify-content:space-between;">
        <div>
          <b>${c.name}</b><br>
          ${c.dob ? 'DOB: ' + c.dob.split('T')[0] : ''} <br>
          ${c.address ? c.address + '<br>' : ''} ${c.mobile ? 'üìû ' + c.mobile : ''}
        </div>
        <div style="text-align:right;">
          <button class="btn btn-sm btn-primary" onclick="sendBirthdayWhatsApp('${(c.mobile||'').replace(/[^0-9]/g,'')}', '${c.name}')">Send WP</button>
        </div>
      </div>
    `).join('');
    html += `</div>`;
    area.innerHTML = html;
  } catch(err) {
    console.error(err);
    alert('Birthday list load error: '+err.message);
  }
}

function sendBirthdayWhatsApp(mobile, name) {
  if(!mobile) return alert('Customer mobile not available');
  const msg = `Happy Birthday ${name}! üéâ Enjoy 20% off on your next salon visit. Book today!`;
  window.open(`https://wa.me/91${mobile}?text=${encodeURIComponent(msg)}`, '_blank');
}



// -----------------------------
// SALOON: Frontend render helpers
// Paste into the same script where other renderX functions exist.
// -----------------------------

async function loadSaloonAI() {
  // Safe fetch: call saloon APIs and render
  try {
    const [dash, services, birthdays] = await Promise.all([
      fetchApi('/api/saloon/dashboard', { method: 'GET' }).catch(()=>({ success:false })),
      fetchApi('/api/saloon/services', { method: 'GET' }).catch(()=>({ success:false })),
      fetchApi('/api/saloon/upcoming-birthdays?days=7', { method: 'GET' }).catch(()=>({ success:false }))
    ]);

    renderSaloonDashboard(dash);
    renderSaloonServices(services);
    renderSaloonBirthdays(birthdays);
  } catch(err){
    console.error('loadSaloonAI error', err);
  }
}

function renderSaloonDashboard(data) {
  const box = document.getElementById('ai-saloon-dashboard');
  if (!box) return;
  if (!data || !data.success) {
    box.innerHTML = `<div class="ai-card-alert ai-alert-danger">Saloon dashboard ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü‡•§</div>`;
    return;
  }

  const appts = data.appointments || [];
  box.innerHTML = `
    <div class="ai-card">
      <h4>Today's Sales: ‚Çπ${data.today_sales || 0} ‚Ä¢ Appointments: ${data.today_appointments || 0}</h4>
      <p>Upcoming Birthdays (7d): <b>${data.upcoming_birthdays || 0}</b></p>
      <hr>
      <h5>Next appointments</h5>
      <div style="max-height:220px; overflow:auto;">
        ${ appts.length ? appts.map(a => `
            <div style="padding:8px 0; border-bottom:1px dashed #eee;">
              <b>${a.customer_name}</b> ‚Ä¢ ${a.service || '-'} ‚Ä¢ ${new Date(a.scheduled_at).toLocaleString()}
              ${a.mobile ? `<br/><small> ${a.mobile}</small>` : ''}
            </div>
          `).join('') : '<div class="text-muted">No upcoming appointments</div>'
        }
      </div>
    </div>
  `;
}

function renderSaloonServices(data) {
  const box = document.getElementById('ai-saloon-services');
  if (!box) return;
  if (!data || !data.success) {
    box.innerHTML = `<div class="ai-card-alert ai-alert-danger">Services data unavailable.</div>`;
    return;
  }

  const list = data.services || [];
  box.innerHTML = `
    <div class="ai-card">
      <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:8px;">
        ${ list.length ? list.map(s => `
            <div style="padding:8px; border-radius:6px; background:#fff; box-shadow:var(--card-shadow);">
              <b>${s.name}</b><br>
              ${s.price ? `Price: ‚Çπ${s.price}` : ''} ${s.duration_minutes ? `‚Ä¢ ${s.duration_minutes}m` : ''}
            </div>
          `).join('') : '<div class="text-muted">No services defined</div>'
        }
      </div>
    </div>
  `;
}

function renderSaloonBirthdays(data) {
  const box = document.getElementById('ai-saloon-birthdays');
  if (!box) return;
  if (!data || !data.success) {
    box.innerHTML = `<div class="ai-card-alert ai-alert-danger">Birthday list unavailable.</div>`;
    return;
  }

  const list = data.customers || [];
  box.innerHTML = `
    <div class="ai-card">
      <div style="max-height:220px; overflow:auto;">
        ${
          list.length ? list.map(c => `
            <div style="padding:8px 0; border-bottom:1px dashed #eee; display:flex; justify-content:space-between; align-items:center;">
              <div>
                <b>${c.name}</b> ${c.mobile ? `<small> ‚Ä¢ ${c.mobile}</small>` : ''}
                <div class="text-muted-small">DOB: ${c.dob ? c.dob.split('T')[0] : '-'}</div>
              </div>
              <div>
                <a class="btn btn-sm btn-outline-primary" href="https://wa.me/91${(c.mobile||'').replace(/[^0-9]/g,'')||''}?text=${encodeURIComponent(`Namaste ${c.name}, Happy Birthday in advance! Enjoy 20% off on your next visit.`)}" target="_blank">Send WP</a>
              </div>
            </div>
          `).join('') : `<div class="text-muted">No upcoming birthdays</div>`
        }
      </div>
    </div>
  `;
}

// Helper: call saloon load from main loadUltimateAI
// -> In loadUltimateAI() add: await loadSaloonAI(); (see below where to insert)




// Add this function near other render* functions (in same script block)
function renderSaloonInsights(data) {
  const box = document.getElementById('ai-saloon-content');
  if(!box) return;

  if(!data || !data.success){
    box.innerHTML = `<div class="ai-card-alert ai-alert-danger">Saloon insights not available.</div>`;
    return;
  }

  const appts = data.appointments || [];
  const repeat = data.repeat_customers || [];
  const topServices = data.top_services || [];
  const noShows = data.no_shows || {no_shows:0,cancelled:0};
  const birthdays = data.upcoming_birthdays || [];
  const todayRev = data.today_revenue || 0;

  let html = `
    <div class="row g-3">
      <div class="col-md-4">
        <div class="card p-3">
          <h6>‡§Ü‡§ú ‡§ï‡•Ä ‡§Ü‡§Æ‡§¶‡§®‡•Ä</h6>
          <h3>‚Çπ${todayRev}</h3>
          <small>Appointments: ${appts.length}</small>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card p-3">
          <h6>No-shows / Cancelled (30d)</h6>
          <p class="mb-0">No-shows: <b>${noShows.no_shows}</b></p>
          <p class="mb-0">Cancelled: <b>${noShows.cancelled}</b></p>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card p-3">
          <h6>Top Services (60d)</h6>
          <ul style="padding-left:16px; margin:0;">
            ${topServices.length ? topServices.map(s=>`<li>${s.service_name} ‚Äî ${s.cnt} bookings ‚Ä¢ ‚Çπ${s.revenue}</li>`).join('') : '<li>‚Äî</li>'}
          </ul>
        </div>
      </div>
    </div>

    <hr>

    <div class="row g-3">
      <div class="col-md-6">
        <h5>Repeat Customers (Top)</h5>
        <div style="max-height:220px; overflow:auto;">
          ${repeat.length ? repeat.map(r=>`
            <div style="padding:6px 0; border-bottom:1px dashed #eee;">
              <b>${r.name}</b> (${r.phone || '‚Äî'}) ‚Äî Visits: ${r.visits} ‚Ä¢ Last: ${r.last_visit ? r.last_visit.split('T')[0] : '‚Äî'}
              <button class="btn btn-sm btn-outline-primary ms-2" onclick="openWhatsAppForSalon('${(r.phone||'').replace(/[^0-9]/g,'')}','${encodeURIComponent('‡§®‡§Æ‡§∏‡•ç‡§§‡•á '+r.name+', ‡§π‡§Æ‡§æ‡§∞‡•á ‡§™‡§æ‡§∏ ‡§Ü‡§™‡§ï‡•á ‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ ‡§™‡§∞ ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§ë‡§´‡§∞ ‡§π‡•à')}')">WhatsApp</button>
            </div>
          `).join('') : `<div class="text-muted">No repeat customers yet.</div>`}
        </div>
      </div>

      <div class="col-md-6">
        <h5>Upcoming Birthdays (7 days)</h5>
        <div style="max-height:220px; overflow:auto;">
          ${birthdays.length ? birthdays.map(b=>`
            <div style="padding:6px 0; border-bottom:1px dashed #eee;">
              <b>${b.name}</b> ‚Ä¢ DOB: ${b.dob ? b.dob.split('T')[0] : '‚Äî'} ‚Ä¢ ${b.phone || ''}
              <button class="btn btn-sm btn-outline-success ms-2" onclick="openWhatsAppForSalon('${(b.phone||'').replace(/[^0-9]/g,'')}','${encodeURIComponent('Happy Birthday '+b.name+'! Special Birthday Offer: 20% off on salon services.')}')">Send Offer</button>
            </div>
          `).join('') : `<div class="text-muted">No birthdays in next 7 days.</div>`}
        </div>
      </div>
    </div>
  `;

  box.innerHTML = html;
}

// helper openWhatsAppForSalon
function openWhatsAppForSalon(mobile, msg){
  if(!mobile) return alert('Mobile missing');
  const url = `https://wa.me/91${mobile}?text=${encodeURIComponent(msg)}`;
  window.open(url, '_blank');
}




// [ ‚úÖ Multiuser.html: Script ‡§ü‡•à‡§ó ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç ]

let currentRecipe = [];

function addRecipeRow() {
    const sku = document.getElementById('recipe-consumable-sku').value;
    const qty = document.getElementById('recipe-qty').value;
    
    if(!sku || !qty) return alert("SKU ‡§î‡§∞ ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ ‡§≠‡§∞‡•á‡§Ç");
    
    currentRecipe.push({ sku, qty });
    renderRecipeList();
    
    // ‡§á‡§®‡§™‡•Å‡§ü ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç
    document.getElementById('recipe-consumable-sku').value = '';
    document.getElementById('recipe-qty').value = '';
}

function renderRecipeList() {
    const list = document.getElementById('recipe-list');
    const input = document.getElementById('stock-recipe-data');
    
    list.innerHTML = currentRecipe.map((r, i) => `
        <div class="d-flex justify-content-between small border-bottom py-1">
            <span>Item: <b>${r.sku}</b>, Qty: <b>${r.qty}</b></span>
            <span class="text-danger cursor-pointer" onclick="currentRecipe.splice(${i},1); renderRecipeList()">√ó</span>
        </div>
    `).join('');
    
    // ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã JSON ‡§∏‡•ç‡§ü‡•ç‡§∞‡§ø‡§Ç‡§ó ‡§¨‡§®‡§æ‡§ï‡§∞ ‡§õ‡§ø‡§™‡•á ‡§π‡•Å‡§è ‡§á‡§®‡§™‡•Å‡§ü ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§≤‡•á‡§Ç ‡§§‡§æ‡§ï‡§ø ‡§´‡•â‡§∞‡•ç‡§Æ ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§π‡•ã ‡§∏‡§ï‡•á
    input.value = JSON.stringify(currentRecipe);
}


// [ ‚úÖ Multiuser.html: ‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç ]

// 1. Modal ‡§ñ‡•ã‡§≤‡§®‡•á ‡§ï‡§æ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
function openAppointmentModal() {
    // ‡§Ü‡§ú ‡§ï‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
    document.getElementById('appt-date').value = new Date().toISOString().split('T')[0];
    
    const modal = new bootstrap.Modal(document.getElementById('appointmentModal'));
    modal.show();
}

// 2. ‡§´‡•â‡§∞‡•ç‡§Æ ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§π‡•ã‡§®‡•á ‡§™‡§∞ (Booking Logic)
document.getElementById('appointment-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const btn = e.target.querySelector('button[type="submit"]');
    const oldText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...';

    const data = {
        name: document.getElementById('appt-name').value,
        mobile: document.getElementById('appt-mobile').value,
        service: document.getElementById('appt-service').value,
        date: document.getElementById('appt-date').value,
        time: document.getElementById('appt-time').value
    };

    try {
        const res = await fetchApi('/api/appointments', { method: 'POST', body: data });
        
        if (res.success) {
            showMessage('‡§∏‡§´‡§≤‡§§‡§æ', res.message, 'success');
            
            // Modal ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç
            const modalEl = document.getElementById('appointmentModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
            
            // ‡§´‡•â‡§∞‡•ç‡§Æ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç
            document.getElementById('appointment-form').reset();
            
            // ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§∞‡•Ä‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç (‡§§‡§æ‡§ï‡§ø ‡§®‡§à ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§¶‡§ø‡§ñ‡•á)
            loadSalonDashboard();
        } else {
            throw new Error(res.message);
        }
    } catch (error) {
        showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', error.message, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = oldText;
    }
});

// ==========================================
// üé® PAINT SHOP LOGIC (The "Brahmastra")
// ==========================================

// 1. Load Painters into Dropdown
async function loadPainters() {
    const select = document.getElementById('pos-painter-select');
    if(!select) return;
    
    try {
        const res = await fetchApi('/api/painters', { method: 'GET' });
        if(res.success) {
            select.innerHTML = '<option value="">-- ‡§ï‡•ã‡§à ‡§™‡•á‡§Ç‡§ü‡§∞ ‡§®‡§π‡•Ä‡§Ç --</option>';
            res.painters.forEach(p => {
                select.innerHTML += `<option value="${p.id}">${p.name} (${p.mobile})</option>`;
            });
        }
    } catch(e) { console.error(e); }
}

// ==========================================
// üé® SAVE FORMULA FUNCTION (DASHBOARD DIARY)
// ==========================================
async function savePaintFormula() {
    // ‡§´‡•â‡§∞‡•ç‡§Æ ‡§∏‡•á ‡§°‡•á‡§ü‡§æ ‡§â‡§†‡§æ‡§è‡§Ç
    const name = document.getElementById('paint_cust_name').value;
    const code = document.getElementById('paint_code').value;
    const base = document.getElementById('paint_base').value;
    const formula = document.getElementById('paint_formula').value;

    if (!name || !code) {
        return showMessage('‡§Ö‡§ß‡•Ç‡§∞‡§æ ‡§°‡•á‡§ü‡§æ', '‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§î‡§∞ ‡§ï‡•ã‡§° ‡§ú‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à‡•§', 'warning');
    }

    const data = {
        customer_name: name,
        color_code: code,
        base_product: base,
        formula_text: formula
    };

    // 2. ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§™‡§∞ ‡§≠‡•á‡§ú‡•á‡§Ç (API Call)
    try {
        const res = await fetchApi('/api/paint/save-formula', { 
            method: 'POST', 
            body: data 
        }, '‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§™‡§∞ ‡§∏‡•á‡§µ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...');

        if (res.success) {
            showMessage('‡§∏‡§´‡§≤‡§§‡§æ', '‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§™‡§∞‡§Æ‡§æ‡§®‡•á‡§Ç‡§ü ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§à!', 'success');
            
            // 3. ‡§´‡•â‡§∞‡•ç‡§Æ ‡§ñ‡§æ‡§≤‡•Ä ‡§ï‡§∞‡•á‡§Ç
            document.getElementById('paint_cust_name').value = '';
            document.getElementById('paint_code').value = '';
            document.getElementById('paint_base').value = '';
            document.getElementById('paint_formula').value = '';

            // 4. ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§ï‡•ã ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç (‡§§‡§æ‡§ï‡§ø ‡§®‡§à ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§¶‡§ø‡§ñ‡•á)
            fetchAndRenderPaintHistory(); 

        } else {
            throw new Error(res.message || '‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§®‡•á ‡§∏‡•á‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ‡•§');
        }
    } catch (e) {
        console.error(e);
        showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§∏‡•á‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü: ${e.message}`, 'danger');
    }
}


// 2. Add New Painter Prompt
async function addNewPainterPrompt() {
    const name = prompt("‡§™‡•á‡§Ç‡§ü‡§∞ ‡§ï‡§æ ‡§®‡§æ‡§Æ:");
    if(!name) return;
    const mobile = prompt("‡§™‡•á‡§Ç‡§ü‡§∞ ‡§ï‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤:");
    
    await fetchApi('/api/painters', { method:'POST', body: { name, mobile } });
    loadPainters(); // Refresh list
    showMessage('Success', 'Painter Added!', 'success');
}

// 3. Paint Estimator Logic (The "Estimate")
function calculatePaintEstimate() {
    const area = parseFloat(document.getElementById('est-area').value);
    if(!area) return alert("Area daalein (Sq.Ft)");

    // Standard Formulas
    const putty = Math.ceil(area / 12); // 1kg covers ~12 sqft (2 coats)
    const primer = Math.ceil(area / 130); // 1L covers ~130 sqft
    const paint = Math.ceil(area / 110); // 1L covers ~110 sqft (2 coats)

    document.getElementById('res-putty').innerText = `${putty} Kg`;
    document.getElementById('res-primer').innerText = `${primer} Liters`;
    document.getElementById('res-paint').innerText = `${paint} Liters`;
    
    document.getElementById('est-result').classList.remove('d-none');
}

function printEstimate() {
    const area = document.getElementById('est-area').value;
    const putty = document.getElementById('res-putty').innerText;
    const primer = document.getElementById('res-primer').innerText;
    const paint = document.getElementById('res-paint').innerText;
    
    const win = window.open('', '', 'width=400,height=400');
    win.document.write(`
        <h3>Paint Estimate (Area: ${area} sq.ft)</h3>
        <hr>
        <p><b>Wall Putty:</b> ${putty}</p>
        <p><b>Primer:</b> ${primer}</p>
        <p><b>Paint (Emulsion):</b> ${paint}</p>
        <hr>
        <small>Generated by Dukan Pro</small>
        <script>window.print();<\/script>
    `);
}

// 4. Mixing Logic (The "Base + Colorant" Problem)
// 1. ‡§¨‡•á‡§∏ ‡§ï‡§æ ‡§¨‡§æ‡§∞‡§ï‡•ã‡§° ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡§§‡•á ‡§π‡•Ä ‡§°‡§ø‡§ü‡•á‡§≤ ‡§Ö‡§™‡§®‡•á ‡§Ü‡§™ ‡§Ü ‡§ú‡§æ‡§è‡§ó‡•Ä
async function fetchBaseDetails(sku) {
    if (!sku) return;
    
    // ‡§∏‡•ç‡§ü‡•â‡§ï ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§Ü‡§á‡§ü‡§Æ ‡§¢‡•Ç‡§Å‡§¢‡•ã
    const item = currentStock.find(s => s.sku === sku);
    
    if (item) {
        document.getElementById('mix-base-name').value = item.name;
        document.getElementById('mix-base-price').value = item.sale_price;
        document.getElementById('mix-stock-status').innerHTML = 
            `<span class="text-success"><i class="fas fa-check"></i> ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•á‡§Ç ‡§â‡§™‡§≤‡§¨‡•ç‡§ß: <b>${item.quantity}</b> ${item.unit}</span>`;
        document.getElementById('mix-stock-status').className = "small text-success";
    } else {
        document.getElementById('mix-stock-status').innerHTML = 
            `<span class="text-danger"><i class="fas fa-times"></i> ‡§Ø‡§π SKU ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ!</span>`;
        document.getElementById('mix-base-name').value = "";
        document.getElementById('mix-base-price').value = "";
    }
}

// 2. ‡§ï‡§æ‡§∞‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§Ö‡§™‡§°‡•á‡§ü‡•á‡§° ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
function addMixedPaintToCart() {
    const baseSku = document.getElementById('mix-base-sku').value;
    const baseName = document.getElementById('mix-base-name').value;
    const basePrice = parseFloat(document.getElementById('mix-base-price').value) || 0;
    const colorCost = parseFloat(document.getElementById('mix-color-cost').value) || 0;
    const colorCode = document.getElementById('mix-code').value;

    if(!baseSku || !baseName) return alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§¨‡•á‡§∏ ‡§¨‡§æ‡§≤‡•ç‡§ü‡•Ä ‡§ï‡§æ SKU ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§°‡§æ‡§≤‡•á‡§Ç‡•§");

    const finalPrice = basePrice + colorCost; 

    // ‡§Ö‡§∏‡§≤‡•Ä ‡§ú‡§æ‡§¶‡•Ç ‡§Ø‡§π‡§æ‡§Å ‡§π‡•à: ‡§π‡§Æ SKU ‡§µ‡§π‡•Ä ‡§∞‡§ñ‡•á‡§Ç‡§ó‡•á ‡§ú‡•ã ‡§¨‡§æ‡§≤‡•ç‡§ü‡•Ä ‡§ï‡§æ ‡§π‡•à, ‡§≤‡•á‡§ï‡§ø‡§® ‡§®‡§æ‡§Æ ‡§î‡§∞ ‡§ï‡•Ä‡§Æ‡§§ ‡§¨‡§¶‡§≤ ‡§¶‡•á‡§Ç‡§ó‡•á
    // ‡§á‡§∏‡§∏‡•á ‡§∏‡•ç‡§ü‡•â‡§ï 'APEX-BASE' ‡§ï‡§æ ‡§π‡•Ä ‡§ï‡§Æ ‡§π‡•ã‡§ó‡§æ!
    const item = {
        sku: baseSku,  // <--- ‡§Ø‡§π ‡§¨‡§æ‡§≤‡•ç‡§ü‡•Ä ‡§ï‡§æ ‡§π‡•Ä SKU ‡§π‡•à
        name: `${baseName} (Mix: ${colorCode})`, // ‡§¨‡§ø‡§≤ ‡§™‡§∞ ‡§®‡§æ‡§Æ ‡§¨‡§¶‡§≤‡§ï‡§∞ ‡§Ü‡§è‡§ó‡§æ
        quantity: 1,
        sale_price: finalPrice, // ‡§ï‡•Ä‡§Æ‡§§ ‡§¨‡§¢‡§º ‡§ó‡§à (‡§¨‡•á‡§∏ + ‡§ï‡§≤‡§∞)
        purchase_price: 0, // (‡§Ø‡§π ‡§¨‡•à‡§ï‡§è‡§Ç‡§° ‡§∏‡•á ‡§Ü ‡§ú‡§æ‡§è‡§ó‡§æ)
        gst: 18,
        product_attributes: { 
            "Type": "Custom Mix", 
            "Colorant Cost": colorCost,
            "Color Code": colorCode
        }
    };

    // ‡§ï‡§æ‡§∞‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§≤‡•á‡§Ç
    addSKUToCartFromMix(item);
    
    // ‡§Æ‡•â‡§°‡§≤ ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç
    const modalEl = document.getElementById('paintMixingModal');
    const modal = bootstrap.Modal.getInstance(modalEl);
    modal.hide();
    
    // ‡§´‡•â‡§∞‡•ç‡§Æ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç
    document.getElementById('mix-base-sku').value = '';
    document.getElementById('mix-base-name').value = '';
    document.getElementById('mix-code').value = '';
    document.getElementById('mix-color-cost').value = '';
    document.getElementById('mix-stock-status').innerText = '';
}

// ‡§Ø‡§π ‡§π‡•á‡§≤‡•ç‡§™‡§∞ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ‡§π‡•à ‡§ú‡•ã ‡§Æ‡§ø‡§ï‡•ç‡§∏ ‡§Ü‡§á‡§ü‡§Æ ‡§ï‡•ã ‡§∏‡•Ä‡§ß‡•á ‡§ï‡§æ‡§∞‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§™‡•Å‡§∂ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
function addSKUToCartFromMix(mixedItem) {
    // ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§∏‡•ç‡§ü‡•â‡§ï ‡§π‡•à ‡§Ø‡§æ ‡§®‡§π‡•Ä‡§Ç
    const stockItem = currentStock.find(s => s.sku === mixedItem.sku);
    if (stockItem && stockItem.quantity < 1) {
        return showMessage('‡§∏‡•ç‡§ü‡•â‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à', '‡§Ø‡§π ‡§¨‡§æ‡§≤‡•ç‡§ü‡•Ä ‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•á‡§Ç ‡§ñ‡§§‡•ç‡§Æ ‡§π‡•ã ‡§ö‡•Å‡§ï‡•Ä ‡§π‡•à!', 'danger');
    }

    // ‡§ï‡§æ‡§∞‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§¢‡•Ç‡§Å‡§¢‡•á‡§Ç
    const existingCartItem = posCart.find(item => item.sku === mixedItem.sku);
    
    if (existingCartItem) {
        // ‡§Ö‡§ó‡§∞ ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§ï‡§æ‡§∞‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§π‡•à, ‡§§‡•ã ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
        existingCartItem.quantity++;
        // ‡§Æ‡§ø‡§ï‡•ç‡§∏‡§ø‡§Ç‡§ó ‡§°‡§ø‡§ü‡•á‡§≤ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç (‡§®‡•ã‡§ü: ‡§è‡§ï ‡§π‡•Ä SKU ‡§ï‡•á ‡§Ö‡§≤‡§ó-‡§Ö‡§≤‡§ó ‡§∞‡§Ç‡§ó ‡§è‡§ï ‡§∏‡§æ‡§• ‡§¨‡§ø‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§§‡•á ‡§á‡§∏ ‡§≤‡•â‡§ú‡§ø‡§ï ‡§Æ‡•á‡§Ç, ‡§ú‡•ã ‡§†‡•Ä‡§ï ‡§π‡•à)
        existingCartItem.name = mixedItem.name;
        existingCartItem.sale_price = mixedItem.sale_price;
    } else {
        // ‡§®‡§Ø‡§æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
        posCart.push(mixedItem);
    }
    updatePOSCartView();
    showMessage('‡§∏‡§´‡§≤‡§§‡§æ', '‡§™‡•á‡§Ç‡§ü ‡§Æ‡§ø‡§ï‡•ç‡§∏ ‡§π‡•ã‡§ï‡§∞ ‡§¨‡§ø‡§≤ ‡§Æ‡•á‡§Ç ‡§ú‡•Å‡§°‡§º ‡§ó‡§Ø‡§æ!', 'success');
}


// ==========================================
// üì∑ NEW: PAINT MIXING SCANNER BUTTON
// ==========================================
function openMobileScannerForMix() {
    console.log("Scanner button clicked for Mixing...");

    // üöÄ NEW: ‡§Æ‡§ø‡§ï‡•ç‡§∏‡§ø‡§Ç‡§ó ‡§Æ‡•ã‡§° ‡§è‡§ï‡•ç‡§ü‡§ø‡§µ ‡§ï‡§∞‡•á‡§Ç
    isMixingModeActive = true; 

    if (isMobile()) {
        console.log("Mobile detected. Opening Local Camera...");
        const paintOtpBox = document.getElementById('paint-otp-box');
        if (paintOtpBox) paintOtpBox.style.display = 'none';
        
        // ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç
        if (typeof startLocalScanner === 'function') {
            startLocalScanner(); 
        } else {
            alert("Error: startLocalScanner function not found!");
        }

    } else {
        console.log("PC detected. Generating OTP...");
        const paintOtpBox = document.getElementById('paint-otp-box');
        const paintSpinner = document.getElementById('paint-otp-spinner');
        const paintCode = document.getElementById('paint-otp-code');
        const paintStatus = document.getElementById('paint-otp-status');

        if (paintOtpBox) {
            paintOtpBox.style.display = 'block';
            if (paintSpinner) paintSpinner.style.display = 'inline-block';
            if (paintCode) paintCode.innerText = '------';
            if (paintStatus) paintStatus.style.display = 'none';
        }

        const posBox = document.getElementById('inline-pairing-box');
        if (posBox) posBox.style.display = 'none';

        if (typeof initPosWebSocket === 'function') {
            initPosWebSocket(); 
        }
    }
}


// ‡§á‡§∏‡•á <script> ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§ï‡§π‡•Ä‡§Ç ‡§≠‡•Ä ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç

    async function fetchAndRenderPaintHistory() {
    const tableBody = document.getElementById('paint-history-body');
    if (!tableBody) return; // ‡§Ö‡§ó‡§∞ ‡§ü‡•á‡§¨‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‡§§‡•ã ‡§∞‡•Å‡§ï ‡§ú‡§æ‡§è‡§Ç

    tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</td></tr>`;

    try {
        // ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§°‡•á‡§ü‡§æ ‡§Æ‡§æ‡§Ç‡§ó‡•á‡§Ç (GET Request)
        const res = await fetchApi('/api/paint/formulas', { method: 'GET' });

        if (res.success && res.formulas && res.formulas.length > 0) {
            // ‡§°‡•á‡§ü‡§æ ‡§Æ‡§ø‡§≤ ‡§ó‡§Ø‡§æ, ‡§Ö‡§¨ ‡§ü‡•á‡§¨‡§≤ ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
            tableBody.innerHTML = res.formulas.map(item => `
                <tr>
                    <td>${new Date(item.created_at).toLocaleDateString('en-IN', { day: 'numeric', month: 'short' })}</td>
                    <td class="fw-bold">${item.customer_name}</td>
                    <td>
                        <span class="badge bg-info text-dark">${item.color_code}</span><br>
                        <small class="text-muted">${item.base_product || ''}</small>
                    </td>
                    <td class="text-danger small fw-bold" style="font-family: monospace;">
                        ${item.formula_text}
                    </td>
                </tr>
            `).join('');
        } else {
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</td></tr>`;
        }
    } catch (e) {
        console.error("History Error:", e);
        tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§æ‡•§</td></tr>`;
    }
}

// [ ‡§á‡§∏‡•á script ‡§ü‡•à‡§ó ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç ]

// Global variable to store current painter ID in view
let currentViewingPainterId = null;

async function viewSelectedPainterLedger() {
    const select = document.getElementById('pos-painter-select');
    const painterId = select.value;
    const painterName = select.options[select.selectedIndex]?.text || 'Unknown';

    if (!painterId) {
        return showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', '‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§∏‡•á ‡§è‡§ï ‡§™‡•á‡§Ç‡§ü‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§', 'warning');
    }

    currentViewingPainterId = painterId; // üöÄ ID ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç ‡§§‡§æ‡§ï‡§ø Pay ‡§¨‡§ü‡§® ‡§ï‡•ã ‡§™‡§§‡§æ ‡§∞‡§π‡•á ‡§ï‡§ø‡§∏‡•á ‡§™‡•à‡§∏‡•á ‡§¶‡•á‡§®‡•á ‡§π‡•à‡§Ç

    const modal = new bootstrap.Modal(document.getElementById('painterLedgerModal'));
    document.getElementById('ledger-painter-name').innerText = painterName + " ‡§ï‡§æ ‡§π‡§ø‡§∏‡§æ‡§¨";
    const tbody = document.getElementById('painter-ledger-body');
    const balDisplay = document.getElementById('painter-current-balance-display'); // üöÄ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á
    
    tbody.innerHTML = `<tr><td colspan="4" class="text-center">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</td></tr>`;
    modal.show();

    try {
        // 1. ‡§≤‡•á‡§ú‡§∞ (‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä) ‡§≤‡§æ‡§è‡§Ç
        const res = await fetchApi(`/api/painters/${painterId}/ledger`, { method: 'GET' });
        
        // 2. ‡§™‡•á‡§Ç‡§ü‡§∞ ‡§ï‡§æ ‡§ï‡§∞‡•ç‡§∞‡•á‡§Ç‡§ü ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§≤‡§æ‡§è‡§Ç (‡§§‡§æ‡§ï‡§ø ‡§™‡§§‡§æ ‡§ö‡§≤‡•á ‡§Ö‡§≠‡•Ä ‡§ï‡§ø‡§§‡§®‡§æ ‡§¶‡•á‡§®‡§æ ‡§¨‡§æ‡§ï‡•Ä ‡§π‡•à)
        // (‡§á‡§∏‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§Æ Painters ‡§≤‡§ø‡§∏‡•ç‡§ü API ‡§ï‡§æ ‡§á‡§∏‡•ç‡§§‡•á‡§Æ‡§æ‡§≤ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§Ø‡§æ ‡§Ö‡§≤‡§ó API)
        const paintersRes = await fetchApi('/api/painters', { method: 'GET' });
        const currentPainter = paintersRes.painters.find(p => p.id == painterId);
        const currentBalance = currentPainter ? parseFloat(currentPainter.commission_balance) : 0;

        // ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
        if(balDisplay) balDisplay.innerText = `‡§ï‡•Å‡§≤ ‡§¨‡§ï‡§æ‡§Ø‡§æ: ${formatCurrency(currentBalance)}`;

        if (res.success && res.history && res.history.length > 0) {
            tbody.innerHTML = '';
            let totalComm = 0;

            res.history.forEach(row => {
                const comm = parseFloat(row.painter_commission_amount || 0);
                totalComm += comm;
                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(row.created_at).toLocaleDateString('en-IN')}</td>
                        <td>#INV-${row.invoice_id}</td>
                        <td>‚Çπ${formatCurrency(row.total_amount).replace('‚Çπ', '')}</td>
                        <td class="text-end fw-bold text-success">+ ‚Çπ${comm.toFixed(2)}</td>
                    </tr>
                `;
            });
            document.getElementById('painter-total-earnings').innerText = formatCurrency(totalComm);
        } else {
            tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">‡§ï‡•ã‡§à ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç‡•§</td></tr>`;
            document.getElementById('painter-total-earnings').innerText = '‚Çπ0.00';
        }
    } catch (e) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.message}</td></tr>`;
    }
}



// üöÄ NEW FUNCTION FOR DAILY REPORTS
async function generateDailyReport() {
    const type = document.getElementById('daily-report-type').value;
    let start = document.getElementById('daily-start-date').value;
    let end = document.getElementById('daily-end-date').value;

    if (!start || !end) {
        const today = new Date().toISOString().split('T')[0];
        if(!start) start = today; if(!end) end = today;
    }

    const tbody = document.getElementById('daily-report-body');
    const thead = document.getElementById('daily-report-head');
    const title = document.getElementById('daily-report-title');

    tbody.innerHTML = `<tr><td colspan="10" class="text-center p-4"><div class="spinner-border text-primary"></div></td></tr>`;

    try {
        const res = await fetchApi('/api/reports/advanced', {
            method: 'POST', body: { reportType: type, startDate: start, endDate: end }
        });

        if (res.success && res.data.length > 0) {
            const data = res.data;
            const columns = Object.keys(data[0]);
            title.innerText = `${type} (${data.length} Rows)`;
            thead.innerHTML = columns.map(col => `<th>${col}</th>`).join('');
            tbody.innerHTML = data.map(row => `<tr>${columns.map(col => `<td>${row[col]}</td>`).join('')}</tr>`).join('');
        } else {
            tbody.innerHTML = `<tr><td colspan="10" class="text-center p-5 text-danger fw-bold">No data found.</td></tr>`;
        }
    } catch (e) {
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="10" class="text-center text-danger">Error: ${e.message}</td></tr>`;
    }
}

// ==========================================
// üöÄ DAILY REPORTS: FILTER & DOWNLOAD LOGIC
// ==========================================

// 1. ‡§™‡•á‡§Ç‡§ü‡§∞ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏ ‡§ï‡•ã ‡§õ‡•Å‡§™‡§æ‡§®‡•á ‡§ï‡§æ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
// filterReportOptions ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ‡§Æ‡•á‡§Ç ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç:

function filterReportOptions() {
    const userType = AppState.user?.businessType; 
    const select = document.getElementById('daily-report-type');
    
    const paintReports = ['PAINTER_COMMISSION', 'PAINT_MIXING_HISTORY'];

    if (select) {
        for (let i = 0; i < select.options.length; i++) {
            const opt = select.options[i];
            
            // üöÄ ‡§¨‡§¶‡§≤‡§æ‡§µ: ‡§Ö‡§¨ ‡§π‡§Æ ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á ‡§ï‡§ø ‡§ü‡§æ‡§á‡§™ 'PAINT_SHOP' ‡§π‡•à ‡§Ø‡§æ ‡§®‡§π‡•Ä‡§Ç
            if (userType !== 'PAINT_SHOP' && paintReports.includes(opt.value)) {
                opt.style.display = 'none'; // ‡§π‡§æ‡§∞‡•ç‡§°‡§µ‡•á‡§Ø‡§∞ ‡§µ‡§æ‡§≤‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ó‡§æ‡§Ø‡§¨
                opt.disabled = true;
            } else {
                opt.style.display = 'block'; // ‡§™‡•á‡§Ç‡§ü ‡§µ‡§æ‡§≤‡•ã‡§Ç ‡§ï‡•ã ‡§¶‡§ø‡§ñ‡•á‡§ó‡§æ
                opt.disabled = false;
            }
        }
    }
}

// 2. Excel ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
async function downloadDailyReportExcel() {
    const type = document.getElementById('daily-report-type').value;
    let start = document.getElementById('daily-start-date').value;
    let end = document.getElementById('daily-end-date').value;

    if (!type) return showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', '‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ö‡•Å‡§®‡•á‡§Ç‡•§', 'warning');

    // ‡§Ö‡§ó‡§∞ ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§®‡§π‡•Ä‡§Ç ‡§ö‡•Å‡§®‡•Ä, ‡§§‡•ã ‡§Ü‡§ú ‡§ï‡•Ä ‡§≤‡•á ‡§≤‡•ã
    if (!start || !end) {
        const today = new Date().toISOString().split('T')[0];
        if(!start) start = today; if(!end) end = today;
    }

    try {
        showMessage('Info', 'Excel ‡§´‡§æ‡§á‡§≤ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à...', 'info');

        // ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§°‡•á‡§ü‡§æ ‡§Æ‡§Ç‡§ó‡§æ‡§è‡§Ç (‡§µ‡§π‡•Ä API ‡§ú‡•ã Show Data ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡•Ç‡§ú‡§º ‡§π‡•ã‡§§‡§æ ‡§π‡•à)
        const res = await fetchApi('/api/reports/advanced', {
            method: 'POST', 
            body: { reportType: type, startDate: start, endDate: end }
        });

        if (res.success && res.data.length > 0) {
            // ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã Excel ‡§∂‡•Ä‡§ü ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤‡•á‡§Ç (SheetJS ‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á)
            const ws = XLSX.utils.json_to_sheet(res.data);
            const wb = XLSX.utils.book_new();
            
            // ‡§∂‡•Ä‡§ü ‡§ï‡•ã ‡§¨‡•Å‡§ï ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
            XLSX.utils.book_append_sheet(wb, ws, "Report");

            // ‡§´‡§æ‡§á‡§≤ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§¨‡§®‡§æ‡§è‡§Ç (‡§ú‡•à‡§∏‡•á: Sales_Report_2023-10-25.xlsx)
            const fileName = `${type}_${start}_to_${end}.xlsx`;

            // ‡§´‡§æ‡§á‡§≤ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
            XLSX.writeFile(wb, fileName);
            
            showMessage('‡§∏‡§´‡§≤‡§§‡§æ', 'Excel ‡§´‡§æ‡§á‡§≤ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§à!', 'success');
        } else {
            showMessage('Warning', '‡§á‡§∏ ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§', 'warning');
        }
    } catch (e) {
        console.error(e);
        showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', 'Excel ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§µ‡§ø‡§´‡§≤: ' + e.message, 'danger');
    }
}

// [ ‚úÖ FIXED: PAINTER PAYMENT FUNCTION (Anti-Freeze) ]
async function payPainterDue() {
    if (!currentViewingPainterId) return;

    // 1. ‡§∞‡§ï‡§Æ ‡§™‡•Ç‡§õ‡•á‡§Ç
    const amountStr = prompt("‡§™‡•á‡§Ç‡§ü‡§∞ ‡§ï‡•ã ‡§ï‡§ø‡§§‡§®‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® (Payment) ‡§ï‡§∞‡§®‡§æ ‡§π‡•à? (‚Çπ)");
    if (!amountStr) return; // ‡§ï‡•à‡§Ç‡§∏‡§ø‡§≤ ‡§ï‡§ø‡§Ø‡§æ ‡§§‡•ã ‡§∞‡•Å‡§ï ‡§ú‡§æ‡§è‡§Ç

    const amount = parseFloat(amountStr);
    if (isNaN(amount) || amount <= 0) {
        return showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', '‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§π‡•Ä ‡§∞‡§æ‡§∂‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§', 'warning');
    }

    try {
        // 2. ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§™‡§∞ ‡§≠‡•á‡§ú‡•á‡§Ç
        const res = await fetchApi('/api/painters/pay', {
            method: 'POST',
            body: { painterId: currentViewingPainterId, amount: amount }
        }, '‡§™‡•á‡§Æ‡•á‡§Ç‡§ü ‡§¶‡§∞‡•ç‡§ú ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...');

        if (res.success) {
            showMessage('‡§∏‡§´‡§≤‡§§‡§æ', res.message, 'success');
            
            // --- üöÄ FIX START: ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§ö‡§ø‡§™‡§ï‡§®‡•á ‡§ï‡§æ ‡§á‡§≤‡§æ‡§ú ---
            
            // Step A: ‡§Æ‡•â‡§°‡§≤ ‡§ï‡•ã ‡§ú‡§æ‡§µ‡§æ‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§∏‡•á ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç
            const modalEl = document.getElementById('painterLedgerModal');
            const modalInstance = bootstrap.Modal.getInstance(modalEl);
            if (modalInstance) {
                modalInstance.hide();
            }

            // Step B: ‡§Ö‡§ó‡§∞ ‡§ï‡§æ‡§≤‡§æ ‡§™‡§∞‡•ç‡§¶‡§æ (Backdrop) ‡§∞‡§π ‡§ó‡§Ø‡§æ ‡§π‡•à, ‡§§‡•ã ‡§â‡§∏‡•á ‡§ú‡§¨‡§∞‡§¶‡§∏‡•ç‡§§‡•Ä ‡§π‡§ü‡§æ‡§è‡§Ç
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());

            // Step C: ‡§¨‡•â‡§°‡•Ä ‡§ï‡•ã ‡§∏‡•ç‡§ï‡•ç‡§∞‡•â‡§≤ ‡§ï‡§∞‡§®‡•á ‡§≤‡§æ‡§Ø‡§ï ‡§¨‡§®‡§æ‡§è‡§Ç
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';

            // --- üöÄ FIX END ---

            // 3. ‡§°‡•á‡§ü‡§æ ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç (‡§•‡•ã‡§°‡§º‡§æ ‡§∞‡•Å‡§ï ‡§ï‡§∞ ‡§§‡§æ‡§ï‡§ø ‡§è‡§®‡§ø‡§Æ‡•á‡§∂‡§® ‡§™‡•Ç‡§∞‡§æ ‡§π‡•ã ‡§ú‡§æ‡§è)
            setTimeout(() => {
                viewSelectedPainterLedger(); // ‡§Ø‡§π ‡§Æ‡•â‡§°‡§≤ ‡§¶‡•ã‡§¨‡§æ‡§∞‡§æ ‡§ñ‡•ã‡§≤‡•á‡§ó‡§æ ‡§Ö‡§™‡§°‡•á‡§ü‡•á‡§° ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§ï‡•á ‡§∏‡§æ‡§•
            }, 500); 
            
            // ‡§ñ‡§∞‡•ç‡§ö (Expense) ‡§≠‡•Ä ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
            if(typeof fetchAndRenderExpenses === 'function') fetchAndRenderExpenses();

        } else {
            throw new Error(res.message);
        }
    } catch (e) {
        showMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', e.message, 'danger');
    }
}

// 1. üõ†Ô∏è REPAIR JOB CARD (‡§§‡§æ‡§≤‡§æ ‡§∞‡§ø‡§™‡•á‡§Ø‡§∞‡§ø‡§Ç‡§ó ‡§ï‡•Ä ‡§Æ‡•à‡§®‡•Å‡§Ö‡§≤ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä)
// 1. üõ†Ô∏è REPAIR JOB CARD (Updated with Invoice ID)
async function createRepairJob() {
    // ‡§®‡§è ‡§´‡•Ä‡§≤‡•ç‡§° ‡§∏‡•á ‡§µ‡•à‡§≤‡•ç‡§Ø‡•Ç ‡§≤‡•á‡§Ç
    const invId = document.getElementById('repair_invoice_id') ? document.getElementById('repair_invoice_id').value : '';
    const issueText = document.getElementById('repair_issue').value;

    // ‡§¨‡§ø‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§ï‡•ã ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§ú‡•ã‡§°‡§º ‡§¶‡•á‡§Ç (‡§§‡§æ‡§ï‡§ø ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§¨‡§¶‡§≤‡•á ‡§¨‡§ø‡§®‡§æ ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ú‡§æ‡§è)
    // ‡§∏‡•á‡§µ ‡§π‡•ã‡§ó‡§æ: "[Bill: 101] Key Broken"
    const finalIssue = invId ? `[Bill: ${invId}] ${issueText}` : issueText;

    const data = {
        customerName: document.getElementById('repair_customer').value,
        mobile: document.getElementById('repair_mobile').value,
        device: document.getElementById('repair_device').value,
        imei: document.getElementById('repair_imei').value, 
        issue: finalIssue, // üöÄ ‡§Ø‡§π‡§æ‡§Å ‡§π‡§Æ‡§®‡•á ‡§¨‡§ø‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§ú‡•ã‡§°‡§º ‡§¶‡§ø‡§Ø‡§æ
        cost: document.getElementById('repair_cost').value,
        advance: document.getElementById('repair_advance').value
    };

    if(!data.customerName || !data.device) {
        return showMessage("‡§Ö‡§ß‡•Ç‡§∞‡§æ ‡§°‡•á‡§ü‡§æ", "‚ùå ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§î‡§∞ ‡§Ü‡§á‡§ü‡§Æ (Device) ‡§≠‡§∞‡§®‡§æ ‡•õ‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à‡•§", "warning");
    }

    try {
        const res = await fetchApi('/api/repair/create-job', { method: 'POST', body: data });
        if(res.success) {
            showMessage("‡§∏‡§´‡§≤‡§§‡§æ", `‚úÖ ‡§ú‡•â‡§¨ ‡§ï‡§æ‡§∞‡•ç‡§° ‡§¨‡§® ‡§ó‡§Ø‡§æ! (Job ID: ${res.jobId})`, "success");
            
            // ‡§´‡•â‡§∞‡•ç‡§Æ ‡§ñ‡§æ‡§≤‡•Ä ‡§ï‡§∞‡•á‡§Ç
            document.getElementById('repair_customer').value = '';
            document.getElementById('repair_device').value = '';
            document.getElementById('repair_issue').value = '';
            document.getElementById('repair_cost').value = '';
            document.getElementById('repair_advance').value = '';
            if(document.getElementById('repair_invoice_id')) document.getElementById('repair_invoice_id').value = '';
        }
    } catch(e) { 
        alert(e.message); 
    }
}

// 2. üöõ DELIVERY TRACKER (‡§§‡§ø‡§ú‡•ã‡§∞‡•Ä ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä ‡§ï‡•Ä ‡§Æ‡•à‡§®‡•Å‡§Ö‡§≤ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä)

// 1. ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
// 1. ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® (Debug ‡§ï‡•á ‡§∏‡§æ‡§•)
// [ ‚úÖ FIXED: LOAD DELIVERY LIST (TARGETS NEW ID) ]
// [ ‚úÖ FIXED: Delivery List Loader (Targets New ID) ]
// [ ‚úÖ FIXED: DELIVERY LIST LOADER (NO CACHE) ]
// [ ‚úÖ FIXED: DELIVERY LIST LOADER (NO CACHE & AUTO-SCROLL) ]
// [ ‚úÖ UPDATED: DELIVERY LIST (Hides Completed Items) ]
async function loadDeliveryList() {
    const tbody = document.getElementById('delivery-list-final');
    if (!tbody) return;

    tbody.innerHTML = `<tr><td colspan="4" class="text-center text-primary"><div class="spinner-border spinner-border-sm"></div> ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</td></tr>`;

    try {
        // ‡§ü‡§æ‡§á‡§Æ‡§∏‡•ç‡§ü‡•à‡§Æ‡•ç‡§™ ‡§∏‡•á ‡§´‡•ç‡§∞‡•á‡§∂ ‡§°‡•á‡§ü‡§æ ‡§≤‡§æ‡§è‡§Ç
        const uniqueUrl = '/api/furniture/deliveries?t=' + new Date().getTime();
        const res = await fetchApi(uniqueUrl, { method: 'GET' }, null);
        
        tbody.innerHTML = ''; 

        if (res.success && res.deliveries && res.deliveries.length > 0) {
            
            // üöÄ ‡§∏‡§ø‡§∞‡•ç‡§´ ‡§µ‡§π‡•Ä ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç ‡§ú‡•ã 'DELIVERED' ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡§Ç
            const pendingItems = res.deliveries.filter(item => item.delivery_status !== 'DELIVERED');

            if (pendingItems.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-success fw-bold py-3">‚úÖ ‡§∏‡§¨ ‡§ï‡§æ‡§Æ ‡§™‡•Ç‡§∞‡§æ ‡§π‡•ã ‡§ó‡§Ø‡§æ! (No Pending)</td></tr>`;
                return;
            }

            pendingItems.forEach(item => {
                const dateObj = new Date(item.delivery_date);
                const dateStr = !isNaN(dateObj) 
                    ? dateObj.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' })
                    : item.delivery_date;

                const mistriBadge = item.assembly_required 
                    ? '<span class="badge bg-danger ms-1" style="font-size:0.7em">Mistri</span>' 
                    : '';

                tbody.innerHTML += `
                    <tr>
                        <td>
                            <span class="fw-bold text-dark">#${item.invoice_id}</span>
                            ${mistriBadge}
                        </td>
                        <td>${dateStr}</td>
                        <td><span class="badge bg-warning text-dark">Pending</span></td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-success border-0" 
                                onclick="markDeliveryDone('${item.invoice_id}')" 
                                title="‡§ï‡§æ‡§Æ ‡§π‡•ã ‡§ó‡§Ø‡§æ (Mark Done)">
                                <i class="fas fa-check-circle fa-lg"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        } else {
            tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-3">‡§ï‡•ã‡§à ‡§™‡•á‡§Ç‡§°‡§ø‡§Ç‡§ó ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</td></tr>`;
        }
    } catch (e) {
        console.error("API Error:", e);
        tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">Error loading data.</td></tr>`;
    }
}

// [ ‚úÖ NEW FUNCTION: Mark as Done ]
async function markDeliveryDone(invoiceId) {
    if(!confirm("‡§ï‡•ç‡§Ø‡§æ ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä ‡§™‡•Ç‡§∞‡•Ä ‡§π‡•ã ‡§ó‡§à ‡§π‡•à? ‡§Ø‡§π ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§∏‡•á ‡§π‡§ü ‡§ú‡§æ‡§è‡§ó‡§æ‡•§")) return;

    try {
        const res = await fetchApi('/api/furniture/mark-done', { 
            method: 'POST', 
            body: { invoiceId } 
        });

        if (res.success) {
            // ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç -> ‡§Ü‡§á‡§ü‡§Æ ‡§ó‡§æ‡§Ø‡§¨ ‡§π‡•ã ‡§ú‡§æ‡§è‡§ó‡§æ
            loadDeliveryList();
            showMessage("‡§∏‡§´‡§≤‡§§‡§æ", "‚úÖ ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä ‡§ï‡§Æ‡•ç‡§™‡§≤‡•Ä‡§ü! ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§∏‡•á ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§", "success");
        }
    } catch (e) {
        alert(e.message);
    }
}
// 2. ‡§™‡•Å‡§∞‡§æ‡§®‡•á scheduleFurnitureDelivery ‡§ï‡•ã ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç (‡§§‡§æ‡§ï‡§ø ‡§∏‡•á‡§µ ‡§ï‡§∞‡§§‡•á ‡§π‡•Ä ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§¶‡§ø‡§ñ‡•á)
// 2. ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä ‡§∏‡•á‡§µ ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® (‡§∏‡•á‡§µ ‡§π‡•ã‡§§‡•á ‡§π‡•Ä ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§ó‡§æ)
// [ ‚úÖ FIXED: Delivery Schedule Function (With Auto-Refresh) ]
// [ ‚úÖ FIXED: DELIVERY SCHEDULE FUNCTION ]
async function scheduleFurnitureDelivery() {
    const btn = document.querySelector('button[onclick="scheduleFurnitureDelivery()"]');
    
    const invoiceId = document.getElementById('furn_invoice_id').value;
    const date = document.getElementById('furn_delivery_date').value;
    const assembly = document.getElementById('furn_assembly').checked;

    if(!date || !invoiceId) {
        return showMessage("‡§Ö‡§ß‡•Ç‡§∞‡§æ ‡§°‡•á‡§ü‡§æ", "‚ùå ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡§ø‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§î‡§∞ ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§ö‡•Å‡§®‡•á‡§Ç‡•§", "warning");
    }

    if(btn) { btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ‡§∏‡•á‡§µ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...'; }

    try {
        const data = { invoiceId, date, assembly };
        // ‡§°‡•á‡§ü‡§æ ‡§≠‡•á‡§ú‡•á‡§Ç
        const res = await fetchApi('/api/furniture/update-delivery', { method: 'POST', body: data });
        
        if(res.success) {
            showMessage("‡§∏‡§´‡§≤‡§§‡§æ", "‚úÖ ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä ‡§∂‡•á‡§°‡•ç‡§Ø‡•Ç‡§≤ ‡§π‡•ã ‡§ó‡§à!", "success");
            
            // ‡§´‡•â‡§∞‡•ç‡§Æ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç
            document.getElementById('furn_invoice_id').value = '';
            document.getElementById('furn_delivery_date').value = '';
            document.getElementById('furn_assembly').checked = false;
            
            // üöÄ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§ï‡•ã 1 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§¨‡§æ‡§¶ ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç (‡§§‡§æ‡§ï‡§ø ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§µ ‡§ï‡§∞ ‡§≤‡•á)
            setTimeout(loadDeliveryList, 1000); 
        }
    } catch(e) { 
        showMessage("‡§§‡•ç‡§∞‡•Å‡§ü‡§ø", e.message, "danger"); 
    } finally {
        if(btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-save"></i> Schedule Delivery'; }
    }
}


// üöÄ GOD MODE: Helper Function to toggle Date Input
function togglePosDeliveryDate() {
    const isChecked = document.getElementById('pos_auto_deliver_check').checked;
    const inputsDiv = document.getElementById('pos_delivery_inputs');
    if (inputsDiv) {
        inputsDiv.style.display = isChecked ? 'block' : 'none';
        // ‡§Ö‡§ó‡§∞ ‡§ö‡•á‡§ï ‡§ï‡§ø‡§Ø‡§æ ‡§π‡•à, ‡§§‡•ã ‡§Ü‡§ú ‡§ï‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§Ö‡§™‡§®‡•á ‡§Ü‡§™ ‡§≠‡§∞ ‡§¶‡•á‡§Ç
        if (isChecked && !document.getElementById('pos_auto_date').value) {
            document.getElementById('pos_auto_date').value = new Date().toISOString().split('T')[0];
        }
    }
}
// ==========================================
// üöÄ GOD MODE: SMART BUTTON SWAP SYSTEM
// ==========================================
// ==========================================
// üöÄ GOD MODE: PRE-OPEN FIX + BUTTON SWAP
// ==========================================
// ==========================================
// üöÄ GOD MODE: SINGLE WINDOW FIX
// ==========================================
// ==========================================
// üöÄ ENTERPRISE GOD MODE: TEMPLATE ENGINE + SMART FLOW
// ==========================================

// 1. Template Reset Helper
function resetTemplate() {
    const defaultTemp = `‡§®‡§Æ‡§∏‡•ç‡§§‡•á *{name}*,\n‡§Ü‡§™‡§ï‡§æ ‡§ë‡§°‡§∞ ‡§ï‡§Ç‡§´‡§∞‡•ç‡§Æ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à! üéâ\nüßæ ‡§¨‡§ø‡§≤ ‡§®‡§Ç‡§¨‡§∞: *#{bill_no}*\nüí∞ ‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø: *{amount}*\nüì¶ ‡§∏‡§æ‡§Æ‡§æ‡§®: {items}\nüöö ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä: {date}\n\n‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§æ‡§• ‡§Æ‡•á‡§Ç ‡§≠‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ PDF ‡§¨‡§ø‡§≤ ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§ ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! üôè`;
    document.getElementById('pos_wa_template').value = defaultTemp;
}

// 2. The Template Engine
function getSmartMessage(template, data) {
    return template
        .replace(/{name}/g, data.customerName)
        .replace(/{bill_no}/g, data.invoiceId)
        .replace(/{amount}/g, formatCurrency(data.totalAmount))
        .replace(/{date}/g, new Date(data.date).toLocaleDateString('en-IN'))
        .replace(/{items}/g, data.items.map(i => i.name).join(', '));
}
// 3. MAIN EXECUTION FUNCTION
// ==========================================
// üöÄ ENTERPRISE GOD MODE: SMART MOBILE FIX
// ==========================================

// 1. Template Reset Helper (Same as before)
function resetTemplate() {
    const defaultTemp = `‡§®‡§Æ‡§∏‡•ç‡§§‡•á *{name}*,\n‡§Ü‡§™‡§ï‡§æ ‡§ë‡§°‡§∞ ‡§ï‡§Ç‡§´‡§∞‡•ç‡§Æ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à! üéâ\nüßæ ‡§¨‡§ø‡§≤ ‡§®‡§Ç‡§¨‡§∞: *#{bill_no}*\nüí∞ ‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø: *{amount}*\nüì¶ ‡§∏‡§æ‡§Æ‡§æ‡§®: {items}\nüöö ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä: {date}\n\n‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§æ‡§• ‡§Æ‡•á‡§Ç ‡§≠‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ PDF ‡§¨‡§ø‡§≤ ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§ ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! üôè`;
    document.getElementById('pos_wa_template').value = defaultTemp;
}

// 2. The Template Engine (Same as before)
function getSmartMessage(template, data) {
    return template
        .replace(/{name}/g, data.customerName)
        .replace(/{bill_no}/g, data.invoiceId)
        .replace(/{amount}/g, formatCurrency(data.totalAmount))
        .replace(/{date}/g, new Date(data.date).toLocaleDateString('en-IN'))
        .replace(/{items}/g, data.items.map(i => i.name).join(', '));
}

// üöÄ 3. GOD MODE (Silent Database Update & PDF Trigger)
async function executeGodModeDelivery(invoiceId, customerName, customerMobile, items, preOpenedWindow) {
    const isEnabled = document.getElementById('pos_auto_deliver_check')?.checked;
    const isMobileDevice = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    if (!isEnabled) {
        if (typeof loadDeliveryList === 'function') loadDeliveryList();
        return;
    }

    const date = document.getElementById('pos_auto_date').value;
    const mistriMobileInput = document.getElementById('pos_auto_mistri_mobile').value; 
    const mistriMobile = mistriMobileInput ? mistriMobileInput.trim() : null;

    if (!date) return; // ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§®‡§π‡•Ä‡§Ç ‡§§‡•ã ‡§ï‡•Å‡§õ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§®‡§æ

    try {
        // A. ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§Ö‡§™‡§°‡•á‡§ü (Database)
        await fetchApi('/api/furniture/update-delivery', { 
            method: 'POST', body: { invoiceId: invoiceId, date: date, assembly: (mistriMobile ? true : false) } 
        });

        if (typeof loadDeliveryList === 'function') setTimeout(loadDeliveryList, 500);

        // B. PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ü‡•ç‡§∞‡§ø‡§ó‡§∞
        const totalBill = items.reduce((sum, item) => sum + (item.sale_price * item.quantity), 0);
        if (typeof generateAndDownloadPDF === 'function') {
            generateAndDownloadPDF(invoiceId, customerName, items, totalBill);
        }

        // C. ‡§Æ‡§ø‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä ‡§¨‡§ü‡§® ‡§∏‡•á‡§ü‡§Ö‡§™ (‡§Ö‡§ó‡§∞ ‡§Æ‡§ø‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä ‡§π‡•à)
        const sendToMistri = document.getElementById('pos_send_mistri_wa')?.checked;
        if (sendToMistri && mistriMobile) {
            const btn = document.getElementById('complete-sale-btn');
            let msgMistri = `üõ†Ô∏è *Job Alert*\nüìç ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï: ${customerName}\nüìû: ${customerMobile}\nüöö ‡§§‡§æ‡§∞‡•Ä‡§ñ: ${new Date(date).toLocaleDateString('en-IN')}\nüì¶ ‡§∏‡§æ‡§Æ‡§æ‡§®: ${items.map(i => i.name).join(', ')}`;
            
            // ‡§¨‡§ü‡§® ‡§¨‡§¶‡§≤‡•á‡§Ç
            btn.innerHTML = `<i class="fab fa-whatsapp"></i> ‡§Æ‡§ø‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä ‡§ï‡•ã ‡§≠‡•á‡§ú‡•á‡§Ç`;
            btn.className = "btn btn-info btn-lg w-100 fw-bold";
            btn.onclick = function() {
                openSmartWhatsApp(mistriMobile, msgMistri);
                setTimeout(resetPOSButton, 2000);
            };
        } else {
             // ‡§Ö‡§ó‡§∞ ‡§Æ‡§ø‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§§‡•ã ‡§¨‡§ü‡§® ‡§∞‡§ø‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
             const sendToCust = document.getElementById('pos_send_cust_wa')?.checked;
             if (sendToCust || !sendToMistri) resetPOSButton();
        }

    } catch (e) {
        console.error("God Mode Error:", e);
    }
}


// üßπ FINAL RESET FUNCTION (Sab Kuch Saaf Karega)
// ==========================================
function resetPOSButton() {
    // 1. ‡§¨‡§ü‡§® ‡§ï‡•ã ‡§µ‡§æ‡§™‡§∏ ‡§π‡§∞‡§æ ‡§ï‡§∞‡•á‡§Ç
    const btn = document.getElementById('complete-sale-btn');
    if(btn) {
        btn.innerHTML = "‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§™‡•Ç‡§∞‡•Ä ‡§ï‡§∞‡•á‡§Ç";
        btn.className = "btn btn-success btn-lg w-100";
        btn.onclick = handleCompleteSale;
    }
    
    // 2. ‡§¨‡•á‡§∏‡§ø‡§ï ‡§´‡•Ä‡§≤‡•ç‡§°‡•ç‡§∏ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç
    document.getElementById('pos-customer').value = '';
    document.getElementById('pos-customer-mobile').value = '';
    
    // 3. God Mode (Mistri) ‡§´‡•Ä‡§≤‡•ç‡§°‡•ç‡§∏ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç (‡§Ö‡§ó‡§∞ ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§π‡•à‡§Ç)
    if(document.getElementById('pos_auto_mistri_mobile')) {
        document.getElementById('pos_auto_mistri_mobile').value = '';
    }
    
    // 4. ‡§ï‡§æ‡§∞‡•ç‡§ü ‡§ñ‡§æ‡§≤‡•Ä ‡§ï‡§∞‡•á‡§Ç
    posCart = [];
    updatePOSCartView();
}

// ==========================================
// üìÑ INSTANT BILL PDF GENERATOR
// ==========================================
// ==========================================
// üìÑ PROFESSIONAL INVOICE PDF GENERATOR
// ==========================================
function generateAndDownloadPDF(invoiceId, customerName, items, totalAmount) {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();

        // --- 1. HEADER SECTION (Colorful) ---
        doc.setFillColor(41, 128, 185); // Professional Blue Header
        doc.rect(0, 0, pageWidth, 35, 'F');

        // Shop Name
        const shopName = AppState.user?.shopName || "MY SHOP NAME";
        doc.setFont("helvetica", "bold");
        doc.setFontSize(22);
        doc.setTextColor(255, 255, 255); // White Text
        doc.text(shopName.toUpperCase(), 15, 15);

        // Shop Details (Subtitle)
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.text("Mobile: 9876543210 | Address: City, India", 15, 22);
        doc.text("GSTIN: 22AAAAA0000A1Z5", 15, 27);

        // Invoice Label
        doc.setFontSize(16);
        doc.text("INVOICE", pageWidth - 15, 20, { align: 'right' });

        // --- 2. CUSTOMER & BILL DETAILS ---
        doc.setTextColor(0, 0, 0); // Black Text
        let y = 45;

        // Left Side: Bill To
        doc.setFontSize(10);
        doc.setFont("helvetica", "bold");
        doc.text("BILL TO:", 15, y);
        doc.setFont("helvetica", "normal");
        doc.text(customerName.toUpperCase(), 15, y + 6);
        // doc.text("Customer Mobile: " + customerMobile, 15, y + 12); // Optional

        // Right Side: Invoice Info
        doc.setFont("helvetica", "bold");
        doc.text("Invoice No:", 140, y);
        doc.text("Date:", 140, y + 6);
        
        doc.setFont("helvetica", "normal");
        doc.text(`#${invoiceId}`, 170, y);
        doc.text(new Date().toLocaleDateString('en-IN'), 170, y + 6);

        // --- 3. ITEM TABLE ---
        y += 20;
        
        // Table Headers
        doc.setFillColor(230, 230, 230); // Light Grey
        doc.rect(15, y, pageWidth - 30, 8, 'F');
        doc.setFont("helvetica", "bold");
        doc.setFontSize(9);
        
        doc.text("#", 18, y + 5);
        doc.text("ITEM NAME", 30, y + 5);
        doc.text("QTY", 120, y + 5, { align: 'center' });
        doc.text("PRICE", 150, y + 5, { align: 'center' });
        doc.text("TOTAL", 185, y + 5, { align: 'center' });

        // Table Rows
        y += 8;
        doc.setFont("helvetica", "normal");
        
        let totalQty = 0;

        items.forEach((item, index) => {
            const lineTotal = item.quantity * item.sale_price;
            totalQty += item.quantity;
            
            // Item Name Formatting (Truncate if too long)
            let itemName = item.name;
            if (itemName.length > 45) itemName = itemName.substring(0, 45) + "...";

            doc.text(String(index + 1), 18, y + 5);
            doc.text(itemName, 30, y + 5);
            doc.text(String(item.quantity), 120, y + 5, { align: 'center' });
            doc.text(formatCurrency(item.sale_price), 150, y + 5, { align: 'center' });
            doc.text(formatCurrency(lineTotal), 185, y + 5, { align: 'center' });

            // Light line between rows
            doc.setDrawColor(220, 220, 220);
            doc.line(15, y + 7, pageWidth - 15, y + 7);
            
            y += 8;
        });

        // --- 4. TOTALS SECTION ---
        y += 5;
        doc.setDrawColor(0, 0, 0);
        doc.line(15, y, pageWidth - 15, y); // Bold Line

        y += 7;
        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.text("GRAND TOTAL", 140, y);
        doc.text(formatCurrency(totalAmount), 185, y, { align: 'center' });

        // Amount in words (Optional logic can be added here)
        // doc.setFontSize(9);
        // doc.text("Amount in Words: " + convertToWords(totalAmount), 15, y);

        // --- 5. FOOTER & SIGNATURE ---
        let footerY = pageHeight - 40;
        
        doc.setFontSize(8);
        doc.setFont("helvetica", "normal");
        doc.text("Terms & Conditions:", 15, footerY);
        doc.text("1. Goods once sold will not be taken back.", 15, footerY + 5);
        doc.text("2. Subject to local jurisdiction.", 15, footerY + 10);

        doc.text("Authorized Signature", pageWidth - 15, footerY + 20, { align: 'right' });

        // Thank you note
        doc.setFontSize(10);
        doc.setTextColor(41, 128, 185);
        doc.text("Thank you for your business!", pageWidth / 2, pageHeight - 10, { align: 'center' });

        // --- 6. SAVE FILE ---
        doc.save(`Invoice_${invoiceId}.pdf`);
        console.log("‚úÖ Professional PDF Downloaded!");

    } catch (e) {
        console.error("PDF Error:", e);
        showMessage("PDF Error", "PDF ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§Ü‡§à‡•§", "warning");
    }
}

// [ ‡§á‡§∏‡•á ‡§Ö‡§™‡§®‡•Ä HTML ‡§´‡§æ‡§á‡§≤ ‡§ï‡•á <script> ‡§∏‡•á‡§ï‡•ç‡§∂‡§® ‡§Æ‡•á‡§Ç ‡§∏‡§¨‡§∏‡•á ‡§®‡•Ä‡§ö‡•á ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç ]

// üè® HOTEL: Check-In Logic
// üè® HOTEL: Check-In Logic (Updated)
async function processHotelCheckIn() {
    // 1. ‡§°‡•á‡§ü‡§æ ‡§á‡§ï‡§ü‡•ç‡§†‡§æ ‡§ï‡§∞‡•á‡§Ç
    const data = {
        room_id: document.getElementById('hotel_room_select').value,
        customer_name: document.getElementById('hotel_guest_name').value,
        mobile: document.getElementById('hotel_guest_mobile').value,
        check_in_date: document.getElementById('hotel_checkin_date').value,
        advance: document.getElementById('hotel_advance').value
    };

    // 2. ‡§µ‡•à‡§≤‡§ø‡§°‡•á‡§∂‡§®
    if(!data.room_id || !data.customer_name || !data.check_in_date) {
        return showMessage("‡§Ö‡§ß‡•Ç‡§∞‡§æ ‡§°‡•á‡§ü‡§æ", "‚ùå ‡§ï‡•É‡§™‡§Ø‡§æ Room No, Guest Name ‡§î‡§∞ Date ‡§ú‡§∞‡•Ç‡§∞ ‡§≠‡§∞‡•á‡§Ç‡•§", "warning");
    }

    // 3. ‡§¨‡§ü‡§® ‡§ï‡•ã ‡§°‡§ø‡§∏‡•á‡§¨‡§≤ ‡§ï‡§∞‡•á‡§Ç
    const btn = document.querySelector('button[onclick="processHotelCheckIn()"]');
    if(btn) { 
        btn.disabled = true; 
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...'; 
    }

    try {
        // 4. ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§ï‡•ã ‡§≠‡•á‡§ú‡•á‡§Ç
        const res = await fetchApi('/api/hotel/checkin', { method: 'POST', body: data });

        if(res.success) {
            showMessage("‡§∏‡§´‡§≤‡§§‡§æ", "‚úÖ ‡§ó‡•á‡§∏‡•ç‡§ü ‡§ï‡§æ ‡§ö‡•á‡§ï-‡§á‡§® ‡§∏‡§´‡§≤ ‡§∞‡§π‡§æ!", "success");
            
            // ‡§´‡•â‡§∞‡•ç‡§Æ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç
            document.getElementById('hotel_guest_name').value = '';
            document.getElementById('hotel_guest_mobile').value = '';
            document.getElementById('hotel_advance').value = '';

            // üöÄ FIX: ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§ï‡•ã ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç (‡§§‡§æ‡§ï‡§ø ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§® ‡§ï‡§∞‡§®‡§æ ‡§™‡•ú‡•á)
            if (typeof loadHotelRooms === 'function') {
                loadHotelRooms(); 
            }

        } else {
             showMessage("‡§§‡•ç‡§∞‡•Å‡§ü‡§ø", res.message || "‡§ö‡•á‡§ï-‡§á‡§® ‡§µ‡§ø‡§´‡§≤ ‡§∞‡§π‡§æ", "danger");
        }
    } catch(e) {
        console.error(e);
        showMessage("‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§è‡§∞‡§∞", "‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§æ: " + e.message, "danger");
    } finally {
        // 5. ‡§¨‡§ü‡§® ‡§ï‡•ã ‡§µ‡§æ‡§™‡§∏ ‡§†‡•Ä‡§ï ‡§ï‡§∞‡•á‡§Ç
        if(btn) { 
            btn.disabled = false; 
            btn.innerHTML = '<i class="fas fa-key"></i> Check-In Guest'; 
        }
    }
}

// [ ‡§á‡§∏‡•á script ‡§Æ‡•á‡§Ç ‡§∏‡§¨‡§∏‡•á ‡§®‡•Ä‡§ö‡•á ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç ]

// [ HTML ‡§´‡§æ‡§á‡§≤ ‡§ï‡•á <script> ‡§Æ‡•á‡§Ç ‡§á‡§∏‡•á ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç ]

// 1. üè® LIST LOAD FUNCTION (‡§á‡§∏‡•á ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç)
async function loadHotelRooms() {
    const container = document.getElementById('hotel-room-list'); 
    if (!container) return;

    // Table view ‡§π‡§ü‡§æ‡§ï‡§∞ Grid View (‡§°‡§ø‡§¨‡•ç‡§¨‡•á) ‡§¨‡§®‡§æ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç
    container.parentElement.innerHTML = `<div id="room-grid-area" class="row g-3"></div>`;
    const grid = document.getElementById('room-grid-area');

    try {
        const res = await fetchApi('/api/hotel/rooms', { method: 'GET' }, null);

        if (res.success && res.rooms.length > 0) {
            grid.innerHTML = res.rooms.map(room => {
                const isOccupied = room.status === 'OCCUPIED';
                const colorClass = isOccupied ? 'bg-danger text-white' : 'bg-success text-white';
                const icon = isOccupied ? 'fa-bed' : 'fa-door-open';
                
                // ‡§ó‡•á‡§∏‡•ç‡§ü ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç (‡§Ö‡§ó‡§∞ ‡§π‡•à ‡§§‡•ã)
                const guestName = room.current_guest_name || 'Guest';
                const guestInfo = isOccupied ? `<small>${guestName}</small>` : '<small>Empty</small>';
                
                // üöÄ [‡§Ø‡§π‡§æ‡§Å ‡§ï‡§ø‡§Ø‡§æ ‡§π‡•à ‡§¨‡§¶‡§≤‡§æ‡§µ] üöÄ
                // ‡§≠‡§∞‡§æ ‡§π‡•à ‡§§‡•ã 'checkoutGuest' (‡§®‡§æ‡§Æ ‡§ï‡•á ‡§∏‡§æ‡§•), ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•à ‡§§‡•ã 'selectRoom'
                const action = isOccupied 
                    ? `checkoutGuest('${room.room_number}', '${guestName}')` 
                    : `selectRoom('${room.room_number}')`;

                return `
                    <div class="col-6 col-md-3 col-lg-2">
                        <div class="card shadow-sm ${colorClass} text-center p-3" 
                             style="cursor: pointer; transition: 0.3s;"
                             onclick="${action}">
                            <h4 class="mb-1">${room.room_number}</h4>
                            <i class="fas ${icon} fa-2x mb-2"></i>
                            <div class="text-truncate">${guestInfo}</div>
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            grid.innerHTML = `<div class="alert alert-warning col-12">‡§ï‡•ã‡§à ‡§ï‡§Æ‡§∞‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§ '+ Add Room' ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§è‡§Ç‡•§</div>`;
        }
    } catch (e) { console.error(e); }
}
// 2. üè® CHECK-OUT FUNCTION (‡§®‡§Ø‡§æ)
// [ ‚úÖ NEW: Open Checkout Modal ]
let currentCheckoutRoom = null;
let currentCheckoutGuest = null;

function checkoutGuest(roomNo, guestName = 'Guest') {
    // 1. ‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
    currentCheckoutRoom = roomNo;
    currentCheckoutGuest = guestName; // (‡§Ö‡§ó‡§∞ guestName ‡§®‡§π‡•Ä‡§Ç ‡§Ü ‡§∞‡§π‡§æ ‡§§‡•ã ‡§ï‡•ã‡§à ‡§¨‡§æ‡§§ ‡§®‡§π‡•Ä‡§Ç)

    // 2. Modal ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
    document.getElementById('co_room_no').innerText = `Room ${roomNo}`;
    document.getElementById('co_guest_name').innerText = `Guest: ${guestName}`;
    document.getElementById('co_amount').value = ''; // ‡§ñ‡§æ‡§≤‡•Ä ‡§ï‡§∞‡•á‡§Ç

    // 3. Modal ‡§ñ‡•ã‡§≤‡•á‡§Ç
    const modal = new bootstrap.Modal(document.getElementById('hotelCheckoutModal'));
    modal.show();
}

/// [ ‚úÖ FIXED: CHECKOUT FORM LISTENER (Safety Check Added) ]
document.addEventListener("DOMContentLoaded", () => {
    
    const checkoutForm = document.getElementById('checkout-form');

    if (checkoutForm) {
        checkoutForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const amount = document.getElementById('co_amount').value;
            const mode = document.getElementById('co_mode').value;

            if(!amount || amount <= 0) {
                if(!confirm("‡§¨‡§ø‡§≤ ‡§Ö‡§Æ‡§æ‡§â‡§Ç‡§ü 0 ‡§π‡•à‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§¨‡§ø‡§®‡§æ ‡§™‡•à‡§∏‡•á ‡§≤‡§ø‡§è ‡§ö‡•á‡§ï-‡§Ü‡§â‡§ü ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")) return;
            }

            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true; 
            btn.innerHTML = 'Processing...';

            try {
                // Global variables (currentCheckoutRoom, etc) defined outside
                const res = await fetchApi('/api/hotel/checkout', { 
                    method: 'POST', 
                    body: { 
                        room_number: window.currentCheckoutRoom, // Using window to be safe
                        total_bill: amount,
                        payment_mode: mode,
                        customer_name: window.currentCheckoutGuest
                    } 
                });

                if(res.success) {
                    showMessage("Success", res.message, "success");
                    
                    // Modal ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç
                    const modalEl = document.getElementById('hotelCheckoutModal');
                    if (modalEl) {
                        const modal = bootstrap.Modal.getInstance(modalEl);
                        if (modal) modal.hide();
                    }

                    if (typeof loadHotelRooms === 'function') loadHotelRooms();
                } else {
                    showMessage("Error", res.message, "danger");
                }
            } catch(e) {
                alert(e.message);
            } finally {
                if(btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Collect & Checkout';
                }
            }
        });
        console.log("‚úÖ Checkout Form initialized successfully.");
    } else {
        console.warn("‚ö†Ô∏è Warning: 'checkout-form' not found. Make sure HTML Modal is placed correctly.");
    }
});

// 3. ‡§∞‡•Ç‡§Æ ‡§∏‡•á‡§≤‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§õ‡•ã‡§ü‡§æ ‡§π‡•á‡§≤‡•ç‡§™‡§∞
// [ ‚úÖ FIXED: SELECT ROOM FUNCTION ]
function selectRoom(roomNo) {
    // 1. ‡§á‡§®‡§™‡•Å‡§ü ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§¢‡•Ç‡§Ç‡§¢‡•á‡§Ç
    const roomInput = document.getElementById('hotel_room_select');
    const guestInput = document.getElementById('hotel_guest_name');

    if (roomInput) {
        // 2. ‡§µ‡•à‡§≤‡•ç‡§Ø‡•Ç ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
        roomInput.value = roomNo;
        
        // 3. ‡§´‡•â‡§∞‡•ç‡§Æ ‡§ï‡•Ä ‡§§‡§∞‡§´ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç (‡§§‡§æ‡§ï‡§ø ‡§Ø‡•Ç‡§ú‡§∞ ‡§ï‡•ã ‡§¶‡§ø‡§ñ‡•á)
        document.getElementById('module-hotel-management').scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
        });

        // 4. ‡§ó‡•á‡§∏‡•ç‡§ü ‡§ï‡•á ‡§®‡§æ‡§Æ ‡§™‡§∞ ‡§´‡•ã‡§ï‡§∏ ‡§ï‡§∞‡•á‡§Ç (‡§§‡§æ‡§ï‡§ø ‡§ü‡§æ‡§á‡§™‡§ø‡§Ç‡§ó ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞ ‡§∏‡§ï‡•á‡§Ç)
        setTimeout(() => {
            if(guestInput) guestInput.focus();
        }, 500);

        // 5. ‡§è‡§ï ‡§õ‡•ã‡§ü‡§æ ‡§Æ‡•à‡§∏‡•á‡§ú ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
        // (‡§Ö‡§ó‡§∞ ‡§Ü‡§™‡§ï‡•á ‡§™‡§æ‡§∏ showMessage ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ‡§π‡•à ‡§§‡•ã)
        if(typeof showMessage === 'function') {
            showMessage("Room Selected", `Room ${roomNo} ‡§ö‡•Å‡§®‡§æ ‡§ó‡§Ø‡§æ‡•§ ‡§Ö‡§¨ ‡§ó‡•á‡§∏‡•ç‡§ü ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§≠‡§∞‡•á‡§Ç‡•§`, "info");
        }
    } else {
        console.error("Error: 'hotel_room_select' ‡§á‡§®‡§™‡•Å‡§ü ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ!");
        alert("Error: ‡§´‡•â‡§∞‡•ç‡§Æ ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü ‡§π‡•à‡•§ ‡§™‡•á‡§ú ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç‡•§");
    }
}// 1. "+ Add More Item" ‡§¨‡§ü‡§® ‡§ï‡§æ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®

// [ ‚úÖ FIXED: KOT LIST (With Permanent Buttons & Manual Refresh) ]
// [ ‚úÖ FIXED: COMPACT KOT LIST (Auto Height + Visible Buttons) ]
async function loadLiveKOTs() {
    const containerWaiter = document.getElementById('active-kot-list');
    const containerKitchen = document.getElementById('active-kot-list-kitchen');

    if (!containerWaiter && !containerKitchen) return;

    // 1. üìè ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§ï‡•Ä ‡§ä‡§Ç‡§ö‡§æ‡§à ‡§¨‡•ù‡§æ‡§®‡§æ (‡§§‡§æ‡§ï‡§ø ‡§¨‡§ü‡§® ‡§® ‡§ï‡§ü‡•á)
    if(containerWaiter) containerWaiter.style.maxHeight = '85vh'; // ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§ï‡§æ 85% ‡§π‡§ø‡§∏‡•ç‡§∏‡§æ
    if(containerKitchen) containerKitchen.style.maxHeight = '85vh'; 

    try {
        const res = await fetchApi('/api/restaurant/active-kots', { method: 'GET' }, null);
        
        if (res.success && res.kots && res.kots.length > 0) {
            
            const cardsHtml = res.kots.map(kot => {
                let data = {};
                try { data = typeof kot.items_json === 'string' ? JSON.parse(kot.items_json) : kot.items_json; } catch(e) {}
                
                const tableNo = data.tableNo || '??';
                const waiter = data.waiter || 'Waitr';

                // 2. üìâ ‡§õ‡•ã‡§ü‡§æ ‡§î‡§∞ ‡§∏‡§æ‡•û ‡§Ü‡§á‡§ü‡§Æ ‡§≤‡§ø‡§∏‡•ç‡§ü (Compact List)
                const itemsList = (data.items || []).map(i => 
                    `<div class="d-flex justify-content-between border-bottom border-light py-1" style="font-size: 0.85rem;">
                        <span class="text-dark fw-bold">${i.item}</span>
                        <span class="badge bg-secondary" style="font-size: 0.8em;">x${i.qty}</span>
                    </div>`
                ).join('');

                // 3. ‚ú® ‡§õ‡•ã‡§ü‡§æ ‡§ï‡§æ‡§∞‡•ç‡§° ‡§°‡§ø‡§ú‡§º‡§æ‡§á‡§® (‡§§‡§æ‡§ï‡§ø ‡§¨‡§ü‡§® ‡§π‡§Æ‡•á‡§∂‡§æ ‡§¶‡§ø‡§ñ‡•á)
                return `
                    <div class="card mb-2 shadow-sm border-0" style="border-radius: 8px; border-left: 4px solid #0d6efd !important;">
                        <div class="card-header bg-white p-2 d-flex justify-content-between align-items-center border-bottom">
                            <div>
                                <span class="badge bg-primary me-1">${tableNo}</span>
                                <small class="text-muted fw-bold" style="font-size: 0.75rem;">üë§ ${waiter}</small>
                            </div>
                            <small class="text-dark fw-bold" style="font-size: 0.75rem;">
                                üïí ${new Date(kot.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                            </small>
                        </div>
                        <div class="card-body p-2 bg-light">
                            ${itemsList}
                            
                            <button class="btn btn-success btn-sm w-100 mt-2 fw-bold shadow-sm" style="font-size: 0.85rem;" onclick="completeKOT(${kot.id})">
                                <i class="fas fa-check"></i> Done
                            </button>
                        </div>
                    </div>`;
            }).join('');

            // HTML ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
            if (containerWaiter) containerWaiter.innerHTML = cardsHtml;
            if (containerKitchen) containerKitchen.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="badge bg-dark">${res.kots.length} Pending</span>
                    <button class="btn btn-sm btn-outline-dark py-0" onclick="loadLiveKOTs()">‚Üª Refresh</button>
                </div>
                ${cardsHtml}`;

        } else {
            const emptyHtml = `<div class="text-center text-muted p-4 border rounded bg-light"><small>No Active Orders</small><br><button class="btn btn-sm btn-link text-decoration-none" onclick="loadLiveKOTs()">Refresh</button></div>`;
            if (containerWaiter) containerWaiter.innerHTML = emptyHtml;
            if (containerKitchen) containerKitchen.innerHTML = emptyHtml;
        }
    } catch(e) { console.error(e); }
}
// [ ‚úÖ FUNCTION: Complete Order ]
async function completeKOT(kotId) {
    if(!confirm("‡§ï‡•ç‡§Ø‡§æ ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§™‡•Ç‡§∞‡§æ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à?")) return;
    try {
        await fetchApi('/api/restaurant/complete-kot', { method: 'POST', body: { kotId } });
        loadLiveKOTs(); // ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç
    } catch(e) { alert(e.message); }
}


// [ ‚úÖ Ensure this function exists too ]
async function completeKOT(kotId) {
    if(!confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ø‡§π ‡§Ü‡§∞‡•ç‡§°‡§∞ ‡§™‡•Ç‡§∞‡§æ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à? (List ‡§∏‡•á ‡§π‡§ü ‡§ú‡§æ‡§è‡§ó‡§æ)")) return;
    
    try {
        const res = await fetchApi('/api/restaurant/complete-kot', { method: 'POST', body: { kotId } });
        if(res.success) {
            // ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç
            await loadLiveKOTs();
            showMessage("‡§∏‡§´‡§≤‡§§‡§æ", "‚úÖ ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§™‡•Ç‡§∞‡§æ ‡§π‡•Å‡§Ü!", "success");
        } else {
            showMessage("‡§§‡•ç‡§∞‡•Å‡§ü‡§ø", res.message, "danger");
        }
    } catch(e) { 
        alert("Error: " + e.message); 
    }
}



// ‡§π‡•á‡§≤‡•ç‡§™‡§∞ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® (‡§§‡§æ‡§ï‡§ø ‡§ï‡•ã‡§° ‡§∏‡§æ‡§´‡§º ‡§∞‡§π‡•á)
function safeJsonParse(str) { try { return typeof str === 'string' ? JSON.parse(str) : str; } catch { return {}; } }
function createItemsHtml(items) { return (items||[]).map(i => `<div class="d-flex justify-content-between border-bottom py-1"><span>${i.item}</span><span class="badge bg-primary">${i.qty}</span></div>`).join(''); }
function formatTime(iso) { return new Date(iso).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); }



/// ‚úÖ 2. KOT ‡§ï‡•ã 'Done' ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
async function completeKOT(kotId) {
    if(!confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ø‡§π ‡§ñ‡§æ‡§®‡§æ ‡§ü‡•á‡§¨‡§≤ ‡§™‡§∞ ‡§∏‡§∞‡•ç‡§µ ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à? (List se hat jayega)")) return;
    
    // ‡§¨‡§ü‡§® ‡§ï‡•ã ‡§°‡§ø‡§∏‡•á‡§¨‡§≤ ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§≤‡•â‡§ú‡§ø‡§ï (Optional Visual Feedback)
    // ‡§π‡§Æ ‡§∏‡•Ä‡§ß‡•á API ‡§ï‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á
    
    try {
        const res = await fetchApi('/api/restaurant/complete-kot', { method: 'POST', body: { kotId } });
        if(res.success) {
            // ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç
            await loadLiveKOTs();
            showMessage("‡§∏‡§´‡§≤‡§§‡§æ", "‚úÖ ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§∏‡•á ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!", "success");
        } else {
            showMessage("‡§§‡•ç‡§∞‡•Å‡§ü‡§ø", res.message, "danger");
        }
    } catch(e) { 
        alert("Error: " + e.message); 
    }
}

// [ ‡§á‡§∏‡•á Script ‡§∏‡•á‡§ï‡•ç‡§∂‡§® ‡§Æ‡•á‡§Ç ‡§®‡•Ä‡§ö‡•á ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç ]

// üçΩÔ∏è KOT ‡§ï‡•ã POS ‡§¨‡§ø‡§≤‡§ø‡§Ç‡§ó ‡§Æ‡•á‡§Ç ‡§≠‡•á‡§ú‡§®‡•á ‡§ï‡§æ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
// [ ‚úÖ UPDATED: Transfer to POS (Uses new Dropdown ID) ]
async function transferTableToPOS() {
    // üöÄ Note: ID ‡§¨‡§¶‡§≤‡§æ ‡§π‡•à
    const tableId = document.getElementById('rest_table_select').value;
    
    if(!tableId) {
        return showMessage("‡§§‡•ç‡§∞‡•Å‡§ü‡§ø", "‡§ï‡•É‡§™‡§Ø‡§æ Table/Room ‡§ö‡•Å‡§®‡•á‡§Ç ‡§ú‡§ø‡§∏‡§ï‡§æ ‡§¨‡§ø‡§≤ ‡§¨‡§®‡§æ‡§®‡§æ ‡§π‡•à‡•§", "warning");
    }

    if(!confirm(`‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ${tableId} ‡§ï‡§æ ‡§¨‡§ø‡§≤ ‡§¨‡§®‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?`)) return;

    try {
        const res = await fetchApi('/api/restaurant/generate-bill', { 
            method: 'POST', 
            body: { tableId } 
        }, '‡§¨‡§ø‡§≤ ‡§¨‡§® ‡§∞‡§π‡§æ ‡§π‡•à...');

        if (res.success && res.items.length > 0) {
            renderView('sales'); // POS ‡§ñ‡•ã‡§≤‡•á‡§Ç
            
            // ‡§Ü‡§á‡§ü‡§Æ‡•ç‡§∏ ‡§ï‡•ã POS ‡§ï‡§æ‡§∞‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§≤‡•á‡§Ç
            res.items.forEach(item => {
                posCart.push({
                    sku: item.sku,
                    name: item.name,
                    quantity: item.quantity,
                    sale_price: item.sale_price,
                    purchase_price: item.purchase_price || 0,
                    gst: item.gst || 0
                });
            });

            updatePOSCartView();
            showMessage("‡§∏‡§´‡§≤‡§§‡§æ", `‚úÖ ${tableId} ‡§ï‡•á ‡§Ü‡§á‡§ü‡§Æ‡•ç‡§∏ ‡§¨‡§ø‡§≤ ‡§Æ‡•á‡§Ç ‡§ú‡•Å‡§°‡§º ‡§ó‡§è!`, "success");

        } else {
            showMessage("Info", res.message || "‡§ï‡•ã‡§à ‡§Ü‡§á‡§ü‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§", "info");
        }
    } catch (e) {
        showMessage("‡§§‡•ç‡§∞‡•Å‡§ü‡§ø", e.message, "danger");
    }
}

// 1. ‡§è‡§ï ‡§®‡§à ‡§°‡§ø‡§∂ ‡§ï‡•Ä ‡§≤‡§æ‡§á‡§® ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§ï‡§æ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
window.addDishRow = function() {
    const tbody = document.getElementById('dish-bulk-body');
    if (!tbody) return;

    const row = document.createElement('tr');
    row.className = 'dish-entry-row';
    row.innerHTML = `
        <td><input type="text" class="form-control form-control-sm dish-name" placeholder="Ex: Masala Dosa" required></td>
        <td><input type="number" class="form-control form-control-sm dish-price" placeholder="0" required></td>
        <td class="text-center"><button type="button" class="btn btn-sm btn-danger py-0 px-2" onclick="this.closest('tr').remove()">√ó</button></td>
    `;
    tbody.appendChild(row);
    // ‡§®‡§è ‡§á‡§®‡§™‡•Å‡§ü ‡§™‡§∞ ‡§´‡•ã‡§ï‡§∏ ‡§ï‡§∞‡•á‡§Ç
    row.querySelector('.dish-name').focus();
};

// ==========================================
// üöÄ SUPER FAST KOT MANAGER (Optimized)
// ==========================================

// ==========================================
// üöÄ SUPER FAST KOT MANAGER (Optimized)
// ==========================================

// ==========================================
// üöÄ SUPER FAST KOT MANAGER (Error Fixed Version)
// ==========================================

// 1. Safe Global Variable Declaration (‡§Ø‡§π ‡§è‡§∞‡§∞ ‡§ï‡•ã ‡§∞‡•ã‡§ï‡•á‡§ó‡§æ)
// ‡§Ö‡§ó‡§∞ ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§¨‡§®‡•á ‡§π‡•à‡§Ç ‡§§‡•ã ‡§†‡•Ä‡§ï, ‡§®‡§π‡•Ä‡§Ç ‡§§‡•ã ‡§®‡§è ‡§¨‡§®‡§æ‡§ì
if (typeof window.kotCart === 'undefined') window.kotCart = [];
if (typeof window.cachedRooms === 'undefined') window.cachedRooms = null;
if (typeof window.lastRoomFetchTime === 'undefined') window.lastRoomFetchTime = 0;

// 2. KOT ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§§‡•á ‡§∏‡§Æ‡§Ø ‡§∏‡•ç‡§ü‡•â‡§ï ‡§î‡§∞ ‡§∞‡•Ç‡§Æ‡•ç‡§∏ ‡§™‡§π‡§≤‡•á ‡§π‡•Ä ‡§≤‡•ã‡§° ‡§ï‡§∞ ‡§≤‡•á‡§Ç
async function initKotSection() {
    // Global variable ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç
    if (!window.currentStock || window.currentStock.length === 0) {
        fetchApi('/api/stock', { method: 'GET' }, null).then(res => {
            if(res.success) window.currentStock = res.stock;
        });
    }
    
    await refreshRoomCache();
    toggleOrderSource();
}

// 3. ‡§∞‡•Ç‡§Æ‡•ç‡§∏ ‡§ï‡•ã ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§≤‡§æ‡§®‡•á ‡§ï‡§æ ‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
async function refreshRoomCache() {
    const now = Date.now();
    // 30 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§ï‡§æ ‡§ï‡•à‡§∂ ‡§ö‡•á‡§ï
    if (window.cachedRooms && (now - window.lastRoomFetchTime < 30000)) {
        return; 
    }

    try {
        const res = await fetchApi('/api/hotel/rooms', { method: 'GET' }, null);
        if (res.success) {
            window.cachedRooms = res.rooms;
            window.lastRoomFetchTime = now;
        }
    } catch (e) { console.error(e); }
}

// 4. ‡§ü‡•á‡§¨‡§≤ ‡§î‡§∞ ‡§∞‡•Ç‡§Æ ‡§ï‡•á ‡§¨‡•Ä‡§ö ‡§∏‡•ç‡§µ‡§ø‡§ö ‡§ï‡§∞‡§®‡§æ
async function toggleOrderSource() {
    const isRoom = document.getElementById('type_room').checked;
    const select = document.getElementById('rest_table_select');
    
    if(!select) return; // ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§ö‡•á‡§ï
    select.innerHTML = ''; 

    if (isRoom) {
        select.classList.remove('border-primary');
        select.classList.add('border-danger');

        if (!window.cachedRooms) await refreshRoomCache();

        const occupiedRooms = window.cachedRooms ? window.cachedRooms.filter(r => r.status === 'OCCUPIED') : [];

        if (occupiedRooms.length > 0) {
            select.innerHTML = occupiedRooms.map(r => 
                `<option value="${r.room_number}">Room ${r.room_number} (${r.current_guest_name || 'Guest'})</option>`
            ).join('');
        } else {
            select.innerHTML = '<option value="">No Guests Checked In</option>';
        }

    } else {
        select.classList.remove('border-danger');
        select.classList.add('border-primary');
        
        let options = '<option value="">-- Select Table --</option>';
        for(let i=1; i<=20; i++) {
            options += `<option value="T-${i}">Table ${i}</option>`;
        }
        options += '<option value="VIP">VIP Table</option>';
        options += '<option value="Staff">Staff Food</option>';
        options += '<option value="Parcel">Parcel / Takeaway</option>';
        
        select.innerHTML = options;
    }
}

// 5. ‡§Ü‡§á‡§ü‡§Æ ‡§∏‡§∞‡•ç‡§ö (Search)
function handleKotSearch(showAll = false) {
    const input = document.getElementById('kot-search-input');
    const list = document.getElementById('kot-search-results');
    const query = input.value.toLowerCase().trim();

    if (!window.currentStock || window.currentStock.length === 0) {
        fetchApi('/api/stock', { method: 'GET' }, null).then(res => {
            if(res.success) {
                window.currentStock = res.stock;
                handleKotSearch(showAll);
            }
        });
        if(!showAll) return; 
    }

    if (!showAll && query.length === 0) {
        list.style.display = 'none';
        return;
    }

    const matches = showAll 
        ? window.currentStock 
        : window.currentStock.filter(item => item.name.toLowerCase().includes(query));

    if (matches.length > 0) {
        list.innerHTML = matches.slice(0, 50).map(item => `
            <li class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" 
                onclick="addKotItem('${item.sku}')" style="cursor: pointer;">
                <div><strong>${item.name}</strong></div>
                <span class="badge bg-success rounded-pill">‚Çπ${item.sale_price}</span>
            </li>
        `).join('');
        list.style.display = 'block';
    } else {
        list.innerHTML = `<li class="list-group-item text-muted text-center">‡§ï‡•ã‡§à ‡§Ü‡§á‡§ü‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ</li>`;
        list.style.display = 'block';
    }
}

// 6. ‡§Ü‡§á‡§ü‡§Æ ‡§ê‡§° ‡§ï‡§∞‡§®‡§æ
function addKotItem(sku) {
    const cleanSku = String(sku).trim();
    const item = window.currentStock.find(i => String(i.sku).trim() === cleanSku);
    
    if (!item) {
        // ‡§Ö‡§ó‡§∞ ‡§Ü‡§á‡§ü‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ, ‡§§‡•ã ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§∏‡•ç‡§ü‡•â‡§ï ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§π‡•ã
        console.error("Item not found in currentStock:", sku);
        return;
    }

    // window.kotCart ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç
    const existing = window.kotCart.find(i => i.sku === cleanSku);
    
    if (existing) {
        existing.qty++;
    } else {
        window.kotCart.push({ 
            sku: item.sku, 
            name: item.name, 
            qty: 1,
            price: item.sale_price 
        });
    }

    renderKotList(); 
    
    const searchInput = document.getElementById('kot-search-input');
    searchInput.value = '';
    document.getElementById('kot-search-results').style.display = 'none';
    searchInput.focus();
}

// 7. ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§∞‡•á‡§Ç‡§°‡§∞ ‡§ï‡§∞‡§®‡§æ
function renderKotList() {
    const container = document.getElementById('kot-added-list');
    
    if (window.kotCart.length === 0) {
        container.innerHTML = `<div class="text-center text-muted small mt-3 p-3 bg-light rounded">
            <i class="fas fa-basket-shopping fa-2x mb-2 text-secondary"></i><br>
            ‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§Ü‡§á‡§ü‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§ö‡•Å‡§®‡§æ
        </div>`;
        return;
    }

    container.innerHTML = window.kotCart.map((item, index) => `
        <div class="d-flex justify-content-between align-items-center border-bottom py-2 bg-white px-2 mb-1 rounded shadow-sm">
            <div>
                <span class="fw-bold text-dark">${item.name}</span>
                <br><small class="text-muted">‚Çπ${item.price} x ${item.qty} = ‚Çπ${item.price * item.qty}</small>
            </div>
            <div class="d-flex align-items-center bg-light rounded p-1 border">
                <button class="btn btn-sm btn-danger py-0 px-2 fw-bold" onclick="updateKotQty(${index}, -1)">-</button>
                <span class="mx-2 fw-bold" style="min-width:20px; text-align:center;">${item.qty}</span>
                <button class="btn btn-sm btn-success py-0 px-2 fw-bold" onclick="updateKotQty(${index}, 1)">+</button>
                <button class="btn btn-sm text-danger ms-2 border-start ps-2" onclick="removeKotItem(${index})"><i class="fas fa-trash"></i></button>
            </div>
        </div>
    `).join('');
}

function updateKotQty(index, change) {
    if (window.kotCart[index].qty + change > 0) {
        window.kotCart[index].qty += change;
        renderKotList();
    } else {
        removeKotItem(index);
    }
}

function removeKotItem(index) {
    window.kotCart.splice(index, 1);
    renderKotList();
}

// ‡§∏‡•á‡§ü‡§Ö‡§™
document.addEventListener('DOMContentLoaded', () => {
    initKotSection();
});


// 1. ‡§™‡•á‡§ú ‡§≤‡•ã‡§° ‡§π‡•ã‡§§‡•á ‡§π‡•Ä ‡§ü‡•á‡§¨‡§≤ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§¨‡§®‡§æ‡§®‡§æ
// [ ‚úÖ FIXED: Initialize Tables (Same Logic, New System) ]
function initRestaurantTables() {
    // ‡§Ø‡§π ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§™‡•á‡§ú ‡§≤‡•ã‡§° ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§Ö‡§™‡§®‡•á ‡§Ü‡§™ "Table Mode" ‡§∏‡•á‡§ü ‡§ï‡§∞ ‡§¶‡•á‡§ó‡§æ
    // ‡§î‡§∞ 1 ‡§∏‡•á 20 ‡§ü‡•á‡§¨‡§≤ + ‡§è‡§ï‡•ç‡§∏‡•ç‡§ü‡•ç‡§∞‡§æ ‡§ë‡§™‡•ç‡§∂‡§® ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§≠‡§∞ ‡§¶‡•á‡§ó‡§æ‡•§
    
    // ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§≤‡•â‡§ú‡§ø‡§ï ‡§Ö‡§¨ 'toggleOrderSource' ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§∂‡§ø‡§´‡•ç‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à,
    // ‡§á‡§∏‡§≤‡§ø‡§è ‡§π‡§Æ‡•á‡§Ç ‡§¨‡§∏ ‡§â‡§∏‡•á ‡§ï‡•â‡§≤ ‡§ï‡§∞‡§®‡§æ ‡§π‡•à‡•§
    if (typeof toggleOrderSource === 'function') {
        toggleOrderSource();
    }
}
// ‡§á‡§∏ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§ï‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ RenderDashboard ‡§Æ‡•á‡§Ç ‡§≠‡•Ä ‡§°‡§æ‡§≤ ‡§¶‡•á‡§Ç
document.addEventListener('DOMContentLoaded', initRestaurantTables);



// [ ‚úÖ LOAD WAITERS DYNAMICALLY ]
async function loadWaiters() {
    const select = document.getElementById('waiter_select');
    if(!select) return;

    try {
        // ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§∏‡•ç‡§ü‡§æ‡§´ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§Æ‡§Ç‡§ó‡§æ‡§è‡§Ç
        const res = await fetchApi('/api/users', { method: 'GET' }, null);
        
        if (res.success && res.users) {
            // ‡§°‡•ç‡§∞‡•â‡§™‡§°‡§æ‡§â‡§® ‡§ï‡•ã ‡§ñ‡§æ‡§≤‡•Ä ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§ë‡§™‡•ç‡§∂‡§® ‡§°‡§æ‡§≤‡•á‡§Ç
            select.innerHTML = '<option value="Self">-- Select Waiter --</option>';
            
            // ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§∏‡•á ‡§®‡§æ‡§Æ ‡§≠‡§∞‡§ï‡§∞ ‡§°‡•ç‡§∞‡•â‡§™‡§°‡§æ‡§â‡§® ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§≤‡•á‡§Ç
            res.users.forEach(user => {
                // ‡§∏‡§ø‡§∞‡•ç‡§´ ‡§â‡§®‡•ç‡§π‡•á‡§Ç ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç ‡§ú‡•ã ‡§è‡§ï‡•ç‡§ü‡§ø‡§µ ‡§π‡•à‡§Ç
                if(user.status === 'active') {
                    const opt = document.createElement('option');
                    opt.value = user.name;
                    opt.innerText = user.name;
                    select.appendChild(opt);
                }
            });
        }
    } catch (e) {
        console.error("Waiters load error:", e);
    }
}

// ‡§™‡•á‡§ú ‡§≤‡•ã‡§° ‡§π‡•ã‡§§‡•á ‡§π‡•Ä ‡§µ‡•á‡§ü‡§∞ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
document.addEventListener('DOMContentLoaded', loadWaiters);


// 5. ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ ‡§Ö‡§™‡§°‡•á‡§ü
function updateKotQty(index, change) {
    if (kotCart[index].qty + change > 0) {
        kotCart[index].qty += change;
    }
    renderKotList();
}

function removeKotItem(index) {
    kotCart.splice(index, 1);
    renderKotList();
}
// [ ‚úÖ FIXED: KOT SENDING (Update UI First, Then Print) ]
async function sendKotToKitchen() {
    const tableId = document.getElementById('rest_table_select').value;
    
    // 1. ‡§ï‡§æ‡§∞‡•ç‡§ü ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç
    if (typeof kotCart === 'undefined' || kotCart.length === 0) {
        return showMessage("‡§ñ‡§æ‡§≤‡•Ä ‡§ë‡§∞‡•ç‡§°‡§∞", "‚ùå ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï ‡§Ü‡§á‡§ü‡§Æ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§", "warning");
    }
    
    if(!tableId) {
        return showMessage("Table Missing", "‚ùå ‡§ï‡•É‡§™‡§Ø‡§æ Table ‡§Ø‡§æ Room ‡§ö‡•Å‡§®‡•á‡§Ç‡•§", "warning");
    }
    
    // 2. ‡§µ‡•á‡§ü‡§∞ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§≤‡•á‡§Ç (‡§Ö‡§ó‡§∞ ‡§°‡•ç‡§∞‡•â‡§™‡§°‡§æ‡§â‡§® ‡§π‡•à ‡§§‡•ã)
    const waiterSelect = document.getElementById('waiter_select');
    const waiterName = waiterSelect ? waiterSelect.value : 'Server';

    // 3. ‡§°‡•á‡§ü‡§æ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç
    const itemsToSend = kotCart.map(i => ({ item: i.name, qty: i.qty }));

    // 4. ‡§¨‡§ü‡§® ‡§ï‡•ã 'Loading' ‡§ï‡§∞‡•á‡§Ç
    const btn = document.querySelector('button[onclick="sendKotToKitchen()"]');
    if(btn) { btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...'; }

    try {
        // 5. ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§™‡§∞ ‡§≠‡•á‡§ú‡•á‡§Ç
        const res = await fetchApi('/api/restaurant/create-kot', {
            method: 'POST',
            body: { tableId, items: itemsToSend, waiter: waiterName }
        });

        if (res.success) {
            // ‚úÖ SUCCESS!
            showMessage("‡§∏‡§´‡§≤‡§§‡§æ", "‚úÖ ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§ï‡§ø‡§ö‡§® ‡§Æ‡•á‡§Ç ‡§ö‡§≤‡§æ ‡§ó‡§Ø‡§æ!", "success");

            // 6. üöÄ CRITICAL FIX: ‡§™‡§π‡§≤‡•á ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç (‡§§‡§æ‡§ï‡§ø ‡§Ø‡•Ç‡§ú‡§∞ ‡§ï‡•ã ‡§¶‡§ø‡§ñ‡•á)
            if (typeof loadLiveKOTs === 'function') await loadLiveKOTs(); // ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂
            
            // 7. ‡§ï‡§æ‡§∞‡•ç‡§ü ‡§ñ‡§æ‡§≤‡•Ä ‡§ï‡§∞‡•á‡§Ç
            kotCart = []; 
            if(typeof renderKotList === 'function') renderKotList();

            // 8. üñ®Ô∏è ‡§Ü‡§ñ‡§ø‡§∞ ‡§Æ‡•á‡§Ç ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡§Ç (0.5 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§∞‡•Å‡§ï‡§ï‡§∞ ‡§§‡§æ‡§ï‡§ø ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ú‡§æ‡§è)
            // ‡§Ö‡§ó‡§∞ ‡§Ü‡§™‡§ï‡•ã PDF/Print ‡§®‡§π‡•Ä‡§Ç ‡§ö‡§æ‡§π‡§ø‡§è, ‡§§‡•ã ‡§®‡•Ä‡§ö‡•á ‡§µ‡§æ‡§≤‡•Ä ‡§≤‡§æ‡§á‡§® ‡§π‡§ü‡§æ ‡§¶‡•á‡§Ç
            setTimeout(() => {
                if(typeof printKOT === 'function') printKOT(tableId, itemsToSend, waiterName, res.kotId || 'New');
            }, 500);
            
        } else {
            showMessage("‡§§‡•ç‡§∞‡•Å‡§ü‡§ø", res.message, "danger");
        }
    } catch (e) {
        showMessage("Error", e.message, "danger");
    } finally {
        // ‡§¨‡§ü‡§® ‡§ï‡•ã ‡§µ‡§æ‡§™‡§∏ ‡§®‡•â‡§∞‡•ç‡§Æ‡§≤ ‡§ï‡§∞‡•á‡§Ç
        if(btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-paper-plane me-2"></i> Send to Kitchen'; }
    }
}

// ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§≤‡•ã‡§° ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§ü‡•á‡§¨‡§≤ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§¨‡§® ‡§ú‡§æ‡§è
// (‡§á‡§∏‡•á ‡§Ö‡§™‡§®‡•á renderDashboard ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§Æ‡•á‡§Ç ‡§≠‡•Ä ‡§ï‡•â‡§≤ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç)
initRestaurantTables();

// ==========================================
// üñ®Ô∏è KOT PRINT FUNCTION (Missing Function)
// ==========================================

// ‚úÖ 3. KOT ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® (Direct Print)
function printKOT(tableNo, items, waiter, kotId) {
    // ‡§õ‡•ã‡§ü‡•Ä ‡§™‡§∞‡•ç‡§ö‡•Ä ‡§ï‡§æ ‡§°‡§ø‡§ú‡§º‡§æ‡§á‡§® (Thermal Printer Friendly)
    const printContent = `
        <div style="font-family: monospace; width: 280px; font-size: 12px; font-weight: bold;">
            <div style="text-align: center;">** KITCHEN ORDER **</div>
            <div style="text-align: center;">KOT #: ${kotId} | ${new Date().toLocaleTimeString()}</div>
            <hr style="border-top: 1px dashed #000;">
            <div style="font-size: 16px;">TABLE: ${tableNo}</div>
            <div>WAITER: ${waiter}</div>
            <hr style="border-top: 1px dashed #000;">
            <table style="width: 100%; text-align: left;">
                ${items.map(i => `
                    <tr>
                        <td style="width: 75%;">${i.item}</td>
                        <td style="width: 25%; text-align: right; font-size: 14px;">x${i.qty}</td>
                    </tr>
                `).join('')}
            </table>
            <hr style="border-top: 1px dashed #000;">
        </div>
    `;

    // ‡§®‡§à ‡§µ‡§ø‡§Ç‡§°‡•ã ‡§ñ‡•ã‡§≤‡§ï‡§∞ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§Æ‡§æ‡§Ç‡§° ‡§¶‡•á‡§Ç
    const win = window.open('', '', 'height=500,width=400');
    win.document.write('<html><body>');
    win.document.write(printContent);
    win.document.write('</body></html>');
    win.document.close();
    win.print(); // ‡§Ø‡§π ‡§∏‡•Ä‡§ß‡•á ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§°‡§æ‡§Ø‡§≤‡•â‡§ó ‡§ñ‡•ã‡§≤‡•á‡§ó‡§æ
    
    // ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§™‡§∞ ‡§µ‡§ø‡§Ç‡§°‡•ã ‡§Ö‡§™‡§®‡•á ‡§Ü‡§™ ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)
    setTimeout(() => { win.close(); }, 1000);
}

// [ ‚úÖ AUTO SETUP: Create 10 Rooms (101-110) ]
async function setupHotelRooms() {
    if(!confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§ë‡§ü‡•ã‡§Æ‡•à‡§ü‡§ø‡§ï 10 ‡§∞‡•Ç‡§Æ (101-110) ‡§¨‡§®‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")) return;

    showLoader("‡§∞‡•Ç‡§Æ‡•ç‡§∏ ‡§¨‡§® ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...");

    try {
        // 101 ‡§∏‡•á 110 ‡§§‡§ï ‡§≤‡•Ç‡§™ ‡§ö‡§≤‡§æ‡§è‡§Ç
        for (let i = 101; i <= 110; i++) {
            await fetchApi('/api/hotel/add-room', { 
                method: 'POST', 
                body: { roomNumber: i.toString() } 
            }, null); // null ‡§ï‡§æ ‡§Æ‡§§‡§≤‡§¨ ‡§π‡§∞ ‡§¨‡§æ‡§∞ ‡§≤‡•ã‡§°‡§∞ ‡§® ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
        }

        hideLoader();
        showMessage("‡§∏‡§´‡§≤‡§§‡§æ", "‚úÖ 10 ‡§∞‡•Ç‡§Æ‡•ç‡§∏ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§¨‡§® ‡§ó‡§è!", "success");
        loadHotelRooms(); // ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç

    } catch (e) {
        hideLoader();
        alert("Error: " + e.message);
    }
}


// [ ‚úÖ MANUAL ADD: Add Single Room ]
async function addRoomManually() {
    // 1. ‡§∞‡•Ç‡§Æ ‡§®‡§Ç‡§¨‡§∞ ‡§™‡•Ç‡§õ‡•á‡§Ç
    const roomNo = prompt("‡§®‡§Ø‡§æ ‡§∞‡•Ç‡§Æ ‡§®‡§Ç‡§¨‡§∞ ‡§°‡§æ‡§≤‡•á‡§Ç (Example: 201, 305, VIP-1):");
    
    // ‡§Ö‡§ó‡§∞ ‡§ñ‡§æ‡§≤‡•Ä ‡§õ‡•ã‡§°‡§º ‡§¶‡§ø‡§Ø‡§æ ‡§Ø‡§æ ‡§ï‡•à‡§Ç‡§∏‡§ø‡§≤ ‡§ï‡§ø‡§Ø‡§æ ‡§§‡•ã ‡§∞‡•Å‡§ï ‡§ú‡§æ‡§è‡§Ç
    if (!roomNo || roomNo.trim() === "") return;

    // 2. ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§™‡§∞ ‡§≠‡•á‡§ú‡•á‡§Ç
    try {
        const res = await fetchApi('/api/hotel/add-room', { 
            method: 'POST', 
            body: { roomNumber: roomNo.trim() } 
        }, '‡§∞‡•Ç‡§Æ ‡§¨‡§® ‡§∞‡§π‡§æ ‡§π‡•à...');

        if (res.success) {
            showMessage("‡§∏‡§´‡§≤‡§§‡§æ", `‚úÖ ‡§∞‡•Ç‡§Æ ${roomNo} ‡§¨‡§® ‡§ó‡§Ø‡§æ!`, "success");
            loadHotelRooms(); // ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç ‡§§‡§æ‡§ï‡§ø ‡§∞‡•Ç‡§Æ ‡§¶‡§ø‡§ñ‡•á
        } else {
            alert("‚ùå " + res.message);
        }
    } catch (e) {
        alert("Error: " + e.message);
    }
}

// [ ‚úÖ KITCHEN MODE: Hides everything except Active Orders ]
function enableKitchenMode() {
    if(!confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§ï‡§ø‡§ö‡§® ‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á ‡§Æ‡•ã‡§° ‡§ö‡§æ‡§≤‡•Ç ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? (‡§¨‡§æ‡§ï‡•Ä ‡§∏‡§¨ ‡§õ‡•Å‡§™ ‡§ú‡§æ‡§è‡§ó‡§æ)")) return;

    // 1. ‡§∏‡§æ‡§á‡§°‡§¨‡§æ‡§∞ ‡§î‡§∞ ‡§π‡•á‡§°‡§∞ ‡§õ‡•Å‡§™‡§æ‡§è‡§Ç
    document.getElementById('sidebar').style.display = 'none';
    document.querySelector('.navbar-toggler').style.display = 'none';
    
    // 2. ‡§Æ‡•á‡§® ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü ‡§ï‡•ã ‡§´‡•Å‡§≤ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§ï‡§∞‡•á‡§Ç
    const main = document.getElementById('main-content');
    main.style.marginLeft = '0';
    main.style.padding = '5px';

    // 3. ‡§∏‡§¨ ‡§ï‡•Å‡§õ ‡§õ‡•Å‡§™‡§æ‡§è‡§Ç
    document.querySelectorAll('.section').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.biz-module').forEach(el => el.style.display = 'none');

    // 4. ‡§∏‡§ø‡§∞‡•ç‡§´ KOT ‡§µ‡§æ‡§≤‡§æ ‡§π‡§ø‡§∏‡•ç‡§∏‡§æ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
    const kotSection = document.getElementById('module-restaurant-kot');
    kotSection.style.display = 'block';
    
    // 5. KOT ‡§∏‡•á‡§ï‡•ç‡§∂‡§® ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§≠‡•Ä ‡§∏‡§ø‡§∞‡•ç‡§´ 'Active Orders' ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç (‡§ä‡§™‡§∞ ‡§ï‡§æ ‡§∏‡§∞‡•ç‡§ö ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§π‡§ü‡§æ ‡§¶‡•á‡§Ç)
    // (Optional: ‡§Ö‡§ó‡§∞ ‡§Ü‡§™ ‡§∏‡§∞‡•ç‡§ö ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§≠‡•Ä ‡§õ‡•Å‡§™‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç ‡§§‡•ã ‡§®‡•Ä‡§ö‡•á ‡§µ‡§æ‡§≤‡•Ä ‡§≤‡§æ‡§á‡§® ‡§Ö‡§®-‡§ï‡§Æ‡•á‡§Ç‡§ü ‡§ï‡§∞‡•á‡§Ç)
    // document.querySelector('#module-restaurant-kot .card-body').children[0].style.display = 'none'; 

    // 6. ‡§ï‡§ø‡§ö‡§® ‡§µ‡•ç‡§Ø‡•Ç ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
    const kitchenView = document.getElementById('standalone-kitchen-view');
    if(kitchenView) {
        kitchenView.style.display = 'block';
        // ‡§¨‡§°‡§º‡•á ‡§´‡•ã‡§Ç‡§ü ‡§ï‡§∞ ‡§¶‡•á‡§Ç ‡§§‡§æ‡§ï‡§ø ‡§¶‡•Ç‡§∞ ‡§∏‡•á ‡§¶‡§ø‡§ñ‡•á
        kitchenView.style.fontSize = '1.2rem'; 
    }
    
    alert("‚úÖ ‡§ï‡§ø‡§ö‡§® ‡§Æ‡•ã‡§° ‡§ö‡§æ‡§≤‡•Ç ‡§π‡•à‡•§ ‡§¨‡§æ‡§π‡§∞ ‡§®‡§ø‡§ï‡§≤‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•á‡§ú ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç‡•§");
    
    // ‡§ë‡§ü‡•ã ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç
    setInterval(loadLiveKOTs, 5000);
}

// [ ‚úÇÔ∏è SALON CLEANUP CODE ]
document.addEventListener('DOMContentLoaded', () => {
    const user = JSON.parse(localStorage.getItem('authUser'));
    
    // ‡§Ö‡§ó‡§∞ ‡§Ø‡•Ç‡§ú‡§∞ ‡§π‡•ã‡§ü‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à (‡§Ø‡§æ‡§®‡•Ä Salon ‡§Ø‡§æ Retail ‡§π‡•à)
    if (user && user.business_type !== 'HOTEL') {
        const hotelOnlyPart = document.getElementById('hotel-bulk-dish-section');
        if (hotelOnlyPart) {
            hotelOnlyPart.style.display = 'none'; // ‡§á‡§∏‡•á ‡§õ‡•Å‡§™‡§æ ‡§¶‡•ã
        }
    }
});


// [ üî• FORCE REMOVE: HOTEL SECTION IN SALON ]
// ‡§Ø‡§π ‡§ï‡•ã‡§° ‡§π‡§∞ ‡§Ü‡§ß‡•á ‡§∏‡•á‡§ï‡§Ç‡§° ‡§Æ‡•á‡§Ç ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§ó‡§æ ‡§î‡§∞ ‡§Ö‡§ó‡§∞ ‡§∏‡•à‡§≤‡•Ç‡§® ‡§Æ‡•á‡§Ç ‡§π‡•ã‡§ü‡§≤ ‡§µ‡§æ‡§≤‡§æ ‡§π‡§ø‡§∏‡•ç‡§∏‡§æ ‡§¶‡§ø‡§ñ‡§æ ‡§§‡•ã ‡§â‡§∏‡•á ‡§Æ‡§ø‡§ü‡§æ ‡§¶‡•á‡§ó‡§æ
setInterval(() => {
    // 1. ‡§Ø‡•Ç‡§ú‡§∞ ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç
    let user = null;
    try { user = JSON.parse(localStorage.getItem('authUser')); } catch(e){}

    // 2. ‡§Ö‡§ó‡§∞ ‡§Ø‡•Ç‡§ú‡§∞ SALON ‡§Ø‡§æ RETAIL ‡§π‡•à (HOTEL ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à)
    if (user && user.business_type !== 'HOTEL') {
        
        // ‡§â‡§∏ ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§ï‡•ã ‡§¢‡•Ç‡§Ç‡§¢‡•á‡§Ç ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç "‡§è‡§ï ‡§∏‡§æ‡§• ‡§ï‡§à ‡§°‡§ø‡§∂‡•á‡§ú ‡§ú‡•ã‡§°‡§º‡•á‡§Ç" ‡§≤‡§ø‡§ñ‡§æ ‡§π‡•à
        document.querySelectorAll('h6').forEach(heading => {
            if (heading.innerText.includes('‡§è‡§ï ‡§∏‡§æ‡§• ‡§ï‡§à ‡§°‡§ø‡§∂‡•á‡§ú ‡§ú‡•ã‡§°‡§º‡•á‡§Ç') || heading.innerText.includes('Bulk Dishes')) {
                
                // ‡§â‡§∏‡§ï‡•á ‡§™‡•Ç‡§∞‡•á ‡§°‡§ø‡§¨‡•ç‡§¨‡•á (Container) ‡§ï‡•ã ‡§¢‡•Ç‡§Ç‡§¢‡•á‡§Ç
                const container = heading.closest('.col-12') || heading.parentElement.parentElement;
                
                // ‡§î‡§∞ ‡§â‡§∏‡•á ‡§π‡§ü‡§æ ‡§¶‡•á‡§Ç
                if (container) {
                    container.remove();
                    console.log("üö´ Salon Dashboard: Hotel Dish Section Removed Forcefully.");
                }
            }
        });
    }
}, 500); // 500ms (‡§π‡§∞ ‡§Ü‡§ß‡•á ‡§∏‡•á‡§ï‡§Ç‡§° ‡§Æ‡•á‡§Ç ‡§ö‡•á‡§ï)

// ================================================================
// 1. MEASUREMENT SAVE KARNE KA DIMAG (Hath-Pair) üß†‚úã
// ================================================================
async function saveMeasurement() {
    const customerId = document.getElementById('measure-customer-id')?.value;
    const itemType = document.getElementById('measure-item')?.value;
    const details = document.getElementById('measure-details')?.value;
    const deliveryDate = document.getElementById('measure-date')?.value;

    if (!customerId || !details) {
        alert("‚ùå ‡§ï‡•É‡§™‡§Ø‡§æ Customer ID ‡§î‡§∞ ‡§®‡§æ‡§™ (Details) ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§≠‡§∞‡•á‡§Ç!");
        return;
    }

    // Button ko loading banayein
    const btn = document.querySelector('#add-measurement-modal .btn-info');
    const oldText = btn.innerText;
    btn.innerText = "Saving...";
    btn.disabled = true;

    try {
        // Server par bhejen
        const res = await fetchApi('/api/measurements', {
            method: 'POST',
            body: JSON.stringify({
                customer_id: customerId,
                item_type: itemType,
                measurements: details,
                delivery_date: deliveryDate
            })
        });

        if (res.success) {
            alert("‚úÖ ‡§®‡§æ‡§™ (Measurement) ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ!");
            // Modal band karein (Bootstrap 5 logic)
            const modalEl = document.getElementById('add-measurement-modal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();
            
            // Form clear karein
            document.getElementById('measurement-form').reset();
        } else {
            alert("‚ùå Error: " + (res.message || "Save nahi hua"));
        }
    } catch (e) {
        console.error(e);
        alert("‚ùå ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§è‡§∞‡§∞: ‡§∏‡•á‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§æ‡•§");
    } finally {
        btn.innerText = oldText;
        btn.disabled = false;
    }
}

// [ ‚úÖ FIXED: WhatsApp Share Function (Mistri & Customer) ]
function shareInvoiceOnWhatsApp(mobileNumber, name, invoiceNo, amount, pdfUrl) {
    console.log("WhatsApp Attempt:", mobileNumber, name);

    // 1. ‡§®‡§Ç‡§¨‡§∞ ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç (Validation)
    if (!mobileNumber) {
        alert("‚ùå ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à!");
        return;
    }

    // 2. ‡§®‡§Ç‡§¨‡§∞ ‡§∏‡§æ‡•û ‡§ï‡§∞‡•á‡§Ç (Space, -, + ‡§π‡§ü‡§æ ‡§¶‡•á‡§Ç)
    let phone = mobileNumber.toString().replace(/\D/g, ''); 

    // 3. '91' ‡§ú‡•ã‡§°‡§º‡•á‡§Ç (‡§Ö‡§ó‡§∞ 10 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§π‡•à)
    if (phone.length === 10) {
        phone = '91' + phone;
    } 
    // ‡§Ö‡§ó‡§∞ ‡§®‡§Ç‡§¨‡§∞ ‡§¨‡§π‡•Å‡§§ ‡§õ‡•ã‡§ü‡§æ ‡§π‡•à ‡§§‡•ã ‡§è‡§∞‡§∞ ‡§¶‡•á‡§Ç
    else if (phone.length < 10) {
        alert("‚ùå ‡§ó‡§≤‡§§ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞: " + mobileNumber);
        return;
    }

    // 4. ‡§Æ‡•à‡§∏‡•á‡§ú ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç
    let msg = `‡§®‡§Æ‡§∏‡•ç‡§§‡•á ${name || 'Customer'},\n`;
    msg += `‡§Ü‡§™‡§ï‡§æ ‡§¨‡§ø‡§≤ (Invoice: ${invoiceNo}) ‡§¨‡§® ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§\n`;
    msg += `‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø: ‚Çπ${amount}\n`;
    msg += `‡§Ø‡§π‡§æ‡§Å ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§ï‡•á ‡§¨‡§ø‡§≤ ‡§¶‡•á‡§ñ‡•á‡§Ç: ${pdfUrl || ''}\n\n`;
    msg += `‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶!`;

    // 5. WhatsApp ‡§≤‡§ø‡§Ç‡§ï ‡§¨‡§®‡§æ‡§è‡§Ç
    // (web.whatsapp.com ‡§ï‡•Ä ‡§ú‡§ó‡§π wa.me ‡§ú‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§≠‡§∞‡•ã‡§∏‡•á‡§Æ‡§Ç‡§¶ ‡§π‡•à ‡§ú‡•ã App ‡§î‡§∞ Web ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§ñ‡•ã‡§≤‡§§‡§æ ‡§π‡•à)
    const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;

    // 6. ‡§µ‡§ø‡§Ç‡§°‡•ã ‡§ñ‡•ã‡§≤‡•á‡§Ç
    window.open(url, '_blank');
}


// üöÄ 1. ULTRA FAST WHATSAPP OPENER (Desktop App + Mobile App)
function openSmartWhatsApp(phone, message) {
    if (!phone) return;
    
    // ‡§®‡§Ç‡§¨‡§∞ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡§®‡§æ (Format check)
    let cleanPhone = phone.replace(/[^0-9]/g, '');
    if (cleanPhone.length === 10) cleanPhone = '91' + cleanPhone;

    const encodedMsg = encodeURIComponent(message);
    const appUrl = `whatsapp://send?phone=${cleanPhone}&text=${encodedMsg}`;
    
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    if (isMobile) {
        // ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤: ‡§∏‡•Ä‡§ß‡•á ‡§≤‡§ø‡§Ç‡§ï (Direct Link)
        window.location.href = appUrl;
    } else {
        // ‡§ï‡§Ç‡§™‡•ç‡§Ø‡•Ç‡§ü‡§∞: ‡§∏‡•Ä‡§ß‡•á App ‡§ü‡•ç‡§∞‡§ø‡§ó‡§∞ (Window Name 'DukanWA' ‡§§‡§æ‡§ï‡§ø ‡§è‡§ï ‡§π‡•Ä ‡§ü‡•à‡§¨ ‡§∞‡§π‡•á)
        // '_self' ‡§ï‡§æ ‡§Æ‡§§‡§≤‡§¨ ‡§π‡•à ‡§ï‡§ø ‡§Ø‡§π ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§ï‡•ã ‡§™‡•â‡§™‡§Ö‡§™ ‡§¶‡§ø‡§ñ‡§æ‡§®‡•á ‡§ï‡•ã ‡§ï‡§π‡•á‡§ó‡§æ
        window.open(appUrl, '_self'); 
    }
}


</script>

<div class="modal fade" id="paintMixingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">üé® Color Mixing Billing</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                
                <div class="mb-3 position-relative p-2 border rounded bg-light">
                    <label class="form-label fw-bold text-danger">‡§∏‡•ç‡§ü‡•á‡§™ 1: ‡§¨‡•á‡§∏ ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡•á‡§Ç (SKU)</label>
                    
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-barcode"></i></span>
                        <input type="text" id="mix-base-sku" class="form-control" placeholder="Scan/Type Bucket Barcode" onchange="fetchBaseDetails(this.value)">
                        
                        <button class="btn btn-dark" type="button" onclick="openMobileScannerForMix()">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>

                    <div id="paint-otp-box" class="mt-2 p-2 border border-danger rounded bg-white text-center" style="display: none;">
                        <p class="mb-1 small text-muted fw-bold">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§∏‡•ç‡§ï‡•à‡§®‡§∞ ‡§Æ‡•á‡§Ç ‡§Ø‡§π ‡§ï‡•ã‡§° ‡§°‡§æ‡§≤‡•á‡§Ç:</p>
                        
                        <div class="d-flex justify-content-center align-items-center gap-2">
                            <span id="paint-otp-code" class="display-6 fw-bold text-danger">------</span>
                            <div id="paint-otp-spinner" class="spinner-border spinner-border-sm text-danger" role="status"></div>
                        </div>

                        <p id="paint-otp-status" class="mt-1 mb-0 small text-success fw-bold" style="display: none;">
                            <i class="fas fa-check-circle"></i> ‡§ï‡§®‡•á‡§ï‡•ç‡§ü‡•á‡§°! ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡•á‡§Ç...
                        </p>
                    </div>

                    <small class="d-block mt-1 fw-bold" id="mix-stock-status"></small> 
                </div>
                <hr>

                <div class="mb-3">
                    <label class="form-label">Base Product Name</label>
                    <input type="text" id="mix-base-name" class="form-control fw-bold" placeholder="Scan SKU or Type Name">
                </div>
                
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="form-label">Base Price (‚Çπ)</label>
                        <input type="number" id="mix-base-price" class="form-control" placeholder="0">
                    </div>
                    
                    <div class="col-6">
                        <label class="form-label text-danger fw-bold">Colorant Cost (‚Çπ)</label>
                        <input type="number" id="mix-color-cost" class="form-control" placeholder="Enter Amount">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Color Code / Shade Name</label>
                    <input type="text" id="mix-code" class="form-control" placeholder="e.g. Sunrise Orange 405">
                </div>

                <div class="alert alert-info py-2 text-center">
                    Final Bill Price: <strong id="mix-final-price" class="fs-5">‚Çπ0</strong>
                </div>

                <button class="btn btn-danger w-100 btn-lg shadow" onclick="addMixedPaintToCart()">
                    <i class="fas fa-cart-plus me-2"></i> ‡§¨‡§ø‡§≤ ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç (Add to Bill)
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="painterLedgerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg"> <div class="modal-content border-primary">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-book-open me-2"></i>‡§™‡•á‡§Ç‡§ü‡§∞ ‡§¨‡§π‡•Ä-‡§ñ‡§æ‡§§‡§æ (Ledger)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h5 id="ledger-painter-name" class="fw-bold text-dark mb-3">Painter Name</h5>
                
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-striped table-bordered mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>‡§§‡§æ‡§∞‡•Ä‡§ñ</th>
                                <th>‡§¨‡§ø‡§≤ ‡§®‡§Ç. (Invoice)</th>
                                <th>‡§ï‡•Å‡§≤ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä</th>
                                <th class="text-end text-success">‡§ï‡§Æ‡•Ä‡§∂‡§®</th>
                            </tr>
                        </thead>
                        <tbody id="painter-ledger-body">
                            </tbody>
                        <tfoot class="table-group-divider bg-light fw-bold">
                            <tr>
                                <td colspan="3" class="text-end">‡§ï‡•Å‡§≤ ‡§ï‡§Æ‡§æ‡§à (Total Earnings):</td>
                                <td class="text-end text-success fs-5" id="painter-total-earnings">‚Çπ0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <div class="text-danger fw-bold" id="painter-current-balance-display">
                    ‡§¨‡§ï‡§æ‡§Ø‡§æ: ‚Çπ0.00
                </div>
                
                <div>
                    <button type="button" class="btn btn-success me-2" onclick="payPainterDue()">
                        <i class="fas fa-money-bill-wave"></i> ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç (Pay)
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="hotelCheckoutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-file-invoice-dollar"></i> Hotel Checkout & Bill</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <h2 id="co_room_no" class="fw-bold text-danger">Room 101</h2>
                    <p id="co_guest_name" class="text-muted mb-0">Guest: Rahul Kumar</p>
                </div>
                
                <form id="checkout-form">
                    <div class="mb-3">
                        <label class="fw-bold small">Final Bill Amount (‚Çπ)</label>
                        <input type="number" id="co_amount" class="form-control form-control-lg fw-bold text-success" placeholder="0.00">
                        <small class="text-muted">*Room Rent + Food - Advance</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="fw-bold small">Payment Mode</label>
                        <select id="co_mode" class="form-select">
                            <option value="Cash" selected>Cash</option>
                            <option value="UPI">UPI / PhonePe</option>
                            <option value="Card">Card</option>
                        </select>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-danger btn-lg">
                            <i class="fas fa-sign-out-alt"></i> Collect & Checkout
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="add-measurement-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">üìè New Measurement</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="measurement-form">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Customer ID / Name</label>
                        <input type="text" id="measure-customer-id" class="form-control" placeholder="Enter Customer ID">
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label">Type</label>
                            <select id="measure-item" class="form-select">
                                <option>Shirt</option><option>Pant</option><option>Suit</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Delivery</label>
                            <input type="date" id="measure-date" class="form-control">
                        </div>
                    </div>
                    <div class="mb-3 mt-2">
                        <label class="form-label">Details</label>
                        <textarea id="measure-details" class="form-control" rows="3" placeholder="Measurements..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-info text-white" onclick="saveMeasurement()">Save Data</button>
            </div>
        </div>
    </div>
</div>


<div id="invoice-content" style="display: none; width: 100%; max-width: 800px; background: #fff; padding: 20px; font-family: 'Poppins', sans-serif;">
    
    <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px;">
        <h2 style="margin: 0; color: #333;">Dukan Pro Invoice</h2> <p style="margin: 5px 0; color: #666;">‡§Ü‡§™‡§ï‡§æ ‡§™‡§§‡§æ ‡§Ø‡§π‡§æ‡§Å ‡§Ü‡§è‡§ó‡§æ | ‡§Æ‡•ã. 9999999999</p>
    </div>

    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
        <div style="width: 48%;">
            <h4 style="margin-bottom: 5px; color: #444;">‡§¨‡§ø‡§≤ ‡§ï‡§ø‡§∏‡§ï‡•á ‡§®‡§æ‡§Æ (Bill To):</h4>
            <p style="margin: 0; font-size: 16px; font-weight: bold;" id="inv-customer">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ</p>
        </div>
        <div style="width: 48%; text-align: right;">
            <p style="margin: 5px 0;"><strong>‡§¨‡§ø‡§≤ ‡§®‡§Ç (No):</strong> <span id="inv-no">---</span></p>
            <p style="margin: 5px 0;"><strong>‡§§‡§æ‡§∞‡•Ä‡§ñ (Date):</strong> <span id="inv-date">---</span></p>
        </div>
    </div>

    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
        <thead>
            <tr style="background-color: #f2f2f2; border-bottom: 2px solid #ddd;">
                <th style="padding: 8px; text-align: left;">#</th>
                <th style="padding: 8px; text-align: left;">‡§∏‡§æ‡§Æ‡§æ‡§® (Item)</th>
                <th style="padding: 8px; text-align: left;">Qty</th>
                <th style="padding: 8px; text-align: left;">Rate</th>
                <th style="padding: 8px; text-align: left;">Total</th>
            </tr>
        </thead>
        <tbody id="inv-items-body">
            </tbody>
    </table>

    <div style="text-align: right; border-top: 2px solid #000; padding-top: 10px;">
        <h3 style="margin: 0;">‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø (Total): <span id="inv-total" style="color: #27ae60;">‚Çπ0.00</span></h3>
    </div>

    <div style="margin-top: 40px; text-align: center; font-size: 12px; color: #888;">
        <p>‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! ‡§´‡§ø‡§∞ ‡§Ö‡§µ‡§∂‡•ç‡§Ø ‡§™‡§ß‡§æ‡§∞‡•á‡§Ç‡•§</p>
        <p>‡§Ø‡§π ‡§è‡§ï ‡§ï‡§Ç‡§™‡•ç‡§Ø‡•Ç‡§ü‡§∞ ‡§ú‡§®‡§ø‡§§ ‡§∞‡§∏‡•Ä‡§¶ ‡§π‡•à‡•§</p>
    </div>
</div>

</script>

<script>
    // ‚úÖ ‡§∏‡§ø‡§∞‡•ç‡§´ ‡§¨‡§ø‡§≤ (Invoice) ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§° - (‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§∂‡•Ä‡§ü ‡§ï‡•ã ‡§°‡§ø‡§∏‡•ç‡§ü‡§∞‡•ç‡§¨ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡•á‡§ó‡§æ)
    window.generateAndDownloadPDF = function(invoiceId, customerName, items, totalAmount) {
        try {
            // ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø jsPDF ‡§≤‡•ã‡§° ‡§π‡•à ‡§Ø‡§æ ‡§®‡§π‡•Ä‡§Ç
            if (!window.jspdf) {
                alert("PDF System Loading... Try again in 2 seconds.");
                return;
            }
    
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
    
            // --- 1. HEADER SECTION ---
            doc.setFillColor(41, 128, 185);
            doc.rect(0, 0, pageWidth, 35, 'F');
    
            // Shop Name Logic
            const shopName = (typeof AppState !== 'undefined' && AppState.user?.shopName) ? AppState.user.shopName : "MY SHOP NAME";
    
            doc.setFont("helvetica", "bold");
            doc.setFontSize(22);
            doc.setTextColor(255, 255, 255);
            doc.text(shopName.toUpperCase(), 15, 15);
    
            // Subtitle
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text("Mobile: 9876543210 | Address: City, India", 15, 22);
    
            doc.setFontSize(16);
            doc.text("INVOICE", pageWidth - 15, 20, { align: 'right' });
    
            // --- 2. DETAILS ---
            doc.setTextColor(0, 0, 0);
            let y = 45;
    
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("BILL TO:", 15, y);
            doc.setFont("helvetica", "normal");
            doc.text((customerName || "Cash Customer").toUpperCase(), 15, y + 6);
    
            doc.setFont("helvetica", "bold");
            doc.text("Invoice No:", 140, y);
            doc.text("Date:", 140, y + 6);
            doc.setFont("helvetica", "normal");
            doc.text(`#${invoiceId || '--'}`, 170, y);
            doc.text(new Date().toLocaleDateString('en-IN'), 170, y + 6);
    
            // --- 3. TABLE ---
            y += 20;
            doc.setFillColor(230, 230, 230);
            doc.rect(15, y, pageWidth - 30, 8, 'F');
            doc.setFont("helvetica", "bold");
            doc.setFontSize(9);
            doc.text("#", 18, y + 5);
            doc.text("ITEM", 30, y + 5);
            doc.text("QTY", 120, y + 5, { align: 'center' });
            doc.text("RATE", 150, y + 5, { align: 'center' });
            doc.text("TOTAL", 185, y + 5, { align: 'center' });
    
            y += 8;
            doc.setFont("helvetica", "normal");
    
            items.forEach((item, index) => {
                let itemName = item.name;
                if (itemName.length > 40) itemName = itemName.substring(0, 40) + "...";
                
                doc.text(String(index + 1), 18, y + 5);
                doc.text(itemName, 30, y + 5);
                doc.text(String(item.quantity), 120, y + 5, { align: 'center' });
                doc.text(String(item.sale_price), 150, y + 5, { align: 'center' });
                doc.text(String((item.sale_price * item.quantity).toFixed(2)), 185, y + 5, { align: 'center' });
                
                doc.setDrawColor(220, 220, 220);
                doc.line(15, y + 7, pageWidth - 15, y + 7);
                y += 8;
            });
    
            // --- 4. TOTAL ---
            y += 5;
            doc.setDrawColor(0, 0, 0);
            doc.line(15, y, pageWidth - 15, y);
            y += 7;
            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.text("GRAND TOTAL", 140, y);
            doc.text('‚Çπ' + parseFloat(totalAmount).toFixed(2), 185, y, { align: 'center' });
    
            // --- 5. FOOTER ---
            doc.setFontSize(10);
            doc.setTextColor(41, 128, 185);
            doc.text("Thank you for your business!", pageWidth / 2, pageHeight - 10, { align: 'center' });
    
            // ‚úÖ DIRECT DOWNLOAD COMMAND
            doc.save(`Invoice_${invoiceId}.pdf`);
    
        } catch (e) {
            alert("Error: " + e.message);
        }
    };
    </script>
   

</body>
</html>