<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dukan Pro Mobile Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f1f5f9; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; flex-direction: column; }
        #container { width: 100%; max-width: 400px; background-color: #1e293b; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5); text-align: center; }
        input[type="text"] { background-color: #334155; border: 1px solid #475569; color: #f1f5f9; text-align: center; font-size: 1.8rem; letter-spacing: 4px; }
        button { background-color: #0ea5e9; transition: background-color 0.2s; }
        button:hover { background-color: #0284c7; }
        .status { min-height: 1.5rem; margin-top: 1rem; font-weight: 600; }
        /* üöÄ ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç */
        #qr-reader { width: 100%; margin-top: 1rem; border-radius: 0.5rem; overflow: hidden; background-color: #000; }
        #qr-reader video { width: 100% !important; height: auto !important; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="container">
        <div id="connection-section">
             <h1 class="text-xl font-bold mb-3">POS ‡§∏‡•á ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç</h1>
             <p class="text-gray-400 mb-4 text-sm">‡§ï‡§Ç‡§™‡•ç‡§Ø‡•Ç‡§ü‡§∞ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§™‡§∞ ‡§¶‡§ø‡§ñ ‡§∞‡§π‡§æ 6 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§ï‡•ã‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç:</p>
             <input type="text" id="pairing-code-input" maxlength="6" pattern="\d{6}" required placeholder="------" class="w-full p-3 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-sky-500">
             <button id="connect-button" class="w-full py-2 px-4 rounded-lg text-white font-bold text-md">‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
             <div id="status-message" class="status text-yellow-400 mt-3">&nbsp;</div>
        </div>

        <div id="scanning-section" class="hidden">
             <h1 class="text-xl font-bold mb-3">‡§™‡•ç‡§∞‡•ã‡§°‡§ï‡•ç‡§ü ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡•á‡§Ç</h1>
             <div id="qr-reader"></div>
             <div id="scan-feedback" class="status text-yellow-400 mt-3">‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§§‡•à‡§Ø‡§æ‡§∞...</div>
             <button id="disconnect-button" class="w-full mt-4 py-2 px-4 rounded-lg bg-red-600 hover:bg-red-700 text-white font-bold text-md">‡§°‡§ø‡§∏‡•ç‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
        </div>
    </div>

<script>
    // --- CONFIGURATION ---
    const BACKEND_URL = 'https://dukan-pro-ultimate.onrender.com'; 
    let scannerSocket = null;
    let html5QrCode = null; // ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§ë‡§¨‡•ç‡§ú‡•á‡§ï‡•ç‡§ü
    let lastScanTime = 0;

    const connectionSection = document.getElementById('connection-section');
    const scanningSection = document.getElementById('scanning-section');
    
    const codeInput = document.getElementById('pairing-code-input');
    const connectButton = document.getElementById('connect-button');
    const statusMessage = document.getElementById('status-message');
    
    const qrReaderDiv = document.getElementById('qr-reader');
    const scanFeedback = document.getElementById('scan-feedback');
    const disconnectButton = document.getElementById('disconnect-button');


    function updateStatus(message, isError = false, target = 'status') {
        const el = target === 'scan' ? scanFeedback : statusMessage;
        el.textContent = message;
        el.className = `status ${isError ? 'text-red-400' : 'text-green-400'}`;
    }
    
    function flashScanFeedback(message) {
         scanFeedback.textContent = message;
         setTimeout(() => {
             if (scanningSection.classList.contains('hidden') === false) {
                 scanFeedback.textContent = "‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§§‡•à‡§Ø‡§æ‡§∞...";
             }
         }, 2000);
    }

    // üöÄ ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§®
    function startCamera() {
        if (html5QrCode && html5QrCode.isScanning) return; // ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§ö‡§≤ ‡§∞‡§π‡§æ ‡§π‡•à
        
        html5QrCode = new Html5Qrcode("qr-reader");
        updateStatus("‡§ï‡•à‡§Æ‡§∞‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...", false, 'scan');

        const onScanSuccess = (decodedText, decodedResult) => {
            const now = Date.now();
            if (now - lastScanTime < 3000) return;
            lastScanTime = now;
            const sku = decodedText.trim();
            flashScanFeedback(`‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ: ${sku}`);
            if (scannerSocket && scannerSocket.readyState === WebSocket.OPEN) {
                scannerSocket.send(JSON.stringify({ type: 'SCAN_SKU', sku: sku }));
            }
        };

        Html5Qrcode.getCameras().then(devices => {
            if (devices && devices.length) {
                let cameraId = devices.length > 1 
                    ? (devices.find(d => d.label.toLowerCase().includes('back')) || devices[devices.length - 1]).id
                    : devices[0].id;
                
                html5QrCode.start(
                    cameraId, 
                    { fps: 5, qrbox: { width: 250, height: 150 } },
                    onScanSuccess,
                    (error) => { /* Ignore 'No QR code found' */ }
                ).then(() => {
                    updateStatus("‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§§‡•à‡§Ø‡§æ‡§∞...", false, 'scan');
                }).catch(err => {
                    updateStatus(`‡§ï‡•à‡§Æ‡§∞‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${err}`, true, 'scan');
                });
            } else {
                 updateStatus('‡§ï‡•ã‡§à ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§', true, 'scan');
            }
        }).catch(err => {
             updateStatus(`‡§ï‡•à‡§Æ‡§∞‡§æ ‡§ñ‡•ã‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${err}`, true, 'scan');
        });
    }

    // üöÄ ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§∞‡•ã‡§ï‡§®‡•á ‡§ï‡§æ ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§®
    function stopCamera() {
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().catch(err => console.warn("‡§ï‡•à‡§Æ‡§∞‡§æ ‡§∞‡•ã‡§ï‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", err));
        }
    }

    // WebSocket ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§®
    function connectWebSocket(pairCode) {
        if (scannerSocket) scannerSocket.close();
        updateStatus("‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...");
        connectButton.disabled = true;
        connectButton.textContent = "‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...";

        const wsUrl = BACKEND_URL.replace('https', 'wss').replace('http', 'ws');
        scannerSocket = new WebSocket(wsUrl);

        scannerSocket.onopen = () => {
            scannerSocket.send(JSON.stringify({ type: 'REGISTER_SCANNER', pairCode: pairCode }));
        };

        scannerSocket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            switch (data.type) {
                case 'SCANNER_PAIRED':
                    updateStatus("‚úÖ ‡§ï‡§®‡•á‡§ï‡•ç‡§ü‡•á‡§°!"); // ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§∏‡•ç‡§ü‡•á‡§ü‡§∏ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
                    connectionSection.classList.add('hidden'); // ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® UI ‡§õ‡§ø‡§™‡§æ‡§è‡§Å
                    scanningSection.classList.remove('hidden'); // ‡§∏‡•ç‡§ï‡•à‡§®‡§ø‡§Ç‡§ó UI ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
                    startCamera(); // üöÄ ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç
                    break;
                case 'POS_DISCONNECTED':
                    updateStatus("POS ‡§°‡§ø‡§∏‡•ç‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ‡•§", true);
                    showConnectionUI();
                    break;
                case 'ERROR':
                    updateStatus("‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: " + data.message, true);
                    connectButton.disabled = false;
                    connectButton.textContent = "‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç";
                    break;
            }
        };

        scannerSocket.onclose = () => {
             console.log("Scanner WebSocket Disconnected");
             showConnectionUI(); // ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® UI ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
             if (statusMessage.textContent === "‚úÖ ‡§ï‡§®‡•á‡§ï‡•ç‡§ü‡•á‡§°!") { // ‡§Ö‡§ó‡§∞ ‡§ï‡§®‡•á‡§ï‡•ç‡§ü‡•á‡§° ‡§•‡§æ
                  updateStatus("‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§ü‡•Ç‡§ü ‡§ó‡§Ø‡§æ‡•§", true);
             }
        };
        
        scannerSocket.onerror = (error) => {
             console.error("WebSocket Error:", error);
             updateStatus("‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§", true);
             showConnectionUI();
        };
    }
    
    // üöÄ ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® UI ‡§¶‡§ø‡§ñ‡§æ‡§®‡•á ‡§ï‡§æ ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§®
    function showConnectionUI() {
         stopCamera(); // ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç
         connectionSection.classList.remove('hidden');
         scanningSection.classList.add('hidden');
         connectButton.disabled = false;
         connectButton.textContent = "‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç";
         codeInput.disabled = false;
         codeInput.value = ""; // ‡§ï‡•ã‡§° ‡§á‡§®‡§™‡•Å‡§ü ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç
    }

    // --- INITIALIZATION ---
    window.onload = function() {
        connectButton.addEventListener('click', () => {
            const code = codeInput.value.trim();
            if (code.length === 6 && /^\d{6}$/.test(code)) {
                connectWebSocket(code);
            } else {
                updateStatus("‡§ï‡•É‡§™‡§Ø‡§æ 6 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§ï‡•ã‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§", true);
            }
        });
        
        codeInput.addEventListener('keypress', function (e) { if (e.key === 'Enter') connectButton.click(); });
        
        disconnectButton.addEventListener('click', () => {
             if (scannerSocket) scannerSocket.close();
             showConnectionUI();
             updateStatus("‡§°‡§ø‡§∏‡•ç‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§");
        });
    };
    
</script>
</body>
</html>
