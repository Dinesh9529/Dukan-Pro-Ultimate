<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dukan Pro Mobile Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f1f5f9; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; flex-direction: column; }
        #scanner-container { width: 100%; max-width: 400px; position: relative; border-radius: 1rem; overflow: hidden; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5); }
        #qr-reader { width: 100%; background-color: #1e293b; }
        #qr-reader video { width: 100% !important; height: auto !important; }
        .status-box { padding: 1.5rem; background-color: #1e293b; text-align: center; }
        .scan-feedback { font-size: 1.1rem; font-weight: 600; color: #fbbf24; min-height: 1.5rem; }
        .status-message { font-size: 1.25rem; font-weight: 700; color: #f1f5f9; }
    </style>
</head>
<body>

    <div id="scanner-container">
        <div id="qr-reader"></div>
        <div class="status-box">
            <div id="status-message">‡§ï‡•à‡§Æ‡§∞‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>
            <div id="scan-feedback" class="scan-feedback">&nbsp;</div>
        </div>
    </div>

<script>
    // --- CONFIGURATION ---
    const APP_STATE = {
        PAIRING_QR: 'PAIRING_QR', // ‡§ï‡§Ç‡§™‡•ç‡§Ø‡•Ç‡§ü‡§∞ ‡§∏‡•á ‡§™‡•á‡§Ø‡§∞‡§ø‡§Ç‡§ó ‡§ï‡•á ‡§≤‡§ø‡§è QR ‡§∏‡•ç‡§ï‡•à‡§®
        SCANNING_PRODUCTS: 'SCANNING_PRODUCTS', // ‡§™‡•ç‡§∞‡•ã‡§°‡§ï‡•ç‡§ü ‡§∏‡•ç‡§ï‡•à‡§®‡§ø‡§Ç‡§ó
        LEGACY_POSTMESSAGE: 'LEGACY_POSTMESSAGE' // ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤-‡§ì‡§®‡§≤‡•Ä ‡§Æ‡•ã‡§°
    };
    let currentState = null;
    let html5QrCode;
    let scannerSocket = null;
    let lastScanTime = 0;
    
    // 1. ‡§¨‡•à‡§ï‡§è‡§Ç‡§° URL (‡§Ø‡§π ‡§µ‡§π‡•Ä ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è ‡§ú‡•ã ‡§Ü‡§™‡§ï‡•á Multiuser.html ‡§Æ‡•á‡§Ç ‡§π‡•à)
    const BACKEND_URL = 'https://dukan-pro-ultimate.onrender.com'; //

    const statusMessage = document.getElementById('status-message');
    const scanFeedback = document.getElementById('scan-feedback');

    function updateStatus(message, feedback = "") {
        if (message) statusMessage.innerText = message;
        if (feedback) scanFeedback.innerText = feedback;
    }
    
    function flashFeedback(feedback) {
        scanFeedback.innerText = feedback;
        setTimeout(() => {
            if (currentState === APP_STATE.SCANNING_PRODUCTS || currentState === APP_STATE.LEGACY_POSTMESSAGE) {
                scanFeedback.innerText = "‡§™‡•ç‡§∞‡•ã‡§°‡§ï‡•ç‡§ü ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§§‡•à‡§Ø‡§æ‡§∞...";
            }
        }, 2000);
    }

    // --- üöÄ ‡§π‡§æ‡§á‡§¨‡•ç‡§∞‡§ø‡§° ‡§≤‡•â‡§ú‡§ø‡§ï ---

    // 1. 'postMessage' ‡§≤‡•â‡§ú‡§ø‡§ï (‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤-‡§ì‡§®‡§≤‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è)
    function startLegacyMode() {
        currentState = APP_STATE.LEGACY_POSTMESSAGE;
        updateStatus("POS ‡§∏‡•á ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...");
        
        // ‡§ü‡•ã‡§ï‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§ï‡§∞‡•á‡§Ç
        window.opener.postMessage({ type: 'REQUEST_AUTH' }, window.location.origin);

        window.addEventListener('message', function(event) {
            if (event.origin !== window.location.origin) return;
            if (event.data && event.data.type === 'AUTH_TOKEN') {
                updateStatus("‚úÖ ‡§ï‡§®‡•á‡§ï‡•ç‡§ü‡•á‡§°!", "‡§™‡•ç‡§∞‡•ã‡§°‡§ï‡•ç‡§ü ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§§‡•à‡§Ø‡§æ‡§∞...");
                startCamera(onProductScan_Legacy); //
            }
        });
    }
    
    function onProductScan_Legacy(decodedText, decodedResult) {
        const now = Date.now();
        if (now - lastScanTime < 3000) return;
        lastScanTime = now;
        
        const sku = decodedText.trim();
        flashFeedback(`‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ: ${sku}`);
        
        // SKU ‡§ï‡•ã 'postMessage' ‡§ï‡•á ‡§ú‡§º‡§∞‡§ø‡§è ‡§µ‡§æ‡§™‡§∏ ‡§≠‡•á‡§ú‡•á‡§Ç
        window.opener.postMessage({ type: 'SCANNED_SKU', sku: sku }, window.location.origin);
    }


    // 2. 'WebSocket' ‡§≤‡•â‡§ú‡§ø‡§ï (‡§ï‡§Ç‡§™‡•ç‡§Ø‡•Ç‡§ü‡§∞ + ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§ï‡•á ‡§≤‡§ø‡§è)
    
    function startPairingMode() {
        currentState = APP_STATE.PAIRING_QR;
        updateStatus("POS ‡§∏‡•á ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è QR ‡§ï‡•ã‡§° ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡•á‡§Ç...");
        startCamera(onPairingScanSuccess);
    }
    
    function connectWebSocket(pairCode) {
        if (scannerSocket) scannerSocket.close();
        const wsUrl = BACKEND_URL.replace('https', 'wss').replace('http', 'ws');
        scannerSocket = new WebSocket(wsUrl);

        scannerSocket.onopen = () => {
            updateStatus("‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...");
            scannerSocket.send(JSON.stringify({ type: 'REGISTER_SCANNER', pairCode: pairCode }));
        };

        scannerSocket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'SCANNER_PAIRED') {
                currentState = APP_STATE.SCANNING_PRODUCTS;
                updateStatus("‚úÖ ‡§ï‡§®‡•á‡§ï‡•ç‡§ü‡•á‡§°!", "‡§™‡•ç‡§∞‡•ã‡§°‡§ï‡•ç‡§ü ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§§‡•à‡§Ø‡§æ‡§∞...");
                startCamera(onProductScan_WebSocket); // ‡§™‡•ç‡§∞‡•ã‡§°‡§ï‡•ç‡§ü ‡§∏‡•ç‡§ï‡•à‡§®‡§ø‡§Ç‡§ó ‡§Æ‡•ã‡§°
            } else if (data.type === 'POS_DISCONNECTED') {
                currentState = APP_STATE.PAIRING_QR;
                updateStatus("POS ‡§°‡§ø‡§∏‡•ç‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ‡•§", "‡§´‡§ø‡§∞ ‡§∏‡•á ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è QR ‡§ï‡•ã‡§° ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡•á‡§Ç...");
                startCamera(onPairingScanSuccess); // ‡§™‡•á‡§Ø‡§∞‡§ø‡§Ç‡§ó ‡§Æ‡•ã‡§°
            } else if (data.type === 'ERROR') {
                updateStatus("‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: " + data.message, "‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§");
                currentState = APP_STATE.PAIRING_QR;
            }
        };

        scannerSocket.onclose = () => {
            if (currentState !== APP_STATE.PAIRING_QR) {
                updateStatus("‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§ü‡•Ç‡§ü ‡§ó‡§Ø‡§æ‡•§", "‡§™‡•Å‡§®‡§É ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è QR ‡§ï‡•ã‡§° ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡•á‡§Ç...");
                currentState = APP_STATE.PAIRING_QR;
                startCamera(onPairingScanSuccess);
            }
        };
    }

    function onPairingScanSuccess(decodedText, decodedResult) {
        const now = Date.now();
        if (now - lastScanTime < 3000) return;
        lastScanTime = now;
        
        if (/^\d{6}$/.test(decodedText)) { // ‡§Æ‡§æ‡§® ‡§≤‡•á‡§Ç ‡§ï‡§ø ‡§™‡•á‡§Ø‡§∞‡§ø‡§Ç‡§ó ‡§ï‡•ã‡§° 6 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§π‡•à
            updateStatus("‡§™‡•á‡§Ø‡§∞‡§ø‡§Ç‡§ó ‡§ï‡•ã‡§° ‡§Æ‡§ø‡§≤‡§æ!", "POS ‡§∏‡•á ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...");
            html5QrCode.stop().then(() => connectWebSocket(decodedText));
        } else {
            flashFeedback("‡§Ø‡§π ‡§™‡•á‡§Ø‡§∞‡§ø‡§Ç‡§ó QR ‡§ï‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§");
        }
    }

    function onProductScan_WebSocket(decodedText, decodedResult) {
        const now = Date.now();
        if (now - lastScanTime < 3000) return;
        lastScanTime = now;

        const sku = decodedText.trim();
        flashFeedback(`‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ: ${sku}`);
        
        if (scannerSocket && scannerSocket.readyState === WebSocket.OPEN) {
            scannerSocket.send(JSON.stringify({ type: 'SCAN_SKU', sku: sku }));
        }
    }

    // 3. ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§®
    function startCamera(onScanSuccessCallback) {
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().catch(err => console.log("‡§ï‡•à‡§Æ‡§∞‡§æ ‡§∞‡•ã‡§ï‡§®‡•á ‡§Æ‡•á‡§Ç ‡§õ‡•ã‡§ü‡•Ä ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø, ‡§Ö‡§®‡§¶‡•á‡§ñ‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§"));
        }
        
        html5QrCode = new Html5Qrcode("qr-reader");

        Html5Qrcode.getCameras().then(devices => {
            if (devices && devices.length) {
                let cameraId = devices.length > 1 
                    ? (devices.find(d => d.label.toLowerCase().includes('back')) || devices[devices.length - 1]).id
                    : devices[0].id;
                
                html5QrCode.start(
                    cameraId, 
                    { fps: 5, qrbox: { width: 250, height: 150 } },
                    onScanSuccessCallback,
                    (error) => { /* "No code found" ‡§ï‡•ã ‡§Ö‡§®‡§¶‡•á‡§ñ‡§æ ‡§ï‡§∞‡•á‡§Ç */ }
                ).catch(err => {
                    updateStatus(`‡§ï‡•à‡§Æ‡§∞‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${err}`);
                });

            } else {
                updateStatus('‡§ï‡•ã‡§à ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§');
            }
        }).catch(err => {
            updateStatus(`‡§ï‡•à‡§Æ‡§∞‡§æ ‡§ñ‡•ã‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${err}`);
        });
    }

    // --- INITIALIZATION ---
    window.onload = function() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            updateStatus('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§');
            return;
        }

        // üöÄ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§π‡§æ‡§á‡§¨‡•ç‡§∞‡§ø‡§° ‡§∞‡§æ‡§â‡§ü‡§∞
        if (window.opener) {
            // ‡§Ö‡§ó‡§∞ ‡§Ø‡§π 'window.open' ‡§∏‡•á ‡§ñ‡•Å‡§≤‡§æ ‡§π‡•à (‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤-‡§ì‡§®‡§≤‡•Ä)
            console.log("Legacy (postMessage) ‡§Æ‡•ã‡§° ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à‡•§");
            startLegacyMode();
        } else {
            // ‡§Ö‡§ó‡§∞ ‡§Ø‡§π ‡§∏‡•Ä‡§ß‡•á URL ‡§∏‡•á ‡§ñ‡•Å‡§≤‡§æ ‡§π‡•à (‡§ï‡§Ç‡§™‡•ç‡§Ø‡•Ç‡§ü‡§∞ + ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§™‡•á‡§Ø‡§∞‡§ø‡§Ç‡§ó)
            console.log("WebSocket (Pairing) ‡§Æ‡•ã‡§° ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à‡•§");
            startPairingMode();
        }
    };
    
</script>
</body>
</html>
